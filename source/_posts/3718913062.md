---
layout: post
title: "ç¨³ï¼Œä»æ•°æ®åº“è¿æ¥æ±  testOnBorrow çœ‹æ¶æ„è®¾è®¡"
date: "2023-06-22T01:16:28.743Z"
---
ç¨³ï¼Œä»æ•°æ®åº“è¿æ¥æ±  testOnBorrow çœ‹æ¶æ„è®¾è®¡
============================

![ç¨³ï¼Œä»æ•°æ®åº“è¿æ¥æ±  testOnBorrow çœ‹æ¶æ„è®¾è®¡](https://img2023.cnblogs.com/blog/2927063/202306/2927063-20230621161842654-977007437.png) æœ¬æ–‡ä» Commons DBCP testOnBorrow çš„ä½œç”¨æœºåˆ¶ç€æ‰‹ï¼Œç®¡ä¸­çª¥è±¹ï¼Œä»ä¸€ç‚¹å»åˆ†ææ•°æ®åº“è¿æ¥æ± è·å–çš„è¿‡ç¨‹ä»¥åŠæ¶æ„åˆ†å±‚è®¾è®¡ã€‚ä»¥ä¸‹å†…å®¹ä¼šæŒ‰ç…§æ¯å±‚çš„ä½œç”¨ï¼Œè´¯ç©¿åˆ†ææ•´ä¸ªè°ƒç”¨æµç¨‹ã€‚

æœ¬æ–‡ä» Commons DBCP testOnBorrow çš„ä½œç”¨æœºåˆ¶ç€æ‰‹ï¼Œç®¡ä¸­çª¥è±¹ï¼Œä»ä¸€ç‚¹å»åˆ†ææ•°æ®åº“è¿æ¥æ± è·å–çš„è¿‡ç¨‹ä»¥åŠæ¶æ„åˆ†å±‚è®¾è®¡ã€‚

ä»¥ä¸‹å†…å®¹ä¼šæŒ‰ç…§æ¯å±‚çš„ä½œç”¨ï¼Œè´¯ç©¿åˆ†ææ•´ä¸ªè°ƒç”¨æµç¨‹ã€‚

1ï¸âƒ£æ¡†æ¶å±‚ commons-pool
-------------------

The indication of whether objects will beÂ **validated before being borrowed**Â from the pool.

If the object fails to validate, it will be dropped from the pool, and we will attempt to borrow another.

**testOnBorrow ä¸æ˜¯ dbcp å®šä¹‰çš„ï¼Œæ˜¯commons-pool å®šä¹‰çš„**ã€‚commons-pool è¯¦ç»†çš„å®šä¹‰äº†èµ„æºæ± ä½¿ç”¨çš„ä¸€å¥—è§„èŒƒå’Œè¿è¡Œæµç¨‹ã€‚

    /**
     * Borrow an object from the pool. get object from èµ„æºæ± 
     * @see org.apache.commons.pool2.impl.GenericObjectPool#borrowObject(long)
     */
    public T borrowObject(final long borrowMaxWaitMillis) throws Exception {
    	
    	PooledObject<T> p = null;
    	
        // if validation fails, the instance is destroyed and the next available instance is examined. 
        // This continues until either a valid instance is returned or there are no more idle instances available.
    	while (p == null) {
            // If there is one or more idle instance available in the pool, 
            // then an idle instance will be selected based on the value of getLifo(), activated and returned.
    		p = idleObjects.pollFirst();
    		if (p != null) {
                // è®¾ç½® testOnBorrow å°±ä¼šè¿›è¡Œå¯ç”¨æ€§æ ¡éªŒ
    			if (p != null && (getTestOnBorrow() || create && getTestOnCreate())) {
    				boolean validate = false;
    				Throwable validationThrowable = null;
    				try {
                        // å…·ä½“çš„æ ¡éªŒå®ç°ç”±å®ç°ç±»å®Œæˆã€‚
                        // see org.apache.commons.dbcp2.PoolableConnectionFactory
    					validate = factory.validateObject(p);
    				} catch (final Throwable t) {
    					PoolUtils.checkRethrow(t);
    					validationThrowable = t;
    				}
    				if (!validate) {
    					try {
                            // å¦‚æœæ ¡éªŒå¼‚å¸¸ï¼Œä¼šé”€æ¯è¯¥èµ„æºã€‚
                            // obj is not valid and should be dropped from the pool
    						destroy(p);
    						destroyedByBorrowValidationCount.incrementAndGet();
    					} catch (final Exception e) {
    						// Ignore - validation failure is more important
    					}
    					p = null;
    				}
    			}
    		}
    	}
    
    	return p.getObject();
    }
    

2ï¸âƒ£åº”ç”¨å±‚ commons-dbcp
-------------------

dbcp æ˜¯ç‰¹å®šäºç®¡ç†æ•°æ®åº“è¿æ¥çš„èµ„æºæ± ã€‚

**PoolableConnectionFactory**Â is a PooledObjectFactory

PoolableConnection is a PooledObject

    /**
     * @see PoolableConnectionFactory#validateObject(PooledObject)
     */
    @Override
    public boolean validateObject(final PooledObject<PoolableConnection> p) {
    	try {
    		/**
    		 * æ£€æµ‹èµ„æºæ± å¯¹è±¡çš„åˆ›å»ºæ—¶é—´ï¼Œæ˜¯å¦è¶…è¿‡ç”Ÿå­˜æ—¶é—´
    		 * å¦‚æœè¶…è¿‡ maxConnLifetimeMillis, ä¸å†å§”æ‰˜æ•°æ®åº“è¿æ¥è¿›è¡Œæ ¡éªŒï¼Œç›´æ¥åºŸå¼ƒæ”¹èµ„æº
    		 * @see PoolableConnectionFactory#setMaxConnLifetimeMillis(long)
    		 */
    		validateLifetime(p);
    		// å§”æ‰˜æ•°æ®åº“è¿æ¥è¿›è¡Œè‡ªæˆ‘æ ¡éªŒ
    		validateConnection(p.getObject());
    		return true;
    	} catch (final Exception e) {
    		return false;
    	}
    }
    
    /**
     * æ•°æ®åº“è¿æ¥å±‚çš„æ ¡éªŒã€‚å…·ä½“åˆ°æ˜¯å¦å·²å…³é—­ã€æ˜¯å¦ä¸ server è¿æ¥å¯ç”¨
     * @see Connection#isValid(int)
     */
    public void validateConnection(final PoolableConnection conn) throws SQLException {
    	if(conn.isClosed()) {
    		throw new SQLException("validateConnection: connection closed");
    	}
    	conn.validate(_validationQuery, _validationQueryTimeout);
    }
    

3ï¸âƒ£åŸºç¡€å±‚ mysql-connector-java
---------------------------

Returns true if the connection has not been closed and is still valid.

è¿™ä¸ªæ˜¯ java.sql.Connection å®šä¹‰çš„è§„èŒƒã€‚å…·ä½“å®ç°æ ¹æ®å¯¹åº”æ•°æ®åº“çš„driver æ¥å®Œæˆã€‚ä½¿ç”¨æŸç§æœºåˆ¶ç”¨æ¥æ¢æµ‹è¿æ¥æ˜¯å¦å¯ç”¨ã€‚

    /**
     * è°ƒç”¨ com.mysql.jdbc.MysqlIOï¼Œ å‘é€ping è¯·æ±‚ï¼Œæ£€æµ‹æ˜¯å¦å¯ç”¨
     * å¯¹æ¯” H2 æ•°æ®åº“ï¼Œæ˜¯é€šè¿‡è·å–å½“å‰äº‹åŠ¡çº§åˆ«æ¥æ£€æµ‹è¿æ¥æ˜¯å¦å¯ä»¥ã€‚ä½†æ˜¯å¿½ç•¥äº† timeout é…ç½®ï¼Œæ¯•ç«Ÿæ˜¯ demo æ•°æ®åº“ ğŸ˜…
     */
    public synchronized boolean isValid(int timeout) throws SQLException {
    	if (this.isClosed()) {
    		return false;
    	} else {
    		try {
    			this.pingInternal(false, timeout * 1000);
    			return true;
    		} catch (Throwable var5) {
    			return false;
    		}
    	}
    }
    

å‚è€ƒï¼š[MySQL çš„è¿æ¥æ—¶é•¿æ§åˆ¶--interactive\_timeoutå’Œwait\_timeout\_ç¿”äº‘123456çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/lanyang123456/article/details/102535434)

æ€»ç»“
--

*   commons-pool å®šä¹‰èµ„æºçš„**å®Œæ•´å£°æ˜å‘¨æœŸæ¥å£**ï¼ŒåŒ…æ‹¬ï¼šmakeObjectã€activateObjectã€validateObjectã€passivateObjectã€destoryObjectã€‚èµ„æºæ± ç®¡ç†å¯¹è±¡ï¼Œé€šè¿‡å®ç°è¿™äº›æ¥å£å³å¯å®ç°èµ„æºæ§åˆ¶ã€‚å‚è€ƒï¼šorg.apache.commons.pool2.PooledObjectFactory
*   åœ¨æ ¡éªŒè¿‡ç¨‹ä¸­ï¼Œç‰µæ¶‰åˆ°å¾ˆå¤šæ—¶é—´ï¼ŒåŒ…æ‹¬èµ„æºæ± å¯¹è±¡çš„åˆ›å»ºæ—¶é—´ã€ç”Ÿå­˜æ—¶é—´ã€æ•°æ®åº“è¿æ¥çš„è¶…æ—¶æ—¶é—´ã€Mysql è¿æ¥ç©ºé—²è¶…æ—¶æ—¶é—´ç­‰ã€‚**ä¸åŒå±‚ä¸ºäº†æœåŠ¡å¯é æ€§ï¼Œæä¾›ä¸åŒçš„æ—¶é—´é…ç½®**ã€‚æ ¡éªŒä¹Ÿæ˜¯å±‚å±‚é€’è¿›ï¼Œæœ€ç»ˆå§”æ‰˜åˆ°æœ€åº•å±‚æ¥åˆ¤æ–­ã€‚
*   æ ¡éªŒè¿‡ç¨‹ä¸­ï¼Œå¯¹äºè¿æ¥ä¹Ÿä¼šç”±æ˜¯å¦å·²å…³é—­çš„æ ¡éªŒï¼ˆ**isClosed()** ï¼‰ã€‚åŒ…æ‹¬PoolableConnection#isClosed, Connection#isClosed, Socket#isClosedã€‚ åŒæ ·ä¹Ÿæ˜¯å±‚å±‚ä¿éšœï¼Œç¡®ä¿æ•´ä¸ªæ¶æ„çš„å¯é ã€‚ğŸ’ª
*   **å®šä¹‰ä¸€å¥—å®Œæ•´ä¸¥è°¨çš„è§„èŒƒå’Œæ ‡å‡†ï¼Œæ¯”å®ç°ä¸€ä¸ªå…·ä½“çš„åŠŸèƒ½æˆ–è€…ç‰¹æ€§è¦æ±‚æ›´é«˜**Â ğŸ¯ã€‚commons-pool å’Œ jdbc å®šä¹‰äº†è§„èŒƒï¼Œcommons-dbcp å’Œ mysql-connector-java å®Œæˆäº†å…·ä½“çš„å®ç°ã€‚æœ‰äº†è§„èŒƒå’Œæ¥å£ï¼Œç»„ä»¶å’Œæ¡†æ¶çš„å¯¹æ¥å’Œå…¼å®¹æ‰å˜ä¸ºå¯èƒ½ã€‚

more ç†è§£é«˜å¯ç”¨
----------

åœ¨é˜…è¯» MySQL Driver æºç è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸ªç‚¹è¦ç‰¹åˆ«è®°å½•ä¸‹ã€‚ä»¥ MySQL Driver åˆ›å»ºè¿æ¥ä¸ºä¾‹ï¼Œç”¨é‡è¯•è¿æ¥å®ç°å¯ç”¨æ€§ï¼Œè¿™å°±æ˜¯é«˜å¯ç”¨ã€‚ğŸ¯

é«˜å¯ç”¨ä¸æ˜¯ä¸€ä¸ªå£å·ï¼Œä¹Ÿä¸æ˜¯å¤æ‚çš„æ¦‚å¿µå’Œå…¬å¼ã€‚èƒ½å¤Ÿå®å®åœ¨åœ¨ä½“ç³»åŒ–çš„è§£å†³ä¸€ç±»é—®é¢˜å°±æ˜¯æ¶æ„çš„ç›®çš„ã€‚ç»“åˆä¸Šè¿°çš„æ¶æ„åˆ†å±‚ï¼Œå¦‚æœè§£å†³é—®é¢˜çš„æ–¹æ¡ˆé€šç”¨æ€§å¥½ï¼Œå¹¶ä¸”å®ç°å¾ˆä¼˜é›…ï¼Œå°±æ˜¯å¥½çš„æ¶æ„ã€‚

    // autoReconnect 
    public void createNewIO(boolean isForReconnect) throws SQLException {
        synchronized (getConnectionMutex()) {
            // jdbc.url autoReconnect æŒ‡å®šä¸º trueï¼Œè¯†åˆ«ä¸º HighAvailabilityã€‚emmm..... ğŸ™‰
            if (!getHighAvailability()) {
                connectOneTryOnly(isForReconnect, mergedProps);
                return;
            }
            // maxReconnects é»˜è®¤ä¸º 3ï¼Œé‡è¯•å¤±è´¥çš„æç¤ºå°±æ˜¯ï¼š Attempted reconnect 3 times. Giving up.
            connectWithRetries(isForReconnect, mergedProps);
        }
    }
    

> ä½œè€…ï¼šäº¬ä¸œç‰©æµ æ¨æ”€
> 
> æ¥æºï¼šäº¬ä¸œäº‘å¼€å‘è€…ç¤¾åŒº