---
layout: post
title: "ä»é›¶ç©è½¬ç³»åˆ—ä¹‹å¾®ä¿¡æ”¯ä»˜å®æˆ˜PCç«¯æ”¯ä»˜å¾®ä¿¡å›è°ƒæ¥å£æ­å»º"
date: "2023-07-30T01:08:55.438Z"
---
ä»é›¶ç©è½¬ç³»åˆ—ä¹‹å¾®ä¿¡æ”¯ä»˜å®æˆ˜PCç«¯æ”¯ä»˜å¾®ä¿¡å›è°ƒæ¥å£æ­å»º
==========================

ä¸€ã€å‰è¨€
====

haloå„ä½å¤§ä½¬å¾ˆä¹…æ²¡æ›´æ–°äº†æœ€è¿‘åœ¨æå¾®ä¿¡æ”¯ä»˜,å› å•†æˆ·å·å®¡æ ¸äº†æˆ‘åŠä¸ªæœˆå’Œå°ç¨‹åºè®¤è¯ä¹Ÿæ‰¾äº†èµ„æ–™å¹¶ä¸”å°†å•†æˆ·å·å’Œå°ç¨‹åºè¿›è¡Œå…³è”,è‡³æ­¤å¾®ä¿¡æ”¯ä»˜Nativeæ”¯ä»˜å®Œæˆ.æ­¤ç¯‡æ–‡ç« è¿‡é•¿æˆ‘å°†åˆ†å‡ ä¸ªé˜¶æ®µçš„æ–‡ç« å‘å¸ƒ(é¡¹ç›®æºç éƒ½æœ‰,å°ç¨‹åºå’ŒPCç«¯)

åœ¨æ­¤ä¹‹å‰å·²ç»æ›´æ–°äº†å¾®ä¿¡æ”¯ä»˜å¼€ç¯‡ã€å¾®ä¿¡æ”¯ä»˜å®‰å…¨ã€å¾®ä¿¡å®æˆ˜åŸºç¡€æ¡†æ¶æ­å»ºã€æœ¬æ¬¡æ›´æ–°ä¸ºå¾®ä¿¡æ”¯ä»˜å®æˆ˜PCç«¯æ¥å£æ­å»º,å®æˆ˜ç¯‡åˆ†ä¸ºå‡ ä¸ªç« èŠ‚å› ä¸ºä»£ç é‡ç¡®å®æœ‰ç‚¹å¤šå“ˆ.

*   [ç¬¬ä¸€ç« ä»é›¶ç©è½¬ç³»åˆ—ä¹‹å¾®ä¿¡æ”¯ä»˜å¼€ç¯‡](https://www.yby6.com/archives/wechatpay02)
*   [ç¬¬äºŒç« ä»é›¶ç©è½¬ç³»åˆ—ä¹‹å¾®ä¿¡æ”¯ä»˜å®‰å…¨](https://www.yby6.com/archives/wechatpay01)
*   [ç¬¬ä¸‰ç« ä»é›¶ç©è½¬ç³»åˆ—ä¹‹å¾®ä¿¡æ”¯ä»˜å®æˆ˜åŸºç¡€æ¡†æ¶æ­å»º](https://www.yby6.com/archives/wechatpay03)
*   [ç¬¬å››ç« ä»é›¶ç©è½¬ç³»åˆ—ä¹‹å¾®ä¿¡æ”¯ä»˜å®æˆ˜PCç«¯æ”¯ä»˜ä¸‹å•æ¥å£æ­å»º](https://www.yby6.com/archives/wechat04)
*   [ç¬¬äº”ç« ä»é›¶ç©è½¬ç³»åˆ—ä¹‹å¾®ä¿¡æ”¯ä»˜å®æˆ˜PCç«¯æ”¯ä»˜å¾®ä¿¡å›è°ƒæ¥å£æ­å»º](https://www.yby6.com/archives/wechat04)

æœ¬æ¬¡é¡¹ç›®ä½¿ç”¨æŠ€æœ¯æ ˆ

åç«¯: SpringBoot3.1.xã€Mysql8.0ã€MybatisPlus

å‰ç«¯: Vue3ã€Viteã€ElementPlus

å°ç¨‹åº: Uniappã€Uview

> é—®é¢˜å¾®ä¿¡æ·»åŠ : BN\_Tang
> 
> å¤‡æ³¨: å¾®ä¿¡æ”¯ä»˜

ä¸€ã€Nativeæ¨¡å¼å›è°ƒ
============

### å½“ç”¨æˆ·æ”¯ä»˜å®Œæˆæ—¶å€™å¾®ä¿¡ä¼šä¸‹å‘ä¸€ä¸ªå›è°ƒåˆ°æˆ‘ä»¬ç³»ç»Ÿå½“ä¸­

è¯¥é“¾æ¥æ˜¯é€šè¿‡åŸºç¡€ä¸‹å•æ¥å£ä¸­çš„è¯·æ±‚å‚æ•°`notify_url`æ¥è®¾ç½®çš„ï¼Œè¦æ±‚å¿…é¡»ä¸ºhttpsåœ°å€ã€‚è¯·ç¡®ä¿å›è°ƒURLæ˜¯å¤–éƒ¨å¯æ­£å¸¸è®¿é—®çš„ï¼Œä¸”ä¸èƒ½æºå¸¦åç¼€å‚æ•°ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å•†æˆ·æ— æ³•æ¥æ”¶åˆ°å¾®ä¿¡çš„å›è°ƒé€šçŸ¥ä¿¡æ¯ã€‚å›è°ƒURLç¤ºä¾‹ï¼š â€œ[https://xxxxxx.com/api/wx-pay/native/notifyâ€](https://xxxxxx.com/api/wx-pay/native/notify%E2%80%9D)

### é€šçŸ¥è§„åˆ™

ç”¨æˆ·æ”¯ä»˜å®Œæˆåï¼Œå¾®ä¿¡ä¼šæŠŠç›¸å…³æ”¯ä»˜ç»“æœå’Œç”¨æˆ·ä¿¡æ¯å‘é€ç»™å•†æˆ·ï¼Œå•†æˆ·éœ€è¦æ¥æ”¶å¤„ç†è¯¥æ¶ˆæ¯ï¼Œå¹¶è¿”å›åº”ç­”ã€‚

å¯¹åå°é€šçŸ¥äº¤äº’æ—¶ï¼Œå¦‚æœå¾®ä¿¡æ”¶åˆ°å•†æˆ·çš„åº”ç­”ä¸ç¬¦åˆè§„èŒƒæˆ–è¶…æ—¶ï¼Œå¾®ä¿¡è®¤ä¸ºé€šçŸ¥å¤±è´¥ï¼Œå¾®ä¿¡ä¼šé€šè¿‡ä¸€å®šçš„ç­–ç•¥å®šæœŸé‡æ–°å‘èµ·é€šçŸ¥ï¼Œå°½å¯èƒ½æé«˜é€šçŸ¥çš„æˆåŠŸç‡ï¼Œä½†å¾®ä¿¡ä¸ä¿è¯é€šçŸ¥æœ€ç»ˆèƒ½æˆåŠŸã€‚ï¼ˆé€šçŸ¥é¢‘ç‡ä¸º15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - æ€»è®¡ 24h4mï¼‰

#### OK æˆ‘ä»¬åœ¨ä¸‹å•çš„æ—¶å€™è®¾ç½®äº†å›è°ƒå¿…é¡»æ˜¯HTTPSçš„SSLè¯ä¹¦çš„

æ­å»ºæœ¬åœ°è°ƒè¯• åˆ°æ—¶å€™ä¸Šçº¿çš„æ—¶å€™å°±æ›¿æ¢åŸŸåå³å¯

åŒå­¦ä»¬å¯ä»¥ä½¿ç”¨å…è´¹çš„å†…ç½‘ç©¿é€,ä½¿ç”¨æ–¹å¼å®˜æ–¹æ–‡æ¡£å¾ˆè¯¦ç»†ä»”ç»†çœ‹æˆ‘è¿™å°±ä¸è®²è§£.

*   [https://www.ngrok.cc/](https://www.ngrok.cc/) Sunny-Ngrok
    *   æä¾›å…è´¹å†…ç½‘ç©¿é€æœåŠ¡ï¼Œå…è´¹æœåŠ¡å™¨æ”¯æŒç»‘å®šè‡ªå®šä¹‰åŸŸå
    *   ç®¡ç†å†…ç½‘æœåŠ¡å™¨ï¼Œå†…ç½‘webè¿›è¡Œæ¼”ç¤º
    *   å¿«é€Ÿå¼€å‘å¾®ä¿¡ç¨‹åºå’Œç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°è°ƒè¯•
    *   æœ¬åœ°WEBå¤–ç½‘è®¿é—®ã€æœ¬åœ°å¼€å‘å¾®ä¿¡ã€TCPç«¯å£è½¬å‘
    *   æœ¬ç«™æ–°å¢FRPæœåŠ¡å™¨ï¼ŒåŸºäº [FRP](http://github.com/fatedier/frp) å®ç°httpsã€udpè½¬å‘
    *   æ— éœ€ä»»ä½•é…ç½®ï¼Œä¸‹è½½å®¢æˆ·ç«¯ä¹‹åç›´æ¥ä¸€æ¡å‘½ä»¤è®©å¤–ç½‘è®¿é—®æ‚¨çš„å†…ç½‘ä¸å†æ˜¯è·ç¦»

ç›®å‰åšä¸»ä½¿ç”¨çš„æ˜¯èŠ±ç”Ÿå£³ æ”¶è´¹ä¹Ÿå°±6å—é’± ç»™äº†ä¸¤ä¸ªSSLçš„åŸŸåé€Ÿåº¦è¿˜å¯ä»¥

*   [https://hsk.oray.com/](https://hsk.oray.com/) èŠ±ç”Ÿå£³ğŸ¥œ so easy to happyçš„ä¸œè¥¿
*   æ— éœ€ä¾èµ–å…¬ç½‘IPã€æ— éœ€é…ç½®è·¯ç”±å™¨ï¼ŒèŠ±ç”Ÿå£³æ”¯æŒåœ¨å®¢æˆ·ç«¯ä¸Š
*   æ·»åŠ ç«¯å£æ˜ å°„ï¼Œå¿«é€Ÿå°†å†…ç½‘æœåŠ¡å‘å¸ƒåˆ°å¤–ç½‘

![image-20230614235701735](https://img2023.cnblogs.com/blog/1735255/202307/1735255-20230729210037235-859746005.webp)

å¼€å¯å†…ç½‘ç©¿é€ä»£ç†åœ°å€åˆ°æœ¬åœ° `127.0.0.1:9080`

ä¿®æ”¹ `wxpay.properties` å½“ä¸­ `wxpay.notify-domain` å‚æ•°ä¸ºä½ çš„å†…ç½‘ç©¿é€åœ°å€

![image-20230615000333650](https://img2023.cnblogs.com/blog/1735255/202307/1735255-20230729210035858-2071210797.webp)

æ”¯ä»˜é€šçŸ¥
----

### é€šçŸ¥æŠ¥æ–‡

æ”¯ä»˜ç»“æœé€šçŸ¥æ˜¯ä»¥POST æ–¹æ³•è®¿é—®å•†æˆ·è®¾ç½®çš„é€šçŸ¥urlï¼Œé€šçŸ¥çš„æ•°æ®ä»¥JSON æ ¼å¼é€šè¿‡è¯·æ±‚ä¸»ä½“ï¼ˆBODYï¼‰ä¼ è¾“ã€‚é€šçŸ¥çš„æ•°æ®åŒ…æ‹¬äº†åŠ å¯†çš„æ”¯ä»˜ç»“æœè¯¦æƒ…ã€‚  
ï¼ˆæ³¨ï¼šç”±äºæ¶‰åŠåˆ°å›è°ƒåŠ å¯†å’Œè§£å¯†ï¼Œå•†æˆ·å¿…é¡»å…ˆè®¾ç½®å¥½apiv3ç§˜é’¥åæ‰èƒ½è§£å¯†å›è°ƒé€šçŸ¥ï¼Œapiv3ç§˜é’¥è®¾ç½®æ–‡æ¡£æŒ‡å¼•è¯¦è§[APIv3ç§˜é’¥è®¾ç½®æŒ‡å¼•](https://kf.qq.com/faq/180830E36vyQ180830AZFZvu.html)ï¼‰

> ä¸Šé¢çš„ä¸ºå•†æˆ·APIV3çš„å¯†é’¥ä¹‹å‰æˆ‘ä»¬å·²ç»è®¾ç½®å¥½äº†è¿˜æœªè®¾ç½®çš„è¯·å‚è€ƒå¼€ç¯‡->è·å–APIv3ç§˜é’¥(åç»­éƒ½æ˜¯ä½¿ç”¨è¿™ä¸ªç§˜é’¥)

### é€šçŸ¥ç­¾å

åŠ å¯†ä¸èƒ½ä¿è¯é€šçŸ¥è¯·æ±‚æ¥è‡ªå¾®ä¿¡ã€‚å¾®ä¿¡ä¼šå¯¹å‘é€ç»™å•†æˆ·çš„é€šçŸ¥è¿›è¡Œç­¾åï¼Œå¹¶å°†ç­¾åå€¼æ”¾åœ¨é€šçŸ¥çš„HTTPå¤´Wechatpay-Signatureã€‚å•†æˆ·åº”å½“éªŒè¯ç­¾åï¼Œä»¥ç¡®è®¤è¯·æ±‚æ¥è‡ªå¾®ä¿¡ï¼Œè€Œä¸æ˜¯å…¶ä»–çš„ç¬¬ä¸‰æ–¹ã€‚ç­¾åéªŒè¯çš„ç®—æ³•è¯·å‚è€ƒ [ã€Šå¾®ä¿¡æ”¯ä»˜API v3ç­¾åéªŒè¯ã€‹](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_1.shtml)ã€‚

> å®˜æ–¹è¯è¯­æˆ‘å°±ä¸è¯´äº†æ„Ÿå…´è¶£çš„å»çœ‹æ–‡æ¡£è¯¦ç»†çš„

### æ€»ç»“ä¸€ä¸‹å›è°ƒéœ€è¦å¹²çš„äº‹æƒ…

### 1.ç­¾åéªŒè¯

* * *

> å¤„ç†ç­¾åéªŒè¯

æ„é€ éªŒç­¾åä¸²

é¦–å…ˆï¼Œå•†æˆ·å…ˆä»åº”ç­”ä¸­è·å–ä»¥ä¸‹ä¿¡æ¯ã€‚

*   HTTPå¤´`Wechatpay-Timestamp` ä¸­çš„åº”ç­”æ—¶é—´æˆ³ã€‚
*   HTTPå¤´`Wechatpay-Nonce` ä¸­çš„åº”ç­”éšæœºä¸²ã€‚
*   åº”ç­”ä¸»ä½“ï¼ˆresponse Bodyï¼‰ï¼Œéœ€è¦æŒ‰ç…§æ¥å£è¿”å›çš„é¡ºåºè¿›è¡ŒéªŒç­¾ï¼Œé”™è¯¯çš„é¡ºåºå°†å¯¼è‡´éªŒç­¾å¤±è´¥ã€‚

ç„¶åï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹è§„åˆ™æ„é€ åº”ç­”çš„éªŒç­¾åä¸²ã€‚ç­¾åä¸²å…±æœ‰ä¸‰è¡Œï¼Œè¡Œå°¾ä»¥`\n` ç»“æŸï¼ŒåŒ…æ‹¬æœ€åä¸€è¡Œã€‚`\n`ä¸ºæ¢è¡Œç¬¦ï¼ˆASCIIç¼–ç å€¼ä¸º0x0Aï¼‰ã€‚è‹¥åº”ç­”æŠ¥æ–‡ä¸»ä½“ä¸ºç©ºï¼ˆå¦‚HTTPçŠ¶æ€ç ä¸º`204 No Content`ï¼‰ï¼Œæœ€åä¸€è¡Œä»…ä¸ºä¸€ä¸ª`\n`æ¢è¡Œç¬¦ã€‚

    åº”ç­”æ—¶é—´æˆ³\n
    åº”ç­”éšæœºä¸²\n
    åº”ç­”æŠ¥æ–‡ä¸»ä½“\n
    

æˆ‘ä»¬å¯ä»¥çœ‹å¾®ä¿¡å®ƒæ˜¯å’‹éªŒè¯çš„æˆ‘ä»¬å°±æ ¹æ®æ–‡æ¡£çš„è¦æ±‚æ”¹é€ ä¸€ä¸‹å­å°±è¡Œidea æŒ‰ä¸¤ä¸‹ shift æœç´¢ `WechatPay2Validator`

> å¼•ç”¨åœ°å€: com.wechat.pay.contrib.apache.httpclient.auth.WechatPay2Validator

![image-20230618212514056](https://img2023.cnblogs.com/blog/1735255/202307/1735255-20230729210050092-1635890676.webp)

> å¥½åƒå•Š ç›´æ¥Copy æ–°å¢wechatæ–‡ä»¶å¤¹å¤åˆ¶åˆ°è¯¥æ–‡ä»¶å¤¹å½“ä¸­ å‘½åä¸º WechatPay2ValidatorForRequest

#### æ¨¡ä»¿å¾®ä¿¡éªŒè¯ç­¾åï¼Œè‡ªå®šä¹‰æ”¯ä»˜é€šçŸ¥APIéªŒè¯ç­¾åï¼Œé’ˆå¯¹é€šçŸ¥è¯·æ±‚çš„ç­¾åéªŒè¯

æ”¹é€ æ„é€ å‡½æ•°

    // å›è°ƒæŠ¥æ–‡
    protected final String body;
    // å›è°ƒå”¯ä¸€ID æ²¡å•¥ç”¨åæ­£åŸæ¥å­˜åœ¨æˆ‘ä»¬å°±æ”¾åœ¨è¿™å‘—
    protected final String requestId;
    
    /**
     * å¾®ä¿¡éªŒè¯å™¨
     *
     * @param verifier  éªŒè¯å™¨
     * @param requestId è¯·æ±‚id
     * @param body      å¾®ä¿¡å›è°ƒçš„body
     */
    public WechatPay2ValidatorForRequest(Verifier verifier, String requestId, String body) {
        this.verifier = verifier;
        this.requestId = requestId;
        this.body = body;
    }
    

æ”¹é€ éªŒè¯æ–¹æ³•

    /**
     * éªŒè¯
     *
     * @param request è¯·æ±‚
     * @return boolean æ˜¯å¦æˆåŠŸ
     * @throws IOException ioexception
     */
    public final boolean validate(HttpServletRequest request) throws IOException {
        try {
            // è°ƒç”¨éªŒè¯å›è°ƒå‚æ•°
            validateParameters(request);
    
            // éªŒç­¾å­—ç¬¦ä¸²
            String message = buildMessage(request);
            String serial = request.getHeader(WECHAT_PAY_SERIAL);
            // ç­¾å
            String signature = request.getHeader(WECHAT_PAY_SIGNATURE);
    
            // è¿›è¡ŒéªŒè¯
            if (!verifier.verify(serial, message.getBytes(StandardCharsets.UTF_8), signature)) {
                throw verifyFail("serial=[%s] message=[%s] sign=[%s], request-id=[%s]",
                        serial, message, signature, request.getHeader(REQUEST_ID));
            }
        } catch (IllegalArgumentException e) {
            log.warn(e.getMessage());
            return false;
        }
        return true;
    }
    
    
        /**
         * æ„å»ºéªŒè¯ç­¾åæ¶ˆæ¯
         * å‚è€ƒæ–‡æ¡£ï¼š<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_1.shtml">å‚è€ƒæ–‡æ¡£</a>
         * <p>
         * æ„é€ éªŒç­¾åä¸²
         * é¦–å…ˆï¼Œå•†æˆ·å…ˆä»åº”ç­”ä¸­è·å–ä»¥ä¸‹ä¿¡æ¯ã€‚
         * <p>
         * HTTPå¤´Wechatpay-Timestamp ä¸­çš„åº”ç­”æ—¶é—´æˆ³ã€‚
         * HTTPå¤´Wechatpay-Nonce ä¸­çš„åº”ç­”éšæœºä¸²ã€‚
         * åº”ç­”ä¸»ä½“ï¼ˆresponse Bodyï¼‰ï¼Œéœ€è¦æŒ‰ç…§æ¥å£è¿”å›çš„é¡ºåºè¿›è¡ŒéªŒç­¾ï¼Œé”™è¯¯çš„é¡ºåºå°†å¯¼è‡´éªŒç­¾å¤±è´¥ã€‚
         * ç„¶åï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹è§„åˆ™æ„é€ åº”ç­”çš„éªŒç­¾åä¸²ã€‚ç­¾åä¸²å…±æœ‰ä¸‰è¡Œï¼Œè¡Œå°¾ä»¥\n ç»“æŸï¼ŒåŒ…æ‹¬æœ€åä¸€è¡Œã€‚\nä¸ºæ¢è¡Œç¬¦ï¼ˆASCIIç¼–ç å€¼ä¸º0x0Aï¼‰ã€‚
         * è‹¥åº”ç­”æŠ¥æ–‡ä¸»ä½“ä¸ºç©ºï¼ˆå¦‚HTTPçŠ¶æ€ç ä¸º204 No Contentï¼‰ï¼Œæœ€åä¸€è¡Œä»…ä¸ºä¸€ä¸ª\næ¢è¡Œç¬¦ã€‚
         * <p>
         ************************************
         * åº”ç­”æ—¶é—´æˆ³\n
         * åº”ç­”éšæœºä¸²\n
         * åº”ç­”æŠ¥æ–‡ä¸»ä½“\n
         ************************************
         * <p>
         *
         * @param request è¯·æ±‚
         * @return {@link String}
         * @throws IOException ioexception
         */
        protected final String buildMessage(HttpServletRequest request) throws IOException {
            String timestamp = request.getHeader(WECHAT_PAY_TIMESTAMP);
            String nonce = request.getHeader(WECHAT_PAY_NONCE);
            return timestamp + "\n"
                    + nonce + "\n"
                    + body + "\n";
        }
    

æ”¹é€ éªŒè¯å›è°ƒå‚æ•°

    /**
     * éªŒè¯å‚æ•°
     *
     * @param request è¯·æ±‚
     */
    protected final void validateParameters(HttpServletRequest request) {
    
        // NOTE: ensure HEADER_WECHAT_PAY_TIMESTAMP at last
        String[] headers = {WECHAT_PAY_SERIAL, WECHAT_PAY_SIGNATURE, WECHAT_PAY_NONCE, WECHAT_PAY_TIMESTAMP};
    
        // è¿™äº›å¤´å¿…é¡»å­˜åœ¨å¦åˆ™ç›´æ¥æ˜¯ä¼ªé€ 
        String header = null;
        for (String headerName : headers) {
            header = request.getHeader(headerName);
            if (header == null) {
                throw parameterError("empty [%s], request-id=[%s]", headerName, requestId);
            }
        }
    
        // å¾ªç¯å®Œæ¯•ç›´æ¥é»˜è®¤è¢«èµ‹å€¼æ˜¯æ—¶é—´æˆ³
        String timestampStr = header;
        try {
            // éªŒè¯è¿‡æœŸåº”ç­”
            Instant responseTime = Instant.ofEpochSecond(Long.parseLong(timestampStr));
            // æ‹’ç»è¿‡æœŸåº”ç­”
            if (Duration.between(responseTime, Instant.now()).abs().toMinutes() >= RESPONSE_EXPIRED_MINUTES) {
                throw parameterError("timestamp=[%s] expires, request-id=[%s]", timestampStr, requestId);
            }
        } catch (DateTimeException | NumberFormatException e) {
            throw parameterError("invalid timestamp=[%s], request-id=[%s]", timestampStr, requestId);
        }
    }
    

å®Œæ•´ä»£ç  è‡ªå®šä¹‰éªŒè¯ç­¾åå™¨

    package com.yby6.wechat;
    
    
    import com.wechat.pay.contrib.apache.httpclient.auth.Verifier;
    import jakarta.servlet.http.HttpServletRequest;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    
    import java.io.IOException;
    import java.nio.charset.StandardCharsets;
    import java.time.DateTimeException;
    import java.time.Duration;
    import java.time.Instant;
    
    import static com.wechat.pay.contrib.apache.httpclient.constant.WechatPayHttpHeaders.*;
    
    
    /**
     * æ¨¡ä»¿å¾®ä¿¡éªŒè¯ç­¾åï¼Œè‡ªå®šä¹‰æ”¯ä»˜é€šçŸ¥APIéªŒè¯ç­¾åï¼Œé’ˆå¯¹é€šçŸ¥è¯·æ±‚çš„ç­¾åéªŒè¯
     *
     * @author Yang Shuai
     * Create By 2023/06/18
     */
    public class WechatPay2ValidatorForRequest {
    
        protected static final Logger log = LoggerFactory.getLogger(WechatPay2ValidatorForRequest.class);
        /**
         * åº”ç­”è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºåˆ†é’Ÿ
         */
        protected static final long RESPONSE_EXPIRED_MINUTES = 5;
        protected final Verifier verifier;
        protected final String body;
        protected final String requestId;
    
        /**
         * å¾®ä¿¡éªŒè¯å™¨
         *
         * @param verifier  éªŒè¯å™¨
         * @param requestId è¯·æ±‚id
         * @param body      å¾®ä¿¡å›è°ƒçš„body
         */
        public WechatPay2ValidatorForRequest(Verifier verifier, String requestId, String body) {
            this.verifier = verifier;
            this.requestId = requestId;
            this.body = body;
        }
    
        /**
         * å‚æ•°é”™è¯¯
         *
         * @param message æ¶ˆæ¯
         * @return {@link IllegalArgumentException}
         */
        protected static IllegalArgumentException parameterError(String message, Object... args) {
            message = String.format(message, args);
            return new IllegalArgumentException("parameter error: " + message);
        }
    
        /**
         * éªŒè¯å¤±è´¥
         *
         * @param message æ¶ˆæ¯
         * @return {@link IllegalArgumentException}
         */
        protected static IllegalArgumentException verifyFail(String message, Object... args) {
            message = String.format(message, args);
            return new IllegalArgumentException("signature verify fail: " + message);
        }
    
        /**
         * éªŒè¯
         *
         * @param request è¯·æ±‚
         * @return boolean æ˜¯å¦æˆåŠŸ
         * @throws IOException ioexception
         */
        public final boolean validate(HttpServletRequest request) throws IOException {
            try {
                // è°ƒç”¨éªŒè¯å›è°ƒå‚æ•°
                validateParameters(request);
    
                // éªŒç­¾å­—ç¬¦ä¸²
                String message = buildMessage(request);
                String serial = request.getHeader(WECHAT_PAY_SERIAL);
                // ç­¾å
                String signature = request.getHeader(WECHAT_PAY_SIGNATURE);
    
                // è¿›è¡ŒéªŒè¯
                if (!verifier.verify(serial, message.getBytes(StandardCharsets.UTF_8), signature)) {
                    throw verifyFail("serial=[%s] message=[%s] sign=[%s], request-id=[%s]",
                            serial, message, signature, request.getHeader(REQUEST_ID));
                }
            } catch (IllegalArgumentException e) {
                log.warn(e.getMessage());
                return false;
            }
            return true;
        }
    
        /**
         * éªŒè¯å‚æ•°
         *
         * @param request è¯·æ±‚
         */
        protected final void validateParameters(HttpServletRequest request) {
    
            // NOTE: ensure HEADER_WECHAT_PAY_TIMESTAMP at last
            String[] headers = {WECHAT_PAY_SERIAL, WECHAT_PAY_SIGNATURE, WECHAT_PAY_NONCE, WECHAT_PAY_TIMESTAMP};
    
            // è¿™äº›å¤´å¿…é¡»å­˜åœ¨å¦åˆ™ç›´æ¥æ˜¯ä¼ªé€ 
            String header = null;
            for (String headerName : headers) {
                header = request.getHeader(headerName);
                if (header == null) {
                    throw parameterError("empty [%s], request-id=[%s]", headerName, requestId);
                }
            }
    
            // å¾ªç¯å®Œæ¯•ç›´æ¥é»˜è®¤è¢«èµ‹å€¼æ˜¯æ—¶é—´æˆ³
            String timestampStr = header;
            try {
                // éªŒè¯è¿‡æœŸåº”ç­”
                Instant responseTime = Instant.ofEpochSecond(Long.parseLong(timestampStr));
                // æ‹’ç»è¿‡æœŸåº”ç­”
                if (Duration.between(responseTime, Instant.now()).abs().toMinutes() >= RESPONSE_EXPIRED_MINUTES) {
                    throw parameterError("timestamp=[%s] expires, request-id=[%s]", timestampStr, requestId);
                }
            } catch (DateTimeException | NumberFormatException e) {
                throw parameterError("invalid timestamp=[%s], request-id=[%s]", timestampStr, requestId);
            }
        }
    
        /**
         * æ„å»ºéªŒè¯ç­¾åæ¶ˆæ¯
         * å‚è€ƒæ–‡æ¡£ï¼š<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_1.shtml">å‚è€ƒæ–‡æ¡£</a>
         * <p>
         * æ„é€ éªŒç­¾åä¸²
         * é¦–å…ˆï¼Œå•†æˆ·å…ˆä»åº”ç­”ä¸­è·å–ä»¥ä¸‹ä¿¡æ¯ã€‚
         * <p>
         * HTTPå¤´Wechatpay-Timestamp ä¸­çš„åº”ç­”æ—¶é—´æˆ³ã€‚
         * HTTPå¤´Wechatpay-Nonce ä¸­çš„åº”ç­”éšæœºä¸²ã€‚
         * åº”ç­”ä¸»ä½“ï¼ˆresponse Bodyï¼‰ï¼Œéœ€è¦æŒ‰ç…§æ¥å£è¿”å›çš„é¡ºåºè¿›è¡ŒéªŒç­¾ï¼Œé”™è¯¯çš„é¡ºåºå°†å¯¼è‡´éªŒç­¾å¤±è´¥ã€‚
         * ç„¶åï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹è§„åˆ™æ„é€ åº”ç­”çš„éªŒç­¾åä¸²ã€‚ç­¾åä¸²å…±æœ‰ä¸‰è¡Œï¼Œè¡Œå°¾ä»¥\n ç»“æŸï¼ŒåŒ…æ‹¬æœ€åä¸€è¡Œã€‚\nä¸ºæ¢è¡Œç¬¦ï¼ˆASCIIç¼–ç å€¼ä¸º0x0Aï¼‰ã€‚
         * è‹¥åº”ç­”æŠ¥æ–‡ä¸»ä½“ä¸ºç©ºï¼ˆå¦‚HTTPçŠ¶æ€ç ä¸º204 No Contentï¼‰ï¼Œæœ€åä¸€è¡Œä»…ä¸ºä¸€ä¸ª\næ¢è¡Œç¬¦ã€‚
         * <p>
         ************************************
         * åº”ç­”æ—¶é—´æˆ³\n
         * åº”ç­”éšæœºä¸²\n
         * åº”ç­”æŠ¥æ–‡ä¸»ä½“\n
         ************************************
         * <p>
         *
         * @param request è¯·æ±‚
         * @return {@link String}
         * @throws IOException ioexception
         */
        protected final String buildMessage(HttpServletRequest request) throws IOException {
            String timestamp = request.getHeader(WECHAT_PAY_TIMESTAMP);
            String nonce = request.getHeader(WECHAT_PAY_NONCE);
            return timestamp + "\n"
                    + nonce + "\n"
                    + body + "\n";
        }
    }
    

* * *

> å¤„ç†æŠ¥æ–‡è§£å¯†

### 2.éªŒè¯æˆåŠŸåè§£å¯†åŠ å¯†çš„æŠ¥æ–‡

### å‚æ•°è§£å¯†

ä¸‹é¢è¯¦ç»†æè¿°å¯¹é€šçŸ¥æ•°æ®è¿›è¡Œè§£å¯†çš„æµç¨‹ï¼š

1.  1ã€ç”¨å•†æˆ·å¹³å°ä¸Šè®¾ç½®çš„APIv3å¯†é’¥ã€[å¾®ä¿¡å•†æˆ·å¹³å°](https://pay.weixin.qq.com/)â€”>è´¦æˆ·è®¾ç½®â€”>APIå®‰å…¨â€”>è®¾ç½®APIv3å¯†é’¥ã€‘ï¼Œè®°ä¸ºkeyï¼›
2.  2ã€é’ˆå¯¹resource.algorithmä¸­æè¿°çš„ç®—æ³•ï¼ˆç›®å‰ä¸ºAEAD\_AES\_256\_GCMï¼‰ï¼Œå–å¾—å¯¹åº”çš„å‚æ•°nonceå’Œassociated\_dataï¼›
3.  3ã€ä½¿ç”¨keyã€nonceå’Œassociated\_dataï¼Œå¯¹æ•°æ®å¯†æ–‡resource.ciphertextè¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°JSONå½¢å¼çš„èµ„æºå¯¹è±¡ï¼›

**æ³¨ï¼š** AEAD\_AES\_256\_GCMç®—æ³•çš„æ¥å£ç»†èŠ‚ï¼Œè¯·å‚è€ƒ[rfc5116](https://datatracker.ietf.org/doc/html/rfc5116)ã€‚å¾®ä¿¡æ”¯ä»˜ä½¿ç”¨çš„å¯†é’¥keyé•¿åº¦ä¸º32ä¸ªå­—èŠ‚ï¼Œéšæœºä¸²nonceé•¿åº¦12ä¸ªå­—èŠ‚ï¼Œassociated\_dataé•¿åº¦å°äº16ä¸ªå­—èŠ‚å¹¶å¯èƒ½ä¸ºç©ºå­—ç¬¦ä¸²ã€‚

### è¯ä¹¦å’Œå›è°ƒæŠ¥æ–‡è§£å¯†

ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œå¾®ä¿¡æ”¯ä»˜åœ¨å›è°ƒé€šçŸ¥å’Œå¹³å°è¯ä¹¦ä¸‹è½½æ¥å£ä¸­ï¼Œå¯¹å…³é”®ä¿¡æ¯è¿›è¡Œäº†AES-256-GCMåŠ å¯†ã€‚æœ¬ç« èŠ‚è¯¦ç»†ä»‹ç»äº†åŠ å¯†æŠ¥æ–‡çš„æ ¼å¼ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œè§£å¯†ã€‚

### å¾®ä¿¡è¿”å›æ¥çš„åŠ å¯†æŠ¥æ–‡æ ¼å¼

`AES-GCM`æ˜¯ä¸€ç§NISTæ ‡å‡†çš„[è®¤è¯åŠ å¯†](https://zh.wikipedia.org/wiki/%E8%AE%A4%E8%AF%81%E5%8A%A0%E5%AF%86)ç®—æ³•ï¼Œ æ˜¯ä¸€ç§èƒ½å¤ŸåŒæ—¶ä¿è¯æ•°æ®çš„ä¿å¯†æ€§ã€ å®Œæ•´æ€§å’ŒçœŸå®æ€§çš„ä¸€ç§åŠ å¯†æ¨¡å¼ã€‚å®ƒæœ€å¹¿æ³›çš„åº”ç”¨æ˜¯åœ¨TLSä¸­ã€‚

`è¯ä¹¦å’Œå›è°ƒæŠ¥æ–‡ä½¿ç”¨çš„åŠ å¯†å¯†é’¥ä¸º`[APIv3å¯†é’¥](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_2.shtml)ã€‚

å¯¹äºåŠ å¯†çš„æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªç‹¬ç«‹çš„JSONå¯¹è±¡æ¥è¡¨ç¤ºã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œç¤ºä¾‹åšäº†Prettyæ ¼å¼åŒ–ï¼Œå¹¶åŠ å…¥äº†æ³¨é‡Šã€‚

    {
    	"original_type": "transaction", // åŠ å¯†å‰çš„å¯¹è±¡ç±»å‹
    	"algorithm": "AEAD_AES_256_GCM", // åŠ å¯†ç®—æ³•
    
    	// Base64ç¼–ç åçš„å¯†æ–‡
    	"ciphertext": "...",
    	// åŠ å¯†ä½¿ç”¨çš„éšæœºä¸²åˆå§‹åŒ–å‘é‡ï¼‰
    	"nonce": "...",
    	// é™„åŠ æ•°æ®åŒ…ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
    	"associated_data": ""
    }
    

> âš ï¸ åŠ å¯†çš„éšæœºä¸²ï¼Œè·Ÿç­¾åæ—¶ä½¿ç”¨çš„éšæœºä¸²æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæ˜¯ä¸ä¸€æ ·çš„ã€‚

### è§£å¯†

ç®—æ³•æ¥å£çš„ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒ[RFC 5116](https://datatracker.ietf.org/doc/html/rfc5116)ã€‚

å¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€ï¼ˆè¾ƒæ–°ç‰ˆæœ¬ï¼‰éƒ½æ”¯æŒäº†`AEAD_AES_256_GCM` ã€‚å¼€å‘è€…å¯ä»¥å‚è€ƒä¸‹åˆ—çš„ç¤ºä¾‹ï¼Œäº†è§£å¦‚ä½•ä½¿ç”¨æ‚¨çš„ç¼–ç¨‹è¯­è¨€å®ç°è§£å¯†ã€‚

    æˆ‘ä»¬å¼•å…¥çš„SDKå·²ç»æœ‰å·¥å…·ç±»ç›´æ¥ç”¨ com.wechat.pay.contrib.apache.httpclient.util.AesUtil
    

> åˆ›å»ºå¤„ç†è¿”å›çš„ `\n` çš„æŠ¥æ–‡è½¬json

    package com.yby6.wechat;
    
    import cn.hutool.json.JSONUtil;
    import jakarta.servlet.http.HttpServletRequest;
    
    import java.io.BufferedReader;
    import java.io.IOException;
    import java.util.HashMap;
    import java.util.Map;
    
    
    /**
     * ç”¨äºè§£æå¾®ä¿¡æ”¯ä»˜å›è°ƒçš„æ•°æ®
     *
     * @author Yang Shuai
     * Create By 2023/06/14
     */
    public class HttpUtils {
    
        /**
         * åˆ†ææ•°æ®
         *
         * @param request è¯·æ±‚
         * @return {@link Map}<{@link String}, {@link Object}>
         */
        public static Map<String, Object> analysisData(HttpServletRequest request) {
            String body = HttpUtils.readData(request);
            return JSONUtil.toBean(body, HashMap.class);
        }
    
        /**
         * å°†é€šçŸ¥å‚æ•°è½¬åŒ–ä¸ºå­—ç¬¦ä¸²
         */
        public static String readData(HttpServletRequest request) {
            BufferedReader br = null;
            try {
                StringBuilder result = new StringBuilder();
                br = request.getReader();
                for (String line; (line = br.readLine()) != null; ) {
                    if (result.length() > 0) {
                        result.append("\n");
                    }
                    result.append(line);
                }
                return result.toString();
            } catch (IOException e) {
                throw new RuntimeException(e);
            } finally {
                if (br != null) {
                    try {
                        br.close();
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                }
            }
        }
    }
    

> çŸ¥è¯†ç‚¹å°±è¿™äº›äº† å®ç°ä¸€æ‰‹
> 
> åˆ›å»º nativeNotify æ˜ å°„æ–¹æ³•

    /**
     * æ”¯ä»˜é€šçŸ¥->å¾®ä¿¡æ”¯ä»˜é€šè¿‡æ”¯ä»˜é€šçŸ¥æ¥å£å°†ç”¨æˆ·æ”¯ä»˜æˆåŠŸæ¶ˆæ¯é€šçŸ¥ç»™å•†æˆ·
     * å‚è€ƒï¼š<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_5.shtml">...</a>
     */
    @PostMapping("/notify")
        public Map<String, String> nativeNotify(HttpServletRequest request, HttpServletResponse response) {
            log.info("æ¥æ”¶åˆ°å¾®ä¿¡æœåŠ¡å›è°ƒ......");
            try {
                //å¤„ç†é€šçŸ¥å‚æ•°
                String body = HttpUtils.readData(request);
                Map<String, Object> bodyMap = JSONUtil.toBean(body, HashMap.class);
                String requestId = (String) bodyMap.get("id");
                log.info("æ”¯ä»˜é€šçŸ¥çš„id ===> {}", requestId);
    
                // ç­¾åçš„éªŒè¯
                WechatPay2ValidatorForRequest wechatPay2ValidatorForRequest = new WechatPay2ValidatorForRequest(verifier, requestId, body);
                if (!wechatPay2ValidatorForRequest.validate(request)) {
                    log.error("é€šçŸ¥éªŒç­¾å¤±è´¥");
                    //å¤±è´¥åº”ç­”
                    response.setStatus(500);
                    return WechatRep.fail();
                }
                log.info("é€šçŸ¥éªŒç­¾æˆåŠŸï¼š{}", bodyMap);
                log.info("å›è°ƒä¸šåŠ¡å¤„ç†å®Œæ¯•");
                // æˆåŠŸåº”ç­”
                response.setStatus(200);
                return WechatRep.ok();
            } catch (Exception e) {
                log.error("å¤„ç†å¾®ä¿¡å›è°ƒå¤±è´¥ï¼š", e);
                // å¤±è´¥åº”ç­”
                response.setStatus(500);
                return WechatRep.fail();
            }
    
        }
    

å¯åŠ¨é¡¹ç›®æµ‹è¯•æµç¨‹
--------

å¼€å¯å†…ç½‘ç©¿é€ æ˜ å°„ä½ å¯åŠ¨é¡¹ç›®çš„ç«¯å£ è‡ªå·±è®¿é—®ä¸€ä¸‹æ˜¯å¦é€š

å¯åŠ¨ç¨‹åº è¯·æ±‚ä¸‹å•æ¥å£ `/api/wx-pay/native/native/{productId}`

> {productId} æŸ¥çœ‹å•†å“è¡¨æ•°æ®çš„ID

å¤åˆ¶è¿”å›çš„å¾®ä¿¡äºŒç»´ç åœ°å€

è¿›å…¥ [https://cli.im/url](https://cli.im/url) ç”Ÿæˆæ‰«æäºŒç»´ç  ä½¿ç”¨å¾®ä¿¡æ‰«æ

ç­‰å¾…å¾®ä¿¡å›è°ƒ

![image-20230618222248672](https://img2023.cnblogs.com/blog/1735255/202307/1735255-20230729210036369-1061889597.webp)

> okæˆ‘ä»¬å¯ä»¥æ­£å¸¸çš„æ¥æ”¶åˆ°å¾®ä¿¡çš„å›è°ƒæˆ‘ä»¬éœ€è¦æ ¹æ®å›è°ƒçš„æ•°æ®æ¥å¤„ç†è‡ªå·±ç³»ç»Ÿçš„ä¸šåŠ¡

ä¿®æ”¹å›è°ƒæ–¹æ³• æ–°å¢ `processOrder` ä¸šåŠ¡ä¼ é€’æŠ¥æ–‡

    log.info("é€šçŸ¥éªŒç­¾æˆåŠŸï¼š{}", bodyMap);
    // é€šçŸ¥å›è°ƒ -> æ›´æ–°è®¢å•çŠ¶æ€é€»è¾‘
    wxPayService.processOrder(bodyMap);
    log.info("å›è°ƒä¸šåŠ¡å¤„ç†å®Œæ¯•");
    

ä¿®æ”¹ `WxPayService` æœåŠ¡ç±»

> å¯ä»¥æredsiåˆ†å¸ƒå¼é”æ ¹æ®å®é™…ä¸šåŠ¡æ¥æˆ‘ä»¬åªæ˜¯ä¸ªdemoå°±ä¸è¦é‚£ä¹ˆä¸¥è°¨

    /**
    * ä¸€ä¸ªå¯é‡å…¥äº’æ–¥ é”
    */
    private final ReentrantLock lock = new ReentrantLock();
    
    /**
     * é€šçŸ¥å›è°ƒ-> æ›´æ–°è®¢å•çŠ¶æ€é€»è¾‘
     */
    @Transactional(rollbackFor = Exception.class)
    @Override
    public void processOrder(Map<String, Object> bodyMap) throws GeneralSecurityException, InterruptedException {
        log.info("å¤„ç†è®¢å•");
    
        //è§£å¯†æŠ¥æ–‡
        String plainText = decryptFromResource(bodyMap);
    
    
            // å°†æ˜æ–‡è½¬æ¢æˆmap
            Map<String, Object> plainTextMap = JSONUtil.toBean(plainText, Map.class);
            String orderNo = (String) plainTextMap.get("out_trade_no");
    
        // å¾®ä¿¡ç‰¹åˆ«æé†’ï¼š
        // åœ¨å¯¹ä¸šåŠ¡æ•°æ®è¿›è¡ŒçŠ¶æ€æ£€æŸ¥å’Œå¤„ç†ä¹‹å‰ï¼Œ
        // è¦é‡‡ç”¨æ•°æ®é”è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼Œä»¥é¿å…å‡½æ•°é‡å…¥é€ æˆçš„æ•°æ®æ··ä¹±.
    
        // å°è¯•è·å–é”ï¼š
        // æˆåŠŸè·å–åˆ™ç«‹å³è¿”å›trueï¼Œè·å–å¤±è´¥åˆ™ç«‹å³è¿”å›falseã€‚ä¸å¿…ä¸€ç›´ç­‰å¾…é”çš„é‡Šæ”¾.
        if (lock.tryLock()) {
            try {
                // å¤„ç†é‡å¤çš„é€šçŸ¥
                // æ¥å£è°ƒç”¨çš„å¹‚ç­‰æ€§ï¼šæ— è®ºæ¥å£è¢«è°ƒç”¨å¤šå°‘æ¬¡ï¼Œäº§ç”Ÿçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚
                OrderInfo orderInfo = orderInfoService.lambdaQuery().eq(OrderInfo::getOrderNo, (orderNo)).one();
    
                if (null != orderInfo && !OrderStatus.NOTPAY.getType().equals(orderInfo.getOrderStatus())) {
                    log.info("é‡å¤çš„é€šçŸ¥,å·²ç»æ”¯ä»˜æˆåŠŸå•¦");
                    return;
                }
    
                // æ¨¡æ‹Ÿé€šçŸ¥å¹¶å‘
                //TimeUnit.SECONDS.sleep(5);
    
                // æ›´æ–°è®¢å•çŠ¶æ€
                orderInfoService.lambdaUpdate().eq(OrderInfo::getOrderNo, orderNo).set(OrderInfo::getOrderStatus, OrderStatus.SUCCESS.getType()).update();
                log.info("æ›´æ–°è®¢å•çŠ¶æ€,è®¢å•å·ï¼š{},è®¢å•çŠ¶æ€ï¼š{}", orderNo, OrderStatus.SUCCESS);
                // è®°å½•æ”¯ä»˜æ—¥å¿—
                paymentInfoService.createPaymentInfo(plainText);
            } finally {
                // è¦ä¸»åŠ¨é‡Šæ”¾é”
                lock.unlock();
            }
        }
    }
    

å‚æ•°è§£å¯†

    /**
     * å¯¹ç§°è§£å¯†
     */
    private String decryptFromResource(Map<String, Object> bodyMap) throws GeneralSecurityException {
        log.info("å¯†æ–‡è§£å¯†");
        //é€šçŸ¥æ•°æ®æ‹¿åˆ° resource èŠ‚ç‚¹
        Map<String, String> resourceMap = (Map) bodyMap.get("resource");
        //æ•°æ®å¯†æ–‡
        String ciphertext = resourceMap.get("ciphertext");
        //éšæœºä¸²
        String nonce = resourceMap.get("nonce");
        //é™„åŠ æ•°æ®
        String associatedData = resourceMap.get("associated_data");
        log.info("å¯†æ–‡ ===> {}", ciphertext);
        AesUtil aesUtil = new AesUtil(wxPayConfig.getApiV3Key().getBytes(StandardCharsets.UTF_8));
        // ä½¿ç”¨keyã€nonceå’Œassociated_dataï¼Œå¯¹æ•°æ®å¯†æ–‡resource.ciphertextè¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°JSONå½¢å¼çš„èµ„æºå¯¹è±¡
        String plainText = aesUtil.decryptToString(associatedData.getBytes(StandardCharsets.UTF_8), nonce.getBytes(StandardCharsets.UTF_8), ciphertext);
        log.info("æ˜æ–‡ ===> {}", plainText);
    
        return plainText;
    }
    

### è®°å½•æ”¯ä»˜æ—¥å¿—

å¼•å…¥

    /**
     * æ”¯ä»˜æ—¥å¿—
     */
    private final PaymentInfoService paymentInfoService;
    

ä¿®æ”¹ `PaymentInfoService`

    package com.yby6.service;
    
    import cn.hutool.core.map.MapUtil;
    import cn.hutool.json.JSONUtil;
    import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
    import com.yby6.domain.PaymentInfo;
    import com.yby6.enums.PayType;
    import com.yby6.mapper.PaymentInfoMapper;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.stereotype.Service;
    import org.springframework.transaction.annotation.Transactional;
    
    import java.util.Map;
    
    @Slf4j
    @Service
    public class PaymentInfoService extends ServiceImpl<PaymentInfoMapper, PaymentInfo> {
    
        /**
         * åˆ›å»ºä»˜æ¬¾ä¿¡æ¯
         *
         * @param plainText çº¯æ–‡æœ¬
         */
        @Transactional
        public void createPaymentInfo(String plainText) {
            log.info("è®°å½•æ”¯ä»˜æ—¥å¿—: {}", plainText);
            Map<String, Object> plainTextMap = JSONUtil.toBean(plainText, Map.class);
    
            //è®¢å•å·
            String orderNo = (String) plainTextMap.get("out_trade_no");
            //ä¸šåŠ¡ç¼–å·
            String transactionId = (String) plainTextMap.get("transaction_id");
            //æ”¯ä»˜ç±»å‹
            String tradeType = (String) plainTextMap.get("trade_type");
            //äº¤æ˜“çŠ¶æ€
            String tradeState = (String) plainTextMap.get("trade_state");
            //ç”¨æˆ·å®é™…æ”¯ä»˜é‡‘é¢
            Map<String, Object> amount = (Map<String, Object>) plainTextMap.get("amount");
    
            Integer payerTotal = MapUtil.getInt(amount, "payer_total");
    
            PaymentInfo paymentInfo = new PaymentInfo();
            paymentInfo.setOrderNo(orderNo);
            paymentInfo.setPaymentType(PayType.WXPAY.getType());
            paymentInfo.setTransactionId(transactionId);
            paymentInfo.setTradeType(tradeType);
            paymentInfo.setTradeState(tradeState);
            paymentInfo.setPayerTotal(payerTotal);
            paymentInfo.setContent(plainText);
            baseMapper.insert(paymentInfo);
        }
    }
    

å¯åŠ¨é¡¹ç›®æµ‹è¯•æµç¨‹
--------

å¼€å¯å†…ç½‘ç©¿é€ æ˜ å°„ä½ å¯åŠ¨é¡¹ç›®çš„ç«¯å£ è‡ªå·±è®¿é—®ä¸€ä¸‹æ˜¯å¦é€š

å¯åŠ¨ç¨‹åº è¯·æ±‚ä¸‹å•æ¥å£ `/api/wx-pay/native/native/{productId}`

> {productId} æŸ¥çœ‹å•†å“è¡¨æ•°æ®çš„ID

å¤åˆ¶è¿”å›çš„å¾®ä¿¡äºŒç»´ç åœ°å€

è¿›å…¥ [https://cli.im/url](https://cli.im/url) ç”Ÿæˆæ‰«æäºŒç»´ç  ä½¿ç”¨å¾®ä¿¡æ‰«æ

ç­‰å¾…å¾®ä¿¡å›è°ƒå¤„ç†ç³»ç»Ÿä¸šåŠ¡è®¢å•çŠ¶æ€æ›´æ”¹

![image-20230618230135867](https://img2023.cnblogs.com/blog/1735255/202307/1735255-20230729210035971-495103274.webp)

ä½ çš„å‹åŠ›æ¥æºäºæ— æ³•è‡ªå¾‹ï¼Œåªæ˜¯å‡è£…åŠªåŠ›ï¼Œç°çŠ¶è·Ÿä¸ä¸Šå†…å¿ƒæ¬²æœ›ï¼Œæ‰€ä»¥ä½ ç„¦è™‘åˆææ…Œã€‚â€”â€”æ¨ä¸æ˜“