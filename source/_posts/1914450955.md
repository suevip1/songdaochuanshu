---
layout: post
title: "iframeä¸ä¸»çª—å£é€šä¿¡"
date: "2023-07-27T01:04:15.919Z"
---
iframeä¸ä¸»çª—å£é€šä¿¡
============

![iframeä¸ä¸»çª—å£é€šä¿¡](https://img2023.cnblogs.com/blog/2393708/202307/2393708-20230727021846101-1261647706.png) æœ¬æ–‡ä¸»è¦è®°è¿°iframeå’Œä¸»çª—å£ä¹‹é—´çš„é€šä¿¡æ–¹å¼ï¼ŒåŒ…å«å†…ç½®æ–¹æ³•å’Œä½¿ç”¨Postmateåº“

1\. å¼•è¨€
------

<iframe> å…ƒç´ æ˜¯ HTML ä¸­çš„ä¸€ä¸ªæ ‡ç­¾ï¼Œç”¨äºåœ¨å½“å‰é¡µé¢ä¸­åµŒå…¥å¦ä¸€ä¸ªé¡µé¢

ä½¿ç”¨ `<iframe>` å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1.  åµŒå…¥å…¶ä»–ç½‘é¡µï¼šå¯ä»¥å°†å…¶ä»–ç½‘é¡µåµŒå…¥åˆ°å½“å‰é¡µé¢ä¸­ï¼Œä¾‹å¦‚æ˜¾ç¤ºåœ°å›¾ã€è§†é¢‘ã€æ–‡æ¡£ç­‰
2.  åµŒå…¥æœ¬åœ°é¡µé¢ï¼šå¯ä»¥å°†å…¶ä»–é¡µé¢æˆ–ç»„ä»¶åµŒå…¥åˆ°å½“å‰é¡µé¢ä¸­ï¼Œä»¥å®ç°æ¨¡å—åŒ–å’Œå¤ç”¨

åµŒå…¥çš„iframeå’Œä¸»ç½‘é¡µä¹‹é—´å…·æœ‰ä¸€å®šçš„ç‹¬ç«‹æ€§ï¼Œæ— æ³•åƒæ­£å¸¸çš„ä¸€ä¸ªç½‘é¡µä¸Šä¸‹æ–‡ä¸€æ ·è®¿é—®å†…å®¹ï¼Œå¦‚ä½•é€šä¿¡æˆä¸ºä¸€ä¸ªé—®é¢˜

æœ¬æ–‡ä¸»è¦è®°è¿°iframeå’Œä¸»çª—å£ä¹‹é—´çš„é€šä¿¡æ–¹å¼ï¼ŒåŒ…å«å†…ç½®æ–¹æ³•å’Œä½¿ç”¨Postmateåº“

2\. æ¦‚è¿°
------

`iframe`æ ‡ç­¾åœ¨JSä¸­å®šä¹‰ä¸º`HTMLIFrameElement`,è€Œ`HTMLIFrameElement.contentWindow`è¿”å›å½“å‰[HTMLIFrameElement](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLIFrameElement)çš„[Window](https://developer.mozilla.org/zh-CN/docs/Web/API/Window)å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ª`Window` å¯¹è±¡å»è®¿é—®è¿™ä¸ª iframe çš„æ–‡æ¡£å’Œå®ƒå†…éƒ¨çš„ DOM

`Window`å¯¹è±¡å¯ä»¥æ¥æ”¶æ¶ˆæ¯ï¼ˆ[onmessage - Web API æ¥å£å‚è€ƒ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/message_event)ï¼‰å’Œå‘é€æ¶ˆæ¯ï¼ˆ[window.postMessage - Web API æ¥å£å‚è€ƒ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage)ï¼‰

å¦å¤–ï¼Œ`Window`å¯¹è±¡è¿˜å­˜åœ¨çˆ¶å¯¹è±¡ï¼ˆ[window.parent - Web API æ¥å£å‚è€ƒ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/parent)ï¼‰ï¼Œå¯ä»¥é€šè¿‡`window.parent`è®¿é—®çˆ¶å¯¹è±¡

åˆ©ç”¨ä¸Šè¿°çš„æ–¹æ³•ä¸ç‰¹æ€§ï¼Œå°±å¯ä»¥å®ç°iframeå’Œä¸»çª—å£ä¹‹é—´çš„é€šè®¯

æ€è·¯ä¹‹ä¸€æ˜¯ï¼šå°†éœ€è¦å¯¹æ–¹è®¿é—®çš„å±æ€§å’Œæ–¹æ³•æŒ‚è½½åˆ°windowå¯¹è±¡ä¸Šï¼Œä»è€Œä¸»çª—å£é€šè¿‡`document.querySelector('iframe').contentWindow.<xxx>`è®¿é—®iframeï¼Œiframeé€šè¿‡`window.parent.<xxx>`è®¿é—®ä¸»çª—å£çš„å±æ€§æˆ–æ–¹æ³•

æ€è·¯ä¹‹äºŒæ˜¯ï¼šä¸»çª—å£å‘iframeå‘é€ä¿¡æ¯`postMessage()`ï¼Œå¹¶ç›‘å¬å­å¯¹è±¡çš„ä¿¡æ¯ï¼Œiframeç›‘å¬ä¸»çª—å£ä¿¡æ¯å¹¶å‘ä¸»çª—å£å‘é€ä¿¡æ¯

ç”±äºå®‰å…¨åŸå› ä¸æµè§ˆå™¨é™åˆ¶ï¼ŒéåŒæºURLï¼ˆåŒåœ°å€åŒç«¯å£ï¼‰ä¸å¯ä»¥ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œç¬¬äºŒç§æ–¹æ³•å‡é€‚ç”¨

3\. å†…ç½®æ–¹æ³•
--------

### 3.1 åˆå§‹å‡†å¤‡

ç¬”è€…å‡†å¤‡äº†è¿™æ ·ä¸¤ä¸ªç½‘é¡µï¼Œåˆ†åˆ«å«`parent.html`å’Œ`children.html`

parent.htmlå†…å®¹å¦‚ä¸‹ï¼š

    <!DOCTYPE html>
    <html lang="en">
    
    <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Document</title>
      <style>
        html,
        body {
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
        }
    
        #parent {
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: row;
        }
    
        iframe {
          width: 80%;
          height: 100%;
        }
    
        #panel {
          width: 20%;
          height: 100%;
          background: white;
          display: flex;
          flex-direction: column;
        }
    
        code {
          font-size: large;
        }
      </style>
    </head>
    
    <body>
      <div id="parent">
        <iframe src="./children.html" frameborder="0"></iframe>
        <div id="panel">
          <h3>ä¸»çª—å£</h3>
            <code></code>
        </div>
      </div>
    
      <script>
    
      </script>
    </body>
    
    </html>
    

children.htmlå†…å®¹å¦‚ä¸‹ï¼š

    <!DOCTYPE html>
    <html lang="en">
    
    <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Document</title>
      <style>
        html,
        body {
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
        }
    
        #container {
          width: 100%;
          height: 100%;
          background: cadetblue;
          display: flex;
          flex-direction: column;
        }
    
        code {
          font-size: large;
        }
      </style>
    </head>
    
    <body>
      <div id="container">
        <h3>å­çª—å£</h3>
        <code></code>
      </div>
      <script>
    
      </script>
    </body>
    
    </html>
    

è¿™ä¸¤ç½‘é¡µçš„ç•Œé¢å¦‚ä¸‹ï¼š

![image-20230726200834842](https://s2.loli.net/2023/07/27/mWbASqX285NrDKv.png)

ç°åœ¨ï¼Œç¬”è€…å‡†å¤‡åœ¨ä¸»çª—å£ä¸iframeä¹‹é—´ä¼ é€’ä¸€ä¸ªä¿¡æ¯

### 3.2 è®¿é—®å±æ€§

å°†å¯¹æ–¹è®¿é—®çš„å±æ€§å’Œæ–¹æ³•æŒ‚è½½åˆ°windowå¯¹è±¡ä¸Šï¼Œä»è€Œä¸»çª—å£é€šè¿‡`document.querySelector('iframe').contentWindow.<xxx>`è®¿é—®iframeï¼Œiframeé€šè¿‡`window.parent.<xxx>`è®¿é—®ä¸»çª—å£çš„å±æ€§æˆ–æ–¹æ³•

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

    // parent.html   
    
    const parentMessage = {
        name: 'æå››',
        age: 20
    };
    Reflect.defineProperty(window, 'parentMessage', {
        value: parentMessage
    });
    
    // è®¿é—®å­çª—å£çš„å…¨å±€å˜é‡
    const iframe = document.querySelector('iframe');
    setTimeout(() => {
        document.querySelector('code').innerHTML = JSON.stringify(iframe.contentWindow.childMessage)
    }, 1000); // ç­‰å¾…iframeåˆå§‹åŒ–å®Œæ¯•
    

    // children.html
    
    const childMessage = {
        name: 'å¼ ä¸‰',
        age: 18
    };
    Reflect.defineProperty(window, 'childMessage', {
        value: childMessage
    });
    
    document.querySelector('code').innerHTML = JSON.stringify(parent.parentMessage)
    

ç»“æœå¦‚ä¸‹ï¼š

![image-20230727001146773](https://s2.loli.net/2023/07/27/kOoJRc1IL7udsFq.png)

æ³¨æ„ï¼Œè¿™ç§æ–¹æ³•åªé€‚ç”¨ä¸åŒæºURLï¼ŒéåŒæºURLè®¿é—®å¯¹æ–¹çš„å±æ€§ä¼šå‡ºç°ç±»ä¼¼é”™è¯¯ï¼š

    Uncaught DOMException: Blocked a frame with origin "http://127.0.0.1:5500" from accessing a cross-origin frame
    

### 3.3 æ¶ˆæ¯å‘é€ä¸ç›‘å¬

ä¸»çª—å£å‘iframeå‘é€ä¿¡æ¯`postMessage()`ï¼Œå¹¶ç›‘å¬å­å¯¹è±¡çš„ä¿¡æ¯ï¼Œiframeç›‘å¬ä¸»çª—å£ä¿¡æ¯å¹¶å‘ä¸»çª—å£å‘é€ä¿¡æ¯

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

    // parent.html
    
    const parentMessage = {
        name: 'æå››',
        age: 20
    };
    const iframe = document.querySelector('iframe');
    iframe.onload = function () {
        // å‘é€æ¶ˆæ¯
        iframe.contentWindow.postMessage(parentMessage, '*');
    };
    // æ¥æ”¶æ¶ˆæ¯
    window.addEventListener('message', function (event) {
        const code = document.querySelector('code');
        code.innerHTML = JSON.stringify(event.data);
    });
    

    // children.html
    
    const childrenMessage = {
        name: 'å¼ ä¸‰',
        age: 18
    };
    // æ¥æ”¶æ¶ˆæ¯
    window.addEventListener('message', function (event) {
    	// å‘é€æ¶ˆæ¯
        window.parent.postMessage(childrenMessage, '*');
        const code = document.querySelector('code');
        code.innerHTML = JSON.stringify(event.data);
    });
    

ç»“æœå’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ï¼š

![image-20230727001146773](https://s2.loli.net/2023/07/27/kOoJRc1IL7udsFq.png)

è¿™ç§æ–¹æ³•åŒæºURLä¸éåŒæºURLéƒ½é€‚ç”¨

4\. Postmate
------------

Postmate æ˜¯ä¸€ä¸ª JavaScript åº“ï¼Œç”¨äºç®€åŒ–ä¸»çª—å£å’Œ iframe ä¹‹é—´çš„è·¨åŸŸé€šï¼Œå®ƒåŸºäº `window.postMessage()` æ–¹æ³•ï¼Œå¹¶æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥åœ¨ä¸»çª—å£å’Œ iframe ä¹‹é—´å‘é€å’Œæ¥æ”¶æ¶ˆæ¯

Postmate çš„GitHubåœ°å€ä¸ºï¼š[dollarshaveclub/postmate: ğŸ“­ A powerful, simple, promise-based postMessage library. (github.com)](https://github.com/dollarshaveclub/postmate)

Postmateçš„ç‰¹æ€§æœ‰ï¼š

*   åŸºäº promise çš„ APIï¼Œç”¨äºä¼˜é›…å’Œç®€å•çš„é€šä¿¡
*   å®‰å…¨çš„åŒå‘çˆ¶ <-> å­æ¡æ‰‹ï¼Œå¹¶å¸¦æœ‰æ¶ˆæ¯éªŒè¯
*   å­ä»£æš´éœ²ä¸€ä¸ªå¯æ£€ç´¢çš„æ¨¡å‹å¯¹è±¡ï¼Œçˆ¶ä»£å¯ä»¥è®¿é—®
*   å­ä»£å‘å‡ºäº‹ä»¶ï¼Œçˆ¶ä»£å¯ä»¥ç›‘å¬
*   çˆ¶ä»£å¯ä»¥è°ƒç”¨å­ä»£çš„å‡½æ•°
*   é›¶ä¾èµ–æ€§ï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œå¯ä»¥ä¸º Promise API æä¾›è‡ªå·±çš„ polyfill æˆ–æŠ½è±¡
*   è½»é‡çº§ï¼Œå¤§å°çº¦ä¸º1.6kbï¼ˆç¼©å°å’Œå‹ç¼©åï¼‰

Postmate çš„ä¸»è¦ç”¨æ³•å°±æ˜¯ï¼š

1.  ä¸»çª—å£å»ºç«‹æ¡æ‰‹ç¨‹åºï¼Œæ¡æ‰‹æˆåŠŸåå¯å‘iframeè·å–æ•°æ®ï¼Œç›‘å¬äº‹ä»¶ä»¥åŠè¿œç¨‹è°ƒç”¨å‡½æ•°
2.  iframeå»ºç«‹æ¡æ‰‹æ¨¡å‹ï¼Œå¯åŒ…å«æ•°æ®ã€å‡½æ•°ç­‰ï¼ŒæˆåŠŸæ¡æ‰‹åå¯å‘ä¸»çª—å£è§¦å‘äº‹ä»¶

å¤§è‡´ç”¨æ³•å°±æ˜¯å¦‚æ­¤ï¼Œæœ‰ä¸ªé—®é¢˜ï¼šiframeå‘ä¸»çª—å£å‘é€æ•°æ®å€’æ˜¯çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œç›´æ¥åœ¨ä¸»çª—å£é‡Œè·å–å³å¯ï¼Œä½†æ˜¯å¦‚ä½•åœ¨iframeé‡Œè·å–ä¸»çª—å£çš„æ•°æ®å‘¢ï¼Œå¦‚ä½•æ‰èƒ½å°†ä¸»çª—å£çš„æ•°æ®å‘é€ç»™iframeå‘¢ï¼Ÿ

æ–¹æ³•ä¹‹ä¸€æ˜¯ï¼šä½¿ç”¨iframeå»ºç«‹çš„æ¡æ‰‹æ¨¡å‹é‡Œè¿œç¨‹è°ƒç”¨å‡½æ•°ï¼Œå°†ä¸»çª—å£ä¼ ç»™iframeçš„æ•°æ®ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼ˆè¿™ä¸€ç‚¹æ„Ÿè§‰å¾ˆåˆ«æ‰­ï¼‰

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

parent.htmlï¼š

    <script src="https://cdn.jsdelivr.net/npm/postmate@1.5.2/build/postmate.min.js"></script>
    <div id="parent">
        <!-- <iframe src="./children.html" frameborder="0"></iframe> -->
        <div id="panel">
            <h3>ä¸»çª—å£</h3>
            <code></code>
        </div>
    </div>
    
    <script>
        const parentMessage = {
            name: 'æå››',
            age: 20
        };
    
        // å»ºç«‹æ¡æ‰‹ç¨‹åº
        const handshake = new Postmate({
            container: document.querySelector('#parent'), // æ³¨æ„å°†åŸiframeæ³¨é‡Šæ‰
            url: './children.html'
        });
    
        // æ¡æ‰‹æˆåŠŸå
        handshake.then(child => {
    
            // ç›‘å¬äº‹ä»¶
            child.on('some-event', data => console.log(data)); // Logs "Hello, World!"
    
            // è¿œç¨‹è°ƒç”¨å‡½æ•°ï¼Œå°†ä¸»çª—å£ä¼ ç»™iframeçš„æ•°æ®ä½œä¸ºå‡½æ•°çš„å‚æ•°
            child.call('changeParentMessage', parentMessage);
    
            // è·å–æ•°æ®
            child.get('childMessage').then(data => {
                document.querySelector('code').innerHTML = JSON.stringify(data)
            }); 
    
        });
    </script>
    

children.htmlï¼š

    <script src="https://cdn.jsdelivr.net/npm/postmate@1.5.2/build/postmate.min.js"></script>
    <div id="container">
        <h3>å­çª—å£</h3>
        <code></code>
    </div>
    <script>
        const childMessage = {
            name: 'å¼ ä¸‰',
            age: 18
        };
    
        const handshake = new Postmate.Model({
            // å»ºç«‹æ¡æ‰‹æ¨¡å‹ Property values may be functions, promises, or regular values
            childMessage: childMessage,
            parentMessage: {},
            changeParentMessage: function (newMessage) {
                this.parentMessage = newMessage;
                document.querySelector('code').innerHTML = JSON.stringify(this.parentMessage);
            }
        });
    
        //æˆåŠŸæ¡æ‰‹åå¯å‘ä¸»çª—å£è§¦å‘äº‹ä»¶
        handshake.then(parent => {
            parent.emit('some-event', 'Hello, World!');
        });
    </script>
    
    

ç»“æœå¦‚ä¸‹ï¼š

![image-20230727020851043](https://s2.loli.net/2023/07/27/rNzK1c9TIbp3aYJ.png)

5\. å‚è€ƒèµ„æ–™
--------

\[1\] [<iframe> - HTMLï¼ˆè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼‰ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe)

\[2\] [window.parent - Web API æ¥å£å‚è€ƒ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/parent)

\[3\] [HTMLIFrameElement.contentWindow - Web API æ¥å£å‚è€ƒ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLIFrameElement/contentWindow)

\[4\] [iframeè·¨åŸŸé€šä¿¡(postMessage) - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844904120680185869)

\[5\] [window.postMessage - Web API æ¥å£å‚è€ƒ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage)

\[6\] [dollarshaveclub/postmate: ğŸ“­ A powerful, simple, promise-based postMessage library. (github.com)](https://github.com/dollarshaveclub/postmate#readme)

\[7\] [é›¶åŸºç¡€å­¦ä¹  Postmateåº“ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7056207112912764941)

ä½œè€…ï¼š[å½“æ—¶æ˜æœˆåœ¨æ›¾ç…§å½©äº‘å½’](https://www.cnblogs.com/jiujiubashiyi/)

å‡ºå¤„ï¼š[https://www.cnblogs.com/jiujiubashiyi/p/17583926.html](https://www.cnblogs.com/jiujiubashiyi/p/17583926.html)