---
layout: post
title: "UDP 编程不能太随意"
date: "2023-07-06T01:25:16.161Z"
---
UDP 编程不能太随意
===========

UDP 相比 TCP 虽然是是无连接的，看似发送接收都很随意，但是在发送——接收过程中，仍然有些问题需要重视。在整个通讯过程中至少有两点需要注意，一方面**要防止发送方的一厢情愿**，另一方面是**在允许的条件下，尽量保证数据的完整性**。

防止发送方的一厢情愿是指在发送时要确保对方有套接字可以接收，不能在另一方没有接收意愿的情况下，浪费时间与精力盲目的发送数据。为了避免一厢情愿的现象发生，我们对 UDP 将要通讯与正在通信的两个阶段分别作出对应的处理。

将要通讯是指还没有发送有效数据的前夕，这个时候我们可以通过先发送一个空的数据包，并使用 select 进行超时等待，然后通过 recvfrom() 接收讯息，如果返回端口不可达或目的不可达的 errno 则直接做相应错误处理，反之，继续程序的运行。

正在通讯发生在将要通讯之后，正在进行有效数据的交互时。在这个阶段如果发生接收方鸟无音讯，处理起来会比较棘手，因为该阶段发送方的行为是同步的，而这种失联是异步发生的。对此有同步与异步两种处理方式，同步方式是指在发送方同步的某个阶段发送空 UDP 消息，用 select 进行超时等待，然后通过 recvfrom() 接收讯息，并对其结果进行对应处理。这样做有一些缺陷，不能及时队错误情况进行处理；异步的方法是通过信号的方法来实现，通过监控相应的信号并注册相应的信号处理函数来对错误情况进行处理。

在可以的条件下，应该尽量保证数据的完整性。虽然 UDP 协议本身就是不对数据质量与完整性负责的协议，但是这种不负责是对于网络状况来说的，这种情况导致的数据不完整是被允许的，除此之外，由于编程者本身对于数据的不规范处理而导致数据的完整性受损应该是被极力避免的。由于编程而引起的数据完整性问题很大程度上是对发送或接收缓冲区的处理不当导致的。

在发送数据时，如果缓冲区满或者缓冲区充足时，前者会返回错误，后者会正常发送，这两者都都不会对数据完整性产生影响，但是如果缓冲区在写入被发送数据的一部分后变为满状态，这时候使用阻塞发送会导致阻塞，如果是非阻塞模式，会直接返回错误造成问题（因为如果重发，我们无法确定数据被发送了多少）。

在接收消息时，如果接收方的数据缓冲区不足以容纳接收到的数据，那么超出缓冲区大小的数据将会被丢弃。这可能会导致数据的丢失，接收方可能无法完全接收发送方发送的数据。因此，在设计应用程序时，需要考虑接收方的数据缓冲区大小，以确保能够完全接收发送方发送的数据。