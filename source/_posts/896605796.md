---
layout: post
title: "é¢éœ¸çš„è‡ªæˆ‘ä¿®å…»ï¼švolatileä¸“é¢˜"
date: "2023-09-05T00:55:53.854Z"
---
é¢éœ¸çš„è‡ªæˆ‘ä¿®å…»ï¼švolatileä¸“é¢˜
==================

![é¢éœ¸çš„è‡ªæˆ‘ä¿®å…»ï¼švolatileä¸“é¢˜](https://img2023.cnblogs.com/blog/3063031/202309/3063031-20230904232415377-1026312033.png) å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯çŽ‹æœ‰å¿—ã€‚ä»Šå¤©æ˜¯ã€Šé¢éœ¸çš„è‡ªæˆ‘ä¿®å…»ã€‹ç¬¬4ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹é¢è¯•ä¸­ä¼šé—®åˆ°å“ªäº›å…³äºŽvolatileçš„é—®é¢˜å§ã€‚

> [çŽ‹æœ‰å¿—](https://www.yuque.com/wangyouzhi-u3woi/dfhnl0/hqrch62un0cc9sp2?singleDoc)ï¼Œä¸€ä¸ªåˆ†äº«ç¡¬æ ¸JavaæŠ€æœ¯çš„äº’é‡‘æ‘¸é±¼ä¾   
> åŠ å…¥Javaäººçš„ææ¡¶è·‘è·¯ç¾¤ï¼š[å…±åŒå¯Œè£•çš„Javaäºº](https://www.yuque.com/wangyouzhi-u3woi/dfhnl0/nwry2mdlktok50bt?singleDoc)

ä»Šå¤©æ˜¯ã€Šé¢éœ¸çš„è‡ªæˆ‘ä¿®å…»ã€‹ç¬¬4ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹é¢è¯•ä¸­ä¼šé—®åˆ°å“ªäº›å…³äºŽvolatileçš„é—®é¢˜å§ã€‚  
**æ•°æ®æ¥æºï¼š**

*   å¤§éƒ¨åˆ†æ¥è‡ªäºŽå„æœºæž„ï¼ˆJavaä¹‹çˆ¶ï¼ŒJavaç»§çˆ¶ï¼ŒæŸçµï¼ŒæŸæ³¡ï¼ŒæŸå®¢ï¼‰ä»¥åŠå„åšä¸»æ•´ç†æ–‡æ¡£ï¼›
*   å°éƒ¨åˆ†æ¥è‡ªäºŽæˆ‘ä»¥åŠèº«è¾¹æœ‹å‹çš„å®žé™…ç»ç†ï¼Œé¢˜ç›®ä¸Šä¼šåšå‡ºæ ‡è¯†ï¼Œå¹¶æ³¨æ˜Žé¢è¯•å…¬å¸ã€‚

**å â€œBUFFâ€ï¼š**

*   å…«è‚¡æ–‡é€šå¸¸å‡ºçŽ°åœ¨é¢è¯•çš„ç¬¬ä¸€äºŒè½®ï¼Œæ˜¯â€œæ•²é—¨ç –â€ï¼Œä½†ä»…ä»…æŽŒæ¡å…«è‚¡æ–‡å¹¶ä¸èƒ½å¸®åŠ©ä½ æ‹¿ä¸‹Offerï¼›
*   ç”±äºŽæœ¬äººæ°´å¹³æœ‰é™ï¼Œæ–‡ä¸­éš¾å…å‡ºçŽ°é”™è¯¯ï¼Œè¿˜è¯·å¤§å®¶ä»¥æ‰¹è¯„æŒ‡æ­£ä¸ºä¸»ï¼Œå°½é‡ä¸è¦å–·~~
*   æœ¬æ–‡åŠåŽ†å²æ–‡ç« å·²ç»å®ŒæˆPDFæ–‡æ¡£çš„åˆ¶ä½œï¼Œæå–å…³é”®å­—ã€é¢éœ¸çš„è‡ªæˆ‘ä¿®å…»ã€‘ã€‚

ç†è®ºç¯‡
---

### æŒ‡ä»¤é‡æŽ’

**éš¾æ˜“ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥

**é‡è¦ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥

**é¢è¯•å…¬å¸**ï¼šæ— 

æŒ‡ä»¤é‡æŽ’æ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œ**é€šè¿‡æŒ‡ä»¤ä¹±åºæ‰§è¡Œï¼ˆOut Of Order Executionï¼Œç®€ç§°OoOEæˆ–OOEï¼‰æé«˜å¤„ç†å™¨çš„æ‰§è¡Œæ•ˆçŽ‡å’Œæ€§èƒ½**ã€‚  
ä»¥ä¸‹å†…å®¹æ‘˜è‡ªç»´åŸºç™¾ç§‘ï¼š

> åœ¨è®¡ç®—æœºå·¥ç¨‹é¢†åŸŸï¼Œ**ä¹±åºæ‰§è¡Œ**ï¼ˆ**é”™åºæ‰§è¡Œ**ï¼Œè‹±è¯­ï¼šout-of-order executionï¼Œç®€ç§°**OoOE**æˆ–**OOE**ï¼‰æ˜¯ä¸€ç§åº”ç”¨åœ¨é«˜æ€§èƒ½å¾®å¤„ç†å™¨ä¸­æ¥åˆ©ç”¨æŒ‡ä»¤å‘¨æœŸä»¥é¿å…ç‰¹å®šç±»åž‹çš„å»¶è¿Ÿæ¶ˆè€—çš„èŒƒå¼ã€‚åœ¨è¿™ç§èŒƒå¼ä¸­ï¼Œå¤„ç†å™¨æ ¹æ®è¾“å…¥æ•°æ®çš„å¯ç”¨æ€§ç¡®å®šæ‰§è¡ŒæŒ‡ä»¤çš„é¡ºåºï¼Œè€Œä¸æ˜¯æ ¹æ®ç¨‹åºçš„åŽŸå§‹æ•°æ®å†³å®šã€‚åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œå¯ä»¥é¿å…å› ä¸ºèŽ·å–ä¸‹ä¸€æ¡ç¨‹åºæŒ‡ä»¤æ‰€å¼•èµ·çš„å¤„ç†å™¨ç­‰å¾…ï¼Œå–è€Œä»£ä¹‹çš„å¤„ç†ä¸‹ä¸€æ¡å¯ä»¥ç«‹å³æ‰§è¡Œçš„æŒ‡ä»¤ã€‚

æŒ‡ä»¤é‡æŽ’çš„åŸºç¡€å»ºç«‹åœ¨ä¿è¯å½“çº¿ç¨‹çŽ¯å¢ƒä¸‹è¯­ä¹‰å‡†ç¡®æ€§çš„å‰æä¸‹ï¼Œè€Œä¸èƒ½ä¿è¯å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹çš„è¯­ä¹‰ã€‚

* * *

### å†…å­˜å±éšœ

**éš¾æ˜“ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

**é‡è¦ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥

**é¢è¯•å…¬å¸**ï¼šæ— 

**å†…å­˜å±éšœ**ï¼ˆMemory barrierï¼‰ï¼Œä¹Ÿç§°**å†…å­˜æ …æ **ï¼Œ**å†…å­˜æ …éšœ**ï¼Œ**å±éšœæŒ‡ä»¤**ç­‰ï¼Œæ˜¯ä¸€ç±»åŒæ­¥æŒ‡ä»¤ï¼Œå®ƒä½¿CPUæˆ–ç¼–è¯‘å™¨è¿›è¡Œæ“ä½œæ—¶ä¸¥æ ¼æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œï¼Œå³ä¿è¯å†…å­˜å±éšœå‰åŽçš„æŒ‡ä»¤ä¸ä¼šå› ä¸ºæŒ‡ä»¤é‡æŽ’è€Œå¯¼è‡´ä¹±åºæ‰§è¡Œã€‚  
JVMä¸­å®šä¹‰äº†7ç§å±éšœï¼š

    class OrderAccess : private Atomic {
    public:
    	static void     loadload();
    	static void     storestore();
    	static void     loadstore();
    	static void     storeload();
    	
    	static void     acquire();
    	static void     release();
    	static void     fence();
    }
    

å…¶ä¸­æœ€é‡è¦çš„æ˜¯4ç§åŸºæœ¬çš„å†…å­˜å±éšœï¼š

*   **LoadLoad**ï¼ŒæŒ‡ä»¤ï¼š`Load1; LoadLoad; Load2`ã€‚ç¡®ä¿Load1åœ¨Load2åŠä¹‹åŽçš„è¯»æ“ä½œå‰å®Œæˆè¯»æ“ä½œï¼ŒLoad1å‰çš„LoadæŒ‡ä»¤ä¸èƒ½é‡æŽ’åºåˆ°Load2åŠä¹‹åŽçš„è¯»æ“ä½œåŽï¼›
*   **StoreStore**ï¼ŒæŒ‡ä»¤ï¼š`Store1; StoreStore; Store2`ã€‚ç¡®ä¿Store1åœ¨Store2åŠä¹‹åŽçš„å†™æ“ä½œå‰å®Œæˆå†™æ“ä½œï¼Œ**ä¸”Stroe1å†™æ“ä½œçš„ç»“æžœå¯¹Store2å¯è§**ï¼ŒStore1å‰çš„StoreæŒ‡ä»¤ä¸èƒ½é‡æŽ’åºåˆ°Store2åŠä¹‹åŽçš„å†™æ“ä½œåŽï¼›
*   **LoadStore**ï¼ŒæŒ‡ä»¤ï¼š`Load1; LoadStore; Store2`ã€‚ç¡®ä¿Load1åœ¨Store2åŠä¹‹åŽçš„å†™æ“ä½œå‰å®Œæˆè¯»æ“ä½œï¼ŒLoad1å‰çš„LoadæŒ‡ä»¤ä¸èƒ½é‡æŽ’åºåˆ°Store2åŠä¹‹åŽçš„å†™æ“ä½œåŽï¼›
*   **StoreLoad**ï¼šæŒ‡ä»¤ï¼š`Store1; StoreLoad; Load2`ã€‚ç¡®ä¿Store1åœ¨Load2åŠä¹‹åŽçš„LoadæŒ‡ä»¤å‰å®Œæˆå†™æ“ä½œï¼ŒStore1å‰çš„StoreæŒ‡ä»¤ä¸èƒ½é‡æŽ’åºåˆ°Load2åŠä¹‹åŽçš„LoadæŒ‡ä»¤åŽã€‚

è‡³äºŽacquireï¼Œreleaseå’Œfenceï¼Œæˆ‘ä»¬é€šè¿‡ä¸€å¼ è¡¨æ ¼æ¥è¡¨ç¤ºå®ƒä»¬ä¸Ž4ç§åŸºæœ¬å†…å­˜å±éšœçš„å¯¹åº”å…³ç³»ï¼š

![](https://img2023.cnblogs.com/blog/3063031/202309/3063031-20230904232452336-394593698.png)

**Tips**ï¼š

*   å†…å­˜å±éšœçš„å®šä¹‰ä½äºŽ[orderAccess.hpp](https://hg.openjdk.org/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/runtime/orderAccess.hpp)ä¸­ï¼Œ**å¼ºçƒˆå»ºè®®é˜…è¯»æ³¨é‡Šä¸­çš„â€œMemory Access Ordering Modelâ€**ï¼›
*   é‡ç‚¹ç†è§£4ç§åŸºæœ¬å†…å­˜å±éšœå®žçŽ°çš„åŠŸèƒ½å³å¯ï¼ŒJVMæºç å¯¹çš„éƒ¨åˆ†äº†è§£å³å¯ï¼Œä¹Ÿåˆ«å¾€ä¸‹å·äº†ï¼Œå•¥æ—¶å€™æ˜¯ä¸ªå¤´å•Šï¼›
*   Javaä¸­å®šä¹‰çš„å†…å­˜å±éšœå±è”½ä¸åŒæ“ä½œç³»ç»Ÿé—´å†…å­˜å±éšœçš„å·®å¼‚ï¼Œä½¿å¾—ä¸åŒçš„æ“ä½œç³»ç»Ÿè¡¨çŽ°å‡ºä¸€è‡´çš„è¯­ä¹‰ã€‚

* * *

åŽŸç†ç¯‡
---

### ðŸ”¥volatileæ˜¯ä»€ä¹ˆï¼Ÿ

**éš¾æ˜“ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥

**é‡è¦ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥

**é¢è¯•å…¬å¸**ï¼šè…¾è®¯

volatileæ˜¯Javaæä¾›çš„å…³é”®å­—ï¼Œå¯ä»¥ç”¨æ¥**ä¿®é¥°æˆå‘˜å˜é‡**ã€‚volatileæä¾›äº†ä¸¤ä¸ªèƒ½åŠ›ï¼š

*   **ä¿è¯è¢«ä¿®é¥°å˜é‡åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹çš„å¯è§æ€§**
*   **ç¦æ­¢è¢«ä¿®é¥°å˜é‡çš„æŒ‡ä»¤é‡æŽ’**

`volatile`**ä¿è¯å¯è§æ€§çš„ä¾‹å­ï¼š**

    private static volatile boolean flag = true;
    
    public static void main(String[] args) throws InterruptedException {
    	new Thread(() -> {
    		while (flag) {
    		}
    		System.out.println("çº¿ç¨‹ï¼š" + Thread.currentThread().getName() + "ï¼ŒflagçŠ¶æ€ï¼š" + flag);
    	}, "block_thread").start();
    	TimeUnit.MICROSECONDS.sleep(500);
    	new Thread(() -> {
    		flag = false;
    		System.out.println("çº¿ç¨‹ï¼š" + Thread.currentThread().getName() + "ï¼ŒflagçŠ¶æ€ï¼š" + flag);
    	}, "change_thread").start();
    }
    

åˆ é™¤ä¿®é¥°`flag`çš„`volatile`åŽï¼Œblock\_threadæ— æ³•â€œå¯Ÿè§‰â€åˆ°change\_threadå¯¹`flag`çš„ä¿®æ”¹ï¼Œå› æ­¤ä¼šâ€œæ²‰è¿·â€`wile`å¾ªçŽ¯æ— æ³•è‡ªæ‹”ã€‚  
`**volatile**`**ç¦æ­¢æŒ‡ä»¤é‡æŽ’çš„ä¾‹å­ï¼š**  
ç»å…¸çš„**åŒæ£€é”å•ä¾‹æ¨¡å¼**ï¼Œåœ¨ä¸‹ä¸€é¢˜ä¸­è§£é‡Šä¸ä½¿ç”¨`volatile`å¸¦æ¥çš„æœ‰åºæ€§é—®é¢˜ã€‚

    public static class Singleton {
    	private volatile Singleton instance;
    	public Singleton getInstance() {
    		if (instance == null) {
    			synchronized(this) {
    				if (instance == null) {
    					instance = new Singleton();
    				}
    			}
    		}
    		return instance;
    	}
    }
    

* * *

### ðŸ”¥volatileçš„å®žçŽ°åŽŸç†

**éš¾æ˜“ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

**é‡è¦ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

**é¢è¯•å…¬å¸**ï¼šç™¾åº¦ï¼ŒOPPOï¼Œä¸°å·¢ï¼Œç¾Žå›¢ï¼Œä¹ä¿¡

è¢«`volatile`ä¿®é¥°çš„å˜é‡åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ä¼šè¢«æ ‡è®°ä¸Š`ACC_VOLATILE`ï¼Œå½“JVMè¯»å–åˆ°è¯¥æ ‡è®°æ—¶ä¼šæŒ‰ç…§JMMä¸­å®šä¹‰çš„volatileè¯­ä¹‰å¤„ç†ã€‚  
ä»¥ç»å…¸çš„åŒæ£€é”å•ä¾‹æ¨¡å¼ä¸ºä¾‹ï¼š

    public class Singleton {
    
    	static volatile Singleton instance;
    
    	public static Singleton getInstance() {
    		if (instance == null) {
    			synchronized(Singleton.class) {
    				if (instance == null) {
    					instance = new Singleton();
    				}
    			}
    		}
    		return instance;
    	}
    }
    

ç¼–è¯‘åŽçš„éƒ¨åˆ†å­—èŠ‚ç å¦‚ä¸‹ï¼š

    public class com.wyz.keyword.keyword_volatile.Singleton
    static volatile com.wyz.keyword.keyword_volatile.Singleton instance;
    flags:(0x0048) ACC_STATIC, ACC_VOLATILE
    public static com.wyz.keyword.keyword_volatile.Singleton getInstance();
    Code:
    stack=2, locals=2, args_size=0
    24: putstatic     #7      // Field instance:Lcom/wyz/keyword/keyword_volatile/Singleton;
    37: getstatic     #7      // Field instance:Lcom/wyz/keyword/keyword_volatile/Singleton;
    

å­—èŠ‚ç ä¸­ç¬¬7è¡Œå’Œç¬¬8è¡Œçš„ä¸¤ä¸ªæŒ‡ä»¤ï¼š`putstatic`å’Œ`getstatic`ï¼ˆéžé™æ€å˜é‡å¯¹åº”`putfield`å’Œ`gettfield`ï¼‰ç”¨äºŽæ“ä½œé™æ€å˜é‡instanceï¼Œè¿™ä¸¤æ¡æŒ‡ä»¤çš„æºç ä½äºŽ[bytecodeInterpreter](https://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/interpreter/bytecodeInterpreter.cpp#l2025)ä¸­ï¼Œä»¥ä¸‹ä»…æˆªå–å…³é”®éƒ¨åˆ†æºç ã€‚

#### volatileå˜é‡çš„å†™æ“ä½œ

`putstatic`å’Œ`putfield`æŒ‡ä»¤ï¼š

    CASE(_putfield):
    CASE(_putstatic):
    {
    	if ((Bytecodes::Code)opcode == Bytecodes::_putstatic) {
    		// staticçš„å¤„ç†æ–¹å¼
    	} else {
    		// éžstaticçš„å¤„ç†æ–¹å¼
    	}
    
    	// ACC_VOLATILE -> JVM_ACC_VOLATILE -> is_volatile()
    	if (cache->is_volatile()) {
    		// volatileå˜é‡çš„å¤„ç†æ–¹å¼
    		if (tos_type == itos) {
    			obj->release_int_field_put(field_offset, STACK_INT(-1));
    		}else {
    			// çœç•¥äº†è¶…å¤šçš„ç±»åž‹åˆ¤æ–­
    		}
    		OrderAccess::storeload();
    	} else {
    		// éžvolatileå˜é‡çš„å¤„ç†æ–¹å¼
    	}
    }
    

JVMåœ¨å¤„ç†å®Œvolatileç±»åž‹å˜é‡çš„å†™æ“ä½œåŽï¼ŒåŠ å…¥`OrderAccess::storeload`ï¼Œ**ä¿è¯volatileå˜é‡çš„å†™æ“ä½œå¯¹æ‰€æœ‰åŽç»­çš„è¯»æ“ä½œå¯è§**ã€‚

#### volatileå˜é‡çš„è¯»æ“ä½œ

`getstatic`å’Œ`gettfield`æŒ‡ä»¤ï¼š

    CASE(_getfield):
    CASE(_getstatic):
    oop obj;
    if ((Bytecodes::Code)opcode == Bytecodes::_getstatic) {
    	// staticå˜é‡çš„å¤„ç†
    } else {
    	// éžstaticå˜é‡çš„å¤„ç†
    }
    if (cache->is_volatile()) {
    	// volatileå˜é‡çš„å¤„ç†æ–¹å¼
    	// 
    	if (support_IRIW_for_not_multiple_copy_atomic_cpu) {
    		OrderAccess::fence();
    	}
    	if (tos_type == atos) {
    		VERIFY_OOP(obj->obj_field_acquire(field_offset));
    		SET_STACK_OBJECT(obj->obj_field_acquire(field_offset), -1);
    	} else {
    		// çœç•¥äº†è¶…å¤šçš„ç±»åž‹åˆ¤æ–­
    	}
    } else {
    	// éžvolatileå˜é‡çš„å¤„ç†
    }
    

JVMåœ¨å¤„ç†volatileå˜é‡çš„è¯»æ“ä½œå‰ï¼ŒåŠ å…¥`OrderAccess::fence`ï¼Œ**ä¿è¯äº†volatileå˜é‡çš„è¯»æ“ä½œå‰æ‰€æœ‰å¯¹volatileå˜é‡çš„å†™æ“ä½œå·²ç»å¯¹å…¶å®ƒå¤„ç†å™¨å¯è§**ã€‚  
æ˜¯å¦ä½¿ç”¨`OrderAccess::fence`ï¼Œç”±å¸¸é‡`support_IRIW_for_not_multiple_copy_atomic_cpu`å†³å®šï¼Œè¯¥å¸¸é‡å®šä¹‰åœ¨[globalDefinitions.hpp](https://hg.openjdk.org/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/utilities/globalDefinitions.hpp#l485)æ–‡ä»¶ä¸­ï¼š

    #ifdef CPU_NOT_MULTIPLE_COPY_ATOMIC
    const bool support_IRIW_for_not_multiple_copy_atomic_cpu = true;
    #else
    const bool support_IRIW_for_not_multiple_copy_atomic_cpu = false;
    #endif
    

è¯¥å¸¸é‡æŒ‡çš„æ˜¯æ”¯æŒIRIWä½†ä¸æ”¯æŒMutiple Copy Atomic(MCAæ¨¡åž‹ï¼ŒMulti-copy Atomicity)çš„CPUï¼Œåœ¨è¿™ç±»CPUä¸­volatileå˜é‡çš„`getstatic`å’Œ`gettfield`æŒ‡ä»¤éœ€è¦ä½¿ç”¨`OrderAccess::fence`æ¥ä¿è¯è¯­ä¹‰çš„æ­£ç¡®æ€§ï¼Œå¦åˆ™ä¸éœ€è¦ä½¿ç”¨ã€‚

**Tips**ï¼šæ–‡æœ«å‚è€ƒèµ„æ–™ä¸­æä¾›äº†å…³äºŽIRIWå’ŒMCAæ¨¡åž‹çš„éƒ¨åˆ†èµ„æ–™ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œé˜…è¯»ã€‚

* * *

### synchronizedå’Œvolatileæœ‰å“ªäº›åŒºåˆ«ï¼Ÿ

**éš¾æ˜“ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥

**é‡è¦ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥

**é¢è¯•å…¬å¸**ï¼šæ— 

`synchronized`å’Œ`volatile`éƒ½æ˜¯Javaä¸­çš„å…³é”®å­—ï¼Œä½†å®ƒä»¬èƒ½å¤Ÿä¿®é¥°çš„èŒƒå›´ä¸åŒï¼š

*   `synchronized`**ç”¨æ¥ä¿®é¥°æ–¹æ³•å’Œä»£ç å—ï¼›**
*   `volatile`**ç”¨æ¥ä¿®é¥°å˜é‡ã€‚**

å¦å¤–å®ƒä»¬çš„ä½œç”¨ä¹Ÿå¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒï¼š

*   `synchronized`**å¯¹å¯è§æ€§ï¼Œæœ‰åºæ€§å’ŒåŽŸå­æ€§éƒ½åšå‡ºäº†ä¿è¯ï¼›**
*   `volatile`**ä¿è¯äº†è¢«ä¿®é¥°å˜é‡çš„å¯è§æ€§ï¼Œç¦æ­¢è¢«ä¿®é¥°å˜é‡çš„æŒ‡ä»¤é‡æŽ’ã€‚**

ä¸¾ä¸ªæŒ‡ä»¤é‡æŽ’çš„ä¾‹å­ï¼š

    int a, b, c, d;
    
    int count;
    
    public static void main(String[] args) {
    	a += 1;
    	b += 1;
    
    	count += 1;
    
    	c += 1;
    	d += 1;
    }
    

è¿™æ®µä»£ç ä¸­ï¼Œå¯èƒ½å‘ç”Ÿçš„é¡ºåºæ˜¯ï¼š  
å½“æˆ‘ä»¬ä½¿ç”¨volatileä¿®é¥°countåŽï¼Œ`count += 1;`ä¸€å®šæ˜¯å‘ç”Ÿåœ¨`a += 1;`å’Œ`b += 1;`ä¹‹åŽï¼Œå‘ç”Ÿåœ¨`c += 1;`å’Œ`d += 1;`ä¹‹å‰çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä¾¿ä¸å­˜åœ¨æ•°æ®ä¾èµ–ï¼Œå¯¹å˜é‡aï¼Œbï¼Œcæˆ–dçš„æ“ä½œä¹Ÿä¸èƒ½ä¸Žå¯¹å˜é‡countçš„æ“ä½œå‘ç”ŸæŒ‡ä»¤é‡æŽ’ã€‚  
è‡³äºŽ`a += 1;`ï¼Œ`b += 1;`å’Œ`c += 1;`ï¼Œ`d += 1;`ä¹‹é—´çš„æŒ‡ä»¤é‡æŽ’ï¼Œè¢«`volatile`ä¿®é¥°çš„`count`å¹¶ä¸å…³å¿ƒã€‚

    d += 1;
    c += 1;
    b += 1;
    a += 1;
    count += 1;
    

**Tips**ï¼šsynchronizedä¸Žvolatileåœ¨ä¿è¯æœ‰åºæ€§ä¸Šçš„åŽŸç†æ˜¯ä¸åŒçš„ã€‚synchronizedé™åˆ¶äº†åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œè¢«ä¿®é¥°çš„ä»£ç ï¼Œå› æ­¤èƒ½å¤Ÿä¿è¯æœ‰åºæ€§ï¼ˆè™½ç„¶æŒ‡ä»¤å¯èƒ½å‘ç”Ÿäº†é‡æŽ’åºï¼‰ï¼›volatileåˆ™æ˜¯ç¦æ­¢äº†æŒ‡ä»¤é‡æŽ’ï¼Œæ¥ä¿è¯ç¨‹åºçš„æœ‰åºæ€§ã€‚

* * *

### ðŸ”¥ä½¿ç”¨volatileå˜é‡å°±ä¸€å®šæ˜¯å¹¶å‘å®‰å…¨çš„å—ï¼Ÿ

**éš¾æ˜“ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥

**é‡è¦ç¨‹åº¦**ï¼šðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

**é¢è¯•å…¬å¸**ï¼šç¾Žå›¢

å¹¶ä¸æ˜¯çš„ï¼Œå¹¶å‘ç¼–ç¨‹ä¸­æœ‰3ä¸ªé—®é¢˜ï¼š

*   å¯è§æ€§é—®é¢˜
*   æœ‰åºæ€§é—®é¢˜
*   åŽŸå­æ€§é—®é¢˜

volatile**å…³é”®å­—é€šè¿‡JVMå®žçŽ°çš„å†…å­˜å±éšœä¿è¯äº†å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œä½†æ²¡æœ‰å¯¹è¿ç®—æ“ä½œåŽŸå­æ€§åšå‡ºä»»ä½•ä¿è¯**ã€‚  
æ¯”å¦‚æœ€å¸¸è§çš„è‡ªå¢žæ“ä½œçš„ä¾‹å­ï¼š

    private volatile static int count = 0;
    
    public static void main(String[] args) {
    	new Thread(() -> {
    		for(int i = 0; i < 300000; i++) {
    			count++;
    			System.out.println("T1ï¼š" + count);
    		}
    	}).start();
    
    	new Thread(() -> {
    		for(int i = 0; i < 300000; i++) {
    			count++;
    			System.out.println("T2ï¼š" + count);
    		}
    	}).start();
    }
    

æ‰§è¡Œä¸Šé¢çš„ç¨‹åºï¼Œæœ€åŽçš„ç»“æžœå¯èƒ½å¹¶ä¸æ˜¯é¢„æœŸçš„600000ï¼Œè€Œæ˜¯ä¸€ä¸ªå°äºŽ600000çš„æ•°å­—ï¼ˆå¦‚æžœç”µè„‘çš„CPUéžå¸¸â€œå±Œâ€ï¼Œå¯ä»¥è¯•è¯•è°ƒå¤§å¾ªçŽ¯çš„æ•°å­—æ¥å¤çŽ°è¿™ä¸ªé—®é¢˜ï¼‰ï¼Œè¿™æ˜¯å› ä¸º`count++`æ“ä½œåŒ…å«äº†3ä¸ªåŠ¨ä½œï¼Œè€Œè¿™3ä¸ªåŠ¨ä½œå¹¶ä¸æ˜¯åŽŸå­æ€§æ‰§è¡Œçš„ï¼š

*   è¯»å–å˜é‡count
*   countè¿›è¡Œè‡ªå¢žæ“ä½œ
*   å°†countå†™å…¥å·¥ä½œå†…å­˜

ä»¥ä¸Šçš„æ“ä½œå¯èƒ½è¢«åˆ†å¼€æ‰§è¡Œï¼Œå¯¼è‡´å‡ºçŽ°å¦‚ä¸‹æƒ…å†µï¼š

![](https://img2023.cnblogs.com/blog/3063031/202309/3063031-20230904232438239-1029151811.png)

ç®€å•è§£é‡Šä¸‹ç¬¬7æ­¥æ“ä½œï¼Œçº¿ç¨‹T1é‡æ–°å¼€å§‹æ‰§è¡Œï¼Œå‘çŽ°ç¼“å­˜å·²ç»å¤±æ•ˆï¼Œæ­¤æ—¶çº¿ç¨‹T1é‡æ–°è¯»å–å†…å­˜ä¸­çš„æ•°æ®ï¼Œä½†ç”±äºŽT1å·²ç»æ‰§è¡Œè¿‡è‡ªå¢žæ“ä½œï¼Œå› æ­¤ä¸ä¼šé‡æ–°æ‰§è¡Œè‡ªå¢žæ“ä½œï¼Œæ‰€ä»¥æ­¤æ—¶å†™å…¥å†…å­˜çš„ä»ç„¶æ˜¯çº¿ç¨‹T1é˜»å¡žå‰è®¡ç®—çš„ç»“æžœã€‚

**Tips**ï¼š

*   ä»¥ä¸Šå†…å®¹éœ€è¦å¤§å®¶ç†Ÿæ‚‰ç¼“å­˜ä¸€è‡´æ€§åè®®MESIçš„åŸºæœ¬å†…å®¹ï¼›
*   MESIæ˜¯ç¼“å­˜ä¸€è‡´æ€§åè®®çš„ä¸€ç§ï¼Œä½†ç¼“å­˜ä¸€è‡´æ€§åè®®å¹¶ä¸ä»…ä»…æ˜¯MESIï¼Œå¸¸è§çš„è¿˜æœ‰MOSIåè®®ï¼ŒMOESIåè®®ç­‰ã€‚

å‚è€ƒèµ„æ–™
----

*   [ä¹±åºæ‰§è¡Œï¼ˆç»´åŸºç™¾ç§‘ï¼‰](https://zh.wikipedia.org/wiki/%E4%B9%B1%E5%BA%8F%E6%89%A7%E8%A1%8C)
*   [å†…å­˜å±éšœï¼ˆç»´åŸºç™¾ç§‘ï¼‰](https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C)
*   [MESIåè®®ï¼ˆç»´åŸºç™¾ç§‘ï¼‰](https://zh.wikipedia.org/zh-cn/MESI%E5%8D%8F%E8%AE%AE)
*   [MESIåè®®ï¼ˆç™¾åº¦ç™¾ç§‘ï¼‰](https://baike.baidu.com/item/MESI%E5%8D%8F%E8%AE%AE)
*   [ç¡¬æ ¸çš„volatileè€ƒç‚¹åˆ†æž](https://mp.weixin.qq.com/s/8ASNksgZidy92cqk5kuI7g)
*   [Relaxed memory models must be rigorous](http://www0.cs.ucl.ac.uk/staff/j.alglave/papers/ec209.pdf)
*   [Multi-copy Atomicity and Barriers](https://developer.arm.com/documentation/ka002179/latest/)

* * *

å¦‚æžœæœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œè¿˜è¯·å¤šå¤šç‚¹èµžæ”¯æŒã€‚å¦‚æžœæ–‡ç« ä¸­å‡ºçŽ°ä»»ä½•é”™è¯¯ï¼Œè¿˜è¯·æ‰¹è¯„æŒ‡æ­£ã€‚**æœ€åŽæ¬¢è¿Žå¤§å®¶å…³æ³¨åˆ†äº«ç¡¬æ ¸JavaæŠ€æœ¯çš„é‡‘èžæ‘¸é±¼ä¾ **[çŽ‹æœ‰å¿—](https://www.yuque.com/wangyouzhi-u3woi/dfhnl0/hqrch62un0cc9sp2?singleDoc)ï¼Œæˆ‘ä»¬ä¸‹æ¬¡å†è§ï¼