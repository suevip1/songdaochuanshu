---
layout: post
title: "Python æ­å»º FastAPI é¡¹ç›®"
date: "2023-09-08T00:56:24.870Z"
---
Python æ­å»º FastAPI é¡¹ç›®
====================

ä¸€èˆ¬ç½‘ä¸Šçš„æ–‡ç« éƒ½æ˜¯ä»¥è„šæœ¬çš„æ–¹å¼å†™Demorçš„ï¼Œæ²¡æ‰¾åˆ°è‡ªå·±æƒ³è¦çš„é‚£ç§é¡¹ç›®ç»“æ„å‹çš„ç¤ºä¾‹ï¼ˆç±»ä¼¼Java SpringBoot åˆ›å»º Model,é€šè¿‡ pom è¿›è¡Œå…³è”é…ç½®çš„é‚£ç§ï¼‰  
çœ‹äº†ä¸€äº›æºç ï¼Œå†ç»“åˆè‡ªå·±çš„æƒ³æ³•ï¼Œå»ºäº†ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹, ç”¨ Python åšæ¥å£æœåŠ¡çš„é¡¹ç›®æ­å»ºï¼Œä»…ä¾›å‚è€ƒ

### ä»£ç ç»“æ„è¯´æ˜

![image](https://img2023.cnblogs.com/blog/80824/202309/80824-20230907100251171-1241329511.png)

    VipQA
    â”‚  .env                                         # ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
    â”‚  app_init.py                                  # æˆ‘ç”¨å®ƒæ¥æ”¾äº†é¡¹ç›®åˆå§‹åŒ–ä»£ç 
    â”‚  main.py                                      # ä¸»ç¨‹åºï¼Œç”¨æ¥å¯åŠ¨é¡¹ç›®
    â”‚  requirements.txt                             # é¡¹ç›®ä¾èµ–åŒ… pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple  è¿›è¡Œå®‰è£…
    â”‚  settings.py                                  # ç”¨æ¥å°† .env é‡Œçš„å˜æ›´å€¼å–å‡ºæ¥ã€‚ Python è®¾ç½®ç¯å¢ƒå˜é‡æ–¹æ³•ï¼ˆhttps://www.cnblogs.com/vipsoft/p/17677020.htmlï¼‰
    â”‚  __init__.py                                  # ç›®å‰æ²¡æ”¾ä»£ç 
    â”‚
    â”œâ”€db                                            # é‡Œé¢æ”¾äº†åˆå§‹åŒ–æ•°æ®åº“çš„è„šæœ¬
    â”‚  â””â”€  build_nodes.py
    â”‚
    â”œâ”€routers                                       # è·¯ç”±ç›®å½•ï¼Œç›¸å½“äº Java é‡Œçš„ Controller
    â”‚  â”‚  node_router.py                            # neo4j èŠ‚ç‚¹æ¥å£ï¼Œç”¨æ¥å¤„ç†èŠ‚ç‚¹ç›¸å…³çš„æ¥å£æ–¹æ³•
    â”‚  â””â”€  __init__.py                              # è·¯ç”±é…ç½®ï¼ŒæŠŠç›®å½•ä¸‹çš„å„æ¨¡å—è·¯ç”±æ³¨å†Œåˆ° API é‡Œé¢
    â”‚
    â”œâ”€service                                       # ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå‚è€ƒJAVAï¼Œä¾› Controller è°ƒç”¨
    â”‚      node_service.py                          # neo4j èŠ‚ç‚¹æœåŠ¡ï¼Œå¤„ç†èŠ‚ç‚¹é€»è¾‘
    â”‚      __init__.py                              # ç›®å‰ç©º
    â”‚
    â”œâ”€static                                        # é™æ€èµ„æºç›®å½•
    â”‚      404.html                                 # URLåœ°å€ä¸å­˜åœ¨æ—¶ï¼Œæ˜¾ç¤ºè¿™ä¸ªé¡µé¢
    â”‚      index.html                               # é»˜è®¤é¦–é¡µ
    â”‚
    â””â”€utils                                         # å·¥å…·ç±»
       â”‚  neo4j_provider.py                         # neo4j è¿æ¥å·¥å…·
       â””â”€ __init__.py                               # ç›®å‰ç©º
    
    

### ä¸»ç¨‹åºä»£ç 

requirements.txt  
`pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`

    #pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
    
    # çŸ¥è¯†å›¾è°±ä¾èµ–åŒ…
    neo4j==5.10.0
    
    # async web framework
    
    # web æœåŠ¡å™¨
    uvicorn==0.23.2
    # ä»£ç æ¡†æ¶
    fastapi==0.101.1
    
    # ç¯å¢ƒé…ç½® .env ä½¿ç”¨ä¾èµ–åŒ…
    python-dotenv==0.20.0
    
    # å‘½ä»¤è¡Œã€æ§åˆ¶å°ï¼Œè¿”å›å†…å®¹ï¼Œå­—ä½“å˜é¢œè‰²
    colorama==0.4.4
    

.env ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶

    # app
    APP_HOST=127.0.0.1
    APP_PORT=8000
    
    # neo4j
    NEO4J_URI=neo4j://172.16.3.64:7687
    NEO4J_USER=neo4j
    NEO4J_PASSWORD=password
    NEO4J_VERSION=5
    NEO4J_DATABASE=neo4j
    NEO4J_PORT=8080
    

settings.py  
å˜é‡è®¾ç½®ä¸€èˆ¬æœ‰ä¸¤ç§ï¼Œä¸€ç§å–æ–‡ä»¶é‡Œçš„ï¼Œè¿˜æœ‰æ˜¯å–ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼Œè¯¦è§ï¼š[Python è®¾ç½®ç¯å¢ƒå˜é‡æ–¹æ³•](https://www.cnblogs.com/vipsoft/p/17677020.html)

    from dotenv import dotenv_values
    from typing import List
    
    dotenv_config = dotenv_values('.env')
    
    
    class Settings:
        BACKEND_CORS_ORIGINS: List = ['*']
    
        # APP
        APP_HOST = dotenv_config.get("APP_HOST", "127.0.0.1")
        APP_PORT = int(dotenv_config.get("APP_PORT", 8000))
    
        # Neo4j
        NEO4J_URI = dotenv_config.get("NEO4J_URI", "neo4j://172.16.3.64:7687")
        NEO4J_USER = dotenv_config.get("NEO4J_USER", "neo4j")
        NEO4J_PASSWORD = dotenv_config.get("NEO4J_PASSWORD", "password")
        NEO4J_VERSION = dotenv_config.get("NEO4J_VERSION", "5")
        NEO4J_DATABASE = dotenv_config.get("NEO4J_DATABASE", "neo4j")
        NEO4J_PORT = int(dotenv_config.get("NEO4J_PORT", 8080))
    
    
    settings = Settings()
    
    

app\_init.py  
é¡¹ç›®å¯åŠ¨

    import time
    import logging
    import os
    
    from settings import settings
    
    from starlette.middleware.cors import CORSMiddleware
    from fastapi import FastAPI, Request
    from fastapi.responses import JSONResponse, FileResponse
    from fastapi.staticfiles import StaticFiles
    
    from routers import api_router
    
    
    # åˆ›å»º  FastAPI å®ç±»ï¼Œä¾› main.py è°ƒç”¨
    def create_application() -> FastAPI:
        # ç­‰å¾…å…¶ä»–ç»„ä»¶å¯åŠ¨å®Œæˆ
        time.sleep(3)
        application = FastAPI(
            title="FastAPIç»“æ„ç¤ºä¾‹",  # æ–‡æ¡£æ ‡é¢˜
            description="ä½¿ç”¨ FastAPI å®ç° Node4j åŸºç¡€åŠŸèƒ½. ğŸš€",  # æ–‡æ¡£ç®€ä»‹
            version="0.0.1",  # æ–‡æ¡£ç‰ˆæœ¬å·
            # docs_url=None, redoc_url=None,  # é…ç½®ç¦»çº¿æ–‡æ¡£,None åï¼Œhttp://127.0.0.1:8000/docs å°±ä¸èƒ½å†è®¿é—®äº†
        )
    	# api_router =>  routers/__init__.py é‡Œé¢ çš„ api_router = APIRouter()
    	# è®¿é—®æ¥å£æ—¶ï¼Œæ‰€æœ‰çš„æ¥å£å‰é¢éƒ½è¦åŠ ä¸Š api å‰ç¼€ï¼Œç›¸å½“äº Java é‡Œçš„  server.servlet.context-path: /api é…ç½®
        application.include_router(api_router, prefix='/api')  # åé¢å¸¦ API çš„å°±è¡¨ç¤ºæ¥å£ï¼Œè·¯ç”±åˆ° routers ç›®å½•ä¸‹æ‰¾å¯¹åº”çš„æ¥å£ï¼Œç›¸å½“äº Java çš„ Controllerï¼Œ
        register_middleware(application)  # æ”¯ä»˜è·¨åŸŸ
        register_static(application)  # æ·»åŠ HTMLé™æ€é¡µé¢é…ç½®
        register_event(application)  # æ·»åŠ é¡¹ç›®äº‹ä»¶
        return application
    
    
    def register_static(app):
        # å¦‚æœéœ€è¦ä½¿ç”¨é™æ€æ–‡ä»¶ï¼Œ å¯ä»¥ä½¿ç”¨ StaticFilesï¼Œå°†å®ƒæŒ‚è½½åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚
        html_path = os.path.dirname(os.path.abspath(__file__))
        app.mount('/static', StaticFiles(directory=os.path.join(html_path, 'static')))
    
        @app.get('/')
        async def read_index():
            # è·³è½¬åˆ° static ä¸‹é¢çš„ index.html æ–‡ä»¶
            return FileResponse(os.path.join(html_path, 'static', 'index.html'))
    
        @app.exception_handler(404)
        async def not_found(request: Request, exc):
            accept = request.headers.get('accept')
            if not accept:
                # è¿”å›JSON æ ¼å¼
                return JSONResponse(content={'error': "Not found"}, status_code=exc.status_code)
            if exc.status_code == 404 and 'text/html' in accept:
                # 404 è·³è½¬åˆ° static ä¸‹é¢çš„ 404.html é¡µé¢
                return FileResponse(os.path.join(html_path, 'static', '404.html'))
            else:
                return JSONResponse(content={'error': "Not found"}, status_code=exc.status_code)
    
    
    # æ”¯æŒè·¨åŸŸ
    def register_middleware(application):
        if settings.BACKEND_CORS_ORIGINS:
            application.add_middleware(
                CORSMiddleware,
                allow_origins=[str(origin) for origin in settings.BACKEND_CORS_ORIGINS],
                allow_credentials=True,
                allow_methods=["*"],
                allow_headers=["*"],
            )
    
    
    def register_event(app):
        @app.on_event("startup")
        async def startup_event():
            logging.info("App Startup")
    
        @app.on_event("shutdown")
        async def shutdown_event():
            logging.info("App Shutdown")
    

#### æ¥å£è·¯ç”±

routers/**init**.py

    from fastapi import APIRouter
    
    from . import node_router
    
    api_router = APIRouter()
    
    # tags æ˜¾ç¤ºåœ¨ Swagger ä¸Šçš„æ ‡é¢˜
    # è¿™è¾¹çš„ prefix ç›¸å½“äº java é‡Œçš„ Controller ä¸Šçš„ @RequestMapping("/node")
    api_router.include_router(node_router.router, tags=['Node'], prefix='/node')
    

node\_router.py

    from fastapi import APIRouter, status
    from fastapi.responses import JSONResponse
    
    router = APIRouter()
    
    
    # å®šä¹‰ä¸€ä¸ªæ ¹è·¯ç”±
    @router.get("/add")
    def add_node():
        # TODO å¾€ neo4j é‡Œåˆ›å»ºæ–°çš„èŠ‚ç‚¹
        data = {
            'code': 0,
            'message': '',
            'data': 'add success'
        }
        return JSONResponse(content=data, status_code=status.HTTP_200_OK)
    

![image](https://img2023.cnblogs.com/blog/80824/202309/80824-20230907110835058-527580178.png)

é™„JAVAï¼Œæ¥å£å‰ç¼€é…ç½®  
æ‰€æœ‰æ¥å£å‰é¢çš„å‰ç¼€

    # å¼€å‘ç¯å¢ƒé…ç½®
    server:
      # æœåŠ¡å™¨çš„HTTPç«¯å£ï¼Œé»˜è®¤ä¸º8080
      port: 8088
      servlet:
        # åº”ç”¨çš„è®¿é—®è·¯å¾„
        context-path: /api
    

ä¸šåŠ¡æ¥å£ä¸Šçš„å‰ç¼€ï¼ˆæ‰€æœ‰ç±»æ–¹æ³•å‰ï¼‰

    @RequestMapping("/node")
    public class NodeController{
    
        @PostMapping("/add")
        public void add(){
    
        }
    }
    

æºç åœ°å€ï¼š[https://gitee.com/VipSoft/VipQA](https://gitee.com/VipSoft/VipQA)

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[VipSoft](https://www.cnblogs.com/vipsoft/) è½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/vipsoft/p/17684079.html](https://www.cnblogs.com/vipsoft/p/17684079.html)