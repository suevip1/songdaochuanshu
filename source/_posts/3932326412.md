---
layout: post
title: "Consistency Models终结扩散模型"
date: "2023-04-27T01:08:20.247Z"
---
Consistency Models终结扩散模型
========================

　　最近看到一篇论文，觉得特别有意思，并且在学术界引起了不小的动静，他就是一致性模型，据说图像生成效果快、质量高，并且还可以实现零样本图像编辑，即不进行一些视觉任务训练，可以实现图像超分、修复、上色等功能。

　　目前代码已经开源到GitHub上面：[https://github.com/openai/consistency\_models](https://github.com/openai/consistency_models)

1.介绍
====

　　扩散模型在图像、音频和视频生成方面取得了重大突破，但它们依赖于迭代生成过程，导致采样速度较慢，限制了其实时应用的潜力。为了克服这一限制，我们提出了一致性模型，这是一种新的生成模型家族，可以在没有对抗性训练的情况下实现高样本质量。它们在设计上支持快速的一步生成，同时仍然允许少步采样以换取样本质量的计算。它们还支持零样本数据编辑，如图像修补、着色和超分辨率，而不需要对这些任务进行明确的训练。

　　我们的目标是创建生成模型，以促进高效的单步生成，而不牺牲迭代细化的重要优势。这些优点包括在必要时为样本质量权衡计算的能力，以及执行零样本数据编辑任务的能力。如图1所示，我们建立在连续时间扩散模型中的概率流(PF)常微分方程(ODE)之上，其轨迹平滑地将数据分布转换为可处理的噪声分布。我们建议学习一个模型，将任何时间步骤的任何点映射到轨迹的起点。我们的模型的一个显著特性是自一致性:同一轨迹上的点映射到相同的起始点。因此，我们把这样的模型称为一致性模型。

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802562077-c1e6cb62-cf6a-4efc-a6e0-e825e178bb9d.png)

2.扩散模型
======

　　一致性模型在很大程度上受到(连续时间)扩散模型理论的启发。扩散模型通过高斯扰动逐步将数据扰动为噪声来生成数据，然后通过连续的去噪步骤从噪声中创建样本。让![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802665918-2bd82bc1-c30b-4ffd-be90-bf986ea4f31e.png)表示数据分布，扩散模型首先用随机微分方程(SDE)扩散

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802712603-8a8d1502-fa46-45a0-8a6d-9b916e967c1b.png)

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802749758-58c01672-77df-4eb8-bc75-62545205cba7.png)和![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802756399-f118466b-8630-4ecf-8a62-f1c855af0908.png)分别为漂移系数和扩散系数，![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802794305-b4e3e03b-1851-4bb4-9a18-9c086a04da6c.png)为标准布朗运动，我们把xt的分布表示为![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802852229-f4825b18-5124-4a1f-b35e-eac6c4ee8322.png)，结果是![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802883357-5523f0dd-815d-4ce9-a0d3-e8c68d9ba051.png)。该SDE的一个显著性质是存在一个常微分方程(ODE)，Song等人称之为概率流(PF) ODE，其在t点采样的轨迹分布:

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802973957-468cb220-b767-4a98-8a85-008f59addbb8.png)

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803041628-f44a781a-58a4-4339-8057-b41382df6181.png)是![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803059679-6bca946b-6588-4add-84f0-6cd544bd4906.png)分数函数，因此扩散模型也被称为基于分数的生成模型

　　通常情况下，式(1)中的SDE设计使![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681802852229-f4825b18-5124-4a1f-b35e-eac6c4ee8322.png)接近于可处理的高斯分布。为了进行采样，我们首先通过分数匹配训练一个分数模型![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803237886-eba39725-1169-4795-9d76-8e6a694c9918.png)，然后将其代入Eq.(2)，以获得PF ODE的经验估计，其形式为：

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803282127-69b7991c-bc18-4940-ba1c-568b46b95edb.png)

　　我们称Eq.(3)为经验PF ODE。我们采样![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803346550-86f794f9-450a-40f0-a97e-353a152b32c7.png)来初始化经验PF ODE，用任何数值ODE求解器及时地反向求解它。

　　扩散模型的瓶颈在于采样速度慢。显然，使用ODE求解器进行采样需要对评分模型![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803430711-4f03a66a-c7f8-4f98-97a4-c94066ed49b2.png)进行多次评估，这是计算成本很高的。现有的快速采样方法包括更快的数值ODE求解器和蒸馏技术。ODE求解器仍然需要超过10个评估步骤来生成有竞争力的样本。大多数蒸馏方法，依赖于在蒸馏之前从扩散模型中收集大量的样本数据集，这本身就是计算成本很高的。据我们所知，唯一不受这一缺点影响的蒸馏方法是渐进蒸馏(PD)。

3.一致性模型
=======

　　一致性模型是一种新型的生成模型，在其设计的核心支持单步生成，同时仍然允许迭代生成。一致性模型可以在蒸馏模式或隔离模式下训练。在前一种情况下，一致性模型将预先训练的扩散模型的知识提取到单步采样器中，显著提高了其他蒸馏方法的样品质量，同时允许零样本图像编辑应用。在后一种情况下，一致性模型是孤立地训练的，不依赖于预训练的扩散模型。这使得它们成为一种独立的新型生成模型。

　　**定义**：给定一个解轨迹式(2)中的PF ODE![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803707827-99dd7e13-c928-48d7-9db9-ab79cfa4e808.png)，我们定义一致性函数为![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803741753-2ba9276f-2e84-43ff-afeb-0136085cc49e.png)一致性函数具有这样的性质：它的输出对于属于相同PF ODE轨迹的任意对![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803790980-0509a00f-1e96-4647-bcf3-7856921fbc0a.png)都是一致的，如图2所示，一致性模型的目标，用fθ表示，是通过学习加强一致性属性来估计数据中的一致性函数f。

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803883063-37f00c2c-2c4e-427a-b5d9-2086ad4ae659.png)

　　**参数化**：对于任何一致性函数![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803955215-56c9ad5c-47c7-487f-b7ee-8d320807c06e.png)有![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681803980220-9e644664-0404-414b-b6cf-ff2fda95f743.png)称这个约束为边界条件，一个有效的一致性模型必须尊重这个边界条件。对于基于深度神经网络的一致性模型，我们讨论了两种几乎免费实现该边界条件的方法。假设我们有一个自由形式的深度神经网络，其输出与x具有相同的维数。第一种方法是简单地将一致性模型参数化为：

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804047252-355b5c97-eddc-4237-b338-9e8e26a16021.png)

　　第二种方法是使用跳越连接对一致性模型进行参数化：

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804083665-14fefe6b-1553-45a8-a946-c23640132430.png)

　　**采样**：一个训练好的一致性模型![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804247305-c50d58a7-3e41-4f36-8135-350e98126080.png)我们可以通过对初始分布进行采样来生成样本![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804281587-43a71915-91d3-4228-8291-be05728f18c9.png)，然后对一致性模型进行评价![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804309666-1f94f2e8-2b88-4fe5-903e-0bb1a0354b14.png)，这只涉及通过一致性模型的一次向前传递，因此在一个步骤中生成样本，重要的是，还可以通过交替去噪和噪声注入步骤来多次评估一致性模型，以提高样本质量。在算法1中总结，这种多步采样过程提供了交换计算样本质量的灵活性。它在零样本数据编辑中也有重要的应用。

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804466942-16a4b257-e060-42cb-a8f9-61a36e750485.png)

　　**零样本数据编辑**：一致性模型可以在零样本数据编辑中实现各种数据编辑和操作应用;他们不需要明确的训练来完成这些任务。一致性模型定义了从高斯噪声向量到数据样本的一对一映射。一致性模型可以通过遍历潜在空间轻松地在样本之间进行插值，可以对各种噪声级进行去噪。此外，算法1中的多步生成过程可以通过使用类似于扩散模型的迭代替换过程来解决零射中的某些逆问题。这使得图像编辑上下文中的许多应用成为可能，包括修复、着色、超分辨率等。

4.通过蒸馏训练一致性模型
=============

　　我们提出了基于提取预训练分数模型, 第一种训练一致性模型的方法。我们的讨论围绕式(3)中的经验PF ODE展开，它是通过将分数模型代入PF ODE得到的。在实践中，我们遵循Karras et al(2022)用公式确定边界![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804808869-606e5872-6696-4361-bc40-cd30f2d4b02b.png)当N足够大时，我们可以通过运行数值ODE求解器的一个离散化步骤，从![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804845792-9f2aa4ae-fe98-4be2-ab74-6645fe286567.png)获得![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804852256-6d6fe019-badc-497d-bcce-45de27346684.png)的准确估计。这个估计值，我们表示为![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804896018-45bbd5c9-c90b-4917-8407-aba698bea48d.png)，定义为

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804910802-fd34fa74-0545-4bf9-b100-4dc744c2e4d1.png)

　　当使用欧拉求解器时，对应如下更新规则：

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681804953294-7f7e4c9f-08dd-4a10-904f-781b420abf98.png)

　　为了简单起见，我们在这项工作中只考虑一步ODE求解器。将我们的框架推广到多步ODE求解器是很简单的，我们把它留作以后的工作。

　　给定一个数据点,我们可以生成一对相邻数据点![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805060558-3a07994d-333c-400e-8e1b-94405472d0a0.png)通过从数据集中采样x，有效地对PF ODE轨迹进行优化，紧随其后的是采样![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805155227-f7ffea67-33f6-409d-8b93-bdb496dbdb97.png) 从SDE的转变密度![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805132968-9b8706a1-a815-4697-8c4e-7f1a649034d3.png),然后根据Eq.(6)，使用数值ODE求解器的一个离散步骤来计算![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805260545-54574be8-3515-4baf-9f97-e18c846c5209.png)。然后，通过最小化一致性模型在![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805304652-9faace12-70ee-405a-8323-aa0ed3840c93.png)对上的输出差异来训练一致性模型。这促使我们遵循一致性蒸馏损失来训练一致性模型。

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805364885-f9a04332-0f04-4329-ad89-442687a0ae3e.png)

　　用E\[.\]表示所有相关随机变量的期望。在我们的实验中，我们考虑了平方距离和l1距离![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805459361-dc891c0a-c972-4b48-b248-147b56f8fffd.png)，以及习得的感知图像块相似性，发现![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805506240-fa7718f7-b41c-4e0e-a98d-1dac2841f5a4.png)在所有测试中表现良好，我们通过对模型参数θ的随机梯度下降来最小化目标，同时用指数移动平均(EMA)更新θ´。也就是说，给定衰减率，我们在每个优化步骤后执行以下更新:

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805549299-a44c140e-ce36-44f9-b98f-7dd17bee6d02.png)

　　我们把fθ´称为“目标网络”，fθ称为“在线网络”。我们发现，与简单设置θ´θ相比，Eq.(8)中的EMA更新和“stopgrad”算子可以极大地稳定训练过程，提高一致性模型的最终性能。

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805663739-e42c2edd-6f0b-420b-b0d9-f28fe79652f3.png)

5.隔离训练一致性模型
===========

　　一致性模型可以不依赖于任何预训练的扩散模型进行训练，使一致性模型成为一个新的独立的生成模型家族。在一致性蒸馏中，我们使用预先训练好的评分模型来近似真实评分函数![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805762313-cf3dd7cc-6bf7-41fe-9e4c-e637b7c775dd.png)。为了摆脱这种依赖，我们需要寻找其他方法来估计分数函数。事实上，由于以下恒等式，存在![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805791295-20ce3f4c-1ae3-45c1-8990-a25617dc2fe6.png)的无偏估计量：

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805803506-c050ae1b-7c0a-4752-a768-9c29e691ed04.png)

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805913964-95f5c5da-3a80-44c2-9370-aa92f05fbbee.png)我们可以得到蒙特卡罗估计![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805941855-508b320f-136b-48e8-afa1-ad2b63a655c1.png)，这个估计实际上足以取代预先训练的扩散模型，进一步假设我们使用欧拉ODE求解器，预训练的分数模型与GT匹配![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681806383603-86997444-9141-48ed-8ed1-3f87dcf8b361.png)，即:

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681806399350-d9664326-00c5-478b-be0b-b3c31075d523.png)

　　一致性训练目标![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681806507619-1899037c-736b-4f24-aee2-6b9c4625b91d.png)，表示为

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681806536266-81701f34-3439-4910-929a-9356189c5f83.png)

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681806586856-8f83bf53-92d9-448d-ba70-d38139311f81.png)，如果![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681806605861-d7851e9f-0bdd-4f81-8fcf-b8ea98a04430.png)![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681806621623-421d1e98-9bd6-4a8a-bb11-b283b3ffcdf8.png)证明基于Taylor级数展开和分数函数的性质。我们将式(10)称为一致性训练(CT)损失。关键的是，loss只依赖于在线网络fθ和目标网络fθ´，而完全不依赖于扩散模型参数φ。

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681805989345-52698d7f-f6b4-4e4f-8e61-87f5d823cb20.png)

6.实验
====

　　使用一致性蒸馏和一致性训练来学习真实图像数据集上的一致性模型，包括CIFAR-10 ， ImageNet， LSUN。根据FID(越低越好)，Inception Score (is, 越高越好)，Precision (Prec,越高越好)，以及Recall (Rec，越高越好)。

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807009608-46813e52-de5c-4b60-8990-ca77669ddb94.png)

　　影响CIFAR-10一致性蒸馏(CD)和一致性训练(CT)的各种因素。CD的最佳配置是LPIPS, Heun ODE求解器和N=18。我们对N和µ的自适应调度函数使CT在优化过程中收敛速度明显快于将其固定为常数。由于CD和CT之间的紧密联系，本文采用LPIPS进行CT实验。与CD不同，在CT中不需要使用Heun的二阶求解器，因为损失函数不依赖于任何特定的数值ODE求解器。如图3d所示，CT的收敛对N高度敏感，N越小收敛速度越快，但得到的样本越差，N越大收敛速度越慢，收敛后得到的样本越好。这与我们在第5节中的分析相匹配，并促使我们实际选择逐步增长的N和µ用于CT，以平衡收敛速度和样本质量之间的权衡。

　　与扩散模型类似，一致性模型允许通过修改算法1中的多步采样过程来编辑零样本图像。我们使用一致性蒸馏在LSUN卧室数据集上训练的一致性模型演示了这种能力。在图6a中，我们展示了这样一个一致性模型可以在测试时对灰度卧室图像进行着色，即使它从未接受过着色任务的训练。在图6b中，我们展示了相同的一致性模型可以从生成高分辨率图像：  
　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807205181-a059bbaf-e3ef-4ba1-82b0-867892c8c3a1.png)　　

6.1零样本图像编辑
----------

　　采用算法4来实现图像的超分辨率。为简单起见，我们假设下采样图像是通过p\*p大小的不重叠块获得的。假设全分辨率图像的形状为h\*w\*3。让y表示简单地向上采样到全分辨率的低分辨率图像，其中每个非重叠补丁中的像素共享相同的值。另外，设![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807344307-032710d9-5fad-4158-b9eb-6965f92c6b6d.png)为二进制掩码：

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807356130-163d3fc2-37af-4868-bc47-2ac8f83c8ae3.png)

　　超分辨率需要一个正交矩阵![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807380356-3ad65542-d47d-4a57-9eb6-f49184efd294.png)，第一列是![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807400033-cabbbe63-ed59-4e02-bf70-36cf90e10af4.png)该正交矩阵可通过QR分解得到。为了实现超分辨率，我们定义线性变换A:

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807484417-b9c22f65-f957-44be-a498-9aa085789e9f.png)

　　逆变换![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807515997-91ef4262-8a97-41d6-87db-12848beb26e1.png)：

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807542362-b9c7d93e-e317-4075-8ffa-561d0622d6e3.png)

　　上述A和Ω的定义允许我们使用算法4进行图像超分辨率。

　　![](https://cdn.nlark.com/yuque/0/2023/png/22916227/1681807265975-041ac301-2418-4c2a-896b-d08606fbdc62.png)