---
layout: post
title: "Golangä¹‹æ—…â€”â€”å†…å­˜ç®¡ç†"
date: "2023-08-13T00:57:53.683Z"
---
Golangä¹‹æ—…â€”â€”å†…å­˜ç®¡ç†
==============

golangå­¦ä¹ è®°å½•-å†…å­˜ç®¡ç†

è½¬è½½æ”¾åœ¨æœ€å‰
------

[ä¸€æ–‡å¸¦ä½ äº†è§£ï¼Œè™šæ‹Ÿå†…å­˜ã€å†…å­˜åˆ†é¡µã€åˆ†æ®µã€æ®µé¡µå¼å†…å­˜ç®¡ç†](https://zhuanlan.zhihu.com/p/451736494)  
[\[Golangä¸‰å…³-å…¸è—ç‰ˆ\]ä¸€ç«™å¼Golangå†…å­˜æ´—é«“ç» | Go æŠ€æœ¯è®ºå›](https://learnku.com/articles/68142) åˆ˜ä¸¹å†°Aceld  
æ„Ÿè°¢ä»¥ä¸Šæ–‡ç« ä½œè€…ï¼Œæ”¶è·æ»¡æ»¡ğŸ‰ğŸ‰ğŸ‰  

å­˜å‚¨å™¨ç®¡ç†
-----

### åˆ†é¡µå­˜å‚¨ç®¡ç†åŸºæœ¬åŸç†

åœ¨é€»è¾‘ç©ºé—´ä¸­çš„å—ç§°ä¸ºé¡µé¢ï¼Œç‰©ç†ç©ºé—´ä¸­çš„ç§°ä¸ºç‰©ç†å—ï¼Œæˆ–è€…é¡µæ¡†å’Œå¸§ã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691829516179-c5c9aa98-1943-44c5-a8a1-2b15feb5f05b.png#averageHue=%23d9ddd6&clientId=ud19b14f9-7332-4&from=paste&id=uf151bc9d&originHeight=561&originWidth=935&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=178077&status=done&style=none&taskId=u5cd5737b-91d4-47c6-a5f4-ed789a2f13b&title=)  

#### é¡µä¸é¡µæ¡†

![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691829151180-d0db7998-5703-49d2-878d-840bbd093b56.png#averageHue=%23f8f8f8&clientId=ud19b14f9-7332-4&from=paste&height=204&id=uf9dada50&originHeight=255&originWidth=689&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=17105&status=done&style=none&taskId=u879ebec4-4f1e-445d-85f6-7fb4ed47856&title=&width=551.2)  
åˆ†é¡µç³»ç»Ÿçš„é€»è¾‘åœ°å€ç»“æ„åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œé¡µå·På’Œé¡µå†…åœ°å€d(åˆç§°ä¸ºé¡µå†…åç§»é‡)ã€‚  
ä»¥32ä½è®¡ç®—æœºçš„é€»è¾‘åœ°å€ä¸ºä¾‹ï¼Œå…¶åœ°å€ç»“æ„å¦‚å›¾æ‰€ç¤º  
é€»è¾‘åœ°å€ä¸º32ä½ï¼Œè®¾é¡µé¢å¤§å°ä¸º4KBï¼Œåˆ™12ä½ã€‚åˆ™12-31ä½åˆ™ä¸ºé¡µå·ï¼Œå…±20ä½ã€‚  
è¿™æ—¶å€™å¯ä»¥è½»æ¾è®¡ç®—å¾—å‡ºï¼Œå†…å­˜å¤§å°ä¸º212\*220=232=4GB  

#### é¡µè¡¨

åœ¨ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åœ°å€æ˜ å°„çš„é€‚åˆéœ€è¦çŸ¥é“é¡µé¢å¯¹åº”çš„ç‰©ç†å—ï¼Œ**ç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹è®¾ç½®äº†ä¸€å¼ é¡µå·åˆ°ç‰©ç†å—å·çš„æ˜ å°„è¡¨ï¼Œç§°ä¸ºé¡µè¡¨ã€‚**  
é¡µè¡¨çš„æ¯ä¸ªè¡¨é¡¹PTE(PAge Table Entry)ç”±é¡µå·På’Œå…¶å¯¹åº”çš„ç‰©ç†å—å·Fç»„æˆï¼Œä»¥é¡µå·ä¸ºåºå»ºç«‹ã€‚  
æ³¨æ„ï¼Œé¡µè¡¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œåªå­˜å‚¨ç‰©ç†å—å·ï¼Œé¡µå·ä¸å ç”¨å­˜å‚¨ç©ºé—´ï¼Œç„¶åå°†é¡µè¡¨çš„èµ·å§‹åœ°å€åŠé•¿åº¦ä¿å­˜åœ¨è¿›ç¨‹çš„PCBä¸­ï¼Œå½“ä»¥åè°ƒåº¦è¿›ç¨‹åˆ°CPUä¸Šæ‰§è¡Œæ—¶ï¼Œå†å°†PCBä¸­ä¿å­˜çš„é¡µè¡¨å§‹åœ°å€åŠé•¿åº¦å†™å…¥CPUçš„é¡µè¡¨å¯„å­˜å™¨ä¸­ã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691829662249-7be675c5-9abc-4303-a234-f404ee09743c.png#averageHue=%23fafafa&clientId=ud19b14f9-7332-4&from=paste&height=190&id=ub84e8ee6&originHeight=238&originWidth=681&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=6762&status=done&style=none&taskId=u3257ed2c-21c6-446f-a018-1b85e0124e8&title=&width=544.8)  

#### åœ°å€æ˜ å°„ä¸è¶Šç•Œä¿æŠ¤

æˆ‘ä»¬è®¾Aä¸ºç‰©ç†åœ°å€ï¼ŒFä¸ºé¡µé¢å¯¹åº”çš„ç‰©ç†å—å·ï¼ŒLä¸ºé¡µé¢çš„å¤§å°ï¼Œwä¸ºé¡µå†…çš„åœ°å€ï¼Œåœ¨ä»¥ä¸Šæ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç‰©ç†åœ°å€ï¼š  
**A=F\*L + w**  
![](https://cdn.nlark.com/yuque/0/2023/jpeg/26124869/1691830080855-23f959e2-debe-4126-b025-03684ecb2567.jpeg#averageHue=%23f3f2ee&clientId=ud19b14f9-7332-4&from=paste&id=u3d4a3072&originHeight=409&originWidth=690&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u147d53de-aff6-436b-b0a0-3d1df6b3cc6&title=)  
å¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹æ­¥éª¤

1.  å½“è°ƒåº¦ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œåˆ‡æ¢ç¨‹åºä¼šå°†ä¸‹ä¸€ä¸ªè¿è¡Œè¿›ç¨‹çš„é¡µè¡¨å§‹åœ°å€åŠé¡µè¡¨é•¿åº¦å†™å…¥é¡µè¡¨å¯„å­˜å™¨PTRä¸­ã€‚
2.  è¿›è¡Œåœ°å€æ˜ å°„æ—¶ï¼Œé¦–å…ˆæ ¹æ®é€»è¾‘åœ°å€è·å–é¡µå·På’Œé¡µå†…åç§»é‡W
3.  é¦–å…ˆæ£€æŸ¥å¿«è¡¨ï¼Œå¿«è¡¨æ˜¯åœ°å€æ˜ å°„æœºæ„ä¸­ä¸€ä¸ªå…·æœ‰å¹¶è¡ŒæŸ¥æ‰¾èƒ½åŠ›çš„é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨ï¼Œå¦‚æœå¿«è¡¨å‘½ä¸­ï¼Œåˆ™ç›´æ¥è·å–å—å·ã€‚è‹¥å¿«è¡¨ä¸å‘½ä¸­ï¼Œåˆ™ä»ç„¶éœ€è¦è®¿é—®å†…å­˜é¡µè¡¨ã€‚
4.  å¦‚æœå¿«è¡¨æœªå‘½ä¸­ï¼Œåˆ¤æ–­é¡µå·æ˜¯å¦è¶…è¿‡é¡µè¡¨é•¿åº¦ï¼Œå¦‚æœè¶…è¿‡ï¼Œäº§ç”Ÿâ€œ**åœ°å€è¶Šç•Œ**â€ä¸­æ–­ã€‚
5.  è®¿é—®å†…å­˜é¡µè¡¨ï¼Œè·å–å—å·ï¼Œå¹¶ä¸”æ›´æ–°å¿«è¡¨ï¼Œå°†æœ¬æ¬¡è®¿é—®çš„é¡µè¡¨é¡¹åŠ å…¥å¿«è¡¨ä¸­ã€‚
6.  é€šè¿‡å—å·å’Œé¡µå†…åç§»é‡Wè®¡ç®—ç‰©ç†åœ°å€Aã€‚

åœ¨æ­¤ï¼Œä½ å¯ä»¥æƒ³ä¸€ä¸‹ï¼Œä½¿ç”¨å¿«è¡¨å’Œä¸ä½¿ç”¨å¿«è¡¨ï¼Œåˆ†åˆ«è®¿é—®äº†å‡ æ¬¡å†…å­˜ï¼Ÿï¼ˆä½¿ç”¨å¿«è¡¨è®¿é—®ä¸€æ¬¡ï¼Œä¸ä½¿ç”¨è®¿é—®ä¸¤æ¬¡ï¼‰  

#### ä¸¤çº§å’Œå¤šçº§é¡µè¡¨

![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691830773578-85a24855-a455-4aa5-8d27-e94419c2b0dd.png#averageHue=%23f8f4f2&clientId=ud19b14f9-7332-4&from=paste&id=u08f98e24&originHeight=1146&originWidth=1686&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=494674&status=done&style=none&taskId=ufba273cd-31ef-4609-bd91-fee0dcddce2&title=)  
å¤šçº§é¡µè¡¨å ç”¨çš„ç©ºé—´å¾ˆå¤§ï¼Œå¦‚æœä»¥è¯¥äºŒçº§é¡µè¡¨ä¸ºä¾‹ï¼Œæ˜ å°„4GBçš„åœ°å€ç©ºé—´ï¼Œéœ€è¦4KB+4MBï¼Œè¶³è¶³å¤šäº†4MBã€‚**æ‰€ä»¥æ“ä½œç³»ç»Ÿä»…ä¼šå°†é¡¶çº§é¡µè¡¨å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚**  
å¤šçº§é¡µè¡¨çš„æ±‚å€è¿‡ç¨‹å’Œå•çº§ä¹Ÿæ²¡æœ‰å¤šå°‘åŒºåˆ«ã€‚  

### åˆ†æ®µå­˜å‚¨ç®¡ç†æ–¹å¼

#### åˆ†æ®µ

åœ¨åˆ†æ®µå­˜å‚¨ä¸­ï¼Œä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ®µ

1.  ä»£ç æ®µï¼ˆCode Segmentï¼‰ï¼š å­˜å‚¨ç¨‹åºçš„æŒ‡ä»¤ï¼Œä¹Ÿç§°ä¸ºå¯æ‰§è¡Œä»£ç ã€‚è¿™éƒ¨åˆ†å†…å­˜åŒ…å«äº†ç¨‹åºçš„æœºå™¨æŒ‡ä»¤ï¼Œç”¨äºå®é™…æ‰§è¡Œç¨‹åºçš„æ“ä½œã€‚
2.  æ•°æ®æ®µï¼ˆData Segmentï¼‰ï¼š å­˜å‚¨å·²åˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€å˜é‡ã€‚è¿™äº›å˜é‡åœ¨ç¨‹åºå¼€å§‹è¿è¡Œæ—¶å°±å·²ç»è¢«åˆå§‹åŒ–å¹¶å ç”¨å†…å­˜ç©ºé—´ã€‚
3.  æœªåˆå§‹åŒ–æ•°æ®æ®µï¼ˆBSS Segmentï¼‰ï¼š å­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€å˜é‡ã€‚è¿™äº›å˜é‡åœ¨ç¨‹åºå¼€å§‹è¿è¡Œæ—¶ä¼šè¢«åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ï¼ˆé€šå¸¸ä¸º0ï¼‰ï¼Œä½†å®é™…çš„åˆå§‹åŒ–æ“ä½œä¼šåœ¨è¿è¡Œæ—¶å®Œæˆã€‚
4.  å †æ ˆæ®µï¼ˆStack Segmentï¼‰ï¼š å­˜å‚¨ç¨‹åºçš„æ‰§è¡Œå †æ ˆã€‚å †æ ˆç”¨äºå­˜å‚¨å‡½æ•°è°ƒç”¨å’Œå±€éƒ¨å˜é‡ç­‰æ•°æ®ï¼Œä»¥åŠç®¡ç†å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›ã€‚
5.  å †æ®µï¼ˆHeap Segmentï¼‰ï¼š å­˜å‚¨åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œç”¨äºç¨‹åºåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”³è¯·å’Œé‡Šæ”¾çš„å†…å­˜ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ malloc() æˆ– new å‡½æ•°åˆ†é…çš„å†…å­˜å°±ä½äºå †æ®µã€‚  
    

#### æ®µè¡¨

![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691837422848-3360b660-8d75-4c34-b778-fa7d161f6af7.png#averageHue=%23f7f7f7&clientId=ud19b14f9-7332-4&from=paste&height=165&id=ua59cb6b4&originHeight=206&originWidth=562&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=8264&status=done&style=none&taskId=u5335909d-9fce-462f-8396-2648656fd08&title=&width=449.6)

*   æ®µå†…åœ°å€çš„ä½æ•°å¯ä»¥å†³å®šæ®µçš„å¤§å°
*   é€»è¾‘åœ°å€=æ®µå·&æ®µå†…åœ°å€ï¼ˆ&å·æ˜¯è¿æ¥ç¬¦å·ï¼Œæ˜¯å°†æ®µå·ä½œä¸ºé€»è¾‘åœ°å€çš„æœ€é«˜ä½ï¼‰

![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691831249716-b1fe0b48-6e20-4f0f-818a-a951a10d492d.png#averageHue=%23f7eee3&clientId=ud19b14f9-7332-4&from=paste&id=B70CD&originHeight=651&originWidth=1055&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=229736&status=done&style=none&taskId=ufbfbf668-6a18-426a-a30a-3ff11faf8a0&title=)  
æ®µå¼çš„æ±‚å€è¿‡ç¨‹å’Œé¡µå¼ä¹Ÿå·®ä¸å¤ªå¤šï¼Œå°±ä¸å†ä»‹ç»äº†ã€‚  

### æ®µé¡µå¼å­˜å‚¨

ç”¨æˆ·ç¨‹åº**å…ˆåˆ†æ®µ**ï¼Œæ¯ä¸ªæ®µå†…éƒ¨**å†åˆ†é¡µï¼ˆå†…éƒ¨åŸç†åŒåŸºæœ¬çš„åˆ†é¡µã€åˆ†æ®µç›¸åŒï¼‰**  
![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691839117225-579a6c6c-8965-408b-85f4-108668fa37c8.png#averageHue=%23f7eee8&clientId=ud19b14f9-7332-4&from=paste&id=u788a38b2&originHeight=699&originWidth=1452&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=325876&status=done&style=none&taskId=u0db5ce8d-c087-4647-b81e-eb8c24468fd&title=)  

#### æ®µé¡µå¼é€»è¾‘åœ°å€ç»“æ„

#### ![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691839229267-a692d2bc-1ef2-4d15-bdc8-569ae0a9d074.png#averageHue=%23f7f7f7&clientId=ud19b14f9-7332-4&from=paste&height=178&id=udea50416&originHeight=223&originWidth=672&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=13951&status=done&style=none&taskId=uadbfcb95-815d-418c-8d65-b98364e3a72&title=&width=537.6)

æ®µé¡µå¼åœ°å€å˜æ¢ä¸­è¦å¾—åˆ°ç‰©ç†åœ°å€é¡»ç»è¿‡ä¸‰æ¬¡å†…å­˜è®¿é—®ï¼š

*   ç¬¬ä¸€æ¬¡è®¿é—®æ®µè¡¨ï¼Œå¾—åˆ°é¡µè¡¨èµ·å§‹åœ°å€ï¼›
*   ç¬¬äºŒæ¬¡è®¿é—®é¡µè¡¨ï¼Œå¾—åˆ°ç‰©ç†é¡µå·ï¼›
*   ç¬¬ä¸‰æ¬¡å°†ç‰©ç†é¡µå·ä¸é¡µå†…ä½ç§»ç»„åˆï¼Œå¾—åˆ°ç‰©ç†åœ°å€ã€‚

è¿™éƒ¨åˆ†å†…å®¹æˆ‘è§‰å¾—åŸç†å·®ä¸å¤šï¼Œç›®å‰å°±å…ˆä¸å†™äº†ã€‚  
æœ‰å¾ˆå¤šæµç¨‹å›¾æˆ–ç»“æ„å›¾ï¼Œä»¥åæœ‰æ—¶é—´å¯ä»¥å†è¡¥ä¸Šã€‚  

### è™šæ‹Ÿå†…å­˜

æ—¢ç„¶æœ‰è™šæ‹Ÿï¼Œé‚£è‚¯å®šä¹Ÿæœ‰å®é™…ï¼Œæ‰€ä»¥æœ‰ä»¥ä¸‹ä¸¤ä¸ªæ¦‚å¿µ

*   æˆ‘ä»¬ç¨‹åºæ‰€ä½¿ç”¨çš„å†…å­˜åœ°å€å«åš**è™šæ‹Ÿå†…å­˜åœ°å€**ï¼ˆ_Virtual Memory Address_ï¼‰
*   å®é™…å­˜åœ¨ç¡¬ä»¶é‡Œé¢çš„ç©ºé—´åœ°å€å«**ç‰©ç†å†…å­˜åœ°å€**ï¼ˆ_Physical Memory Address_ï¼‰ã€‚

è™šæ‹Ÿå†…å­˜æ˜¯è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒå…è®¸ç¨‹åºä½¿ç”¨æ¯”å®é™…ç‰©ç†å†…å­˜æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚å®é™…ä¸Šï¼Œè®¡ç®—æœºä¸Šçš„ç‰©ç†å†…å­˜å®¹é‡é€šå¸¸æ˜¯æœ‰é™çš„ï¼Œä½†æ˜¯è™šæ‹Ÿå†…å­˜å…è®¸æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºä¼¼ä¹å…·æœ‰æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚  
è™šæ‹Ÿå­˜å‚¨ç³»ç»Ÿåœ¨ä¸¤æ–¹é¢æœ‰æ”¹è¿›

*   å°†è¿›ç¨‹è£…å…¥çš„ä¸€æ¬¡æ€§æˆ–è€…æ•´ä½“æ€§æ”¹ä¸ºå¤šæ¬¡æ€§
*   å°†è¿›ç¨‹çš„é©»ç•™æ€§æ”¹ä¸ºç½®æ¢æ€§

ç¨‹åºè¿è¡Œæ—¶ï¼Œå¦‚æœè¦è®¿é—®çš„é¡µé¢(æ®µ)å·²è£…å…¥å†…å­˜ï¼Œä¾¿å¯ç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œå¦‚æœå®ƒè¦è®¿é—®çš„é¡µé¢(æ®µ)å°šæœªè£…å…¥å†…å­˜ï¼Œåˆ™å‘ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿå°†å¯åŠ¨è¯·æ±‚è°ƒé¡µ(æ®µ)åŠŸèƒ½ï¼Œå°†ä½œä¸šæ‰€éœ€çš„é¡µ(æ®µ)è£…å…¥å†…å­˜ã€‚å¦‚æœæ­¤æ—¶å†…å­˜å·²æ»¡ï¼Œåˆ™ä¼šä½¿ç”¨ç›¸åº”çš„é¡µé¢ç½®æ¢ç®—æ³•æ¥è¿›è¡Œé¡µé¢ç½®æ¢ã€‚  
**è™šæ‹Ÿå­˜å‚¨å™¨çš„å®ç°ï¼Œå¿…é¡»å»ºç«‹åœ¨ç¦»æ•£å­˜å‚¨å™¨ç®¡ç†æ–¹å¼çš„åŸºç¡€ä¹‹ä¸Šï¼Œå› æ­¤å¯ä»¥æœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼šè¯·æ±‚åˆ†é¡µï¼Œè¯·æ±‚åˆ†æ®µå’Œè¯·æ±‚æ®µé¡µå¼**ï¼Œå½“å‰ä¸»æµçš„æ–¹æ³•å¼è¯·æ±‚åˆ†é¡µæ–¹å¼ï¼Œå› æ­¤ä¸‹é¢çš„å†…å®¹å°†ä»¥è¯·æ±‚åˆ†é¡µå­˜å‚¨ç®¡ç†æ–¹å¼çš„å®ç°æœºåˆ¶ä¸ºä¾‹æ¥è¯´æ˜ã€‚  

#### é¡µè¡¨

è¿™é‡Œçš„é¡µè¡¨å’Œä¹‹å‰æ‰€æåˆ°çš„æœ‰ä¸åŒï¼Œä½†å…¶åŸºæœ¬ä½œç”¨ä»ç„¶æ˜¯å®ç°é¡µå·åˆ°ç‰©ç†å—å·çš„æ˜ å°„ã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691840424834-4dbd08b1-7f14-4d66-845e-8dbb055222a8.png#averageHue=%23f7f7f7&clientId=ud19b14f9-7332-4&from=paste&height=184&id=uc563b7f2&originHeight=230&originWidth=1243&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=24209&status=done&style=none&taskId=u30a6313b-d2b3-4892-9d48-6e4de885546&title=&width=994.4)

1.  çŠ¶æ€ä½Pï¼šè¡¨ç¤ºé¡µé¢æ˜¯å¦åœ¨å†…å­˜ï¼Œè‹¥ä¸åœ¨å†…å­˜ï¼Œåˆ™äº§ç”Ÿç¼ºé¡µä¸­æ–­ã€‚
2.  è®¿é—®å­—æ®µAï¼šè®°å½•é¡µé¢è¢«è®¿é—®çš„æƒ…å†µï¼Œä¾æ®æ‰€é‡‡ç”¨çš„é¡µé¢ç½®æ¢ç®—æ³•ï¼Œå¯èƒ½æ˜¯è¢«è®¿é—®æ¬¡æ•°æˆ–è€…æœªè®¿é—®æ—¶é—´ï¼Œä¾›é¡µé¢ç½®æ¢æ—¶å‚è€ƒã€‚
3.  ä¿®æ”¹ä½Mï¼šè¡¨ç¤ºé¡µé¢è£…å…¥å†…å­˜åæ˜¯å¦æœ‰è¢«ä¿®æ”¹è¿‡ã€‚
4.  å¤–å­˜åœ°å€ï¼šè®°å½•é¡µé¢åœ¨å¤–å­˜ä¸Šçš„åœ°å€ï¼Œé€šå¸¸æ˜¯ç‰©ç†å—å·ï¼Œä¾›è°ƒå…¥é¡µé¢æ—¶å‚è€ƒã€‚  
    

#### ç¼ºé¡µä¸­æ–­æµç¨‹

![image.png](https://cdn.nlark.com/yuque/0/2023/png/26124869/1691842598493-185e6fab-7cb2-4089-b0ed-5ba6a48652e2.png#averageHue=%23f8f8f8&clientId=ud19b14f9-7332-4&from=paste&height=758&id=u4dacf909&originHeight=947&originWidth=1556&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=146910&status=done&style=none&taskId=ud48217a8-ebc1-40bb-82be-377256c6f71&title=&width=1244.8)  

#### é¡µé¢ç½®æ¢ç­–ç•¥

è¦çŸ¥é“å›ºå®šåˆ†é…å±€éƒ¨ç½®æ¢ã€å¯å˜åˆ†é…å…¨éƒ¨ç½®æ¢ã€å¯å˜åˆ†é…å±€éƒ¨ç½®æ¢çš„æ„æ€ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š  
1.\*\* å›ºå®šåˆ†é…**ï¼šæ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ç»„å›ºå®šæ•°ç›®å¤§å°çš„ç‰©ç†å—ã€‚åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸å…è®¸æ”¹å˜ï¼å³é©»ç•™é›†å¤§å°å›ºå®šä¸å˜ã€‚  
2.**å¯å˜åˆ†é…**ï¼šå…ˆä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€å®šå¤§å°çš„ç‰©ç†å—ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åŠ¨æ€æ”¹å˜ç‰©ç†å—çš„å¤§å°ã€‚å³ï¼Œé©»ç•™é›†å¤§å°å¯å˜ã€‚  
3.**å±€éƒ¨ç½®æ¢**ï¼šè¿›ç¨‹å‘ç”Ÿç¼ºé¡µæ—¶ï¼Œåªèƒ½é€‰æ‹©å½“å‰è¿›ç¨‹ä¸­çš„ç‰©ç†å—è¿›è¡Œç½®æ¢ã€‚  
4.**å…¨å±€ç½®æ¢\*\*ï¼šå¯ä»¥å°†æ“ä½œç³»ç»Ÿè¿›ç¨‹ä¸­ä¿ç•™çš„ç©ºé—²ç‰©ç†å—åˆ†é…ç»™ç¼ºé¡µè¿›ç¨‹ï¼Œè¿˜å¯ä»¥å°†åˆ«çš„è¿›ç¨‹æŒæœ‰çš„ç‰©ç†å—ç½®æ¢åˆ°å¤–å­˜ï¼Œå†å°†è¿™ä¸ªç‰©ç†å—åˆ†é…ç»™ç¼ºé¡µçš„è¿›ç¨‹ã€‚  

##### å›ºå®šåˆ†é…å±€éƒ¨ç½®æ¢

**æ¦‚å¿µ**ï¼šç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…**ä¸€å®šæ•°é‡**çš„[å†…å­˜](https://so.csdn.net/so/search?q=%E5%86%85%E5%AD%98&spm=1001.2101.3001.7020)å—ï¼ˆç‰©ç†å—ï¼‰ï¼Œåœ¨æ•´ä¸ªè¿è¡ŒæœŸéƒ½ä¸æ”¹å˜ã€‚è‹¥è¿›ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†ç¼ºé¡µï¼Œåˆ™**åªèƒ½åœ¨æœ¬è¿›ç¨‹çš„å†…å­˜é¡µé¢**ä¸­é€‰å‡ºä¸€ä¸ªè¿›è¡Œæ¢å‡ºï¼Œç„¶åå†è°ƒç”¨éœ€è¦çš„é¡µé¢ã€‚  
**ç¼ºç‚¹**ï¼šå¾ˆéš¾ç¡®å®šä¸€ä¸ªè¿›ç¨‹åˆ°åº•åº”è¯¥åˆ†é…å¤šå¤§çš„å®é™…å†…å­˜æ‰åˆç†  

##### å¯å˜åˆ†é…å±€éƒ¨ç½®æ¢

**æ¦‚å¿µ**ï¼šåˆšå¼€å§‹ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€å®šæ•°é‡çš„ç‰©ç†å—ã€‚å½“è¿›ç¨‹å‘ç”Ÿç¼ºé¡µæ—¶ï¼Œåªå…è®¸ä»å½“å‰è¿›ç¨‹çš„ç‰©ç†å—ä¸­é€‰å‡ºä¸€ä¸ªæ¢å‡ºå¤–å­˜ã€‚å¦‚æœå½“å‰è¿›ç¨‹åœ¨è¿è¡Œçš„æ—¶å€™é¢‘ç¹ç¼ºé¡µï¼Œç³»ç»Ÿä¼šä¸ºè¯¥è¿›ç¨‹åŠ¨æ€å¢åŠ ä¸€äº›ç‰©ç†å—ï¼Œç›´åˆ°è¯¥è¿›ç¨‹ç¼ºé¡µç‡è¶‹äºé€‚ä¸­ç¨‹åº¦ï¼›å¦‚æœè¯´ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç¼ºé¡µç‡å¾ˆä½æˆ–è€…ä¸ç¼ºé¡µï¼Œåˆ™å¯ä»¥é€‚å½“å‡å°‘è¯¥è¿›ç¨‹åˆ†é…çš„ç‰©ç†å—ã€‚é€šè¿‡è¿™äº›æ“ä½œå¯ä»¥ä¿æŒå¤šé“ç¨‹åºçš„å¹¶å‘åº¦è¾ƒé«˜ã€‚  
**ç¼ºç‚¹ï¼š**ä½¿ç”¨å¯å˜åˆ†é…å±€éƒ¨ç½®æ¢æ—¶ï¼Œæ¯ä¸ªè¿›ç¨‹ä¼šè¢«åˆ†é…ä¸€ä¸ªå¯å˜å¤§å°çš„é¡µé¢å—ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸­å‡ºç°è®¸å¤šä¸åŒå¤§å°çš„ç©ºé—²å—ï¼Œä»è€Œå¢åŠ å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚è¿™äº›ç¢ç‰‡å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ç©ºé—´ä¸è¿ç»­ï¼Œä½¿å¾—æ— æ³•ä¸ºè¾ƒå¤§çš„è¿›ç¨‹åˆ†é…è¶³å¤Ÿçš„å†…å­˜ã€‚  

##### å¯å˜åˆ†é…å…¨å±€ç½®æ¢

**æ¦‚å¿µ**ï¼šç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€å®šæ•°é‡çš„å†…å­˜å—ï¼ˆç‰©ç†å—ï¼‰ã€‚æ“ä½œç³»ç»Ÿè¿˜ä¼šä¿æŒä¸€ä¸ªç©ºé—²ç‰©ç†å—çš„é˜Ÿåˆ—ã€‚è‹¥æŸè¿›ç¨‹å‘ç”Ÿç¼ºé¡µï¼Œå¯ä»¥ä»ç©ºé—²ç‰©ç†å—ä¸­å–å‡ºä¸€å—åˆ†é…ç»™è¯¥è¿›ç¨‹ã€‚å¦‚æœç©ºé—²ç‰©ç†å—æ²¡æœ‰äº†ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©ä¸€ä¸ªæœªé”å®šï¼ˆä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼‰çš„é¡µé¢æ¢å‡ºåˆ°å¤–å­˜ï¼Œå†å°†ç‰©ç†å—åˆ†é…ç»™ç¼ºé¡µçš„è¿›ç¨‹ã€‚  
**ç¼ºç‚¹**ï¼šåœ¨ç©ºé—²ç‰©ç†å—æ²¡æœ‰çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå°†å…¶ä»–è¿›ç¨‹çš„é¡µé¢è°ƒå‡ºåˆ°å¤–å­˜ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿›ç¨‹å°±ä¼šæ‹¥æœ‰è¾ƒå°çš„é©»ç•™é›†ï¼Œå¦‚æ­¤ä¼šå¯¼è‡´è¯¥è¿›ç¨‹çš„ç¼ºé¡µç‡ä¸Šå‡  
çœ‹åˆ°è¿™ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰å›ºå®šåˆ†é…å…¨å±€ç½®æ¢å‘¢ï¼Ÿ  
å¦‚æœç†è§£ä¸Šé¢çš„åˆ†é…å’Œç½®æ¢ï¼Œé‚£åº”è¯¥å¾ˆå®¹æ˜“æ˜ç™½ï¼Œ**è¿™ç§æƒ…å†µä¸‹ï¼Œå›ºå®šå’Œå…¨å±€æœ¬èº«å°±æ˜¯çŸ›ç›¾çš„ï¼Œä¸å¯èƒ½åœ¨å›ºå®šçš„æƒ…å†µä¸‹ï¼Œè¿˜è¿›è¡Œå…¨å±€çš„ç½®æ¢ï¼Œå› ä¸ºå…¨å±€çš„ç½®æ¢ä¼šåˆ†é…å…¶ä»–çš„ç©ºé—²ç‰©ç†å—ã€‚**  

#### é¡µé¢è°ƒåº¦æ—¶æœº

é¢„è°ƒé¡µç­–ç•¥ï¼šåŸºäºå±€éƒ¨æ€§åŸç†ï¼Œä¸€æ¬¡è°ƒå…¥è‹¥å¹²ä¸ªç›¸é‚»é¡µé¢å¯èƒ½æ¯”ä¸€æ¬¡è°ƒå…¥ä¸€ä¸ªé¡µé¢æ›´é«˜æ•ˆã€‚  
ç¼ºç‚¹ï¼šå¦‚æœè°ƒå…¥çš„è‹¥å¹²é¡µé¢æ˜¯ä¸ä¼šè¢«é©¬ä¸Šè®¿é—®çš„ï¼Œé‚£ä¹ˆè¿™æ ·æ•ˆç‡åˆä¼šå¾ˆä½ã€‚  
è¯·æ±‚è°ƒé¡µç­–ç•¥ï¼šåªæœ‰åœ¨è¿›ç¨‹å¤„äºè¿è¡ŒæœŸï¼Œä¸”å‘ç”Ÿç¼ºé¡µçš„æ—¶å€™æ‰è¢«è°ƒå…¥å†…å­˜ã€‚  
ç¼ºç‚¹ï¼šç¼ºé¡µæ—¶æ¯æ¬¡åªä¼šè°ƒå…¥ä¸€é¡µï¼Œæ¯æ¬¡ä»å¤–å­˜åˆ°å†…å­˜çš„è°ƒå…¥éƒ½ä¼šè¿›è¡ŒI/Oæ“ä½œï¼Œå› æ­¤I/Oå¼€é”€è¾ƒå¤§ã€‚  

#### é¡µé¢ç½®æ¢ç®—æ³•

è¿™ä¸ªéƒ¨åˆ†çš„å†…å®¹æš‚ä¸”å°±å…ˆç®€ç•¥çš„ä»‹ç»ä¸€ä¸‹ï¼Œå› ä¸ºæ„Ÿè§‰ç†è®ºåŸºæœ¬éƒ½å¾ˆå®¹æ˜“çœ‹æ˜ç™½ã€‚  
OPTæ˜¯æœ€å¥½çš„é¡µé¢ç½®æ¢ç®—æ³•ï¼Œæ‰€æœ‰çš„ç½®æ¢ç®—æ³•éƒ½æ˜¯ä¸ºäº†æ¥è¿‘å®ƒçš„æ€§èƒ½è€Œè¿›è¡Œä¼˜åŒ–ã€‚

1.  æœ€ä½³ï¼ˆOPTï¼ŒOptimalï¼‰ï¼š è¿™æ˜¯ä¸€ç§ç†è®ºä¸Šçš„ç½®æ¢ç­–ç•¥ï¼Œå®ƒæ€»æ˜¯é€‰æ‹©æœªæ¥æœ€é•¿æ—¶é—´å†…ä¸ä¼šè¢«è®¿é—®çš„é¡µé¢è¿›è¡Œç½®æ¢ã€‚è™½ç„¶ OPT ç®—æ³•å¯ä»¥è·å¾—æœ€å°çš„ç¼ºé¡µæ¬¡æ•°ï¼Œä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸‹ï¼Œæ— æ³•é¢„çŸ¥æœªæ¥çš„è®¿é—®æ¨¡å¼ï¼Œå› æ­¤å¾ˆéš¾å®ç°ã€‚
2.  å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰ï¼š è¿™æ˜¯æœ€ç®€å•çš„é¡µé¢ç½®æ¢ç­–ç•¥ä¹‹ä¸€ã€‚å®ƒæ€»æ˜¯é€‰æ‹©æœ€æ—©è¿›å…¥ç‰©ç†å†…å­˜çš„é¡µé¢è¿›è¡Œç½®æ¢ã€‚ç„¶è€Œï¼ŒFIFO ç®—æ³•å¯èƒ½ä¼šå¯¼è‡´ "Belady's Anomaly"ï¼Œå³å¢åŠ é¡µé¢æ•°æ—¶ï¼Œç¼ºé¡µæ¬¡æ•°åè€Œå¢åŠ ã€‚
3.  æœ€è¿‘æœªä½¿ç”¨ï¼ˆLRUï¼ŒLeast Recently Usedï¼‰ï¼š è¿™ä¸ªç­–ç•¥é€‰æ‹©æœ€é•¿æ—¶é—´æœªè¢«ä½¿ç”¨çš„é¡µé¢è¿›è¡Œç½®æ¢ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šå°†æœ€è¿‘æœ€å°‘è¢«è®¿é—®çš„é¡µé¢æ¢å‡ºã€‚LRU ç®—æ³•å¯ä»¥æœ‰æ•ˆåœ°å‡å°‘ç¼ºé¡µæ¬¡æ•°ï¼Œä½†å®ç°èµ·æ¥è¾ƒä¸ºå¤æ‚ï¼Œå¯èƒ½éœ€è¦è¾ƒå¤§çš„å¼€é”€æ¥ç»´æŠ¤é¡µé¢çš„è®¿é—®å†å²ã€‚
4.  æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆLFUï¼ŒLeast Frequently Usedï¼‰ï¼š è¿™ä¸ªç­–ç•¥é€‰æ‹©åœ¨ä¸€æ®µæ—¶é—´å†…è¢«è®¿é—®æ¬¡æ•°æœ€å°‘çš„é¡µé¢è¿›è¡Œç½®æ¢ã€‚LFU ç®—æ³•è€ƒè™‘äº†é¡µé¢çš„ä½¿ç”¨é¢‘ç‡ï¼Œä½†åŒæ ·éœ€è¦ç»´æŠ¤è®¿é—®è®¡æ•°ï¼Œå¯èƒ½å¢åŠ å¼€é”€ã€‚
5.  æ—¶é’Ÿç½®æ¢ç®—æ³•ï¼ˆClock Replacement Algorithmï¼‰:ä¹Ÿç§°ä¸º"äºŒæ¬¡æœºä¼š"ï¼ˆSecond-Chanceï¼‰é¡µé¢ç½®æ¢ç®—æ³•ï¼Œæ˜¯ä¸€ç§ç”¨äºè™šæ‹Ÿå†…å­˜ç®¡ç†çš„é¡µé¢ç½®æ¢ç­–ç•¥ã€‚å®ƒæ˜¯åŸºäºè¿‘ä¼¼æœ€è¿‘æœªä½¿ç”¨ï¼ˆLRUï¼‰ç®—æ³•çš„ä¸€ç§æ”¹è¿›ï¼Œæ—¨åœ¨é™ä½å®ç°å¤æ‚åº¦ï¼ŒåŒæ—¶åœ¨æŸç§ç¨‹åº¦ä¸Šæ¨¡æ‹ŸLRUçš„æ•ˆæœã€‚  
    

#### é¡µé¢ç¼“å†²æ€æƒ³

é¡µé¢ç¼“å†²æ€æƒ³ï¼ˆPage Bufferingï¼‰æ˜¯æŒ‡åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œé€šè¿‡ç¼“å­˜ï¼ˆç¼“å†²ï¼‰é¡µé¢æ•°æ®æ¥ä¼˜åŒ–æ•°æ®è®¿é—®å’Œç®¡ç†çš„ç­–ç•¥ã€‚è¿™ç§æ€æƒ³é€šå¸¸åº”ç”¨äºç£ç›˜å’Œæ–‡ä»¶ç³»ç»Ÿç­‰å­˜å‚¨ç³»ç»Ÿï¼Œæ—¨åœ¨å‡å°‘æ•°æ®è¯»å–å’Œå†™å…¥çš„å»¶è¿Ÿï¼Œæé«˜æ•°æ®è®¿é—®é€Ÿåº¦å’Œæ•ˆç‡ã€‚  
é¡µé¢ç¼“å†²çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†æœ€å¸¸ç”¨çš„æ•°æ®é¡µï¼ˆæˆ–æ•°æ®å—ï¼‰æš‚æ—¶å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶èƒ½å¤Ÿæ›´å¿«åœ°è®¿é—®ã€‚å…·ä½“æ¥è¯´ï¼Œå½“åº”ç”¨ç¨‹åºéœ€è¦ä»ç£ç›˜è¯»å–æ•°æ®æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆæ£€æŸ¥ç¼“å†²åŒºä¸­æ˜¯å¦å·²ç»å­˜åœ¨æ‰€éœ€çš„æ•°æ®é¡µã€‚å¦‚æœæ•°æ®é¡µå·²ç»åœ¨ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­è¯»å–ï¼Œé¿å…äº†æ…¢é€Ÿçš„ç£ç›˜è®¿é—®ã€‚å¦‚æœæ•°æ®é¡µä¸åœ¨ç¼“å†²åŒºä¸­ï¼Œç³»ç»Ÿä¼šå°†å®ƒä»ç£ç›˜è¯»å–åˆ°ç¼“å†²åŒºï¼Œå¹¶ä¸”å¯èƒ½è¿˜ä¼šæ›¿æ¢æ‰ç¼“å†²åŒºä¸­çš„å…¶ä»–æ•°æ®é¡µã€‚  
é¡µé¢ç¼“å†²çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š

1.  åŠ é€Ÿæ•°æ®è®¿é—®ï¼š ç¼“å†²æ•°æ®å¯ä»¥æ˜¾è‘—åŠ å¿«æ•°æ®çš„è¯»å–é€Ÿåº¦ï¼Œå› ä¸ºå†…å­˜çš„è®¿é—®é€Ÿåº¦æ¯”ç£ç›˜å¿«å¾—å¤šã€‚
2.  é™ä½ç£ç›˜è®¿é—®é¢‘ç‡ï¼š ç¼“å†²æ•°æ®å¯ä»¥å‡å°‘å¯¹ç£ç›˜çš„é¢‘ç¹è®¿é—®ï¼Œä»è€Œå‡å°‘ç£ç›˜çš„è´Ÿè½½ï¼Œå»¶é•¿ç£ç›˜å¯¿å‘½ï¼Œå¹¶æé«˜æ•´ä½“ç³»ç»Ÿæ€§èƒ½ã€‚
3.  å¹³æ»‘è®¿é—®æµé‡ï¼š ç¼“å†²æ•°æ®å¯ä»¥å¹³æ»‘åº”ç”¨ç¨‹åºå¯¹å­˜å‚¨ç³»ç»Ÿçš„è®¿é—®æµé‡ï¼Œé¿å…çªå‘æ€§çš„å¤§é‡ç£ç›˜è®¿é—®ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚
4.  ç¼“è§£æŠ–åŠ¨ï¼š é¡µé¢ç¼“å†²å¯ä»¥å‡å°‘æŠ–åŠ¨é—®é¢˜ï¼Œå³å‡å°‘é¢‘ç¹çš„é¡µé¢ç½®æ¢ï¼Œä»è€Œé¿å…ç³»ç»Ÿæ€§èƒ½ä¸‹é™ã€‚

ç„¶è€Œï¼Œé¡µé¢ç¼“å†²ä¹Ÿå¯èƒ½å¸¦æ¥ä¸€äº›æŒ‘æˆ˜ï¼Œå¦‚ï¼š

1.  å†…å­˜ç®¡ç†ï¼š é¡µé¢ç¼“å†²éœ€è¦å ç”¨ä¸€éƒ¨åˆ†å†…å­˜ç©ºé—´ï¼Œå› æ­¤éœ€è¦åˆç†ç®¡ç†å†…å­˜èµ„æºï¼Œé¿å…å†…å­˜ä¸è¶³å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
2.  ç¼“å†²å‘½ä¸­ç‡ï¼š ç¼“å†²å‘½ä¸­ç‡æŒ‡ç¼“å†²åŒºä¸­å·²ç¼“å­˜çš„æ•°æ®åœ¨æ€»çš„æ•°æ®è®¿é—®ä¸­çš„æ¯”ä¾‹ã€‚ç¼“å†²å‘½ä¸­ç‡è¶Šé«˜ï¼Œæ€§èƒ½æå‡è¶Šæ˜æ˜¾ã€‚ä½†å¦‚æœç¼“å†²å‘½ä¸­ç‡å¾ˆä½ï¼Œåˆ™å¯èƒ½å¸¦æ¥é¢å¤–çš„å¼€é”€ã€‚
3.  ä¸€è‡´æ€§ï¼š ç¼“å†²æ•°æ®ä¸ç£ç›˜ä¸Šçš„æ•°æ®ä¹‹é—´éœ€è¦ä¿æŒä¸€è‡´æ€§ï¼Œå› æ­¤éœ€è¦é€‚å½“çš„ç¼“å†²ç®¡ç†æœºåˆ¶ï¼Œä»¥ç¡®ä¿æ•°æ®çš„æ­£ç¡®æ€§ã€‚  
    

TCMalloc
--------

TCMallocï¼ˆThread Cache Mallocï¼‰ã€‚Golang çš„å†…å­˜ç®¡ç†å°±æ˜¯åŸºäº TCMalloc çš„æ ¸å¿ƒæ€æƒ³æ¥æ„å»ºçš„ã€‚æœ¬èŠ‚å°†ä»‹ç» TCMalloc çš„åŸºç¡€ç†å¿µå’Œç»“æ„ã€‚  

### åŸºç¡€æ•°æ®ç»“æ„

#### Page

TCMalloc ä¸­çš„ Page ä¸ä¹‹å‰ç« èŠ‚ä»‹ç»æ“ä½œç³»ç»Ÿå¯¹è™šæ‹Ÿå†…å­˜ç®¡ç†çš„ MMU å®šä¹‰çš„ç‰©ç†é¡µæœ‰ç›¸ä¼¼çš„å®šä¹‰ï¼ŒTCMalloc å°†è™šæ‹Ÿå†…å­˜ç©ºé—´åˆ’åˆ†ä¸ºå¤šä»½åŒç­‰å¤§å°çš„ Pageï¼Œæ¯ä¸ª Page é»˜è®¤æ˜¯ 8KBã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690461397085-c5572c23-0412-4f27-b97b-8df35f5fcc52.png#averageHue=%23f8f8f8&clientId=u116305bf-1b21-4&from=paste&id=u752e68c3&originHeight=562&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=udd7d1d5b-1072-45a2-b959-d6b36b23a92&title=)  
å°† Page è¿›è¡Œç¼–å·çš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥æ ¹æ®ä»»æ„å†…å­˜çš„åœ°å€æŒ‡é’ˆï¼Œè¿›è¡Œå›ºå®šç®—æ³•åç§»è®¡ç®—æ¥ç®—å‡ºæ‰€åœ¨çš„ Pageã€‚

#### Span

å¤šä¸ªè¿ç»­çš„ Page ç§°ä¹‹ä¸ºæ˜¯ä¸€ä¸ª Spanï¼Œå…¶å®šä¹‰å«ä¹‰æœ‰æ“ä½œç³»ç»Ÿçš„ç®¡ç†çš„é¡µè¡¨ç›¸ä¼¼ï¼ŒPage å’Œ Span çš„å…³ç³»å¦‚å›¾æ‰€ç¤ºã€‚

![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690461430389-b42720a0-8035-4ff1-a29e-a6fe887be75c.png#averageHue=%23f7f3ed&clientId=u116305bf-1b21-4&from=paste&id=ua28dba17&originHeight=660&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=ubb29d500-b2d4-4c7b-a371-9dc43cb3625&title=)  
TCMalloc æ˜¯ä»¥ Span ä¸ºå•ä½å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„ã€‚æ¯ä¸ª Span è®°å½•äº†ç¬¬ä¸€ä¸ªèµ·å§‹ Page çš„ç¼–å· Startï¼Œå’Œä¸€å…±æœ‰å¤šå°‘ä¸ªè¿ç»­ Page çš„æ•°é‡ Lengthã€‚  

#### Size Class

åœ¨ 256KB ä»¥å†…çš„å°å¯¹è±¡ï¼ŒTCMalloc ä¼šå°†è¿™äº›å°å¯¹è±¡é›†åˆåˆ’åˆ†æˆå¤šä¸ªå†…å­˜åˆ»åº¦ \[6\]ï¼ŒåŒå±äºä¸€ä¸ªåˆ»åº¦ç±»åˆ«ä¸‹çš„å†…å­˜é›†åˆç§°ä¹‹ä¸ºå±äºä¸€ä¸ª Size Classã€‚è¿™ä¸ä¹‹å‰ç« èŠ‚è‡ªå®šä¹‰å®ç°çš„å†…å­˜æ± ï¼Œå°† Buf åˆ’åˆ†å¤šä¸ªåˆ»åº¦çš„ BufList ç±»ä¼¼ã€‚  
æ¯ä¸ª Size Class éƒ½å¯¹åº”ä¸€ä¸ªå¤§å°æ¯”å¦‚ 8 å­—èŠ‚ã€16 å­—èŠ‚ã€32 å­—èŠ‚ç­‰ã€‚åœ¨ç”³è¯·å°å¯¹è±¡å†…å­˜çš„æ—¶å€™ï¼ŒTCMalloc ä¼šæ ¹æ®ä½¿ç”¨æ–¹ç”³è¯·çš„ç©ºé—´å¤§å°å°±è¿‘å‘ä¸Šå–æœ€æ¥è¿‘çš„ä¸€ä¸ª Size Class çš„ Spanï¼ˆç”±å¤šä¸ªç­‰ç©ºé—´çš„ Page ç»„æˆï¼‰å†…å­˜å—è¿”å›ç»™ä½¿ç”¨æ–¹ã€‚  
ï¼ˆè¿™å›¾æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Ÿæˆ‘æ„Ÿè§‰åº”è¯¥æ˜¯KBè€Œä¸æ˜¯Bï¼‰  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690461515232-af4c2dd2-44f8-4223-833d-002bffdb0472.png#averageHue=%23f5f5f5&clientId=u116305bf-1b21-4&from=paste&id=u2b8d16f0&originHeight=1151&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=ua7e2fe08-0385-4847-a26c-dc3459e38a0&title=)  

### ThreadCache

åœ¨ TCMalloc ä¸­æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä»½å•ç‹¬çš„ç¼“å­˜ï¼Œå°±æ˜¯ ThreadCacheã€‚ThreadCache ä¸­å¯¹äºæ¯ä¸ª Size Class éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ FreeListï¼ŒFreeList è¡¨ç¤ºå½“å‰ç¼“å­˜ä¸­è¿˜æœ‰å¤šå°‘ä¸ªç©ºé—²çš„å†…å­˜å¯ç”¨ï¼Œå…·ä½“çš„ç»“æ„å¸ƒå±€å¦‚å›¾ 25 æ‰€ç¤ºã€‚

![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690461701012-0a5ab170-2926-4328-8065-4ab9f1d1af77.png#averageHue=%23685634&clientId=u116305bf-1b21-4&from=paste&id=u9ee74a7e&originHeight=975&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=u3ef03cb3-a830-4811-8a9e-d7471271718&title=)  
ä½¿ç”¨æ–¹å¯¹äºä» TCMalloc ç”³è¯·çš„å°å¯¹è±¡ï¼Œä¼šç›´æ¥ä» TreadCache è·å–ï¼Œå®åˆ™æ˜¯ä» FreeList ä¸­è¿”å›ä¸€ä¸ªç©ºé—²çš„å¯¹è±¡ï¼Œå¦‚æœå¯¹åº”çš„ Size Class åˆ»åº¦ä¸‹å·²ç»æ²¡æœ‰ç©ºé—²çš„ Span å¯ä»¥è¢«è·å–äº†ï¼Œåˆ™ ThreadCache ä¼šä» CentralCache ä¸­è·å–ã€‚å½“ä½¿ç”¨æ–¹ä½¿ç”¨å®Œå†…å­˜ä¹‹åï¼Œå½’è¿˜ä¹Ÿæ˜¯ç›´æ¥å½’è¿˜ç»™å½“å‰çš„ ThreadCache ä¸­å¯¹åº”åˆ»åº¦ä¸‹çš„çš„ FreeList ä¸­ã€‚  
æ•´æ¡ç”³è¯·å’Œå½’è¿˜çš„æµç¨‹æ˜¯ä¸éœ€è¦åŠ é”çš„ï¼Œå› ä¸º ThreadCache ä¸ºå½“å‰çº¿ç¨‹ç‹¬äº«ï¼Œä½†å¦‚æœ ThreadCache ä¸å¤Ÿç”¨ï¼Œéœ€è¦ä» CentralCache ç”³è¯·å†…å­˜æ—¶ï¼Œè¿™ä¸ªåŠ¨ä½œæ˜¯éœ€è¦åŠ é”çš„ï¼Œå› ä¸ºCentralCacheæ˜¯ä¸€ä¸ªå…¨å±€çš„å¯¹è±¡ã€‚ä¸åŒ Thread ä¹‹é—´çš„ ThreadCache æ˜¯ä»¥åŒå‘é“¾è¡¨çš„ç»“æ„è¿›è¡Œå…³è”ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿ TCMalloc ç»Ÿè®¡å’Œç®¡ç†ã€‚  

### CentralCache

CentralCache æ˜¯å„ä¸ªçº¿ç¨‹å…±ç”¨çš„ï¼Œæ‰€ä»¥ä¸ CentralCache è·å–å†…å­˜äº¤äº’æ˜¯éœ€è¦åŠ é”çš„ã€‚CentralCache ç¼“å­˜çš„ Size Class å’Œ ThreadCache çš„ä¸€æ ·ï¼Œè¿™äº›ç¼“å­˜éƒ½è¢«æ”¾åœ¨ CentralFreeList ä¸­ï¼Œå½“ ThreadCache ä¸­çš„æŸä¸ª Size Class åˆ»åº¦ä¸‹çš„ç¼“å­˜å°å¯¹è±¡ä¸å¤Ÿç”¨ï¼Œå°±ä¼šå‘ CentralCache å¯¹åº”çš„ Size Class åˆ»åº¦çš„ CentralFreeList è·å–ï¼ŒåŒæ ·çš„å¦‚æœ ThreadCache æœ‰å¤šä½™çš„ç¼“å­˜å¯¹è±¡ä¹Ÿä¼šé€€è¿˜ç»™å“åº”çš„ CentralFreeListï¼Œæµç¨‹å’Œå…³ç³»å¦‚å›¾  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690461917878-f6183b6b-7139-48f3-b0a3-4e3cda23417b.png#averageHue=%23f8c66b&clientId=u116305bf-1b21-4&from=paste&id=uccf5cc69&originHeight=979&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=u71bf584e-567e-4c12-867f-995f06f199d&title=)  
CentralCache ä¸ PageHeap çš„è§’è‰²å…³ç³»ä¸ ThreadCache ä¸ CentralCache çš„è§’è‰²å…³ç³»ç›¸ä¼¼ï¼Œå½“ CentralCache å‡ºç° Span ä¸è¶³æ—¶ï¼Œä¼šä» PageHeap ç”³è¯· Spanï¼Œä»¥åŠå°†ä¸å†ä½¿ç”¨çš„ Span é€€è¿˜ç»™ PageHeapã€‚  

### PageHeap

PageHeap æ˜¯æä¾› CentralCache çš„å†…å­˜æ¥æºã€‚PageHead ä¸ CentralCache ä¸åŒçš„æ˜¯ CentralCache æ˜¯ä¸ ThreadCache å¸ƒå±€ä¸€æ¨¡ä¸€æ ·çš„ç¼“å­˜ï¼Œä¸»è¦æ˜¯èµ·åˆ°é’ˆå¯¹ ThreadCache çš„ä¸€å±‚äºŒçº§ç¼“å­˜ä½œç”¨ï¼Œä¸”åªæ”¯æŒå°å¯¹è±¡å†…å­˜åˆ†é…ã€‚è€Œ PageHeap åˆ™æ˜¯é’ˆå¯¹ CentralCache çš„ä¸‰çº§ç¼“å­˜ã€‚å¼¥è¡¥å¯¹äºä¸­å¯¹è±¡å†…å­˜å’Œå¤§å¯¹è±¡å†…å­˜çš„åˆ†é…ï¼ŒPageHeap ä¹Ÿæ˜¯ç›´æ¥å’Œæ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜è¡”æ¥çš„ä¸€å±‚ç¼“å­˜ï¼Œå½“æ‰¾ä¸åˆ° ThreadCacheã€CentralCacheã€PageHeap éƒ½æ‰¾ä¸åˆ°åˆé€‚çš„ Spanï¼ŒPageHeap åˆ™ä¼šè°ƒç”¨æ“ä½œç³»ç»Ÿå†…å­˜ç”³è¯·ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ¥ä»è™šæ‹Ÿå†…å­˜çš„å †åŒºä¸­å–å‡ºå†…å­˜å¡«å……åˆ° PageHeap å½“ä¸­ï¼Œå…·ä½“çš„ç»“æ„å¦‚å›¾ 27 æ‰€ç¤ºã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690462293470-23132124-d7b6-4d31-b4c7-da5c19f676c1.png#averageHue=%23a6aaa9&clientId=u0b733760-139f-4&from=paste&id=uc625cc27&originHeight=948&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=uf15c5033-f7d3-4cdc-bedc-7e03ed8a9f9&title=)  
PageHeap å†…éƒ¨çš„ Span ç®¡ç†ï¼Œé‡‡ç”¨ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼Œå¯¹äº 128 ä¸ª Page ä»¥å†…çš„ Span ç”³è¯·ï¼Œæ¯ä¸ª Page åˆ»åº¦éƒ½ä¼šç”¨ä¸€ä¸ªé“¾è¡¨å½¢å¼çš„ç¼“å­˜æ¥å­˜å‚¨ã€‚å¯¹äº 128 ä¸ª Page ä»¥ä¸Šå†…å­˜ç”³è¯·ï¼ŒPageHeap æ˜¯ä»¥æœ‰åºé›†åˆï¼ˆC++ æ ‡å‡†åº“ STL ä¸­çš„ Std::Set å®¹å™¨ï¼‰æ¥å­˜æ”¾ã€‚

### TCMallocçš„å°å¯¹è±¡åˆ†é…

![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690727946531-bb64f763-c6da-40e5-b2c0-311ea959e4b3.png#averageHue=%23fae28e&clientId=udacbeb45-45da-4&from=paste&id=u9c690274&originHeight=1175&originWidth=1680&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u10c5a831-6080-486b-a2b2-cc0f3cf91b1&title=)  
å°å¯¹è±¡ä¸ºå ç”¨å†…å­˜å°äºç­‰äº 256KB çš„å†…å­˜ï¼Œå‚è€ƒå›¾ä¸­çš„æµç¨‹ï¼Œä¸‹é¢å°†ä»‹ç»è¯¦ç»†æµç¨‹æ­¥éª¤ï¼š

ï¼ˆ1ï¼‰Thread ç”¨æˆ·çº¿ç¨‹åº”ç”¨é€»è¾‘ç”³è¯·å†…å­˜ï¼Œå½“å‰ Thread è®¿é—®å¯¹åº”çš„ ThreadCache è·å–å†…å­˜ï¼Œæ­¤è¿‡ç¨‹ä¸éœ€è¦åŠ é”ã€‚  
ï¼ˆ2ï¼‰ThreadCache çš„å¾—åˆ°ç”³è¯·å†…å­˜çš„ SizeClassï¼ˆä¸€èˆ¬å‘ä¸Šå–æ•´ï¼Œå¤§äºç­‰äºç”³è¯·çš„å†…å­˜å¤§å°ï¼‰ï¼Œé€šè¿‡ SizeClass ç´¢å¼•å»è¯·æ±‚è‡ªèº«å¯¹åº”çš„ FreeListã€‚  
ï¼ˆ3ï¼‰åˆ¤æ–­å¾—åˆ°çš„ FreeList æ˜¯å¦ä¸ºéç©ºã€‚  
ï¼ˆ4ï¼‰å¦‚æœ FreeList éç©ºï¼Œåˆ™è¡¨ç¤ºç›®å‰æœ‰å¯¹åº”å†…å­˜ç©ºé—´ä¾› Thread ä½¿ç”¨ï¼Œå¾—åˆ° FreeList ç¬¬ä¸€ä¸ªç©ºé—² Span è¿”å›ç»™ Thread ç”¨æˆ·é€»è¾‘ï¼Œæµç¨‹ç»“æŸã€‚  
ï¼ˆ5ï¼‰å¦‚æœ FreeList ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºç›®å‰æ²¡æœ‰å¯¹åº” SizeClass çš„ç©ºé—² Span å¯ä½¿ç”¨ï¼Œè¯·æ±‚ CentralCache å¹¶å‘ŠçŸ¥ CentralCache å…·ä½“çš„ SizeClassã€‚  
ï¼ˆ6ï¼‰CentralCache æ”¶åˆ°è¯·æ±‚åï¼ŒåŠ é”è®¿é—® CentralFreeListï¼Œæ ¹æ® SizeClass è¿›è¡Œç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„ CentralFreeListã€‚  
ï¼ˆ7ï¼‰åˆ¤æ–­å¾—åˆ°çš„ CentralFreeList æ˜¯å¦ä¸ºéç©ºã€‚  
ï¼ˆ8ï¼‰å¦‚æœ CentralFreeList éç©ºï¼Œåˆ™è¡¨ç¤ºç›®å‰æœ‰ç©ºé—²çš„ Span å¯ä½¿ç”¨ã€‚è¿”å›å¤šä¸ª Spanï¼Œå°†è¿™äº› Spanï¼ˆé™¤äº†ç¬¬ä¸€ä¸ª Spanï¼‰æ”¾ç½® ThreadCache çš„ FreeList ä¸­ï¼Œå¹¶ä¸”å°†ç¬¬ä¸€ä¸ª Span è¿”å›ç»™ Thread ç”¨æˆ·é€»è¾‘ï¼Œæµç¨‹ç»“æŸã€‚  
ï¼ˆ9ï¼‰å¦‚æœ CentralFreeList ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºç›®å‰æ²¡æœ‰å¯ç”¨æ˜¯ Span å¯ä½¿ç”¨ï¼Œå‘ PageHeap ç”³è¯·å¯¹åº”å¤§å°çš„ Spanã€‚  
ï¼ˆ10ï¼‰PageHeap å¾—åˆ° CentralCache çš„ç”³è¯·ï¼ŒåŠ é”è¯·æ±‚å¯¹åº”çš„ Page åˆ»åº¦çš„ Span é“¾è¡¨ã€‚  
ï¼ˆ11ï¼‰PageHeap å°†å¾—åˆ°çš„ Span æ ¹æ®æœ¬æ¬¡æµç¨‹è¯·æ±‚çš„ SizeClass å¤§å°ä¸ºåˆ»åº¦è¿›è¡Œæ‹†åˆ†ï¼Œåˆ†æˆ N ä»½ SizeClass å¤§å°çš„ Span è¿”å›ç»™ CentralCacheï¼Œå¦‚æœæœ‰å¤šä½™çš„ Span åˆ™æ”¾å› PageHeap å¯¹åº” Page çš„ Span é“¾è¡¨ä¸­ã€‚  
ï¼ˆ12ï¼‰CentralCache å¾—åˆ°å¯¹åº”çš„ N ä¸ª Spanï¼Œæ·»åŠ è‡³ CentralFreeList ä¸­ï¼Œè·³è½¬è‡³ç¬¬ï¼ˆ8ï¼‰æ­¥ã€‚  
ç»¼ä¸Šæ˜¯ TCMalloc ä¸€æ¬¡ç”³è¯·å°å¯¹è±¡çš„å…¨éƒ¨è¯¦ç»†æµç¨‹ï¼Œæ¥ä¸‹æ¥åˆ†æä¸­å¯¹è±¡çš„åˆ†é…æµç¨‹ã€‚  

### TCMallocçš„ä¸­å¯¹è±¡åˆ†é…

ä¸­å¯¹è±¡ä¸ºå¤§äº 256KB ä¸”å°äºç­‰äº 1MB çš„å†…å­˜ã€‚å¯¹äºä¸­å¯¹è±¡ç”³è¯·åˆ†é…çš„æµç¨‹ TCMalloc ä¸å¤„ç†å°å¯¹è±¡åˆ†é…æœ‰ä¸€å®šçš„åŒºåˆ«ã€‚å¯¹äºä¸­å¯¹è±¡åˆ†é…ï¼ŒThread ä¸å†æŒ‰ç…§å°å¯¹è±¡çš„æµç¨‹è·¯å¾„å‘ ThreadCache è·å–ï¼Œè€Œæ˜¯ç›´æ¥ä» PageHeap è·å–  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690728393147-31135c42-6676-4cc2-980e-34a43db9eea9.png#averageHue=%239fa3a2&clientId=udacbeb45-45da-4&from=paste&id=ua96f5167&originHeight=1342&originWidth=1680&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u6594677d-c346-47a4-aa1f-b22b94f2d09&title=)  
PageHeap å°† 128 ä¸ª Page ä»¥å†…å¤§å°çš„ Span å®šä¹‰ä¸ºå° Spanï¼Œå°† 128 ä¸ª Page ä»¥ä¸Šå¤§å°çš„ Span å®šä¹‰ä¸ºå¤§ Spanã€‚ç”±äºä¸€ä¸ª Page ä¸º 8KBï¼Œé‚£ä¹ˆ 128 ä¸ª Page å³ä¸º 1MBï¼Œæ‰€ä»¥å¯¹äºä¸­å¯¹è±¡çš„ç”³è¯·ï¼ŒPageHeap å‡æ˜¯æŒ‰ç…§å° Span çš„ç”³è¯·æµç¨‹ï¼Œå…·ä½“å¦‚ä¸‹ï¼š  
ï¼ˆ1ï¼‰Thread ç”¨æˆ·é€»è¾‘å±‚æäº¤å†…å­˜ç”³è¯·å¤„ç†ï¼Œå¦‚æœæœ¬æ¬¡ç”³è¯·å†…å­˜è¶…è¿‡ 256KB ä½†ä¸è¶…è¿‡ 1MB åˆ™å±äºä¸­å¯¹è±¡ç”³è¯·ã€‚TCMalloc å°†ç›´æ¥å‘ PageHeap å‘èµ·ç”³è¯· Span è¯·æ±‚ã€‚  
ï¼ˆ2ï¼‰PageHeap æ¥æ”¶åˆ°ç”³è¯·åéœ€è¦åˆ¤æ–­æœ¬æ¬¡ç”³è¯·æ˜¯å¦å±äºå° Spanï¼ˆ128 ä¸ª Page ä»¥å†…ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™èµ°å° Spanï¼Œå³ä¸­å¯¹è±¡ç”³è¯·æµç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¿›å…¥å¤§å¯¹è±¡ç”³è¯·æµç¨‹ã€‚  
ï¼ˆ3ï¼‰PageHeap æ ¹æ®ç”³è¯·çš„ Span åœ¨å° Span çš„é“¾è¡¨ä¸­å‘ä¸Šå–æ•´ï¼Œå¾—åˆ°æœ€é€‚åº”çš„ç¬¬ K ä¸ª Page åˆ»åº¦çš„ Span é“¾è¡¨ã€‚  
ï¼ˆ4ï¼‰å¾—åˆ°ç¬¬ K ä¸ª Page é“¾è¡¨åˆ»åº¦åï¼Œå°† K ä½œä¸ºèµ·å§‹ç‚¹ï¼Œå‘ä¸‹éå†æ‰¾åˆ°ç¬¬ä¸€ä¸ªéç©ºé“¾è¡¨ï¼Œç›´è‡³ 128 ä¸ª Page åˆ»åº¦ä½ç½®ï¼Œæ‰¾åˆ°åˆ™åœæ­¢ï¼Œå°†åœæ­¢å¤„çš„éç©º Span é“¾è¡¨ä½œä¸ºæä¾›æ­¤æ¬¡è¿”å›çš„å†…å­˜ Spanï¼Œå°†é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª Span å–å‡ºã€‚å¦‚æœæ‰¾ä¸åˆ°éç©ºé“¾è¡¨ï¼Œåˆ™å½“é”™æœ¬æ¬¡ç”³è¯·ä¸ºå¤§ Span ç”³è¯·ï¼Œåˆ™è¿›å…¥å¤§å¯¹è±¡ç”³è¯·æµç¨‹ã€‚  
ï¼ˆ5ï¼‰å‡è®¾æœ¬æ¬¡è·å–åˆ°çš„ Span ç”± N ä¸ª Page ç»„æˆã€‚PageHeap å°† N ä¸ª Page çš„ Span æ‹†åˆ†æˆä¸¤ä¸ª Spanï¼Œå…¶ä¸­ä¸€ä¸ªä¸º K ä¸ª Page ç»„æˆçš„ Spanï¼Œä½œä¸ºæœ¬æ¬¡å†…å­˜ç”³è¯·çš„è¿”å›ï¼Œç»™åˆ° Threadï¼Œå¦ä¸€ä¸ªä¸º N-K ä¸ª Page ç»„æˆçš„ Spanï¼Œé‡æ–°æ’å…¥åˆ° N-K ä¸ª Page å¯¹åº”çš„ Span é“¾è¡¨ä¸­ã€‚  
ç»¼ä¸Šæ˜¯ TCMalloc å¯¹äºä¸­å¯¹è±¡åˆ†é…çš„è¯¦ç»†æµç¨‹ã€‚  

### TCMallocçš„å¤§å¯¹è±¡åˆ†é…

å¯¹äºè¶…è¿‡ 128 ä¸ª Pageï¼ˆå³ 1MBï¼‰çš„å†…å­˜åˆ†é…åˆ™ä¸ºå¤§å¯¹è±¡åˆ†é…æµç¨‹ã€‚å¤§å¯¹è±¡åˆ†é…ä¸ä¸­å¯¹è±¡åˆ†é…æƒ…å†µç±»ä¼¼ï¼ŒThread ç»•è¿‡ ThreadCache å’Œ CentralCacheï¼Œç›´æ¥å‘ PageHeap è·å–ã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690731882739-492e5b82-35c9-49d1-b7d5-2b206eabd741.png#averageHue=%23abc2c0&clientId=udacbeb45-45da-4&from=paste&id=u6e474348&originHeight=1168&originWidth=1680&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u97f44659-2ba2-4e1b-a35c-ce76bbf0c8a&title=)  
è¿›å…¥å¤§å¯¹è±¡åˆ†é…æµç¨‹é™¤äº†ç”³è¯·çš„ Span å¤§äº 128 ä¸ª Page ä¹‹å¤–ï¼Œå¯¹äºä¸­å¯¹è±¡åˆ†é…å¦‚æœæ‰¾ä¸åˆ°éç©ºé“¾è¡¨ä¹Ÿä¼šè¿›å…¥å¤§å¯¹è±¡åˆ†é…æµç¨‹ï¼Œå¤§å¯¹è±¡åˆ†é…çš„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š  
ï¼ˆ1ï¼‰Thread ç”¨æˆ·é€»è¾‘å±‚æäº¤å†…å­˜ç”³è¯·å¤„ç†ï¼Œå¦‚æœæœ¬æ¬¡ç”³è¯·å†…å­˜è¶…è¿‡ 1MB åˆ™å±äºå¤§å¯¹è±¡ç”³è¯·ã€‚TCMalloc å°†ç›´æ¥å‘ PageHeap å‘èµ·ç”³è¯· Span ã€‚  
ï¼ˆ2ï¼‰PageHeap æ¥æ”¶åˆ°ç”³è¯·åéœ€è¦åˆ¤æ–­æœ¬æ¬¡ç”³è¯·æ˜¯å¦å±äºå° Spanï¼ˆ128 ä¸ª Page ä»¥å†…ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™èµ°å° Span ä¸­å¯¹è±¡ç”³è¯·æµç¨‹ï¼ˆä¸Šä¸€èŠ‚å·²ä»‹ç»ï¼‰ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¿›å…¥å¤§å¯¹è±¡ç”³è¯·æµç¨‹ã€‚  
ï¼ˆ3ï¼‰PageHeap æ ¹æ® Span çš„å¤§å°æŒ‰ç…§ Page å•å…ƒè¿›è¡Œé™¤æ³•è¿ç®—ï¼Œå‘ä¸Šå–æ•´ï¼Œå¾—åˆ°æœ€æ¥è¿‘ Span çš„ä¸”å¤§äº Span çš„ Page å€æ•° Kï¼Œæ­¤æ—¶çš„ K åº”è¯¥æ˜¯å¤§äº 128ã€‚å¦‚æœæ˜¯ä»ä¸­å¯¹è±¡æµç¨‹åˆ†è¿‡æ¥çš„ï¼ˆä¸­å¯¹è±¡ç”³è¯·æµç¨‹å¯èƒ½æ²¡æœ‰éç©ºé“¾è¡¨æä¾› Spanï¼‰ï¼Œåˆ™ K å€¼åº”è¯¥å°äº 128ã€‚  
ï¼ˆ4ï¼‰æœç´¢ Large Span Set é›†åˆï¼Œæ‰¾åˆ°ä¸å°äº K ä¸ª Page çš„æœ€å° Spanï¼ˆN ä¸ª Pageï¼‰ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ Spanï¼Œåˆ™è¯´æ˜ PageHeap å·²ç»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œåˆ™å‘æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜çš„å †ç©ºé—´ç”³è¯·ä¸€å †å†…å­˜ï¼Œå°†ç”³è¯·åˆ°çš„å†…å­˜å®‰ç½®åœ¨ PageHeap çš„å†…å­˜ç»“æ„ä¸­ï¼Œé‡æ–°æ‰§è¡Œï¼ˆ3ï¼‰æ­¥éª¤ã€‚  
ï¼ˆ5ï¼‰å°†ä» Large Span Set é›†åˆå¾—åˆ°çš„ N ä¸ª Page ç»„æˆçš„ Span æ‹†åˆ†æˆä¸¤ä¸ª Spanï¼ŒK ä¸ª Page çš„ Span ç›´æ¥è¿”å›ç»™ Thread ç”¨æˆ·é€»è¾‘ï¼ŒN-K ä¸ª Span é€€è¿˜ç»™ PageHeapã€‚å…¶ä¸­å¦‚æœ N-K å¤§äº 128 åˆ™é€€è¿˜åˆ° Large Span Set é›†åˆä¸­ï¼Œå¦‚æœ N-K å°äº 128ï¼Œåˆ™é€€è¿˜åˆ° Page é“¾è¡¨ä¸­ã€‚  
ç»¼ä¸Šæ˜¯ TCMalloc å¯¹äºå¤§å¯¹è±¡åˆ†é…çš„è¯¦ç»†æµç¨‹ã€‚  

Golangå †å†…å­˜ç®¡ç†
-----------

![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690732934211-0fa021d5-5617-4a0c-8d7f-501a7cf232dc.png#averageHue=%23ccaa2c&clientId=udacbeb45-45da-4&from=paste&id=u7c924db6&originHeight=1575&originWidth=1680&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u1d685a81-19f3-4525-8a83-5998d3bc360&title=)  
Golang å†…å­˜ç®¡ç†ä¸­ä¾ç„¶ä¿ç•™ TCMalloc ä¸­çš„ Pageã€Spanã€Size Class ç­‰æ¦‚å¿µã€‚

### Page

ä¸ TCMalloc çš„ Page ä¸€è‡´ã€‚Golang å†…å­˜ç®¡ç†æ¨¡å‹å»¶ç»­äº† TCMalloc çš„æ¦‚å¿µï¼Œä¸€ä¸ª Page çš„å¤§å°ä¾ç„¶æ˜¯ 8KBã€‚Page è¡¨ç¤º Golang å†…å­˜ç®¡ç†ä¸è™šæ‹Ÿå†…å­˜äº¤äº’å†…å­˜çš„æœ€å°å•å…ƒã€‚æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜å¯¹äº Golang æ¥è¯´ï¼Œä¾ç„¶æ˜¯åˆ’åˆ†æˆç­‰åˆ†çš„ N ä¸ª Page ç»„æˆçš„ä¸€å—å¤§å†…å­˜å…¬å…±æ± ã€‚  

### mSpan

ä¸ TCMalloc ä¸­çš„ Span ä¸€è‡´ã€‚mSpan æ¦‚å¿µä¾ç„¶å»¶ç»­ TCMalloc ä¸­çš„ Span æ¦‚å¿µï¼Œåœ¨ Golang ä¸­å°† Span çš„åç§°æ”¹ä¸º mSpanï¼Œä¾ç„¶è¡¨ç¤ºä¸€ç»„è¿ç»­çš„ Pageã€‚  

### Size Class ç›¸å…³

Golang å†…å­˜ç®¡ç†é’ˆå¯¹ Size Class å¯¹è¡¡é‡å†…å­˜çš„çš„æ¦‚å¿µåˆæ›´åŠ è¯¦ç»†äº†å¾ˆå¤šï¼Œè¿™é‡Œé¢ä»‹ç»ä¸€äº›åŸºç¡€çš„æœ‰å…³å†…å­˜å¤§å°çš„åè¯åŠç®—æ³•ã€‚  
ï¼ˆ1ï¼‰Object Sizeï¼Œæ˜¯æŒ‡åç¨‹åº”ç”¨é€»è¾‘ä¸€æ¬¡å‘ Golang å†…å­˜ç”³è¯·çš„å¯¹è±¡ Object å¤§å°ã€‚Object æ˜¯ Golang å†…å­˜ç®¡ç†æ¨¡å—é’ˆå¯¹å†…å­˜ç®¡ç†æ›´åŠ ç»†åŒ–çš„å†…å­˜ç®¡ç†å•å…ƒã€‚ä¸€ä¸ª Span åœ¨åˆå§‹åŒ–æ—¶ä¼šè¢«åˆ†æˆå¤šä¸ª Objectã€‚æ¯”å¦‚ Object Size æ˜¯ 8Bï¼ˆ8 å­—èŠ‚ï¼‰å¤§å°çš„ Objectï¼Œæ‰€å±çš„ Span å¤§å°æ˜¯ 8KBï¼ˆ8192 å­—èŠ‚ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ª Span å°±ä¼šè¢«å¹³å‡åˆ†å‰²æˆ 1024ï¼ˆ8192/8=1024ï¼‰ä¸ª Objectã€‚é€»è¾‘å±‚å‘ Golang å†…å­˜æ¨¡å‹å–å†…å­˜ï¼Œå®åˆ™æ˜¯åˆ†é…ä¸€ä¸ª Object å‡ºå»ã€‚ä¸ºäº†æ›´å¥½çš„è®©è¯»è€…ç†è§£ï¼Œè¿™é‡Œå‡è®¾äº†å‡ ä¸ªæ•°æ®æ¥æ ‡è¯† Object Size å’Œ Span çš„å…³ç³»ã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690732975281-f746abc7-c495-43ac-a114-d65955ec53fb.png#averageHue=%23fcf8f3&clientId=udacbeb45-45da-4&from=paste&id=u9a5674ba&originHeight=1079&originWidth=1680&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=ubb0c0964-2197-4d98-8a51-78e9d6083fb&title=)  
ä¸Šå›¾ä¸­çš„ Num Of Object è¡¨ç¤ºå½“å‰ Span ä¸­ä¸€å…±å­˜åœ¨å¤šå°‘ä¸ª Objectã€‚  
æ³¨æ„ **Pageæ˜¯Golangå†…å­˜ç®¡ç†ä¸æ“ä½œç³»ç»Ÿäº¤äº’è¡¡é‡å†…å­˜å®¹é‡çš„åŸºæœ¬å•å…ƒ**ï¼Œ**Golang å†…å­˜ç®¡ç†å†…éƒ¨æœ¬èº«ç”¨æ¥ç»™å¯¹è±¡å­˜å‚¨å†…å­˜çš„åŸºæœ¬å•å…ƒæ˜¯ Objectã€‚**  
ï¼ˆ2ï¼‰Size Classï¼ŒGolang å†…å­˜ç®¡ç†ä¸­çš„ Size Class ä¸ TCMalloc æ‰€è¡¨ç¤ºçš„è®¾è®¡å«ä¹‰æ˜¯ä¸€è‡´çš„ï¼Œéƒ½è¡¨ç¤ºä¸€å—å†…å­˜çš„æ‰€å±è§„æ ¼æˆ–è€…åˆ»åº¦ã€‚**Golang å†…å­˜ç®¡ç†ä¸­çš„ Size Class æ˜¯é’ˆå¯¹ Object Size æ¥åˆ’åˆ†å†…å­˜çš„**ã€‚ä¹Ÿæ˜¯åˆ’åˆ† Object å¤§å°çš„çº§åˆ«ã€‚æ¯”å¦‚ Object Size åœ¨ 1Byte8Byte ä¹‹é—´çš„ Object å±äº Size Class 1 çº§åˆ«ï¼ŒObject Size åœ¨ 8B16Byte ä¹‹é—´çš„å±äº Size Class 2 çº§åˆ«ã€‚  
ï¼ˆ3ï¼‰**Span Classï¼Œè¿™ä¸ªæ˜¯ Golang å†…å­˜ç®¡ç†é¢å¤–å®šä¹‰çš„è§„æ ¼å±æ€§**ï¼Œæ˜¯é’ˆå¯¹ Span æ¥è¿›è¡Œåˆ’åˆ†çš„ï¼Œæ˜¯ Span å¤§å°çš„çº§åˆ«ã€‚ä¸€ä¸ª Size Class ä¼šå¯¹åº”ä¸¤ä¸ª Span Classï¼Œå…¶ä¸­ä¸€ä¸ª Span ä¸ºå­˜æ”¾éœ€è¦ GC æ‰«æçš„å¯¹è±¡ï¼ˆåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰ï¼Œå¦ä¸€ä¸ª Span ä¸ºå­˜æ”¾ä¸éœ€è¦ GC æ‰«æçš„å¯¹è±¡ï¼ˆä¸åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰ã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690733711249-5f4dd111-ba00-4648-93c0-665dbfb61cb1.png#averageHue=%23f5ece1&clientId=udacbeb45-45da-4&from=paste&id=u05dd44c5&originHeight=1196&originWidth=1680&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=ue5563e97-4bd6-49ea-832d-658a4470a4e&title=)  
å…¶å®çœ‹ç€è¿™ä¸ªå›¾è¡¨ï¼Œä¹Ÿèƒ½çŒœå‡ºæ¥ä¸€ä¸‹å¯¹åº”å…¬å¼ã€‚

    éœ€è¦ GC æ‰«æ	
    Span Class = Size Class * 2 + 0
    ä¸éœ€è¦ GC æ‰«æ	
    Span Class = Size Class * 2 + 1
    

#### Size Classå¯¹åº”æ˜ç»†

    /*
    classï¼š class IDï¼Œæ¯ä¸ªspanç»“æ„ä¸­éƒ½æœ‰ä¸€ä¸ªclass ID, è¡¨ç¤ºè¯¥spanå¯å¤„ç†çš„å¯¹è±¡ç±»å‹
    bytes/objï¼šè¯¥classä»£è¡¨å¯¹è±¡çš„å­—èŠ‚æ•°
    bytes/spanï¼šæ¯ä¸ªspanå ç”¨å †çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå³é¡µæ•°*é¡µå¤§å°
    objects: æ¯ä¸ªspanå¯åˆ†é…çš„å¯¹è±¡ä¸ªæ•°ï¼Œä¹Ÿå³ï¼ˆbytes/spansï¼‰/ï¼ˆbytes/objï¼‰
    tail waste åˆ—ä¸ºå½“å‰ Span å¹³å‡åˆ†å±‚ N ä»½ Objectï¼Œä¼šæœ‰å¤šå°‘å†…å­˜æµªè´¹ï¼Œè¿™ä¸ªå€¼æ˜¯é€šè¿‡ bytes/span å¯¹ bytes/obj æ±‚ä½™å¾—å‡ºï¼Œå³ span% objã€‚
    max waste:åˆ—å½“å‰ Size Class æœ€å¤§å¯èƒ½æµªè´¹çš„ç©ºé—´æ‰€å ç™¾åˆ†æ¯”ã€‚
    */
    // class  bytes/obj  bytes/span  objects  tail waste  max waste
    //     1          8        8192     1024           0        87.50%
    //     2         16        8192      512           0        43.75%
    //     3         32        8192      256           0        46.88%
    //     4         48        8192      170          32        31.52%
    //     5         64        8192      128           0        23.44%
    //     6         80        8192      102          32        19.07%
    //     7         96        8192       85          32        15.95%
    //     8        112        8192       73          16        13.56%
    //     9        128        8192       64           0        11.72%
    //    10        144        8192       56         128        11.82%
    //    11        160        8192       51          32        9.73%
    //    12        176        8192       46          96        9.59%
    //    13        192        8192       42         128        9.25%
    //    14        208        8192       39          80        8.12%
    //    15        224        8192       36         128        8.15%
    //    16        240        8192       34          32        6.62%
    //    17        256        8192       32           0        5.86%
    //    18        288        8192       28         128        12.16%
    //    19        320        8192       25         192        11.80%
    //    20        352        8192       23          96        9.88%
    //    21        384        8192       21         128        9.51%
    //    22        416        8192       19         288        10.71%
    //    23        448        8192       18         128        8.37%
    //    24        480        8192       17          32        6.82%
    //    25        512        8192       16           0        6.05%
    //    26        576        8192       14         128        12.33%
    //    27        640        8192       12         512        15.48%
    //    28        704        8192       11         448        13.93%
    //    29        768        8192       10         512        13.94%
    //    30        896        8192        9         128        15.52%
    //    31       1024        8192        8           0        12.40%
    //    32       1152        8192        7         128        12.41%
    //    33       1280        8192        6         512        15.55%
    //    34       1408       16384       11         896        14.00%
    //    35       1536        8192        5         512        14.00%
    //    36       1792       16384        9         256        15.57%
    //    37       2048        8192        4           0        12.45%
    //    38       2304       16384        7         256       12.46%
    //    39       2688        8192        3         128        15.59%
    //    40       3072       24576        8           0        12.47%
    //    41       3200       16384        5         384        6.22%
    //    42       3456       24576        7         384        8.83%
    //    43       4096        8192        2           0        15.60%
    //    44       4864       24576        5         256        16.65%
    //    45       5376       16384        3         256        10.92%
    //    46       6144       24576        4           0        12.48%
    //    47       6528       32768        5         128        6.23%
    //    48       6784       40960        6         256        4.36%
    //    49       6912       49152        7         768        3.37%
    //    50       8192        8192        1           0        15.61%
    //    51       9472       57344        6         512        14.28%
    //    52       9728       49152        5         512        3.64%
    //    53      10240       40960        4           0        4.99%
    //    54      10880       32768        3         128        6.24%
    //    55      12288       24576        2           0        11.45%
    //    56      13568       40960        3         256        9.99%
    //    57      14336       57344        4           0        5.35%
    //    58      16384       16384        1           0        12.49%
    //    59      18432       73728        4           0        11.11%
    //    60      19072       57344        3         128        3.57%
    //    61      20480       40960        2           0        6.87%
    //    62      21760       65536        3         256        6.25%
    //    63      24576       24576        1           0        11.45%
    //    64      27264       81920        3         128        10.00%
    //    65      28672       57344        2           0        4.91%
    //    66      32768       32768        1           0        12.50%
    

ä¸Šè¡¨å¯è§æœ€å¤§çš„å¯¹è±¡æ˜¯32Kå¤§å°ï¼Œè¶…è¿‡32Kå¤§å°çš„ç”±ç‰¹æ®Šçš„classè¡¨ç¤ºï¼Œè¯¥class IDä¸º0ï¼Œæ¯ä¸ªclassåªåŒ…å«ä¸€ä¸ªå¯¹è±¡ã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690734710809-f6cb0889-f5a2-4a69-b280-33c822117154.png#averageHue=%23fbf5f4&clientId=udacbeb45-45da-4&from=paste&id=u01892d7c&originHeight=813&originWidth=1680&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u8cc87a0f-c94f-45e5-89d6-578aabee418&title=)  

### MCache

ä»æ¦‚å¿µæ¥è®² MCache ä¸ TCMalloc çš„ ThreadCache ååˆ†ç›¸ä¼¼ï¼Œè®¿é—® mcache ä¾ç„¶ä¸éœ€è¦åŠ é”è€Œæ˜¯ç›´æ¥è®¿é—®ï¼Œä¸” MCache ä¸­ä¾ç„¶ä¿å­˜å„ç§å¤§å°çš„ Spanã€‚  
è™½ç„¶ MCache ä¸ ThreadCache æ¦‚å¿µç›¸ä¼¼ï¼ŒäºŒè€…è¿˜æ˜¯å­˜åœ¨ä¸€å®šçš„åŒºåˆ«çš„ï¼ŒMCache æ˜¯ä¸ Golang åç¨‹è°ƒåº¦æ¨¡å‹ GPM ä¸­çš„ P æ‰€ç»‘å®šï¼Œè€Œä¸æ˜¯å’Œçº¿ç¨‹ç»‘å®šã€‚å› ä¸º Golang è°ƒåº¦çš„ GPM æ¨¡å‹ï¼ŒçœŸæ­£å¯è¿è¡Œçš„çº¿ç¨‹ M çš„æ•°é‡ä¸ P çš„æ•°é‡ä¸€è‡´ï¼Œå³ `GOMAXPROCS` ä¸ªï¼Œæ‰€ä»¥ MCache ä¸ P è¿›è¡Œç»‘å®šæ›´èƒ½èŠ‚çœå†…å­˜ç©ºé—´ä½¿ç”¨ï¼Œå¯ä»¥ä¿è¯æ¯ä¸ª G ä½¿ç”¨ MCache æ—¶ä¸éœ€è¦åŠ é”å°±å¯ä»¥è·å–åˆ°å†…å­˜ã€‚è€Œ TCMalloc ä¸­çš„ ThreadCache éšç€ Thread çš„å¢å¤šï¼ŒThreadCache çš„æ•°é‡ä¹Ÿå°±ç›¸å¯¹æˆæ­£æ¯”å¢å¤šã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690734953370-da99d278-79e1-433c-8379-28cc511c6c1e.png#averageHue=%23fbf1e4&clientId=udacbeb45-45da-4&from=paste&id=ua98d2e78&originHeight=902&originWidth=1680&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u9343bc01-8967-48d4-9e8f-81a57642aac&title=)  
ä¸‹å›¾ï¼Œçœ‹ä¸€ä¸‹MCacheçš„å†…éƒ¨æ„é€   
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690885009492-aaf71d47-7148-4c8d-9543-f5608cc1791b.png#averageHue=%23f3c68e&clientId=ua72da740-1449-4&from=paste&id=ub6468a3d&originHeight=1117&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=ucca69f6f-f94b-4206-94cb-4a25c81bae5&title=)  
åç¨‹é€»è¾‘å±‚ä» mcache ä¸Šè·å–å†…å­˜æ˜¯ä¸éœ€è¦åŠ é”çš„ï¼Œå› ä¸ºä¸€ä¸ª P åªæœ‰ä¸€ä¸ª M åœ¨å…¶ä¸Šè¿è¡Œï¼Œä¸å¯èƒ½å‡ºç°ç«äº‰ï¼Œç”±äºæ²¡æœ‰é”é™åˆ¶ï¼Œmcache åˆ™å…¶åˆ°äº†åŠ é€Ÿå†…å­˜åˆ†é…ã€‚  
MCache ä¸­æ¯ä¸ª Span Class éƒ½ä¼šå¯¹åº”ä¸€ä¸ª MSpanï¼Œä¸åŒ Span Class çš„ MSpan çš„æ€»ä½“é•¿åº¦ä¸åŒï¼Œå‚è€ƒ runtime/sizeclasses.go çš„æ ‡å‡†è§„å®šåˆ’åˆ†ã€‚æ¯”å¦‚å¯¹äº Span Class ä¸º 4 çš„ MSpan æ¥è¯´ï¼Œå­˜æ”¾å†…å­˜å¤§å°ä¸º 1Pageï¼Œå³ 8KBã€‚æ¯ä¸ªå¯¹å¤–æä¾›çš„ Object å¤§å°ä¸º 16Bï¼Œå…±å­˜æ”¾ 512 ä¸ª Objectã€‚å…¶ä»– Span Class çš„å­˜æ”¾æ–¹å¼ç±»ä¼¼ã€‚å½“å…¶ä¸­æŸä¸ª Span Class çš„ MSpan å·²ç»æ²¡æœ‰å¯æä¾›çš„ Object æ—¶ï¼ŒMCache åˆ™ä¼šå‘ MCentral ç”³è¯·ä¸€ä¸ªå¯¹åº”çš„ MSpanã€‚  
åœ¨ä¸Šå›¾ä¸­åº”è¯¥ä¼šå‘ç°ï¼Œå¯¹äº Span Class ä¸º 0 å’Œ 1 çš„ï¼Œä¹Ÿå°±æ˜¯å¯¹åº” Size Class ä¸º 0 çš„è§„æ ¼åˆ»åº¦å†…å­˜ï¼Œmcache å®é™…ä¸Šæ˜¯æ²¡æœ‰åˆ†é…ä»»ä½•å†…å­˜çš„ã€‚å› ä¸º Golang å†…å­˜ç®¡ç†å¯¹å†…å­˜ä¸º 0 çš„æ•°æ®ç”³è¯·åšäº†ç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœç”³è¯·çš„æ•°æ®å¤§å°ä¸º 0 å°†ç›´æ¥è¿”å›ä¸€ä¸ªå›ºå®šå†…å­˜åœ°å€ï¼Œä¸ä¼šèµ° Golang å†…å­˜ç®¡ç†çš„æ­£å¸¸é€»è¾‘ï¼Œç›¸å…³ Golang æºä»£ç å¦‚ä¸‹ï¼š

    //usr/local/go/src/runtime/malloc.go
    
    // Al Allocate an object of size bytes.                                     
    // Sm Small objects are allocated from the per-P cache's free lists.        
    // La Large objects (> 32 kB) are allocated straight from the heap.         
    func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {                        
    // â€¦â€¦ï¼ˆçœç•¥éƒ¨åˆ†ä»£ç ï¼‰
    
    if size == 0 {
    return unsafe.Pointer(&zerobase)
    }
    
    //â€¦â€¦ï¼ˆçœç•¥éƒ¨åˆ†ä»£ç ï¼‰
    }
    

ä¸Šè¿°ä»£ç å¯ä»¥çœ‹è§ï¼Œå¦‚æœç”³è¯·çš„ size ä¸º 0ï¼Œåˆ™ç›´æ¥ return ä¸€ä¸ªå›ºå®šåœ°å€ zerobaseã€‚ä¸‹é¢æ¥æµ‹è¯•ä¸€ä¸‹æœ‰å…³ 0 ç©ºé—´ç”³è¯·çš„æƒ…å†µï¼Œåœ¨ Golang ä¸­å¦‚ \[0\] intã€ struct {} æ‰€éœ€è¦å¤§å°å‡æ˜¯ 0ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šå¼€å‘è€…åœ¨é€šè¿‡ Channel åšåŒæ­¥æ—¶ï¼Œå‘é€ä¸€ä¸ª struct {} æ•°æ®ï¼Œå› ä¸ºä¸ä¼šç”³è¯·ä»»ä½•å†…å­˜ï¼Œèƒ½å¤Ÿé€‚å½“èŠ‚çœä¸€éƒ¨åˆ†å†…å­˜ç©ºé—´ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

    package main
    
    import (
    "fmt"
    )
    
    func main() {
    var (
    //0å†…å­˜å¯¹è±¡
    a struct{}
    b [0]int
    
    //100ä¸ª0å†…å­˜struct{}
    c [100]struct{}
    
    //100ä¸ª0å†…å­˜struct{},makeç”³è¯·å½¢å¼
    d = make([]struct{}, 100)
    )
    
    fmt.Printf("%p\n", &a)
    fmt.Printf("%p\n", &b)
    fmt.Printf("%p\n", &c[50])    //å–ä»»æ„å…ƒç´ 
    fmt.Printf("%p\n", &(d[50]))  //å–ä»»æ„å…ƒç´ 
    }
    // è¿è¡Œç»“æœ
    0x11aac78
    0x11aac78
    0x11aac78
    0x11aac78
    

ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå…¨éƒ¨çš„ 0 å†…å­˜å¯¹è±¡åˆ†é…ï¼Œè¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªå›ºå®šçš„åœ°å€ã€‚  

### MCentral

MCentral ä¸ TCMalloc ä¸­çš„ Central æ¦‚å¿µä¾ç„¶ç›¸ä¼¼ã€‚å‘ MCentral ç”³è¯· Span æ˜¯åŒæ ·æ˜¯éœ€è¦åŠ é”çš„ã€‚åˆ°è¿™åº”è¯¥å¯ä»¥è½»æ¾ç†è§£äº†ï¼Œå› ä¸ºMCentralæ˜¯ä¸€ä¸ªå…¨å±€çš„å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦åŠ é”ã€‚  
å½“ MCache ä¸­æŸä¸ª Size Class å¯¹åº”çš„ Span è¢«ä¸€æ¬¡æ¬¡ Object è¢«ä¸Šå±‚å–èµ°åï¼Œå¦‚æœå‡ºç°å½“å‰ Size Class çš„ Span ç©ºç¼ºæƒ…å†µï¼ŒMCache åˆ™ä¼šå‘ MCentral ç”³è¯·å¯¹åº”çš„ Spanã€‚Goroutineã€MCacheã€MCentralã€MHeap äº’ç›¸äº¤æ¢çš„å†…å­˜å•ä½æ˜¯ä¸åŒçš„ã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690885645642-e449a025-1524-4ae7-829a-7b6efb3f56ba.png#averageHue=%23fbf0ed&clientId=ua72da740-1449-4&from=paste&id=u5612944a&originHeight=663&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=uceb8ce8a-068d-4f23-927a-bc76068403b&title=)  
å…¶ä¸­åç¨‹é€»è¾‘å±‚ä¸ MCache çš„å†…å­˜äº¤æ¢å•ä½æ˜¯ Objectï¼ŒMCache ä¸ MCentral çš„å†…å­˜äº¤æ¢å•ä½æ˜¯ Spanï¼Œè€Œ MCentral ä¸ MHeap çš„å†…å­˜äº¤æ¢å•ä½æ˜¯ Pageã€‚  
MCentral ä¸ TCMalloc ä¸­çš„ Central ä¸åŒçš„æ˜¯ MCentral é’ˆå¯¹æ¯ä¸ª Span Class çº§åˆ«æœ‰ä¸¤ä¸ª Span é“¾è¡¨ï¼Œè€Œ TCMalloc ä¸­çš„ Central åªæœ‰ä¸€ä¸ªã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690885913983-1535603a-8a06-4ca5-bb5e-86a723b3d4a9.png#averageHue=%23eaa697&clientId=ua72da740-1449-4&from=paste&id=u8885008f&originHeight=1089&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=u22d34c60-f2f2-47e1-9809-f2fccfdbfc3&title=)  
MCentral ä¸ MCCache ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ªçº§åˆ«ä¿å­˜çš„ä¸æ˜¯ä¸€ä¸ª Spanï¼Œè€Œæ˜¯ä¸€ä¸ª Span List é“¾è¡¨ã€‚ä¸ TCMalloc ä¸­çš„ Central ä¸åŒçš„æ˜¯ï¼ŒMCentral æ¯ä¸ªçº§åˆ«éƒ½ä¿å­˜äº†ä¸¤ä¸ª Span Listã€‚  
æ³¨æ„å›¾ä¸­MCentral æ˜¯è¡¨ç¤ºä¸€å±‚æŠ½è±¡çš„æ¦‚å¿µï¼Œå®é™…ä¸Šæ¯ä¸ª Span Class å¯¹åº”çš„å†…å­˜æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ª **mcentral**ï¼Œå³åœ¨ MCentral è¿™å±‚æ•°æ®ç®¡ç†ä¸­ï¼Œå®é™…ä¸Šæœ‰ Span Class ä¸ª mcentral å°å†…å­˜ç®¡ç†å•å…ƒã€‚  
mcentralçš„ç®€åŒ–æ•°æ®ç»“æ„ï¼ˆgo.16å‰ï¼‰

    type mcentral struct {
        lock      mutex     // ç”³è¯·MCentralå†…å­˜åˆ†é…æ—¶éœ€è¦åŠ çš„é”
        sizeclass int       // å½“å‰ mcentral ç®¡ç†çš„å¯¹è±¡çš„Size Classçº§åˆ«çš„
        nonempty  mSpanList // éç©ºçš„ Span åˆ—è¡¨ï¼ŒåŒ…å«æœªæ»¡è¶³åˆ†é…è¯·æ±‚çš„ Span
        empty     mSpanList // æ²¡æœ‰å¯ç”¨ç©ºé—´çš„Spané“¾è¡¨ï¼Œæˆ–è€…å½“å‰é“¾è¡¨é‡Œçš„Spanå·²ç»äº¤ç»™mcache
    }
    
    type mSpanList struct {
        first *mspan // ç¬¬ä¸€ä¸ª Span
        last  *mspan // æœ€åä¸€ä¸ª Span
    }
    

**nonempty**  
è¡¨ç¤ºè¿˜æœ‰å¯ç”¨ç©ºé—´çš„ Span é“¾è¡¨ã€‚é“¾è¡¨ä¸­çš„æ‰€æœ‰ Span éƒ½è‡³å°‘æœ‰ 1 ä¸ªç©ºé—²çš„ Object ç©ºé—´ã€‚å¦‚æœ MCentral ä¸Šæ¸¸ MCache é€€è¿˜ Spanï¼Œä¼šå°†é€€è¿˜çš„ Span åŠ å…¥åˆ° NonEmpty Span List é“¾è¡¨ä¸­ã€‚  
**empty**  
è¡¨ç¤ºæ²¡æœ‰å¯ç”¨ç©ºé—´çš„ Span é“¾è¡¨ã€‚è¯¥é“¾è¡¨ä¸Šçš„ Span éƒ½ä¸ç¡®å®šå¦è¿˜æœ‰æœ‰ç©ºé—²çš„ Object ç©ºé—´ã€‚å¦‚æœ MCentral æä¾›ç»™ä¸€ä¸ª Span ç»™åˆ°ä¸Šæ¸¸ MCacheï¼Œé‚£ä¹ˆè¢«æä¾›çš„ Span å°±ä¼šåŠ å…¥åˆ° Empty List é“¾è¡¨ä¸­ã€‚  
**æ³¨æ„ åœ¨ Golang 1.16 ç‰ˆæœ¬ä¹‹åï¼ŒMCentral ä¸­çš„ NonEmpty Span List å’Œ Empty Span List**  
**å‡ç”±é“¾è¡¨ç®¡ç†æ”¹æˆé›†åˆç®¡ç†ï¼Œåˆ†åˆ«å¯¹åº” Partial Span Set å’Œ Full Span Setã€‚è™½ç„¶å­˜å‚¨çš„æ•°æ®ç»“æ„æœ‰å˜åŒ–ï¼Œä½†æ˜¯åŸºæœ¬çš„ä½œç”¨å’ŒèŒè´£æ²¡æœ‰åŒºåˆ«ã€‚**  
mcentralçš„ç®€åŒ–æ•°æ®ç»“æ„ï¼ˆgo1.16åï¼‰

    type mcentral struct {
    // mcentralå¯¹åº”çš„spanClass
    spanclass spanClass
    
    partial  [2]spanSet // ç»´æŠ¤å…¨éƒ¨ç©ºé—²çš„Spané›†åˆ
    full     [2]spanSet // ç»´æŠ¤å­˜åœ¨éç©ºé—²çš„Spané›†åˆ
    }
    

æ–°ç‰ˆæœ¬çš„æ”¹è¿›æ˜¯å°† List å˜æˆäº†ä¸¤ä¸ª Set é›†åˆï¼ŒPartial é›†åˆä¸ NonEmpty Span List è´£ä»»ç±»ä¼¼ï¼ŒFull é›†åˆä¸ Empty Span List è´£ä»»ç±»ä¼¼ã€‚å¯ä»¥çœ‹è§ Partial å’Œ Full éƒ½æ˜¯ä¸€ä¸ª \[2\] spanSet ç±»å‹ï¼Œä¹Ÿå°±æ¯ä¸ª Partial å’Œ Full éƒ½å„æœ‰ä¸¤ä¸ª spanSet é›†åˆï¼Œè¿™æ˜¯ä¸ºäº†ç»™ GC åƒåœ¾å›æ”¶æ¥ä½¿ç”¨çš„ï¼Œå…¶ä¸­ä¸€ä¸ªé›†åˆæ˜¯å·²æ‰«æçš„ï¼Œå¦ä¸€ä¸ªé›†åˆæ˜¯æœªæ‰«æçš„ã€‚

### MHeap

Golang å†…å­˜ç®¡ç†çš„ MHeap ä¾ç„¶æ˜¯ç»§æ‰¿ TCMalloc çš„ PageHeap è®¾è®¡ã€‚MHeap çš„ä¸Šæ¸¸æ˜¯ MCentralï¼ŒMCentral ä¸­çš„ Span ä¸å¤Ÿæ—¶ä¼šå‘ MHeap ç”³è¯·ã€‚MHeap çš„ä¸‹æ¸¸æ˜¯æ“ä½œç³»ç»Ÿï¼ŒMHeap çš„å†…å­˜ä¸å¤Ÿæ—¶ä¼šå‘æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜ç©ºé—´ç”³è¯·ã€‚è®¿é—® MHeap è·å–å†…å­˜ä¾ç„¶æ˜¯éœ€è¦åŠ é”çš„ã€‚  
MHeap æ˜¯å¯¹å†…å­˜å—çš„ç®¡ç†å¯¹è±¡ï¼Œæ˜¯é€šè¿‡ Page ä¸ºå†…å­˜å•å…ƒè¿›è¡Œç®¡ç†ã€‚é‚£ä¹ˆç”¨æ¥è¯¦ç»†ç®¡ç†æ¯ä¸€ç³»åˆ— Page çš„ç»“æ„ç§°ä¹‹ä¸ºä¸€ä¸ª HeapArenaï¼Œå®ƒä»¬çš„é€»è¾‘å±‚çº§å…³ç³»å¦‚å›¾æ‰€ç¤ºã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690887074468-4b62fd68-91e2-4198-9f77-492654dc6396.png#averageHue=%236db93f&clientId=ua72da740-1449-4&from=paste&id=ubea96786&originHeight=1499&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=ubc1dbc13-9b37-4733-9b5e-1207c7e22c7&title=)  
ä¸€ä¸ª HeapArena å ç”¨å†…å­˜ 64MB\[8\]ï¼Œå…¶ä¸­é‡Œé¢çš„å†…å­˜çš„æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ mspanï¼Œå½“ç„¶æœ€å°å•å…ƒä¾ç„¶æ˜¯ Pageï¼Œå›¾ä¸­æ²¡æœ‰è¡¨ç¤ºå‡º mspanï¼Œå› ä¸ºå¤šä¸ªè¿ç»­çš„ page å°±æ˜¯ä¸€ä¸ª mspanã€‚æ‰€æœ‰çš„ HeapArena ç»„æˆçš„é›†åˆæ˜¯ä¸€ä¸ª Arenasï¼Œä¹Ÿå°±æ˜¯ MHeap é’ˆå¯¹å †å†…å­˜çš„ç®¡ç†ã€‚MHeap æ˜¯ Golang è¿›ç¨‹å…¨å±€å”¯ä¸€çš„æ‰€ä»¥è®¿é—®ä¾ç„¶åŠ é”ã€‚å›¾ä¸­åˆå‡ºç°äº† MCentralï¼Œå› ä¸º MCentral æœ¬ä¹Ÿå±äº MHeap ä¸­çš„ä¸€éƒ¨åˆ†ã€‚åªä¸è¿‡ä¼šä¼˜å…ˆä» MCentral è·å–å†…å­˜ï¼Œå¦‚æœæ²¡æœ‰ MCentral ä¼šä» Arenas ä¸­çš„æŸä¸ª HeapArena è·å– Pageã€‚  

Golangå¯¹è±¡åˆ†é…æµç¨‹
------------

Golang å†…å­˜ä¸ TCMalloc å¯¹å†…å­˜çš„åˆ†ç±»å¯¹æ¯”

**TCMalloc**

**Golang**

å°å¯¹è±¡

Tiny å¯¹è±¡

ä¸­å¯¹è±¡

å°å¯¹è±¡

å¤§å¯¹è±¡

å¤§å¯¹è±¡

### Tinyå¯¹è±¡åˆ†é…æµç¨‹

é’ˆå¯¹ Tiny å¾®å°å¯¹è±¡çš„åˆ†é…ï¼Œå®é™…ä¸Š Golang åšäº†æ¯”è¾ƒç‰¹æ®Šçš„å¤„ç†ï¼Œä¹‹å‰åœ¨ä»‹ç» MCache çš„æ—¶å€™å¹¶æ²¡æœ‰æåŠæœ‰å…³ Tiny çš„å­˜å‚¨å’Œåˆ†é…é—®é¢˜ï¼ŒMCache ä¸­ä¸ä»…ä¿å­˜ç€å„ä¸ª Span Class çº§åˆ«çš„å†…å­˜å—ç©ºé—´ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„ Tiny å­˜å‚¨ç©ºé—´ã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690888050093-ea775ac3-d0ce-4c6a-b61f-cfeb8a10425f.png#averageHue=%23f3c68c&clientId=ua72da740-1449-4&from=paste&id=ub557c1db&originHeight=1125&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=u798b8598-a9ec-4a30-b224-f687ca5c9d9&title=)  
Tiny ç©ºé—´æ˜¯ä» Size Class = 2ï¼ˆå¯¹åº” Span Class = 4 æˆ– 5ï¼‰ä¸­è·å–ä¸€ä¸ª 16B çš„ Objectï¼Œä½œä¸º Tiny å¯¹è±¡çš„åˆ†é…ç©ºé—´ã€‚å¯¹äº Golang å†…å­˜ç®¡ç†ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ª Tiny è¿™æ ·çš„ 16B ç©ºé—´ï¼ŒåŸå› æ˜¯å› ä¸ºå¦‚æœåç¨‹é€»è¾‘å±‚ç”³è¯·çš„å†…å­˜ç©ºé—´å°äºç­‰äº 8Bï¼Œé‚£ä¹ˆæ ¹æ®æ­£å¸¸çš„ Size Class åŒ¹é…ä¼šåŒ¹é…åˆ° Size Class = 1ï¼ˆå¯¹åº” Span Class = 2 æˆ– 3ï¼‰ï¼Œæ‰€ä»¥åƒ int32ã€ byteã€ bool ä»¥åŠå°å­—ç¬¦ä¸²ç­‰ç»å¸¸ä½¿ç”¨çš„ Tiny å¾®å°å¯¹è±¡ï¼Œä¹Ÿéƒ½ä¼šä½¿ç”¨ä» Size Class = 1 ç”³è¯·çš„è¿™ 8B çš„ç©ºé—´ã€‚ä½†æ˜¯ç±»ä¼¼ bool æˆ–è€… 1 ä¸ªå­—èŠ‚çš„ byteï¼Œä¹Ÿéƒ½ä¼šå„è‡ªç‹¬äº«è¿™ 8B çš„ç©ºé—´ï¼Œè¿›è€Œå¯¼è‡´æœ‰ä¸€å®šçš„å†…å­˜ç©ºé—´æµªè´¹ï¼Œå¦‚å›¾ 42 æ‰€ç¤ºã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690889043843-5960fedd-3ea0-4241-b866-ec907dbfd61e.png#averageHue=%23f3f3f3&clientId=ua72da740-1449-4&from=paste&id=ufd8911b9&originHeight=1530&originWidth=862&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=uedcb6052-573c-48fe-a3ed-d5d1200a952&title=)

å¯ä»¥çœ‹å‡ºæ¥è¿™æ ·å½“å¤§é‡çš„ä½¿ç”¨å¾®å°å¯¹è±¡å¯èƒ½ä¼šå¯¹ Size Class = 1 çš„ Span é€ æˆå¤§é‡çš„æµªè´¹ã€‚æ‰€ä»¥ Golang å†…å­˜ç®¡ç†å†³å®šå°½é‡ä¸ä½¿ç”¨ Size Class = 1 çš„ Spanï¼Œè€Œæ˜¯å°†ç”³è¯·çš„ Object å°äº 16B çš„ç”³è¯·ç»Ÿä¸€å½’ç±»ä¸º Tiny å¯¹è±¡ç”³è¯·ã€‚å…·ä½“çš„ç”³è¯·æµç¨‹å¦‚å›¾æ‰€ç¤ºã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690889078879-8f571093-8ed6-493b-b396-b87714837a2e.png#averageHue=%23dc931d&clientId=ua72da740-1449-4&from=paste&id=ube3eaf01&originHeight=1283&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=u91a78cef-58ce-491b-be9b-0a4e6d50e66&title=)  
MCache ä¸­å¯¹äº Tiny å¾®å°å¯¹è±¡çš„ç”³è¯·æµç¨‹å¦‚ä¸‹ï¼š  
ï¼ˆ1ï¼‰P å‘ MCache ç”³è¯·å¾®å°å¯¹è±¡å¦‚ä¸€ä¸ª Bool å˜é‡ã€‚å¦‚æœç”³è¯·çš„ Object åœ¨ Tiny å¯¹è±¡çš„å¤§å°èŒƒå›´åˆ™è¿›å…¥ Tiny å¯¹è±¡ç”³è¯·æµç¨‹ï¼Œå¦åˆ™è¿›å…¥å°å¯¹è±¡æˆ–å¤§å¯¹è±¡ç”³è¯·æµç¨‹ã€‚  
ï¼ˆ2ï¼‰åˆ¤æ–­ç”³è¯·çš„ Tiny å¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡é’ˆï¼Œå¦‚æœåŒ…å«åˆ™è¿›å…¥å°å¯¹è±¡ç”³è¯·æµç¨‹ï¼ˆä¸ä¼šæ”¾åœ¨ Tiny ç¼“å†²åŒºï¼Œå› ä¸ºéœ€è¦ GC èµ°æ‰«æç­‰æµç¨‹ï¼‰ã€‚  
ï¼ˆ3ï¼‰å¦‚æœ Tiny ç©ºé—´çš„ 16B æ²¡æœ‰å¤šä½™çš„å­˜å‚¨å®¹é‡ï¼Œåˆ™ä» Size Class = 2ï¼ˆå³ Span Class = 4 æˆ– 5ï¼‰çš„ Span ä¸­è·å–ä¸€ä¸ª 16B çš„ Object æ”¾ç½® Tiny ç¼“å†²åŒºã€‚  
ï¼ˆ4ï¼‰å°† 1B çš„ Bool ç±»å‹æ”¾ç½®åœ¨ 16B çš„ Tiny ç©ºé—´ä¸­ï¼Œä»¥å­—èŠ‚å¯¹é½çš„æ–¹å¼ã€‚

å¯¹äº Tiny å†…å­˜åˆ†é…å™¨ï¼Œå¯¹è±¡çš„å¯¹é½æ˜¯æ ¹æ®å…¶å¤§å°è¿›è¡Œçš„ã€‚tiny å†…å­˜åˆ†é…å™¨ä¸­çš„å¯¹è±¡æœ‰ä»¥ä¸‹å¯¹é½è§„åˆ™ï¼š

1.  å¯¹è±¡å¤§å°å°äºç­‰äº 8 å­—èŠ‚æ—¶ï¼Œå¯¹è±¡çš„å¤§å°ä¿æŒä¸å˜ï¼Œä¸è¿›è¡Œå¯¹é½ã€‚ä¾‹å¦‚ï¼Œå¤§å°ä¸º 4 å­—èŠ‚çš„å¯¹è±¡å ç”¨ 4 å­—èŠ‚çš„å†…å­˜ã€‚
2.  å¯¹è±¡å¤§å°å¤§äº 8 å­—èŠ‚ï¼Œä¸”å°äºç­‰äº 16 å­—èŠ‚æ—¶ï¼Œå¯¹è±¡çš„å¤§å°è¿›è¡Œå¯¹é½åˆ° 8 å­—èŠ‚ã€‚ä¾‹å¦‚ï¼Œå¤§å°ä¸º 12 å­—èŠ‚çš„å¯¹è±¡ä¼šå ç”¨ 16 å­—èŠ‚çš„å†…å­˜ã€‚

Tiny å¯¹è±¡çš„ç”³è¯·ä¹Ÿæ˜¯è¾¾ä¸åˆ°å†…å­˜åˆ©ç”¨ç‡ 100% çš„ï¼Œå°±ä¸Šè¿°å›¾ 43 ä¸ºä¾‹ï¼Œå½“å‰ Tiny ç¼“å†² 16B çš„å†…å­˜åˆ©ç”¨ç‡ä¸ºï¼Œè€Œå¦‚æœä¸ç”¨ Tiny å¾®å°å¯¹è±¡çš„æ–¹å¼æ¥å­˜å‚¨ï¼Œé‚£ä¹ˆå†…å­˜çš„å¸ƒå±€å°†å¦‚å›¾

![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690889097861-68d82fe4-81d2-4082-b0e8-7e044de4c74e.png#averageHue=%23f5f5f5&clientId=ua72da740-1449-4&from=paste&id=u359399cb&originHeight=370&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=udcd2cfb3-1879-4838-a509-9f8162efdeb&title=)  

### å°å¯¹è±¡åˆ†é…æµç¨‹

ä¸Šé¢å·²ç»ä»‹ç»äº†åˆ†é…åœ¨ 1B è‡³ 16B çš„ Tiny å¯¹è±¡çš„åˆ†é…æµç¨‹ï¼Œé‚£ä¹ˆå¯¹äºå¯¹è±¡åœ¨ 16B è‡³ 32B çš„å†…å­˜åˆ†é…ï¼ŒGolang ä¼šé‡‡ç”¨å°å¯¹è±¡çš„åˆ†é…æµç¨‹ã€‚  
åˆ†é…å°å¯¹è±¡çš„æ ‡å‡†æµç¨‹æ˜¯æŒ‰ç…§ Span Class è§„æ ¼åŒ¹é…çš„ã€‚åœ¨ä¹‹å‰ä»‹ç» MCache çš„å†…éƒ¨æ„é€ å·²ç»ä»‹ç»äº†ï¼ŒMCache ä¸€å…±æœ‰ 67 ä»½ Size Class å…¶ä¸­ Size Class ä¸º 0 çš„åšäº†ç‰¹æ®Šçš„å¤„ç†ç›´æ¥è¿”å›ä¸€ä¸ªå›ºå®šçš„åœ°å€ã€‚Span Class ä¸º Size Class çš„äºŒå€ï¼Œä¹Ÿå°±æ˜¯ä» 0 è‡³ 133 å…± 134 ä¸ª Span Classã€‚  
å½“åç¨‹é€»è¾‘å±‚ P ä¸»åŠ¨ç”³è¯·ä¸€ä¸ªå°å¯¹è±¡çš„æ—¶å€™ï¼ŒGolang å†…å­˜ç®¡ç†çš„å†…å­˜ç”³è¯·æµç¨‹å¦‚å›¾æ‰€ç¤ºã€‚  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690889359403-1a1d91a5-f3fe-4d86-97a3-4db7ac2bdaf6.png#averageHue=%23e19338&clientId=ua72da740-1449-4&from=paste&id=u4b7ade5d&originHeight=934&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=uf3b2f839-35c2-4d81-9d3e-c86ad559151&title=)  
ä¸‹é¢æ¥åˆ†æä¸€ä¸‹å…·ä½“çš„æµç¨‹è¿‡ç¨‹ï¼š  
ï¼ˆ1ï¼‰é¦–å…ˆåç¨‹é€»è¾‘å±‚ P å‘ Golang å†…å­˜ç®¡ç†ç”³è¯·ä¸€ä¸ªå¯¹è±¡æ‰€éœ€çš„å†…å­˜ç©ºé—´ã€‚  
ï¼ˆ2ï¼‰MCache åœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ ¹æ®å¯¹è±¡æ‰€éœ€çš„å†…å­˜ç©ºé—´è®¡ç®—å‡ºå…·ä½“çš„å¤§å° Sizeã€‚  
ï¼ˆ3ï¼‰åˆ¤æ–­ Size æ˜¯å¦å°äº 16Bï¼Œå¦‚æœå°äº 16B åˆ™è¿›å…¥ Tiny å¾®å¯¹è±¡ç”³è¯·æµç¨‹ï¼Œå¦åˆ™è¿›å…¥å°å¯¹è±¡ç”³è¯·æµç¨‹ã€‚  
ï¼ˆ4ï¼‰æ ¹æ® Size åŒ¹é…å¯¹åº”çš„ Size Class å†…å­˜è§„æ ¼ï¼Œ**å†æ ¹æ® Size Class å’Œè¯¥å¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡é’ˆï¼Œæ¥å®šä½æ˜¯ä» noscan Span Class è¿˜æ˜¯ scan Span Class è·å–ç©ºé—´ï¼Œæ²¡æœ‰æŒ‡é’ˆåˆ™é”å®š noscanã€‚**  
ï¼ˆ5ï¼‰åœ¨å®šä½çš„ Span Class ä¸­çš„ Span å–å‡ºä¸€ä¸ª Object è¿”å›ç»™åç¨‹é€»è¾‘å±‚ Pï¼ŒP å¾—åˆ°å†…å­˜ç©ºé—´ï¼Œæµç¨‹ç»“æŸã€‚  
ï¼ˆ6ï¼‰å¦‚æœå®šä½çš„ Span Class ä¸­çš„ Span æ‰€æœ‰çš„å†…å­˜å— Object éƒ½è¢«å ç”¨ï¼Œåˆ™ MCache ä¼šå‘ MCentral ç”³è¯·ä¸€ä¸ª Spanã€‚  
ï¼ˆ7ï¼‰MCentral æ”¶åˆ°å†…å­˜ç”³è¯·åï¼Œä¼˜å…ˆä»ç›¸å¯¹åº”çš„ Span Class ä¸­çš„ NonEmpty Span Listï¼ˆæˆ– Partial Setï¼ŒGolang V1.16+ï¼‰é‡Œå–å‡º Spanï¼ˆå¤šä¸ª Object ç»„æˆï¼‰ï¼ŒNonEmpty Span List æ²¡æœ‰åˆ™ä» Empty Listï¼ˆæˆ– Full Set Golang V1.16+ï¼‰ä¸­å–ï¼Œè¿”å›ç»™ MCacheã€‚  
ï¼ˆ8ï¼‰MCache å¾—åˆ° MCentral è¿”å›çš„ Spanï¼Œè¡¥å……åˆ°å¯¹åº”çš„ Span Class ä¸­ï¼Œä¹‹åå†æ¬¡æ‰§è¡Œç¬¬ï¼ˆ5ï¼‰æ­¥æµç¨‹ã€‚  
ï¼ˆ9ï¼‰å¦‚æœ Empty Span Listï¼ˆæˆ– Full Setï¼‰ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ Spanï¼Œåˆ™ MCentral ä¼šå‘ MHeap ç”³è¯·å†…å­˜ã€‚  
ï¼ˆ10ï¼‰MHeap æ”¶åˆ°å†…å­˜è¯·æ±‚ä»å…¶ä¸­ä¸€ä¸ª HeapArena ä»å–å‡ºä¸€éƒ¨åˆ† Pages è¿”å›ç»™ MCentralï¼Œå½“ MHeap æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ—¶ï¼ŒMHeap ä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œå°†ç”³è¯·çš„å†…å­˜ä¹Ÿä¿å­˜åˆ° HeapArena ä¸­çš„ mspan ä¸­ã€‚MCentral å°†ä» MHeap è·å–çš„ç”± Pages ç»„æˆçš„ Span æ·»åŠ åˆ°å¯¹åº”çš„ Span Class é“¾è¡¨æˆ–é›†åˆä¸­ï¼Œä½œä¸ºæ–°çš„è¡¥å……ï¼Œä¹‹åå†æ¬¡æ‰§è¡Œç¬¬ï¼ˆ7ï¼‰æ­¥ã€‚  
ï¼ˆ11ï¼‰æœ€ååç¨‹ä¸šåŠ¡é€»è¾‘å±‚å¾—åˆ°è¯¥å¯¹è±¡ç”³è¯·åˆ°çš„å†…å­˜ï¼Œæµç¨‹ç»“æŸã€‚  

### å¤§å¯¹è±¡åˆ†é…æµç¨‹

å°å¯¹è±¡æ˜¯åœ¨ MCache ä¸­åˆ†é…çš„ï¼Œè€Œå¤§å¯¹è±¡æ˜¯ç›´æ¥ä» MHeap ä¸­åˆ†é…ã€‚å¯¹äºä¸æ»¡è¶³ MCache åˆ†é…èŒƒå›´çš„å¯¹è±¡ï¼Œå‡æ˜¯æŒ‰ç…§å¤§å¯¹è±¡åˆ†é…æµç¨‹å¤„ç†ã€‚  
å¤§å¯¹è±¡åˆ†é…æµç¨‹æ˜¯åç¨‹é€»è¾‘å±‚ç›´æ¥å‘ MHeap ç”³è¯·å¯¹è±¡æ‰€éœ€è¦çš„é€‚å½“ Pagesï¼Œä»è€Œç»•è¿‡ä» MCaceh åˆ° MCentral çš„ç¹çç”³è¯·å†…å­˜æµç¨‹ï¼Œå¤§å¯¹è±¡çš„å†…å­˜åˆ†é…æµç¨‹ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå…·ä½“çš„æµç¨‹å¦‚å›¾  
![](https://cdn.nlark.com/yuque/0/2023/png/26124869/1690889740954-d5018a7f-47ca-406b-9d61-f7b45f4b24b1.png#averageHue=%236cb541&clientId=ua72da740-1449-4&from=paste&id=ud0c63def&originHeight=862&originWidth=1680&originalType=url&ratio=1.6875&rotation=0&showTitle=false&status=done&style=none&taskId=u0399a343-17a6-454a-a44b-fb6298181d1&title=)  
ä¸‹é¢æ¥åˆ†æä¸€ä¸‹å…·ä½“çš„å¤§å¯¹è±¡å†…å­˜åˆ†é…æµç¨‹ï¼š  
ï¼ˆ1ï¼‰åç¨‹é€»è¾‘å±‚ç”³è¯·å¤§å¯¹è±¡æ‰€éœ€çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœè¶…è¿‡ 32KBï¼Œåˆ™ç›´æ¥ç»•è¿‡ MCache å’Œ MCentral ç›´æ¥å‘ MHeap ç”³è¯·ã€‚  
ï¼ˆ2ï¼‰MHeap æ ¹æ®å¯¹è±¡æ‰€éœ€çš„ç©ºé—´è®¡ç®—å¾—åˆ°éœ€è¦å¤šå°‘ä¸ª Pageã€‚  
ï¼ˆ3ï¼‰MHeap å‘ Arenas ä¸­çš„ HeapArena ç”³è¯·ç›¸å¯¹åº”çš„ Pagesã€‚  
ï¼ˆ4ï¼‰å¦‚æœ Arenas ä¸­æ²¡æœ‰ HeapA å¯æä¾›åˆé€‚çš„ Pages å†…å­˜ï¼Œåˆ™å‘æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜ç”³è¯·ï¼Œä¸”å¡«å……è‡³ Arenas ä¸­ã€‚  
ï¼ˆ5ï¼‰MHeap è¿”å›å¤§å¯¹è±¡çš„å†…å­˜ç©ºé—´ã€‚  
ï¼ˆ6ï¼‰åç¨‹é€»è¾‘å±‚ P å¾—åˆ°å†…å­˜ï¼Œæµç¨‹ç»“æŸã€‚  

æ€»ç»“
--

å†…å®¹çœŸçš„å¤ªç¡¬æ ¸äº†ï¼Œåšä¸»å·®ä¸å¤šçœ‹äº†ä¸¤å¤©æ‰è¿‡å®Œä¸€éï¼Œè¿˜æœ‰å¾ˆå¤šä¸ç†Ÿæ‚‰çš„åœ°æ–¹ï¼Œè¿˜è¦ç»§ç»­å¤šå­¦ä¹ ã€‚  
æ‰“ç®—çœ‹ä¸€ä¸‹åˆ˜ä¸¹å†°ä½œè€…çš„ã€Šæ·±å…¥ç†è§£goè¯­è¨€ã€‹