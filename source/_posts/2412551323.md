---
layout: post
title: "ã€æŠ€æœ¯ç§¯ç´¯ã€‘Javaé‡Œçš„volatileå…³é”®å­—åˆ°åº•èƒ½å¹²å˜›ï¼Ÿ"
date: "2023-08-18T00:55:12.818Z"
---
ã€æŠ€æœ¯ç§¯ç´¯ã€‘Javaé‡Œçš„volatileå…³é”®å­—åˆ°åº•èƒ½å¹²å˜›ï¼Ÿ
=============================

### 7.4 æœ€å®³æ€•çš„ä¸€é›† - volatile

#### 7.4.1 æœ€ç®€å•çš„ä¸€é›† - volatile è¯­ä¹‰ (éš¾åº¦ : â­)

è¯» -> è¯»ä¸€ä¸ª volatile å¿…é¡»ä» ä¸»å†…å­˜è¯»

å†™ -> å†™ä¸€ä¸ª volatile ä¼šæŠŠ æœ¬åœ°å†…å­˜ å†™åˆ° ä¸»å†…å­˜å»

#### 7.4.2 æœ€å¥½ç†è§£çš„ä¸€é›† - volatile ä¿è¯äº† å¯è§æ€§ ( éš¾åº¦ : â­ )

public class VolatileSTest {  
â€‹  
 Â  Â public static void main(String\[\] args) throws InterruptedException {  
 Â  Â  Â  Â Data data \= new Data();  
 Â  Â  Â  Â new Thread(() \-> {  
 Â  Â  Â  Â  Â  Â while (true) {  
 Â  Â  Â  Â  Â  Â  Â  Â if (data.bool) {  
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â System.out.println("æºœäº†æºœäº†,çº¿ç¨‹ç»“æŸäº†å–µ!");  
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;  
 Â  Â  Â  Â  Â  Â  Â   }  
 Â  Â  Â  Â  Â   }  
 Â  Â  Â   }).start();  
â€‹  
 Â  Â  Â  Â TimeUnit.SECONDS.sleep(1);  
 Â  Â  Â  Â // ä¿è¯æ–°çº¿ç¨‹åä¿®æ”¹  
 Â  Â  Â  Â new Thread(() \-> {  
 Â  Â  Â  Â  Â  Â data.bool \= true;  
 Â  Â  Â   }).start();  
 Â   }  
}  
class Data {  
 Â  // boolean bool = false;  
 Â  Â // volatile boolean bool = false;  
}  
â€‹

**ç†è§£æ–¹æ³•:**

*   å¦‚æœå»æ‰ volatile : å°±ä¼šå‘ç° æ­»å¾ªç¯äº†
    
*   å¦‚æœä¸å»æ‰ volatile : å°±ä¼šå‘ç° æ²¡æ­»å¾ªç¯
    

è‡ªç„¶å°±å¾ˆå¥½ç†è§£ä»–çš„ å¯è§æ€§ä¿è¯

#### 7.4.3 æœ€éš¾å¤ç°çš„ä¸€é›† - volatile çš„ æœ‰åºæ€§ä¿è¯ ( éš¾åº¦ : â­â­â­â­ )

`ä¸ºä»€ä¹ˆç»™å››é¢—â­, å› ä¸ºé¦–å…ˆ,å‡­ç©ºæƒ³æƒ³ä¸åˆ°,è€Œä¸”çœŸè¦å¤ç°å‡ºé‡æ’åºå¾ˆéš¾, ä¸ªäººè¿è¡Œäº†å‡ åƒæ¬¡çº¿ç¨‹éƒ½å‡ºä¸æ¥`

class Number {  
 Â  Â int i \= 1;  
 Â  Â volatile int v \= 1;  
â€‹  
 Â  Â public void set() {  
 Â  Â  Â  Â i \= 2;  
 Â  Â  Â  Â v \= 2;  
 Â   }  
â€‹  
 Â  Â public void show() {  
 Â  Â  Â  Â if (v \== 2) {  
 Â  Â  Â  Â  Â  Â System.out.println("t = " \+ i);  
 Â  Â  Â   }  
 Â   }  
}

**é‡æ’åº**

**é—®é¢˜ä¸€**

ä¸¤ä¸ªçº¿ç¨‹ :

ä¸€ä¸ªè°ƒç”¨ show , ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ set

> é‡å¤ä¸€é !!!! ä¸¤ä¸ªçº¿ç¨‹: ä¸€ä¸ªè°ƒç”¨ show , ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ set
> 
> é‡å¤ä¸€é !!!! ä¸¤ä¸ªçº¿ç¨‹: ä¸€ä¸ªè°ƒç”¨ show , ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ set
> 
> é‡å¤ä¸€é !!!! ä¸¤ä¸ªçº¿ç¨‹: ä¸€ä¸ªè°ƒç”¨ show , ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ set

å› ä¸ºåœ¨å•çº¿ç¨‹ä¸­ , å…ˆè°ƒç”¨setæ–¹æ³• ,å†è°ƒç”¨showæ–¹æ³•, å› ä¸º happens-before , æ˜¯ä¸ä¼šå…è®¸é‡æ’åºçš„

çº¿ç¨‹ä¸€: {  
 Â  Â  Â   i = 2;  
 Â  Â  Â   v = 2;  
}  
çº¿ç¨‹äºŒ: {  
 Â  Â  Â   if (v == 2) {  
 Â  Â  Â  Â  Â   System.out.println("t = " + i);  
 Â  Â  Â   }  
}  
åœ¨ä¸ä½¿ç”¨ volatile çš„æƒ…å†µä¸‹  
æ˜æ˜¾,åœ¨å•çº¿ç¨‹ä¸­ ,ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•ä½“æ˜¯æ²¡æœ‰ç›¸äº’ä¾èµ–çš„  
æ‰€ä»¥æ˜¯å¯ä»¥é‡æ’åºçš„,æ‰€ä»¥å¯ä»¥å‡ºç°  
çº¿ç¨‹ä¸€: {  
    v = 2  
    i = 2  
}  
çº¿ç¨‹äºŒ: {  
    // å…ˆè¯»å– i  (å³ å…ˆå‡†å¤‡ä¸€ä¸‹sout)  
    if(v == 2){  
     Â  æŠŠå‡†å¤‡å¥½çš„iè¾“å‡º  
    }  
}  
â€‹  
æ˜æ˜¾ä¼šå‡ºç°   
é”™è¯¯æƒ…å†µä¸€: v = 2 , i = 1 å¯¼è‡´ çº¿ç¨‹äºŒè¾“å‡º i = 1  
é”™è¯¯æƒ…å†µäºŒ: v = 2 , i = 2 ,ä½†æ˜¯!!å› ä¸ºçº¿ç¨‹äºŒå¯ä»¥å‡†å¤‡å¥½ i ,æ‰€ä»¥çº¿ç¨‹äºŒè¾“å‡º i = 1  
éƒ½æ˜¯é”™çš„  
è€Œä½¿ç”¨ volatile å°±å¯ä»¥é¿å…è¿™äº›æƒ…å†µ

> Q: æ¬¸æ¬¸æ¬¸ï¼å‡­ä»€ä¹ˆshowä¸€å®šåœ¨setä¹‹åå•Šï¼Ÿå°±ä¸èƒ½å…ˆshowå†setå—ï¼Ÿ
> 
> A: ğŸ˜…å¹²å˜›?å…ˆshowçš„è¯, çº¿ç¨‹äºŒæ²¡æœ‰è¾“å‡ºå‘—,ç„¶åå‘¢???æœ‰ä»€ä¹ˆé—®é¢˜å—???

**é—®é¢˜äºŒ**

public class Singleton {  
 Â  Â private volatile static Singleton instance \= null;  
 Â  Â public Â static Singleton getInstance() {  
 Â  Â  Â  Â if(null \== instance) {  
 Â  Â  Â  Â  Â  Â synchronized (Singleton.class) {  
 Â  Â  Â  Â  Â  Â  Â  Â if(null \== instance) {  
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â instance \= new Singleton();  
 Â  Â  Â  Â  Â  Â  Â   }  
 Â  Â  Â  Â  Â   }  
 Â  Â  Â   }  
  Â  Â  Â  Â return instance;  
  Â   }  
}

è¿™ä¸ªå°±ä¸è¯´äº†,

instancec å®ä¾‹åŒ–è¿‡ç¨‹:

åˆ†é…å†…å­˜ç©ºé—´  
åˆå§‹åŒ–å¯¹è±¡  
å°†å¯¹è±¡æŒ‡å‘åˆšåˆ†é…çš„å†…å­˜ç©ºé—´

å˜æˆ

åˆ†é…å†…å­˜ç©ºé—´  
å°†å¯¹è±¡æŒ‡å‘åˆšåˆ†é…çš„å†…å­˜ç©ºé—´  
åˆå§‹åŒ–å¯¹è±¡

ç„¶ååˆå§‹åŒ–ä¹‹å‰åˆè¢«åˆ«çš„çº¿ç¨‹è·å–åˆ°äº† instance å¼‚å¸¸, å°±ä¼šå‡ºç°null

#### 7.4.4 æœ€è®¨åŒçš„ä¸€é›† - å•¥é™åˆ¶é‡æ’åºå•Š ( éš¾åº¦: â­â­â­â­â­ )

è¿˜æ˜¯å…ˆè®°ä¸€ä¸‹ç»“è®ºå†å»ç†è§£å­ : **è¯»åå†™å‰**

**è¯»åå†™å‰ : volatileè¯»åç¦æ­¢ä¸€ä¸”è¯»å†™é‡æ’åº, volatileå†™å‰ç¦æ­¢ä¸€åˆ‡é‡æ’åº**

ç†è§£:

é¦–å…ˆè¦è®°ä½,éƒ½ç¦æ­¢é‡æ’åºäº†, æ€ä¹ˆå¯èƒ½è·Ÿå¯è§æ€§æœ‰å…³å‘¢ ?

ä¸€å®šæ˜¯å’Œ æœ‰åºæ€§ç›¸å…³ã€‚

class Number {  
 Â  Â int i \= 1;  
 Â  Â volatile int v \= 1;  
â€‹  
 Â  Â public void set() {  
 Â  Â  Â  Â i \= 2;  
 Â  Â  Â  Â v \= 2; // å†™ voaltileå€¼  
 Â   }  
â€‹  
 Â  Â public void show() {  
 Â  Â  Â  Â if (v \== 2) { // è¯» volatileå€¼  
 Â  Â  Â  Â  Â  Â System.out.println("t = " \+ i);  
 Â  Â  Â   }  
 Â   }  
}

é¦–å…ˆ,è®°ä½**7.4.1**ï¼š

è¯» -> è¯»ä¸€ä¸ª volatile å¿…é¡»ä» ä¸»å†…å­˜è¯»

å†™ -> å†™ä¸€ä¸ª volatile ä¼šæŠŠ æœ¬åœ°å†…å­˜ å†™åˆ° ä¸»å†…å­˜å»

ç„¶åï¼š

**å…ˆçœ‹çœ‹ç‰¹ä¾‹åˆ†æ**

çœ‹showæ–¹æ³•ï¼š å¦‚æœé‡æ’åºï¼Œ æ˜¯ä¸æ˜¯ä¼šå‡ºç° 7.4.3 ä¸­çš„ æƒ…å†µäºŒçš„é—®é¢˜

**ä¸‹é¢æ˜¯å®šæ€§åˆ†æ**

> \\é¦–å…ˆï¼Œvolatileè¯»å†™ä¹‹é—´è‚¯å®šè¦ç¦æ­¢é‡æ’åºå­ï¼Œé‡ç‚¹ä¸å¥½ç†è§£çš„è‚¯å®šæ˜¯ä¸ºä»€ä¹ˆ vè¯»ä¹‹åä¸å¯ä»¥æ™®é€šè¯»
> 
> å¯¹æ¯”ä¸€ä¸‹ï¼š( **å¦‚æœçœŸçš„å‡ºç°æ‰€è°“ vè¯»å’Œåé¢çš„æ“ä½œå‡ºç°é‡æ’åºä¼šå‘ç”Ÿä»€ä¹ˆ** )
> 
> â‘  vè¯» -> è¯»
> 
> â‘¡ vè¯» -> å†™
> 
> â‘¢ è¯» -> vè¯»
> 
> â‘£ å†™ -> vè¯»
> 
> â‘  â‘¢ å¯¹æ¯”ï¼š
> 
> â‘  ï¼š è¯»ä¸»å†…å­˜ï¼Œç„¶åæ”¾åˆ°å·¥ä½œå†…å­˜ -> è¯»å·¥ä½œå†…å­˜
> 
> â‘¢ ï¼š è¯»å·¥ä½œå†…å­˜ -> è¯»ä¸»å†…å­˜ï¼Œæ”¾åˆ°å·¥ä½œå†…å­˜
> 
> **æœ‰æ²¡æœ‰å‘ç°ï¼Œâ‘ â‘¢æ™®é€šè¯»çš„å·¥ä½œå†…å­˜æ¥æºä¸åŒï¼Ÿä¸€ä¸ªæ˜¯ä¹‹å‰çš„ï¼Œä¸€ä¸ªæ˜¯ä¹‹åçš„**
> 
> â‘¡ â‘£ å¯¹æ¯”ï¼š
> 
> â‘¡ ï¼šè¯»ä¸»å†…å­˜ï¼Œç„¶åæ”¾åˆ°å·¥ä½œå†…å­˜ -> æ”¹å˜å·¥ä½œå†…å­˜ï¼Œç„¶ååˆ·ç›˜åˆ°ä¸»å†…å­˜
> 
> â‘£ ï¼šæ”¹å˜å·¥ä½œå†…å­˜ï¼Œç„¶ååˆ·ç›˜åˆ°ä¸»å†…å­˜ -> è¯»ä¸»å†…å­˜ï¼Œç„¶åæ”¾åˆ°å·¥ä½œå†…å­˜
> 
> **æœ‰æ²¡æœ‰å‘ç°ï¼Œâ‘¡â‘£volatileè¯»åˆ°çš„ä¸»å†…å­˜æ¥æºä¸åŒï¼Ÿä¸€ä¸ªæ˜¯ä¹‹å‰çš„ï¼Œä¸€ä¸ªæ˜¯ä¹‹åçš„**

æ‰€ä»¥ è¯»åä¸å¯ä»¥é‡æ’åº

å†™å‰åŒç†

#### 7.4.5 æœ€æŠ½è±¡çš„ä¸€é›† - å†…å­˜å±éšœ ( éš¾åº¦: ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜… )

å†™çš„å‰åæœ‰ StoreStoreå±éšœ, StoreLoadå±éšœ

è¯»çš„åé¢åˆ LoadStoreå±éšœ, LoadLoadå±éšœ

> çœŸæ¶å¿ƒ,å•¥è·Ÿå•¥å•Š ?
> 
> è®°å¿†è§„å¾‹: å±éšœä¸¤ä¸ªå•è¯, å†™æ˜¯ä¸æ˜¯Store, æ‰€ä»¥æ˜¯ Store + (Store / Loadå±éšœ)
> 
> è¯»æ˜¯ä¸æ˜¯Load, æ‰€ä»¥æ˜¯ Load + (Store / Loadå±éšœ)

![image-20230817010351391](https://chain-tian.oss-cn-guangzhou.aliyuncs.com/img/202308170104073.png)

ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ç®—äº†å§, è¦è¿™ä¹ˆç»†æ˜¯æˆ‘ä¸é…äº†

**é…åˆ 7.4.5 å»ç†è§£å™¢,å†…å­˜å±éšœæˆ‘å°±æ˜¯è¯´å¾—å‡ºæ¥,ä½†æ˜¯å°±æ„Ÿè§‰ç¨€é‡Œç³Šæ¶‚ä¸çŸ¥é“ä»€ä¹ˆç©æ„,å°±æ˜¯æ„Ÿè§‰æŠ½è±¡,æˆ‘æ˜¯æ‰¾ä¸åˆ°æ–‡ç« èƒ½æŠŠè¿™ç©æ„è®²çš„æ¸…æ¸…æ¥šæ¥š,çœ‹å®Œå°±å¿˜äº†å±äºæ˜¯ğŸ˜…ğŸ˜…ğŸ˜…**

#### 7.4.6 æœ€å¥½ç¬‘çš„ä¸€çº§ - volatileå¹²å˜›çš„

**æ— è®ºæ˜¯çœ‹å…³äºvolatileçš„è§†é¢‘è¿˜æ˜¯æ–‡ç« ï¼Œæ¯æ¬¡çœ‹å®Œæˆ‘éƒ½æœ‰ç§ â€œ å™¢ ï¼Œç‰›é€¼ ï¼Œä½†æ˜¯åŸç¥æ˜¯ç”±...(æ¼ğŸ˜¡ï¼‰â€ çš„æ„Ÿè§‰ï¼Œä¸æ˜¯å—**

å…¶å®å§ï¼Œå¦‚æœæ²¡æœ‰æ¶‰åŠåˆ° å¤šçº¿ç¨‹å…¬å…±èµ„æºçš„ä¿®æ”¹ï¼Œ

volatile å°±æ˜¯**FW**

**æ‰€ä»¥å¤§å¤šæ•°æƒ…å†µï¼Œvolatile å°±æ˜¯ä¸ªFWï¼ˆå¤§æ¦‚ï¼‰**

**ä½†æ˜¯,æ¶‰åŠåˆ°å¤šçº¿ç¨‹å…¬å…±èµ„æºçš„ä¿®æ”¹,å°±ä¸ä¸€æ ·äº†!!! è§7.4.6**

æ‰€ä»¥å®ƒå¹²å˜›ç”¨çš„ï¼Ÿ

ä¸¤ç‚¹ï¼š â‘  ä¿è¯å¯è§æ€§ â‘¡ ä¿è¯æœ‰åºæ€§

> å•Š ï¼Ÿ é‚£å‰é¢ä»€ä¹ˆæœ€è®¨åŒçš„ä¸€é›†ï¼Ÿæœ€éš¾å¤ç°çš„ä¸€é›†å¹²å˜›çš„ï¼Ÿ

> > ç»™ä½ çœ‹çœ‹ä»€ä¹ˆæƒ…å†µä¸‹**volatileå±…ç„¶ä¸æ˜¯åºŸç‰©è¯¶ï¼åŸæ¥è¯»å‰å†™åæ˜¯è¿™æ ·çš„å“‡ï¼**

#### 7.4.7 æœ€éœ‡æƒŠçš„ä¸€é›† - çœŸå¤ç°å‡ºæ¥äº† ( é‡æ’åºå¤ç° )

public class OutOfOrderExecution {  
 Â  Â private static int i \= 0, j \= 0;  
 Â  Â private static int a \= 0, b \= 0;  
â€‹  
 Â  Â public static void main(String\[\] args) throws InterruptedException {  
 Â  Â  Â  Â int count \= 0; // è®¡æ•°  
 Â  Â  Â  Â while (true) {  
 Â  Â  Â  Â  Â  Â count++;  
 Â  Â  Â  Â  Â  Â i \= 0;  
 Â  Â  Â  Â  Â  Â j \= 0;  
 Â  Â  Â  Â  Â  Â a \= 0;  
 Â  Â  Â  Â  Â  Â b \= 0;  
 Â  Â  Â  Â  Â  Â Thread one \= new Thread(new Runnable() {  
 Â  Â  Â  Â  Â  Â  Â  Â @Override  
 Â  Â  Â  Â  Â  Â  Â  Â public void run() {  
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â a \= 1;  
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â i \= b;  
 Â  Â  Â  Â  Â  Â  Â   }  
 Â  Â  Â  Â  Â   });  
 Â  Â  Â  Â  Â  Â Thread two \= new Thread(new Runnable() {  
 Â  Â  Â  Â  Â  Â  Â  Â @Override  
 Â  Â  Â  Â  Â  Â  Â  Â public void run() {  
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â b \= 1;  
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â j \= a;  
 Â  Â  Â  Â  Â  Â  Â   }  
 Â  Â  Â  Â  Â   });  
 Â  Â  Â  Â  Â  Â two.start();  
 Â  Â  Â  Â  Â  Â one.start();  
 Â  Â  Â  Â  Â  Â one.join();  
 Â  Â  Â  Â  Â  Â two.join();  
 Â  Â  Â  Â  Â  Â String result \= "ç¬¬" \+ count \+ "æ¬¡ï¼ˆ Â   i= " \+ i \+ ", j= " \+ j \+ ")";  
 Â  Â  Â  Â  Â  Â if (i \== 0 && j \== 0) {  
 Â  Â  Â  Â  Â  Â  Â  Â System.out.println(result);  
 Â  Â  Â  Â  Â  Â  Â  Â break;  
 Â  Â  Â  Â  Â   } else {  
 Â  Â  Â  Â  Â  Â  Â  Â System.out.println(result);  
 Â  Â  Â  Â  Â   }  
 Â  Â  Â   }  
 Â   }  
}  
â€‹

æœ€åä¼šå‡ºç°ä¸€æ¬¡ i = 0 j = 0çš„æƒ…å†µ ?!

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[è‡ªå¾‹å³è‡ªç”±-](https://www.cnblogs.com/deyo/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/deyo/p/17638577.html](https://www.cnblogs.com/deyo/p/17638577.html)