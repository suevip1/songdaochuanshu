---
layout: post
title: "ç”±C# yield returnå¼•å‘çš„æ€è€ƒ"
date: "2023-05-31T01:16:55.360Z"
---
ç”±C# yield returnå¼•å‘çš„æ€è€ƒ
=====================

### å‰è¨€

Â Â Â Â å½“æˆ‘ä»¬ç¼–å†™ C# ä»£ç æ—¶ï¼Œç»å¸¸éœ€è¦å¤„ç†å¤§é‡çš„æ•°æ®é›†åˆã€‚åœ¨ä¼ ç»Ÿçš„æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦å…ˆå°†æ•´ä¸ªæ•°æ®é›†åˆåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†è¿›è¡Œæ“ä½œã€‚ä½†æ˜¯å¦‚æœæ•°æ®é›†åˆéå¸¸å¤§ï¼Œè¿™ç§æ–¹å¼å°±ä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒã€‚

Â Â Â Â C# ä¸­çš„`yield return`æœºåˆ¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚é€šè¿‡ä½¿ç”¨`yield return`ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®é›†åˆæŒ‰éœ€ç”Ÿæˆï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§ç”Ÿæˆæ•´ä¸ªæ•°æ®é›†åˆã€‚è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘å†…å­˜å ç”¨ï¼Œå¹¶ä¸”æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚

Â Â Â Â åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥è®¨è®º C# ä¸­`yield return`çš„æœºåˆ¶å’Œç”¨æ³•ï¼Œå¸®åŠ©æ‚¨æ›´å¥½åœ°ç†è§£è¿™ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œå¹¶åœ¨å®é™…å¼€å‘ä¸­çµæ´»ä½¿ç”¨å®ƒã€‚

### ä½¿ç”¨æ–¹å¼

ä¸Šé¢æˆ‘ä»¬æåˆ°äº†`yield return`å°†æ•°æ®é›†åˆæŒ‰éœ€ç”Ÿæˆï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§ç”Ÿæˆæ•´ä¸ªæ•°æ®é›†åˆã€‚æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å·¥ä½œæ–¹å¼æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä»¥ä¾¿åŠ æ·±å¯¹å®ƒçš„ç†è§£

    foreach (var num in GetInts())
    {
        Console.WriteLine("å¤–éƒ¨éå†äº†:{0}", num);
    }
    
    IEnumerable<int> GetInts()
    {
        for (int i = 0; i < 5; i++)
        {
            Console.WriteLine("å†…éƒ¨éå†äº†:{0}", i);
            yield return i;
        }
    }
    

é¦–å…ˆï¼Œåœ¨`GetInts`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`yield return`å…³é”®å­—æ¥å®šä¹‰ä¸€ä¸ªè¿­ä»£å™¨ã€‚è¿™ä¸ªè¿­ä»£å™¨å¯ä»¥æŒ‰éœ€ç”Ÿæˆæ•´æ•°åºåˆ—ã€‚åœ¨æ¯æ¬¡å¾ªç¯æ—¶ï¼Œä½¿ç”¨`yield return`è¿”å›å½“å‰çš„æ•´æ•°ã€‚é€šè¿‡1`foreach`å¾ªç¯æ¥éå† `GetInts`æ–¹æ³•è¿”å›çš„æ•´æ•°åºåˆ—ã€‚åœ¨è¿­ä»£æ—¶`GetInts`æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯ä¸ä¼šå°†æ•´ä¸ªåºåˆ—åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è€Œæ˜¯åœ¨éœ€è¦æ—¶ï¼ŒæŒ‰éœ€ç”Ÿæˆåºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ ã€‚åœ¨æ¯æ¬¡è¿­ä»£æ—¶ï¼Œä¼šè¾“å‡ºå½“å‰è¿­ä»£çš„æ•´æ•°å¯¹åº”çš„ä¿¡æ¯ã€‚æ‰€ä»¥è¾“å‡ºçš„ç»“æœä¸º

    å†…éƒ¨éå†äº†:0
    å¤–éƒ¨éå†äº†:0
    å†…éƒ¨éå†äº†:1
    å¤–éƒ¨éå†äº†:1
    å†…éƒ¨éå†äº†:2
    å¤–éƒ¨éå†äº†:2
    å†…éƒ¨éå†äº†:3
    å¤–éƒ¨éå†äº†:3
    å†…éƒ¨éå†äº†:4
    å¤–éƒ¨éå†äº†:4
    

å¯ä»¥çœ‹åˆ°ï¼Œæ•´æ•°åºåˆ—æ˜¯æŒ‰éœ€ç”Ÿæˆçš„ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡ç”Ÿæˆæ—¶éƒ½ä¼šè¾“å‡ºç›¸åº”çš„ä¿¡æ¯ã€‚è¿™ç§æ–¹å¼å¯ä»¥å¤§å¤§å‡å°‘å†…å­˜å ç”¨ï¼Œå¹¶ä¸”æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚å½“ç„¶ä»`c# 8`å¼€å§‹å¼‚æ­¥è¿­ä»£çš„æ–¹å¼åŒæ ·æ”¯æŒ

    await foreach (var num in GetIntsAsync())
    {
        Console.WriteLine("å¤–éƒ¨éå†äº†:{0}", num);
    }
    
    async IAsyncEnumerable<int> GetIntsAsync()
    {
        for (int i = 0; i < 5; i++)
        {
            await Task.Yield();
            Console.WriteLine("å†…éƒ¨éå†äº†:{0}", i);
            yield return i;
        }
    }
    

å’Œä¸Šé¢ä¸åŒçš„æ˜¯ï¼Œå¦‚æœéœ€è¦ç”¨å¼‚æ­¥çš„æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›`IAsyncEnumerable`ç±»å‹ï¼Œè¿™ç§æ–¹å¼çš„æ‰§è¡Œç»“æœå’Œä¸Šé¢åŒæ­¥çš„æ–¹å¼æ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œæˆ‘ä»¬å°±ä¸åšå±•ç¤ºäº†ã€‚ä¸Šé¢æˆ‘ä»¬çš„ç¤ºä¾‹éƒ½æ˜¯åŸºäºå¾ªç¯æŒç»­è¿­ä»£çš„ï¼Œå…¶å®ä½¿ç”¨`yield return`çš„æ–¹å¼è¿˜å¯ä»¥æŒ‰éœ€çš„æ–¹å¼å»è¾“å‡ºï¼Œè¿™ç§æ–¹å¼é€‚åˆçµæ´»è¿­ä»£çš„æ–¹å¼ã€‚å¦‚ä¸‹ç¤ºä¾‹æ‰€ç¤º

    foreach (var num in GetInts())
    {
        Console.WriteLine("å¤–éƒ¨éå†äº†:{0}", num);
    }
    
    IEnumerable<int> GetInts()
    {
        Console.WriteLine("å†…éƒ¨éå†äº†:0");
        yield return 0;
    
        Console.WriteLine("å†…éƒ¨éå†äº†:1");
        yield return 1;
    
        Console.WriteLine("å†…éƒ¨éå†äº†:2");
        yield return 2;
    }
    

`foreach`å¾ªç¯æ¯æ¬¡ä¼šè°ƒç”¨`GetInts()`æ–¹æ³•ï¼Œ`GetInts()`æ–¹æ³•çš„å†…éƒ¨ä¾¿ä½¿ç”¨`yield return`å…³é”®å­—è¿”å›ä¸€ä¸ªç»“æœã€‚æ¯æ¬¡éå†éƒ½ä¼šå»æ‰§è¡Œä¸‹ä¸€ä¸ª`yield return`ã€‚æ‰€ä»¥ä¸Šé¢ä»£ç è¾“å‡ºçš„ç»“æœæ˜¯

    å†…éƒ¨éå†äº†:0
    å¤–éƒ¨éå†äº†:0
    å†…éƒ¨éå†äº†:1
    å¤–éƒ¨éå†äº†:1
    å†…éƒ¨éå†äº†:2
    å¤–éƒ¨éå†äº†:2
    

### æ¢ç©¶æœ¬è´¨

ä¸Šé¢æˆ‘ä»¬å±•ç¤ºäº†`yield return`å¦‚ä½•ä½¿ç”¨çš„ç¤ºä¾‹ï¼Œå®ƒæ˜¯ä¸€ç§å»¶è¿ŸåŠ è½½çš„æœºåˆ¶ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬é€ä¸ªåœ°å¤„ç†æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åœ°å°†æ‰€æœ‰æ•°æ®è¯»å–åˆ°å†…å­˜ä¸­ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ¢ç©¶ä¸€ä¸‹ç¥å¥‡æ“ä½œçš„èƒŒååˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ–¹ä¾¿è®©å¤§å®¶æ›´æ¸…æ™°çš„äº†è§£è¿­ä»£ä½“ç³»ç›¸å…³ã€‚

#### foreachæœ¬è´¨

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`foreach`ä¸ºä»€ä¹ˆå¯ä»¥éå†ï¼Œä¹Ÿå°±æ˜¯å¦‚æœå¯ä»¥è¢«`foreach`éå†çš„å¯¹è±¡ï¼Œè¢«éå†çš„æ“ä½œéœ€è¦æ»¡è¶³å“ªäº›æ¡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åç¼–è¯‘å·¥å…·æ¥çœ‹ä¸€ä¸‹ç¼–è¯‘åçš„ä»£ç æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œç›¸ä¿¡å¤§å®¶æœ€ç†Ÿæ‚‰çš„å°±æ˜¯`List<T>`é›†åˆçš„éå†æ–¹å¼äº†,é‚£æˆ‘ä»¬å°±ç”¨`List<T>`çš„ç¤ºä¾‹æ¥æ¼”ç¤ºä¸€ä¸‹

    List<int> ints = new List<int>();
    foreach(int item in ints)
    {
        Console.WriteLine(item);
    }
    

ä¸Šé¢çš„è¿™æ®µä»£ç å¾ˆç®€å•ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰ç»™å®ƒä»»ä½•åˆå§‹åŒ–çš„æ•°æ®ï¼Œè¿™æ ·å¯ä»¥æ’é™¤å¹²æ‰°ï¼Œè®©æˆ‘ä»¬èƒ½æ›´æ¸…æ™°çš„çœ‹åˆ°åç¼–è¯‘çš„ç»“æœï¼Œæ’é™¤å…¶ä»–å¹²æ‰°ã€‚å®ƒåç¼–è¯‘åçš„ä»£ç æ˜¯è¿™æ ·çš„

    List<int> list = new List<int>();
    List<int>.Enumerator enumerator = list.GetEnumerator();
    try
    {
        while (enumerator.MoveNext())
        {
            int current = enumerator.Current;
            Console.WriteLine(current);
        }
    }
    finally
    {
        ((IDisposable)enumerator).Dispose();
    }
    

> å¯ä»¥åç¼–è¯‘ä»£ç çš„å·¥å…·æœ‰å¾ˆå¤šï¼Œæˆ‘ç”¨çš„æ¯”è¾ƒå¤šçš„ä¸€èˆ¬æ˜¯`ILSpy`ã€`dnSpy`ã€`dotPeek`å’Œåœ¨çº¿`c#`åç¼–è¯‘ç½‘ç«™[sharplab.io](https://sharplab.io/)ï¼Œå…¶ä¸­`dnSpy`è¿˜å¯ä»¥è°ƒè¯•åç¼–è¯‘çš„ä»£ç ã€‚

é€šè¿‡ä¸Šé¢çš„åç¼–è¯‘ä¹‹åçš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`foreach`ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªå›ºå®šçš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸æåŠçš„è®¾è®¡æ¨¡å¼ä¸­çš„è¿­ä»£å™¨æ¨¡å¼ç»“æ„

    Enumerator enumerator = list.GetEnumerator();
    while (enumerator.MoveNext())
    {
       var current = enumerator.Current;
    }
    

é€šè¿‡è¿™æ®µå›ºå®šçš„ç»“æ„æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹`foreach`çš„å·¥ä½œåŸç†

*   å¯ä»¥è¢«`foreach`çš„å¯¹è±¡éœ€è¦è¦åŒ…å«`GetEnumerator()`æ–¹æ³•
*   è¿­ä»£å™¨å¯¹è±¡åŒ…å«`MoveNext()`æ–¹æ³•å’Œ`Current`å±æ€§
*   `MoveNext()`æ–¹æ³•è¿”å›`bool`ç±»å‹ï¼Œåˆ¤æ–­æ˜¯å¦å¯ä»¥ç»§ç»­è¿­ä»£ã€‚`Current`å±æ€§è¿”å›å½“å‰çš„è¿­ä»£ç»“æœã€‚

æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹`List<T>`ç±»å¯è¿­ä»£çš„æºç ç»“æ„æ˜¯å¦‚ä½•å®ç°çš„

    public class List<T> : IList<T>, IList, IReadOnlyList<T>
    {
        public Enumerator GetEnumerator() => new Enumerator(this);
     
        IEnumerator<T> IEnumerable<T>.GetEnumerator() => Count == 0 ? SZGenericArrayEnumerator<T>.Empty : GetEnumerator();
     
        IEnumerator IEnumerable.GetEnumerator() => ((IEnumerable<T>)this).GetEnumerator();
    
        public struct Enumerator : IEnumerator<T>, IEnumerator
        {
            public T Current => _current!;
            public bool MoveNext()
            {
            }
        }
    }
    

è¿™é‡Œæ¶‰åŠåˆ°äº†ä¸¤ä¸ªæ ¸å¿ƒçš„æ¥å£`IEnumerable<`å’Œ`IEnumerator`ï¼Œä»–ä»¬ä¸¤ä¸ªå®šä¹‰äº†å¯ä»¥å®ç°è¿­ä»£çš„èƒ½åŠ›æŠ½è±¡ï¼Œå®ç°æ–¹å¼å¦‚ä¸‹

    public interface IEnumerable
    {
        IEnumerator GetEnumerator();
    }
    
    public interface IEnumerator
    {
        bool MoveNext();
        object Current{ get; }
        void Reset();
    }
    

å¦‚æœç±»å®ç°`IEnumerable`æ¥å£å¹¶å®ç°äº†`GetEnumerator()`æ–¹æ³•ä¾¿å¯ä»¥è¢«`foreach`ï¼Œè¿­ä»£çš„å¯¹è±¡æ˜¯`IEnumerator`ç±»å‹ï¼ŒåŒ…å«ä¸€ä¸ª`MoveNext()`æ–¹æ³•å’Œ`Current`å±æ€§ã€‚ä¸Šé¢çš„æ¥å£æ˜¯åŸå§‹å¯¹è±¡çš„æ–¹å¼ï¼Œè¿™ç§æ“ä½œéƒ½æ˜¯é’ˆå¯¹`object`ç±»å‹é›†åˆå¯¹è±¡ã€‚æˆ‘ä»¬å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¤§å¤šæ•°éƒ½æ˜¯ä½¿ç”¨çš„æ³›å‹é›†åˆï¼Œå½“ç„¶ä¹Ÿæœ‰å¯¹åº”çš„å®ç°æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤º

    public interface IEnumerable<out T> : IEnumerable
    {
        new IEnumerator<T> GetEnumerator();
    }
    
    public interface IEnumerator<out T> : IDisposable, IEnumerator
    {
        new T Current{ get; }
    }
    

> å¯ä»¥è¢«`foreach`è¿­ä»£å¹¶ä¸æ„å‘³ç€ä¸€å®šè¦å»å®ç°`IEnumerable`æ¥å£ï¼Œè¿™åªæ˜¯ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¯ä»¥è¢«è¿­ä»£çš„æŠ½è±¡çš„èƒ½åŠ›ã€‚åªè¦ç±»ä¸­åŒ…å«`GetEnumerator()`æ–¹æ³•å¹¶è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¿­ä»£å™¨é‡ŒåŒ…å«è¿”å›`bool`ç±»å‹çš„`MoveNext()`æ–¹æ³•å’Œè·å–å½“å‰è¿­ä»£å¯¹è±¡çš„`Current`å±æ€§å³å¯ã€‚

#### yield returnæœ¬è´¨

ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†å¯ä»¥è¢«`foreach`è¿­ä»£çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆ`yield return`çš„è¿”å›å€¼å¯ä»¥è¢«`IEnumerable<T>`æ¥æ”¶è¯´æ˜å…¶ä¸­å¿…æœ‰è¹Šè··ï¼Œæˆ‘ä»¬åç¼–è¯‘ä¸€ä¸‹æˆ‘ä»¬ä¸Šé¢çš„ç¤ºä¾‹çœ‹ä¸€ä¸‹åç¼–è¯‘ä¹‹åä»£ç ï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶å¯¹æ¯”åç¼–è¯‘ç»“æœï¼Œè¿™é‡Œæˆ‘æŠŠä¸Šé¢çš„ç¤ºä¾‹å†æ¬¡ç²˜è´´ä¸€ä¸‹

    foreach (var num in GetInts())
    {
        Console.WriteLine("å¤–éƒ¨éå†äº†:{0}", num);
    }
    
    IEnumerable<int> GetInts()
    {
        for (int i = 0; i < 5; i++)
        {
            Console.WriteLine("å†…éƒ¨éå†äº†:{0}", i);
            yield return i;
        }
    }
    

å®ƒçš„åç¼–è¯‘ç»“æœï¼Œè¿™é‡Œå’±ä»¬å°±ä¸å…¨éƒ¨å±•ç¤ºäº†ï¼Œåªå±•ç¤ºä¸€ä¸‹æ ¸å¿ƒçš„é€»è¾‘

    //foeachç¼–è¯‘åçš„ç»“æœ
    IEnumerator<int> enumerator = GetInts().GetEnumerator();
    try
    {
        while (enumerator.MoveNext())
        {
            int current = enumerator.Current;
            Console.WriteLine("å¤–éƒ¨éå†äº†:{0}", current);
        }
    }
    finally
    {
        if (enumerator != null)
        {
            enumerator.Dispose();
        }
    }
    
    //GetIntsæ–¹æ³•ç¼–è¯‘åçš„ç»“æœ
    private IEnumerable<int> GetInts()
    {
        <GetInts>d__1 <GetInts>d__ = new <GetInts>d__1(-2);
        <GetInts>d__.<>4__this = this;
        return <GetInts>d__;
    }
    

è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`GetInts()`æ–¹æ³•é‡ŒåŸæ¥çš„ä»£ç ä¸è§äº†ï¼Œè€Œæ˜¯å¤šäº†ä¸€ä¸ª`<GetInts>d__1` lç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´`yield return`æœ¬è´¨æ˜¯`è¯­æ³•ç³–`ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹`<GetInts>d__1`ç±»çš„å®ç°

    //ç”Ÿæˆçš„ç±»å³å®ç°äº†IEnumerableæ¥å£ä¹Ÿå®ç°äº†IEnumeratoræ¥å£
    //è¯´æ˜å®ƒæ—¢åŒ…å«äº†GetEnumerator()æ–¹æ³•ï¼Œä¹ŸåŒ…å«MoveNext()æ–¹æ³•å’ŒCurrentå±æ€§
    private sealed class <>GetIntsd__1 : IEnumerable<int>, IEnumerable, IEnumerator<int>, IEnumerator, IDisposable
    {
        private int <>1__state;
        //å½“å‰è¿­ä»£ç»“æœ
        private int <>2__current;
        private int <>l__initialThreadId;
        public C <>4__this;
        private int <i>5__1;
    
        //å½“å‰è¿­ä»£åˆ°çš„ç»“æœ
        int IEnumerator<int>.Current
        {
            get{ return <>2__current; }
        }
    
        //å½“å‰è¿­ä»£åˆ°çš„ç»“æœ
        object IEnumerator.Current
        {
            get{ return <>2__current; }
        }
    
        //æ„é€ å‡½æ•°åŒ…å«çŠ¶æ€å­—æ®µï¼Œå˜å‘è¯´æ˜é çŠ¶æ€æœºå»å®ç°æ ¸å¿ƒæµç¨‹æµè½¬
        public <GetInts>d__1(int <>1__state)
        {
            this.<>1__state = <>1__state;
            <>l__initialThreadId = Environment.CurrentManagedThreadId;
        }
    
        //æ ¸å¿ƒæ–¹æ³•MoveNext
        private bool MoveNext()
        {
            int num = <>1__state;
            if (num != 0)
            {
                if (num != 1)
                {
                    return false;
                }
                //æ§åˆ¶çŠ¶æ€
                <>1__state = -1;
                //è‡ªå¢ ä¹Ÿå°±æ˜¯ä»£ç é‡Œå¾ªç¯çš„i++
                <i>5__1++;
            }
            else
            {
                <>1__state = -1;
                <i>5__1 = 0;
            }
            //å¾ªç¯ç»ˆæ­¢æ¡ä»¶ ä¸Šé¢å¾ªç¯é‡Œçš„i<5
            if (<i>5__1 < 5)
            {
                Console.WriteLine("å†…éƒ¨éå†äº†:{0}", <i>5__1);
                //æŠŠå½“å‰è¿­ä»£ç»“æœèµ‹å€¼ç»™Currentå±æ€§
                <>2__current = <i>5__1;
                <>1__state = 1;
                //è¯´æ˜å¯ä»¥ç»§ç»­è¿­ä»£
                return true;
            }
            //è¿­ä»£ç»“æŸ
            return false;
        }
    
        //IEnumeratorçš„MoveNextæ–¹æ³•
        bool IEnumerator.MoveNext()
        {
            return this.MoveNext();
        }
    
        //IEnumerableçš„IEnumerableæ–¹æ³•
        IEnumerator<int> IEnumerable<int>.IEnumerable()
        {
            //å®ä¾‹åŒ–<GetInts>d__1å®ä¾‹
            <GetInts>d__1 <GetInts>d__;
            if (<>1__state == -2 && <>l__initialThreadId == Environment.CurrentManagedThreadId)
            {
                <>1__state = 0;
                <GetInts>d__ = this;
            }
            else
            {
                //ç»™çŠ¶æ€æœºåˆå§‹åŒ–
                <GetInts>d__ = new <GetInts>d__1(0);
                <GetInts>d__.<>4__this = <>4__this;
            }
            //å› ä¸º<GetInts>d__1å®ç°äº†IEnumeratoræ¥å£æ‰€ä»¥å¯ä»¥ç›´æ¥è¿”å›
            return <GetInts>d__;
        }
    
        IEnumerator IEnumerable.GetEnumerator()
        {
            //å› ä¸º<GetInts>d__1å®ç°äº†IEnumeratoræ¥å£æ‰€ä»¥å¯ä»¥ç›´æ¥è½¬æ¢
            return ((IEnumerable<int>)this).GetEnumerator();
        }
    
        void IEnumerator.Reset()
        {
        }
    
        void IDisposable.Dispose()
        {
        }
    }
    

é€šè¿‡å®ƒç”Ÿæˆçš„ç±»æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ç±»å³å®ç°äº†`IEnumerable`æ¥å£ä¹Ÿå®ç°äº†`IEnumerator`æ¥å£è¯´æ˜å®ƒæ—¢åŒ…å«äº†`GetEnumerator()`æ–¹æ³•ï¼Œä¹ŸåŒ…å«`MoveNext()`æ–¹æ³•å’Œ`Current`å±æ€§ã€‚ç”¨è¿™ä¸€ä¸ªç±»å°±å¯ä»¥æ»¡è¶³å¯è¢«`foeach`è¿­ä»£çš„æ ¸å¿ƒç»“æ„ã€‚æˆ‘ä»¬æ‰‹åŠ¨å†™çš„`for`ä»£ç è¢«åŒ…å«åˆ°äº†`MoveNext()`æ–¹æ³•é‡Œï¼Œå®ƒåŒ…å«äº†å®šä¹‰çš„çŠ¶æ€æœºåˆ¶ä»£ç ï¼Œå¹¶ä¸”æ ¹æ®å½“å‰çš„çŠ¶æ€æœºä»£ç å°†è¿­ä»£ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å¤§æ¦‚è®²è§£ä¸€ä¸‹æˆ‘ä»¬çš„`for`ä»£ç è¢«ç¿»è¯‘åˆ°`MoveNext()`æ–¹æ³•é‡Œçš„æ‰§è¡Œæµç¨‹

*   é¦–æ¬¡è¿­ä»£æ—¶`<>1__state`è¢«åˆå§‹åŒ–æˆ0ï¼Œä»£è¡¨é¦–ä¸ªè¢«è¿­ä»£çš„å…ƒç´ ï¼Œè¿™ä¸ªæ—¶å€™`Current`åˆå§‹å€¼ä¸º0ï¼Œå¾ªç¯æ§åˆ¶å˜é‡`<i>5__1`åˆå§‹å€¼ä¹Ÿä¸º0ã€‚
*   åˆ¤æ–­æ˜¯å¦æ»¡è¶³ç»ˆæ­¢æ¡ä»¶ï¼Œä¸æ»¡è¶³åˆ™æ‰§è¡Œå¾ªç¯é‡Œçš„é€»è¾‘ã€‚å¹¶æ›´æ”¹è£…å¡«æœº`<>1__state`ä¸º1ï¼Œä»£è¡¨é¦–æ¬¡è¿­ä»£æ‰§è¡Œå®Œæˆã€‚
*   å¾ªç¯æ§åˆ¶å˜é‡`<i>5__1`ç»§ç»­è‡ªå¢å¹¶æ›´æ”¹å¹¶æ›´æ”¹è£…å¡«æœº`<>1__state`ä¸º-1ï¼Œä»£è¡¨å¯æŒç»­è¿­ä»£ã€‚å¹¶å¾ªç¯æ‰§è¡Œå¾ªç¯ä½“çš„è‡ªå®šä¹‰é€»è¾‘ã€‚
*   ä¸æ»¡è¶³è¿­ä»£æ¡ä»¶åˆ™è¿”å›`false`,ä¹Ÿå°±æ˜¯ä»£è¡¨äº†`MoveNext()`ä»¥ä¸æ»¡è¶³è¿­ä»£æ¡ä»¶`while (enumerator.MoveNext())`é€»è¾‘ç»ˆæ­¢ã€‚

ä¸Šé¢æˆ‘ä»¬è¿˜å±•ç¤ºäº†å¦ä¸€ç§`yield return`çš„æ–¹å¼ï¼Œå°±æ˜¯åŒä¸€ä¸ªæ–¹æ³•é‡ŒåŒ…å«å¤šä¸ª`yield return`çš„å½¢å¼

    IEnumerable<int> GetInts()
    {
        Console.WriteLine("å†…éƒ¨éå†äº†:0");
        yield return 0;
    
        Console.WriteLine("å†…éƒ¨éå†äº†:1");
        yield return 1;
    
        Console.WriteLine("å†…éƒ¨éå†äº†:2");
        yield return 2;
    }
    

ä¸Šé¢è¿™æ®µä»£ç åç¼–è¯‘çš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™é‡Œå’±ä»¬åªå±•ç¤ºæ ¸å¿ƒçš„æ–¹æ³•`MoveNext()`çš„å®ç°

    private bool MoveNext()
    {
        switch (<>1__state)
        {
            default:
                return false;
            case 0:
                <>1__state = -1;
                Console.WriteLine("å†…éƒ¨éå†äº†:0");
                <>2__current = 0;
                <>1__state = 1;
                return true;
            case 1:
                <>1__state = -1;
                Console.WriteLine("å†…éƒ¨éå†äº†:1");
                <>2__current = 1;
                <>1__state = 2;
                return true;
            case 2:
                <>1__state = -1;
                Console.WriteLine("å†…éƒ¨éå†äº†:2");
                <>2__current = 2;
                <>1__state = 3;
                return true;
            case 3:
                <>1__state = -1;
                return false;
        }
    }
    

é€šè¿‡ç¼–è¯‘åçš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¤šä¸ª`yield return`çš„å½¢å¼ä¼šè¢«ç¼–è¯‘æˆ`switch...case`çš„å½¢å¼ï¼Œæœ‰å‡ ä¸ª`yield return`åˆ™ä¼šç¼–è¯‘æˆ`n+1`ä¸ª`case`ï¼Œå¤šå‡ºæ¥çš„ä¸€ä¸ª`case`åˆ™ä»£è¡¨çš„`MoveNext()`ç»ˆæ­¢æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¿”å›`false`çš„æ¡ä»¶ã€‚å…¶å®ƒçš„`case`åˆ™è¿”å›`true`è¡¨ç¤ºå¯ä»¥ç»§ç»­è¿­ä»£ã€‚

#### IAsyncEnumerableæ¥å£

ä¸Šé¢æˆ‘ä»¬å±•ç¤ºäº†åŒæ­¥`yield return`æ–¹å¼ï¼Œ`c# 8`å¼€å§‹æ–°å¢äº†`IAsyncEnumerable<T>`æ¥å£ï¼Œç”¨äºå®Œæˆå¼‚æ­¥è¿­ä»£ï¼Œä¹Ÿå°±æ˜¯è¿­ä»£å™¨é€»è¾‘é‡ŒåŒ…å«å¼‚æ­¥é€»è¾‘çš„åœºæ™¯ã€‚`IAsyncEnumerable<T>`æ¥å£çš„å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤º

    public interface IAsyncEnumerable<out T>
    {
        IAsyncEnumerator<T> GetAsyncEnumerator(CancellationToken cancellationToken = default);
    }
    
    public interface IAsyncEnumerator<out T> : IAsyncDisposable
    {
        ValueTask<bool> MoveNextAsync();
        T Current { get; }
    }
    

å®ƒæœ€å¤§çš„ä¸åŒåˆ™æ˜¯åŒæ­¥çš„`IEnumerator`åŒ…å«çš„æ˜¯`MoveNext()`æ–¹æ³•è¿”å›çš„æ˜¯`bool`ï¼Œ`IAsyncEnumerator`æ¥å£åŒ…å«çš„æ˜¯`MoveNextAsync()`å¼‚æ­¥æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯`ValueTask<bool>`ç±»å‹ã€‚æ‰€ä»¥ä¸Šé¢çš„ç¤ºä¾‹ä»£ç 

    await foreach (var num in GetIntsAsync())
    {
        Console.WriteLine("å¤–éƒ¨éå†äº†:{0}", num);
    }
    

æ‰€ä»¥è¿™é‡Œçš„`await`è™½ç„¶æ˜¯åŠ åœ¨`foreach`ä¸Šé¢ï¼Œä½†æ˜¯å®é™…ä½œç”¨çš„åˆ™æ˜¯æ¯ä¸€æ¬¡è¿­ä»£æ‰§è¡Œçš„`MoveNextAsync()`æ–¹æ³•ã€‚å¯ä»¥å¤§è‡´ç†è§£ä¸ºä¸‹é¢çš„å·¥ä½œæ–¹å¼

    IAsyncEnumerator<int> enumerator = list.GetAsyncEnumerator();
    while (enumerator.MoveNextAsync().GetAwaiter().GetResult())
    {
       var current = enumerator.Current;
    }
    

å½“ç„¶ï¼Œå®é™…ç¼–è¯‘æˆçš„ä»£ç å¹¶ä¸æ˜¯è¿™ä¸ªæ ·å­çš„ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰çš„æ–‡ç« <[ç ”ç©¶c#å¼‚æ­¥æ“ä½œasync awaitçŠ¶æ€æœºçš„æ€»ç»“](https://www.cnblogs.com/wucy/p/17137128.html)\>ä¸€æ–‡ä¸­è®²è§£è¿‡`async await`ä¼šè¢«ç¼–è¯‘æˆ`IAsyncStateMachine`å¼‚æ­¥çŠ¶æ€æœºï¼Œæ‰€ä»¥`IAsyncEnumerator<T>`ç»“åˆ`yield return`çš„å®ç°æ¯”åŒæ­¥çš„æ–¹å¼æ›´åŠ å¤æ‚è€Œä¸”åŒ…å«æ›´å¤šçš„ä»£ç ï¼Œä¸è¿‡å®ç°åŸç†å¯ä»¥ç»“åˆåŒæ­¥çš„æ–¹å¼ç±»æ¯”ä¸€ä¸‹ï¼Œä½†æ˜¯è¦åŒæ—¶äº†è§£å¼‚æ­¥çŠ¶æ€æœºçš„å®ç°ï¼Œè¿™é‡Œå’±ä»¬å°±ä¸è¿‡å¤šå±•ç¤º`å¼‚æ­¥yield return`çš„ç¼–è¯‘åå®ç°äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œäº†è§£ä¸€ä¸‹ã€‚

#### foreachå¢å¼º

`c# 9`å¢åŠ äº†å¯¹foreachçš„å¢å¼ºçš„åŠŸèƒ½ï¼Œå³é€šè¿‡æ‰©å±•æ–¹æ³•çš„å½¢å¼ï¼Œå¯¹åŸæœ¬å…·å¤‡åŒ…å«`foreach`èƒ½åŠ›çš„å¯¹è±¡å¢åŠ `GetEnumerator()`æ–¹æ³•ï¼Œä½¿å¾—æ™®é€šç±»åœ¨ä¸å…·å¤‡`foreach`çš„èƒ½åŠ›çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨æ¥è¿­ä»£ã€‚å®ƒçš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹

    Foo foo = new Foo();
    foreach (int item in foo)
    {
        Console.WriteLine(item);
    }
    
    public class Foo
    {
        public List<int> Ints { get; set; } = new List<int>();
    }
    
    public static class Bar
    {
        //ç»™Fooå®šä¹‰æ‰©å±•æ–¹æ³•
        public static IEnumerator<int> GetEnumerator(this Foo foo)
        {
            foreach (int item in foo.Ints)
            {
                yield return item;
            }
        }
    }
    

è¿™ä¸ªåŠŸèƒ½ç¡®å®æ¯”è¾ƒå¼ºå¤§ï¼Œæ»¡è¶³å¼€æ”¾å°é—­åŸåˆ™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¿®æ”¹åŸå§‹ä»£ç çš„æƒ…å†µï¼Œå¢å¼ºä»£ç çš„åŠŸèƒ½ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸çš„å®ç”¨ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ç¼–è¯‘åçš„ç»“æœæ˜¯å•¥

    Foo foo = new Foo();
    IEnumerator<int> enumerator = Bar.GetEnumerator(foo);
    try
    {
        while (enumerator.MoveNext())
        {
            int current = enumerator.Current;
            Console.WriteLine(current);
        }
    }
    finally
    {
        if (enumerator != null)
        {
            enumerator.Dispose();
        }
    }
    

è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°æ‰©å±•æ–¹æ³•`GetEnumerator()`æœ¬è´¨ä¹Ÿæ˜¯è¯­æ³•ç³–ï¼Œä¼šæŠŠæ‰©å±•èƒ½åŠ›ç¼–è¯‘æˆ`æ‰©å±•ç±».GetEnumerator(è¢«æ‰©å±•å®ä¾‹)`çš„æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™ä»£ç æ—¶å€™çš„åŸå§‹æ–¹å¼ï¼Œåªæ˜¯ç¼–è¯‘å™¨å¸®æˆ‘ä»¬ç”Ÿæˆäº†å®ƒçš„è°ƒç”¨æ–¹å¼ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹`GetEnumerator()`æ‰©å±•æ–¹æ³•ç¼–è¯‘æˆäº†ä»€ä¹ˆ

    public static IEnumerator<int> GetEnumerator(Foo foo)
    {
        <GetEnumerator>d__0 <GetEnumerator>d__ = new <GetEnumerator>d__0(0);
        <GetEnumerator>d__.foo = foo;
        return <GetEnumerator>d__;
    }
    

çœ‹åˆ°è¿™ä¸ªä»£ç æ˜¯ä¸æ˜¯è§‰å¾—å¾ˆçœ¼ç†Ÿäº†ï¼Œä¸é”™å’Œä¸Šé¢`yield returnæœ¬è´¨`è¿™ä¸€èŠ‚é‡Œè®²åˆ°çš„è¯­æ³•ç³–ç”Ÿæˆæ–¹å¼æ˜¯ä¸€æ ·çš„äº†ï¼ŒåŒæ ·çš„ç¼–è¯‘æ—¶å€™ä¹Ÿæ˜¯ç”Ÿæˆäº†ä¸€ä¸ªå¯¹åº”ç±»ï¼Œè¿™é‡Œçš„ç±»æ˜¯`<GetEnumerator>d__0`,æˆ‘ä»¬çœ‹ä¸€ä¸‹è¯¥ç±»çš„ç»“æ„

    private sealed class <GetEnumerator>d__0 : IEnumerator<int>, IEnumerator, IDisposable
    {
        private int <>1__state;
        private int <>2__current;
        public Foo foo;
        private List<int>.Enumerator <>s__1;
        private int <item>5__2;
    
        int IEnumerator<int>.Current
        {
            get{ return <>2__current; }
        }
    
        object IEnumerator.Current
        {
            get{ return <>2__current; }
        }
    
        public <GetEnumerator>d__0(int <>1__state)
        {
            this.<>1__state = <>1__state;
        }
    
        private bool MoveNext()
        {
            try
            {
                int num = <>1__state;
                if (num != 0)
                {
                    if (num != 1)
                    {
                        return false;
                    }
                    <>1__state = -3;
                }
                else
                {
                    <>1__state = -1;
                    //å› ä¸ºç¤ºä¾‹ä¸­çš„Intsæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯List<T>
                    <>s__1 = foo.Ints.GetEnumerator();
                    <>1__state = -3;
                }
                //å› ä¸ºä¸Šé¢çš„æ‰©å±•æ–¹æ³•é‡Œä½¿ç”¨çš„æ˜¯foreachéå†æ–¹å¼
                //è¿™é‡Œä¹Ÿè¢«ç¼–è¯‘æˆäº†å®é™…ç”Ÿäº§æ–¹å¼
                if (<>s__1.MoveNext())
                {
                    <item>5__2 = <>s__1.Current;
                    <>2__current = <item>5__2;
                    <>1__state = 1;
                    return true;
                }
                <>m__Finally1();
                <>s__1 = default(List<int>.Enumerator);
                return false;
            }
            catch
            {
                ((IDisposable)this).Dispose();
                throw;
            }
        }
    
        bool IEnumerator.MoveNext()
        {
            return this.MoveNext();
        }
    
        void IDisposable.Dispose()
        {
        }
    
        void IEnumerator.Reset()
        {
        }
    
        private void <>m__Finally1()
        {
        }
    }
    

çœ‹åˆ°ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`yield return`ç”Ÿæˆçš„ä»£ç ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯`MoveNext()`é‡Œçš„é€»è¾‘å–å†³äºæˆ‘ä»¬å†™ä»£ç æ—¶å€™çš„å…·ä½“é€»è¾‘ï¼Œä¸åŒçš„é€»è¾‘ç”Ÿæˆä¸åŒçš„ä»£ç ã€‚è¿™é‡Œå’±ä»¬å°±ä¸åœ¨è®²è§£å®ƒç”Ÿæˆçš„ä»£ç äº†ï¼Œå› ä¸ºå’Œä¸Šé¢å’±ä»¬è®²è§£çš„ä»£ç é€»è¾‘æ˜¯å·®ä¸å¤šçš„ã€‚

### æ€»ç»“

Â Â Â Â é€šè¿‡æœ¬æ–‡æˆ‘ä»¬ä»‹ç»äº†`c#`ä¸­çš„`yield return`è¯­æ³•ï¼Œå¹¶æ¢è®¨äº†ç”±å®ƒå¸¦æ¥çš„ä¸€äº›æ€è€ƒã€‚æˆ‘ä»¬é€šè¿‡ä¸€äº›ç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºäº†`yield return`çš„ä½¿ç”¨æ–¹å¼ï¼ŒçŸ¥é“äº†è¿­ä»£å™¨æ¥æ˜¯å¦‚ä½•æŒ‰éœ€å¤„ç†å¤§é‡æ•°æ®ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡åˆ†æ`foreach`è¿­ä»£å’Œ`yield return`è¯­æ³•çš„æœ¬è´¨ï¼Œè®²è§£äº†å®ƒä»¬çš„å®ç°åŸç†å’Œåº•å±‚æœºåˆ¶ã€‚å¥½åœ¨æ¶‰åŠåˆ°çš„çŸ¥è¯†æ•´ä½“æ¯”è¾ƒç®€å•ï¼Œä»”ç»†é˜…è¯»ç›¸å…³å®ç°ä»£ç çš„è¯ç›¸ä¿¡ä¼šäº†è§£èƒŒåçš„å®ç°åŸç†ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚

Â Â Â Â å½“ä½ é‡åˆ°æŒ‘æˆ˜å’Œå›°éš¾æ—¶ï¼Œè¯·ä¸è¦è½»æ˜“æ”¾å¼ƒã€‚æ— è®ºä½ é¢å¯¹çš„æ˜¯ä»€ä¹ˆï¼Œåªè¦ä½ è‚¯åŠªåŠ›å»å°è¯•ï¼Œå»æ¢ç´¢ï¼Œå»è¿½æ±‚ï¼Œä½ ä¸€å®šèƒ½å¤Ÿå…‹æœå›°éš¾ï¼Œèµ°å‘æˆåŠŸã€‚è®°ä½ï¼ŒæˆåŠŸä¸æ˜¯ä¸€è¹´è€Œå°±çš„ï¼Œå®ƒéœ€è¦æˆ‘ä»¬ä¸æ–­åŠªåŠ›å’ŒåšæŒã€‚ç›¸ä¿¡è‡ªå·±ï¼Œç›¸ä¿¡è‡ªå·±çš„èƒ½åŠ›ï¼Œç›¸ä¿¡è‡ªå·±çš„æ½œåŠ›ï¼Œä½ ä¸€å®šèƒ½å¤Ÿæˆä¸ºæ›´å¥½çš„è‡ªå·±ã€‚  
  

ğŸ‘‡æ¬¢è¿æ‰«ç å…³æ³¨æˆ‘çš„å…¬ä¼—å·ğŸ‘‡ ![](https://img2020.cnblogs.com/blog/2042116/202006/2042116-20200622133425514-1420050576.png)