---
layout: post
title: "ç”¨å£°æ˜å¼å®è§£æ Rust è¯­æ³•"
date: "2023-06-17T01:10:33.761Z"
---
ç”¨å£°æ˜å¼å®è§£æ Rust è¯­æ³•
---------------

åœ¨ä¸Šä¸€ç¯‡ [Rust å£°æ˜å¼å®ä¸­çš„ Metavariables æœ‰å“ªäº›](https://mp.weixin.qq.com/s/xIwW5h-T7PoKMyEVReIUUw) çš„åŸºç¡€ä¸Šï¼Œ  
ä»Šå¤©å°è¯•è§£æä¸€ä¸‹ Rust ä¸­çš„å‡ ç§ itemã€‚æˆ‘ä»¬çŸ¥é“ä¸€ä¸ª crate æ˜¯ç”± item ç»„æˆçš„ï¼Œæ¯ä¸€ä¸ª `fn` `struct` `enum` `impl` `mod` ç­‰å®šä¹‰éƒ½æ˜¯ä¸€ä¸ª itemï¼Œ  
è¿™ç¯‡æ–‡ç« å°±ç®€å•è§£æä¸€ä¸‹ `Function` å’Œ `struct`

Function
--------

å…ˆçœ‹ä¸€ä¸ªæœ€ç®€å•çš„å‡½æ•°

    fn foo() {}
    

è¿™ä¸ª `foo` å‡½æ•°ç”±å…³é”®å­— `fn` å¼€å¤´ï¼Œåé¢è·Ÿä¸€ä¸ªå‡½æ•°å($function\_name: ident), ç„¶åæ˜¯ä¸€å¯¹ `()`, å†è·Ÿä¸€ä¸ªå‡½æ•°ä½“ `block`

    macro_rules! function_item_matcher {
        (fn $name: ident () $block: block) => {
            fn $name() $block
        };
    }
    
    function_item_matcher! {
        fn hello(){
            println!("hello");
        }
    }
    

å†å¤æ‚ä¸€ç‚¹ï¼Œç»™æˆ‘ä»¬çš„ `foo` å‡½æ•°åŠ ç‚¹æ–™

    #[allow(unused_variables)]
    pub async fn foo(arg1: u8) -> u8 { arg1 }
    

æˆ‘ä»¬çš„ `foo` å‡½æ•°å·²ç»å…·å¤‡äº†å¸¸è§å‡½æ•°çš„åŸºæœ¬å½¢æ€ï¼Œé™¤äº†æ²¡æœ‰æ³›å‹ç­‰æ¯”è¾ƒå¤æ‚çš„éƒ¨åˆ†ï¼Œè¿™é‡Œäº†è§£åˆ†ææ–¹æ³•å°±è¡Œï¼Œæœ‰éœ€è¦çš„è¯å†ç»§ç»­æŠ½ä¸å‰¥èŒ§å³å¯ã€‚  
å®Œæ•´çš„ `Function` çš„è¯­æ³•å®šä¹‰çœ‹è¿™é‡Œ: [https://doc.rust-lang.org/reference/items/functions.html](https://doc.rust-lang.org/reference/items/functions.html)

    macro_rules! function_item_matcher {
        (
            #[$meta: meta]
            $vis: vis async fn $name: ident ($arg: ident : $ty: ty) -> $ret:ty $block: block
        ) => {
            #[$meta]
            $vis async fn $name($arg: $ty) -> $ret $block
        };
    }
    

å¦‚æœ meta çš„ä¸ªæ•°å’Œ argument çš„ä¸ªæ•°éƒ½ä¸ç¡®å®šå‘¢

    #[allow(unused_variables)]
    #[allow(dead_code)]
    pub async fn foo(arg1: u8, arg2: u32, ) -> u8 { arg1 }
    

å¥½ï¼Œé‚£å°±å†æ”¹ä¸€æ”¹:

    macro_rules! function_item_matcher {
        (
            $(#[$meta: meta])*
            $vis: vis async fn $name: ident ($($arg: ident : $ty: ty),* $(,)?) -> $ret:ty $block: block
        ) => {
            $(#[$meta])*
            $vis async fn $name($($arg: $ty),*) -> $ret $block
        };
    }
    

è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œè¿™ä¸ª async ç›´æ¥å†™ä¸‹æ¥çš„ï¼Œè¦æ˜¯æ²¡æœ‰ async å‘¢? åªéœ€è¦åŠ ä¸€ä¸ªåˆ†æ”¯å°±å¥½

    macro_rules! function_item_matcher {
        (
            $(#[$meta: meta])*
            $vis: vis async fn $name: ident ($($arg: ident : $ty: ty),* $(,)?) -> $ret:ty $block: block
        ) => {
            $(#[$meta])*
            $vis async fn $name($($arg: $ty),*) -> $ret $block
        };
    
        (
            $(#[$meta: meta])*
            $vis: vis fn $name: ident ($($arg: ident : $ty: ty),* $(,)?) -> $ret:ty $block: block
        ) => {
            $(#[$meta])*
            $vis fn $name($($arg: $ty),*) -> $ret $block
        };
    }
    

è¿™æ ·åšä¸è¿‡æ˜¯æŠŠæˆ‘å®šä¹‰çš„å‡½æ•°ç…§æ¬ä¸‹æ¥ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿå¥½å¤„å°±æ˜¯ä½ å¯ä»¥éšæ„æ’å…¥è‡ªå·±çš„ä»£ç 

    macro_rules! function_item_matcher {
        (
            $(#[$meta: meta])*
            $vis: vis fn $name: ident ($($arg: ident : $ty: ty),* $(,)?) -> $ret:ty $block: block
        ) => {
            println!("definition: {}({})", stringify!($name), stringify!($($arg: $ty),*));
            $(#[$meta])*
            $vis fn $name($($arg: $ty),*) -> $ret {
                print!("calling: {}(", stringify!($name));
                $(print!("{},", $arg);)*
                println!(")");
    
                $block
            }
        };
    }
    
    function_item_matcher!{
        #[allow(unused_variables)]
        #[allow(dead_code)]
        pub fn foo(arg1: u8, arg2: u32, ) -> u8 { arg1 }
    }
    
    foo(9, 8);
    

è¾“å‡º

    definition: foo(arg1 : u8, arg2 : u32)
    calling: foo(9,8,)
    

struct
------

[struct](https://doc.rust-lang.org/reference/items/structs.html) æœ‰ä¸¤ç§

    // struct struct
    #[...]
    struct A {
        ...
    }
    
    // tuple struct
    #[...]
    struct B(...);
    

æ‰€ä»¥å¯¹äºç¬¬ä¸€ç§:

    macro_rules! struct_item_matcher {
        (
            $(#[$meta: meta])*
            $vis: vis struct $name: ident {
                $(
                    $(#[$field_meta: meta])*
                    $field_vis: vis $field_name: ident : $field_ty: ty
                ),*
    
                $(,)?
            }
        ) => {
            $(#[$meta])*
            $vis struct $name {
                $(
                    $(#[$field_meta])*
                    $field_vis $field_name: $field_ty
                ),*
            }
        };
    
        // é’ˆå¯¹ struct A; çš„æƒ…å†µ
        (
            $(#[$meta: meta])*
            $vis: vis struct $name: ident;
        ) => {
            $(#[$meta])*
            $vis struct $name;
        }
    }
    

å¯¹äºç¬¬äºŒç§ `tuple struct` çš„æƒ…å†µå¤„ç†èµ·æ¥å¤§åŒå°å¼‚ï¼Œæˆ‘å°±ä¸å†™äº† ğŸ˜‚

![](https://img2023.cnblogs.com/blog/342816/202306/342816-20230614182318243-1514579333.png)

+V d2h5X251bGw= è¯·å¤‡æ³¨ï¼šfromåšå®¢å›­

posted on 2023-06-16 18:31Â  [æ˜å¤©æœ‰é£å¹](https://www.cnblogs.com/hangj/)Â  é˜…è¯»(83)Â  è¯„è®º(0)Â  [ç¼–è¾‘](https://i.cnblogs.com/EditPosts.aspx?postid=17486291)Â  [æ”¶è—](javascript:void(0))Â  [ä¸¾æŠ¥](javascript:void(0))