---
layout: post
title: "ã€Pythonã€‘sqlmodel: Python æ•°æ®åº“ç®¡ç†ORM çš„ç»ˆæå½¢æ€ï¼Ÿ"
date: "2023-06-07T01:21:28.294Z"
---
ã€Pythonã€‘sqlmodel: Python æ•°æ®åº“ç®¡ç†ORM çš„ç»ˆæå½¢æ€ï¼Ÿ
========================================

![ã€Pythonã€‘sqlmodel: Python æ•°æ®åº“ç®¡ç†ORM çš„ç»ˆæå½¢æ€ï¼Ÿ](https://img2023.cnblogs.com/blog/1172048/202306/1172048-20230606202444878-1803738506.png) ä½¿ç”¨ è¶…è½»é‡çº§çš„ORM æ¡†æ¶ sqlmodel ï¼Œç»“åˆ mixins å°è£…ç»™ FastAPI è¿™åªè™æ·»ä¸Šç¿…è†€ï¼Œè®©æ¥å£åŠŸèƒ½å¼€å‘æ›´å®¹æ˜“ã€‚

ORM
---

å¤§å®¶éƒ½çŸ¥é“ORMï¼ˆObject Relational Mappingï¼‰æ˜¯ä¸€ç§å°†å¯¹è±¡å’Œå…³ç³»æ•°æ®åº“ä¸­çš„è¡¨è¿›è¡Œæ˜ å°„çš„æŠ€æœ¯ï¼Œå®ƒå¯ä»¥è®©å¼€å‘è€…æ›´åŠ æ–¹ä¾¿åœ°æ“ä½œæ•°æ®åº“ï¼Œè€Œä¸ç”¨ç›´æ¥ä½¿ç”¨SQLè¯­å¥ã€‚

ç›´æ¥ä½¿ç”¨SQLè¯­å¥æ“ä½œæ•°æ®åº“ï¼Œè™½ç„¶å¯ä»¥è®©å¼€å‘è€…ç›´æ¥ä¸æ•°æ®åº“æ‰“äº¤é“ï¼Œä½†æ‰‹åŠ¨ç¼–å†™SQLè¯­å¥ï¼Œå®¹æ˜“å‡ºé”™ï¼Œè€Œä¸”çµæ´»æ€§ä¸Šæ¯”è¾ƒæ¬ ç¼ºã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œä½¿ç”¨ORMï¼ˆä»¥`SQLAlchemy`ä¸ºä¾‹ï¼‰æœ‰æ›´åŠ æ˜“äºä½¿ç”¨ã€æ›´åŠ çµæ´»ã€èƒ½é˜²æ­¢ `SQL` æ³¨å…¥æ”»å‡»ã€æ›´åŠ æ˜“äºæµ‹è¯•çš„ä¼˜åŠ¿ã€‚

**ç‚¹å‡»æŸ¥çœ‹ä¼˜åŠ¿è¯´æ˜**

> **æ›´åŠ æ˜“äºä½¿ç”¨:** å¯ä»¥ä½¿ç”¨ Python å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„è¡¨å’Œè¡Œï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ SQL è¯­å¥ã€‚è¿™æ ·å¯ä»¥ä½¿ä»£ç æ›´åŠ æ˜“äºç¼–å†™å’Œç»´æŠ¤ã€‚  
> **æ›´åŠ çµæ´»:** SQLAlchemy æä¾›äº†çµæ´»çš„æŸ¥è¯¢è¯­è¨€ï¼Œå¯ä»¥é€šè¿‡é“¾å¼è°ƒç”¨çš„æ–¹å¼æ„å»ºå¤æ‚çš„æŸ¥è¯¢è¯­å¥ã€‚åŒæ—¶ï¼ŒSQLAlchemy æ”¯æŒå¤šç§æ•°æ®åº“ï¼Œå¯ä»¥åœ¨ä¸åŒçš„æ•°æ®åº“ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ä»£ç ã€‚  
> **é˜²æ­¢ SQL æ³¨å…¥æ”»å‡»:** SQLAlchemy æä¾›äº†å‚æ•°åŒ–æŸ¥è¯¢çš„æ–¹å¼ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é˜²æ­¢ SQL æ³¨å…¥æ”»å‡»ã€‚ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢å¯ä»¥å°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®è½¬æ¢ä¸ºå‚æ•°ï¼Œä»è€Œé¿å…äº† SQL æ³¨å…¥æ”»å‡»ã€‚  
> **æ›´åŠ æ˜“äºæµ‹è¯•:** ä½¿ç”¨ SQLAlchemy å¯ä»¥å°†ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®åº“æ“ä½œåˆ†ç¦»ï¼Œä»è€Œä½¿å¾—ä»£ç æ›´åŠ æ˜“äºæµ‹è¯•ã€‚å¯ä»¥é€šè¿‡ Mock å¯¹è±¡æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œï¼Œä»è€Œè¿›è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚  
> ...

å½“ç„¶ï¼Œä½¿ç”¨ `SQLAlchemy` ä¹Ÿä¼šå¢åŠ ä»£ç çš„å¤æ‚åº¦ï¼Œéœ€è¦å­¦ä¹ é¢å¤–çš„çŸ¥è¯†å’Œ APIã€‚å› æ­¤ï¼Œåœ¨å®é™…åº”ç”¨ä¸­éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œé€‰æ‹©ã€‚

é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æŠ€æœ¯æˆ–è€…æ¡†æ¶ **æ—¢ä¸ç”¨å¢åŠ å¤ªå¤šçš„åº”ç”¨æˆæœ¬ï¼Œåˆå…¼å…·ä»¥`SQLAlchemy`ä¸ºä»£è¡¨çš„ORM æ¡†æ¶çš„ä¼˜åŠ¿** å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬ä»Šå¤©ä»‹ç»çš„ä¸»è§’ **`sqlmodel`**.

æˆ‘ä»¬å°±ä»¥ `Fastapi` å¼€å‘**åˆ›å»ºç”¨æˆ·**å’Œ**æŸ¥è¯¢ç”¨æˆ·** ä¸¤ä¸ªåŠŸèƒ½çš„æ¥å£æ¥å¯¹æ¯”ä¸€ä¸‹ ï¼Œ`SQLAlchemy` å’Œ `sqlmodel`ï¼Œ `sqlmodel` å’Œ åªä½¿ç”¨ `SQL`çš„å·®å¼‚ã€‚

ä½¿ç”¨SQLAlchemy
------------

#### å®‰è£…

    pip install sqlalchemy
    

#### ç¤ºä¾‹ä»£ç 

    from fastapi import FastAPI, Depends, HTTPException
    from sqlalchemy import create_engine, Column, Integer, String
    from sqlalchemy.orm import Session, declarative_base, sessionmaker
    
    SQLALCHEMY_DATABASE_URL = "mysql://user:password@host:port/database"
    
    engine = create_engine(SQLALCHEMY_DATABASE_URL)
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    Base = declarative_base()
    
    app = FastAPI()
    
    class User(Base):
        __tablename__ = "users"
    
        id = Column(Integer, primary_key=True, index=True)
        name = Column(String(50))
        age = Column(Integer)
    
    class UserIn(Base):
        name: str
        age: int
    
    class UserOut(Base):
        id: int
        name: str
        age: int
    
    class UserUpdate(Base):
        name: Optional[str] = None
        age: Optional[int] = None
    
    Base.metadata.create_all(bind=engine)
    
    def get_db():
        db = None
        try:
            db = SessionLocal()
            yield db
        finally:
            db.close()
    
    def create_user(db: Session, user: UserIn):
        db_user = User(name=user.name, age=user.age)
        db.add(db_user)
        db.commit()
        db.refresh(db_user)
        return db_user
    
    def read_user(db: Session, user_id: int):
        db_user = db.query(User).filter(User.id == user_id).first()
        if not db_user:
            raise HTTPException(status_code=404, detail="User not found")
        return db_user
    
    def read_all_user(db: Session, ):
        db_user = db.query(User).all()
        if not db_user:
            raise HTTPException(status_code=404, detail="User not found")
        return db_user
    
    @app.post("/users/", response_model=UserOut)
    async def create_user_view(user: UserIn, db: Session = Depends(get_db)):
        return create_user(db, user)
    
    @app.get("/users/{user_id}", response_model=UserOut)
    async def read_user_view(user_id: int, db: Session = Depends(get_db)):
        return read_user(db, user_id)
    
    @app.get("/users/", response_model=UserOut)
    async def read_all_user_view(db: Session = Depends(get_db)):
        return read_all_user(db)
    

#### ä»£ç è§£é‡Š

`User` æ˜¯æ•°æ®æ¨¡å‹ç±»çš„åç§°ï¼Œ`id`ã€`name`ã€`age` æ˜¯è¡¨ä¸­çš„åˆ—åã€‚`UserIn` æ˜¯åˆ›å»ºç”¨æˆ·çš„è¯·æ±‚å‚æ•°æ¨¡å‹ï¼Œ`UserOut` æ˜¯æŸ¥è¯¢ç”¨æˆ·çš„å“åº”æ•°æ®æ¨¡å‹ï¼Œ`UserUpdate` æ˜¯æ›´æ–°ç”¨æˆ·çš„è¯·æ±‚å‚æ•°æ¨¡å‹ã€‚

ä½¿ç”¨ `create_engine` å‡½æ•°åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥å¼•æ“ï¼Œä½¿ç”¨ `sessionmaker` å‡½æ•°åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ä¼šè¯å·¥å‚ï¼Œä½¿ç”¨ `declarative_base` å‡½æ•°åˆ›å»ºä¸€ä¸ªåŸºç±»ã€‚åœ¨åˆ›å»ºè¡¨æ—¶ï¼Œä½¿ç”¨ `Base.metadata.create_all` å‡½æ•°åˆ›å»ºè¡¨ã€‚

ä½¿ç”¨ `get_db` å‡½æ•°è·å–æ•°æ®åº“ä¼šè¯å¯¹è±¡ï¼Œä½¿ç”¨ `create_user` å’Œ `read_user` å‡½æ•°è¿›è¡Œæ•°æ®åº“æ“ä½œã€‚åœ¨è§†å›¾å‡½æ•°ä¸­ï¼Œåªéœ€è¦è°ƒç”¨è¿™äº›å‡½æ•°å³å¯å®Œæˆç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚

ä¸Šé¢çš„ä»£ç å·²ç»éå¸¸ç®€æ´ç›´è§‚ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰æœ‰ä¸€å®šçš„å­¦ä¹ æˆæœ¬ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ä½¿ç”¨æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’ -- `sqlmodel` éœ€è¦æ€æ ·æ¥å®ç°ä¸Šé¢çš„æ¥å£ã€‚

ä½¿ç”¨sqlmodel
----------

#### å®‰è£… sqlmodel

    pip install sqlmodel
    

#### ç¤ºä¾‹ä»£ç 

* * *

**ç‚¹å‡»æŸ¥çœ‹å®Œæ•´ä»£ç **

    # -*- coding: utf-8 -*-
    """
    @File   :dda.py
    @Date   :2023-06-05
    @user   :bingoHe
    """
    from typing import Optional
    
    from fastapi import FastAPI, Depends, HTTPException
    from sqlalchemy import create_engine
    from sqlalchemy.orm import Session
    from sqlmodel import SQLModel, Field, create_all, Session as SQLModelSession
    
    SQLALCHEMY_DATABASE_URL = "mysql://user:password@host:port/database"
    
    engine = create_engine(SQLALCHEMY_DATABASE_URL)
    
    app = FastAPI()
    
    class UserBase(SQLModel):
        name: Optional[str] = None
        age: Optional[int] = None
    
    class User(UserBase, table=True):
        id: Optional[int] = Field(default=None, primary_key=True)
    
    class UserIn(UserBase):
        pass
    
    class UserOut(UserBase):
        id: int
    
    class UserUpdate(UserBase):
        pass
    
    
    create_all(engine)
    
    def get_db():
        """è·å–æ•°æ®åº“ä¼šè¯å¯¹è±¡"""
        db = None
        try:
            db = SQLModelSession(engine)
            yield db
        finally:
            db.close()
    
    def create_user(db: SQLModelSession, user: UserIn):
        """åˆ›å»ºç”¨æˆ·"""
        db_user = User.from_orm(user)
        db.add(db_user)
        db.commit()
        db.refresh(db_user)
        return db_user
    
    def read_user(db: SQLModelSession, user_id: int):
        """æŸ¥è¯¢ç”¨æˆ·"""
        db_user = db.get(User, user_id)
        if not db_user:
            raise HTTPException(status_code=404, detail="User not found")
        return db_user
    
    @app.post("/users/", response_model=UserOut)
    async def create_user(user: UserIn, db: SQLModelSession = Depends(get_db)):
        """åˆ›å»ºç”¨æˆ·"""
        return create_user(db, user)
    
    @app.get("/users/{user_id}", response_model=UserOut)
    async def read_user(user_id: int, db: SQLModelSession = Depends(get_db)):
        """æŸ¥è¯¢ç”¨æˆ·"""
        return read_user(db, user_id)

* * *

å’Œ`SQLAlchemy`çš„ä¸»è¦ä½¿ç”¨å·®å¼‚åœ¨å‚æ•°çš„å®šä¹‰ä¸Šï¼Œä½¿ç”¨å¤šå¤„ç»§æ‰¿ï¼Œè€Œä¸æ˜¯å„è‡ªå®šä¹‰çš„æ–¹æ³•ï¼š

    # Code above omitted ğŸ‘†
    ...
    class UserBase(SQLModel):
        name: Optional[str] = None
        age: Optional[int] = None
    
    class User(UserBase, table=True):
        id: Optional[int] = Field(default=None, primary_key=True)
    
    class UserIn(UserBase):
        pass
    
    class UserOut(UserBase):
        id: int
    
    class UserUpdate(UserBase):
        pass
    ...
    # Code below omitted ğŸ‘‡
    

ç»§æ‰¿è¿™ä¸€ç‚¹å¯¹äºè¿˜åœ¨é¢‘ç¹è¿­ä»£çš„ç³»ç»Ÿä¸­éå¸¸é‡è¦ï¼Œå› ä¸ºåŒæ ·æ·»åŠ  ä¸€ä¸ªuserçš„æ•°æ®ç»“æ„ï¼ŒSQLAlchemyéœ€è¦ä¿®æ”¹4å¤„åœ°æ–¹ï¼Œè€Œ`sqlmodel` ä»…ä»…åªéœ€è¦ä¿®æ”¹ä¸€å¤„ã€‚å¦‚æœæœ‰å¤šä¸ªè¡¨ï¼Œè¿™ä¸ªä¾¿åˆ©æ€§çš„ä¼˜åŠ¿ä¼šå°¤ä¸ºçªå‡ºã€‚

è¿™ä¹Ÿå°±å¼•å‡ºäº†`sqlmodel`å…·æœ‰çš„ä¼˜åŠ¿ï¼š

*   **ç®€çŸ­ï¼š** æœ€å°åŒ–ä»£ç é‡å¤ã€‚ä¸€ä¸ªå•ä¸€çš„ç±»å‹æ³¨è§£åšäº†å¾ˆå¤šå·¥ä½œã€‚æ— éœ€åœ¨ SQLAlchemy å’Œ `Pydantic` ä¸­å¤åˆ¶æ¨¡å‹ã€‚
*   **ç®€å•æ˜“ç”¨ï¼š** API è®¾è®¡ç®€å•æ˜“ç”¨ï¼Œå¼ºå¤§çš„ç¼–è¾‘å™¨æ”¯æŒï¼Œå­¦ä¹ æ›²çº¿è¾ƒä½ï¼Œå¯ä»¥å¿«é€Ÿä¸Šæ‰‹ã€‚å®ƒä½¿ç”¨ Python ç±»å‹æ³¨è§£æ¥å®šä¹‰æ•°æ®æ¨¡å‹ï¼Œå¯ä»¥è‡ªåŠ¨æ¨æ–­æ•°æ®åº“è¡¨ç»“æ„ï¼ŒåŒæ—¶æ”¯æŒç±»å‹æ£€æŸ¥å’Œæ•°æ®éªŒè¯ã€‚
*   **å¯æ‰©å±•ï¼š** æ‹¥æœ‰ `SQLAlchemy` å’Œ `Pydantic` çš„æ‰€æœ‰åŠŸèƒ½ã€‚
*   **é«˜æ€§èƒ½**ï¼š `sqlmodel` é‡‡ç”¨äº†ä¸€äº›æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œæ¯”å¦‚ä½¿ç”¨é¢„ç¼–è¯‘ SQL è¯­å¥ã€å‡å°‘æ•°æ®åº“è¿æ¥æ¬¡æ•°ç­‰ï¼Œå¯ä»¥æé«˜æ•°æ®åº“æ“ä½œçš„æ€§èƒ½ã€‚
*   **æ”¯æŒå¼‚æ­¥æ“ä½œï¼š** `sqlmodel` æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œå¯ä»¥ä¸ asyncio åº“ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚
*   **æ”¯æŒåŸç”Ÿ SQLï¼š** `sqlmodel` æ”¯æŒåŸç”Ÿ SQLï¼Œå¯ä»¥ä½¿ç”¨åŸç”Ÿ SQL è¯­å¥è¿›è¡Œæ•°æ®åº“æ“ä½œï¼ŒåŒæ—¶è¿˜æ”¯æŒå‚æ•°ç»‘å®šå’Œ SQL æ³¨å…¥é˜²æŠ¤ã€‚

> SQLModel å®é™…ä¸Šæ˜¯åœ¨ Pydantic å’Œ SQLAlchemy ä¹‹é—´å¢åŠ äº†ä¸€å±‚å…¼å®¹é€‚é…ï¼Œç»è¿‡ç²¾å¿ƒè®¾è®¡ä»¥å…¼å®¹ä¸¤è€…ã€‚SQLModel æ—¨åœ¨ç®€åŒ– FastAPI åº”ç”¨ç¨‹åºä¸­ä¸ SQL æ•°æ®åº“çš„äº¤äº’ã€‚å®ƒç»“åˆäº† SQLAlchemy å’Œ Pydanticï¼Œå¹¶å°è¯•å°½å¯èƒ½ç®€åŒ–ä»£ç ï¼Œè®©ä»£ç é‡å¤å‡å°‘åˆ°æœ€ä½é™åº¦ï¼ŒåŒæ—¶å°½å¯èƒ½è®©å¼€å‘äººå‘˜è·å¾—æœ€ä½³çš„å¼€å‘ä½“éªŒã€‚

#### åŸç”Ÿçš„SQLè¯­å¥æ”¯æŒä¸¾ä¾‹

æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦ä½¿ç”¨åŸç”Ÿçš„SQLè¯­å¥æ¥è¿›è¡Œä¸€äº›å¤æ‚çš„æ“ä½œã€‚

    from sqlmodel import create_engine, Session
    
    # åˆ›å»ºæ•°æ®åº“å¼•æ“
    engine = create_engine("sqlite:///example.db")
    
    # åˆ›å»ºSessionå¯¹è±¡
    with Session(engine) as session:
        # æ‰§è¡ŒåŸç”Ÿçš„SQLè¯­å¥
        result = session.execute("SELECT * FROM users WHERE age > :age", {"age": 18})
    
        # å¤„ç†æŸ¥è¯¢ç»“æœ
        for row in result:
            print(row)
    

é«˜çº§ç”¨æ³•ï¼šç»“åˆmixinç±»ï¼Œç®€åŒ–æ•°æ®åº“æ“ä½œ
---------------------

ç»“åˆmixinç±»ï¼Œç®€åŒ–æ•°æ®åº“æ“ä½œï¼Œä¸€å¤„å°è£…ï¼Œå¤„å¤„é€‚ç”¨ã€‚

##### **å¦‚æœç†Ÿæ‚‰fastapiï¼Œä¸”ä»”ç»†è§‚å¯Ÿä¸Šé¢çš„å®Œæ•´ä»£ç å°±ä¼šå‘ç°ï¼Œé™¤äº†ä¸‹é¢è¿™æ®µï¼Œå…¶ä»–çš„éƒ½æ˜¯æ ‡å‡†çš„`Fastapi` æ¥å£å¼€å‘éœ€è¦çš„ä¿¡æ¯ã€‚è€Œè¿™æ ·çš„æ“ä½œç»“åˆæˆ‘ä»¬æ¥ä¸‹æ¥ä»‹ç»çš„`mixin`æ–¹æ³•ï¼Œå°±å¯ä»¥ç»™è¿™åªè™æ·»ä¸Šç¿…è†€ã€‚**

    class User(UserBase, table=True):
        id: Optional[int] = Field(default=None, primary_key=True)
    

> **tips**: åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼ŒMixinæ˜¯ä¸€ç§é‡ç”¨ä»£ç çš„æ–¹å¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªç±»ï¼ŒåŒ…å«ä¸€äº›æ–¹æ³•å’Œå±æ€§ï¼Œå¯ä»¥è¢«å…¶ä»–ç±»ç»§æ‰¿å’Œä½¿ç”¨ã€‚Mixinç±»é€šå¸¸ä¸æ˜¯ç‹¬ç«‹çš„ç±»ï¼Œè€Œæ˜¯ç”¨äºå¢å¼ºå…¶ä»–ç±»çš„åŠŸèƒ½ã€‚Mixinç±»çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥å°†ä»£ç åˆ†è§£ä¸ºå°çš„ã€å¯é‡ç”¨çš„éƒ¨åˆ†ï¼Œä»è€Œå‡å°‘ä»£ç çš„é‡å¤å’Œå†—ä½™ã€‚Mixinç±»å¯ä»¥è¢«å¤šä¸ªç±»ç»§æ‰¿ï¼Œä»è€Œé¿å…äº†å¤šé‡ç»§æ‰¿çš„é—®é¢˜ã€‚

    import uvicorn
    from typing import Optional, Union
    
    from fastapi import FastAPI, Depends, HTTPException
    from sqlmodel import Field, Session, SQLModel, create_engine, select
    
    
    class ActiveRecord(SQLModel):
        @classmethod
        def by_id(cls, _id: int, session):
            obj = session.get(cls, _id)
            if obj is None:
                raise HTTPException(status_code=404, detail=f"{cls.__name__} with id {id} not found")
            return obj
    
        @classmethod
        def all(cls, session):
            return session.exec(select(cls)).all()
    
        @classmethod
        def create(cls, source: Union[dict, SQLModel], session):
            if isinstance(source, SQLModel):
                obj = cls.from_orm(source)
            # elif isinstance(source, dict):
            elif isinstance(source, dict):
                obj = cls.parse_obj(source)
            session.add(obj)
            session.commit()
            session.refresh(obj)
            return obj
    
        def save(self, session):
            session.add(self)
            session.commit()
            session.refresh(self)
    
    
    class UserBase(SQLModel):
        name: Optional[str] = None
        age: Optional[int] = None
    
    
    class User(UserBase, ActiveRecord, table=True):
        id: Optional[int] = Field(default=None, primary_key=True)
        __table_args__ = {'extend_existing': True}
    
    
    class UserIn(UserBase):
        pass
    
    
    class UserOut(UserBase):
        id: int
    
    
    class UserUpdate(UserBase):
        pass
    
    # æ³¨æ„ï¼šéœ€è¦æå‰å®‰è£…pymysqlï¼Œ pip install pymysql
    SQLALCHEMY_DATABASE_URL = "mysql+pymysql://user:password@host:port/database"
    
    engine = create_engine(SQLALCHEMY_DATABASE_URL)
    
    
    def create_db_and_tables():
        SQLModel.metadata.create_all(engine)
    
    
    def get_session():
        with Session(engine) as session:
            yield session
    
    
    app = FastAPI()
    
    
    @app.on_event("startup")
    def on_startup():
        create_db_and_tables()
    
    
    @app.post("/User/", response_model=UserOut)
    def create_user(hero: UserIn, session: Session = Depends(get_session)):
        return User.create(hero, session)
    
    @app.get("/User/", response_model=list[UserOut])
    def read_user(session: Session = Depends(get_session)):
        return User.all(session)
    
    @app.get("/User/{user_id}", response_model=UserOut)
    def read_user(user_id: int,session: Session = Depends(get_session)):
        return User.by_id(user_id, session)
    
    
    if __name__ == '__main__':
        uvicorn.run("main:app", reload=True)
    
    

æ€»ç»“
--

ä½¿ç”¨`SQLModel` + `mixins`å¯ä»¥åœ¨å…¬å…±çš„é€»è¾‘é‡Œé¢å®ç°å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œå¤„å°è£…ï¼Œå¤„å¤„é€‚ç”¨ï¼Œå‡å°‘äº†ä»£ç çš„é‡å¤æ€§å’Œå†—ä½™æ€§ã€‚

ç‰¹ç‚¹

SQLAlchemy

sqlmodel

æ•°æ®åº“æ”¯æŒ

æ”¯æŒå¤šç§æ•°æ®åº“ï¼ŒåŒ…æ‹¬MySQLã€PostgreSQLã€SQLiteç­‰

æ”¯æŒå¤šç§æ•°æ®åº“ï¼ŒåŒ…æ‹¬MySQLã€PostgreSQLã€SQLiteç­‰

ORMåŠŸèƒ½

æä¾›å…¨é¢çš„ORMåŠŸèƒ½ï¼Œæ”¯æŒå¯¹è±¡å…³ç³»æ˜ å°„ã€äº‹åŠ¡å¤„ç†ã€æŸ¥è¯¢æ„å»ºç­‰

æä¾›è½»é‡çº§çš„ORMåŠŸèƒ½ï¼Œæ”¯æŒå¯¹è±¡å…³ç³»æ˜ å°„ã€æŸ¥è¯¢æ„å»ºç­‰

æ€§èƒ½

æ€§èƒ½è¾ƒå¥½ï¼Œæ”¯æŒç¼“å­˜ã€è¿æ¥æ± ç­‰ä¼˜åŒ–æ‰‹æ®µ

æ€§èƒ½è¾ƒå¥½ï¼Œæ”¯æŒç¼“å­˜ã€è¿æ¥æ± ç­‰ä¼˜åŒ–æ‰‹æ®µ

å­¦ä¹ éš¾åº¦

å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­ï¼Œéœ€è¦æŒæ¡å¤æ‚çš„æ¦‚å¿µå’ŒAPI

å­¦ä¹ æ›²çº¿è¾ƒå¹³ç¼“ï¼Œæ˜“äºä¸Šæ‰‹å’Œä½¿ç”¨

æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒ

æä¾›å®Œå–„çš„æ–‡æ¡£å’Œæ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ

æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒç›¸å¯¹è¾ƒå°‘

ä»£ç è§„èŒƒ

ä»£ç è§„èŒƒè¾ƒä¸ºçµæ´»ï¼Œå¯ä»¥è‡ªç”±ç»„ç»‡ä»£ç ç»“æ„

ä»£ç è§„èŒƒè¾ƒä¸ºä¸¥æ ¼ï¼Œéœ€è¦æŒ‰ç…§è§„èŒƒç»„ç»‡ä»£ç ç»“æ„

#### å»ºè®®ï¼š

æ ¹æ®ä¸Šè¿°æ¯”è¾ƒï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹é€‰æ‹©å»ºè®®ï¼š

*   å¦‚æœéœ€è¦ä½¿ç”¨å…¨é¢çš„ORMåŠŸèƒ½ï¼Œæˆ–è€…éœ€è¦ä½¿ç”¨å¤æ‚çš„æŸ¥è¯¢æ„å»ºå’Œäº‹åŠ¡å¤„ç†ç­‰åŠŸèƒ½ï¼Œå»ºè®®é€‰æ‹©SQLAlchemyã€‚
*   å¦‚æœéœ€è¦ä½¿ç”¨è½»é‡çº§çš„ORMåŠŸèƒ½ï¼Œæˆ–è€…**éœ€è¦å¿«é€Ÿä¸Šæ‰‹å’Œä½¿ç”¨**ï¼Œå»ºè®®é€‰æ‹©sqlmodelã€‚
*   å¦‚æœéœ€è¦æ”¯æŒå¤šç§æ•°æ®åº“ï¼Œå»ºè®®ä¸¤è€…éƒ½å¯ä»¥è€ƒè™‘ä½¿ç”¨ã€‚
*   **å¦‚æœå¯¹æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒæœ‰è¾ƒé«˜çš„è¦æ±‚**ï¼Œå»ºè®®é€‰æ‹©SQLAlchemyã€‚
*   å¦‚æœå¯¹ä»£ç è§„èŒƒæœ‰è¾ƒé«˜çš„è¦æ±‚ï¼Œå»ºè®®é€‰æ‹©sqlmodelã€‚

æ–‡ä¸­å¯èƒ½å­˜åœ¨æè¿°ä¸æ­£ç¡®ï¼Œæ¬¢è¿å¤§ç¥ä»¬æŒ‡æ­£è¡¥å……ï¼

æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœè§‰å¾—å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå°±åœ¨å³ä¸‹è§’ç‚¹ä¸ªèµå§ï¼Œæ„Ÿè°¢ï¼

åˆæŠ±ä¹‹æœ¨ï¼Œç”Ÿäºæ¯«æœ«ï¼›ä¹å±‚ä¹‹å°ï¼Œèµ·äºç´¯åœŸï¼›åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚