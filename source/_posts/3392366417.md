---
layout: post
title: "RWKV â€“ transformer ä¸Ž RNN çš„å¼ºå¼ºè”åˆ"
date: "2023-06-01T01:42:06.642Z"
---
RWKV â€“ transformer ä¸Ž RNN çš„å¼ºå¼ºè”åˆ
==============================

åœ¨ NLP (Natural Language Processing, è‡ªç„¶è¯­è¨€å¤„ç†) é¢†åŸŸï¼ŒChatGPT å’Œå…¶ä»–çš„èŠå¤©æœºå™¨äººåº”ç”¨å¼•èµ·äº†æžå¤§çš„å…³æ³¨ã€‚æ¯ä¸ªç¤¾åŒºä¸ºæž„å»ºè‡ªå·±çš„åº”ç”¨ï¼Œä¹Ÿéƒ½åœ¨æŒç»­åœ°å¯»æ±‚å¼ºå¤§ã€å¯é çš„å¼€æºæ¨¡åž‹ã€‚è‡ª Vaswani ç­‰äººäºŽ 2017 å¹´é¦–æ¬¡æå‡º [Attention Is All You Need](https://arxiv.org/abs/1706.03762) ä¹‹åŽï¼ŒåŸºäºŽ transformer çš„å¼ºå¤§çš„æ¨¡åž‹ä¸€ç›´åœ¨ä¸æ–­åœ°æ¶ŒçŽ°ï¼Œå®ƒä»¬åœ¨ NLP ç›¸å…³ä»»åŠ¡ä¸Šçš„è¡¨çŽ°è¿œè¿œè¶…è¿‡åŸºäºŽ RNN (Recurrent Neural Networks, é€’å½’ç¥žç»ç½‘ç»œ) çš„ SoTA æ¨¡åž‹ï¼Œç”šè‡³å¤šæ•°è®¤ä¸º RNN å·²æ­»ã€‚è€Œæœ¬æ–‡å°†ä»‹ç»ä¸€ä¸ªé›† RNN å’Œ transformer ä¸¤è€…çš„ä¼˜åŠ¿äºŽä¸€èº«çš„å…¨æ–°ç½‘ç»œæž¶æž„ â€“RWKVï¼çŽ°å·²åœ¨ HuggingFace [transformers](https://github.com/huggingface/transformers) åº“ä¸­æ”¯æŒã€‚

### RWKV é¡¹ç›®æ¦‚è§ˆ

RWKV é¡¹ç›®å·²ç»å¯åŠ¨ï¼Œç”± [Bo Peng](https://github.com/BlinkDL) ä¸»å¯¼ã€è´¡çŒ®å’Œç»´æŠ¤ã€‚åŒæ—¶é¡¹ç›®æˆå‘˜åœ¨å®˜æ–¹ Discord ä¹Ÿå¼€è®¾äº†ä¸åŒä¸»é¢˜çš„è®¨è®ºé¢‘é“: å¦‚æ€§èƒ½ (RWKV.cppã€é‡åŒ–ç­‰)ï¼Œæ‰©å±•æ€§ (æ•°æ®é›†æ”¶é›†å’Œå¤„ç†)ï¼Œç›¸å…³ç ”ç©¶ (chat å¾®è°ƒã€å¤šæ¨¡æ€å¾®è°ƒç­‰)ã€‚è¯¥é¡¹ç›®ä¸­è®­ç»ƒ RWKV æ¨¡åž‹æ‰€éœ€çš„ GPU èµ„æºç”± Stability AI æä¾›ã€‚

è¯»è€…å¯ä»¥åŠ å…¥ [å®˜æ–¹ discord é¢‘é“](https://discordapp.com/users/468093332535640064) äº†è§£è¯¦æƒ…æˆ–è€…å‚ä¸Žè®¨è®ºã€‚å¦‚æƒ³äº†è§£ RWKV èƒŒåŽçš„æ€æƒ³ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸¤ç¯‡åšæ–‡:

*   [https://johanwind.github.io/2023/03/23/rwkv\_overview.html](https://johanwind.github.io/2023/03/23/rwkv_overview.html)
*   [https://johanwind.github.io/2023/03/23/rwkv\_details.html](https://johanwind.github.io/2023/03/23/rwkv_details.html)

### Transformer ä¸Ž RNN æž¶æž„å¯¹æ¯”

RNN æž¶æž„æ˜¯æœ€æ—©å¹¿æ³›ç”¨äºŽå¤„ç†åºåˆ—æ•°æ®çš„ç¥žç»ç½‘ç»œæž¶æž„ä¹‹ä¸€ã€‚ä¸ŽæŽ¥æ”¶å›ºå®šè¾“å…¥å°ºå¯¸çš„ç»å…¸æž¶æž„ä¸åŒï¼ŒRNN æŽ¥æ”¶å½“å‰æ—¶åˆ»çš„ â€œtokenâ€(å³æ•°æ®æµä¸­çš„å½“å‰æ•°æ®ç‚¹) å’Œå…ˆå‰æ—¶åˆ»çš„ â€œçŠ¶æ€â€ ä½œä¸ºè¾“å…¥ï¼Œé€šè¿‡ç½‘ç»œé¢„æµ‹è¾“å‡ºä¸‹ä¸€æ—¶åˆ»çš„ â€œtokenâ€ å’Œ â€œçŠ¶æ€â€ï¼ŒåŒæ—¶è¾“å‡ºçš„ â€œçŠ¶æ€â€ è¿˜èƒ½ç»§ç»­ç”¨åˆ°åŽç»­çš„é¢„æµ‹ä¸­åŽ»ï¼Œä¸€ç›´åˆ°åºåˆ—æœ«å°¾ã€‚RNN è¿˜å¯ä»¥ç”¨äºŽä¸åŒçš„ â€œæ¨¡å¼â€ï¼Œé€‚ç”¨äºŽå¤šç§ä¸åŒçš„åœºæ™¯ã€‚å‚è€ƒ [Andrej Karpathy çš„åšå®¢](https://karpathy.github.io/2015/05/21/rnn-effectiveness/)ï¼ŒRNN å¯ä»¥ç”¨äºŽ: ä¸€å¯¹ä¸€ (å›¾åƒåˆ†ç±»)ï¼Œä¸€å¯¹å¤š (å›¾åƒæè¿°)ï¼Œå¤šå¯¹ä¸€ (åºåˆ—åˆ†ç±»)ï¼Œå¤šå¯¹å¤š (åºåˆ—ç”Ÿæˆ)ï¼Œç­‰ç­‰ã€‚

![](https://devrel.andfun.cn/devrel/posts/2023-05-31-123817.png)

ç”±äºŽ RNN åœ¨è®¡ç®—æ¯ä¸€æ—¶åˆ»çš„é¢„æµ‹å€¼æ—¶ä½¿ç”¨çš„éƒ½æ˜¯åŒä¸€ç»„ç½‘ç»œæƒé‡ï¼Œå› æ­¤ RNN å¾ˆéš¾è§£å†³é•¿è·ç¦»åºåˆ—ä¿¡æ¯çš„è®°å¿†é—®é¢˜ï¼Œè¿™ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿæ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­æ¢¯åº¦æ¶ˆå¤±å¯¼è‡´çš„ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç›¸ç»§æœ‰æ–°çš„ç½‘ç»œæž¶æž„è¢«æå‡ºï¼Œå¦‚ LSTM æˆ–è€… GRUï¼Œå…¶ä¸­ transformer æ˜¯å·²è¢«è¯å®žæœ€æœ‰æ•ˆçš„æž¶æž„ã€‚

åœ¨ transformer æž¶æž„ä¸­ï¼Œä¸åŒæ—¶åˆ»çš„è¾“å…¥ token å¯ä»¥åœ¨ self-attention æ¨¡å—ä¸­å¹¶è¡Œå¤„ç†ã€‚é¦–å…ˆ token ç»è¿‡ Qã€Kã€V æƒé‡çŸ©é˜µåšçº¿æ€§å˜æ¢æŠ•å½±åˆ°ä¸åŒçš„ç©ºé—´ï¼Œå¾—åˆ°çš„ Qã€K çŸ©é˜µç”¨äºŽè®¡ç®—æ³¨æ„åŠ›åˆ†æ•° (é€šè¿‡ softmaxï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º)ï¼Œç„¶åŽä¹˜ä»¥ V çš„éšçŠ¶æ€å¾—åˆ°æœ€ç»ˆçš„éšçŠ¶æ€ï¼Œè¿™ç§æž¶æž„è®¾è®¡å¯ä»¥æœ‰æ•ˆç¼“è§£é•¿è·ç¦»åºåˆ—é—®é¢˜ï¼ŒåŒæ—¶å…·æœ‰æ¯” RNN æ›´å¿«çš„è®­ç»ƒå’ŒæŽ¨ç†é€Ÿåº¦ã€‚

![](https://devrel.andfun.cn/devrel/posts/2023-05-31-123820.png)

![](https://devrel.andfun.cn/devrel/posts/2023-05-31-123821.png)

åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼ŒTransformer æž¶æž„ç›¸æ¯”äºŽä¼ ç»Ÿçš„ RNN å’Œ CNN æœ‰å¤šä¸ªä¼˜åŠ¿ï¼Œæœ€çªå‡ºçš„ä¼˜åŠ¿æ˜¯å®ƒèƒ½å¤Ÿå­¦åˆ°ä¸Šä¸‹æ–‡ç‰¹å¾è¡¨è¾¾ã€‚ä¸åŒäºŽæ¯æ¬¡ä»…å¤„ç†è¾“å…¥åºåˆ—ä¸­ä¸€ä¸ª token çš„ RNN å’Œ CNNï¼Œtransformer å¯ä»¥å•æ¬¡å¤„ç†æ•´ä¸ªè¾“å…¥åºåˆ—ï¼Œè¿™ç§ç‰¹æ€§ä¹Ÿä½¿å¾— transformer å¯ä»¥å¾ˆå¥½åœ°åº”å¯¹é•¿è·ç¦»åºåˆ— token ä¾èµ–é—®é¢˜ï¼Œå› æ­¤ transformer åœ¨è¯­è¨€ç¿»è¯‘å’Œé—®ç­”ç­‰å¤šç§ä»»åŠ¡ä¸­è¡¨çŽ°éžå¸¸äº®çœ¼ã€‚

åœ¨æŽ¨ç†è¿‡ç¨‹ä¸­ï¼ŒRNN æž¶æž„åœ¨æŽ¨ç†é€Ÿåº¦å’Œå†…å­˜æ•ˆçŽ‡æ–¹é¢ä¼šå…·æœ‰ä¸€äº›ä¼˜åŠ¿ã€‚ä¾‹å¦‚è®¡ç®—ç®€å• (åªéœ€çŸ©é˜µ - å‘é‡è¿ç®—) ã€å†…å­˜å‹å¥½ (å†…å­˜ä¸ä¼šéšç€æŽ¨ç†é˜¶æ®µçš„è¿›è¡Œè€Œå¢žåŠ )ï¼Œé€Ÿåº¦ç¨³å®š (ä¸Žä¸Šä¸‹æ–‡çª—å£é•¿åº¦ä¸€è‡´ï¼Œå› ä¸º RNN åªå…³æ³¨å½“å‰æ—¶åˆ»çš„ token å’ŒçŠ¶æ€)ã€‚

RWKV æž¶æž„
-------

RWKV çš„çµæ„Ÿæ¥è‡ªäºŽ Apple å…¬å¸çš„ [Attention Free Transformer](https://machinelearning.apple.com/research/attention-free-transformer)ã€‚RWKV è¯¥æž¶æž„ç»è¿‡ç²¾å¿ƒç®€åŒ–å’Œä¼˜åŒ–ï¼Œå¯ä»¥è½¬æ¢ä¸º RNNã€‚é™¤æ­¤æ­¤å¤–ï¼Œä¸ºä½¿ RWKV æ€§èƒ½åª²ç¾Ž GPTï¼Œè¿˜é¢å¤–ä½¿ç”¨äº†è®¸å¤šæŠ€å·§ï¼Œä¾‹å¦‚ `TokenShift` å’Œ `SmallInitEmb` (ä½¿ç”¨çš„å®Œæ•´æŠ€å·§åˆ—è¡¨åœ¨ [å®˜æ–¹ GitHub ä»“åº“çš„ README ä¸­](https://github.com/BlinkDL/RWKV-LM/blob/main/README.md#how-it-works) è¯´æ˜Ž)ã€‚å¯¹äºŽ RWKV çš„è®­ç»ƒï¼ŒçŽ°æœ‰çš„é¡¹ç›®ä»“åº“å¯ä»¥å°†å‚æ•°é‡æ‰©å±•åˆ° 14Bï¼Œå¹¶ä¸”è¿­ä»£ä¿®äº† RWKV-4 çš„ä¸€äº›è®­ç»ƒé—®é¢˜ï¼Œä¾‹å¦‚æ•°å€¼ä¸ç¨³å®šæ€§ç­‰ã€‚

### RWKV æ˜¯ RNN å’Œ Transformer çš„å¼ºå¼ºè”åˆ

å¦‚ä½•æŠŠ transformer å’Œ RNN ä¼˜åŠ¿ç»“åˆèµ·æ¥ï¼ŸåŸºäºŽ transformer çš„æ¨¡åž‹çš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œåœ¨æŽ¥æ”¶è¶…å‡ºä¸Šä¸‹æ–‡é•¿åº¦é¢„è®¾å€¼çš„è¾“å…¥æ—¶ï¼ŒæŽ¨ç†ç»“æžœå¯èƒ½ä¼šå‡ºçŽ°æ½œåœ¨çš„é£Žé™©ï¼Œå› ä¸ºæ³¨æ„åŠ›åˆ†æ•°æ˜¯é’ˆå¯¹è®­ç»ƒæ—¶çš„é¢„è®¾å€¼æ¥åŒæ—¶è®¡ç®—æ•´ä¸ªåºåˆ—çš„ã€‚

RNN æœ¬èº«æ”¯æŒéžå¸¸é•¿çš„ä¸Šä¸‹æ–‡é•¿åº¦ã€‚å³ä½¿åœ¨è®­ç»ƒæ—¶æŽ¥æ”¶çš„ä¸Šä¸‹æ–‡é•¿åº¦æœ‰é™ï¼ŒRNN ä¹Ÿå¯ä»¥é€šè¿‡ç²¾å¿ƒçš„ç¼–ç ï¼Œæ¥å¾—åˆ°æ•°ç™¾ä¸‡é•¿åº¦çš„æŽ¨ç†ç»“æžœã€‚ç›®å‰ï¼ŒRWKV æ¨¡åž‹ä½¿ç”¨ä¸Šä¸‹æ–‡é•¿åº¦ä¸Šä¸º 8192 ( `ctx8192`) å’Œ `ctx1024` æ—¶çš„è®­ç»ƒé€Ÿåº¦å’Œå†…å­˜éœ€æ±‚å‡ç›¸åŒã€‚

ä¼ ç»Ÿ RNN æ¨¡åž‹çš„ä¸»è¦ç¼ºé™·ï¼Œä»¥åŠ RWKV æ˜¯å¦‚ä½•é¿å…çš„:

1.  ä¼ ç»Ÿçš„ RNN æ¨¡åž‹æ— æ³•åˆ©ç”¨å¾ˆé•¿è·ç¦»çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ (LSTM ç”¨ä½œè¯­è¨€æ¨¡åž‹æ—¶ä¹Ÿåªèƒ½æœ‰æ•ˆå¤„ç†çº¦ 100 ä¸ª token)ï¼Œè€Œ RWKV å¯ä»¥å¤„ç†æ•°åƒä¸ªç”šè‡³æ›´å¤šçš„ tokenï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

![](https://devrel.andfun.cn/devrel/posts/2023-05-31-123822.png)

1.  ä¼ ç»Ÿçš„ RNN æ¨¡åž‹æ— æ³•å¹¶è¡Œè®­ç»ƒï¼Œè€Œ RWKV æ›´åƒä¸€ä¸ª â€œçº¿æ€§ GPTâ€ï¼Œå› æ­¤æ¯” GPT è®­ç»ƒå¾—æ›´å¿«ã€‚

é€šè¿‡å°†è¿™ä¸¤ä¸ªä¼˜åŠ¿å¼ºå¼ºè”åˆï¼Œå¸Œæœ› RWKV å¯ä»¥å®žçŽ° â€œ1 + 1 > 2â€ çš„æ•ˆæžœã€‚

### RWKV æ³¨æ„åŠ›å…¬å¼

RWKV æ¨¡åž‹æž¶æž„ä¸Žç»å…¸çš„ transformer æ¨¡åž‹æž¶æž„éžå¸¸ç›¸ä¼¼ (ä¾‹å¦‚ä¹ŸåŒ…å« embedding å±‚ã€Layer Normalizationã€ç”¨äºŽé¢„æµ‹ä¸‹ä¸€ token çš„å› æžœè¯­è¨€æ¨¡åž‹å¤´ã€ä»¥åŠå¤šä¸ªå®Œå…¨ç›¸åŒçš„ç½‘ç»œå±‚ç­‰)ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºŽæ³¨æ„åŠ›å±‚ï¼Œå®ƒä¸Žä¼ ç»Ÿçš„ transformer æ¨¡åž‹æž¶æž„å®Œå…¨ä¸åŒï¼Œå› æ­¤ RWKV çš„æ³¨æ„åŠ›è®¡ç®—å…¬å¼ä¹Ÿä¸ä¸€æ ·ã€‚

æœ¬æ–‡ä¸ä¼šå¯¹æ³¨æ„åŠ›å±‚è¿‡å¤šçš„ä»‹ç»ï¼Œè¿™é‡ŒæŽ¨èä¸€ç¯‡ [Johan Sokrates Wind çš„åšæ–‡](https://johanwind.github.io/2023/03/23/rwkv_details.html)ï¼Œé‡Œé¢æœ‰å¯¹æ³¨æ„åŠ›å±‚çš„åˆ†æ•°è®¡ç®—å…¬å¼ç­‰æ›´å…¨é¢çš„è§£é‡Šã€‚

### çŽ°æœ‰æ£€æŸ¥ç‚¹

#### çº¯è¯­è¨€æ¨¡åž‹: RWKV-4 æ¨¡åž‹

å¤§å¤šæ•°é‡‡ç”¨ RWKV æž¶æž„çš„è¯­è¨€æ¨¡åž‹å‚æ•°é‡èŒƒå›´ä»Ž 170M åˆ° 14B ä¸ç­‰ã€‚ æ® [RWKV æ¦‚è¿°åšæ–‡](https://johanwind.github.io/2023/03/23/rwkv_overview.html) ä»‹ç»ï¼Œè¿™äº›æ¨¡åž‹å·²ç»åœ¨ Pile æ•°æ®é›†ä¸Šå®Œæˆè®­ç»ƒï¼Œå¹¶è¿›è¡Œäº†å¤šé¡¹ä¸åŒçš„åŸºå‡†æµ‹è¯•ï¼Œå–å¾—äº†ä¸Žå…¶ä»– SoTA æ¨¡åž‹è¡¨çŽ°ç›¸å½“çš„æ€§èƒ½ç»“æžœã€‚

![](https://devrel.andfun.cn/devrel/posts/2023-05-31-123824.png)

#### æŒ‡ä»¤å¾®è°ƒ/Chat ç‰ˆ: RWKV-4 Raven

Bo è¿˜è®­ç»ƒäº† RWKV æž¶æž„çš„ â€œchatâ€ ç‰ˆæœ¬: RWKV-4 Raven æ¨¡åž‹ã€‚RWKV-4 Raven æ˜¯ä¸€ä¸ªåœ¨ Pile æ•°æ®é›†ä¸Šé¢„è®­ç»ƒçš„æ¨¡åž‹ï¼Œå¹¶åœ¨ ALPACAã€CodeAlpacaã€Guanacoã€GPT4Allã€ShareGPT ç­‰ä¸Šè¿›è¡Œäº†å¾®è°ƒã€‚RWKV-4 Raven æ¨¡åž‹æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå¦‚ä¸åŒè¯­è¨€ (ä»…è‹±æ–‡ã€è‹±æ–‡ + ä¸­æ–‡ + æ—¥æ–‡ã€è‹±æ–‡ + æ—¥æ–‡ç­‰) å’Œä¸åŒå¤§å° (1.5B å‚æ•°ã€7B å‚æ•°ã€14B å‚æ•°) ç­‰ã€‚

æ‰€æœ‰ HF ç‰ˆçš„æ¨¡åž‹éƒ½å¯ä»¥åœ¨ Hugging Face Hub çš„ [RWKV ç¤¾åŒºä¸»é¡µ](https://huggingface.co/RWKV) æ‰¾åˆ°ã€‚

é›†æˆ ðŸ¤— Transformers åº“
--------------------

æ„Ÿè°¢è¿™ä¸ª [Pull Request](https://github.com/huggingface/transformers/pull/22797) çš„è´¡çŒ®ï¼ŒRWKV æž¶æž„çŽ°å·²é›†æˆåˆ° ðŸ¤— transformers åº“ä¸­ã€‚åœ¨ä½œè€…æ’°å†™æœ¬æ–‡ä¹‹æ—¶ï¼Œæ‚¨å·²ç»å¯ä»¥é€šè¿‡ä»Žæºä»£ç å®‰è£… `transformers` åº“ï¼Œæˆ–è€…ä½¿ç”¨å…¶ `main` åˆ†æ”¯ã€‚RWKV æž¶æž„ä¹Ÿä¼šä¸Ž transformers åº“ä¸€èµ·æ›´æ–°ï¼Œæ‚¨å¯ä»¥åƒä½¿ç”¨ä»»ä½•å…¶ä»–æž¶æž„ä¸€æ ·ä½¿ç”¨å®ƒã€‚

ä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹ä¸€äº›ä½¿ç”¨ç¤ºä¾‹ã€‚

### æ–‡æœ¬ç”Ÿæˆç¤ºä¾‹

è¦åœ¨ç»™å®š prompt çš„æƒ…å†µä¸‹ç”Ÿæˆæ–‡æœ¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `pipeline`:

    from transformers import pipeline
    model_id = "RWKV/rwkv-4-169m-pile"
    prompt = "\nIn a shocking finding, scientist discovered a herd of dragons living in a remote, previously unexplored valley, in Tibet. Even more surprising to the researchers was the fact that the dragons spoke perfect Chinese."
    pipe = pipeline("text-generation", model=model_id)
    print(pipe(prompt, max_new_tokens=20))
    >>> [{'generated_text': '\nIn a shocking finding, scientist discovered a herd of dragons living in a remote, previously unexplored valley, in Tibet. Even more surprising to the researchers was the fact that the dragons spoke perfect Chinese.\n\nThe researchers found that the dragons were able to communicate with each other, and that they were'}]
    

æˆ–è€…å¯ä»¥è¿è¡Œä¸‹é¢çš„ä»£ç ç‰‡æ®µ:

    import torch
    from transformers import AutoModelForCausalLM, AutoTokenizer
    model = AutoModelForCausalLM.from_pretrained("RWKV/rwkv-4-169m-pile")
    tokenizer = AutoTokenizer.from_pretrained("RWKV/rwkv-4-169m-pile")
    prompt = "\nIn a shocking finding, scientist discovered a herd of dragons living in a remote, previously unexplored valley, in Tibet. Even more surprising to the researchers was the fact that the dragons spoke perfect Chinese."
    inputs = tokenizer(prompt, return_tensors="pt")
    output = model.generate(inputs["input_ids"], max_new_tokens=20)
    print(tokenizer.decode(output[0].tolist()))
    >>> In a shocking finding, scientist discovered a herd of dragons living in a remote, previously unexplored valley, in Tibet. Even more surprising to the researchers was the fact that the dragons spoke perfect Chinese.\n\nThe researchers found that the dragons were able to communicate with each other, and that they were
    

### ä½¿ç”¨ Raven æ¨¡åž‹ (chat æ¨¡åž‹) ç¤ºä¾‹

æ‚¨å¯ä»¥ä»¥ alpaca é£Žæ ¼ä½¿ç”¨æç¤º chat ç‰ˆæ¨¡åž‹ï¼Œç¤ºä¾‹å¦‚ä¸‹:

    from transformers import AutoTokenizer, AutoModelForCausalLM
    model_id = "RWKV/rwkv-raven-1b5"
    model = AutoModelForCausalLM.from_pretrained(model_id).to(0)
    tokenizer = AutoTokenizer.from_pretrained(model_id)
    question = "Tell me about ravens"
    prompt = f"### Instruction: {question}\n### Response:"
    inputs = tokenizer(prompt, return_tensors="pt").to(0)
    output = model.generate(inputs["input_ids"], max_new_tokens=100)
    print(tokenizer.decode(output[0].tolist(), skip_special_tokens=True))
    >>> ### Instruction: Tell me about ravens
    ### Response: RAVENS are a type of bird that is native to the Middle East and North Africa. They are known for their intelligence, adaptability, and their ability to live in a variety of environments. RAVENS are known for their intelligence, adaptability, and their ability to live in a variety of environments. They are known for their intelligence, adaptability, and their ability to live in a variety of environments.
    

æ® Bo æ‰€è¿°ï¼Œ[è¿™æ¡ discord æ¶ˆæ¯ (è®¿é—®è¶…é“¾æŽ¥æ—¶è¯·ç¡®ä¿å·²åŠ å…¥ discord é¢‘é“)](https://discord.com/channels/992359628979568762/1083107245971226685/1098533896355848283) ä¸­æœ‰æ›´è¯¦ç»†çš„ä¹¦å†™æŒ‡ä»¤æŠ€å·§ã€‚

![](https://devrel.andfun.cn/devrel/posts/2023-05-31-123848.png)

### æƒé‡è½¬æ¢

ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨ `transformers` åº“ä¸­æä¾›çš„è½¬æ¢è„šæœ¬è½»æ¾åœ°å°†åŽŸå§‹ RWKV æ¨¡åž‹æƒé‡è½¬æ¢ä¸º HF æ ¼å¼ã€‚å…·ä½“æ­¥éª¤ä¸º: é¦–å…ˆï¼Œå°† â€œåŽŸå§‹â€ æƒé‡ push åˆ° Hugging Face Hub (å‡å®šç›®æ ‡ä»“åº“ä¸º `RAW_HUB_REPO`ï¼Œç›®æ ‡æƒé‡æ–‡ä»¶ä¸º `RAW_FILE`)ï¼Œç„¶åŽè¿è¡Œä»¥ä¸‹è½¬æ¢è„šæœ¬:

    python convert_rwkv_checkpoint_to_hf.py --repo_id RAW_HUB_REPO --checkpoint_file RAW_FILE --output_dir OUTPUT_DIR
    

å¦‚æžœæ‚¨æƒ³å°†è½¬æ¢åŽçš„æ¨¡åž‹ push åˆ° Hub ä¸Š (å‡å®šæŽ¨é€ç›®å½•ä¸º `dummy_user/converted-rwkv`)ï¼Œé¦–å…ˆè¯·ç¡®ä¿åœ¨ push æ¨¡åž‹ä¹‹å‰ä½¿ç”¨ `huggingface-cli login` ç™»å½• HF è´¦å·ï¼Œç„¶åŽè¿è¡Œ:

    python convert_rwkv_checkpoint_to_hf.py --repo_id RAW_HUB_REPO --checkpoint_file RAW_FILE --output_dir OUTPUT_DIR --push_to_hub --model_name dummy_user/converted-rwkv
    

æœªæ¥å·¥ä½œ
----

### å¤šè¯­è¨€ RWKV

Bo ç›®å‰æ­£åœ¨ç ”ç©¶åœ¨å¤šè¯­è¨€è¯­æ–™åº“ä¸Šè®­ç»ƒ RWKV æ¨¡åž‹ï¼Œæœ€è¿‘å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„ [å¤šè¯­è¨€åˆ†è¯å™¨](https://twitter.com/BlinkDL_AI/status/1649839897208045573)ã€‚

### ç¤¾åŒºåŽç»­ç ”ç©¶æ–¹å‘

RWKV ç¤¾åŒºéžå¸¸æ´»è·ƒï¼Œè‡´åŠ›äºŽå‡ ä¸ªåŽç»­ç ”ç©¶æ–¹å‘ã€‚é¡¹ç›®æ¸…å•å¯ä»¥åœ¨ RWKV çš„ [discord ä¸“ç”¨é¢‘é“ä¸­æ‰¾åˆ° (è®¿é—®è¶…é“¾æŽ¥æ—¶è¯·ç¡®ä¿å·²åŠ å…¥ discord é¢‘é“)](https://discord.com/channels/992359628979568762/1068563033510653992)ã€‚æ¬¢è¿ŽåŠ å…¥è¿™ä¸ª RWKV ç ”ç©¶é¢‘é“ï¼Œä»¥åŠå¯¹ RWKV çš„ç§¯æžè´¡çŒ®ï¼

### æ¨¡åž‹åŽ‹ç¼©ä¸ŽåŠ é€Ÿ

ç”±äºŽåªéœ€è¦çŸ©é˜µ - å‘é‡è¿ç®—ï¼Œå¯¹äºŽéžæ ‡å‡†åŒ–å’Œå®žéªŒæ€§çš„è®¡ç®—ç¡¬ä»¶ï¼ŒRWKV æ˜¯ä¸€ä¸ªéžå¸¸ç†æƒ³çš„æž¶æž„é€‰æ‹©ï¼Œä¾‹å¦‚å…‰å­å¤„ç†å™¨/åŠ é€Ÿå™¨ã€‚

å› æ­¤è‡ªç„¶åœ°ï¼ŒRWKV æž¶æž„ä¹Ÿå¯ä»¥ä½¿ç”¨ç»å…¸çš„åŠ é€Ÿå’ŒåŽ‹ç¼©æŠ€æœ¯ (å¦‚ [ONNX](https://github.com/harrisonvanderbyl/rwkv-onnx)ã€4 ä½/8 ä½é‡åŒ–ç­‰)ã€‚æˆ‘ä»¬å¸Œæœ›é›†æˆäº† transformer çš„ RWKV æž¶æž„èƒ½å¤Ÿä½¿æ›´å¤šå¼€å‘è€…å’Œä»Žä¸šè€…å—ç›Šã€‚

åœ¨ä¸ä¹…çš„å°†æ¥ï¼ŒRWKV è¿˜å¯ä»¥ä½¿ç”¨ [optimum](https://github.com/huggingface/optimum) åº“æå‡ºçš„åŠ é€ŸæŠ€æœ¯ã€‚[rwkv.cpp](https://github.com/saharNooby/rwkv.cpp) æˆ– [rwkv-cpp-cuda](https://github.com/harrisonvanderbyl/rwkv-cpp-cuda) ä»“åº“æ¶‰åŠçš„å…¶ä¸­ä¸€äº›æŠ€æœ¯åœ¨åº“ä¸­å·²æ ‡æ˜Žã€‚

### è‡´è°¢

æˆ‘ä»¬ Hugging Face å›¢é˜Ÿéžå¸¸æ„Ÿè°¢ Bo å’Œ RWKV ç¤¾åŒºæŠ½å‡ºå®è´µæ—¶é—´æ¥å›žç­”å…³äºŽæž¶æž„çš„é—®é¢˜ï¼Œä»¥åŠéžå¸¸æ„Ÿè°¢ä»–ä»¬çš„å¸®åŠ©å’Œæ”¯æŒã€‚æˆ‘ä»¬å¾ˆæœŸå¾…åœ¨ HF ç”Ÿæ€ä¸­çœ‹åˆ°æ›´å¤š RWKV æ¨¡åž‹çš„åº”ç”¨ã€‚æˆ‘ä»¬è¿˜è¦æ„Ÿè°¢ [Johan Wind](https://twitter.com/johanwind) å‘å¸ƒçš„å…³äºŽ RWKV çš„åšæ–‡ï¼Œè¿™å¯¹æˆ‘ä»¬ç†è§£æž¶æž„æœ¬èº«å’Œå…¶æ½œåŠ›æœ‰å¾ˆå¤§å¸®åŠ©ã€‚æœ€åŽï¼Œæˆ‘ä»¬ç€é‡æ„Ÿè°¢ [ArEnSc](https://github.com/ArEnSc) å¼€å¯ RWKV é›†æˆåˆ° `transformers` åº“çš„ PR æ‰€åšçš„å·¥ä½œï¼Œä»¥åŠæ„Ÿè°¢ [Merve Noyan](https://huggingface.co/merve)ã€[Maria Khalusova](https://huggingface.co/MariaK) å’Œ [Pedro Cuenca](https://huggingface.co/pcuenq) å®¡é˜…å’Œæ ¡å¯¹æœ¬ç¯‡æ–‡ç« ï¼

### å¼•ç”¨

å¦‚æžœæ‚¨å¸Œæœ›åœ¨å·¥ä½œä¸­ä½¿ç”¨ RWKVï¼Œè¯·ä½¿ç”¨æ­¤ [cff å¼•ç”¨](https://github.com/BlinkDL/RWKV-LM/blob/main/CITATION.cff)ã€‚

* * *

> è‹±æ–‡åŽŸæ–‡: [https://hf.co/blog/rwkv](https://hf.co/blog/rwkv)
> 
> ä½œè€…: BlinkDL, Harrison Vanderbyl, Sylvain Gugger, Younes Belkada
> 
> è¯‘è€…: SuSung-boy
> 
> å®¡æ ¡/æŽ’ç‰ˆ: zhongdongy (é˜¿ä¸œ)