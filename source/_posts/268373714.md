---
layout: post
title: "åˆ†äº«6ä¸ªSQLå°æŠ€å·§"
date: "2023-06-18T01:24:06.752Z"
---
åˆ†äº«6ä¸ªSQLå°æŠ€å·§
==========

> åŸåˆ›ï¼šæ‰£é’‰æ—¥è®°ï¼ˆå¾®ä¿¡å…¬ä¼—å·IDï¼šcodelogsï¼‰ï¼Œæ¬¢è¿åˆ†äº«ï¼Œéå…¬ä¼—å·è½¬è½½ä¿ç•™æ­¤å£°æ˜ã€‚

### ç®€ä»‹

ç»å¸¸æœ‰å°å“¥å‘å‡ºç–‘é—®ï¼ŒSQLè¿˜èƒ½è¿™ä¹ˆå†™ï¼Ÿæˆ‘ç»å¸¸ç¬‘ç€å›åº”ï¼ŒSQLç¡®å®å¯ä»¥è¿™ä¹ˆå†™ã€‚å…¶å®SQLå­¦èµ·æ¥ç®€å•ï¼Œç”¨èµ·æ¥ä¹Ÿç®€å•ï¼Œä½†å®ƒè¿˜æ˜¯èƒ½å†™å‡ºå¾ˆå¤šå˜åŒ–ï¼Œè¿™äº›å˜åŒ–è¯»æ‡‚å®ƒä¸éš¾ï¼Œä½†è¦è‡ªå·±Getåˆ°è¿™äº›å˜åŒ–ï¼Œå¯èƒ½éœ€è¦æƒ³ä¸€ä¼šæˆ–åœ¨ç½‘ä¸Šæ‰¾ä¸€ä¼šã€‚

#### å„ç§join

å…³äºjoinçš„ä»‹ç»ï¼Œæ¯”è¾ƒæµè¡Œçš„å°±æ˜¯è¿™å¼ å›¾äº†ï¼Œå¦‚ä¸‹ï¼š  
![join](https://img2023.cnblogs.com/blog/2792815/202306/2792815-20230617221551657-819443701.png)  
ç®€å•çš„è§£é‡Šå¦‚ä¸‹ï¼š

*   joinï¼šå†…è”æ¥ï¼Œä¹Ÿå¯å†™æˆinner joinï¼Œå–ä¸¤è¡¨å…³è”å­—æ®µç›¸äº¤çš„é‚£éƒ¨åˆ†æ•°æ®ã€‚
*   left joinï¼šå·¦å¤–è”æ¥ï¼Œä¹Ÿå¯å†™æˆleft outer joinï¼Œå–å·¦è¡¨æ•°æ®ï¼Œè‹¥å…³è”ä¸åˆ°å³è¡¨ï¼Œå³è¡¨ä¸ºç©ºã€‚
*   right joinï¼šå³å¤–è”æ¥ï¼Œä¹Ÿå¯å†™æˆright outer joinï¼Œå–å³è¡¨æ•°æ®ï¼Œè‹¥å…³è”ä¸åˆ°å·¦è¡¨ï¼Œå·¦è¡¨ä¸ºç©ºã€‚
*   full joinï¼šå…¨è”æ¥ï¼Œä¹Ÿå¯å†™æˆfull outer joinï¼Œå–å·¦è¡¨å’Œå³è¡¨ä¸­æ‰€æœ‰æ•°æ®ã€‚

ä½†æ³¨æ„ä¸Šå›¾ï¼Œé‡Œé¢è¿˜æœ‰å‡ ä¸ª`Key is null`çš„æƒ…å†µï¼Œå®ƒå¯ä»¥å°†ä¸¤è¡¨ç›¸äº¤çš„é‚£éƒ¨åˆ†æ•°æ®æ’é™¤æ‰ï¼  
ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œä¸€ç§å¾ˆå¸¸è§çš„SQLæŠ€å·§æ˜¯ï¼Œç”¨`left join`å¯æ›¿æ¢`not exists`ã€`not in`ç­‰ç›¸å…³å­æŸ¥è¯¢ï¼Œå¦‚ä¸‹ï¼š

    select * from tableA A 
    where not exists (select 1 from tableB B where B.Key=A.Key)
    
    -- ä½¿ç”¨left joinçš„ç­‰ä»·å†™æ³•
    select * from tableA A 
    left join tableB B on B.Key=A.Key where B.Key is null
    

ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œåªæœ‰å½“å·¦è¡¨çš„æ•°æ®åœ¨å³è¡¨ä¸­ä¸å­˜åœ¨æ—¶ï¼Œ`B.Key is null`æ‰æˆç«‹ã€‚

#### æŸ¥è¯¢å„ç±»åˆ«æœ€å¤§çš„é‚£æ¡æ•°æ®

æ¯”å¦‚åœ¨å­¦ç±ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæœ‰ä¸€ç±»å¾ˆå¸¸è§çš„éœ€æ±‚ï¼ŒæŸ¥è¯¢æ¯å­¦ç§‘åˆ†æ•°æœ€é«˜çš„é‚£æ¡æ•°æ®ï¼Œæœ‰å¦‚ä¸‹å‡ ç§å†™æ³•ï¼š

    select * from stu_score s 
    where s.course_id in ('Maths','English') 
    and s.score = (select max(score) from stu_score s1 where s1.course_id = s.course_id)
    

æ¯”è¾ƒå¥½ç†è§£ï¼Œè€ƒåˆ†æœ€é«˜å…¶å®å°±æ˜¯è¿‡æ»¤å‡ºåˆ†æ•°ç­‰äºæœ€å¤§åˆ†æ•°çš„è®°å½•ã€‚

åœ¨ä¸èƒ½ä½¿ç”¨å­æŸ¥è¯¢çš„åœºæ™¯ä¸‹ï¼Œä¹Ÿå¯è½¬æ¢æˆjoinï¼Œå¦‚ä¸‹ï¼š

    select * from stu_score s 
    left join stu_score s1 on s1.course_id = s.course_id and s1.score > s.score
    where s.course_id in ('Maths','English') and s1.id is null
    

è¿™å’Œå‰é¢ç”¨left joinæ”¹å†™not existsç±»ä¼¼ï¼Œé€šè¿‡`s1.id is null`è¿‡æ»¤å‡ºleft joinå…³è”æ¡ä»¶ä¸æ»¡è¶³æ—¶çš„æ•°æ®ï¼Œä»€ä¹ˆæƒ…å†µleft joinå…³è”æ¡ä»¶ä¸æ»¡è¶³å‘¢ï¼Œå½“sè¡¨è®°å½•æ˜¯åˆ†æ•°æœ€å¤§çš„é‚£æ¡è®°å½•æ—¶ï¼Œ`s1.score > s.score`æ¡ä»¶è‡ªç„¶å°±ä¸æˆç«‹äº†ï¼Œæ‰€ä»¥å®ƒè¿‡æ»¤å‡ºæ¥çš„æ•°æ®ï¼Œå°±æ˜¯å­¦ç§‘ä¸­åˆ†æ•°æœ€å¤§çš„é‚£æ¡è®°å½•ã€‚

ä¸€ç›´ä»¥æ¥ï¼Œæˆ‘çœ‹åˆ°SQLçš„joinçš„æ¡ä»¶å¤§éƒ½æ˜¯a.field=b.fieldè¿™ç§å½¢å¼ï¼Œå¯¼è‡´æˆ‘ä»¥ä¸ºjoinåªèƒ½å†™ç­‰å€¼æ¡ä»¶ï¼Œå®é™…ä¸Šï¼Œjoinæ¡ä»¶å’Œwhereä¸­ä¸€æ ·ï¼Œæ”¯æŒ`>`ã€`<`ã€`like`ã€`in`ç”šè‡³æ˜¯existså­æŸ¥è¯¢ç­‰æ¡ä»¶ï¼Œå¤§å®¶ä¹Ÿä¸€å®šä¸è¦å¿½è§†äº†è¿™ä¸€ç‚¹ã€‚

ä¸Šé¢åœºæ™¯è¿˜æœ‰ä¸€ç§å†™æ³•ï¼Œå°±æ˜¯ä½¿ç”¨group byå…ˆæŠŠå„å­¦ç§‘æœ€å¤§åˆ†ç®—å‡ºæ¥ï¼Œç„¶åå†å…³è”å‡ºç›¸åº”æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

    select * from
    (select s.course_id,max(s.score) max_score stu_score s where s.course_id in ('Maths','English') group by s.course_id) sm
    join stu_score s1 on s1.course_id = sm.course_id and s1.score=sm.max_score
    

#### æŸ¥è¯¢å„ç±»åˆ«top næ•°æ®

æ¯”å¦‚åœ¨å­¦ç±ç®¡ç†ç³»ç»Ÿä¸­ï¼ŒæŸ¥è¯¢æ¯å­¦ç§‘åˆ†æ•°å‰5çš„è®°å½•ï¼Œç±»ä¼¼è¿™ç§éœ€æ±‚ä¹Ÿå¾ˆå¸¸è§ï¼Œæ¯”è¾ƒç®€å•æ˜äº†çš„å†™æ³•å¦‚ä¸‹ï¼š

    select * from stu_score s 
    where s.course_id in ('Maths','English') 
    and (select count(*) from stu_score s1 where s1.course_id = s.course_id and s1.score > s.score) < 5
    

å¾ˆæ˜¾ç„¶ï¼Œç¬¬5ååªæœ‰4ä¸ªå­¦ç”Ÿæ¯”å®ƒåˆ†æ•°é«˜ï¼Œç¬¬4ååªæœ‰3ä¸ªå­¦ç”Ÿæ¯”å®ƒåˆ†æ•°é«˜ï¼Œä¾æ­¤ç±»æ¨ã€‚

#### LATERAL join

MySQL8ä¸ºjoinæä¾›äº†ä¸€ä¸ªæ–°çš„è¯­æ³•LATERALï¼Œä½¿å¾—è¢«å…³è”è¡¨Båœ¨è”æ¥å‰å¯ä»¥å…ˆæ ¹æ®å…³è”è¡¨Açš„å­—æ®µè¿‡æ»¤ä¸€ä¸‹ï¼Œç„¶åå†è¿›è¡Œå…³è”ã€‚

è¿™ä¸ªæ–°çš„è¯­æ³•ï¼Œå¯ä»¥éå¸¸ç®€å•çš„è§£å†³ä¸Šé¢`top n`çš„åœºæ™¯ï¼Œå¦‚ä¸‹ï¼š

    select * from stu_course c 
    join LATERAL (select * from stu_score s where c.course_id = s.course_id order by s.score desc limit 5) s1 on c.course_id = s1.course_id
    where c.course_name in ('æ•°å­¦','è‹±è¯­')
    

å¦‚ä¸Šï¼Œæ¯ä¸ªå­¦ç§‘æŸ¥è¯¢å‡ºå®ƒçš„å‰5åè®°å½•ï¼Œç„¶åå†å…³è”èµ·æ¥ã€‚

#### ç»Ÿè®¡å¤šä¸ªæ•°é‡

ä½¿ç”¨`count(*)`å¯ä»¥ç»Ÿè®¡æ•°é‡ï¼Œä½†æœ‰äº›åœºæ™¯æƒ³ç»Ÿè®¡å¤šä¸ªæ•°é‡ï¼Œå¦‚ç»Ÿè®¡1å¤©å†…å•é‡ã€1å‘¨å†…å•é‡ã€1æœˆå†…å•é‡ã€‚

ç”¨`count(*)`çš„è¯ï¼Œéœ€è¦æ‰«æ3æ¬¡è¡¨ï¼Œå¦‚ä¸‹ï¼š

    select count(*) from order where add_time > DATE_SUB(now(), INTERVAL 1 DAY)
    union all
    select count(*) from order where add_time > DATE_SUB(now(), INTERVAL 1 WEEK)
    union all
    select count(*) from order where add_time > DATE_SUB(now(), INTERVAL 1 MONTH)
    

å…¶å®æ‰«æä¸€æ¬¡è¡¨ä¹Ÿå¯ä»¥å®ç°ï¼Œç”¨sumæ¥ä»£æ›¿countå³å¯ï¼Œå¦‚ä¸‹ï¼š

    select sum(IF(add_time > DATE_SUB(now(), INTERVAL 1 DAY)), 1, 0) day_order_cnt,
    sum(IF(add_time > DATE_SUB(now(), INTERVAL 1 WEEK)), 1, 0) week_order_cnt,
    sum(IF(add_time > DATE_SUB(now(), INTERVAL 1 MONTH)), 1, 0) month_order_cnt
    from order where add_time > DATE_SUB(now(), INTERVAL 1 MONTH)
    

IFæ˜¯mysqlçš„é€»è¾‘åˆ¤æ–­å‡½æ•°ï¼Œå½“å…¶ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºtrueæ—¶ï¼Œè¿”å›ç¬¬äºŒä¸ªå‚æ•°å€¼ï¼Œå³1ï¼Œå¦åˆ™è¿”å›ç¬¬ä¸‰ä¸ªå‚æ•°å€¼0ï¼Œç„¶åå†ä½¿ç”¨sumåŠ èµ·æ¥ï¼Œå°±æ˜¯å„æ¡ä»¶ä¸ºtrueçš„æ•°é‡äº†ã€‚

#### æ•°æ®å¯¹æ¯”

æœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯”ä¸¤ä¸ªè¡¨çš„æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œæœ€ç®€å•çš„æ–¹æ³•ï¼Œå°±æ˜¯åœ¨ä¸¤è¾¹æŸ¥è¯¢å‡ºç»“æœé›†ï¼Œç„¶åé€è¡Œé€å­—æ®µå¯¹æ¯”ã€‚

ä½†æ˜¯è¿™æ ·å¯¹æ¯”çš„æ•ˆç‡æ¯”è¾ƒä½ä¸‹ï¼Œå› ä¸ºå®ƒè¦ä¸¤ä¸ªè¡¨çš„æ•°æ®å…¨éƒ½æŸ¥å‡ºæ¥ï¼Œå…¶å®æˆ‘ä»¬ä¸ä¸€å®šéè¦éƒ½æŸ¥å‡ºæ¥ï¼Œåªè¦è®¡ç®—å‡ºä¸€ä¸ªhashå€¼ï¼Œç„¶åå¯¹æ¯”hashå€¼å³å¯ï¼Œå¦‚ä¸‹ï¼š

    select BIT_XOR(CRC32(CONCAT(ifnull(column1,''),ifnull(column2,'')))) as checksum 
    from table_name where add_time > '2020-02-20' and add_time < '2020-02-21';  
    

å…ˆä½¿ç”¨CONCATå°†è¦å¯¹æ¯”çš„åˆ—è¿æ¥èµ·æ¥ï¼Œç„¶åä½¿ç”¨CRC32æˆ–MD5è®¡ç®—hashå€¼ï¼Œæœ€åä½¿ç”¨èšåˆå‡½æ•°BIT\_XORå°†å¤šè¡Œhashå€¼å¼‚æˆ–åˆå¹¶ä¸ºä¸€ä¸ªhashå€¼ã€‚

è¿™ä¸ªæŸ¥è¯¢æœ€ç»ˆåªä¼šè¿”å›1æ¡hashå€¼ï¼ŒæŸ¥è¯¢æ•°æ®é‡å¤§å¤§å‡å°‘äº†ï¼Œæ•°æ®å¯¹æ¯”æ•ˆç‡å°±ä¸Šå»äº†ã€‚

### æ€»ç»“

SQLçœ‹èµ·æ¥ç®€å•ï¼Œå…¶å®æœ‰å¾ˆå¤šç»†èŠ‚ä¸æŠ€å·§ï¼Œå¦‚æœä½ ä¹Ÿæœ‰å…¶å®ƒæŠ€å·§ï¼Œæ¬¢è¿ç•™è¨€åˆ†äº«è®¨è®ºğŸ˜ƒ