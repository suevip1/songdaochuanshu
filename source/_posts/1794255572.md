---
layout: post
title: "Cypress è¸©å‘è®° - DOM é®æŒ¡"
date: "2023-05-17T01:09:48.753Z"
---
Cypress è¸©å‘è®° - DOM é®æŒ¡
====================

> `Cypress` æ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„æµ‹è¯•å·¥å…·ï¼Œç„¶è€Œå®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°ä¸€äº›é—®é¢˜ï¼Œè¿™é‡Œåšäº›è®°å½•ã€‚

é—®é¢˜å‘ç°
----

åœ¨ `Cypress` ä¸‹ `click` æ˜¯éå¸¸å¸¸ç”¨çš„æŒ‡ä»¤ï¼Œç„¶è€Œåœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸‹ `click` å¹¶ä¸èƒ½å¦‚æƒ³è±¡ä¸­é‚£èˆ¬æ­£å¸¸å·¥ä½œã€‚

æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªå¼¹çª—ï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•åœ¨ç‚¹å‡»é®ç½©å±‚æ—¶æ˜¯å¦å¯ä»¥æ­£å¸¸å…³é—­å¼¹çª—ã€‚

![picture 1](https://stg.heyfe.org/images/wip-cypress-hard-point-1684240200898.png)

æµ‹è¯•ä»£ç æ¯”è¾ƒç®€å•ï¼š

    /// <reference types="cypress" />
    
    context('Actions', () => {
        beforeEach(() => {
            cy.visit('http://localhost:3300/Modal');
        });
    
        it('Override', () => {
            cy.get('.mantine-Button-root').click();
            cy.get('.mantine-Modal-root').should('exist');
            cy.get('.mantine-Modal-overlay').click();
        });
    });
    

ç„¶åæ‰§è¡Œ `Cypress`ï¼Œå‘ç°ä¸€åˆ‡å¦‚æƒ³è±¡ä¸­é‚£èˆ¬ç®€å•ï¼Œå¾ˆé¡ºåˆ©å°±é€šè¿‡äº†ã€‚

![picture 2](https://stg.heyfe.org/images/wip-cypress-hard-point-1684240349883.png)

ç„¶è€Œå½“å¾€ `Model` ä¸­å¡«å……äº†ä¸€äº›å†…å®¹åï¼Œå´å‘ç°çªç„¶è¿™é‡Œå°±æŠ¥é”™äº†ã€‚

![picture 3](https://stg.heyfe.org/images/wip-cypress-hard-point-1684240550385.png)

å½“ç„¶ï¼ŒæŠ¥é”™æ˜¯æ²¡é—®é¢˜ï¼Œé®ç½©å±‚ç¡®å®è¢«å†…å®¹é®æŒ¡äº†ã€‚é—®é¢˜æ˜¯åˆšåˆšæ˜æ˜ä¹Ÿæ˜¯ä¸€æ ·è¢«é®æŒ¡ï¼Œä¸ºä½•å°±ä¸æŠ¥é”™ï¼Œåªæ˜¯å› ä¸ºå†…å®¹å¤šäº†ä¸€ç‚¹å°±æŠ¥é”™ï¼Œè¿™å°±å¾ˆä¸åˆé€‚äº†ã€‚

æŸ¥çœ‹æ–‡æ¡£ä¼šå‘ç° `click` è¿˜æ”¯æŒåæ ‡æˆ–ä½ç½®å‚æ•°ã€‚

![picture 4](https://stg.heyfe.org/images/wip-cypress-hard-point-1684241089587.png)

ç„¶è€Œï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç‚¹å‡»ä½ç½®æ— å…³ï¼Œåº”è¯¥æ˜¯å’Œ `Cypress` åˆ¤æ–­å…ƒç´ é®æŒ¡æœ‰å…³ç³»ï¼Œçœ‹èµ·æ¥ `Cypress` é®æŒ¡è®¡ç®—è¿˜éœ€è¦ä¼˜åŒ–ã€‚

åŸå› æ’æŸ¥
----

æ’æŸ¥æºç å¯ä»¥å‘ç° `Cypress` çš„ `click` ä¼šç»è¿‡ä¸€äº›åˆ¤å®šï¼š

    if (force !== true) {
        // now that we know our element isn't animating its time
        // to figure out if it's being covered by another element.
        // this calculation is relative from the viewport so we
        // only care about fromElViewport coords
        $elAtCoords =
            options.ensure.notCovered && ensureElIsNotCovered(cy, win, $el, coords.fromElViewport, options, _log, onScroll);
        Cypress.ensure.isNotHiddenByAncestors($el, name, _log);
    }
    

å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å‚æ•°æ˜¯ `coords.fromElViewport`ï¼Œå…¶æ•°å€¼é•¿è¿™æ ·ï¼š

    {
        "top": 0,
        "left": 0,
        "right": 1000,
        "bottom": 660,
        "topCenter": 330,
        "leftCenter": 500,
        "x": 500,
        "y": 330
    }
    

æ³¨æ„å…¶ä¸­çš„ `x` å’Œ `y`ï¼Œå¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸­å¿ƒç‚¹çš„åæ ‡ã€‚

ç„¶å `Cypress` ä¼šä½¿ç”¨è¯¥åæ ‡è·å–è¯¥ä½ç½®æœ€é¡¶å±‚çš„å…ƒç´ ï¼š

    const getElementAtPointFromViewport = function (fromElViewport) {
        // get the element at point from the viewport based
        // on the desired x/y normalized coordinations
        let elAtCoords;
    
        elAtCoords = $dom.getElementAtPointFromViewport(win.document, fromElViewport.x, fromElViewport.y);
    
        if (elAtCoords) {
            $elAtCoords = $dom.wrap(elAtCoords);
    
            return $elAtCoords;
        }
    
        return null;
    };
    
    const ensureDescendents = function (fromElViewport) {
        // figure out the deepest element we are about to interact
        // with at these coordinates
        $elAtCoords = getElementAtPointFromViewport(fromElViewport);
        debug('elAtCoords', $elAtCoords);
        debug('el has pointer-events none?');
        ensureElDoesNotHaveCSS($el, 'pointer-events', 'none', name, log);
        debug('is descendent of elAtCoords?');
        ensureIsDescendent($el, $elAtCoords, name, log);
    
        return $elAtCoords;
    };
    

å¯ä»¥å‘ç°è¿™é‡Œç›´æ¥ä½¿ç”¨ `x` å’Œ `y` å»è·å–å…ƒç´ ï¼Œç„¶åå’Œå½“å‰ç›®æ ‡å…ƒç´ å»åšäº†å¯¹æ¯”ã€‚

è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ `click` æœ‰æ—¶å€™å¯ä»¥ç‚¹ï¼Œæœ‰æ—¶å€™ä¸å¯ä»¥çš„åŸå› äº†ï¼Œç®€å•è¯´å°±æ˜¯ä¸­å¿ƒç‚¹è¢«é®äº†å°±å¯ä»¥ç‚¹ï¼Œæ²¡è¢«é®å°±ä¸å¯ä»¥ç‚¹ï¼Œè¿˜çœŸæ˜¯ç®€å•ç²—æš´ ğŸ˜‚ã€‚è¿™ä¹Ÿå¯¼è‡´äº† `click` çš„ä¸ç¨³å®šç°è±¡ã€‚

ç»“æœéªŒè¯
----

é‚£æˆ‘ä»¬æ¥éªŒè¯ä¸‹æ˜¯ä¸æ˜¯å¦‚æ­¤ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªéå¸¸å°çš„é®æŒ¡å…ƒç´ ï¼Œç„¶åæ”¾åœ¨ä¸­å¤®ä½ç½®ï¼Œæµ‹è¯•ä¸‹æ˜¯ä¸æ˜¯ä¼šå‡ºé—®é¢˜ã€‚ä»£ç å¦‚ä¸‹ï¼š

    import style from './Covered-1.module.css';
    const Covered = () => {
        return (
            <div className={style.parent} data-test-id='parent'>
                <div className={style.mask} data-test-id='mask'></div>
                <div className={style.child} data-test-id='child'></div>
            </div>
        );
    };
    export default Covered;
    

    .parent {
        width: 100%;
        height: 100%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .mask {
        background: rgb(0, 0, 0, 0.3);
        position: absolute;
        inset: 0;
    }
    .child {
        background: purple;
        width: 5px;
        height: 5px;
        z-index: 10;
    }
    

æµ‹è¯•ç”¨ä¾‹å°±ç‚¹å‡» `mask` å³å¯ã€‚

    /// <reference types="cypress" />
    
    context('Actions', () => {
        beforeEach(() => {
            cy.visit('http://localhost:3300/Covered-1');
        });
    
        it('Override', () => {
            cy.get('[data-test-id="mask"]').click();
        });
    });
    

ç»“æœæœç„¶ä¸å‡ºæ‰€æ–™ï¼š

![picture 1](https://stg.heyfe.org/images/wip-cypress-hard-point-dom-covered-1684246337600.png)

ä¸ºäº†ä¸¥è°¨ï¼Œæˆ‘ä»¬å†æµ‹è¯•ä¸‹å¦ä¸€ä¸ª `case`ï¼Œæˆ‘ä»¬å°†å››å‘¨å…¨éƒ¨ç”¨å…ƒç´ é®æŒ¡ä½ï¼Œåªç•™ä¸‹ä¸­å¿ƒä¸€ç‚¹ï¼Œç„¶åç‚¹å‡»ï¼ŒéªŒè¯ä¸‹æ˜¯ä¸æ˜¯å¯ä»¥æ­£å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š

    import style from './Covered-2.module.css';
    const Covered = () => {
        return (
            <div className={style.parent} data-test-id='parent'>
                <div className={style.mask} data-test-id='mask'></div>
                <div className={style.child + ' ' + style.left} data-test-id='child'></div>
                <div className={style.child + ' ' + style.right} data-test-id='child'></div>
                <div className={style.child + ' ' + style.top} data-test-id='child'></div>
                <div className={style.child + ' ' + style.bottom} data-test-id='child'></div>
            </div>
        );
    };
    export default Covered;
    

    .parent {
        width: 100%;
        height: 100%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .mask {
        background: rgb(0, 0, 0, 0.3);
        position: absolute;
        inset: 0;
    }
    .child {
        background: purple;
        z-index: 10;
        position: absolute;
        top: 0;
        left: 0;
    }
    .left,
    .right {
        width: 49%;
        height: 100%;
    }
    .right {
        right: 0;
        left: unset;
    }
    .top,
    .bottom {
        height: 49%;
        width: 100%;
    }
    .bottom {
        top: unset;
        bottom: 0;
    }
    

æµ‹è¯•ä»£ç æ— éœ€æ›´æ”¹ï¼š

    /// <reference types="cypress" />
    
    context('Actions', () => {
        beforeEach(() => {
            cy.visit('http://localhost:3300/Covered-2');
        });
    
        it('Override', () => {
            cy.get('[data-test-id="mask"]').click();
        });
    });
    

ä¸å‡ºæ‰€æ–™ï¼Œæœç„¶å¯ä»¥ç‚¹å‡»ã€‚

![picture 2](https://stg.heyfe.org/images/wip-cypress-hard-point-dom-covered-1684246780981.png)

æœ€å
--

è¯´å®åœ¨çš„ `Cypress` è¿™æ ·çš„é®æŒ¡æ£€æŸ¥æ–¹å¼ä¸å¤ªå¦¥å½“ï¼Œè¿‡äºç®€å•ç²—æš´è€Œä¸”å¾ˆå®¹æ˜“è®©äººå›°æƒ‘ã€‚ç†è®ºä¸Šè€Œè¨€å¯ä»¥ä½¿ç”¨ `layer` å±‚å±‚æ¯”å¯¹äº¤å‰åŒºåŸŸæ¥åˆ¤å®šæ›´ä¸ºå¦¥å½“ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯æœ‰ä»€ä¹ˆæ–‡æ¡£å¯¼è‡´æ”¾å¼ƒäº†ã€‚

è¿˜æœ‰ç‚¹å‡»çš„æ–¹å¼æ„Ÿè§‰ä¹Ÿå¯ä»¥å†ä¼˜åŒ–ä¸€ä¸‹ï¼Œæ¯”å¦‚æä¾›äº†åæ ‡æˆ–è€…æ–¹ä½ï¼Œé‚£å°±åº”è¯¥ä»¥æä¾›çš„åæ ‡æˆ–æ–¹ä½æ¥åšé®æŒ¡åˆ¤å®šï¼Œç°åœ¨é‡åˆ°è¿™ç§æƒ…å†µåªèƒ½ä½¿ç”¨ `force`ï¼Œç„¶è€Œä½¿ç”¨äº† `force` è¿™ä¸ªæµ‹è¯•çš„æ„ä¹‰å°±å°‘äº†ä¸€å¤§åŠã€‚