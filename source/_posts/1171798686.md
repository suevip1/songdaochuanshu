---
layout: post
title: ".Net Coreåç«¯æ¶æ„å®æˆ˜ã€3-ä»‹å…¥IOCæ§åˆ¶åè½¬ã€‘"
date: "2023-06-05T01:18:16.455Z"
---
.Net Coreåç«¯æ¶æ„å®æˆ˜ã€3-ä»‹å…¥IOCæ§åˆ¶åè½¬ã€‘
============================

> æ‘˜è¦ï¼šåŸºäº.NET Core 7.0WebApiåç«¯æ¶æ„å®æˆ˜ã€2-ä»‹å…¥IOCæ§åˆ¶åè½¬ã€‘Â Â 2023/04/09, ASP.NET Core 7.0, VS2022

å¼•è¨€
--

    Inversion of Control,ç®€ç§°IOCï¼Œå³æ§åˆ¶åè½¬ã€‚è®°å¾—å½“åˆåˆšå®ä¹ çš„æ—¶å€™å…¬å¸çš„å¸¦æˆ‘çš„äººå’Œæˆ‘æåˆ°è¿‡IOCè¿™ä¸ªæ¦‚å¿µï¼Œå½“åˆå®Œå…¨ä¸çŸ¥é“æ˜¯  
å•¥ä¸œè¥¿ã€‚åæ¥æœ‰å¹¸å†™äº†åŠå¹´Java,SpringBooté‡Œé¢ä¸šåŠ¡å¼€å‘éšå¤„å¯è§IOCã€‚å†åæ¥æˆ‘å†™.Net Coreç”¨åˆ°çš„ç¬¬ä¸€ä¸ªæ¡†æ¶Blog.Coreé¡¹ç›®ï¼Œå®ƒé‡Œ  
é¢IRepositoryä¸Repositoryå’ŒIServicesä¸Servicesï¼Œè¿™ç§è§£è€¦çš„ç¨‹åº¦å•è¯´å®ƒè´¯å½»ä¾èµ–å€’ç½®åŸåˆ™æ˜¯éå¸¸niceçš„ï¼.NetCoreæ—¶ä»£æ›´åŠ æ³¨  
é‡é¢å‘æ¥å£ç¼–ç¨‹ï¼Œå¹¶ä¸”å®ƒå†…ç½®è½»é‡å‹çš„IOCå®¹å™¨å¯å¸®åŠ©æˆ‘ä»¬çµæ´»çš„è¿›è¡Œå¼€å‘ã€‚

ä¾èµ–æ³¨å…¥
----

> Dependency Injectionï¼Œä½•ä¸ºä¾èµ–æ³¨å…¥ï¼Ÿç”±å®¹å™¨åŠ¨æ€çš„å°†å¯¹è±¡ä¾èµ–çš„èµ„æºæ³¨å…¥åˆ°å¯¹è±¡ä¹‹ä¸­ã€‚å‡è®¾å®¹å™¨åœ¨æ„é€ å¯¹è±¡Aæ—¶ï¼Œå¯¹è±¡Açš„æ„é€ ä¾èµ–å¯¹è±¡Bã€å¯¹è±¡Cã€å¯¹è±¡Dè¿™äº›å‚æ•°ï¼Œå®¹å™¨ä¼šå°†è¿™äº›ä¾èµ–å…³ç³»è‡ªåŠ¨æ„é€ å¥½ï¼Œæœ€å¤§é™åº¦çš„å®Œæˆç¨‹åºçš„è§£è€¦ã€‚ä¾èµ–æ³¨å…¥(Dependency Injection,ç®€ç§°DI)å°±æ˜¯æ„é€ Aå¯¹è±¡æ—¶ï¼Œéœ€è¦ä¾èµ–Bå¯¹è±¡ï¼Œé‚£ä¹ˆå°±å…ˆæ„é€ Bå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’åˆ°Aå¯¹è±¡ï¼Œè¿™ç§å¯¹è±¡åˆå§‹åŒ–å¹¶æ³¨å…¥çš„æŠ€æœ¯å°±å«åšä¾èµ–æ³¨å…¥ã€‚

.NetCoreæœ¬èº«å°±é›†æˆäº†ä¸€ä¸ªè½»é‡å‹çš„IOCå®¹å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç¨‹åºä¸­çš„æŠ½è±¡ï¼ˆInterfaceï¼‰æˆ–ä¸šåŠ¡ç±»æ ¹æ®éœ€è¦çš„ç”Ÿå‘½å‘¨æœŸé…ç½®åˆ°å®¹å™¨ä¸­ã€‚ä»–ä¸æ˜¯ä¸€æ¬¡æŠŠæ‰€æœ‰çš„å®ä¾‹éƒ½æ„é€ å‡ºæ¥ï¼Œå½“ä½ åœ¨ç”¨çš„æ—¶å€™ä»–æ‰ä¼šå»æ„é€ å®ä¾‹ï¼.NetCoreå†…ç½®çš„IOCå®¹å™¨åªæ”¯æŒæ„é€ å‡½æ•°æ³¨å…¥ï¼

å¦‚ä¸‹ä¸‰ç§ç”Ÿå‘½å‘¨æœŸçš„æ³¨å…¥ï¼š

![](https://img2023.cnblogs.com/blog/1677460/202304/1677460-20230409143345156-241427938.png)

`Singleton`ï¼šåœ¨ç¬¬ä¸€æ¬¡è¢«è¯·æ±‚çš„æ—¶å€™è¢«åˆ›å»ºï¼Œå¯¹è±¡çš„æ„é€ å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ç„¶åä¸€ç›´ä¼šå­˜åœ¨å†…å­˜ä¸­ä¹‹åå°±ä¸€ç›´ä½¿ç”¨è¿™ä¸€ä¸ªå®ä¾‹ã€‚å¦‚æœåœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨äº†Singleton,è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œä¿è¯å®ƒä¸ä¼šæœ‰å†²çªã€‚

`Scoped`ï¼šä¸€ä¸ªè¯·æ±‚åªåˆ›å»ºè¿™ä¸€ä¸ªå®ä¾‹ï¼Œè¯·æ±‚ä¼šè¢«å½“æˆä¸€ä¸ªèŒƒå›´ï¼Œä¹Ÿå°±æ˜¯è¯´å•ä¸ªè¯·æ±‚å¯¹è±¡çš„æ„é€ å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼ŒåŒä¸€æ¬¡è¯·æ±‚å†…æ³¨å…¥å¤šæ¬¡ä¹Ÿç”¨çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚å‡å¦‚ä¸€ä¸ªè¯·æ±‚ä¼šç©¿é€åº”ç”¨å±‚ã€é¢†åŸŸå±‚ã€åŸºç¡€è®¾æ–½å±‚ç­‰ç­‰å„å±‚ï¼Œåœ¨ç©¿å±‚çš„è¿‡ç¨‹ä¸­è‚¯å®šä¼šæœ‰åŒä¸€ä¸ªç±»çš„å¤šæ¬¡æ³¨å…¥ï¼Œé‚£è¿™äº›å¤šæ¬¡æ³¨å…¥åœ¨è¿™ä¸ªä½œç”¨åŸŸä¸‹ç»´æŒçš„å°±æ˜¯å•ä¾‹ã€‚ä¾‹å¦‚å·¥ä½œå•å…ƒæ¨¡å¼å°±å¯ä»¥å€ŸåŠ©è¿™ç§æ¨¡å¼çš„ç”Ÿå‘½å‘¨æœŸæ¥å®ç°ï¼ŒåƒEF Coreçš„DbContextä¸Šä¸‹æ–‡å°±è¢«æ³¨å†Œä¸ºä½œç”¨åŸŸæœåŠ¡ã€‚

`Transient`ï¼šæ¯æ¬¡è¯·æ±‚æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œåªè¦æ³¨å…¥ä¸€æ¬¡ï¼Œæ„é€ å‡½æ•°å°±ä¼šæ‰§è¡Œä¸€æ¬¡å³å®ä¾‹åŒ–ä¸€æ¬¡ã€‚Scopedã€Transientçš„åŒºåˆ«æ˜¯ä½ åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­æ˜¯å¦æœŸæœ›ä½¿ç”¨åŒä¸€ä¸ªå®ä¾‹ï¼Œå¦‚æœæ˜¯ï¼Œç”¨Scopedï¼Œåä¹‹åˆ™ä½¿ç”¨Transientã€‚

ğŸ˜Šæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹.Net Coreä¸­ç›¸å…³IOCæ ¸å¿ƒæºç ğŸ˜Š

IOCæºç 
-----

### ServiceDescriptor

è¿™ä¸ªç±»æ˜¯ç”¨æ¥æè¿°æœåŠ¡æ³¨å†Œæ—¶çš„æœåŠ¡ç±»å‹ã€å®ä¾‹ç±»å‹ã€å®ç°ç±»å‹ã€ç”Ÿå‘½å‘¨æœŸç­‰ä¿¡æ¯ã€‚å°±å¦‚åŒä»–æœ¬èº«çš„æè¿°ï¼šDescribes a service with its service type, implementation, and lifetime.Â  Â  Â  Â 

DIå®¹å™¨ServiceProviderä¹‹æ‰€ä»¥èƒ½å¤Ÿæ ¹æ®æˆ‘ä»¬ç»™å®šçš„æœåŠ¡ç±»å‹ï¼ˆä¸€èˆ¬æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼‰æä¾›ä¸€ä¸ªèƒ½å¤Ÿå¼€ç®±å³ç”¨çš„æœåŠ¡å®ä¾‹ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬é¢„å…ˆæ³¨å†Œäº†ç›¸åº”çš„æœåŠ¡æè¿°ä¿¡æ¯ï¼Œå°±æ˜¯è¯´ServiceDescriptorä¸ºå®¹å™¨æä¾›äº†æ­£ç¡®çš„æœåŠ¡ä¿¡æ¯ä»¥ä¾›å®¹å™¨é€‰æ‹©å¯¹åº”çš„å®ä¾‹ã€‚

è¿™ä¸ªç±»ä¸€å…±æœ‰å››ä¸ªæ„é€ å‡½æ•°ï¼Œæœ¬è´¨å…¶å®å°±æ˜¯ç»™æè¿°å…·ä½“æ³¨å†Œçš„Lifetimeã€ServiceTypeã€ImplementationTypeã€ImplementationInstanceã€ImplementationFactoryèµ‹å€¼ã€‚è¯·çœ‹æºç ï¼š

è¿™é‡Œçš„è¯åªåˆ—ä¸¾å…¶ä¸­çš„ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå› ä¸ºæˆ‘å‘ç°åœ¨æ–‡ç« ä¸­æºç ä¸èƒ½ç½—åˆ—çš„å¤ªå¤šï¼Œä¸ç„¶è®©äººçœ‹å¾—å«Œçƒ¦ğŸ˜…

ä¸‹é¢è¿™ä¸ªæ„é€ å‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯æœåŠ¡å…ƒç´ çš„ç±»å‹ï¼ŒæœåŠ¡å…ƒç´ å®ä¾‹ï¼Œé»˜è®¤æ˜¯å•ä¾‹çš„ï¼Œå…¶å®ƒçš„å‡ ä¸ªæ„é€ å‡½æ•°éƒ½ä¸å…¶å¾ˆç›¸ä»¿ã€‚

    /// <summary>
    /// Initializes a new instance of <see cref="ServiceDescriptor"/> with the specified <paramref name="instance"/>
    /// as a <see cref="ServiceLifetime.Singleton"/>.
    /// </summary>
    /// <param name="serviceType">The <see cref="Type"/> of the service.</param>
    /// <param name="instance">The instance implementing the service.</param>
    public ServiceDescriptor(
        Type serviceType,
        object instance)
        : this(serviceType, ServiceLifetime.Singleton)
    {
        if (serviceType == null)
        {
            throw new ArgumentNullException(nameof(serviceType));
        }
        if (instance == null)
        {
            throw new ArgumentNullException(nameof(instance));
        }
        ImplementationInstance = instance;
    }

Â æˆ‘ä»¬å†æ¥çœ‹ä¸‹å®ƒé‡Œé¢å‡ ä¸ªé‡è¦çš„å‡½æ•°ï¼š

â‘ `Describe()`å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯ç”¨æ¥ç”Ÿæˆ`ServiceDescriptor`ç±»çš„ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”ä¸Šé¢çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ºå®ä¾‹åŒ–`ServiceDescriptor`æä¾›å¦å¤–ä¸€ç§æ–¹å¼ã€‚æºç å¦‚ä¸‹ï¼š

    private static ServiceDescriptor Describe<TService, TImplementation>(ServiceLifetime lifetime)
        where TService : class
        where TImplementation : class, TService
    {
        return Describe(
            typeof(TService),
            typeof(TImplementation),
            lifetime: lifetime);
    }
    /// <summary>
    /// Creates an instance of <see cref="ServiceDescriptor"/> with the specified
    /// <paramref name="serviceType"/>, <paramref name="implementationType"/>,
    /// and <paramref name="lifetime"/>.
    /// </summary>
    /// <param name="serviceType">The type of the service.</param>
    /// <param name="implementationType">The type of the implementation.</param>
    /// <param name="lifetime">The lifetime of the service.</param>
    /// <returns>A new instance of <see cref="ServiceDescriptor"/>.</returns>
    public static ServiceDescriptor Describe(Type serviceType, Type implementationType, ServiceLifetime lifetime)
    {
        return new ServiceDescriptor(serviceType, implementationType, lifetime);
    }
    /// <summary>
    /// Creates an instance of <see cref="ServiceDescriptor"/> with the specified
    /// <paramref name="serviceType"/>, <paramref name="implementationFactory"/>,
    /// and <paramref name="lifetime"/>.
    /// </summary>
    /// <param name="serviceType">The type of the service.</param>
    /// <param name="implementationFactory">A factory to create new instances of the service implementation.</param>
    /// <param name="lifetime">The lifetime of the service.</param>
    /// <returns>A new instance of <see cref="ServiceDescriptor"/>.</returns>
    public static ServiceDescriptor Describe(Type serviceType, Func<IServiceProvider, object> implementationFactory, ServiceLifetime lifetime)
    {
        return new ServiceDescriptor(serviceType, implementationFactory, lifetime);
    }

â‘¡`Singleton()`å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸€å…±æœ‰ä¸ƒä¸ªé‡è½½ï¼Œæˆ‘åªè´´å‡ºå…¶ä¸­ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶å®ƒå‡ ä¸ªéƒ½å·®ä¸å¤šï¼Œæ€»ä¹‹å°±æ˜¯ä¸€å¥è¯ç”¨äºç”Ÿæˆå•ä¾‹åŒ–çš„`ServiceDescriptor`ç±»ã€‚æºç å¦‚ä¸‹ï¼š

    /// <summary>
    /// Creates an instance of <see cref="ServiceDescriptor"/> with the specified
    /// <typeparamref name="TService"/>, <typeparamref name="TImplementation"/>,
    /// and the <see cref="ServiceLifetime.Singleton"/> lifetime.
    /// </summary>
    /// <typeparam name="TService">The type of the service.</typeparam>
    /// <typeparam name="TImplementation">The type of the implementation.</typeparam>
    /// <returns>A new instance of <see cref="ServiceDescriptor"/>.</returns>
    public static ServiceDescriptor Singleton<TService, TImplementation>()
        where TService : class
        where TImplementation : class, TService
    {
        return Describe<TService, TImplementation>(ServiceLifetime.Singleton);
    }
    /// <summary>
    /// Creates an instance of <see cref="ServiceDescriptor"/> with the specified
    /// <paramref name="service"/> and <paramref name="implementationType"/>
    /// and the <see cref="ServiceLifetime.Singleton"/> lifetime.
    /// </summary>
    /// <param name="service">The type of the service.</param>
    /// <param name="implementationType">The type of the implementation.</param>
    /// <returns>A new instance of <see cref="ServiceDescriptor"/>.</returns>
    public static ServiceDescriptor Singleton(Type service, Type implementationType)
    {
        if (service == null)
        {
            throw new ArgumentNullException(nameof(service));
        }
        if (implementationType == null)
        {
            throw new ArgumentNullException(nameof(implementationType));
        }
        return Describe(service, implementationType, ServiceLifetime.Singleton);
    }
    /// <summary>
    /// Creates an instance of <see cref="ServiceDescriptor"/> with the specified
    /// <paramref name="serviceType"/>, <paramref name="implementationInstance"/>,
    /// and the <see cref="ServiceLifetime.Scoped"/> lifetime.
    /// </summary>
    /// <param name="serviceType">The type of the service.</param>
    /// <param name="implementationInstance">The instance of the implementation.</param>
    /// <returns>A new instance of <see cref="ServiceDescriptor"/>.</returns>
    public static ServiceDescriptor Singleton(
        Type serviceType,
        object implementationInstance)
    {
        if (serviceType == null)
        {
            throw new ArgumentNullException(nameof(serviceType));
        }
        if (implementationInstance == null)
        {
            throw new ArgumentNullException(nameof(implementationInstance));
        }
        return new ServiceDescriptor(serviceType, implementationInstance);
    }

â‘¢`Scoped()`å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ‰äº”ä¸ªé‡è½½ï¼Œå…¶å®ä»–å†…éƒ¨è¿˜æ˜¯è°ƒç”¨`Describe()`æ–¹æ³•æ¥ç”Ÿæˆä½œç”¨åŸŸçš„`ServiceDescriptor`ç±»ã€‚æºç å¦‚ä¸‹ï¼š

    /// <summary>
    /// Creates an instance of <see cref="ServiceDescriptor"/> with the specified
    /// <typeparamref name="TService"/>, <typeparamref name="TImplementation"/>,
    /// and the <see cref="ServiceLifetime.Scoped"/> lifetime.
    /// </summary>
    /// <typeparam name="TService">The type of the service.</typeparam>
    /// <typeparam name="TImplementation">The type of the implementation.</typeparam>
    /// <returns>A new instance of <see cref="ServiceDescriptor"/>.</returns>
    public static ServiceDescriptor Scoped<TService, TImplementation>()
        where TService : class
        where TImplementation : class, TService
    {
        return Describe<TService, TImplementation>(ServiceLifetime.Scoped);
    }
    /// <summary>
    /// Creates an instance of <see cref="ServiceDescriptor"/> with the specified
    /// <paramref name="service"/> and <paramref name="implementationType"/>
    /// and the <see cref="ServiceLifetime.Scoped"/> lifetime.
    /// </summary>
    /// <param name="service">The type of the service.</param>
    /// <param name="implementationType">The type of the implementation.</param>
    /// <returns>A new instance of <see cref="ServiceDescriptor"/>.</returns>
    public static ServiceDescriptor Scoped(Type service, Type implementationType)
    {
        return Describe(service, implementationType, ServiceLifetime.Scoped);
    }

é€šè¿‡`Scoped()`æ–¹æ³•æˆ‘ä»¬å¯ä»¥è¿™æ ·æ³¨å†Œï¼š

    services.Add(ServiceDescriptor.Scoped<IPersonService, PersonService>());
    //services.Add(ServiceDescriptor.Scoped(typeof(IPersonService),typeof(PersonService)));
    //æˆ–
    services.Add(ServiceDescriptor.Transient<IPersonService, PersonService>());
    //services.Add(ServiceDescriptor.Transient(typeof(IPersonService), typeof(PersonService)));
    //æˆ–
    services.Add(ServiceDescriptor.Singleton<IPersonService, PersonService>());
    //services.Add(ServiceDescriptor.Singleton(typeof(IPersonService), typeof(PersonService)));

è¿™ç§æ³¨å†Œæ–¹å¼æ˜¯é€šè¿‡`ServiceDescriptor`è‡ªèº«çš„æ“ä½œå»æ³¨å†Œç›¸å…³å®ä¾‹ï¼Œæˆ‘ä»¬æ‹¿å‡ºæ¥å…¶ä¸­ä¸€ä¸ª`Transient`æ–¹æ³•çœ‹ä¸€ä¸‹å…·ä½“å®ç°ï¼š

    public static ServiceDescriptor Transient<TService, TImplementation>()
        where TService : class
        where TImplementation : class, TService
    {
        //éƒ½æ˜¯åœ¨è°ƒç”¨Describe
        return Describe<TService, TImplementation>(ServiceLifetime.Transient);
    }
     
     
    public static ServiceDescriptor Transient(Type service, Type implementationType)
    {
        //éƒ½æ˜¯åœ¨è°ƒç”¨Describe
        return Describe(service, implementationType, ServiceLifetime.Transient);
    }
     
     
    public static ServiceDescriptor Describe(Type serviceType, Type implementationType, ServiceLifetime lifetime)
    {
        //è¿˜æ˜¯è¿”å›ServiceDescriptorå®ä¾‹
        return new ServiceDescriptor(serviceType, implementationType, lifetime);
    }
     
     
    public static ServiceDescriptor Describe(Type serviceType, Func<IServiceProvider, object> implementationFactory, ServiceLifetime lifetime)
    {
        //è¿˜æ˜¯è¿”å›ServiceDescriptorå®ä¾‹
        return new ServiceDescriptor(serviceType, implementationFactory, lifetime);
    }

é€šè¿‡è¿™ä¸ªæˆ‘ä»¬å°±å¯ä»¥äº†è§£åˆ°`ServiceDescriptor.Singleton`ã€`ServiceDescriptor.Scoped`ã€`ServiceDescriptor.Transient`å…¶å®æ˜¯è°ƒç”¨çš„`Describe()`æ–¹æ³•,`Describe()`çš„æœ¬èº«è¿˜æ˜¯å»å®ä¾‹åŒ–`ServiceDescriptor`ï¼Œæ®Šé€”åŒå½’ï¼Œåªæ˜¯å¤šäº†ç§å†™æ³•ï¼Œæœ€ç»ˆè¿˜æ˜¯å»æ„å»º`ServiceDescriptor`ã€‚é€šè¿‡è¿™ä¹ˆå¤šæºç çš„åˆ†æå¾—å‡ºçš„ç»“è®ºå°±ä¸€ç‚¹`IServiceCollection`æ³¨å†Œçš„æœ¬è´¨å°±æ˜¯åœ¨æ„å»º`ServiceDescriptor`é›†åˆã€‚

### IServiceCollection

`IServiceCollection`æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œæ¥è‡ªäº`Microsoft.Extensions.DependencyInjection`è¿™ä¸ªåŒ…ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„å®šä¹‰ï¼š

    using System.Collections;
    using System.Collections.Generic;
    
    namespace Microsoft.Extensions.DependencyInjection
    {
      public interface IServiceCollection : 
        IList<ServiceDescriptor>,
        ICollection<ServiceDescriptor>,
        IEnumerable<ServiceDescriptor>,
        IEnumerable
      {
      }
    }

å¯ä»¥çœ‹åˆ°å®ƒå·²ç»å…·å¤‡é›†åˆçš„å¢åˆ æ”¹æŸ¥åŸºæœ¬åŠŸèƒ½äº†ï¼Œå¹¶ä¸”å®ƒå’Œ`ServiceDescriptor`è¿›è¡Œäº†æŒ‚é’©ï¼Œæ˜¯ä¿å­˜`ServiceDescriptor`çš„æ•°æ®ç»“æ„æ¥å£ã€‚ä½†æ˜¯é‡Œé¢å¹¶æ²¡æœ‰`AddScoped`ã€`AddTransient`ã€`AddSingleton`è¿™å‡ ä¸ªæ–¹æ³•ï¼Œè¯´æ˜è¿™å‡ ä¸ªæ–¹æ³•æ˜¯å†™åœ¨å…¶å®ƒç±»ä¸­çš„æ‰©å±•æ–¹æ³•ã€‚IServiceCollectionä¹Ÿæ²¡æœ‰å®šä¹‰å…¶ä»»ä½•æˆå‘˜ï¼Œè€Œæ˜¯ä»IList<ServiceDescriptor>ã€ICollection<ServiceDescriptor>ã€IEnumerable<ServiceDescriptor>æ´¾ç”Ÿ

### ServiceCollection

æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹`ServiceCollection`çš„æºç ï¼Œ`ServiceCollection`å°±æ˜¯`ServiceDescriptor`çš„é›†åˆï¼Œå®ƒå…¨éƒ¨æ˜¯å¯¹`ServiceDescriptor`é›†åˆè¿›è¡Œæ“ä½œã€‚å¦‚ä¸‹ï¼š

    /// <summary>
    /// Default implementation of <see cref="IServiceCollection"/>.
    /// </summary>
    public class ServiceCollection : IServiceCollection
    {
        private readonly List<ServiceDescriptor> _descriptors = new List<ServiceDescriptor>();
        /// <inheritdoc />
        public int Count => _descriptors.Count;
        /// <inheritdoc />
        public bool IsReadOnly => false;
        /// <inheritdoc />
        public ServiceDescriptor this[int index]
        {
            get
            {
                return _descriptors[index];
            }
            set
            {
                _descriptors[index] = value;
            }
        }
        /// <inheritdoc />
        public void Clear()
        {
            _descriptors.Clear();
        }
        /// <inheritdoc />
        public bool Contains(ServiceDescriptor item)
        {
            return _descriptors.Contains(item);
        }
        /// <inheritdoc />
        public void CopyTo(ServiceDescriptor[] array, int arrayIndex)
        {
            _descriptors.CopyTo(array, arrayIndex);
        }
        /// <inheritdoc />
        public bool Remove(ServiceDescriptor item)
        {
            return _descriptors.Remove(item);
        }
        /// <inheritdoc />
        public IEnumerator<ServiceDescriptor> GetEnumerator()
        {
            return _descriptors.GetEnumerator();
        }
        void ICollection<ServiceDescriptor>.Add(ServiceDescriptor item)
        {
            _descriptors.Add(item);
        }
        IEnumerator IEnumerable.GetEnumerator()
        {
            return GetEnumerator();
        }
        /// <inheritdoc />
        public int IndexOf(ServiceDescriptor item)
        {
            return _descriptors.IndexOf(item);
        }
        /// <inheritdoc />
        public void Insert(int index, ServiceDescriptor item)
        {
            _descriptors.Insert(index, item);
        }
        /// <inheritdoc />
        public void RemoveAt(int index)
        {
            _descriptors.RemoveAt(index);
        }
    }

`ServiceCollection`æ˜¯ä¸€ä¸ª`ServiceDescriptor`é˜Ÿåˆ—å®ç°ç±»ï¼Œä¸»è¦ä½œç”¨æ˜¯ä¿å­˜`ServiceDescriptor`å¯¹è±¡ï¼Œå®ƒé»˜è®¤å®šä¹‰çš„`ServiceDescriptor`é›†åˆæ˜¯ç§æœ‰çš„ã€‚`ServiceCollection`æ‰¿è½½äº†ä¸€ä¸ª`List`çš„é›†åˆï¼Œç”±äºå®ç°äº†`IList`æ¥å£ï¼Œæ‰€ä»¥è¯¥ç±»å®ç°äº†æ¥å£çš„æ–¹æ³•ï¼Œå®ç°äº†å¯¹`List`é›†åˆçš„æ“ä½œã€‚æ€»ä¹‹`ServiceCollection`å°±æ˜¯ç”¨æ¥æ“ä½œ`ServiceDescriptor`å¯¹è±¡çš„ã€‚

### ServiceCollectionServiceExtensions

è¿™ä¸ªç±»é‡Œé¢éƒ½æ˜¯æˆ‘ä»¬å¹³æ—¶æœåŠ¡æ³¨å†Œç”¨åˆ°çš„å¸¸ç”¨æ–¹æ³•ï¼Œå³ï¼š`AddTransient`ã€`AddScoped`ã€`AddSingleton`ã€‚å®ƒä»¬å…¶å®æ–¹æ³•å®ç°éƒ½å·®ä¸å¤šï¼Œç”±äºç¯‡å¹…åŸå› æˆ‘åªè´´å‡ºéƒ¨åˆ†æºç ï¼š

    /// <summary>
    /// Adds a scoped service of the type specified in <paramref name="serviceType"/> with an
    /// implementation of the type specified in <paramref name="implementationType"/> to the
    /// specified <see cref="IServiceCollection"/>.
    /// </summary>
    /// <param name="services">The <see cref="IServiceCollection"/> to add the service to.</param>
    /// <param name="serviceType">The type of the service to register.</param>
    /// <param name="implementationType">The implementation type of the service.</param>
    /// <returns>A reference to this instance after the operation has completed.</returns>
    /// <seealso cref="ServiceLifetime.Scoped"/>
    public static IServiceCollection AddScoped(
        this IServiceCollection services,
        Type serviceType,
        Type implementationType)
    {
        if (services == null)
        {
            throw new ArgumentNullException(nameof(services));
        }
        if (serviceType == null)
        {
            throw new ArgumentNullException(nameof(serviceType));
        }
        if (implementationType == null)
        {
            throw new ArgumentNullException(nameof(implementationType));
        }
        return Add(services, serviceType, implementationType, ServiceLifetime.Scoped);
    }

    private static IServiceCollection Add(
        IServiceCollection collection,
        Type serviceType,
        Type implementationType,
        ServiceLifetime lifetime)
    {
        var descriptor = new ServiceDescriptor(serviceType, implementationType, lifetime);
        collection.Add(descriptor);
        return collection;
    }
    private static IServiceCollection Add(
        IServiceCollection collection,
        Type serviceType,
        Func<IServiceProvider, object> implementationFactory,
        ServiceLifetime lifetime)
    {
        var descriptor = new ServiceDescriptor(serviceType, implementationFactory, lifetime);
        collection.Add(descriptor);
        return collection;
    }

å¯ä»¥çœ‹åˆ°`AddScoped()`æ–¹æ³•æœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯`Add()`æ–¹æ³•ï¼Œä¸€å…±æœ‰ä¸¤ä¸ªé‡è½½ï¼Œæ¯ä¸ªæ³¨å…¥çš„å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯é€šè¿‡`ServiceLifetime`è¿™ä¸ªæšä¸¾æ¥åˆ¤æ–­çš„ã€‚ä½ çœ‹å®ƒä»£ç éƒ½éå¸¸ç®€å•ï¼Œå°±æ˜¯æ„å»º`ServiceDescriptor`å®ä¾‹ç„¶åæ·»åŠ åˆ°`IServiceCollection`å³`IList`ä¸­ã€‚ä¸‹å›¾è¿™ç§åªæ³¨å†Œå…·ä½“ç±»å‹æˆ–è€…å…·ä½“å®ä¾‹çš„æ–¹æ³•ï¼Œå…¶å®æ³¨å†Œå•ç±»å‹çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨çš„æ³¨å…¥å®ä¾‹åˆ°æŠ½è±¡çš„æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯å°†è‡ªå·±æ³¨å†Œç»™äº†è‡ªå·±ã€‚

![](https://img2023.cnblogs.com/blog/1677460/202304/1677460-20230412183924325-1795755719.png)

æ¥çœ‹ä¸€ä¸‹`ServiceLifetime`çš„æºç ï¼Œè¿™ä¸ªæšä¸¾æ˜¯ä¸ºäº†æˆ‘ä»¬æ³¨å†ŒæœåŠ¡å®ä¾‹çš„å£°æ˜å‘¨æœŸçš„ï¼Œéå¸¸æ¸…æ™°ä¸åœ¨è¿‡å¤šè®²è¿°ï¼š

    /// <summary>
    /// Specifies the lifetime of a service in an <see cref="IServiceCollection"/>.
    /// </summary>
    public enum ServiceLifetime
    {
        /// <summary>
        /// Specifies that a single instance of the service will be created.
        /// </summary>
        Singleton,
        /// <summary>
        /// Specifies that a new instance of the service will be created for each scope.
        /// </summary>
        /// <remarks>
        /// In ASP.NET Core applications a scope is created around each server request.
        /// </remarks>
        Scoped,
        /// <summary>
        /// Specifies that a new instance of the service will be created every time it is requested.
        /// </summary>
        Transient
    }

### IServiceProvider

`IServiceProvider`æ˜¯ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ¥å£ ï¼Œä½†æ˜¯å®ƒé‡Œé¢çš„ç»“æ„æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºä»å®¹å™¨ä¸­è·å–å®ä¾‹ï¼Œå…¶ä»–è·å–å®ä¾‹çš„æ–¹æ³•éƒ½æ˜¯æ ¹æ®è¿™ä¸ªæ–¹æ³•æ‰©å±•è€Œæ¥ï¼š

    /// <summary>Defines a mechanism for retrieving a service object; that is, an object that provides custom support to other objects.</summary>
    public interface IServiceProvider
    {
      /// <summary>Gets the service object of the specified type.</summary>
      /// <param name="serviceType">An object that specifies the type of service object to get.</param>
      /// <returns>A service object of type <paramref name="serviceType" />.
      /// 
      /// -or-
      /// 
      /// <see langword="null" /> if there is no service object of type <paramref name="serviceType" />.</returns>
      object? GetService(Type serviceType);
    }

`IServiceProvider`ä½œä¸ºæœåŠ¡æä¾›è€…ï¼Œæ˜¯æ ¹æ®`IServiceCollection`æ„å»ºå‡ºæ¥çš„ï¼š

    IServiceProvider serviceProvider = services.BuildServiceProvider();

`BuildServiceProvider`æ¥è‡ªäº`ServiceCollectionContainerBuilderExtensions`æ‰©å±•ç±»ä¸‹çš„æ‰©å±•æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š

    /// <summary>
    /// Extension methods for building a <see cref="ServiceProvider"/> from an <see cref="IServiceCollection"/>.
    /// </summary>
    public static class ServiceCollectionContainerBuilderExtensions
    {
        /// <summary>
        /// Creates a <see cref="ServiceProvider"/> containing services from the provided <see cref="IServiceCollection"/>.
        /// </summary>
        /// <param name="services">The <see cref="IServiceCollection"/> containing service descriptors.</param>
        /// <returns>The <see cref="ServiceProvider"/>.</returns>
        public static ServiceProvider BuildServiceProvider(this IServiceCollection services)
        {
            return BuildServiceProvider(services, ServiceProviderOptions.Default);
        }
        /// <summary>
        /// Creates a <see cref="ServiceProvider"/> containing services from the provided <see cref="IServiceCollection"/>
        /// optionally enabling scope validation.
        /// </summary>
        /// <param name="services">The <see cref="IServiceCollection"/> containing service descriptors.</param>
        /// <param name="validateScopes">
        /// <c>true</c> to perform check verifying that scoped services never gets resolved from root provider; otherwise <c>false</c>.
        /// </param>
        /// <returns>The <see cref="ServiceProvider"/>.</returns>
        public static ServiceProvider BuildServiceProvider(this IServiceCollection services, bool validateScopes)
        {
            return services.BuildServiceProvider(new ServiceProviderOptions { ValidateScopes = validateScopes });
        }
        /// <summary>
        /// Creates a <see cref="ServiceProvider"/> containing services from the provided <see cref="IServiceCollection"/>
        /// optionally enabling scope validation.
        /// </summary>
        /// <param name="services">The <see cref="IServiceCollection"/> containing service descriptors.</param>
        /// <param name="options">
        /// Configures various service provider behaviors.
        /// </param>
        /// <returns>The <see cref="ServiceProvider"/>.</returns>
        public static ServiceProvider BuildServiceProvider(this IServiceCollection services, ServiceProviderOptions options)
        {
            if (services == null)
            {
                throw new ArgumentNullException(nameof(services));
            }
            if (options == null)
            {
                throw new ArgumentNullException(nameof(options));
            }
            return new ServiceProvider(services, options);
        }
    }

å½“æˆ‘ä»¬æ„å»º`ServiceProvider`å®ä¾‹çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’å‚æ•°ï¼Œä»–ä¼šåˆ›å»ºä¸€ä¸ª`ServiceProviderOptions`çš„é»˜è®¤å®ä¾‹ï¼Œ`ServiceProviderOptions`è¿™ä¸ªç±»æ˜¯ DI å®¹å™¨çš„é…ç½®é€‰é¡¹ï¼Œä¸»è¦å¯ä»¥ç”¨æ¥é…ç½®`ServiceProvider`çš„è¡Œä¸ºï¼Œä½“ç°åœ¨å…¶å†…éƒ¨å‡ ä¸ªå±æ€§çš„å€¼ä¸Šé¢ã€‚

    public class ServiceProviderOptions
    {
        internal static readonly ServiceProviderOptions Default = new ServiceProviderOptions();
        /// <summary>
        /// æ˜¯å¦åœ¨æ¯ä¸ªä½œç”¨åŸŸä¸­éªŒè¯æœåŠ¡çš„ä¾èµ–å…³ç³»ã€‚é»˜è®¤å€¼ä¸º falseã€‚
        /// </summary>
        public bool ValidateScopes { get; set; }
        /// <summary>
        /// æ˜¯å¦åœ¨æ„å»º ServiceProvider æ—¶éªŒè¯æ‰€æœ‰æœåŠ¡çš„ä¾èµ–å…³ç³»ã€‚é»˜è®¤å€¼ä¸º trueã€‚
        /// </summary>
        public bool ValidateOnBuild { get; set; }
        /// <summary>
        /// æ§åˆ¶ ServiceProvider çš„è¡Œä¸º
        /// </summary>
        internal ServiceProviderMode Mode { get; set; }
    }
    
    internal enum ServiceProviderMode
    {
        Default,//è¿™æ˜¯é»˜è®¤çš„æœåŠ¡æä¾›ç¨‹åºæ¨¡å¼ï¼Œå®ƒä½¿ç”¨åŸºäºåå°„çš„åŠ¨æ€ä»£ç ç”Ÿæˆæ¥åˆ›å»ºæœåŠ¡å¯¹è±¡ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ç§æ¨¡å¼å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚
        Dynamic,//è¿™ç§æ¨¡å¼ä¹Ÿä½¿ç”¨åŸºäºåå°„çš„åŠ¨æ€ä»£ç ç”Ÿæˆæ¥åˆ›å»ºæœåŠ¡å¯¹è±¡ï¼Œä½†æ˜¯å®ƒä¼šå°è¯•åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ï¼Œä»¥æé«˜æ€§èƒ½ã€‚è¿™ç§æ¨¡å¼éœ€è¦åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œç¼–è¯‘ï¼Œå› æ­¤å¯èƒ½ä¼šå¢åŠ å¯åŠ¨æ—¶é—´ã€‚
        Runtime,//è¿™ç§æ¨¡å¼ä½¿ç”¨åŸºäºåå°„çš„åŠ¨æ€ä»£ç ç”Ÿæˆæ¥åˆ›å»ºæœåŠ¡å¯¹è±¡ï¼Œä½†æ˜¯å®ƒä¼šå°è¯•åœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç ã€‚è¿™ç§æ¨¡å¼å¯ä»¥æé«˜æ€§èƒ½ï¼Œä½†æ˜¯ä¼šå¢åŠ å†…å­˜ä½¿ç”¨é‡å’Œå¯åŠ¨æ—¶é—´ã€‚
        Expressions,//è¿™ç§æ¨¡å¼ä½¿ç”¨è¡¨è¾¾å¼æ ‘æ¥åˆ›å»ºæœåŠ¡å¯¹è±¡ã€‚å®ƒæ¯”åŸºäºåå°„çš„åŠ¨æ€ä»£ç ç”Ÿæˆæ›´å¿«ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¢åŠ å†…å­˜ä½¿ç”¨é‡ã€‚
        ILEmit,//è¿™ç§æ¨¡å¼ä½¿ç”¨åŸºäº IL çš„ä»£ç ç”Ÿæˆæ¥åˆ›å»ºæœåŠ¡å¯¹è±¡ã€‚å®ƒæ¯”åŸºäºåå°„çš„åŠ¨æ€ä»£ç ç”Ÿæˆæ›´å¿«ï¼Œä½†æ˜¯éœ€è¦æ›´å¤šçš„å†…å­˜å’Œå¯åŠ¨æ—¶é—´ã€‚
    }

`ValidateScopes`å±æ€§ç”¨äºæ§åˆ¶æœåŠ¡æä¾›ç¨‹åºæ˜¯å¦æ£€æŸ¥æœåŠ¡ä½œç”¨åŸŸçš„èŒƒå›´ï¼š

*   å¦‚æœå¼€å¯äº†èŒƒå›´æ£€æŸ¥ï¼Œç¨‹åºå°†ä¼šåœ¨åˆ›å»ºæœåŠ¡å¯¹è±¡æ—¶æ£€æŸ¥æœåŠ¡å¯¹è±¡çš„ä½œç”¨åŸŸæ˜¯å¦ä¸å…¶ä¾èµ–é¡¹çš„ä½œç”¨åŸŸåŒ¹é…ã€‚å¦‚æœä¸åŒ¹é…ï¼ŒæœåŠ¡æä¾›ç¨‹åºå°†ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œä»¥é¿å…å‡ºç°æ½œåœ¨çš„ bugã€‚å¼€å¯ä½œç”¨åŸŸèŒƒå›´æ£€æŸ¥å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­åŠæ—¶å‘ç°é—®é¢˜ï¼Œç¡®ä¿åº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚ç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨å¤šä¸ªä½œç”¨åŸŸçš„æƒ…å†µä¸‹ï¼Œå¼€å¯ä½œç”¨åŸŸèŒƒå›´æ£€æŸ¥å¯ä»¥é¿å…å‡ºç°ä¸€äº›æ„æƒ³ä¸åˆ°çš„é—®é¢˜ã€‚
    
*   å¦‚æœä¸å¼€å¯èŒƒå›´æ£€æŸ¥ï¼Œç¨‹åºå°†ä¸ä¼šè¿›è¡Œä½œç”¨åŸŸèŒƒå›´æ£€æŸ¥ã€‚è¿™æ ·å¯ä»¥æé«˜æœåŠ¡å¯¹è±¡çš„åˆ›å»ºé€Ÿåº¦ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ½œåœ¨çš„ bugï¼Œå› ä¸ºæœåŠ¡å¯¹è±¡çš„ä½œç”¨åŸŸä¸å…¶ä¾èµ–é¡¹çš„ä½œç”¨åŸŸä¸åŒ¹é…ã€‚
    

`ValidateOnBuild`å±æ€§ç”¨äºæŒ‡å®š DI å®¹å™¨åœ¨åˆ›å»ºæœåŠ¡å®ä¾‹æ—¶æ˜¯å¦è¿›è¡Œä½œç”¨åŸŸèŒƒå›´æ£€æŸ¥ï¼Œä¸»è¦ä¼šæ£€æŸ¥æœåŠ¡å®ä¾‹çš„ä¾èµ–å…³ç³»æ˜¯å¦åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸèŒƒå›´å†…ï¼Œä»¥ç¡®ä¿æœåŠ¡å®ä¾‹çš„ä¾èµ–å…³ç³»æ­£ç¡®ï¼š

*   å¦‚æœå¼€å¯äº†ä¾èµ–å…³ç³»æ£€æŸ¥ï¼Œå®¹å™¨ä¼šåœ¨åˆ›å»ºæœåŠ¡å®ä¾‹æ—¶è¿›è¡Œä½œç”¨åŸŸèŒƒå›´æ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
    
*   å¦‚æœä¸å¼€å¯ä¾èµ–å…³ç³»æ£€æŸ¥ï¼Œå®¹å™¨ä¸ä¼šè¿›è¡Œä½œç”¨åŸŸèŒƒå›´æ£€æŸ¥ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å®ä¾‹çš„ä¾èµ–å…³ç³»é”™è¯¯ï¼Œä»è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°é—®é¢˜ã€‚
    

å› æ­¤ï¼Œå»ºè®®åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¼€å¯ValidateScopes ä¸ValidateOnBuild å±æ€§ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ä»¥è€ƒè™‘å…³é—­è¿™ä¸¤ä¸ªå±æ€§ä»¥æé«˜æ€§èƒ½ã€‚

### ServiceProvider

`ServiceProvider`æ˜¯.NET Core ä¸­ä¾èµ–æ³¨å…¥å®¹å™¨çš„æ ¸å¿ƒå®ç°ï¼Œå®ƒæä¾›äº†æ³¨å†ŒæœåŠ¡ã€è·å–æœåŠ¡ã€åˆ›å»ºä½œç”¨åŸŸç­‰åŸºæœ¬åŠŸèƒ½ï¼Œå¹¶æ”¯æŒé…ç½®é€‰é¡¹å’Œæ¨¡å¼ï¼Œå®ƒä¹Ÿæ˜¯`IServiceProvider`çš„é»˜è®¤å®ç°ç±»ï¼Œè¿™é‡Œçš„è¯æˆ‘åªè´´å‡ºæä¾›æœåŠ¡ç›¸å…³çš„ä»£ç ï¼š

    /// <summary>
    /// The default IServiceProvider.
    /// </summary>
    public sealed class ServiceProvider : IServiceProvider, IDisposable, IServiceProviderEngineCallback, IAsyncDisposable
    {
        private readonly IServiceProviderEngine _engine;
        private readonly CallSiteValidator _callSiteValidator;
        internal ServiceProvider(IEnumerable<ServiceDescriptor> serviceDescriptors, ServiceProviderOptions options)
        {
            IServiceProviderEngineCallback callback = null;
            if (options.ValidateScopes)
            {
                callback = this;
                _callSiteValidator = new CallSiteValidator();
            }        //é€šè¿‡ServiceProviderOptionsä¸­çš„æšä¸¾å€¼åˆ¤æ–­ç”¨å“ªç§æ–¹å¼å®ä¾‹åŒ–å¯¹è±¡
            switch (options.Mode)
            {
                case ServiceProviderMode.Default:
    !NETCOREAPP
                    _engine = new DynamicServiceProviderEngine(serviceDescriptors, callback);
    e
                    if (RuntimeFeature.IsSupported("IsDynamicCodeCompiled"))
                    {
                        _engine = new DynamicServiceProviderEngine(serviceDescriptors, callback);
                    }
                    else
                    {
                        // Don't try to compile Expressions/IL if they are going to get interpreted
                        _engine = new RuntimeServiceProviderEngine(serviceDescriptors, callback);
                    }
    if
                    break;
                case ServiceProviderMode.Dynamic:
                    _engine = new DynamicServiceProviderEngine(serviceDescriptors, callback);
                    break;
                case ServiceProviderMode.Runtime:
                    _engine = new RuntimeServiceProviderEngine(serviceDescriptors, callback);
                    break;
    IL_EMIT
                case ServiceProviderMode.ILEmit:
                    _engine = new ILEmitServiceProviderEngine(serviceDescriptors, callback);
                    break;
    if
                case ServiceProviderMode.Expressions:
                    _engine = new ExpressionsServiceProviderEngine(serviceDescriptors, callback);
                    break;
                default:
                    throw new NotSupportedException(nameof(options.Mode));
            }        //å½“å‰åˆ›å»ºæœåŠ¡å®ä¾‹æ—¶æ˜¯å¦è¿›è¡Œä½œç”¨åŸŸèŒƒå›´æ£€æŸ¥
            if (options.ValidateOnBuild)
            {
                List<Exception> exceptions = null;
                foreach (var serviceDescriptor in serviceDescriptors)
                {
                    try
                    {
                        _engine.ValidateService(serviceDescriptor);
                    }
                    catch (Exception e)
                    {
                        exceptions = exceptions ?? new List<Exception>();
                        exceptions.Add(e);
                    }
                }
                if (exceptions != null)
                {
                    throw new AggregateException("Some services are not able to be constructed", exceptions.ToArray());
                }
            }
        }
        /// <summary>
        /// é€šè¿‡IServiceProviderEngineè·å–å®ä¾‹
        /// </summary>
        public object GetService(Type serviceType) => _engine.GetService(serviceType);
    }

`IServiceProviderEngine`æ¥å£æ˜¯ç”¨äºåˆ›å»ºå’Œç®¡ç†ä¾èµ–é¡¹æ³¨å…¥å®¹å™¨çš„å¼•æ“ï¼Œè¿™ä¸ªæ¥å£æ˜¯ä¸ºäº†æé«˜ä¾èµ–é¡¹æ³¨å…¥å®¹å™¨çš„æ€§èƒ½è€Œè®¾è®¡çš„ã€‚

`IServiceProviderEngine`æ¥å£å®šä¹‰äº†ä¸€ä¸ª`CreateServiceProvider`Â æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨Â `IServiceProviderEngine`Â å®ç°åˆ›å»ºä¸€ä¸ªæ–°çš„Â `IServiceProvider`Â å®ä¾‹ã€‚

å…·ä½“æ¥è¯´ï¼Œ`IServiceProviderEngine`æ¥å£çš„ä½œç”¨æ˜¯ï¼š

*   æä¾›äº†ä¸€ä¸ªå¯æ‰©å±•çš„æ¥å£ï¼Œå…è®¸å¼€å‘äººå‘˜å®ç°è‡ªå®šä¹‰çš„ä¾èµ–æ³¨å…¥å®¹å™¨ã€‚
*   é€šè¿‡ä½¿ç”¨ç¼–è¯‘æ—¶ç”Ÿæˆçš„ä»£ç ï¼Œæé«˜äº†ä¾èµ–æ³¨å…¥å®¹å™¨çš„æ€§èƒ½ã€‚
    
*   æä¾›äº†ä¸€ç§æ›´çµæ´»çš„æ–¹å¼æ¥ç®¡ç†ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œä»¥æ”¯æŒæ›´é«˜çº§çš„åœºæ™¯ï¼Œä¾‹å¦‚æ¨¡å—åŒ–åº”ç”¨ç¨‹åºå’Œæ’ä»¶å¼æ¶æ„ã€‚
    

æˆ‘ä»¬ä¸Šé¢è¯´åˆ°ä»å®¹å™¨ä¸­è·å–å®ä¾‹ä½¿ç”¨`IServiceProvider`ä¸­çš„`GetService()`æ–¹æ³•ï¼Œä½†æ˜¯è¿œä¸æ­¢è¿™ä¸€ç§ï¼Œè¿˜æœ‰æˆ‘ä»¬çš„å­ä½œç”¨åŸŸçš„åˆ›å»ºæ˜¯åœ¨å“ªä¸ªç±»ä¸­å®ç°çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`ServiceProvider`çš„å¦ä¸€ä¸ªæ‰©å±•ç±»`ServiceProviderServiceExtensions`ï¼Œæºç å¦‚ä¸‹ï¼š

    /// <summary>
    /// Extension methods for getting services from an <see cref="IServiceProvider" />.
    /// </summary>
    public static class ServiceProviderServiceExtensions
    {
        /// <summary>
        /// Get service of type <typeparamref name="T"/> from the <see cref="IServiceProvider"/>.
        /// </summary>
        /// <typeparam name="T">The type of service object to get.</typeparam>
        /// <param name="provider">The <see cref="IServiceProvider"/> to retrieve the service object from.</param>
        /// <returns>A service object of type <typeparamref name="T"/> or null if there is no such service.</returns>
        public static T GetService<T>(this IServiceProvider provider)
        {
            if (provider == null)
            {
                throw new ArgumentNullException(nameof(provider));
            }
            return (T)provider.GetService(typeof(T));
        }
        /// <summary>
        /// Get service of type <paramref name="serviceType"/> from the <see cref="IServiceProvider"/>.
        /// </summary>
        /// <param name="provider">The <see cref="IServiceProvider"/> to retrieve the service object from.</param>
        /// <param name="serviceType">An object that specifies the type of service object to get.</param>
        /// <returns>A service object of type <paramref name="serviceType"/>.</returns>
        /// <exception cref="System.InvalidOperationException">There is no service of type <paramref name="serviceType"/>.</exception>
        public static object GetRequiredService(this IServiceProvider provider, Type serviceType)
        {
            if (provider == null)
            {
                throw new ArgumentNullException(nameof(provider));
            }
            if (serviceType == null)
            {
                throw new ArgumentNullException(nameof(serviceType));
            }
            var requiredServiceSupportingProvider = provider as ISupportRequiredService;
            if (requiredServiceSupportingProvider != null)
            {
                return requiredServiceSupportingProvider.GetRequiredService(serviceType);
            }
            var service = provider.GetService(serviceType);
            if (service == null)
            {
                throw new InvalidOperationException(Resources.FormatNoServiceRegistered(serviceType));
            }
            return service;
        }
        /// <summary>
        /// Get service of type <typeparamref name="T"/> from the <see cref="IServiceProvider"/>.
        /// </summary>
        /// <typeparam name="T">The type of service object to get.</typeparam>
        /// <param name="provider">The <see cref="IServiceProvider"/> to retrieve the service object from.</param>
        /// <returns>A service object of type <typeparamref name="T"/>.</returns>
        /// <exception cref="System.InvalidOperationException">There is no service of type <typeparamref name="T"/>.</exception>
        public static T GetRequiredService<T>(this IServiceProvider provider)
        {
            if (provider == null)
            {
                throw new ArgumentNullException(nameof(provider));
            }
            return (T)provider.GetRequiredService(typeof(T));
        }
        /// <summary>
        /// Get an enumeration of services of type <typeparamref name="T"/> from the <see cref="IServiceProvider"/>.
        /// </summary>
        /// <typeparam name="T">The type of service object to get.</typeparam>
        /// <param name="provider">The <see cref="IServiceProvider"/> to retrieve the services from.</param>
        /// <returns>An enumeration of services of type <typeparamref name="T"/>.</returns>
        public static IEnumerable<T> GetServices<T>(this IServiceProvider provider)
        {
            if (provider == null)
            {
                throw new ArgumentNullException(nameof(provider));
            }
            return provider.GetRequiredService<IEnumerable<T>>();
        }
        /// <summary>
        /// Get an enumeration of services of type <paramref name="serviceType"/> from the <see cref="IServiceProvider"/>.
        /// </summary>
        /// <param name="provider">The <see cref="IServiceProvider"/> to retrieve the services from.</param>
        /// <param name="serviceType">An object that specifies the type of service object to get.</param>
        /// <returns>An enumeration of services of type <paramref name="serviceType"/>.</returns>
        public static IEnumerable<object> GetServices(this IServiceProvider provider, Type serviceType)
        {
            if (provider == null)
            {
                throw new ArgumentNullException(nameof(provider));
            }
            if (serviceType == null)
            {
                throw new ArgumentNullException(nameof(serviceType));
            }
            var genericEnumerable = typeof(IEnumerable<>).MakeGenericType(serviceType);
            return (IEnumerable<object>)provider.GetRequiredService(genericEnumerable);
        }
        /// <summary>
        /// Creates a new <see cref="IServiceScope"/> that can be used to resolve scoped services.
        /// </summary>
        /// <param name="provider">The <see cref="IServiceProvider"/> to create the scope from.</param>
        /// <returns>A <see cref="IServiceScope"/> that can be used to resolve scoped services.</returns>
        public static IServiceScope CreateScope(this IServiceProvider provider)
        {
            return provider.GetRequiredService<IServiceScopeFactory>().CreateScope();
        }
    }

åˆ›å»ºå­ä½œç”¨åŸŸï¼š

    using (IServiceScope scope = serviceProvider.CreateScope())
    {
        IServiceProvider scopeProvider = scope.ServiceProvider;
    }

*   `GetService(Type serviceType)`ï¼šä» DI å®¹å™¨ä¸­è·å–æŒ‡å®šç±»å‹çš„æœåŠ¡å®ä¾‹ã€‚å¦‚æœ DI å®¹å™¨ä¸­ä¸å­˜åœ¨è¯¥ç±»å‹çš„æœåŠ¡ï¼Œåˆ™è¿”å› nullã€‚
*   `GetRequiredService(Type serviceType)`ï¼šä» DI å®¹å™¨ä¸­è·å–æŒ‡å®šç±»å‹çš„æœåŠ¡å®ä¾‹ã€‚å¦‚æœ DI å®¹å™¨ä¸­ä¸å­˜åœ¨è¯¥ç±»å‹çš„æœåŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
*   `GetServices(Type serviceType)`ï¼šä» DI å®¹å™¨ä¸­è·å–æŒ‡å®šç±»å‹çš„æ‰€æœ‰æœåŠ¡å®ä¾‹ã€‚å¦‚æœ DI å®¹å™¨ä¸­ä¸å­˜åœ¨è¯¥ç±»å‹çš„æœåŠ¡ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„`IEnumerable`ã€‚
*   `CreateScope()`ï¼šç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼ˆScopeï¼‰ã€‚ä½œç”¨åŸŸæ˜¯ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒå¯ä»¥ç”¨äºéš”ç¦»ä¸åŒéƒ¨åˆ†ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ§åˆ¶ä¾èµ–é¡¹çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨ä¸€ä¸ªä½œç”¨åŸŸä¸­ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„`IServiceProvider`Â å®ä¾‹ï¼Œè¯¥å®ä¾‹åªèƒ½è®¿é—®å½“å‰ä½œç”¨åŸŸåŠå…¶çˆ¶ä½œç”¨åŸŸä¸­æ³¨å†Œçš„æœåŠ¡ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨ä¸åŒçš„ä½œç”¨åŸŸä¸­ä½¿ç”¨ä¸åŒçš„æœåŠ¡å®ä¾‹ï¼Œä»è€Œå®ç°ä¾èµ–å…³ç³»çš„éš”ç¦»ã€‚è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª`IServiceScope`Â å®ä¾‹ï¼Œè¯¥å®ä¾‹åŒ…å«äº†ä¸€ä¸ªæ–°çš„`IServiceProvider`Â å®ä¾‹å’Œä¸€ä¸ªä½œç”¨åŸŸå¯¹è±¡ã€‚å¯ä»¥é€šè¿‡è°ƒç”¨`IServiceScope`Â å®ä¾‹çš„`ServiceProvider`Â å±æ€§æ¥è·å–æ–°çš„Â `IServiceProvider`Â å®ä¾‹ï¼Œç„¶åä½¿ç”¨è¯¥å®ä¾‹æ¥è§£æå½“å‰ä½œç”¨åŸŸåŠå…¶çˆ¶ä½œç”¨åŸŸä¸­æ³¨å†Œçš„æœåŠ¡ã€‚

### IServiceProviderFactory

åœ¨.Net Coreä¸­æä¾›äº†`IServiceProviderFactory`æ¥å£æ¥æ›¿æ¢é»˜è®¤çš„å®¹å™¨ï¼Œé€šè¿‡å®ç°Â `IServiceProviderFactory`æ¥å£ï¼Œå¯ä»¥åˆ›å»ºè‡ªå·±çš„å®¹å™¨å¹¶å°†å…¶ä¸ ASP.NET Core çš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿé›†æˆå®ç°è‡ªå®šä¹‰çš„ä¾èµ–æ³¨å…¥å®¹å™¨ã€‚è¿™ä¸ªæ¥å£å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•`CreateServiceProvider`ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ³›å‹å‚æ•°`TContainer`ï¼Œå¹¶è¿”å›ä¸€ä¸ªå®ç°äº†`IServiceProvider`æ¥å£çš„å¯¹è±¡ã€‚æºç å¦‚ä¸‹ï¼š

    /// <summary>
    /// Provides an extension point for creating a container specific builder and an <see cref="IServiceProvider"/>.
    /// </summary>
    public interface IServiceProviderFactory<TContainerBuilder>
    {
        /// <summary>
        /// Creates a container builder from an <see cref="IServiceCollection"/>.
        /// </summary>
        /// <param name="services">The collection of services</param>
        /// <returns>A container builder that can be used to create an <see cref="IServiceProvider"/>.</returns>
        TContainerBuilder CreateBuilder(IServiceCollection services);
        /// <summary>
        /// Creates an <see cref="IServiceProvider"/> from the container builder.
        /// </summary>
        /// <param name="containerBuilder">The container builder</param>
        /// <returns>An <see cref="IServiceProvider"/></returns>
        IServiceProvider CreateServiceProvider(TContainerBuilder containerBuilder);
    }

`IServiceProviderFactory`æ¥å£çš„é»˜è®¤å®ç°æ˜¯`DefaultServiceProviderFactory`ç±»ï¼Œæºç å¦‚ä¸‹ï¼š

    /// <summary>
    /// Default implementation of <see cref="IServiceProviderFactory{TContainerBuilder}"/>.
    /// </summary>
    public class DefaultServiceProviderFactory : IServiceProviderFactory<IServiceCollection>
    {
        private readonly ServiceProviderOptions _options;
        /// <summary>
        /// Initializes a new instance of the <see cref="DefaultServiceProviderFactory"/> class
        /// with default options.
        /// </summary>
        /// <seealso cref="ServiceProviderOptions.Default"/>
        public DefaultServiceProviderFactory() : this(ServiceProviderOptions.Default)
        {
        }
        /// <summary>
        /// Initializes a new instance of the <see cref="DefaultServiceProviderFactory"/> class
        /// with the specified <paramref name="options"/>.
        /// </summary>
        /// <param name="options">The options to use for this instance.</param>
        public DefaultServiceProviderFactory(ServiceProviderOptions options)
        {
            if (options == null)
            {
                throw new ArgumentNullException(nameof(options));
            }
            _options = options;
        }
        /// <inheritdoc />
        public IServiceCollection CreateBuilder(IServiceCollection services)
        {
            return services;
        }
        /// <inheritdoc />
        public IServiceProvider CreateServiceProvider(IServiceCollection containerBuilder)
        {
            return containerBuilder.BuildServiceProvider(_options);
        }
    }

å¯ä»¥çœ‹åˆ°æ ¹æœ¬ä¹ˆæœ‰ä»€ä¹ˆé€»è¾‘ï¼Œå°±æ˜¯æŠŠ`IServiceCollection`å’Œ`IServiceProvider`å‘å¤–æä¾›ï¼Œæ–¹ä¾¿å¼€å‘è€…èƒ½å¤Ÿæ›¿æ¢é»˜è®¤çš„å®¹å™¨å®ç°è‡ªå®šä¹‰çš„å®¹å™¨ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Autofacä¸­çš„æºç ï¼Œ`AutofacServiceProviderFactory`Â è¿™ä¸ªç±»å°±æ˜¯Autofac å¯¹`IServiceProviderFactory`Â çš„ä¸€ä¸ªå®ç°ã€‚æºç å¦‚ä¸‹ï¼š

    /// <summary>
    /// A factory for creating a <see cref="ContainerBuilder"/> and an <see cref="IServiceProvider" />.
    /// </summary>
    public class AutofacServiceProviderFactory : IServiceProviderFactory<ContainerBuilder>
    {
        private readonly Action<ContainerBuilder> _configurationAction;
        private readonly ContainerBuildOptions _containerBuildOptions = ContainerBuildOptions.None;
    
        /// <summary>
        /// Initializes a new instance of the <see cref="AutofacServiceProviderFactory"/> class.
        /// </summary>
        /// <param name="containerBuildOptions">The container options to use when building the container.</param>
        /// <param name="configurationAction">Action on a <see cref="ContainerBuilder"/> that adds component registrations to the container.</param>
        public AutofacServiceProviderFactory(
            ContainerBuildOptions containerBuildOptions,
            Action<ContainerBuilder> configurationAction = null)
            : this(configurationAction) =>
            _containerBuildOptions = containerBuildOptions;
    
        /// <summary>
        /// Initializes a new instance of the <see cref="AutofacServiceProviderFactory"/> class.
        /// </summary>
        /// <param name="configurationAction">Action on a <see cref="ContainerBuilder"/> that adds component registrations to the container..</param>
        public AutofacServiceProviderFactory(Action<ContainerBuilder> configurationAction = null) =>
            _configurationAction = configurationAction ?? (builder => { });
    
        /// <summary>
        /// Creates a container builder from an <see cref="IServiceCollection" />.
        /// </summary>
        /// <param name="services">The collection of services.</param>
        /// <returns>A container builder that can be used to create an <see cref="IServiceProvider" />.</returns>
        public ContainerBuilder CreateBuilder(IServiceCollection services)
        {
            var builder = new ContainerBuilder();
    
            builder.Populate(services);
    
            _configurationAction(builder);
    
            return builder;
        }
    
        /// <summary>
        /// Creates an <see cref="IServiceProvider" /> from the container builder.
        /// </summary>
        /// <param name="containerBuilder">The container builder.</param>
        /// <returns>An <see cref="IServiceProvider" />.</returns>
        public IServiceProvider CreateServiceProvider(ContainerBuilder containerBuilder)
        {
            if (containerBuilder == null)
            {
                throw new ArgumentNullException(nameof(containerBuilder));
            }
    
            var container = containerBuilder.Build(_containerBuildOptions);
    
            return new AutofacServiceProvider(container);
        }
    }

`CreateBuilder`æ–¹æ³•æ¥æ”¶ä¸€ä¸ª`IServiceCollection`ç±»å‹çš„å‚æ•°`services`ï¼Œç”¨äºå°†æœåŠ¡æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ª`ContainerBuilder`å®ä¾‹ï¼Œç„¶åè°ƒç”¨å…¶ `Populate`æ–¹æ³•å°†`services`ä¸­çš„æœåŠ¡æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚æœ€åï¼Œå¦‚æœå­˜åœ¨è‡ªå®šä¹‰é…ç½®ï¼Œå°±è°ƒç”¨`configurationAction`å¯¹å®¹å™¨è¿›è¡Œé…ç½®ã€‚

`CreateServiceProvider`æ–¹æ³•æ¥æ”¶ä¸€ä¸ª`ContainerBuilder`ç±»å‹çš„å‚æ•°`containerBuilder`ï¼Œç”¨äºåˆ›å»º`IServiceProvider`å®ä¾‹ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè°ƒç”¨`containerBuilder`çš„`Build`æ–¹æ³•åˆ›å»ºå®¹å™¨å®ä¾‹ï¼Œç„¶åå°†å®¹å™¨å®ä¾‹ä¼ å…¥`AutofacServiceProvider`çš„æ„é€ å‡½æ•°ä¸­åˆ›å»º`IServiceProvider`å®ä¾‹ã€‚

### UseServiceProviderFactory

    public IHostBuilder UseServiceProviderFactory<TContainerBuilder>(IServiceProviderFactory<TContainerBuilder> factory) where TContainerBuilder : notnull
     {
         if (factory is null)
         {
             throw new ArgumentNullException(nameof(factory));
         }
         _operations.Add(b => b.UseServiceProviderFactory(factory));
         return this;
     }

`UseServiceProviderFactory`æ˜¯ä¸€ä¸ªæ‰©å±•æ–¹æ³•ï¼Œç”¨æ¥æ³¨å†Œè‡ªå®šä¹‰å®¹å™¨å·¥å‚ï¼Œå¯ä»¥ç”¨`builder.Host.UseServiceProviderFactory(new XXXFactory())`æ¥è¿›è¡Œé…ç½®ï¼Œä»è€Œå®ç°æ›´åŠ çµæ´»çš„ä¾èµ–æ³¨å…¥ã€‚

å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°`IServiceProviderFactory`æ¥å£æ¥åˆ›å»ºè‡ªå®šä¹‰çš„æœåŠ¡æä¾›ç¨‹åºå·¥å‚ï¼Œå…¶ä¸­`TContainer`æ˜¯æœåŠ¡æä¾›ç¨‹åºå®¹å™¨çš„ç±»å‹ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`UseServiceProviderFactory`æ–¹æ³•ä¸­ä½¿ç”¨è¿™ä¸ªå·¥å‚æ¥åˆ›å»ºæœåŠ¡æä¾›ç¨‹åºã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿ç”¨ `Autofac` ä½œä¸ºæœåŠ¡æä¾›ç¨‹åºå®¹å™¨ï¼Œå°±å¯ä»¥å®ç°`IServiceProviderFactory`æ¥å£æ¥åˆ›å»º`Autofac`å®¹å™¨ï¼Œç„¶ååœ¨`WebHostBuilder`æˆ–`HostBuilder`ä¸­ä½¿ç”¨`UseServiceProviderFactory`æ–¹æ³•æ¥æŒ‡å®šä½¿ç”¨è¿™ä¸ªå·¥å‚ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ `Autofac`æ¥ç®¡ç†ä¾èµ–å…³ç³»ã€‚

æ‰©å±•
--

ä¸èƒ½åœ¨é¡¹ç›®ä¸­ä½¿ç”¨`AddScoped`ã€`AddSingleton`ã€`AddTransient`æ¥æ³¨å†Œå¯¹è±¡è‡³å®¹å™¨ä¸­ï¼Œä¸æ˜¯ä¸æ¨èï¼Œæ˜¯ä¸èƒ½ğŸ¤¨ã€‚åé¢é¡¹ç›®ä¸€æ—¦è†¨èƒ€èµ·æ¥ç»´æŠ¤å˜å¾—å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†é¡¹ç›®ä¸­çš„dllè¿›è¡Œåˆ¤æ–­ç„¶åå°†å…¶ä¸­çš„ç±»æ ¹æ®æˆ‘ä»¬è‡ªå®šä¹‰çš„è§„åˆ™åˆ¤æ–­è‡ªåŠ¨è¿›è¡Œæ³¨å†Œã€‚è¿™é‡Œçš„è¯æˆ‘ä»¬è¿˜æ˜¯ç”¨.Net Coreè‡ªå¸¦çš„IOCè¿›è¡Œæ‰©å±•æ‰¹é‡æ³¨å…¥ã€‚

### æ‰¹é‡æ³¨å…¥-ä½¿ç”¨æ¥å£çš„æ–¹å¼

æˆ‘ä»¬å®šä¹‰ä¸‰ç§ç±»å‹çš„æ¥å£ï¼Œè®©å…¶åˆ†åˆ«ä»£è¡¨å•ä¾‹ã€ä½œç”¨åŸŸä¸ç¬æ—¶ï¼Œç„¶åæ‰«æé¡¹ç›®ä¸­çš„dllä¸­çš„ç±»å‹ï¼Œåˆ¤æ–­æ˜¯å¦ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿è¿™ä¸‰ç§æ¥å£ï¼Œå¦‚æœæ˜¯åˆ™æ‰¾åˆ°å®ä¾‹ç„¶åè¿›è¡Œæ³¨å†ŒğŸ‰

å…ˆå®šä¹‰ä¸‰ç§ç±»å‹çš„æ¥å£ï¼š

    /// <summary>
    /// å®ç°è¯¥æ¥å£çš„å¯¹è±¡ä¸ºä½œç”¨åŸŸç”Ÿå‘½å‘¨æœŸ
    /// </summary>
    public interface IScopeDependency
    {
    }
    /// <summary>
    /// å®ç°è¯¥æ¥å£çš„å¯¹è±¡ä¸ºå•ä¾‹ç”Ÿå‘½å‘¨æœŸ
    /// </summary>
    public interface ISingletonDependency
    {
    }
    /// <summary>
    /// å®ç°è¯¥æ¥å£çš„å¯¹è±¡ä¸ºç¬æ—¶ç”Ÿå‘½å‘¨æœŸ
    /// </summary>
    public interface ITransientDependency
    {
    }

ä¸»è¦çš„å®ç°æ–¹æ³•ï¼Œå°±æ˜¯ç­›é€‰æˆ‘ä»¬éœ€è¦çš„Typeè¿›è¡Œæ³¨å†Œï¼š

    public static List<Type> BaseTypes { get; set; } = new();
    public static IServiceCollection AddDataService(this IServiceCollection services, IConfiguration configuration)
    {
        List<string> BaseTypeStrArr = (List<string>)configuration.GetSection("BaseTypes").Get(typeof(List<string>));
        BaseTypeStrArr.ForEach(item => { BaseTypes.Add(Type.GetType(item)); });
        var path = AppDomain.CurrentDomain.RelativeSearchPath ?? AppDomain.CurrentDomain.BaseDirectory;
        var getFiles = Directory.GetFiles(path, "*.dll").Where(x => Match(x, configuration));
        var referencedAssemblies = getFiles.Select(Assembly.LoadFrom).ToList();
        var types = referencedAssemblies
                    .SelectMany(m => m.DefinedTypes)
                    .Select(type => type.AsType())
                    .Where(IsMatchType).ToList();
        var implementTypes = types.Where(x => x.IsClass).ToList();
        var interfaceTypes = types.Where(x => x.IsInterface).ToList();
        //å¾ªç¯å®ä¾‹
        foreach (var implementType in implementTypes)
        {
            var type = GetMatchType(implementType);
            if (type != null)
            {
                var interfaceType = interfaceTypes.FirstOrDefault(x => x.IsAssignableFrom(implementType));
                if (interfaceType != null)
                {
                    switch (type.Name)
                    {
                        case "IScopeDependency":
                            services.AddScoped(interfaceType, implementType);
                            break;
                        case "ISingletonDependency":
                            services.AddSingleton(interfaceType, implementType);
                            break;
                        case "ITransientDependency":
                            services.AddTransient(interfaceType, implementType);
                            break;
                        default:
                            break;
                    }
                }
            }
        }
        return services;
    }
    
    /// <summary>
    /// åˆ¤æ–­ç±»å‹æ˜¯å¦åŒ¹é…
    /// </summary>
    /// <param name="type"></param>
    /// <returns></returns>
    public static bool IsMatchType(Type type)
    {
        return BaseTypes.Where(m => m != type && m.IsAssignableFrom(type)).Any();
    }
    
    /// <summary>
    /// è·å–BaseType
    /// </summary>
    /// <param name="type"></param>
    /// <returns></returns>
    public static Type GetMatchType(Type type)
    {
        return BaseTypes.Where(m => m.IsAssignableFrom(type)).FirstOrDefault();
    }
    
    /// <summary>
    /// ç¨‹åºé›†æ˜¯å¦åŒ¹é…
    /// </summary>
    public static bool Match(string assemblyName, IConfiguration configuration)
    {
        assemblyName = Path.GetFileName(assemblyName);
        //if (assemblyName.StartsWith($"{AppDomain.CurrentDomain.FriendlyName}.XXX"))
        //    return false;
        return Regex.IsMatch(assemblyName, configuration["MatchAssemblies"], RegexOptions.IgnoreCase | RegexOptions.Compiled);
    }

### æ‰¹é‡æ³¨å…¥-ä½¿ç”¨æ³¨è§£çš„æ–¹å¼

æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªç‰¹æ€§ï¼Œå¯ä¼ å…¥ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸçš„æšä¸¾å‚æ•°ï¼Œç„¶ååœ¨éœ€è¦çš„ç±»ä¸Šé¢æ ‡æ³¨ï¼Œå¦‚æœè¿™ä¸ªç±»æœ‰æ¥å£åˆ™å°†è‡ªå·±å’Œå¯¹åº”çš„æ¥å£è¿›è¡Œæ³¨å†Œï¼Œå¦‚æœæ²¡æœ‰æ¥å£åˆ™åªæ³¨å…¥è‡ªå·±ğŸ

å®šä¹‰ç‰¹æ€§ç±»ï¼Œç”¨äºå£°æ˜å½“å‰æ ‡æ³¨çš„ç±»çš„ç”Ÿå‘½å‘¨æœŸ

    [AttributeUsage(AttributeTargets.Class, AllowMultiple = false)]
    public class CoreInjectAttribute : Attribute
    {
        public CoreInjectAttribute(ServiceLifetime injectType)
        {
            InjectType = injectType;
        }
    
        /// <summary>
        /// ç”Ÿå‘½å‘¨æœŸ
        /// </summary>
        public ServiceLifetime InjectType { get; set; }
    }

ä¸»è¦çš„å®ç°æ–¹æ³•ï¼Œä»£ç éƒ½æ¯”è¾ƒç®€å•ï¼Œæˆ‘å°±ä¸å†è¯´äº†

    public static IServiceCollection AddDataService(this IServiceCollection service)
    {
        var basePath = ApplicationEnvironment.ApplicationBasePath;
        var path = AppDomain.CurrentDomain.BaseDirectory;
        var assemblies = Directory.GetFiles(path, "ICore.*.dll").Select(Assembly.LoadFrom).ToList();
        foreach (var assembly in assemblies)
        {
            var types = assembly.GetTypes().Where(a => a.GetCustomAttribute<CoreInjectAttribute>() != null)
                .ToList();
            if (types.Count <= 0) continue;
            foreach (var type in types)
            {
                var injectData = (CoreInjectAttribute)type.GetCustomAttribute<CoreInjectAttribute>();
                Type[] interfaces = type.GetInterfaces();
                if (!interfaces.Any())
                {
                    service.RegisterType(type, type, injectData.InjectType);
                    continue;
                }
                foreach (Type interfaceType in interfaces)
                {
                    service.RegisterType(interfaceType, type, injectData.InjectType);
                }
            }
        }
        return service;
    }
    
    public static void RegisterType(this IServiceCollection service, Type interfaceType, Type serviceType, ServiceLifetime serviceLifetime)
    {
        switch (serviceLifetime)
        {
            case ServiceLifetime.Scoped:
                service.AddScoped(interfaceType, serviceType);
                break;
            case ServiceLifetime.Singleton:
                service.AddSingleton(interfaceType, serviceType);
                break;
            case ServiceLifetime.Transient:
                service.AddTransient(interfaceType, serviceType);
                break;
            default:
                throw new ArgumentOutOfRangeException();
        }
    }

### å®ç°å±æ€§æ³¨å…¥

å› ä¸º.Net Coreé»˜è®¤æ˜¯ä¸æ”¯æŒå±æ€§æ³¨å…¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`IControllerActivator`æ¥å£æ¥å®ç°è®©æ§åˆ¶å™¨æ”¯æŒå±æ€§æ³¨å…¥ã€‚`IControllerActivator`Â æ¥å£çš„ä½œç”¨æ˜¯åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹ï¼Œå½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾æ—¶ï¼Œæ¡†æ¶éœ€è¦åˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨å®ä¾‹ä»¥å¤„ç†è¯¥è¯·æ±‚ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°Â `IControllerActivator`Â æ¥å£æ¥è‡ªå®šä¹‰æ§åˆ¶å™¨å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ã€‚å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç‰¹æ€§ï¼Œåœ¨æ§åˆ¶å™¨éœ€è¦å®ä¾‹çš„å±æ€§ä¸Šé¢æ ‡è®°ä¸€ä¸‹ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬ä»å®¹å™¨ä¸­å–å‡ºå¯¹åº”çš„å®ä¾‹å¯¹å…¶è¿›è¡Œèµ‹å€¼å³å¯ã€‚  

    [AttributeUsage(AttributeTargets.Property)]
    public class InjectAttribute : Attribute
    {
    }
    
    public class CustomControllerActivator : IControllerActivator
    {
        /// <summary>
        /// ç”¨äºåˆ›å»ºæ§åˆ¶å™¨å®ä¾‹ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ­¤æ–¹æ³•å®ä¾‹å±æ€§ä¿¡æ¯
        /// <summary>
        public object Create(ControllerContext context)
        {
            var controllerType = context.ActionDescriptor.ControllerTypeInfo.AsType();//å¾—åˆ°æ§åˆ¶å™¨çš„ç±»å‹
            var controllerInstance = context.HttpContext.RequestServices.GetService(controllerType);//ç”¨å®¹å™¨å®Œæˆæ§åˆ¶å™¨çš„å®ä¾‹åŒ–
            //å¾ªç¯æ ‡è®°Injectç‰¹æ€§çš„å±æ€§
            foreach (var prop in controllerType.GetProperties().Where(p => p.IsDefined(typeof(InjectAttribute), true)))
            {
                //ä»å®¹å™¨ä¸­å–å‡ºå¯¹åº”çš„å®ä¾‹
                var propValue = context.HttpContext.RequestServices.GetService(prop.PropertyType);
                prop.SetValue(controllerInstance, propValue);
            }
    
            return controllerInstance;
        }
    
        /// <summary>
        /// ç”¨äºé‡Šæ”¾æ§åˆ¶å™¨å®ä¾‹ä»¥ä¾¿è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œ    /// å½“ ASP.NET Core æ¡†æ¶ä¸å†éœ€è¦ä½¿ç”¨æ§åˆ¶å™¨å®ä¾‹æ—¶ï¼Œå®ƒä¼šè°ƒç”¨Releaseæ–¹æ³•æ¥é€šçŸ¥IControllerActivatorå®ç°é‡Šæ”¾æ§åˆ¶å™¨å®ä¾‹ã€‚    /// åœ¨é‡Šæ”¾æ§åˆ¶å™¨å®ä¾‹ä¹‹å‰ï¼ŒRelease æ–¹æ³•å¯ä»¥æ‰§è¡Œä»»ä½•å¿…è¦çš„æ¸…ç†æ“ä½œï¼Œä¾‹å¦‚å…³é—­æ•°æ®åº“è¿æ¥ã€é‡Šæ”¾æœªæ‰˜ç®¡èµ„æºç­‰ã€‚
        /// <summary>
        public void Release(ControllerContext context, object controller)
        {
            if (context == null)
            {
                throw new ArgumentNullException(nameof(context));
            }
    
            if (controller == null)
            {
                throw new ArgumentNullException(nameof(controller));
            }
    
            var disposable = controller as IDisposable;
            if (disposable != null)
            {
                disposable.Dispose();
            }
        }
    }

æˆ‘ä»¬å…ˆæ˜¯è¯´äº†ä¸€ä¸‹IOCçš„ç†å¿µï¼Œå†ä»‹ç»äº†.Net Coreä¸­ä¸‰ç§æ³¨å…¥çš„ç”Ÿå‘½å‘¨æœŸï¼Œç„¶åçœ‹æºç äº†è§£å…¶å†…éƒ¨æ˜¯å¦‚ä½•è¿ä½œçš„ä»¥åŠæ€æ ·æ›¿æ¢é»˜è®¤å®¹å™¨ï¼Œæœ€åç”¨.Net Coreè‡ªå¸¦å®¹å™¨å®ç°æ‰¹é‡æ³¨å…¥ä»¥åŠæ‰©å±•å±æ€§æ³¨å…¥ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ğŸï¸