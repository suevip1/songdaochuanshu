---
layout: post
title: "ã€.Net/C#ä¹‹ChatGPTå¼€å‘ç³»åˆ—ã€‘å››ã€ChatGPTå¤šKEYåŠ¨æ€è½®è¯¢ï¼Œè‡ªåŠ¨åˆ é™¤æ— æ•ˆKEY"
date: "2023-07-03T01:25:37.714Z"
---
ã€.Net/C#ä¹‹ChatGPTå¼€å‘ç³»åˆ—ã€‘å››ã€ChatGPTå¤šKEYåŠ¨æ€è½®è¯¢ï¼Œè‡ªåŠ¨åˆ é™¤æ— æ•ˆKEY
================================================

ChatGPTæ˜¯ä¸€ç§åŸºäºTokenæ•°é‡è®¡è´¹çš„è¯­è¨€æ¨¡å‹ï¼Œå®ƒå¯ä»¥ç”Ÿæˆé«˜è´¨é‡çš„æ–‡æœ¬ã€‚ç„¶è€Œï¼Œæ¯ä¸ªæ–°è´¦å·åªæœ‰ä¸€ä¸ªæœ‰é™çš„åˆå§‹é…é¢ï¼Œç”¨å®Œåå°±éœ€è¦ä»˜è´¹æ‰èƒ½ç»§ç»­ä½¿ç”¨ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯èƒ½å­˜åœ¨ä½¿ç”¨å¤šKEYçš„æƒ…å†µï¼Œå¹¶åœ¨æ¯ä¸ªKEYè¾¾åˆ°é¢åº¦ä¸Šé™åï¼Œè‡ªåŠ¨å°†å…¶åˆ é™¤ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å®ç°è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿè¿˜è¯·å¤§å®¶æ‰«ä¸ªå°å…³ã€‚ğŸ‘‡

![](https://img2023.cnblogs.com/blog/49399/202307/49399-20230702165056627-1110807339.png)

**ChatGPTå¤šKEYè½®è¯¢**
-----------------

ä¸ºäº†å®ç°å¤šKEYç®¡ç†ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦æŠŠæ‰€æœ‰å¯†é’¥ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œä½†ä¸ºäº†ç®€åŒ–æ¼”ç¤ºï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨Redisæ¥è¿›è¡Œå­˜å‚¨å’Œç®¡ç†å¤šä¸ªKEYã€‚åŒæ ·ï¼Œæˆ‘å°†é‡æ–°åˆ›å»ºä¸€ä¸ªåä¸ºChatGPT.Demo4çš„é¡¹ç›®ï¼Œä»£ç å’ŒChatGPT.Demo3ç›¸åŒã€‚

### **ä¸€ã€Rediså¯†é’¥ç®¡ç†**

#### **1ã€å®šä¹‰IChatGPTKeyServiceæ¥å£**

åœ¨æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªåä¸ºExtensionsçš„æ–‡ä»¶å¤¹ï¼Œç„¶åå³é”®ç‚¹å‡»å®ƒï¼Œæ–°å»ºä¸€ä¸ªIChatGPTKeyService.csæ¥å£æ–‡ä»¶ï¼Œå¹¶å†™å…¥ä»¥ä¸‹ä»£ç ï¼š

public interface IChatGPTKeyService
{
    //åˆå§‹è¯å¯†é’¥
    public Task InitAsync();

    //éšæœºè·å–å¯†é’¥KEY
    public Task<string\> GetRandomAsync();

    //è·å–æ‰€æœ‰å¯†é’¥
    Task<string\[\]> GetAllAsync();

    //ç§»é™¤å¯†é’¥
    Task RemoveAsync(string apiKey);
}

InitAsyncæ–¹æ³•ç”¨ä»¥åˆå§‹åŒ–å¯†é’¥ï¼ŒGetRandomAsyncæ–¹æ³•ç”¨äºéšæœºè¯»å–ä¸€ä¸ªå¯†é’¥ï¼ŒGetAllAsyncæ–¹æ³•ç”¨äºè¯»å–æ‰€æœ‰å¯†é’¥ï¼ŒRemoveAsyncæ–¹æ³•ç”¨äºåˆ é™¤æŒ‡å®šå¯†é’¥ã€‚

#### **2ã€å®ç°IChatGPTKeyServiceæœåŠ¡**

å®‰è£…StackExchange.Redisåº“ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºè®¿é—®å’Œæ“ä½œRedisæ•°æ®åº“çš„.NETå®¢æˆ·ç«¯ã€‚

PM> Install-Package StackExchange.Redis

å³é”®ç‚¹å‡»Extensionsæ–‡ä»¶å¤¹ï¼Œæ–°å»ºä¸€ä¸ªChatGPTKeyService.csæ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹ä»£ç ï¼š

using StackExchange.Redis;

public class ChatGPTKeyService : IChatGPTKeyService
{
    private ConnectionMultiplexer? \_connection;
    private IDatabase? \_cache;
    private readonly string \_configuration;
    private const string \_redisKey = "ChatGPTKey";

    public ChatGPTKeyService(string configuration)
    {
        \_configuration \= configuration;
    }

    private async Task ConnectAsync()
    {
        if (\_cache != null) return;
        \_connection \= await ConnectionMultiplexer.ConnectAsync(\_configuration);
        \_cache \= \_connection.GetDatabase();
    }
    public async Task InitAsync()
    {
        await ConnectAsync();
        //ä½¿ç”¨Setå¯¹è±¡å­˜å‚¨å¯†é’¥
        await \_cache!.SetAddAsync(\_redisKey, new RedisValue\[\] {
        "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx1",
        "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx2",
        });
    }
    public async Task<string\> GetRandomAsync()
    {
        await ConnectAsync();
        //ä½¿ç”¨Setéšæœºè¿”å›ä¸€ä¸ªå¯†é’¥
        var redisValue = await \_cache!.SetRandomMemberAsync(\_redisKey);
        return redisValue.ToString();
    }

    public async Task<string\[\]> GetAllAsync()
    {
        await ConnectAsync();
        //è¯»å–æ‰€æœ‰å¯†é’¥
        var redisValues = await \_cache!.SetMembersAsync(\_redisKey);
        return redisValues.Select(m => m.ToString()).ToArray();
    }

    public async Task RemoveAsync(string apiKey)
    {
        await ConnectAsync();
        await \_cache!.SetRemoveAsync(\_redisKey, apiKey);
    }
}

ä¸ºäº†ä¿å­˜KEYï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨Redisçš„Setæ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥å­˜å‚¨ä¸é‡å¤çš„å…ƒç´ ï¼Œå¹¶ä¸”å¯ä»¥éšæœºè¿”å›ä¸€ä¸ªå…ƒç´ ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°å¯†é’¥çš„éšæœºè½®æ¢åŠŸèƒ½ã€‚ConnectAsyncæ–¹æ³•æ˜¯ç”¨æ¥å»ºç«‹å’ŒRedisæ•°æ®åº“çš„è¿æ¥ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ‰“å¼€Program.csæ–‡ä»¶æ³¨å†ŒChatGPTKeyServiceæœåŠ¡ã€‚å¦å¤–ï¼Œä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ï¼Œè°ƒç”¨InitAsyncæ–¹æ³•æ¥åˆå§‹åŒ–æ•°æ®ï¼š

using ChatGPT.Demo4.Extensions;
//æ³¨å†ŒIChatGPTKeyServiceå•ä¾‹æœåŠ¡
builder.Services.AddSingleton<IChatGPTKeyService>(
    new ChatGPTKeyService("localhost"));
    
var app = builder.Build();
//åˆå§‹åŒ–redisæ•°æ®åº“
var \_chatGPTKeyService = app.Services.GetRequiredService<IChatGPTKeyService>();
\_chatGPTKeyService.InitAsync().Wait();

Betalgo.OpenAIæä¾›äº†ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œä¸€ç§æ˜¯ä¾èµ–æ³¨å…¥ï¼Œä¸€ç§æ˜¯éä¾èµ–æ³¨å…¥ã€‚ä¹‹å‰æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ä¾èµ–æ³¨å…¥æ–¹å¼ï¼Œå¤§å®¶ä¼šå‘ç°ï¼Œä¾èµ–æ³¨å…¥å¹¶ä¸æ”¯æŒå¤šKEYçš„è®¾ç½®ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨éä¾èµ–æ³¨å…¥çš„æ–¹å¼å®ç°ã€‚

_//Betalgo.OpenAIåœ°å€ï¼š[https:_//github.com/betalgo/openai_](https://github.com/betalgo/openai)_

### **äºŒã€ éä¾èµ–æ³¨å…¥å®ç°å¯†é’¥è½®æ¢**

#### **1ã€å–æ¶ˆIOpenAIServiceæœåŠ¡æ³¨å†Œ**

æˆ‘ä»¬å…ˆæ‰“å¼€Program.csæ–‡ä»¶ï¼ŒæŠŠIOpenAIServiceæœåŠ¡çš„æ³¨å†Œä»£ç æ³¨é‡Šæ‰ã€‚

![](https://img2023.cnblogs.com/blog/49399/202307/49399-20230702170125913-1459860304.png)

#### **2ã€å–æ¶ˆIOpenAIServiceä¾èµ–æ³¨å…¥**

æ‰“å¼€Controllers/ChatController.csæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ IChatGPTKeyServiceæœåŠ¡çš„å‘½åç©ºé—´ï¼Œç„¶ååœ¨æ„é€ å‡½æ•°ä¸­æ³¨å…¥è¯¥æœåŠ¡ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬æŠŠIOpenAIServiceæœåŠ¡çš„æ³¨å…¥ä¹Ÿæ³¨é‡Šæ‰ã€‚

using ChatGPT.Demo4.Extensions;

//private readonly IOpenAIService \_openAiService;
private readonly IChatGPTKeyService \_chatGPTKeyService;

public ChatController(/\*IOpenAIService openAiService,\*/ IChatGPTKeyService chatGPTKeyService)
{
    //\_openAiService = openAiService;
    \_chatGPTKeyService = chatGPTKeyService;
}

#### **3ã€æ‰‹åŠ¨å®ä¾‹åŒ–IOpenAIService**

æ¥ç€ä¿®æ”¹Inputæ–¹æ³•ï¼Œå…ˆè°ƒç”¨IChatGPTKeyServiceä¸­çš„GetRandomAsyncæ–¹æ³•ï¼Œè·å–ä¸€ä¸ªéšæœºçš„å¯†é’¥ã€‚ç„¶åï¼Œä½¿ç”¨è¿™ä¸ªå¯†é’¥æ¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªIOpenAIServiceæœåŠ¡çš„å®ä¾‹ã€‚

string apiKey = await \_chatGPTKeyService.GetRandomAsync();
IOpenAIService \_openAiService \= new OpenAIService(new OpenAiOptions
{
    ApiKey \= apiKey
});

![](https://img2023.cnblogs.com/blog/49399/202307/49399-20230702170126089-1935924512.png)

è¿™æ ·ï¼Œé€šè¿‡éä¾èµ–æ³¨å…¥æ–¹å¼ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ChatGPTçš„å¤šKEYåŠ¨æ€è½®è¯¢åŠŸèƒ½ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼æ²¡æœ‰åˆ©ç”¨.NetÂ Coreçš„ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œæ— æ³•å‘æŒ¥å®ƒçš„ä¼˜åŠ¿ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰å¯èƒ½ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè®©æˆ‘ä»¬ç»§ç»­ã€‚

### **ä¸‰ã€ ä¾èµ–æ³¨å…¥å®ç°å¯†é’¥è½®æ¢**

Betalgo.OpenAIè¯·æ±‚æ˜¯åŸºäºHttpClientæ¥å®ç°çš„ï¼Œè¿™ç»™æˆ‘ä»¬å®ç°å¤šKEYåˆ‡æ¢å¸¦æ¥äº†å¸Œæœ›ã€‚

DelegatingHandleræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»§æ‰¿è‡ªHttpMessageHandlerï¼Œç”¨äºå¤„ç†HTTPè¯·æ±‚å’Œå“åº”ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯å¯ä»¥å°†è¯·æ±‚å’Œå“åº”çš„å¤„ç†å§”æ‰˜ç»™å¦ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œç§°ä¸ºå†…éƒ¨å¤„ç†ç¨‹åºã€‚é€šå¸¸ï¼Œä¸€ç³»åˆ—çš„DelegatingHandlerè¢«é“¾æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå¤„ç†ç¨‹åºé“¾ã€‚ç¬¬ä¸€ä¸ªå¤„ç†ç¨‹åºæ¥æ”¶ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œåšä¸€äº›å¤„ç†ï¼Œç„¶åå°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œè¿™ç§æ¨¡å¼è¢«ç§°ä¸ºå§”æ‰˜å¤„ç†ç¨‹åºæ¨¡å¼ã€‚

HttpClienté»˜è®¤ä½¿ç”¨HttpClientHandlerå¤„ç†ç¨‹åºæ¥å¤„ç†è¯·æ±‚ï¼ŒHttpClientHandlerç»§æ‰¿è‡ªHttpMessageHandlerï¼Œå®ƒé‡å†™äº†HttpMessageHandlerçš„Sendæ–¹æ³•ï¼Œè´Ÿè´£å°†è¯·æ±‚é€šè¿‡ç½‘ç»œå‘é€åˆ°æœåŠ¡å™¨å¹¶è·å–æœåŠ¡å™¨çš„å“åº”ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç®¡é“ä¸­æ’å…¥è‡ªå®šä¹‰çš„DelegatingHandlerï¼Œæ¥æ‹¦æˆªä¿®æ”¹è¯·æ±‚å¤´ä¸­çš„å¯†é’¥ï¼Œå®ç°å¤šKEYè½®æ¢çš„åŠŸèƒ½ã€‚

#### **1ã€åˆ›å»ºDelegatingHandler**

è¦ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„DelegatingHandlerï¼Œæˆ‘ä»¬éœ€è¦ç»§æ‰¿System.Net.Http.DelegatingHandlerç±»ï¼Œå¹¶é‡å†™å®ƒçš„Sendæ–¹æ³•ã€‚

æˆ‘ä»¬åœ¨Extensionsæ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºChatGPTHttpMessageHandler.csçš„æ–‡ä»¶ï¼Œç„¶ååœ¨å…¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

    public class ChatGPTHttpMessageHandler : DelegatingHandler
{
        private readonly IChatGPTKeyService \_chatGPTKeyService;

        public ChatGPTHttpMessageHandler(IChatGPTKeyService  chatGPTKeyService)
        {
            \_chatGPTKeyService \= chatGPTKeyService;
        }

        protected override async Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
        {
            var apiKey = await \_chatGPTKeyService.GetRandomAsync();

            request.Headers.Remove("Authorization");
            request.Headers.Add("Authorization", $"Bearer {apiKey}");
            return await base.SendAsync(request, cancellationToken);
        }

        protected override HttpResponseMessage Send(HttpRequestMessage request, CancellationToken cancellationToken)
        {
            var apiKey = \_chatGPTKeyService.GetRandomAsync().Result;
            request.Headers.Remove("Authorization");
            request.Headers.Add("Authorization", $"Bearer {apiKey}");
            return base.Send(request, cancellationToken);
        }
    }

åœ¨ChatGPTHttpMessageHandlerä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼è·å–IChatGPTKeyServiceå¯†é’¥æœåŠ¡çš„å®ä¾‹ï¼Œç„¶åé‡å†™äº†Sendæ–¹æ³•ï¼Œè°ƒç”¨IChatGPTKeyServiceçš„GetRandomAsyncæ–¹æ³•éšæœºè·å–ä¸€ä¸ªKEYï¼Œæ¥ç€ä½¿ç”¨HttpHeadersçš„Removeæ–¹æ³•ç§»é™¤é»˜è®¤çš„KEYï¼Œå†ä½¿ç”¨HttpHeadersçš„Addæ–¹æ³•æ·»åŠ è·å–çš„KEYï¼Œæœ€åæˆ‘ä»¬è°ƒç”¨base.SendAsyncæ–¹æ³•å°†è¯·æ±‚ä¼ é€’ç»™å†…éƒ¨å¤„ç†ç¨‹åºè¿›è¡Œåç»­çš„å¤„ç†ã€‚è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†KEYçš„åˆ‡æ¢ã€‚

#### **2ã€æ³¨å†ŒDelegatingHandler**

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Program.csæ–‡ä»¶ä¸­ï¼Œå°†ChatGPTHttpMessageHandlerå¤„ç†ç¨‹åºæ³¨å†Œåˆ°OpenAIServiceçš„è¯·æ±‚ç®¡é“ä¸­ã€‚

builder.Services.AddTransient<ChatGPTHttpMessageHandler>();
builder.Services.AddHttpClient<IOpenAIService, OpenAIService>().AddHttpMessageHandler<ChatGPTHttpMessageHandler>()ï¼›

#### **3ã€é‡æ–°æ³¨å†ŒIOpenAIServiceæœåŠ¡**

åŒæ—¶å–æ¶ˆProgram.csæ–‡ä»¶ä¸­OpenAIServiceæœåŠ¡çš„æ³¨é‡Šã€‚

![](https://img2023.cnblogs.com/blog/49399/202307/49399-20230702170126066-1415387514.png)

#### **4ã€æ¢å¤IOpenAIServiceä¾èµ–æ³¨å…¥**

æœ€ååœ¨Controllers/ChatController.csä¸­ï¼Œæˆ‘ä»¬é‡æ–°ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼è·å–OpenAIServiceæœåŠ¡çš„å®ä¾‹ï¼ŒåŒæ—¶æ³¨é‡Šæ‰æ‰‹åŠ¨åˆ›å»ºOpenAIServiceçš„ä»£ç ã€‚![](https://img2023.cnblogs.com/blog/49399/202307/49399-20230702170126105-2002955109.png)

**åŠ¨æ€åˆ é™¤æ— æ•ˆKEY**
-------------

å½“ChatGPTè´¦å·ä½¿ç”¨è¾¾åˆ°é¢åº¦ä¸Šé™æ—¶ï¼ŒKEYå°†ä¼šå¤±æ•ˆï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åŠæ—¶åˆ é™¤æ— æ•ˆçš„KEYï¼Œé¿å…å½±å“è¯·æ±‚çš„æ­£å¸¸å‘é€ã€‚ä½†æ¯”è¾ƒé—æ†¾ï¼ŒOpenAIå®˜æ–¹å¹¶æ²¡æœ‰æä¾›ç›´æ¥çš„APIæ¥æŸ¥è¯¢é¢åº¦ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“KEYæ˜¯å¦è¿˜æœ‰æ•ˆå‘¢ï¼Ÿ

å¹¸è¿çš„æ˜¯ï¼Œæœ‰å¤§ç¥é€šè¿‡æŠ“åŒ…åˆ†æå‘ç°äº†ä¸¤ä¸ªå¯ç”¨çš„æ¥å£ï¼Œå¯ä»¥ç”¨æ¥æŸ¥è¯¢KEYçš„ç›¸å…³ä¿¡æ¯ï¼Œä¸€ä¸ªæ˜¯è´¦å•æŸ¥è¯¢APIï¼Œç”¨æ¥æŸ¥è¯¢KEYçš„è¿‡æœŸæ—¶é—´å’Œå‰©ä½™é¢åº¦ï¼Œå®ƒæ¥å—GETè¯·æ±‚ï¼Œåœ¨Headerä¸­å¸¦ä¸ŠæˆæƒToken(APIÂ KEY)å³å¯ã€‚

_//è´¦å•æŸ¥è¯¢APIï¼š[https:_//api.openai.com/v1/dashboard/billing/subscription_](https://api.openai.com/v1/dashboard/billing/subscription)_

å¦ä¸€ä¸ªæ˜¯è´¦å•æ˜ç»†æŸ¥è¯¢ï¼Œç”¨æ¥æŸ¥è¯¢å·²ä½¿ç”¨çš„é¢åº¦å’Œå…·ä½“çš„è¯·æ±‚è®°å½•ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªGETè¯·æ±‚ï¼Œåœ¨Headerä¸­åŒæ ·éœ€è¦æºå¸¦æˆæƒToken(APIÂ KEY)ï¼Œå¦å¤–è¿˜å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šè¦æŸ¥è¯¢çš„æ—¥æœŸèŒƒå›´ã€‚

_//è´¦å•æ˜ç»†ï¼š_[https:_//api.openai.com/v1/v1/dashboard/billing/usage?start\_date=2023-07-01&end\_date=2023-07-02_](https://api.openai.com/v1/v1/dashboard/billing/usage?start_date=2023-07-01&end_date=2023-07-02)

#### **1ã€åˆ›å»ºChatGPTè´¦å•æŸ¥è¯¢æœåŠ¡**

æˆ‘ä»¬åœ¨Extensionsæ–‡ä»¶å¤¹ä¸­åˆ›å»ºIChatGPTBillService.csæ¥å£å’ŒChatGPTBillService.csæœåŠ¡ä¸¤ä¸ªæ–‡ä»¶ï¼ŒIChatGPTBillServiceæ¥å£å£°æ˜äº†è´¦å•åŠæ˜ç»†æŸ¥è¯¢ä¸¤ä¸ªæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

public interface IChatGPTBillService
{
    /// <summary>
    /// æŸ¥è¯¢è´¦å•
    /// </summary>
    /// <param name="apiKey">apiå¯†é’¥</param>
    /// <returns></returns>
    Task<ChatGPTBillModel?> QueryAsync(string apiKey);

    /// <summary>
    /// è´¦å•æ˜ç»†
    /// </summary>
    /// <param name="apiKey">apiå¯†é’¥</param>
    /// <param name="startTime">å¼€å§‹æ—¥æœŸ</param>
    /// <param name="endTime">ç»“æŸæ—¥æœŸ</param>
    /// <returns></returns>
    Task<ChatGPTBillDetailsModel?> QueryDetailsAsync(string apiKey, DateTimeOffset startTime, DateTimeOffset endTime);
}

ChatGPTBillServiceæœåŠ¡æ˜¯IChatGPTBillServiceæ¥å£çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

public class ChatGPTBillService : IChatGPTBillService
{
    private readonly IHttpClientFactory \_httpClientFactory;

    public ChatGPTBillService(IHttpClientFactory httpClientFactory)
    {
        \_httpClientFactory \= httpClientFactory;
    }

    public async Task<ChatGPTBillModel?> QueryAsync(string apiKey)
    {
        string url = "https://api.openai.com/v1/dashboard/billing/subscription";
        var client = \_httpClientFactory.CreateClient();
        client.DefaultRequestHeaders.Add("Authorization", $"Bearer {apiKey}");
        var response = await client.GetFromJsonAsync<ChatGPTBillModel>(url);
        return response;
    }

    public async Task<ChatGPTBillDetailsModel?> QueryDetailsAsync(string apiKey, DateTimeOffset startTime, DateTimeOffset endTime)
    {
        string url = $"https://api.openai.com/dashboard/billing/usage?start\_date={startTime:yyyy-MM-dd}&end\_date={endTime:yyyy-MM-dd}";
        var client = \_httpClientFactory.CreateClient();
        client.DefaultRequestHeaders.Add("Authorization", $"Bearer {apiKey}");
        var response = await client.GetFromJsonAsync<ChatGPTBillDetailsModel>(url);
        return response;
    }
}

ChatGPTBillServiceé€šè¿‡ä½¿ç”¨IHttpClientFactoryå·¥å‚åˆ›å»ºHttpClientæ¥å‘é€è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ ChatGPTçš„æˆæƒTokenï¼Œå³APIÂ KEYï¼Œä»è€Œå®ç°å¯¹ChatGPTçš„è´¦å•å’Œæ˜ç»†çš„æŸ¥è¯¢åŠŸèƒ½ã€‚è€ƒè™‘åˆ°ç¯‡å¹…é•¿åº¦ï¼Œè¿™é‡Œä¸å†ç»™å‡ºè´¦å•ç±»ChatGPTBillModelå’Œè´¦å•æ˜ç»†ç±»ChatGPTBillDetailsModelçš„å…·ä½“å®šä¹‰ã€‚

#### **2ã€åˆ›å»ºåå°ä»»åŠ¡è¿‡æ»¤æ— æ•ˆKEY**

æˆ‘ä»¬ä½¿ç”¨BackgroundServiceæ¥å®ç°è‡ªåŠ¨è¿‡æ»¤ä»»åŠ¡ï¼ŒBackgroundServiceæ˜¯.NETÂ Coreä¸­çš„ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œå®ƒå®ç°äº†IHostedServiceæ¥å£ï¼Œç”¨äºæ‰§è¡Œåå°ä»»åŠ¡æˆ–é•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡ã€‚BackgroundServiceç±»æä¾›äº†ä»¥ä¸‹æ–¹æ³•ï¼š

*   StartAsyncÂ (CancellationToken)ï¼šåœ¨æœåŠ¡å¯åŠ¨æ—¶è°ƒç”¨ï¼Œå¯ä»¥ç”¨äºæ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œã€‚
*   StopAsyncÂ (CancellationToken)ï¼šåœ¨æœåŠ¡åœæ­¢æ—¶è°ƒç”¨ï¼Œå¯ä»¥ç”¨äºæ‰§è¡Œä¸€äº›æ¸…ç†æ“ä½œã€‚
*   ExecuteAsyncÂ (CancellationToken)ï¼šåœ¨æœåŠ¡è¿è¡Œæ—¶è°ƒç”¨ï¼ŒåŒ…å«äº†åå°ä»»åŠ¡çš„ä¸»è¦é€»è¾‘ï¼Œå¿…é¡»è¢«é‡å†™

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåå°å®šæ—¶ä»»åŠ¡ï¼Œåœ¨ExecuteAsyncæ–¹æ³•ä¸­æ‰§è¡ŒChatGPTçš„å¯†é’¥è¿‡æ»¤ã€‚åœ¨Extensionsæ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªåä¸ºChatGPTBillBackgroundService.csçš„æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

public class ChatGPTBillBackgroundService : BackgroundService
{
    private readonly IChatGPTKeyService \_chatGPTKeyService;
    private readonly IChatGPTBillService \_chatGPTBillService;

    public ChatGPTBillBackgroundService(IChatGPTKeyService chatGPTKeyService, IChatGPTBillService chatGPTBillService)
    {
        \_chatGPTKeyService \= chatGPTKeyService;
        \_chatGPTBillService \= chatGPTBillService;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            var apiKeys = await \_chatGPTKeyService.GetAllAsync();
            foreach (var apiKey in apiKeys)
            {
                var bill = await \_chatGPTBillService.QueryAsync(apiKey);
                if (bill == null) continue;

                var dt = DateTimeOffset.Now;
                //åˆ¤æ–­keyæ˜¯å¦åˆ°æœŸæˆ–æ˜¯å¦æœ‰é¢åº¦
                if (bill.AccessUntil < dt.ToUnixTimeSeconds() || bill.HardLimitUsd == 0)
                {
                    await \_chatGPTKeyService.RemoveAsync(apiKey);
                    continue;
                }
                //æŸ¥è¯¢99å¤©ä»¥å†…çš„è´¦å•æ˜ç»†
                var billDetails = await \_chatGPTBillService.QueryDetailsAsync(
                    apiKey, dt.AddDays(\-99), dt.AddDays(1));

                if (billDetails == null) continue;

                //åˆ¤æ–­å·²ä½¿ç”¨é¢åº¦å¤§äºç­‰äºæ€»é¢åº¦
                if (billDetails.TotalUsage >= bill.HardLimitUsd)
                {
                    await \_chatGPTKeyService.RemoveAsync(apiKey);
                    continue;
                }
            }

            // åˆ›å»ºä¸€ä¸ªå¼‚æ­¥çš„ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡åœ¨æŒ‡å®š1åˆ†é’Ÿé—´éš”åå®Œæˆ
            await Task.Delay(1 \* 60 \* 1000, stoppingToken);
        }

    }
}

ChatGPTBillBackgroundServiceç±»ç»§æ‰¿è‡ªBackgroundServiceï¼Œå¹¶é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥äº†IChatGPTKeyServiceå¯†é’¥æœåŠ¡å’ŒIChatGPTBillServiceè´¦å•æœåŠ¡ï¼Œç„¶åé‡å†™äº†ExecuteAsyncæ–¹æ³•ï¼Œé€šè¿‡ä½¿ç”¨whileå¾ªç¯å’ŒTask.Delayæ–¹æ³•é—´æ¥å®ç°æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡çš„å®šæ—¶ä»»åŠ¡ï¼Œä»»åŠ¡çš„é€»è¾‘æ˜¯ï¼šä»ç¼“å­˜ä¸­è·å–æ‰€æœ‰å¯†é’¥ï¼Œç„¶åå¯¹æ¯ä¸ªå¯†é’¥è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š

*   è°ƒç”¨IChatGPTBillServiceæœåŠ¡ï¼ŒæŸ¥è¯¢å¯†é’¥çš„æœ‰æ•ˆæœŸå’Œæ€»é¢åº¦ã€‚
*   å¦‚æœå¯†é’¥å·²è¿‡æœŸæˆ–æ€»é¢åº¦ä¸ºé›¶ï¼Œå°±ä»ç¼“å­˜ä¸­ç§»é™¤è¯¥å¯†é’¥ã€‚
*   å¦‚æœå¯†é’¥ä»æœ‰æ•ˆï¼Œå°±ç»§ç»­è°ƒç”¨IChatGPTBillServiceæœåŠ¡ï¼ŒæŸ¥è¯¢å¯†é’¥çš„å·²ä½¿ç”¨é¢åº¦ã€‚
*   å¦‚æœå·²ä½¿ç”¨é¢åº¦å¤§äºæˆ–ç­‰äºæ€»é¢åº¦ï¼Œå°±ä»ç¼“å­˜ä¸­ç§»é™¤è¯¥å¯†é’¥ã€‚

ä¸ºäº†è®©è¿™ä¸ªåå°æœåŠ¡èƒ½å¤Ÿåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è¿è¡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨Program.csæ–‡ä»¶ä¸­æ³¨å†Œå®ƒã€‚æ‰“Program.csæ–‡ä»¶ï¼ŒåŠ å…¥ä¸‹é¢çš„ä»£ç ï¼š

//æ³¨å†Œè´¦å•æœåŠ¡
builder.Services.AddSingleton<IChatGPTBillService, ChatGPTBillService>();
//æ³¨å†Œåå°ä»»åŠ¡
builder.Services.AddHostedService<ChatGPTBillBackgroundService>();

![](https://img2023.cnblogs.com/blog/49399/202307/49399-20230702170126109-1936714270.png)

è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†ChatGPTçš„å¤šKEYåŠ¨æ€è½®è¯¢ï¼Œå’Œè‡ªåŠ¨åˆ é™¤æ— æ•ˆKEYçš„åŠŸèƒ½å®ç°ã€‚

å†™ä½œä¸æ˜“ï¼Œè½¬è½½è¯·æ³¨æ˜åšæ–‡åœ°å€ï¼Œå¦åˆ™ç¦è½¬ï¼ï¼ï¼

`//æºç åœ°å€ï¼š`[`https://github.com/ynanech/ChatGPT.Demo`](https://github.com/ynanech/ChatGPT.Demo)