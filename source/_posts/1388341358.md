---
layout: post
title: "è®°ä¸€æ¬¡ .NET æŸè½¦é›¶ä»¶MESç³»ç»Ÿ ç™»å½•å¼‚å¸¸åˆ†æ"
date: "2023-05-08T01:04:46.235Z"
---
è®°ä¸€æ¬¡ .NET æŸè½¦é›¶ä»¶MESç³»ç»Ÿ ç™»å½•å¼‚å¸¸åˆ†æ
=========================

ä¸€ï¼šèƒŒæ™¯
----

### 1\. è®²æ•…äº‹

è¿™ä¸ªæ¡ˆä¾‹æœ‰ç‚¹ç‰¹æ®Šï¼Œä»¥å‰dumpåˆ†æéƒ½æ˜¯å’Œè½¯ä»¶å·¥ç¨‹å¸ˆæ‰“äº¤é“ï¼Œè¿™æ¬¡å’Œéä¸šå†…äººå£«äº¤æµï¼Œéš”è¡Œå¦‚éš”å±±ï¼Œä»æŒ‡å¯¼dumpæ€ä¹ˆæŠ“åˆ°é—®é¢˜è§£å†³ï¼Œéœ€è¦ä¸€ä¸ªå¼ºå¤§çš„è€å¿ƒã€‚

å‰å‡ å¤©æœ‰ä½æœ‹å‹åœ¨å¾®ä¿¡ä¸Šæ‰¾åˆ°æˆ‘ï¼Œè¯´ä»–ä»¬å…¬å¸é‡‡è´­çš„MESç³»ç»Ÿç™»å½•çš„æ—¶å€™å‡ºç°äº†å¼‚å¸¸ï¼Œè®©æˆ‘å¸®å¿™çœ‹ä¸€ä¸‹ï¼Œæˆ‘åœ¨æƒ³**è§£é“ƒè¿˜é¡»ç³»é“ƒäºº**ï¼Œæ€ä¹ˆçš„ä¹Ÿä¸åº”è¯¥æ‰¾åˆ°æˆ‘å‘€ï¼Œæ®æœ‹å‹åé¦ˆé¡¹ç›®å·²ç»éªŒæ”¶ï¼Œé‚£è¾¹ç»™äº†å›é¦ˆæ˜¯ç½‘ç»œçš„é—®é¢˜ï¼Œå¯èƒ½æ²¡æœ‰å¸®ä»–ä»¬æ›´æ·±å…¥çš„åˆ†æå§ï¼Œæ‰¾æˆ‘çš„ç›®çš„åº”è¯¥å°±æ˜¯éªŒè¯ä¸‹å¯¹æ–¹å…¬å¸è¯´çš„å¯¹ä¸å¯¹ ğŸ˜‚ğŸ˜‚ğŸ˜‚

äºŒï¼šWinDbg åˆ†æ
-----------

### 1\. çœŸçš„æ˜¯ç½‘ç»œé—®é¢˜å—

åœ¨æ²¡æœ‰é¡¹ç›®æºä»£ç å’Œæ—¥å¿—çš„æƒ…å†µä¸‹ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯æŠ“dumpï¼Œä¸€æ ·å¯ä»¥æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼Œè®©æœ‹å‹åœ¨ç¨‹åºç™»å½•å¡æ­»çš„æ—¶å€™æŠ“äº†ä¸€ä¸ªdumpï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹æ˜¯ä¸æ˜¯å¯¹æ–¹å·¥ç¨‹å¸ˆæ‰€è¯´çš„ç½‘ç»œé—®é¢˜ã€‚

å› ä¸ºæœ‰å¡æ­»å‘ç”Ÿï¼Œå¿…ç„¶æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ä»€ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `~*e !clrstack` çœ‹ä¸‹æ‰€æœ‰çš„çº¿ç¨‹çš„çº¿ç¨‹æ ˆã€‚

    
    0:000:x86> ~*e !clrstack
    ...
    OS Thread Id: 0x2094 (14)
    Child SP       IP Call Site
    0f94e888 0000002b [GCFrame: 0f94e888] 
    0f94e938 0000002b [HelperMethodFrame_1OBJ: 0f94e938] System.Threading.Monitor.ObjWait(Boolean, Int32, System.Object)
    ...
    0f94ead0 6b53d7b6 System.Threading.Tasks.Task.Wait(Int32, System.Threading.CancellationToken) [f:\dd\ndp\clr\src\BCL\system\threading\Tasks\Task.cs @ 3167]
    0f94eae0 1468ae6b MySql.Data.Common.Ssl.StartSSL(System.IO.Stream ByRef, System.Text.Encoding, System.String)
    0f94eb38 14687a55 MySql.Data.MySqlClient.NativeDriver.Open()
    0f94ec04 14686e63 MySql.Data.MySqlClient.Driver.Open()
    0f94ec28 14686ac7 MySql.Data.MySqlClient.Driver.Create(MySql.Data.MySqlClient.MySqlConnectionStringBuilder)
    0f94ec50 146869ec MySql.Data.MySqlClient.MySqlPool.CreateNewPooledConnection()
    0f94ec58 14686957 MySql.Data.MySqlClient.MySqlPool.GetPooledConnection()
    0f94ec8c 146863e9 MySql.Data.MySqlClient.MySqlPool.TryToGetDriver()
    0f94ecac 146862ca MySql.Data.MySqlClient.MySqlPool.GetConnection()
    0f94ece0 146817c1 MySql.Data.MySqlClient.MySqlConnection.Open()
    0f94ed18 0ca28753 xxx.GetMySqlConnection()
    ...
    0f94efec 0ca21902 xxx.UserLogin(System.String, System.String)
    ...
    0f94f4ac 6b4ae9db System.Threading._ThreadPoolWaitCallback.PerformWaitCallback() [f:\dd\ndp\clr\src\BCL\system\threading\threadpool.cs @ 1161]
    0f94f6cc 6c500556 [DebuggerU2MCatchHandlerFrame: 0f94f6cc] 
    ...
    
    

é€šè¿‡è§‚å¯Ÿå‘ç° `14` å·çº¿ç¨‹åœ¨ä¸€ä¸ª `xxx.UserLogin` æ–¹æ³•ä¸­ï¼Œåº”è¯¥å°±æ˜¯æœ‹å‹ç‚¹å‡»çš„ç™»å½•æŒ‰é’®çš„é€»è¾‘ï¼Œé€šè¯»ä¸€ä¸‹çº¿ç¨‹æ ˆå¯ä»¥çœ‹åˆ°å®ƒæ˜¯åœ¨ `MySql.Data.Common.Ssl.StartSSL` æ–¹æ³•ä¸­ç­‰å¾…ï¼Œçœ‹æ ·å­æ˜¯åœ¨è¿™é‡Œè¶…æ—¶äº†ã€‚

ä¸€èˆ¬æ¥è¯´ mysql æ˜¯å†…ç½‘çš„è¯ï¼Œä¸ä¼šç‰¹åˆ«å»é…ä»€ä¹ˆ ssl è¯ä¹¦ï¼Œè¿™ä¸ªå¤ªéº»çƒ¦äº†ï¼Œæ¥ä¸‹æ¥éªŒè¯ä¸‹ mysql æ˜¯å†…ç½‘è¿˜æ˜¯å¤–ç½‘ï¼Œå¯ä»¥ç”¨ `!dso` æŸ¥çœ‹mysql çš„è¿æ¥ä¸²ã€‚

![](https://img2023.cnblogs.com/blog/214741/202305/214741-20230508084422742-1205013440.png)

ä»ä¸Šé¢çš„ `192.168` å‰ç¼€æ¥çœ‹æœç„¶æ˜¯å†…ç½‘ï¼Œè¿™æ—¶å€™çŒœæµ‹èµ° SSL è‚¯å®šæ˜¯æ„æ–™ä¹‹å¤–çš„åœºæ™¯ã€‚

### 2\. çœŸçš„è¦èµ° SSL

è®°å¾—å¤§æ¦‚3-4å¹´å‰åœ¨ä¸Šæµ·ä¸Šç­çš„æ—¶å€™ï¼Œæ›¾ç»æœ‰ä¸€ä¸ªé¡¹ç›®å‡çº§ä¹‹åä½¿ç”¨äº†nugetä¸Šçš„ mysql 8.0ï¼Œç„¶åé¡¹ç›®å°±æ— æ³•è®¿é—®äº†ï¼ŒæŠ¥äº†ä»€ä¹ˆæˆæƒé”™è¯¯ï¼Œçœ‹æ ·å­åº”è¯¥å°±æ˜¯ç›®å‰è¿™ä¸ªé¡¹ç›®é‡åˆ°çš„åœºæ™¯ã€‚

æ¥ä¸‹æ¥è¦éªŒè¯ä¸‹è¿™ä¸ª mysql çš„sdk æ˜¯ 8.0 çš„ç‰ˆæœ¬å—ï¼Ÿ å¯ä»¥ç”¨ lm æ‰¾ä¸‹ `MySQL.Data` æ¨¡å—ã€‚

    
    0:014:x86> lm
    start    end        module name
    ...
    12b40000 12ca6000   MySql_Data   (deferred)    
    ...
    
    0:014:x86> lm vm MySql_Data
    Browse full module list
    start    end        module name
    12b40000 12ca6000   MySql_Data   (deferred)             
        Image path: C:\Users\xxxx\MySql.Data.dll
        Image name: MySql.Data.dll
        Browse all global symbols  functions  data
        Has CLR image header, track-debug-data flag not set
        Image was built with /Brepro flag.
        Timestamp:        95CE4983 (This is a reproducible build file hash, not a timestamp)
        CheckSum:         001611FF
        ImageSize:        00166000
        File version:     8.0.29.0
        Product version:  8.0.29.0
        File flags:       0 (Mask 3F)
        File OS:          4 Unknown Win32
        File type:        2.0 Dll
        File date:        00000000.00000000
        Translations:     0000.04b0
        Information from resource tables:
            CompanyName:      Oracle
            ProductName:      MySql.Data.Core
            InternalName:     MySql.Data.dll
            OriginalFilename: MySql.Data.dll
            ProductVersion:   8.0.29
            FileVersion:      8.0.29.0
            FileDescription:  MySql.Data
            LegalCopyright:   Copyright Â© 2016, 2020, Oracle and/or its affiliates. All rights reserved.
            LegalTrademarks:  
            Comments:         ADO.Net driver for MySQL for .Net Framework and .Net Core
    
    

ä»ä¸Šé¢çš„ `Product version` æ¥çœ‹æœç„¶æ˜¯ `8.0` ç‰ˆæœ¬ï¼ŒéªŒè¯äº†æˆ‘çš„çŒœæƒ³ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è®©æœ‹å‹åœ¨è¿æ¥ä¸²ä¸­åŠ ä¸Š `SslMode=None` æ ‡è®°ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·ã€‚

    
    <add key="ä¸ŠæŠ¥å¹³å°1" value="mysql|Database = drp; Data Source = 192.168.xx.xx; port = 3306; User Id = xxx; Password = xxx;SslMode=None" />
    
    

æŠŠç»“æœå‘Šè¯‰æœ‹å‹ä¹‹åï¼Œæœ‹å‹ç¬¬äºŒå¤©åé¦ˆé—®é¢˜æå®šã€‚

![](https://img2023.cnblogs.com/blog/214741/202305/214741-20230508084422793-982556942.png)

ä¸è¿‡ä»–åšäº†ä¸€ä¸ªå¤§èƒ†çš„æ“ä½œï¼Œç¦ç”¨äº† MySQL çš„ `hava_openssl` ã€‚

![](https://img2023.cnblogs.com/blog/214741/202305/214741-20230508084422739-174446560.png)

è¯´å®è¯è¿™ä¸ªå½±å“é¢å¤ªå¤§äº†ï¼Œå‰¯ä½œç”¨å°ä¸€ç‚¹çš„è¯åŠ ä¸Šä¸€ä¸ªåç¼€å°±å¥½ï¼Œä¸ç®¡æ€ä¹ˆæ ·è§£å†³äº†é—®é¢˜å°±è¡Œã€‚

ä¸‰ï¼šæ€»ç»“
----

æ€»çš„æ¥è¯´è¿™ä¸ªé—®é¢˜å¯¹ä¸€ä¸ªå¼€å‘æ¥è¯´å¾ˆç®€å•ï¼Œä½†å¦‚æœæ²Ÿé€šå¯¹è±¡æ˜¯ä¸€ä¸ªéå¼€å‘ï¼Œæ²¡æœ‰æºç ï¼Œæ²¡æœ‰æ—¥å¿— è¿˜èƒ½å‡†ç¡®å®šä½é—®é¢˜ï¼Œæ˜¯ä¸€ä»¶æŒºæœ‰æŒ‘æˆ˜çš„äº‹æƒ…ã€‚

![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)