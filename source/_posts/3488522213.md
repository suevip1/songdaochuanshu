---
layout: post
title: "åˆ©ç”¨Rediså®ç°å‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼šè§£å†³æ–‡æœ¬ã€å›¾åƒå’ŒéŸ³é¢‘ä¹‹é—´çš„ç›¸ä¼¼åº¦åŒ¹é…é—®é¢˜"
date: "2023-07-29T01:06:13.143Z"
---
åˆ©ç”¨Rediså®ç°å‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼šè§£å†³æ–‡æœ¬ã€å›¾åƒå’ŒéŸ³é¢‘ä¹‹é—´çš„ç›¸ä¼¼åº¦åŒ¹é…é—®é¢˜
=====================================

åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸï¼Œæœ‰ä¸€ä¸ªå¸¸è§ä¸”é‡è¦çš„ä»»åŠ¡å°±æ˜¯æ–‡æœ¬ç›¸ä¼¼åº¦æœç´¢ã€‚æ–‡æœ¬ç›¸ä¼¼åº¦æœç´¢æ˜¯æŒ‡æ ¹æ®ç”¨æˆ·è¾“å…¥çš„ä¸€æ®µæ–‡æœ¬ï¼Œä»æ•°æ®åº“ä¸­æ‰¾å‡ºä¸ä¹‹æœ€ç›¸ä¼¼æˆ–æœ€ç›¸å…³çš„ä¸€æ®µæˆ–å¤šæ®µæ–‡æœ¬ã€‚å®ƒå¯ä»¥åº”ç”¨åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼Œä¾‹å¦‚é—®ç­”ç³»ç»Ÿã€æ¨èç³»ç»Ÿã€æœç´¢å¼•æ“ç­‰ã€‚

æ¯”å¦‚ï¼Œå½“ç”¨æˆ·åœ¨çŸ¥ä¹ä¸Šæå‡ºä¸€ä¸ªé—®é¢˜æ—¶ï¼Œç³»ç»Ÿå°±å¯ä»¥ä»çŸ¥ä¹ä¸Šå·²æœ‰çš„å›ç­”ä¸­æ‰¾å‡ºä¸è¯¥é—®é¢˜æœ€åŒ¹é…æˆ–æœ€æœ‰ä»·å€¼çš„å›ç­”ï¼Œå¹¶å±•ç¤ºç»™ç”¨æˆ·ã€‚

è¦å®ç°ç±»ä¼¼é«˜æ•ˆçš„æœç´¢ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€äº›ç‰¹æ®Šçš„æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚å…¶ä¸­ï¼Œå‘é‡ç›¸ä¼¼åº¦æœç´¢æ˜¯ä¸€ç§åœ¨å¤§è§„æ¨¡æ•°æ®æœç´¢ä¸­è¡¨ç°ä¼˜ç§€çš„ç®—æ³•ã€‚è€ŒRedisä½œä¸ºä¸€ç§é«˜æ€§èƒ½çš„é”®å€¼æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°å‘é‡ç›¸ä¼¼åº¦æœç´¢ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥ä½“éªŒä¸€æŠŠï¼Œè¿˜è¯·å¸®å¿™ç‚¹ä¸ªå…³æ³¨ğŸ‘‡

![](https://pic3.zhimg.com/80/v2-7a872ee24751692fb682cecefeda4096_720w.webp)

çŒ¿æƒ‘è±

åœ¨å¼€å§‹å­¦ä¹ å¦‚ä½•ä½¿ç”¨Rediså®ç°å‘é‡ç›¸ä¼¼åº¦æœç´¢ä¹‹å‰ï¼Œéœ€è¦äº†è§£å‘é‡åŠå‘é‡ç›¸ä¼¼åº¦æœç´¢çš„åŸºæœ¬çŸ¥è¯†å’ŒåŸç†ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£åé¢çš„å†…å®¹ã€‚

**ä»€ä¹ˆæ˜¯å‘é‡ï¼Ÿ**
----------

å‘é‡æ˜¯æ•°å­¦ã€ç‰©ç†å­¦å’Œå·¥ç¨‹ç§‘å­¦ç­‰å¤šä¸ªè‡ªç„¶ç§‘å­¦ä¸­çš„åŸºæœ¬æ¦‚å¿µï¼Œå®ƒæ˜¯ä¸€ä¸ªå…·æœ‰æ–¹å‘å’Œé•¿åº¦çš„é‡ï¼Œç”¨äºæè¿°é—®é¢˜ï¼Œå¦‚ç©ºé—´å‡ ä½•ã€åŠ›å­¦ã€ä¿¡å·å¤„ç†ç­‰ã€‚åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå‘é‡è¢«ç”¨äºè¡¨ç¤ºæ•°æ®ï¼Œå¦‚æ–‡æœ¬ã€å›¾åƒæˆ–éŸ³é¢‘ã€‚æ­¤å¤–ï¼Œå‘é‡è¿˜ä»£è¡¨AIæ¨¡å‹å¯¹æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ç­‰éç»“æ„åŒ–æ•°æ®çš„å°è±¡ã€‚

**å‘é‡ç›¸ä¼¼åº¦æœç´¢çš„åŸºæœ¬åŸç†**
----------------

å‘é‡ç›¸ä¼¼åº¦æœç´¢çš„åŸºæœ¬åŸç†æ˜¯é€šè¿‡å°†æ•°æ®é›†ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜ å°„ä¸ºå‘é‡ï¼Œå¹¶ä½¿ç”¨ç‰¹å®šç›¸ä¼¼åº¦è®¡ç®—ç®—æ³•ï¼Œå¦‚åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„ã€åŸºäºæ¬§æ°ç›¸ä¼¼åº¦æˆ–åŸºäºJaccardç›¸ä¼¼åº¦ç­‰ç®—æ³•ï¼Œæ‰¾åˆ°ä¸æŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚

**Rediså®ç°å‘é‡ç›¸ä¼¼åº¦æœç´¢**
------------------

äº†è§£åŸç†åï¼Œæˆ‘ä»¬å¼€å§‹æ¥å®ç°å¦‚ä½•ä½¿ç”¨Rediså®ç°å‘é‡ç›¸ä¼¼åº¦æœç´¢ã€‚Rediså…è®¸æˆ‘ä»¬åœ¨FT.SEARCHå‘½ä»¤ä¸­ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢ã€‚ä½¿æˆ‘ä»¬å¯ä»¥åŠ è½½ã€ç´¢å¼•å’ŒæŸ¥è¯¢ä½œä¸ºRediså“ˆå¸Œæˆ–JSONæ–‡æ¡£ä¸­å­—æ®µå­˜å‚¨çš„å‘é‡ã€‚

_//ç›¸å…³æ–‡æ¡£åœ°å€_

[_https:_//redis.io/docs/interact/search-and-query/search/vectors__](https://redis.io/docs/interact/search-and-query/search/vectors)

### **1ã€RedisÂ Searchå®‰è£…**

å…³äºRedisÂ Searchçš„å®‰è£…å’Œä½¿ç”¨ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ï¼Œå¦‚æœæ‚¨å¯¹æ­¤ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« ï¼š

C#+RedisÂ Searchï¼šå¦‚ä½•ç”¨Rediså®ç°é«˜æ€§èƒ½å…¨æ–‡æœç´¢

### **2ã€åˆ›å»ºå‘é‡ç´¢å¼•åº“**

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨NRedisStackå’ŒStackExchange.Redisä¸¤ä¸ªåº“æ¥ä¸Redisè¿›è¡Œäº¤äº’æ“ä½œã€‚

//åˆ›å»ºä¸€ä¸ªRedisè¿æ¥
static ConnectionMultiplexer mux = ConnectionMultiplexer.Connect("localhost");
//è·å–ä¸€ä¸ªRedisæ•°æ®åº“
static IDatabase db = mux.GetDatabase();
//åˆ›å»ºä¸€ä¸ªRediSearchå®¢æˆ·ç«¯
static SearchCommands ft = new SearchCommands(db, null);

åœ¨è¿›è¡Œå‘é‡æœç´¢ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰å¹¶åˆ›å»ºç´¢å¼•ï¼Œå¹¶æŒ‡å®šç›¸ä¼¼æ€§ç®—æ³•ã€‚

public static async Task CreateIndexAsync()
{
    await ft.CreateAsync(indexName,
        new FTCreateParams()
                    .On(IndexDataType.HASH)
                    .Prefix(prefix),
        new Schema()
                    .AddTagField("tag")
                    .AddTextField("content")
                    .AddVectorField("vector",
                        VectorField.VectorAlgo.HNSW,
                        new Dictionary<string, object\>()
                        {
                            \["TYPE"\] = "FLOAT32",
                            \["DIM"\] = 2,
                            \["DISTANCE\_METRIC"\] = "COSINE"
                        }));
}

è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼š

*   ä½¿ç”¨äº†ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•Â ft.CreateAsyncÂ æ¥åˆ›å»ºç´¢å¼•ã€‚å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼šç´¢å¼•åç§°Â indexNameï¼Œä¸€ä¸ªÂ FTCreateParamsÂ å¯¹è±¡å’Œä¸€ä¸ªÂ SchemaÂ å¯¹è±¡ï¼›
*   FTCreateParamsÂ ç±»æä¾›äº†ä¸€äº›å‚æ•°é€‰é¡¹ï¼Œç”¨äºæŒ‡å®šç´¢å¼•çš„å‚æ•°ã€‚è¿™é‡Œä½¿ç”¨Â .On(IndexDataType.HASH)Â Â æ–¹æ³•æ¥æŒ‡å®šç´¢å¼•æ•°æ®ç±»å‹ä¸ºå“ˆå¸Œï¼Œå¹¶ä½¿ç”¨Â .Prefix(prefix)Â Â æ–¹æ³•æ¥æŒ‡å®šç´¢å¼•æ•°æ®çš„å‰ç¼€ï¼›
*   SchemaÂ ç±»ç”¨äºå®šä¹‰ç´¢å¼•ä¸­çš„å­—æ®µå’Œå­—æ®µç±»å‹ã€‚è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæ ‡ç­¾å­—æ®µï¼ˆtagÂ fieldï¼‰ç”¨äºåŒºåˆ†è¿‡è™‘æ•°æ®ã€‚å®šä¹‰äº†ä¸€ä¸ªæ–‡æœ¬å­—æ®µï¼ˆtextÂ fieldï¼‰ç”¨äºå­˜å‚¨åŸå§‹æ•°æ®ï¼Œä»¥åŠä¸€ä¸ªå‘é‡å­—æ®µï¼ˆvectorÂ fieldï¼‰ç”¨äºå­˜å‚¨ç»åŸå§‹æ•°æ®è½¬åŒ–åçš„å‘é‡æ•°æ®ï¼›
*   ä½¿ç”¨äº†Â VectorField.VectorAlgo.HNSWÂ æ¥æŒ‡å®šå‘é‡ç®—æ³•ä¸ºÂ HNSWï¼ˆHierarchicalÂ NavigableÂ SmallÂ Worldï¼‰ã€‚è¿˜ä¼ é€’äº†ä¸€ä¸ªå­—å…¸å¯¹è±¡ï¼Œç”¨äºè®¾ç½®å‘é‡å­—æ®µçš„å‚æ•°ã€‚å…¶ä¸­ï¼Œé”®ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œå€¼ä¸ºå¯¹è±¡ç±»å‹ã€‚

#### ç›®å‰Redisæ”¯æŒä¸¤ç§ç›¸ä¼¼åº¦ç®—æ³•ï¼š

HNSWåˆ†å±‚å¯¼èˆªå°ä¸–ç•Œç®—æ³•ï¼Œä½¿ç”¨å°ä¸–ç•Œç½‘ç»œæ„å»ºç´¢å¼•ï¼Œå…·æœ‰å¿«é€ŸæŸ¥è¯¢é€Ÿåº¦å’Œå°å†…å­˜å ç”¨ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(logn)ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡ç´¢å¼•ã€‚

FLATæš´åŠ›ç®—æ³•ï¼Œå®ƒå¯¹æ‰€æœ‰çš„é”®å€¼å¯¹è¿›è¡Œæ‰«æï¼Œç„¶åæ ¹æ®é”®å€¼å¯¹çš„è·ç¦»è®¡ç®—å‡ºæœ€çŸ­è·¯å¾„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œå…¶ä¸­næ˜¯é”®å€¼å¯¹çš„æ•°é‡ã€‚è¿™ç§ç®—æ³•æ—¶é—´å¤æ‚åº¦éå¸¸é«˜ï¼Œåªé€‚ç”¨äºå°è§„æ¨¡çš„ç´¢å¼•ã€‚

### **3ã€æ·»åŠ å‘é‡åˆ°ç´¢å¼•åº“**

ç´¢å¼•åˆ›å»ºåï¼Œæˆ‘ä»¬å°†æ•°æ®æ·»åŠ åˆ°ç´¢å¼•ä¸­ã€‚

public async Task SetAsync(string docId, string prefix, string tag, string content, float\[\] vector)
{
    await db.HashSetAsync($"{prefix}{docId}", new HashEntry\[\] {
        new HashEntry ("tag", tag),
        new HashEntry ("content", content),
        new HashEntry ("vector", vector.SelectMany(BitConverter.GetBytes).ToArray())
    });
}

SetAsyncæ–¹æ³•ç”¨äºå°†ä¸€ä¸ªå…·æœ‰æŒ‡å®šæ–‡æ¡£IDã€å‰ç¼€ã€æ ‡ç­¾ã€å†…å®¹åŠå†…å®¹çš„å‘é‡å­˜å‚¨åˆ°ç´¢å¼•åº“ä¸­ã€‚å¹¶ä½¿ç”¨SelectMany()æ–¹æ³•å’ŒBitConverter.GetBytes()æ–¹æ³•å°†å‘é‡è½¬æ¢ä¸ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚

### **4ã€å‘é‡æœç´¢**

RedisÂ æ”¯æŒä¸¤ç§ç±»å‹çš„å‘é‡æŸ¥è¯¢ï¼šKNNæŸ¥è¯¢å’ŒRangeæŸ¥è¯¢ï¼Œä¹Ÿå¯ä»¥å°†ä¸¤ç§æŸ¥è¯¢æ··åˆä½¿ç”¨ã€‚

#### **KNNÂ æŸ¥è¯¢**

KNNÂ æŸ¥è¯¢ç”¨äºåœ¨ç»™å®šæŸ¥è¯¢å‘é‡çš„æƒ…å†µä¸‹æŸ¥æ‰¾å‰Â NÂ ä¸ªæœ€ç›¸ä¼¼çš„å‘é‡ã€‚

public async IAsyncEnumerable<(string Content, double Score)> SearchAsync(float\[\] vector, int limit)
{
    var query = new Query($"\*=>\[KNN {limit} @vector $vector AS score\]")
                .AddParam("vector", vector.SelectMany(BitConverter.GetBytes).ToArray())
                .SetSortBy("score")
                .ReturnFields("content", "score")
                .Limit(0, limit)
                .Dialect(2);

    var result = await ft.SearchAsync(indexName, query).ConfigureAwait(false);
    foreach (var document in result.Documents)
    {
        yield return (document\["content"\],Convert.ToDouble(document\["score"\]));
    }
}

è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼š

*   åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å¯¹è±¡Â queryï¼Œå¹¶è®¾ç½®æŸ¥è¯¢æ¡ä»¶ã€‚æŸ¥è¯¢æ¡ä»¶åŒ…æ‹¬ï¼š
    1.  "\*=>\[KNNÂ {limit}Â @vectorÂ $vectorÂ ASÂ score\]"ï¼šä½¿ç”¨KNNç®—æ³•è¿›è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼Œé™åˆ¶ç»“æœæ•°é‡ä¸ºlimitï¼Œä½¿ç”¨ç»™å®šçš„å‘é‡vectorä½œä¸ºæŸ¥è¯¢å‘é‡ï¼Œå°†æŸ¥è¯¢ç»“æœæŒ‰ç…§ç›¸ä¼¼åº¦å¾—åˆ†è¿›è¡Œæ’åºï¼›
    2.  AddParam("vector",Â vector.SelectMany(BitConverter.GetBytes).ToArray())ï¼šå°†æµ®ç‚¹æ•°æ•°ç»„è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ï¼Œå¹¶å°†å…¶ä½œä¸ºæŸ¥è¯¢å‚æ•°ä¼ é€’ç»™æŸ¥è¯¢ï¼›
    3.  SetSortBy("score")ï¼šæŒ‰ç…§ç›¸ä¼¼åº¦å¾—åˆ†å¯¹ç»“æœè¿›è¡Œæ’åºï¼›
    4.  ReturnFields("content",Â "score")ï¼šå°†contentå’Œscoreä¸¤ä¸ªå­—æ®µä»ç»“æœé›†ä¸­è¿”å›ï¼›
    5.  Limit(0,Â limit)ï¼šé™åˆ¶ç»“æœé›†çš„èµ·å§‹ä½ç½®ä¸º0ï¼Œç»“æœæ•°é‡ä¸ºlimitï¼›
    6.  Dialect(2)ï¼šè®¾ç½®æŸ¥è¯¢æ–¹è¨€ä¸º2ï¼Œå³Redisé»˜è®¤çš„æŸ¥è¯¢è¯­è¨€RedisÂ Protocolï¼›
*   è°ƒç”¨å¼‚æ­¥æœç´¢æ–¹æ³•Â ft.SearchAsync(indexName,Â query)ï¼Œå¹¶ç­‰å¾…æœç´¢ç»“æœï¼›
*   éå†æœç´¢ç»“æœé›†Â result.Documentsï¼Œå°†æ¯ä¸ªæ–‡æ¡£è½¬æ¢ä¸ºÂ (stringÂ Content,Â doubleÂ Score)Â å…ƒç»„ï¼Œå¹¶é€šè¿‡Â yieldÂ è¯­å¥è¿›è¡Œè¿­ä»£è¿”å›ã€‚

#### **RangeÂ æŸ¥è¯¢ï¼š**

RangeæŸ¥è¯¢æä¾›äº†ä¸€ç§æ ¹æ®Â RedisÂ ä¸­çš„å‘é‡å­—æ®µä¸åŸºäºæŸäº›é¢„å®šä¹‰é˜ˆå€¼ï¼ˆåŠå¾„ï¼‰çš„æŸ¥è¯¢å‘é‡ä¹‹é—´çš„è·ç¦»æ¥è¿‡æ»¤ç»“æœçš„æ–¹æ³•ã€‚ç±»ä¼¼äºÂ NUMERICÂ å’ŒÂ GEOÂ å­å¥ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢ä¸­å¤šæ¬¡å‡ºç°ï¼Œç‰¹åˆ«æ˜¯å¯ä»¥å’ŒÂ KNNÂ è¿›è¡Œæ··åˆæœç´¢ã€‚

public static async IAsyncEnumerable<(string Tag, string Content, double Score)> SearchAsync(string tag, float\[\] vector, int limit)
{
    var query = new Query($"(@tag:{tag})=>\[KNN {limit} @vector $vector AS score\]")
                .AddParam("vector", vector.SelectMany(BitConverter.GetBytes).ToArray())
                .SetSortBy("score")
                .ReturnFields("tag", "content", "score")
                .Limit(0, limit)
                .Dialect(2);

    var result = await ft.SearchAsync(indexName, query).ConfigureAwait(false);
    foreach (var document in result.Documents)
    {
        yield return (document\["tag"\], document\["content"\], Convert.ToDouble(document\["score"\]));
    }
}

è¿™æ®µä»£ç ä½¿ç”¨äº†KNNå’ŒRangeæ··åˆæŸ¥è¯¢ï¼Œä¸ä¸Šä¸€æ®µä»£ç ç›¸æ¯”ï¼Œæ–°å¢äº†@tagå‚æ•°ï¼Œå°†é™åˆ¶ç»“æœä»…åŒ…å«ç»™å®šæ ‡ç­¾çš„å†…å®¹ã€‚è¿™æ ·åšå¯ä»¥å¢åŠ æŸ¥è¯¢çš„å‡†ç¡®æ€§ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

### **5ã€ä»ç´¢å¼•åº“ä¸­åˆ é™¤å‘é‡**

public async Task DeleteAsync(string docId, string prefix)
{
    await db.KeyDeleteAsync($"{prefix}{docId}");
}

è¿™ä¸ªæ–¹æ³•é€šè¿‡åˆ é™¤ä¸æŒ‡å®šå‘é‡ç›¸å…³è”çš„å“ˆå¸Œç¼“å­˜é”®ï¼Œæ¥å®ç°ä»ç´¢å¼•åº“ä¸­åˆ é™¤æŒ‡å®šå‘é‡æ•°æ®ã€‚

### **6ã€åˆ é™¤å‘é‡ç´¢å¼•åº“**

public async Task DropIndexAsync()
{
    await ft.DropIndexAsync(indexName, true);
}

è¿™ä¸ªæ–¹æ³•Â awaitÂ ft.DropIndexAsyncæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šÂ indexNameÂ å’ŒÂ trueÂ ã€‚indexNameÂ è¡¨ç¤ºç´¢å¼•åº“çš„åç§°ï¼ŒÂ trueÂ è¡¨ç¤ºåœ¨åˆ é™¤ç´¢å¼•æ—¶æ˜¯å¦åˆ é™¤ç´¢å¼•æ–‡ä»¶ã€‚

### **7ã€æŸ¥è¯¢ç´¢å¼•åº“ä¿¡æ¯**

public async Task<InfoResult> InfoAsync()
{
    return await ft.InfoAsync(indexName);
}

é€šè¿‡Â awaitÂ ft.InfoAsync(indexName)Â æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°æŒ‡å®šç´¢å¼•åº“çš„å¤§å°ï¼Œæ–‡æ¡£æ•°é‡ç­‰ç›¸å…³ç´¢å¼•åº“ä¿¡æ¯ã€‚

å®Œæ•´Â DemoÂ å¦‚ä¸‹ï¼š

using NRedisStack;
using NRedisStack.Search;
using NRedisStack.Search.DataTypes;
using NRedisStack.Search.Literals.Enums;
using StackExchange.Redis;
using static NRedisStack.Search.Schema;

namespace RedisVectorExample
{
    class Program
    {
        //åˆ›å»ºä¸€ä¸ªRedisè¿æ¥
        static ConnectionMultiplexer mux = ConnectionMultiplexer.Connect("localhost");
        //è·å–ä¸€ä¸ªRedisæ•°æ®åº“
        static IDatabase db = mux.GetDatabase();
        //åˆ›å»ºä¸€ä¸ªRediSearchå®¢æˆ·ç«¯
        static SearchCommands ft = new SearchCommands(db, null);
        //ç´¢å¼•åç§°
        static string indexName = "test:index";
        //ç´¢å¼•å‰ç¼€
        static string prefix = "test:data";
        static async Task Main(string\[\] args)
        {  
            //åˆ›å»ºä¸€ä¸ªå‘é‡çš„ç´¢å¼•
            await CreateIndexAsync();

            //æ·»åŠ ä¸€äº›å‘é‡åˆ°ç´¢å¼•ä¸­
            await SetAsync("1", "A", "æµ‹è¯•æ•°æ®A1", new float\[\] { 0.1f, 0.2f });
            await SetAsync("2", "A", "æµ‹è¯•æ•°æ®A2", new float\[\] { 0.3f, 0.4f });
            await SetAsync("3", "B", "æµ‹è¯•æ•°æ®B1", new float\[\] { 0.5f, 0.6f });
            await SetAsync("4", "C", "æµ‹è¯•æ•°æ®C1", new float\[\] { 0.7f, 0.8f });

            //åˆ é™¤ä¸€ä¸ªå‘é‡
            await DeleteAsync("4");

            //KUNæœç´¢ 
            await foreach (var (Content, Score) in SearchAsync(new float\[\] { 0.1f, 0.2f }, 2))
            {
                Console.WriteLine($"å†…å®¹ï¼š{Content}ï¼Œç›¸ä¼¼åº¦å¾—åˆ†ï¼š{Score}");
            }

            //æ··åˆ
            await foreach (var (Tag, Content, Score) in SearchAsync("A", new float\[\] { 0.1f, 0.2f }, 2))
            {
                Console.WriteLine($"æ ‡ç­¾ï¼š{Tag}ï¼Œå†…å®¹ï¼š{Content}ï¼Œç›¸ä¼¼åº¦å¾—åˆ†ï¼š{Score}");
            }
            
            //æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
            var info = await InfoAsync();
            if (info != null)
                await DropIndexAsync(); //å­˜åœ¨åˆ™åˆ é™¤ç´¢å¼•
        }

        public static async Task CreateIndexAsync()
        {
            await ft.CreateAsync(indexName,
                new FTCreateParams()
                            .On(IndexDataType.HASH)
                            .Prefix(prefix),
                new Schema()
                            .AddTagField("tag")
                            .AddTextField("content")
                            .AddVectorField("vector",
                                VectorField.VectorAlgo.HNSW,
                                new Dictionary<string, object\>()
                                {
                                    \["TYPE"\] = "FLOAT32",
                                    \["DIM"\] = 2,
                                    \["DISTANCE\_METRIC"\] = "COSINE"
                                }));
        }

        public static async Task SetAsync(string docId, string tag, string content, float\[\] vector)
        {
            await db.HashSetAsync($"{prefix}{docId}", new HashEntry\[\] {
                new HashEntry ("tag", tag),
                new HashEntry ("content", content),
                new HashEntry ("vector", vector.SelectMany(BitConverter.GetBytes).ToArray())
            });
        }

        public static async Task DeleteAsync(string docId)
        {
            await db.KeyDeleteAsync($"{prefix}{docId}");
        }

        public static async Task DropIndexAsync()
        {
            await ft.DropIndexAsync(indexName, true);
        }

        public static async Task<InfoResult> InfoAsync()
        {
            return await ft.InfoAsync(indexName);
        }

        public static async IAsyncEnumerable<(string Content, double Score)> SearchAsync(float\[\] vector, int limit)
        {
            var query = new Query($"\*=>\[KNN {limit} @vector $vector AS score\]")
                        .AddParam("vector", vector.SelectMany(BitConverter.GetBytes).ToArray())
                        .SetSortBy("score")
                        .ReturnFields("content", "score")
                        .Limit(0, limit)
                        .Dialect(2);

            var result = await ft.SearchAsync(indexName, query).ConfigureAwait(false);
            foreach (var document in result.Documents)
            {
                yield return (document\["content"\], Convert.ToDouble(document\["score"\]));
            }
        }

        public static async IAsyncEnumerable<(string Tag, string Content, double Score)> SearchAsync(string tag, float\[\] vector, int limit)
        {
            var query = new Query($"(@tag:{tag})=>\[KNN {limit} @vector $vector AS score\]")
                        .AddParam("vector", vector.SelectMany(BitConverter.GetBytes).ToArray())
                        .SetSortBy("score")
                        .ReturnFields("tag", "content", "score")
                        .Limit(0, limit)
                        .Dialect(2);

            var result = await ft.SearchAsync(indexName, query).ConfigureAwait(false);
            foreach (var document in result.Documents)
            {
                yield return (document\["tag"\], document\["content"\], Convert.ToDouble(document\["score"\]));
            }
        }
    }
}

ç¯‡å¹…åŸå› å…ˆåˆ°è¿™é‡Œï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥ç€æ¢è®¨å¦‚ä½•åˆ©ç”¨ChatGPTÂ EmbeddingsæŠ€æœ¯æå–æ–‡æœ¬å‘é‡ï¼Œå¹¶åŸºäºRediså®ç°æ–‡æœ¬ç›¸ä¼¼åº¦åŒ¹é…ã€‚ç›¸æ¯”ä¼ ç»Ÿæ–¹æ³•ï¼Œè¿™ç§æ–¹å¼èƒ½å¤Ÿæ›´å¥½åœ°ä¿ç•™æ–‡æœ¬çš„è¯­ä¹‰å’Œæƒ…æ„Ÿä¿¡æ¯ï¼Œä»è€Œæ›´å‡†ç¡®åœ°åæ˜ æ–‡æœ¬çš„å®è´¨æ€§å†…å®¹ã€‚

ğŸ‘‡æ„Ÿè°¢é˜…è¯»ï¼Œç‚¹èµ+åˆ†äº«+æ”¶è—+å…³æ³¨ğŸ‘‡

![](https://img2023.cnblogs.com/blog/49399/202307/49399-20230728204833723-1692358371.png)

æ–‡ç« å‡ºè‡ªçŒ¿æƒ‘è±å¾®ä¿¡å…¬ä¼—å·