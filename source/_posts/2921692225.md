---
layout: post
title: "è®¾è®¡ C++ æ¥å£æ–‡ä»¶çš„å°æŠ€å·§ä¹‹ PIMPL"
date: "2023-06-18T01:24:06.756Z"
---
è®¾è®¡ C++ æ¥å£æ–‡ä»¶çš„å°æŠ€å·§ä¹‹ PIMPL
======================

C++ é‡Œé¢æœ‰ä¸€äº›æƒ¯ç”¨æ³•ï¼ˆidiomsï¼‰ï¼Œå¦‚ RAIIï¼ŒPIMPLï¼Œcopy-swapã€CRTPã€SFINAE ç­‰ã€‚ä»Šå¤©è¦è¯´çš„æ˜¯ PIMPLï¼Œå³ Pointer To Implementationï¼ŒæŒ‡å‘å®ç°çš„æŒ‡é’ˆã€‚

é—®é¢˜æè¿°
----

åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œç»å¸¸éœ€è¦å®šä¹‰å’Œç¬¬ä¸‰æ–¹/ä¾›åº”å•†çš„ C++ æ¥å£ã€‚å‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªæ¥å£æ–‡ä»¶ï¼š

MyInterface.h

    #include <string>
    #include <list>
    #include "dds.h"
    
    class MyInterface {
       public:
        int publicApi1();
        int publicApi2();
    
       private:
        int privateMethod1();
        int privateMethod2();
        int privateMethod3();
    
       private:
        std::string name_;
        std::list<int> list_;
        DDSDomainPariciant dp_;
        DDSTopic topic_;
        DDSDataWriter dw_;
    };
    

è¯¥æ¥å£å¤´æ–‡ä»¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

*   **æš´éœ²äº† MyInterface å†…éƒ¨å®ç°**ã€‚æ‰€æœ‰çš„ private/protected çš„æ–¹æ³•ã€æˆå‘˜å˜é‡éƒ½æš´éœ²ç»™æ¥å£çš„ä½¿ç”¨è€…
*   ç”±æ­¤å¸¦æ¥çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯**æ¥å£ä¸ç¨³å®š**ã€‚å‡å¦‚æˆ‘ä»¬ä¿®æ”¹ç±»çš„å†…éƒ¨å®ç°ï¼Œå³ä½¿ä¸æ”¹å˜ public æ¥å£ï¼Œæ¥å£çš„ä½¿ç”¨è€…ä¹Ÿéœ€è¦è·Ÿç€æ›´æ–°å¤´æ–‡ä»¶ï¼š
    *   æ¯”å¦‚ list\_ æˆå‘˜ä¹‹å‰ç”¨çš„æ˜¯ std::list å®¹å™¨ï¼Œç°åœ¨æ‰“ç®—æ”¹ç”¨ std::vector å®¹å™¨
    *   å†æ¯”å¦‚ï¼Œä¹‹å‰æœ‰ 3 ä¸ª private æ–¹æ³•ï¼Œç°åœ¨é‡æ„å®ç°éƒ¨åˆ†ï¼Œæ‹†æˆæ›´å¤šçš„å°å‡½æ•°
*   **å¢åŠ äº†ä½¿ç”¨è€…çš„ä¾èµ–**ã€‚æ¥å£çš„ä½¿ç”¨è€…æƒ³è¦ä½¿ç”¨ä¸Šè¿°å¤´æ–‡ä»¶ï¼Œå¿…é¡»è¦ #include "dds.h" è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œ "dds.h" é€šå¸¸åˆä¼š #include å¾ˆå¤šå…¶ä»–æ–‡ä»¶ã€‚æœ€ç»ˆçš„ç»“æœå¾€å¾€æ˜¯è¦å‘æ¥å£çš„ä½¿ç”¨è€…æä¾›å¾ˆå¤šé¢å¤–çš„å¤´æ–‡ä»¶ã€‚å¦‚æœå°†æ¥é‡æ„ï¼Œä¸ç”¨ DDSï¼Œæ”¹ç”¨ SOME/IP æˆ–å…¶ä»–ä¸­é—´ä»¶ï¼Œæ¥å£çš„ä½¿ç”¨è€…ä¹Ÿè¦è·Ÿç€æ”¹å˜ã€‚ä¸ä»…å¦‚æ­¤ï¼Œä¸º private æˆå‘˜è€Œé¢å¤– #include çš„å¤´æ–‡ä»¶ä¹Ÿä¼šå¢åŠ ç¼–è¯‘æ—¶é—´

è§£å†³æ–¹æ¡ˆ â€”â€” PIMPL
-------------

PIMPL å°±æ˜¯ C++ é‡Œä¸“é—¨ç”¨æ¥è§£å†³è¿™äº›é—®é¢˜çš„æƒ¯ç”¨æ³•ã€‚**PIMPL å°† MyInterface ç±»çš„å…·ä½“å®ç°ï¼ˆprivate/protected æ–¹æ³•ã€æˆå‘˜ï¼‰è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªåµŒå¥—ç±» Impl ä¸­ï¼Œç„¶ååˆ©ç”¨å‰å‘å£°æ˜ï¼ˆforward declarationï¼‰å£°æ˜ Implï¼Œå¹¶åœ¨åŸæœ‰çš„ MyInterface æ¥å£ç±»ä¸­å¢åŠ ä¸€ä¸ªæŒ‡å‘ Impl å¯¹è±¡çš„æŒ‡é’ˆã€‚**å†æ¬¡å¼ºè°ƒï¼Œåœ¨ MyInterface ä¸­çš„ Impl ä»…ä»…æ˜¯ä¸€ä¸ªå‰å‘å£°æ˜ï¼ŒMyInterface ç±»åªçŸ¥é“æœ‰ Impl è¿™ä¹ˆä¸ªç±»ï¼Œä½†æ˜¯å¯¹ Impl æœ‰å“ªäº›æ–¹æ³•ã€å“ªäº›æˆå‘˜å˜é‡ä¸€æ— æ‰€çŸ¥ï¼Œå› æ­¤èƒ½åšçš„äº‹æƒ…éå¸¸æœ‰é™ï¼ˆå£°æ˜ä¸€ä¸ªæŒ‡å‘è¯¥ç±»çš„æŒ‡é’ˆå°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼‰ã€‚è€Œè¿™æ°æ°å°±æ˜¯ PIMPL å°†æ¥å£å’Œå®ç°è§£è€¦çš„å…³é”®æ‰€åœ¨ã€‚

åº”ç”¨ PIMPL åçš„ MyInterface.h æ–‡ä»¶ï¼š

    class MyInterface {
       public:
        MyInterface();
        ~MyInterface();
        
        int publicApi1();
        int publicApi2();
    
       private:
        struct Impl;
        Impl* impl_;
    };
    

ç°åœ¨ MyInterface.h æ¥å£æ–‡ä»¶å˜å¾—éå¸¸æ¸…çˆ½ã€‚åŸæœ¬åœ¨ MyInterface.h ä¸­çš„é‚£äº›ä¾èµ–ã€å®ç°ç»†èŠ‚ï¼Œç°åœ¨é€šé€šè½¬ç§»åˆ°äº† MyInterface.cpp å†…éƒ¨ï¼Œ**å¯¹æ¥å£çš„ä½¿ç”¨è€…å½»åº•éšè—ï¼Œé™ä½ä½¿ç”¨è€…çš„ä¾èµ–ï¼Œæé«˜æ¥å£ç¨³å®šæ€§**ï¼š

MyInterface.cpp

    #include <string>
    #include <list>
    #include "dds.h"
    
    struct MyInterface::Impl {
        int publicApi1();
        int publicApi2(int i);
    
        int privateMethod1();
        int privateMethod2();
        int privateMethod3();
    
        std::string name_;
        std::list<int> list_;
        DDSDomainPariciant dp_;
        DDSTopic topic_;
        DDSDataWriter dw_;
    };
    
    MyInterface::MyInterface() 
        : pimpl_(new Impl()) {}
    
    MyInterface::~MyInterface() {
        delete pimpl_;
    }
    
    int MyInterface::publicApi1() {
        impl_->publicApi1();
    }
    int MyInterface::publicApi2(int i) {
        impl_->publicApi2(i);
    }
    
    // å…¶ä»– MyInterface::Impl ç±»çš„æ–¹æ³•å®ç°
    // åŸæœ¬ MyInterface ä¸­çš„é€»è¾‘æŒªåˆ° MyInterface::Impl ä¸­
    int MyInterface::Impl::publicApi1() {...}
    

å¯ä»¥çœ‹åˆ°ï¼ŒMyInterface ç±»çš„å®ç°æœ¬èº«åªæ˜¯å•çº¯åœ°å°†è¯·æ±‚å§”æ‰˜/è½¬å‘ç»™ MyInterface::Impl çš„åŒåæ–¹æ³•ã€‚å¯¹äºå‚æ•°çš„ä¼ é€’ï¼Œä¹Ÿå¯ä»¥é€‚å½“ä½¿ç”¨ std::move æå‡æ•ˆç‡ï¼ˆå…³äº std::move ä»Šåä¹Ÿå¯ä»¥å±•å¼€è¯´è¯´ï¼‰ã€‚

ä¹Ÿå¯ä»¥æŠŠåµŒå¥—ç±» MyInterface::Impl æ”¾åˆ°å•ç‹¬ MyInterfaceImpl.h/cpp ä¸­ï¼Œå¦‚æ­¤ä¸€æ¥ MyInterface.cpp å°±ä¼šå˜å¾—éå¸¸ç®€æ´ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š

MyInterface.cpp

    #include "MyInterface.h"
    #include "MyInterfaceImpl.h"
    
    MyInterface::MyInterface() 
        : pimpl_(new Impl()) {}
    
    MyInterface::~MyInterface() {
        delete pimpl_;
    }
    
    int MyInterface::publicApi1() {
        return impl_->publicApi1();
    }
    
    int MyInterface::publicApi2(int i) {
        return impl_->publicApi2(i);
    }
    

MyInterfaceImpl.h

    #include <string>
    #include <list>
    #include "dds.h"
    
    struct MyInterface::Impl {
        int publicApi1();
        int publicApi2(int i);
    
        int privateMethod1();
        int privateMethod2();
        int privateMethod3();
    
        std::string name_;
        std::list<int> list_;
        DDSDomainPariciant dp_;
        DDSTopic topic_;
        DDSDataWriter dw_;
    };
    

MyInterfaceImpl.cpp

    #include "MyInterfaceImpl.h"
    
    int MyInterface::Impl::publicApi1() {
        // ...
    }
    
    // å…¶ä»– MyInterface::Impl ç±»çš„æ–¹æ³•å®ç°
    

æ³¨æ„ä¸è¦åœ¨ MyInterface.h ä¸­ #include "MyInterfaceImpl.h"ï¼Œå¦åˆ™å°±å‰åŠŸå°½å¼ƒäº†ã€‚

ç°ä»£ C++ ä¸­çš„ PIMPL
---------------

ä»¥ä¸Šæ˜¯ä¼ ç»Ÿ C++ ä¸­çš„ PIMPL çš„å®ç°ï¼Œç°ä»£ C++ åº”å°½é‡é¿å…ä½¿ç”¨è£¸æŒ‡é’ˆï¼Œè€Œä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆã€‚å…·ä½“çš„åŸå› è§è¿™ç¯‡æ–‡ç« ã€Œ[è£¸æŒ‡é’ˆä¸ƒå®—ç½ª](https://www.cnblogs.com/tengzijian/p/16209803.html)ã€ã€‚

Impl å¯¹è±¡çš„æ‰€æœ‰æƒåº”è¯¥æ˜¯ MyInterface ç‹¬æœ‰ ï¼Œunique\_ptr æ˜¯åˆæƒ…åˆç†çš„é€‰æ‹©ã€‚å¦‚æœç›´æ¥å°†ä¸Šè¿°çš„è£¸æŒ‡é’ˆæ›¿æ¢æˆ unique\_ptrï¼š

    #include <memory>
    
    class MyInterface {
       public:
        MyInterface();
        int publicApi1();
        int publicApi2();
    
       private:
        struct Impl;
        std::unique_ptr<Impl> impl_;
    };
    
    // main.cpp
    int main() {
        MyInterface if;
    }
    

ä¼šçœ‹åˆ°è¿™æ ·çš„æŠ¥é”™ï¼š

    /opt/compiler-explorer/gcc-13.1.0/include/c++/13.1.0/bits/unique_ptr.h: In instantiation of 'constexpr void std::default_delete<_Tp>::operator()(_Tp*) const [with _Tp = MyInterface::Impl]':
    /opt/compiler-explorer/gcc-13.1.0/include/c++/13.1.0/bits/unique_ptr.h:404:17:   required from 'constexpr std::unique_ptr<_Tp, _Dp>::~unique_ptr() [with _Tp = MyInterface::Impl; _Dp = std::default_delete<MyInterface::Impl>]'
    <source>:118:7:   required from here
    /opt/compiler-explorer/gcc-13.1.0/include/c++/13.1.0/bits/unique_ptr.h:97:23: error: invalid application of 'sizeof' to incomplete type 'MyInterface::Impl'
       97 |         static_assert(sizeof(_Tp)>0,
          |                       ^~~~~~~~~~~
    

é—®é¢˜å‡ºåœ¨å“ªé‡Œå‘¢ï¼Ÿ

é—®é¢˜å°±å‡ºåœ¨ MyInterface çš„ææ„å‡½æ•°ã€‚åœ¨æ²¡æœ‰æ˜¾å¼å£°æ˜ææ„å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆæˆä¸€ä¸ªéšå¼å†…è”çš„ææ„å‡½æ•°ï¼ˆç¼–è¯‘å™¨åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹ï¼Œè‡ªåŠ¨åˆæˆå“ªäº›å‡½æ•°ä¹Ÿæœ‰ä¸å°‘å­¦é—®ï¼Œåé¢ä¼šå•ç‹¬å‘ä¸€ç¯‡ï¼‰ï¼Œç­‰æ•ˆä»£ç å¦‚ä¸‹ï¼š

    class MyInterface {
       public:
        MyInterface();
        ~MyInterface(){} // æ˜¯å®ç°ï¼Œä¸æ˜¯å£°æ˜ï¼
        int publicApi1();
        int publicApi2();
    
       private:
        struct Impl;
        std::unique_ptr<Impl> impl_;
    };
    

åœ¨ MyInterface.h ä¸­ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨åˆæˆçš„ææ„å‡½æ•°ä¼šè¿›è¡Œä»¥ä¸‹æ“ä½œï¼š

1.  æ‰§è¡Œç©ºçš„ææ„å‡½æ•°ä½“
2.  æŒ‰ç…§æ„é€ çš„ç›¸åé¡ºåºï¼Œä¾æ¬¡é”€æ¯ MyInterface çš„æˆå‘˜
3.  é”€æ¯ `unique_ptr<Impl> impl_` æˆå‘˜
4.  è°ƒç”¨ unique\_ptr çš„ææ„å‡½æ•°
5.  unique\_ptr çš„ææ„å‡½æ•°è°ƒç”¨é»˜è®¤çš„åˆ é™¤å™¨ï¼ˆdeleteï¼‰ï¼Œåˆ é™¤æŒ‡å‘çš„ Impl å¯¹è±¡

æˆ‘ä»¬æ‰€çœ‹åˆ°æŠ¥é”™ï¼Œå°±å‡ºåœ¨ç¬¬ 5 æ­¥ã€‚unique\_ptr çš„å®ç°ä»£ç åœ¨åˆ é™¤å‰ï¼Œä¼šè¿›è¡Œ `static_assert(sizeof(_Tp)>0` æ–­è¨€ï¼Œè€Œç¼–è¯‘å™¨æ‰§è¡Œè¯¥æ–­è¨€çš„æ—¶å€™ï¼ŒImpl è¿˜æ˜¯ä¸€ä¸ªä¸å®Œæ•´ç±»å‹ï¼ˆIncomplete Typeï¼‰ã€‚å› ä¸ºç¼–è¯‘å™¨æ­¤æ—¶åªçœ‹åˆ°äº† MyInterface::Impl çš„å‰å‘å£°æ˜ï¼Œè¿˜æ²¡æœ‰çœ‹åˆ°å®šä¹‰ï¼Œä¸çŸ¥é“ Impl æœ‰å“ªäº›æˆå‘˜ï¼Œä¹Ÿä¸çŸ¥ Impl ç±»å ç”¨å¤šå¤§å†…å­˜ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œ sizeof(Impl) çš„æ—¶å€™æŠ¥é”™ã€‚

çŸ¥é“äº†èƒŒåçš„åŸç†ï¼Œè§£å†³èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä¿è¯åœ¨ MyInterface ææ„å‡½æ•°å®ç°çš„åœ°æ–¹ï¼Œèƒ½çœ‹åˆ° Impl ç±»çš„å®šä¹‰å³å¯ï¼š

MyInterface.h

    #include <memory>
    
    class MyInterface {
       public:
        MyInterface();
        ~MyInterface();  // ä½¿ç”¨ unique_ptr çš„å…³é”®ï¼šåªå£°æ˜ï¼Œä¸å®ç°ï¼
        int publicApi1();
        int publicApi2();
    
       private:
        struct Impl;
        std::unique_ptr<Impl> impl_;
    };
    
    

MyInterface.cpp

    #include <memory>
    #include "MyInterface.h"
    #include "MyInterfaceImpl.h"
    
    MyInterface::MyInterface()
        : pImpl_(std::make_unique<Impl>()) {}
    
    MyInterface::~MyInterface() = default;
    
    int MyInterface::publicApi1() {
        return impl_->publicApi1();
    }
    int MyInterface::publicApi2(int i) {
        return impl_->publicApi2(i);
    }
    

è¿™æ ·ï¼Œä¸€ä¸ªæ­£ç¡®çš„ PIMPL å°±æå®šå•¦ï¼è™½ç„¶ PIMPL å¤šäº†ä¸€å±‚å°è£…ï¼Œç¨å¾®å¢åŠ äº†ä¸€ç‚¹ç‚¹å¤æ‚åº¦ï¼Œä½†æˆ‘è®¤ä¸ºè¿™ä¹ˆåšæ˜¯ç»å¯¹çš„åˆ©å¤§äºå¼Šã€‚ä»¥ä¸€ä¸ªæˆ‘æ›¾å‚ä¸çš„é¡¹ç›®ä¸ºä¾‹ï¼Œåœ¨å°†è¿‘ä¸€å¹´çš„æ—¶é—´é‡Œï¼Œå®ç°åº“æ›´æ–°äº†å¾ˆå¤šç‰ˆï¼Œä½†æ˜¯æ¥å£æ–‡ä»¶ä»é‡Šæ”¾ä»¥æ¥ä¸€ç›´æ²¡å˜è¿‡ï¼Œå¤§å¤§å‡å°‘äº†å’Œç¬¬ä¸‰æ–¹/ä¾›åº”å•†çš„æ²Ÿé€šã€è°ƒè¯•æˆæœ¬ã€‚

æœ€åï¼Œç•™ä¸€ä¸ªæ€è€ƒé¢˜ï¼šä¸ºä»€ä¹ˆå°† unique\_ptr æ¢æˆ shared\_ptr ä¸ä¼šé‡åˆ°ä¸Šé¢çš„ `static_assert(sizeof(_Tp)>0` ç¼–è¯‘é”™è¯¯ï¼Ÿå¦‚æœä½ èƒ½è§£é‡Šå…¶ä¸­çš„åŸå› ï¼Œé‚£è¯´æ˜ä½ å¯¹ shared\_ptrã€unique\_ptr çš„ç†è§£ç›¸å½“æ·±å…¥äº†ğŸ‘

åŸæ–‡åœ°å€ï¼š[https://www.cnblogs.com/tengzijian/p/17473602.html](https://www.cnblogs.com/tengzijian/p/17473602.html)