---
layout: post
title: "k8s实战案例之基于StatefulSet控制器运行MySQL一主多从"
date: "2023-06-16T01:14:57.536Z"
---
k8s实战案例之基于StatefulSet控制器运行MySQL一主多从
===================================

![k8s实战案例之基于StatefulSet控制器运行MySQL一主多从](https://img2023.cnblogs.com/blog/1503305/202306/1503305-20230608000146022-469083139.png) StatefulSet本质上是Deployment的⼀种变体，在v1.9版本中已成为GA版本，它为了解决有状态服务的问题，它所管理的Pod拥有固定的Pod名称，启停顺序，在StatefulSet中，Pod名字称为⽹络标识(hostname)，还必须要⽤到共享存储。在Deployment中，与之对应的服务是service，⽽在StatefulSet中与之对应的headless service，headless service，即⽆头服务，与service的区别就是它没有Cluster IP，解析它的名称时将返回该Headless Service对应的全部Pod的Endpoint列表。

1、前言
====

Pod调度运⾏时，如果应⽤不需要任何稳定的标示、有序的部署、删除和扩展，则应该使⽤⼀组⽆状态副本的控制器来部署应⽤，例如 Deployment 或 ReplicaSet更适合⽆状态服务需求，⽽StatefulSet适合管理所有有状态的服务，⽐如MySQL、MongoDB集群等。

2、StatefulSet控制器运行MySQL一主多从架构图
==============================

![](https://img2023.cnblogs.com/blog/1503305/202306/1503305-20230607234142300-493509305.png)

> StatefulSet本质上是Deployment的⼀种变体，在v1.9版本中已成为GA版本，它为了解决有状态服务的问题，它所管理的Pod拥有固定的Pod名称，启停顺序，在StatefulSet中，Pod名字称为⽹络标识(hostname)，还必须要⽤到共享存储。  
> 在Deployment中，与之对应的服务是service，⽽在StatefulSet中与之对应的headless service，headless service，即⽆头服务，与service的区别就是它没有Cluster IP，解析它的名称时将返回该Headless Service对应的全部Pod的Endpoint列表。

2.1、StatefulSet控制器特点
--------------------

*   给每个pod分配固定且唯⼀的⽹络标识符
*   给每个pod分配固定且持久化的外部存储
*   对pod进⾏有序的部署和扩展
*   对pod进有序的删除和终⽌
*   对pod进有序的⾃动滚动更新

2.2、StatefulSet的组成部分
--------------------

*   Headless Service：⽤来定义Pod⽹络标识( DNS domain)，指的是短的service(丢失了domainname)。
*   StatefulSet：定义具体应⽤，有多少个Pod副本，并为每个Pod定义了⼀个域名。
*   volumeClaimTemplates： 存储卷申请模板，创建PVC，指定pvc名称⼤⼩，将⾃动创建pvc，且pvc必须由存储类供应。

3、在k8s上部署mysql一主多从
==================

3.1、基础镜像准备
----------

### 3.1.1、准备mysql镜像

**下载镜像**

    root@k8s-master01:~# nerdctl pull mysql:5.7.36
    

**修改镜像tag为本地harbor地址**

    root@k8s-master01:~# nerdctl tag mysql:5.7.36 harbor.ik8s.cc/magedu/mysql:5.7.36
    

**上传镜像至本地harbor**

    root@k8s-master01:~# nerdctl push harbor.ik8s.cc/magedu/mysql:5.7.36
    

### 3.1.2、准备xtrabackup镜像

**下载镜像**

    root@k8s-master01:~# nerdctl pull registry.cn-hangzhou.aliyuncs.com/hxpdocker/xtrabackup:1.0
    

**修改镜像tag为本地harbor地址**

    root@k8s-master01:~# nerdctl tag registry.cn-hangzhou.aliyuncs.com/hxpdocker/xtrabackup:1.0 harbor.ik8s.cc/magedu/xtrabackup:1.0
    

**上传镜像至本地harbor**

    root@k8s-master01:~# nerdctl push harbor.ik8s.cc/magedu/xtrabackup:1.0
    

### 3.1.3、验证镜像是否上传至harbor？

![](https://img2023.cnblogs.com/blog/1503305/202306/1503305-20230615163400489-1911815181.png)

3.2、准备pv
--------

### 3.2.1、在nfs服务器上创建数据存储目录

    root@harbor:~# mkdir -pv /data/k8sdata/magedu/mysql-datadir-{1..5}
    mkdir: created directory '/data/k8sdata/magedu/mysql-datadir-1'
    mkdir: created directory '/data/k8sdata/magedu/mysql-datadir-2'
    mkdir: created directory '/data/k8sdata/magedu/mysql-datadir-3'
    mkdir: created directory '/data/k8sdata/magedu/mysql-datadir-4'
    mkdir: created directory '/data/k8sdata/magedu/mysql-datadir-5'
    root@harbor:~# 
    

### 3.2.2、在nfs服务器上导出数据存储目录

    root@harbor:/data/k8sdata/magedu# cat /etc/exports 
    # /etc/exports: the access control list for filesystems which may be exported
    #               to NFS clients.  See exports(5).
    #
    # Example for NFSv2 and NFSv3:
    # /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
    #
    # Example for NFSv4:
    # /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
    # /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
    #
    /data/k8sdata/kuboard *(rw,no_root_squash)
    /data/volumes *(rw,no_root_squash)
    /pod-vol *(rw,no_root_squash)
    /data/k8sdata/myserver *(rw,no_root_squash)
    /data/k8sdata/mysite *(rw,no_root_squash)
    
    /data/k8sdata/magedu/images *(rw,no_root_squash)
    /data/k8sdata/magedu/static *(rw,no_root_squash)
    
    
    /data/k8sdata/magedu/zookeeper-datadir-1 *(rw,no_root_squash)
    /data/k8sdata/magedu/zookeeper-datadir-2 *(rw,no_root_squash)
    /data/k8sdata/magedu/zookeeper-datadir-3 *(rw,no_root_squash)
    
    
    /data/k8sdata/magedu/redis-datadir-1 *(rw,no_root_squash) 
    
    /data/k8sdata/magedu/redis0 *(rw,no_root_squash)
    /data/k8sdata/magedu/redis1 *(rw,no_root_squash)
    /data/k8sdata/magedu/redis2 *(rw,no_root_squash)
    /data/k8sdata/magedu/redis3 *(rw,no_root_squash)
    /data/k8sdata/magedu/redis4 *(rw,no_root_squash)
    /data/k8sdata/magedu/redis5 *(rw,no_root_squash)
    
    
    
    /data/k8sdata/magedu/mysql-datadir-1 *(rw,no_root_squash)
    /data/k8sdata/magedu/mysql-datadir-2 *(rw,no_root_squash)
    /data/k8sdata/magedu/mysql-datadir-3 *(rw,no_root_squash)
    /data/k8sdata/magedu/mysql-datadir-4 *(rw,no_root_squash)
    /data/k8sdata/magedu/mysql-datadir-5 *(rw,no_root_squash)
    root@harbor:/data/k8sdata/magedu# exportfs -av
    exportfs: /etc/exports [1]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/kuboard".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [2]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/volumes".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [3]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/pod-vol".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [4]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/myserver".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [5]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/mysite".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [7]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/images".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [8]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/static".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [11]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/zookeeper-datadir-1".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [12]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/zookeeper-datadir-2".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [13]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/zookeeper-datadir-3".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [16]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/redis-datadir-1".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [18]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/redis0".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [19]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/redis1".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [20]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/redis2".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [21]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/redis3".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [22]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/redis4".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [23]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/redis5".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [27]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/mysql-datadir-1".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [28]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/mysql-datadir-2".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [29]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/mysql-datadir-3".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [30]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/mysql-datadir-4".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exportfs: /etc/exports [31]: Neither 'subtree_check' or 'no_subtree_check' specified for export "*:/data/k8sdata/magedu/mysql-datadir-5".
      Assuming default behaviour ('no_subtree_check').
      NOTE: this default has changed since nfs-utils version 1.0.x
    
    exporting *:/data/k8sdata/magedu/mysql-datadir-5
    exporting *:/data/k8sdata/magedu/mysql-datadir-4
    exporting *:/data/k8sdata/magedu/mysql-datadir-3
    exporting *:/data/k8sdata/magedu/mysql-datadir-2
    exporting *:/data/k8sdata/magedu/mysql-datadir-1
    exporting *:/data/k8sdata/magedu/redis5
    exporting *:/data/k8sdata/magedu/redis4
    exporting *:/data/k8sdata/magedu/redis3
    exporting *:/data/k8sdata/magedu/redis2
    exporting *:/data/k8sdata/magedu/redis1
    exporting *:/data/k8sdata/magedu/redis0
    exporting *:/data/k8sdata/magedu/redis-datadir-1
    exporting *:/data/k8sdata/magedu/zookeeper-datadir-3
    exporting *:/data/k8sdata/magedu/zookeeper-datadir-2
    exporting *:/data/k8sdata/magedu/zookeeper-datadir-1
    exporting *:/data/k8sdata/magedu/static
    exporting *:/data/k8sdata/magedu/images
    exporting *:/data/k8sdata/mysite
    exporting *:/data/k8sdata/myserver
    exporting *:/pod-vol
    exporting *:/data/volumes
    exporting *:/data/k8sdata/kuboard
    root@harbor:/data/k8sdata/magedu# 
    

### 3.2.2、创建pv

**创建pv配置清单**

    ---
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: mysql-datadir-1
      namespace: magedu
    spec:
      capacity:
        storage: 50Gi
      accessModes:
        - ReadWriteOnce
      nfs:
        path: /data/k8sdata/magedu/mysql-datadir-1 
        server: 192.168.0.42
    ---
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: mysql-datadir-2
      namespace: magedu
    spec:
      capacity:
        storage: 50Gi
      accessModes:
        - ReadWriteOnce
      nfs:
        path: /data/k8sdata/magedu/mysql-datadir-2
        server: 192.168.0.42
    ---
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: mysql-datadir-3
      namespace: magedu
    spec:
      capacity:
        storage: 50Gi
      accessModes:
        - ReadWriteOnce
      nfs:
        path: /data/k8sdata/magedu/mysql-datadir-3
        server: 192.168.0.42
    ---
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: mysql-datadir-4
      namespace: magedu
    spec:
      capacity:
        storage: 50Gi
      accessModes:
        - ReadWriteOnce
      nfs:
        path: /data/k8sdata/magedu/mysql-datadir-4
        server: 192.168.0.42
    ---
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: mysql-datadir-5
      namespace: magedu
    spec:
      capacity:
        storage: 50Gi
      accessModes:
        - ReadWriteOnce
      nfs:
        path: /data/k8sdata/magedu/mysql-datadir-5
        server: 192.168.0.42
    
    

**创建pv**

    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# kubectl apply -f pv/mysql-persistentvolume.yaml
    persistentvolume/mysql-datadir-1 created
    persistentvolume/mysql-datadir-2 created
    persistentvolume/mysql-datadir-3 created
    persistentvolume/mysql-datadir-4 created
    persistentvolume/mysql-datadir-5 created
    root@k8s-master01:~/k8s-data/yaml/magedu/mysql#
    

### 3.2.3、验证pv

    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# kubectl get pv
    NAME                     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                            STORAGECLASS   REASON   AGE
    mysql-datadir-1          50Gi       RWO            Retain           Available                                                            5s
    mysql-datadir-2          50Gi       RWO            Retain           Available                                                            5s
    mysql-datadir-3          50Gi       RWO            Retain           Available                                                            5s
    mysql-datadir-4          50Gi       RWO            Retain           Available                                                            5s
    mysql-datadir-5          50Gi       RWO            Retain           Available                                                            5s
    redis-cluster-pv0        5Gi        RWO            Retain           Bound       magedu/data-redis-1                                      8d
    redis-cluster-pv1        5Gi        RWO            Retain           Bound       magedu/data-redis-3                                      8d
    redis-cluster-pv2        5Gi        RWO            Retain           Bound       magedu/data-redis-4                                      8d
    redis-cluster-pv3        5Gi        RWO            Retain           Bound       magedu/data-redis-0                                      8d
    redis-cluster-pv4        5Gi        RWO            Retain           Bound       magedu/data-redis-5                                      8d
    redis-cluster-pv5        5Gi        RWO            Retain           Bound       magedu/data-redis-2                                      8d
    redis-datadir-pv-1       10Gi       RWO            Retain           Bound       magedu/redis-datadir-pvc-1                               9d
    zookeeper-datadir-pv-1   20Gi       RWO            Retain           Bound       magedu/zookeeper-datadir-pvc-1                           10d
    zookeeper-datadir-pv-2   20Gi       RWO            Retain           Bound       magedu/zookeeper-datadir-pvc-2                           10d
    zookeeper-datadir-pv-3   20Gi       RWO            Retain           Bound       magedu/zookeeper-datadir-pvc-3                           10d
    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# 
    

3.3、运行mysql服务
-------------

**MYSQL CONFIGMAP配置清单**

    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: mysql
      namespace: magedu
      labels:
        app: mysql
    data:
      master.cnf: |
        # Apply this config only on the master.
        [mysqld]
        log-bin
        log_bin_trust_function_creators=1
        lower_case_table_names=1
      slave.cnf: |
        # Apply this config only on slaves.
        [mysqld]
        super-read-only
        log_bin_trust_function_creators=1
    

**MYSQL POD配置清单**

    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: mysql
      namespace: magedu
    spec:
      selector:
        matchLabels:
          app: mysql
      serviceName: mysql
      replicas: 2
      template:
        metadata:
          labels:
            app: mysql
        spec:
          initContainers:
          - name: init-mysql #初始化容器1、基于当前pod name匹配角色是master还是slave，并动态生成相对应的配置文件
            image: harbor.ik8s.cc/magedu/mysql:5.7.36
            command:
            - bash
            - "-c"
            - |
              set -ex
              # Generate mysql server-id from pod ordinal index.
              [[ `hostname` =~ -([0-9]+)$ ]] || exit 1 #匹配hostname的最后一位、最后是一个顺序叠加的整数
              ordinal=${BASH_REMATCH[1]} 
              echo [mysqld] > /mnt/conf.d/server-id.cnf
              # Add an offset to avoid reserved server-id=0 value.
              echo server-id=$((100 + $ordinal)) >> /mnt/conf.d/server-id.cnf
              # Copy appropriate conf.d files from config-map to emptyDir.
              if [[ $ordinal -eq 0 ]]; then #如果是master、则cpmaster配置文件
                cp /mnt/config-map/master.cnf /mnt/conf.d/
              else #否则cp slave配置文件
                cp /mnt/config-map/slave.cnf /mnt/conf.d/
              fi
            volumeMounts:
            - name: conf #临时卷、emptyDir
              mountPath: /mnt/conf.d
            - name: config-map
              mountPath: /mnt/config-map
          - name: clone-mysql #初始化容器2、用于生成mysql配置文件、并从上一个pod完成首次的全量数据clone(slave 3从slave2 clone，而不是每个slave都从master clone实现首次全量同步,但是后期都是与master实现增量同步)
            image: harbor.ik8s.cc/magedu/xtrabackup:1.0 
            command:
            - bash
            - "-c"
            - |
              set -ex
              # Skip the clone if data already exists.
              [[ -d /var/lib/mysql/mysql ]] && exit 0
              # Skip the clone on master (ordinal index 0).
              [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
              ordinal=${BASH_REMATCH[1]}
              [[ $ordinal -eq 0 ]] && exit 0 #如果最后一位是0(master)则退出clone过程
              # Clone data from previous peer.
              ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql #从上一个pod执行clone(binlog),xbstream为解压缩命令
              # Prepare the backup.xue
              xtrabackup --prepare --target-dir=/var/lib/mysql #通过xtrabackup恢复binlog
            volumeMounts:
            - name: data
              mountPath: /var/lib/mysql
              subPath: mysql
            - name: conf
              mountPath: /etc/mysql/conf.d
          containers:
          - name: mysql #业务容器1(mysql主容器)
            image: harbor.ik8s.cc/magedu/mysql:5.7.36
            env:
            - name: MYSQL_ALLOW_EMPTY_PASSWORD
              value: "1"
            ports:
            - name: mysql
              containerPort: 3306
            volumeMounts:
            - name: data #挂载数据目录至/var/lib/mysql
              mountPath: /var/lib/mysql
              subPath: mysql
            - name: conf #配置文件/etc/mysql/conf.d
              mountPath: /etc/mysql/conf.d
            resources: #资源限制
              requests:
                cpu: 500m
                memory: 1Gi
            livenessProbe: #存活探针
              exec:
                command: ["mysqladmin", "ping"]
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 5
            readinessProbe: #就绪探针
              exec:
                # Check we can execute queries over TCP (skip-networking is off).
                command: ["mysql", "-h", "127.0.0.1", "-e", "SELECT 1"]
              initialDelaySeconds: 5
              periodSeconds: 2
              timeoutSeconds: 1
          - name: xtrabackup #业务容器2(xtrabackup),用于后期同步master 的binglog并恢复数据
            image: harbor.ik8s.cc/magedu/xtrabackup:1.0 
            ports:
            - name: xtrabackup
              containerPort: 3307
            command:
            - bash
            - "-c"
            - |
              set -ex
              cd /var/lib/mysql
              # Determine binlog position of cloned data, if any.
              if [[ -f xtrabackup_slave_info ]]; then
                # XtraBackup already generated a partial "CHANGE MASTER TO" query
                # because we're cloning from an existing slave.
                mv xtrabackup_slave_info change_master_to.sql.in
                # Ignore xtrabackup_binlog_info in this case (it's useless).
                rm -f xtrabackup_binlog_info
              elif [[ -f xtrabackup_binlog_info ]]; then
                # We're cloning directly from master. Parse binlog position.
                [[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1
                rm xtrabackup_binlog_info
                echo "CHANGE MASTER TO MASTER_LOG_FILE='${BASH_REMATCH[1]}',\
                      MASTER_LOG_POS=${BASH_REMATCH[2]}" > change_master_to.sql.in #生成CHANGE MASTER命令
              fi
              # Check if we need to complete a clone by starting replication.
              if [[ -f change_master_to.sql.in ]]; then
                echo "Waiting for mysqld to be ready (accepting connections)"
                until mysql -h 127.0.0.1 -e "SELECT 1"; do sleep 1; done
                echo "Initializing replication from clone position"
                # In case of container restart, attempt this at-most-once.
                mv change_master_to.sql.in change_master_to.sql.orig 
                #执行CHANGE MASTER操作并启动SLAVE
                mysql -h 127.0.0.1 <<EOF
              $(<change_master_to.sql.orig),
                MASTER_HOST='mysql-0.mysql',
                MASTER_USER='root',
                MASTER_PASSWORD='',
                MASTER_CONNECT_RETRY=10;
              START SLAVE;
              EOF
              fi
              # Start a server to send backups when requested by peers. #监听在3307端口，用于为下一个pod同步全量数据
              exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \
                "xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root"
            volumeMounts:
            - name: data
              mountPath: /var/lib/mysql
              subPath: mysql
            - name: conf
              mountPath: /etc/mysql/conf.d
            resources:
              requests:
                cpu: 100m
                memory: 100Mi
          volumes:
          - name: conf
            emptyDir: {}
          - name: config-map
            configMap:
              name: mysql
      volumeClaimTemplates:
      - metadata:
          name: data
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    

> 上述配置清单主要定义两个mysqlPod，其中每个pod中运行4个容器，第一个容器init容器主要目的是通过sts控制器创建pod的名称id来确定挂载master和slave配置；第二个初始化容器主要目的是用于克隆上一个pod的数据，即salve1从master上克隆数据，slave2从slave1克隆数据，以此类推；第三个就是mysql主容器，运行mysql实例；第四个容器主要用于给mysql主容器同步后期的增量数据的；

**MYSQL SERVICE配置清单**

    # Headless service for stable DNS entries of StatefulSet members.
    apiVersion: v1
    kind: Service
    metadata:
      namespace: magedu
      name: mysql
      labels:
        app: mysql
    spec:
      ports:
      - name: mysql
        port: 3306
      clusterIP: None
      selector:
        app: mysql
    ---
    # Client service for connecting to any MySQL instance for reads.
    # For writes, you must instead connect to the master: mysql-0.mysql.
    apiVersion: v1
    kind: Service
    metadata:
      name: mysql-read
      namespace: magedu
      labels:
        app: mysql
    spec:
      ports:
      - name: mysql
        port: 3306
      selector:
        app: mysql
    

> 上述配置清单主要创建了两个service，第一个是一个无头service 用户返回后端所有pod端点；第二个service是一个默认clusterip类型service，这两个service都是可以的；

### 3.3.1、创建mysql pod

    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# kubectl apply -f mysql-configmap.yaml -f mysql-services.yaml -f mysql-statefulset.yaml 
    configmap/mysql created
    service/mysql created
    service/mysql-read created
    statefulset.apps/mysql created
    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# 
    

### 3.3.2、验证MySQL Pod状态

    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# kubectl get pods -n magedu 
    NAME                                             READY   STATUS      RESTARTS       AGE
    magedu-nginx-deployment-5589bbf4bc-6gd2w         1/1     Running     8 (113m ago)   11d
    magedu-tomcat-app1-deployment-7754c8549c-c7rtb   1/1     Running     4 (114m ago)   11d
    magedu-tomcat-app1-deployment-7754c8549c-prglk   1/1     Running     4 (114m ago)   11d
    mysql-0                                          2/2     Running     0              47s
    mysql-1                                          2/2     Running     0              23s
    redis-0                                          1/1     Running     2 (114m ago)   8d
    redis-1                                          1/1     Running     2 (114m ago)   8d
    redis-2                                          1/1     Running     2 (114m ago)   8d
    redis-3                                          1/1     Running     2 (114m ago)   8d
    redis-4                                          1/1     Running     2 (114m ago)   8d
    redis-5                                          1/1     Running     2 (114m ago)   8d
    ubuntu1804                                       0/1     Completed   0              8d
    zookeeper1-675c5477cb-vmwwq                      1/1     Running     4 (114m ago)   10d
    zookeeper2-759fb6c6f-7jktr                       1/1     Running     4 (114m ago)   10d
    zookeeper3-5c78bb5974-vxpbh                      1/1     Running     4 (114m ago)   10d
    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# 
    

**修改配置清单pod副本为3，看看对应pod是否能够正常running?**  
![](https://img2023.cnblogs.com/blog/1503305/202306/1503305-20230615181704603-677012244.png)  
**应用配置清单**  
![](https://img2023.cnblogs.com/blog/1503305/202306/1503305-20230615181829889-848151014.png)

### 3.3.3、验证MySQL主从同步是否正常

**验证master状态**

    root@k8s-master01:~# kubectl exec -it mysql-0 -n magedu  bash 
    kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
    Defaulted container "mysql" out of: mysql, xtrabackup, init-mysql (init), clone-mysql (init)
    root@mysql-0:/# mysql 
    Welcome to the MySQL monitor.  Commands end with ; or \g.
    Your MySQL connection id is 691
    Server version: 5.7.36-log MySQL Community Server (GPL)
    
    Copyright (c) 2000, 2021, Oracle and/or its affiliates.
    
    Oracle is a registered trademark of Oracle Corporation and/or its
    affiliates. Other names may be trademarks of their respective
    owners.
    
    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
    
    mysql> show master status\G
    *************************** 1. row ***************************
                 File: mysql-0-bin.000003
             Position: 313
         Binlog_Do_DB: 
     Binlog_Ignore_DB: 
    Executed_Gtid_Set: 
    1 row in set (0.01 sec)
    
    mysql> exit
    Bye
    root@mysql-0:/# exit
    exit
    root@k8s-master01:~# 
    

**验证slave状态**

    root@k8s-master01:~# kubectl exec -it mysql-1 -n magedu  bash  
    kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
    Defaulted container "mysql" out of: mysql, xtrabackup, init-mysql (init), clone-mysql (init)
    root@mysql-1:/# mysql
    Welcome to the MySQL monitor.  Commands end with ; or \g.
    Your MySQL connection id is 708
    Server version: 5.7.36 MySQL Community Server (GPL)
    
    Copyright (c) 2000, 2021, Oracle and/or its affiliates.
    
    Oracle is a registered trademark of Oracle Corporation and/or its
    affiliates. Other names may be trademarks of their respective
    owners.
    
    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
    
    mysql> show slave status\G
    *************************** 1. row ***************************
                   Slave_IO_State: Waiting for master to send event
                      Master_Host: mysql-0.mysql
                      Master_User: root
                      Master_Port: 3306
                    Connect_Retry: 10
                  Master_Log_File: mysql-0-bin.000003
              Read_Master_Log_Pos: 313
                   Relay_Log_File: mysql-1-relay-bin.000002
                    Relay_Log_Pos: 481
            Relay_Master_Log_File: mysql-0-bin.000003
                 Slave_IO_Running: Yes
                Slave_SQL_Running: Yes
                  Replicate_Do_DB: 
              Replicate_Ignore_DB: 
               Replicate_Do_Table: 
           Replicate_Ignore_Table: 
          Replicate_Wild_Do_Table: 
      Replicate_Wild_Ignore_Table: 
                       Last_Errno: 0
                       Last_Error: 
                     Skip_Counter: 0
              Exec_Master_Log_Pos: 313
                  Relay_Log_Space: 690
                  Until_Condition: None
                   Until_Log_File: 
                    Until_Log_Pos: 0
               Master_SSL_Allowed: No
               Master_SSL_CA_File: 
               Master_SSL_CA_Path: 
                  Master_SSL_Cert: 
                Master_SSL_Cipher: 
                   Master_SSL_Key: 
            Seconds_Behind_Master: 0
    Master_SSL_Verify_Server_Cert: No
                    Last_IO_Errno: 0
                    Last_IO_Error: 
                   Last_SQL_Errno: 0
                   Last_SQL_Error: 
      Replicate_Ignore_Server_Ids: 
                 Master_Server_Id: 100
                      Master_UUID: 72724f41-0b65-11ee-b561-16065cd6961a
                 Master_Info_File: /var/lib/mysql/master.info
                        SQL_Delay: 0
              SQL_Remaining_Delay: NULL
          Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
               Master_Retry_Count: 86400
                      Master_Bind: 
          Last_IO_Error_Timestamp: 
         Last_SQL_Error_Timestamp: 
                   Master_SSL_Crl: 
               Master_SSL_Crlpath: 
               Retrieved_Gtid_Set: 
                Executed_Gtid_Set: 
                    Auto_Position: 0
             Replicate_Rewrite_DB: 
                     Channel_Name: 
               Master_TLS_Version: 
    1 row in set (0.00 sec)
    
    mysql> exit 
    Bye
    root@mysql-1:/# exit
    exit
    root@k8s-master01:~# kubectl exec -it mysql-2 -n magedu  bash  
    kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
    Defaulted container "mysql" out of: mysql, xtrabackup, init-mysql (init), clone-mysql (init)
    root@mysql-2:/# mysql
    Welcome to the MySQL monitor.  Commands end with ; or \g.
    Your MySQL connection id is 632
    Server version: 5.7.36 MySQL Community Server (GPL)
    
    Copyright (c) 2000, 2021, Oracle and/or its affiliates.
    
    Oracle is a registered trademark of Oracle Corporation and/or its
    affiliates. Other names may be trademarks of their respective
    owners.
    
    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
    
    mysql> show slave status\G
    *************************** 1. row ***************************
                   Slave_IO_State: Waiting for master to send event
                      Master_Host: mysql-0.mysql
                      Master_User: root
                      Master_Port: 3306
                    Connect_Retry: 10
                  Master_Log_File: mysql-0-bin.000003
              Read_Master_Log_Pos: 313
                   Relay_Log_File: mysql-2-relay-bin.000002
                    Relay_Log_Pos: 481
            Relay_Master_Log_File: mysql-0-bin.000003
                 Slave_IO_Running: Yes
                Slave_SQL_Running: Yes
                  Replicate_Do_DB: 
              Replicate_Ignore_DB: 
               Replicate_Do_Table: 
           Replicate_Ignore_Table: 
          Replicate_Wild_Do_Table: 
      Replicate_Wild_Ignore_Table: 
                       Last_Errno: 0
                       Last_Error: 
                     Skip_Counter: 0
              Exec_Master_Log_Pos: 313
                  Relay_Log_Space: 690
                  Until_Condition: None
                   Until_Log_File: 
                    Until_Log_Pos: 0
               Master_SSL_Allowed: No
               Master_SSL_CA_File: 
               Master_SSL_CA_Path: 
                  Master_SSL_Cert: 
                Master_SSL_Cipher: 
                   Master_SSL_Key: 
            Seconds_Behind_Master: 0
    Master_SSL_Verify_Server_Cert: No
                    Last_IO_Errno: 0
                    Last_IO_Error: 
                   Last_SQL_Errno: 0
                   Last_SQL_Error: 
      Replicate_Ignore_Server_Ids: 
                 Master_Server_Id: 100
                      Master_UUID: 72724f41-0b65-11ee-b561-16065cd6961a
                 Master_Info_File: /var/lib/mysql/master.info
                        SQL_Delay: 0
              SQL_Remaining_Delay: NULL
          Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
               Master_Retry_Count: 86400
                      Master_Bind: 
          Last_IO_Error_Timestamp: 
         Last_SQL_Error_Timestamp: 
                   Master_SSL_Crl: 
               Master_SSL_Crlpath: 
               Retrieved_Gtid_Set: 
                Executed_Gtid_Set: 
                    Auto_Position: 0
             Replicate_Rewrite_DB: 
                     Channel_Name: 
               Master_TLS_Version: 
    1 row in set (0.00 sec)
    
    mysql> exit
    Bye
    root@mysql-2:/# exit
    exit
    root@k8s-master01:~#
    

> 能够在slave上看到IO和SQL线程正常running，说明slave状态没有问题；

**进入mysql-0创建数据库**

    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# kubectl exec -it mysql-0 -n magedu  bash
    kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
    Defaulted container "mysql" out of: mysql, xtrabackup, init-mysql (init), clone-mysql (init)
    root@mysql-0:/# mysql
    Welcome to the MySQL monitor.  Commands end with ; or \g.
    Your MySQL connection id is 355
    Server version: 5.7.36-log MySQL Community Server (GPL)
    
    Copyright (c) 2000, 2021, Oracle and/or its affiliates.
    
    Oracle is a registered trademark of Oracle Corporation and/or its
    affiliates. Other names may be trademarks of their respective
    owners.
    
    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
    
    mysql> show databases;
    +------------------------+
    | Database               |
    +------------------------+
    | information_schema     |
    | mysql                  |
    | performance_schema     |
    | sys                    |
    | xtrabackup_backupfiles |
    +------------------------+
    5 rows in set (0.02 sec)
    
    mysql> create database mydb;
    Query OK, 1 row affected (0.00 sec)
    
    mysql> show databases;
    +------------------------+
    | Database               |
    +------------------------+
    | information_schema     |
    | mydb                   |
    | mysql                  |
    | performance_schema     |
    | sys                    |
    | xtrabackup_backupfiles |
    +------------------------+
    6 rows in set (0.00 sec)
    
    mysql> 
    

**在slave pod中验证数据是否同步？**

    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# kubectl exec -it mysql-1 -n magedu  bash 
    kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
    Defaulted container "mysql" out of: mysql, xtrabackup, init-mysql (init), clone-mysql (init)
    root@mysql-1:/# mysql
    Welcome to the MySQL monitor.  Commands end with ; or \g.
    Your MySQL connection id is 437
    Server version: 5.7.36 MySQL Community Server (GPL)
    
    Copyright (c) 2000, 2021, Oracle and/or its affiliates.
    
    Oracle is a registered trademark of Oracle Corporation and/or its
    affiliates. Other names may be trademarks of their respective
    owners.
    
    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
    
    mysql> show databases;
    +------------------------+
    | Database               |
    +------------------------+
    | information_schema     |
    | mydb                   |
    | mysql                  |
    | performance_schema     |
    | sys                    |
    | xtrabackup_backupfiles |
    +------------------------+
    6 rows in set (0.01 sec)
    
    mysql> exit
    Bye
    root@mysql-1:/# exit
    exit
    root@k8s-master01:~/k8s-data/yaml/magedu/mysql# kubectl exec -it mysql-2 -n magedu  bash  
    kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
    Defaulted container "mysql" out of: mysql, xtrabackup, init-mysql (init), clone-mysql (init)
    root@mysql-2:/# mysql
    Welcome to the MySQL monitor.  Commands end with ; or \g.
    Your MySQL connection id is 361
    Server version: 5.7.36 MySQL Community Server (GPL)
    
    Copyright (c) 2000, 2021, Oracle and/or its affiliates.
    
    Oracle is a registered trademark of Oracle Corporation and/or its
    affiliates. Other names may be trademarks of their respective
    owners.
    
    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
    
    mysql> show databases;
    +------------------------+
    | Database               |
    +------------------------+
    | information_schema     |
    | mydb                   |
    | mysql                  |
    | performance_schema     |
    | sys                    |
    | xtrabackup_backupfiles |
    +------------------------+
    6 rows in set (0.02 sec)
    
    mysql> exit
    Bye
    root@mysql-2:/# exit
    exit
    root@k8s-master01:~/k8s-data/yaml/magedu/mysql#
    

> 能够通过上述在主库创建数据库，从库能够正常同步，则说明mysql主从同步没有问题；

### 3.3.4、mysql⾼可⽤测试

#### 3.3.4.1、删除master pod验证mysql高可用性

![](https://img2023.cnblogs.com/blog/1503305/202306/1503305-20230615184210608-893922158.png)  
**进入master，验证master数据是否丢失？**  
![](https://img2023.cnblogs.com/blog/1503305/202306/1503305-20230615184319370-1818494767.png)

> 能够看到master数据并未丢失，这是因为该数据存放至远端nfs存储之上；

#### 3.3.4.2、删除slave pod验证mysql高可用性

    root@k8s-master01:~# kubectl get pods -n magedu 
    NAME                                             READY   STATUS      RESTARTS       AGE
    magedu-nginx-deployment-5589bbf4bc-6gd2w         1/1     Running     8 (143m ago)   11d
    magedu-tomcat-app1-deployment-7754c8549c-c7rtb   1/1     Running     4 (143m ago)   11d
    magedu-tomcat-app1-deployment-7754c8549c-prglk   1/1     Running     4 (143m ago)   11d
    mysql-0                                          2/2     Running     0              3m6s
    mysql-1                                          2/2     Running     0              29m
    mysql-2                                          2/2     Running     0              27m
    redis-0                                          1/1     Running     2 (143m ago)   8d
    redis-1                                          1/1     Running     2 (143m ago)   8d
    redis-2                                          1/1     Running     2 (143m ago)   8d
    redis-3                                          1/1     Running     2 (143m ago)   8d
    redis-4                                          1/1     Running     2 (143m ago)   8d
    redis-5                                          1/1     Running     2 (143m ago)   8d
    ubuntu1804                                       0/1     Completed   0              8d
    zookeeper1-675c5477cb-vmwwq                      1/1     Running     4 (143m ago)   10d
    zookeeper2-759fb6c6f-7jktr                       1/1     Running     4 (143m ago)   10d
    zookeeper3-5c78bb5974-vxpbh                      1/1     Running     4 (143m ago)   10d
    root@k8s-master01:~# kubectl delete pods mysql-1 -n magedu 
    pod "mysql-1" deleted
    root@k8s-master01:~# kubectl get pods -n magedu 
    NAME                                             READY   STATUS      RESTARTS       AGE
    magedu-nginx-deployment-5589bbf4bc-6gd2w         1/1     Running     8 (144m ago)   11d
    magedu-tomcat-app1-deployment-7754c8549c-c7rtb   1/1     Running     4 (145m ago)   11d
    magedu-tomcat-app1-deployment-7754c8549c-prglk   1/1     Running     4 (145m ago)   11d
    mysql-0                                          2/2     Running     0              4m55s
    mysql-1                                          2/2     Running     0              55s
    mysql-2                                          2/2     Running     0              28m
    redis-0                                          1/1     Running     2 (145m ago)   8d
    redis-1                                          1/1     Running     2 (145m ago)   8d
    redis-2                                          1/1     Running     2 (145m ago)   8d
    redis-3                                          1/1     Running     2 (145m ago)   8d
    redis-4                                          1/1     Running     2 (145m ago)   8d
    redis-5                                          1/1     Running     2 (145m ago)   8d
    ubuntu1804                                       0/1     Completed   0              8d
    zookeeper1-675c5477cb-vmwwq                      1/1     Running     4 (145m ago)   10d
    zookeeper2-759fb6c6f-7jktr                       1/1     Running     4 (145m ago)   10d
    zookeeper3-5c78bb5974-vxpbh                      1/1     Running     4 (145m ago)   10d
    root@k8s-master01:~# 
    

**进入slave验证数据**  
![](https://img2023.cnblogs.com/blog/1503305/202306/1503305-20230615184757780-253261346.png)

作者：[Linux-1874](https://www.cnblogs.com/qiuhom-1874/)

出处：[https://www.cnblogs.com/qiuhom-1874/](https://www.cnblogs.com/qiuhom-1874/)

本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.