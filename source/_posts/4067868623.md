---
layout: post
title: "Vue Router æºç åˆ†æ"
date: "2023-06-29T01:22:03.972Z"
---
Vue Router æºç åˆ†æğŸ’ª
=================

æœ€ç»ˆæˆæœï¼Œå®ç°äº†ä¸€ä¸ªå¯è¿è¡Œçš„æ ¸å¿ƒè·¯ç”±å·¥ç¨‹ï¼šæŸæˆ/vue-router3.xã€‚åœ°å€å¦‚ä¸‹ï¼šhttps://gitee.com/lbcjs/vue-router3.x

> ä¸“æ åˆ†äº«ï¼š[vue2æºç ä¸“æ ](https://www.cnblogs.com/burc/category/2291641.html)ï¼Œ[ç©å…·é¡¹ç›®ä¸“æ ](https://www.cnblogs.com/burc/category/1948081.html)ï¼Œç¡¬æ ¸ ğŸ’ª æ¨è ğŸ™Œ
> 
> æ¬¢è¿å„ä½ ITer å…³æ³¨ç‚¹èµæ”¶è— ğŸŒ¸ğŸŒ¸ğŸŒ¸

æœ¬ç¯‡æ–‡ç« å‚è€ƒç‰ˆæœ¬ï¼š[vue-router v3.x](https://github.com/vuejs/vue-router)  
æœ€ç»ˆæˆæœï¼Œå®ç°äº†ä¸€ä¸ªå¯è¿è¡Œçš„æ ¸å¿ƒè·¯ç”±å·¥ç¨‹ï¼š[æŸæˆ/vue-router3.x](https://gitee.com/lbcjs/vue-router3.x)  
ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

    .
    |-- components           // ç»„ä»¶(view/link)
    |   |-- router-link.js
    |   `-- router-view.js
    |-- create-matcher.js    // Route åŒ¹é…
    |-- create-route-map.js  // Route æ˜ å°„è¡¨
    |-- history              // Router å¤„ç† (hashæ¨¡å¼ã€historyæ¨¡å¼)
    |   |-- base.js
    |   |-- hash.js
    |   `-- html5.js
    |-- index.js             // Router ç±»
    `-- install.js           // Router æ’ä»¶å®‰è£…
    

1\. è·¯ç”±æ³¨å†Œ
========

èµ·æ­¥
--

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªåŸºæœ¬ä¾‹å­ï¼Œç†Ÿæ‚‰å…¶ç®€å•çš„åº”ç”¨é…ç½®

    import Vue from 'vue'
    import VueRouter from 'vue-router'
    
    Vue.use(VueRouter)
    
    // 1. å®šä¹‰ (è·¯ç”±) ç»„ä»¶
    const Foo = { template: '<div>foo</div>' }
    const Bar = { template: '<div>bar</div>' }
    
    // 2. å®šä¹‰è·¯ç”±
    const routes = [
      { path: '/foo', component: Foo },
      { path: '/bar', component: Bar }
    ]
    
    // 3. åˆ›å»º router å®ä¾‹ï¼Œç„¶åä¼  routes é…ç½®
    const router = new VueRouter({
      mode: 'history',
      routes
    })
    
    // 4. åˆ›å»ºå’ŒæŒ‚è½½æ ¹å®ä¾‹ï¼Œè®°å¾—æ³¨å…¥è·¯ç”±å™¨ï¼Œä»è€Œè®©æ•´ä¸ªåº”ç”¨éƒ½æœ‰è·¯ç”±åŠŸèƒ½
    const app = new Vue({
      router
    }).$mount('#app')
    

é€šè¿‡æ³¨å…¥è·¯ç”±å™¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•ç»„ä»¶å†…é€šè¿‡ `this.$router` è®¿é—®è·¯ç”±å™¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `this.$route` è®¿é—®å½“å‰è·¯ç”±ï¼ˆåé¢æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»å…¶å†…éƒ¨å®ç°ï¼‰

use
---

æˆ‘ä»¬å‘ç°ï¼Œå¦‚æœè¦åœ¨ä¸€ä¸ªæ¨¡å—åŒ–å·¥ç¨‹ä¸­ä½¿ç”¨ vue-routerï¼Œå¿…é¡»è¦é€šè¿‡ `Vue.use()` æ˜ç¡®åœ°å®‰è£…è·¯ç”±åŠŸèƒ½  
`Vue.use(plugin)` æ˜¯ä¸€ä¸ªå…¨å±€æ’ä»¶æ³¨å†ŒAPIï¼Œå®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»çš„ï¼š

> å®‰è£… Vue.js æ’ä»¶æ—¶è°ƒç”¨ï¼Œå¦‚æœæ’ä»¶æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»æä¾› install æ–¹æ³•ã€‚å¦‚æœæ’ä»¶æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæœ¬èº«ä¼šè¢«ä½œä¸º install æ–¹æ³•ã€‚install æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šå°† Vue å¯¹è±¡ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥

å°† Vue å¯¹è±¡å½“åšå‚æ•°çš„å¥½å¤„å°±æ˜¯æ’ä»¶çš„ç¼–å†™æ–¹ä¸éœ€è¦é¢å¤– import Vue äº†ï¼Œå¯å‡å°‘æ’ä»¶åŒ…çš„ä½“ç§¯

install
-------

vue-router çš„å…¥å£æ–‡ä»¶æ˜¯ `src/index.js`ï¼Œå…¶ä¸­å®šä¹‰äº† VueRouter ç±»ï¼›ä¹Ÿå®ç°äº† install çš„é™æ€æ–¹æ³•ï¼Œå®ƒçš„å®šä¹‰åœ¨ `src/install.js` ä¸­

`Vue.use(VueRouter)` é»˜è®¤ä¼šè°ƒç”¨ VueRouter ç±»ä¸Šçš„ install æ–¹æ³•

`src/index.js:`

    import install from './install'
    export default class VueRouter{ }
    VueRouter.install = install
    

`src/install.js:`

    import routerLink from './components/router-link'
    import routerView from './components/router-view'
    
    // é™æ€å…¨å±€å˜é‡
    export let Vue
    
    function install (_Vue) {
      Vue = _Vue
    
      // mixin å†…éƒ¨ä¼šè°ƒç”¨ mergeOptionsæ–¹æ³•ï¼Œ æ‰€æœ‰ç»„ä»¶åˆå§‹åŒ–éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
      // è¿™é‡Œä¸èƒ½ç›´æ¥å°†å±æ€§å®šä¹‰åœ¨åŸå‹ä¸Š, åªæœ‰åœ¨ new Vue ä¸­ä¼ å…¥äº† routerè·¯ç”±å®ä¾‹ æ‰èƒ½è¢«åä»£ç»„ä»¶å…±äº«
      Vue.mixin({
        beforeCreate () {
          // ç»„ä»¶æ¸²æŸ“æ˜¯ä»çˆ¶åˆ°å­çš„
          // è¿™æ ·ä¿è¯äº†æœ‰ routerè·¯ç”±å®ä¾‹æ‰åŠ ï¼Œæ²¡æœ‰ routerè·¯ç”±å®ä¾‹å°±ä¸åŠ 
          if (this.$options.router) {
            this._routerRoot = this // æ ¹å®ä¾‹
            this._router = this.$options.router // routerè·¯ç”±å®ä¾‹
    
            this._router.init(this) // this å°±æ˜¯æˆ‘ä»¬çš„æ ¹åº”ç”¨ new Vue()
    
            // ç»™æ ¹å®ä¾‹æ·»åŠ ä¸€ä¸ªå±æ€§ _routeï¼Œå€¼å°±æ˜¯å½“å‰çš„ currentå¯¹è±¡ï¼Œå¹¶å°† this._routeå˜æˆäº†å“åº”å¼å¯¹è±¡ï¼ˆæ•°æ®å˜åŒ–åº”è¯¥ä¼šå¼•èµ·é¡µé¢é‡æ–°æ¸²æŸ“ï¼‰
            // æ³¨æ„ï¼ï¼ï¼current æ”¹å˜å¹¶ä¸ä¼šè§¦å‘ _routeçš„æ”¹å˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ currentå˜åŒ–æ—¶æ‰‹åŠ¨æ›´æ–° this._routeçš„å€¼
            // let current = {}; let _route = current; current = {name: 'æ–°çš„'}; _route ä»ç„¶æ˜¯ {}
            Vue.util.defineReactive(this, '_route', this._router.history.current)
    
            // this._router å¯ä»¥æ‹¿åˆ°è·¯ç”±å®ä¾‹
            // this._route å¯ä»¥æ‹¿åˆ°currentå¯¹è±¡
          } else {
            // åœ¨æ‰€æœ‰åä»£ç»„ä»¶ä¸Šéƒ½å¢åŠ  _routerRootï¼Œå…¶æŒ‡å‘æ ¹å®ä¾‹
            this._routerRoot = this.$parent && this.$parent._routerRoot
          }
        }
      })
    
      // ä»£ç†å®ä¾‹ä¸Šçš„ $router å±æ€§ï¼Œthis.$router
      Object.defineProperty(Vue.prototype, '$router', {
        get () {
          return this._routerRoot && this._routerRoot._router
        }
      })
      // ä»£ç†å®ä¾‹ä¸Šçš„ $route å±æ€§ï¼Œthis.$route
      Object.defineProperty(Vue.prototype, '$route', {
        get () {
          return this._routerRoot && this._routerRoot._route
        }
      })
    
      // æ³¨å†Œ router-link å…¨å±€ç»„ä»¶
      Vue.component('router-link', routerLink)
      // æ³¨å†Œ router-view å…¨å±€ç»„ä»¶
      Vue.component('router-view', routerView)
    }
    export default install
    

**åœ¨ install æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦åšäº† 3 ä»¶äº‹ ï¼**

1.  æˆ‘ä»¬åˆ©ç”¨ `Vue.mixin` å°† beforeCreate ç”Ÿå‘½å‘¨æœŸé’©å­æ³¨å…¥åˆ°äº†æ¯ä¸€ä¸ªç»„ä»¶ä¸­ï¼Œå¹¶åœ¨ç»„ä»¶è‡ªèº«é’©å­ä¹‹å‰è°ƒç”¨
    
    åœ¨ beforeCreate é’©å­ä¸­ï¼Œæˆ‘ä»¬å°†æ ¹å®ä¾‹ `_routerRoot` å…±äº«ç»™äº†æ‰€æœ‰çš„åä»£ç»„ä»¶ï¼›ç»™æ ¹å®ä¾‹æ·»åŠ äº†ä¸€ä¸ª `_router` å±æ€§ï¼ˆVueRouterå®ä¾‹ï¼‰å¹¶è°ƒç”¨äº† router çš„åˆå§‹åŒ–æ–¹æ³• `this._router.init()`ï¼›ç„¶åç”¨ `defineReactive` æ–¹æ³•ç»™æ ¹å®ä¾‹æ·»åŠ äº†ä¸€ä¸ªå“åº”å¼å±æ€§ `_route`ï¼ˆå½“å‰è·¯ç”±å¯¹è±¡ï¼‰
    
2.  åœ¨ Vue åŸå‹ä¸Šä»£ç†äº† `$router`ã€`$route` å±æ€§ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•ç»„ä»¶å†…é€šè¿‡ `this.$router` è®¿é—®è·¯ç”±å™¨ã€é€šè¿‡ `this.$route` è®¿é—®å½“å‰è·¯ç”±
    
3.  é€šè¿‡ `Vue.component` æ³¨å†Œäº†å…¨å±€ç»„ä»¶ `<router-link>`ã€`<router-view>`
    

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†åˆ†æä¸€ä¸‹ VueRouter å¯¹è±¡çš„å®ç°å’Œå®ƒçš„åˆå§‹åŒ–å·¥ä½œ

2\. VueRouter ç±»
===============

VueRouter çš„å®ç°æ˜¯ä¸€ä¸ªç±»ï¼Œåœ¨å…¥å£æ–‡ä»¶ `src/index.js`ä¸­å®šä¹‰

    import install from './install'
    import createMatcher from './create-matcher'
    import HashHistory from './history/hash'
    import Html5History from './history/html5'
    
    class VueRouter {
      constructor (options) {
        // ç”¨æˆ·ä¼ é€’çš„è·¯ç”±é…ç½®
        const routes = options.routes || []
        this.beforeEachHooks = []
    
        // è·¯ç”±åŒ¹é…å™¨ï¼Œå¯ä»¥åŒ¹é…ä¹Ÿå¯ä»¥æ·»åŠ æ–°çš„è·¯ç”±
        this.matcher = createMatcher(routes)
    
        const mode = options.mode || 'hash'
        if (mode === 'hash') {
          this.history = new HashHistory(this) // popstate, hashchange
        } else if (mode === 'history') {
          this.history = new Html5History(this) // popstate
        }
      }
    
      // è·¯ç”±å®ˆå«ï¼Œç¼“å­˜å›è°ƒé’©å­ï¼Œåœ¨ transitionToæ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒé’©å­
      beforeEach (cb) {
        this.beforeEachHooks.push(cb)
      }
    
      // routeråˆå§‹åŒ–æ–¹æ³•ï¼ˆåªä¼šåœ¨ æ ¹vueå®ä¾‹ä¸­çš„ beforeCreateé’©å­ä¸­è°ƒç”¨ä¸€æ¬¡ï¼‰
      init (app) {
        console.log('routeråˆå§‹åŒ–æ–¹æ³•ï¼ˆinitï¼‰')
        const history = this.history
        // æ‰‹åŠ¨æ ¹æ®å½“å‰è·¯å¾„å»åŒ¹é…å¯¹åº”çš„ç»„ä»¶ï¼Œæ¸²æŸ“ï¼Œä¹‹åç›‘å¬è·¯ç”±å˜åŒ–
        history.transitionTo(history.getCurrentLocation(), () => {
          history.setupListener()
        })
    
        // åœ¨ transitionTo æ–¹æ³•ä¸­æ‰§è¡Œè¿™ä¸ªå›è°ƒï¼Œç›®çš„å°±æ˜¯åœ¨ currentå˜åŒ–æ—¶æ‰‹åŠ¨æ›´æ–° app._routeçš„å€¼ï¼Œæ•°æ®å˜åŒ–ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“è§†å›¾
        history.listen((newRoute) => {
          app._route = newRoute
        })
      }
    
      // ç®€åŒ–ç”¨æˆ·è°ƒç”¨å±‚çº§  this.match â‰ˆ this.matcher.match
      match (location) {
        return this.matcher.match(location)
      }
    
      // è°ƒç”¨ HashHistory or Html5History çš„è·³è½¬é€»è¾‘ï¼ˆç‚¹å‡»router-linkè§¦å‘ï¼‰
      push (location) {
        // é’ˆå¯¹hashæ¨¡å¼ï¼š window.location.hash
        // é’ˆå¯¹historyæ¨¡å¼ï¼š history.pushState
        return this.history.push(location)
      }
    }
    
    // å½“æ‰§è¡Œ Vue.use(VueRouter) æ—¶ï¼Œå¦‚æœ VueRouteræ’ä»¶æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»æä¾› installæ–¹æ³•ï¼Œinstallæ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šå°† Vueä½œä¸ºå‚æ•°ä¼ å…¥
    VueRouter.install = install
    
    export default VueRouter
    

constructor
-----------

æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹ constructoræ„é€ å‡½æ•°ï¼Œçœ‹çœ‹å½“æˆ‘ä»¬ `new VueRouter({})` æ—¶æ‰§è¡Œäº†å“ªäº›æ“ä½œ

åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€äº›ç§æœ‰å±æ€§ã€‚ **this.beforeEachHooks å±æ€§ç”¨æ¥è®°å½•è·¯ç”±å®ˆå«é’©å­å›è°ƒ**ï¼ˆæœ€ç»ˆåœ¨ transitionTo æ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ï¼‰ï¼›**this.matcher å±æ€§ä»£è¡¨è·¯ç”±åŒ¹é…å™¨å¯¹è±¡**ï¼Œ`createMatcher()` æ–¹æ³•è¿”å›äº† matchã€addRouteã€addRoutes ç­‰æ–¹æ³•ï¼Œå¯ä»¥åŒ¹é…ã€æ·»åŠ æ–°çš„è·¯ç”±ï¼ˆæˆ‘ä»¬ä¼šåœ¨ transitionTo æ–¹æ³•ä¸­åº”ç”¨ matchï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ï¼‰ï¼›**this.history å±æ€§ä»£è¡¨è·¯ç”±å†å²å®ä¾‹**ï¼Œæ˜¯å…·ä½“æ‰§è¡Œå„ç§è·¯ç”±æ“ä½œçš„æ‰§è¡Œè€…ï¼Œå…¶æ ¹æ®é€‰é¡¹æ¨¡å¼ `options.mode` çš„ä¸åŒï¼Œå» new äº†ä¸€ä¸ªç›¸å¯¹åº”çš„ History å®ä¾‹ `HashHistory or Html5History`ï¼ˆåé¢ä¼šè¯¦ç»†ä»‹ç»ï¼‰

**tipï¼š**transitionTo æ–¹æ³•çš„å®ç°æ˜¯åœ¨ `src/history/base.js` ä¸­ã€‚ä»–è´Ÿè´£å¤„ç†æ‰€æœ‰çš„è·³è½¬é€»è¾‘ï¼Œä¼šæ ¹æ®è·¯å¾„åŒ¹é…å¯¹åº”çš„è·¯ç”±è®°å½•ï¼Œæ›´æ–° `app._route`ï¼ˆå“åº”å¼å¯¹è±¡ï¼‰ä¸ºæœ€æ–°çš„è·¯ç”±å¯¹è±¡ï¼Œä»è€Œè§¦å‘ setter åŠ«æŒï¼Œé€šçŸ¥ `<router-view>` å»æ¸²æŸ“æ–°çš„ç»„ä»¶ï¼ˆå…ˆæœ‰ä¸ªå¤§æ¦‚è®¤çŸ¥ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ï¼‰

init
----

**è§¦å‘æ—¶æœº**ï¼šè¿˜è®°å¾—å—ï¼Ÿåœ¨å‰é¢ `VueRouter.install` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨ `Vue.mixin` å°† beforeCreate ç”Ÿå‘½å‘¨æœŸé’©å­æ³¨å…¥åˆ°äº†æ¯ä¸€ä¸ªç»„ä»¶ä¸­ã€‚æˆ‘ä»¬åœ¨ `new Vue({})` æ ¹å®ä¾‹æ—¶ï¼Œä¼šæŠŠ router è·¯ç”±å™¨æ³¨å…¥åˆ°æ ¹å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åªä¼šåœ¨æ ¹vueå®ä¾‹ä¸­çš„ beforeCreate é’©å­ä¸­è°ƒç”¨ä¸€æ¬¡`router.init`æ–¹æ³•

`src/install.js:`

    beforeCreate () {
      if (this.$options.router) {
        this._routerRoot = this // æ ¹å®ä¾‹
        this._router = this.$options.router // routerè·¯ç”±å®ä¾‹
    
        this._router.init(this) // this å°±æ˜¯æˆ‘ä»¬çš„æ ¹åº”ç”¨ new Vue()
    
        Vue.util.defineReactive(this, '_route', this._router.history.current)
      } else {
        this._routerRoot = this.$parent && this.$parent._routerRoot
      }
    }
    

**æˆ‘ä»¬åœ¨ router åˆå§‹åŒ–æ–¹æ³•ä¸­ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼**

1.  **æ‰§è¡Œ history.transitionTo æ–¹æ³•**ï¼Œæ ¹æ®å½“å‰è·¯å¾„å»åŒ¹é…å¯¹åº”çš„ç»„ä»¶ï¼Œå¹¶æ¸²æŸ“ã€‚ç„¶åé€šè¿‡ `history.setupListener` åœ¨å›è°ƒä¸­æ·»åŠ è·¯ç”±ç›‘å¬å™¨ï¼Œå½“è·¯ç”±å˜åŒ–æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åšä¸€äº›äº‹æƒ…äº†ï¼å½“ç„¶ï¼Œä¸åŒçš„è·¯ç”±æ¨¡å¼æœ‰ä¸åŒçš„ setupListener å®ç°ï¼ˆåé¢ä¼šè¯¦ç»†ä»‹ç»ï¼‰

    history.transitionTo(history.getCurrentLocation(), () => {
      history.setupListener()
    })
    

2.  **æ‰§è¡Œ history.listen æ–¹æ³•**ï¼Œç¼“å­˜æ›´æ–° `app._route` çš„å›è°ƒã€‚åç»­æˆ‘ä»¬ä¼šåœ¨ transitionTo æ–¹æ³•ä¸­æ‰§è¡Œè¿™ä¸ªå›è°ƒï¼Œç›®çš„å°±æ˜¯åœ¨ current å¯¹è±¡å˜åŒ–æ—¶æ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹ `app._route` çš„å€¼ã€‚

    history.listen((newRoute) => {
      app._route = newRoute
    })
    

æˆ‘ä»¬ä¹‹å‰ç”¨ `defineReactive` æ–¹æ³•å°†æ ¹å®ä¾‹ä¸Šçš„ \_route å±æ€§å˜æˆäº†ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œå…¶æ•°æ®å˜åŒ–åï¼Œä¼šè§¦å‘ setter åŠ«æŒï¼Œé€šçŸ¥ `<router-view>` å»è‡ªåŠ¨æ¸²æŸ“æ–°çš„ç»„ä»¶

**tipï¼š**ä¸ºä»€ä¹ˆè¦æ‰‹åŠ¨æ›´æ–° `app._route` çš„å€¼å‘¢ï¼Ÿå› ä¸º current æ”¹å˜å¹¶ä¸ä¼šè§¦å‘ \_route çš„æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ current å˜åŒ–æ—¶æ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹ \_route çš„å€¼ï¼Œçœ‹ä¸ªå°ä¾‹å­å°±æ˜ç™½äº†

    // Vue.util.defineReactive(this, '_route', this._router.history.current)
    
    let current = {}; let _route = current; current = {name: 'æ–°å€¼'}; // _route ä»ç„¶æ˜¯ {}
    

push
----

å½“æˆ‘ä»¬é€šè¿‡ `<router-link>` è·³è½¬è·¯ç”±æ—¶ä¼šè§¦å‘æ­¤æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨äº† history å¯¹è±¡ï¼ˆè·¯ç”±å†å²å®ä¾‹ï¼‰çš„ push æ–¹æ³•ï¼Œä¸åŒçš„ mode é€‰é¡¹æœ‰ä¸åŒçš„å®ç°æ–¹å¼

**hashæ¨¡å¼ä¸‹**ï¼Œæˆ‘ä»¬é€šè¿‡ transitionTo æ–¹æ³•åŒ¹é…æ¸²æŸ“æ–°çš„ç»„ä»¶ï¼Œç„¶åé€šè¿‡ `history.pushState`/`location.hash` ï¼ˆä¼˜é›…é™çº§å¤„ç†ï¼‰å¾€è·¯ç”±æ ˆä¸­æ·»åŠ ä¸€æ¡è·¯ç”±è®°å½•ï¼ˆtransitionTo æ–¹æ³•åé¢ä¼šè¯¦ç»†ä»‹ç»ï¼‰

HashHistory ç±»åœ¨ `src/history/hash.js`ä¸­å®ç°

    const supportsPushState = window.history && typeof window.history.pushState === 'function'
    
    class HashHistory extends Base {
      push (location) {
        this.transitionTo(location, () => {
          if (supportsPushState) {
            window.history.pushState({}, '', getUrl(location))
          } else {
            window.location.hash = location
          }
        })
      }
    }
    

**historyæ¨¡å¼ä¸‹**ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯é€šè¿‡ transitionTo æ–¹æ³•åŒ¹é…æ¸²æŸ“æ–°çš„ç»„ä»¶ï¼Œç„¶åé€šè¿‡ `history.pushState` å¾€è·¯ç”±æ ˆä¸­æ·»åŠ ä¸€æ¡è·¯ç”±è®°å½•

Html5History ç±»åœ¨ `src/history/html5.js`ä¸­å®ç°

    class HTML5History extends Base {
      push (location) {
        this.transitionTo(location, () => {
          window.history.pushState({}, '', location)
        })
      }
    }
    

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†åˆ†æä¸€ä¸‹ matcher è·¯ç”±åŒ¹é…å™¨çš„å®ç°

3\. matcher
===========

create-matcher
--------------

createMatcher æ–¹æ³•è¿”å›äº† matchã€addRouteã€addRoutes ç­‰æ–¹æ³•ï¼Œå¯ä»¥åŒ¹é…ã€æ·»åŠ æ–°çš„è·¯ç”±ã€‚ä»–çš„å®šä¹‰åœ¨ `src/create-matcher.js` ä¸­

å…¶ä¸­ match æ–¹æ³•å¯ä»¥æ ¹æ®ä¸€ä¸ª location è·¯å¾„ï¼Œå» createRouteMap æ–¹æ³•è¿”å›çš„ pathMap è·¯ç”±æ˜ å°„è¡¨ä¸­åŒ¹é…åˆ°å¯¹åº”çš„è·¯ç”±ä¿¡æ¯

     export default function createMatcher (routes) {
      // pathListï¼šæ”¶é›†æ‰€æœ‰çš„è·¯ç”±è·¯å¾„ï¼Œ['/', '/a', '/b', '/about', '/about/a', '/about/b']
      // pathMapï¼šæ”¶é›†è·¯å¾„çš„å¯¹åº”è·¯ç”±è®°å½•ï¼Œ['/':{/çš„è®°å½•}, '/a':{/açš„è®°å½•}, '/b':{/bçš„è®°å½•}, '/about':{/aboutçš„è®°å½•}, ...]
      const { pathList, pathMap } = createRouteMap(routes)
    
      // åŠ¨æ€æ·»åŠ å¤šä¸ªè·¯ç”±è§„åˆ™ åœ¨v4.xä¸­å·²åºŸå¼ƒï¼šä½¿ç”¨ router.addRoute() ä»£æ›¿
      function addRoutes (routes) {
        createRouteMap(routes, pathList, pathMap)
      }
      // åŠ¨æ€æ·»åŠ ä¸€æ¡æ–°è·¯ç”±è§„åˆ™
      function addRoute (route) {
        createRouteMap([route], pathList, pathMap)
      }
      // æ ¹æ®ä¸€ä¸ªè·¯å¾„è·å–å¯¹åº”çš„è·¯ç”±ä¿¡æ¯ åœ¨v4.xä¸­å·²åºŸå¼ƒï¼šåˆ é™¤ router.match æ”¹ä¸º router.resolve
      function match (location) {
        return pathMap[location]
      }
    
      return {
        addRoutes,
        addRoute,
        match
      }
    }
    

**createMatcher è§¦å‘æ—¶æœºï¼š**VueRouter ç±»çš„ constructor æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€äº›ç§æœ‰å±æ€§ï¼Œå…¶ä¸­å°±åŒ…æ‹¬`this.matcher` è·¯ç”±åŒ¹é…å™¨å¯¹è±¡ã€‚VueRouter ç±»åœ¨ `src/index.js` ä¸­å®ç°

    class VueRouter {
      constructor (options) {
        // ç”¨æˆ·ä¼ é€’çš„è·¯ç”±é…ç½®
        const routes = options.routes || []
        this.matcher = createMatcher(routes)
          ...
      }
    
      // ç®€åŒ–ç”¨æˆ·è°ƒç”¨å±‚çº§  this.match â‰ˆ this.matcher.match
      match (location) {
        return this.matcher.match(location)
      }
    }
    

**match åº”ç”¨æ—¶æœºï¼š**æˆ‘ä»¬ä¼šåœ¨ transitionTo æ–¹æ³•ä¸­è¿è¡Œ match æ–¹æ³•ï¼Œç”¨ä»¥åŒ¹é…å¯¹åº”çš„è·¯ç”±ä¿¡æ¯ã€‚ç„¶åæ›´æ–° `app._route`ï¼ˆå“åº”å¼å¯¹è±¡ï¼‰ä¸ºæœ€æ–°çš„è·¯ç”±å¯¹è±¡ï¼Œä»è€Œè§¦å‘ setter åŠ«æŒï¼Œé€šçŸ¥ `<router-view>` å»æ¸²æŸ“æ–°çš„ç»„ä»¶

create-route-map
----------------

createMatcher åˆ›å»ºè·¯ç”±åŒ¹é…å™¨æ—¶ï¼Œä¼šç”¨åˆ° createRouteMap æ–¹æ³•å»åˆ›å»ºè·¯ç”±æ˜ å°„å…³ç³»ï¼Œå®ƒçš„å®šä¹‰åœ¨ `src/create-route-map.js` ä¸­

è¯¥æ–¹æ³•æ ¹æ®ç”¨æˆ·ä¼ å…¥çš„ routesé€‰é¡¹ï¼Œè¿”å›äº† pathListï¼ˆæ”¶é›†æ‰€æœ‰çš„è·¯ç”±è·¯å¾„ï¼‰ å’Œ pathMapï¼ˆæ”¶é›†è·¯å¾„çš„å¯¹åº”è·¯ç”±è®°å½•ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„è·¯ç”±æ˜ å°„è¡¨ï¼‰ 2ä¸ªå¯¹è±¡

     // @return pathListï¼šæ”¶é›†æ‰€æœ‰çš„è·¯ç”±è·¯å¾„ï¼Œ['/', '/a', '/b', '/about', '/about/a', '/about/b']
     // @return pathMapï¼šæ”¶é›†è·¯å¾„çš„å¯¹åº”è·¯ç”±è®°å½•ï¼Œ['/':{/çš„è®°å½•}, '/a':{/açš„è®°å½•}, '/b':{/bçš„è®°å½•}, '/about':{/aboutçš„è®°å½•}, ...]
    export default function createRouteMap (routes, pathList, pathMap) {
      // å½“ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™æ²¡æœ‰ pathList å’Œ pathMap
      pathList = pathList || []
      pathMap = pathMap || {}
      routes.forEach(route => {
        addRouteRecord(route, pathList, pathMap)
      })
    
      return {
        pathMap
      }
    }
    
    // æ·»åŠ è·¯ç”±ä¿¡æ¯
    function addRouteRecord (route, pathList, pathMap, parentRecord) {
      const path = parentRecord ? `${parentRecord.path}${parentRecord.path.endsWith('/') ? '' : '/'}${route.path}` : route.path
      const record = {
        path,
        component: route.component,
        props: route.props,
        meta: route.meta,
        parent: parentRecord
      }
    
      // ç»´æŠ¤è·¯å¾„å¯¹åº”çš„å±æ€§
      if (!pathMap[path]) {
        pathList.push(path)
        pathMap[path] = record
      }
    
      route.children && route.children.forEach(childRoute => {
        addRouteRecord(childRoute, pathList, pathMap, record)
      })
    }
    
    

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†åˆ†æä¸€ä¸‹ HashHistoryï¼ˆhashæ¨¡å¼ï¼‰ã€HTML5Historyï¼ˆhistoryæ¨¡å¼ï¼‰å¯¹è±¡çš„å®ç°

4\. è·¯ç”±æ¨¡å¼
========

HashHistory å’Œ Html5History çš„å®ç°æ˜¯ä¸¤ä¸ªç±»ï¼Œä»–ä»¬å‡ç»§æ‰¿è‡ª base åŸºç±»ï¼Œç”±äº base åŸºç±»ä¸­ä¸»è¦æ˜¯è·¯ç”±è·³è½¬ç›¸å…³çš„é€»è¾‘ï¼Œæˆ‘ä»¬æ‰“ç®—åœ¨ä¸‹ä¸€ç« èŠ‚å’Œè·¯ç”±ç»„ä»¶ã€å¯¼èˆªå®ˆå«ä¸€èµ·åˆ†æï¼Œå®ƒåœ¨ `src/history/base.js`ä¸­å®šä¹‰

HashHistory
-----------

hash æ¨¡å¼ï¼Œä¼˜å…ˆä½¿ç”¨ history.pushState/repaceState API æ¥å®Œæˆ URL è·³è½¬å’Œ `onpopstate` äº‹ä»¶ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œä¸æ”¯æŒå†é™çº§ä¸º location.hash API å’Œ `onhashchange` äº‹ä»¶ã€‚åœ¨`src/history/hash.js`ä¸­å®šä¹‰

    import Base from './base'
    
    const supportsPushState = window.history && typeof window.history.pushState === 'function'
    
    class HashHistory extends Base {
      constructor (router) {
        super(router)
    
        // åˆå§‹åŒ– hashè·¯ç”±æ—¶ï¼Œç»™ä¸€ä¸ªé»˜è®¤çš„ hashè·¯å¾„ /
        ensureSlash()
      }
    
      // è·å–hashè·¯å¾„ç‰‡æ®µ http://192.168.21.144/framework-assets#/assets/1522392838?id=1522392838 => '/assets/1522392838?id=1522392838'
      getCurrentLocation () {
        return getHash()
      }
    
      // æ·»åŠ ç›‘å¬å™¨ï¼Œç›‘å¬hashå€¼çš„å˜åŒ–ï¼ˆåœ¨ vueRouterç±»çš„initæ–¹æ³•ä¸­è°ƒç”¨ï¼‰
      // å½“ç”¨æˆ·åœ¨æµè§ˆå™¨ç‚¹å‡»åé€€ã€å‰è¿›ï¼Œæˆ–è€…åœ¨jsä¸­è°ƒç”¨HTML5 history APIã€history.back()ï¼Œhistory.go()ï¼Œhistory.forward()ã€‘ç­‰ï¼Œä¼šè§¦å‘ popstateäº‹ä»¶ å’Œ hashchangeäº‹ä»¶
      // ç”¨æˆ·é€šè¿‡ location.hash = 'xxx' ä¹Ÿä¼šè§¦å‘ popstateäº‹ä»¶ å’Œ hashchangeäº‹ä»¶
      // ä½† history.pushState()ï¼Œhistory.replaceStateï¼ˆï¼‰ä¸ä¼šè§¦å‘è¿™ä¸¤ä¸ªäº‹ä»¶ï¼ï¼ï¼
      setupListener () {
        const eventType = supportsPushState ? 'popstate' : 'hashchange'
        window.addEventListener(eventType, () => {
          this.transitionTo(getHash()) // åˆå§‹åŒ–æ‰§è¡Œçš„ ensureSlashæ–¹æ³•ä¹Ÿä¼šè§¦å‘æ­¤å›è°ƒ
        })
      }
    
      // è·³è½¬é¡µé¢
      // ä¸ºä»€ä¹ˆè¦æ‰‹åŠ¨æ‰§è¡Œ transitionToï¼Œè€Œä¸æ˜¯ç›´æ¥æ”¹å˜åœ°å€ï¼Œé€šè¿‡è·¯ç”±ç›‘å¬å™¨å»é—´æ¥æ‰§è¡Œ transitionToï¼Ÿ
      // å› ä¸º window.history.pushState() ä¸ä¼šè§¦å‘ popstateäº‹ä»¶ï¼ï¼ï¼
      push (location) {
        this.transitionTo(location, () => {
          if (supportsPushState) {
            window.history.pushState({}, '', getUrl(location))
          } else {
            window.location.hash = location
          }
        })
      }
    }
    
    // http://localhost:8080/  ==>  http://localhost:8080/#/
    function ensureSlash () {
      if (window.location.hash) {
        return
      }
      window.location.hash = '/'
    }
    
    // è·å–å½“å‰hashå€¼ï¼ˆå»æ‰ #ï¼‰
    // '#/assets/1522392838?id=1522392838'  ==>  '/assets/1522392838?id=1522392838'
    function getHash () {
      return window.location.hash.slice(1)
    }
    
    // ç»å¯¹è·¯å¾„
    function getUrl (path) {
      const href = window.location.href
      const i = href.indexOf('#')
      const base = i >= 0 ? href.slice(0, i) : href
      return `${base}#${path}`
    }
    
    export default HashHistory
    

### ensureSlash

å½“æˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ª history å¯¹è±¡æ—¶ï¼Œä¼šé»˜è®¤åœ¨ constructor æ„é€ å‡½æ•°ä¸­æ‰§è¡Œ ensureSlash æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰hash å€¼çš„è¯å°±ç»™ä¸€ä¸ªé»˜è®¤çš„ hash è·¯å¾„ `/`ï¼Œç¡®ä¿å­˜åœ¨ hash é”šç‚¹

å…¶ä½œç”¨å°±æ˜¯å°† `http://localhost:8080/` è‡ªåŠ¨ä¿®æ”¹ä¸º `http://localhost:8080/#/`

### setupListener

æ·»åŠ è·¯ç”±ç›‘å¬å™¨ï¼Œå½“ hash å€¼å˜åŒ–æ—¶è°ƒç”¨ transitionTo æ–¹æ³•ç»Ÿä¸€å¤„ç†è·³è½¬é€»è¾‘ã€‚äº‹ä»¶æ³¨å†Œé‡‡ç”¨äº†é™çº§å¤„ç†ï¼Œä¼˜å…ˆä½¿ç”¨ `onpopstate` äº‹ä»¶ï¼Œè‹¥ä¸æ”¯æŒï¼Œåˆ™é™çº§ä½¿ç”¨ `onhashchange` äº‹ä»¶

> å½“ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨çš„åé€€ã€å‰è¿›æŒ‰é’®ï¼Œåœ¨ js ä¸­è°ƒç”¨ HTML5 history APIï¼Œå¦‚ `history.back()`ã€`history.go()`ã€`history.forward()`ï¼Œæˆ–è€…é€šè¿‡ `location.hash = 'xxx'` éƒ½ä¼šè§¦å‘ popstate äº‹ä»¶ å’Œ hashchange äº‹ä»¶  
> éœ€è¦æ³¨æ„çš„æ˜¯è°ƒç”¨ `history.pushState()` æˆ–è€… `history.replaceState()` ä¸ä¼šè§¦å‘ popstate äº‹ä»¶ å’Œ hashchange äº‹ä»¶

**è§¦å‘æ—¶æœºï¼š**åœ¨ vueRouter ç±»çš„ init æ–¹æ³•ä¸­è°ƒç”¨

    class VueRouter {
      // routeråˆå§‹åŒ–æ–¹æ³•ï¼ˆåªä¼šåœ¨ æ ¹vueå®ä¾‹ä¸­çš„ beforeCreateé’©å­ä¸­è°ƒç”¨ä¸€æ¬¡ï¼‰
      init (app) {
        const history = this.history
        // æ‰‹åŠ¨æ ¹æ®å½“å‰è·¯å¾„å»åŒ¹é…å¯¹åº”çš„ç»„ä»¶ï¼Œæ¸²æŸ“ï¼Œä¹‹åç›‘å¬è·¯ç”±å˜åŒ–
        history.transitionTo(history.getCurrentLocation(), () => {
          history.setupListener()
        })
    
        ...
      }
    }
    

### push

è·³è½¬é¡µé¢ï¼Œæ‰‹åŠ¨è°ƒç”¨ transitionTo æ–¹æ³•å»å¤„ç†è·³è½¬é€»è¾‘ï¼Œå¹¶åœ¨å›è°ƒä¸­é€šè¿‡ `history.pushState` æˆ– `location.hash` å‘è·¯ç”±æ ˆæ·»åŠ ä¸€æ¡è·¯ç”±è®°å½•ï¼Œæ›´æ–°åœ°å€æ  URL

**è§¦å‘æ—¶æœºï¼š**å½“æˆ‘ä»¬é€šè¿‡ `<router-link>` è·³è½¬è·¯ç”±æ—¶ä¼šè§¦å‘æ ¹å®ä¾‹ä¸Šçš„ `app._router.push()` æ–¹æ³•ï¼ˆ VueRouter ç±»ä¸­çš„ push æ–¹æ³•ï¼‰ï¼Œå…¶å†…éƒ¨å°±è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œå³ history å¯¹è±¡ï¼ˆè·¯ç”±å†å²å®ä¾‹ï¼‰çš„ push æ–¹æ³•ï¼Œå½“ç„¶ï¼Œä¸åŒçš„ mode é€‰é¡¹æœ‰ä¸åŒçš„å®ç°æ–¹å¼

    class VueRouter {
      // è°ƒç”¨ HashHistory or Html5History çš„è·³è½¬é€»è¾‘ï¼ˆç‚¹å‡»router-linkè§¦å‘ï¼‰
      push (location) {
        // é’ˆå¯¹hashæ¨¡å¼ï¼š history.pushStateã€ä¸æ”¯æŒå†é™çº§ä¸º window.location.hash
        // é’ˆå¯¹historyæ¨¡å¼ï¼š history.pushState
        return this.history.push(location)
      }
    }
    

ä¸ºä»€ä¹ˆè¦æ‰‹åŠ¨æ‰§è¡Œ transitionTo æ–¹æ³•ï¼Ÿè€Œä¸æ˜¯é€šè¿‡ `history.pushState` æˆ– `location.hash` æ”¹å˜è·¯ç”±æ ˆï¼Œç„¶ååˆ©ç”¨ onpopstate äº‹ä»¶ æˆ– onhashchange äº‹ä»¶å»é—´æ¥æ‰§è¡Œ transitionTo æ–¹æ³•å‘¢ â“

ç­”ï¼šå› ä¸º `history.pushState` ä¸ä¼šè§¦å‘ onpopstate äº‹ä»¶ â— è¿™é‡Œå¼•å‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œäº† transitionTo æ–¹æ³•ï¼Œç„¶ååœ¨å›è°ƒä¸­ç”¨ `location.hash` æ”¹å˜è·¯ç”±æ ˆï¼Œå°±åˆä¼šé€šè¿‡ onhashchange äº‹ä»¶å†æ¬¡æ‰§è¡Œ transitionTo æ–¹æ³•ï¼Œè¿™é‡Œé‡å¤æ‰§è¡Œäº† 2 éï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨ transitionTo å†…éƒ¨åšå»é‡å¤„ç†ï¼ˆåé¢ä¼šè¯¦ç»†ä»‹ç»å…¶å»é‡é€»è¾‘ï¼‰

Html5History
------------

history æ¨¡å¼ï¼Œä½¿ç”¨ history.pushState/repaceState API æ¥å®Œæˆ URL è·³è½¬ï¼Œä½¿ç”¨`onpopstate` äº‹ä»¶ç›‘å¬è·¯ç”±å˜åŒ–ã€‚åœ¨`src/history/html5.js`ä¸­å®šä¹‰

    import Base from './base'
    
    class HTML5History extends Base {
      constructor (router) {
        super(router)
      }
    
      // æ·»åŠ ç›‘å¬å™¨ï¼Œç›‘å¬pathnameå˜åŒ–ï¼ˆåœ¨ vueRouterç±»çš„initæ–¹æ³•ä¸­è°ƒç”¨ï¼‰
      // å½“ç”¨æˆ·åœ¨æµè§ˆå™¨ç‚¹å‡»åé€€ã€å‰è¿›ï¼Œæˆ–è€…åœ¨jsä¸­è°ƒç”¨ history.back()ï¼Œhistory.go()ï¼Œhistory.forward()ç­‰ï¼Œä¼šè§¦å‘popstateäº‹ä»¶
      // ä½† pushStateã€replaceStateä¸ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶
      setupListener () {
        window.addEventListener('popstate', () => {
          this.transitionTo(window.location.pathname)
        })
      }
    
      // è·å–pathname  http://192.168.21.144/framework-assets#/assets/1522392838?id=1522392838 => '/framework-assets'
      getCurrentLocation () {
        return window.location.pathname
      }
    
      // è·³è½¬é¡µé¢
      // ä¸ºä»€ä¹ˆè¦æ‰‹åŠ¨æ‰§è¡Œ transitionToï¼Œè€Œä¸æ˜¯ç›´æ¥æ”¹å˜åœ°å€ï¼Œé€šè¿‡è·¯ç”±ç›‘å¬å™¨å»é—´æ¥æ‰§è¡Œ transitionToï¼Ÿ
      // å› ä¸º window.history.pushState() ä¸ä¼šè§¦å‘ popstateäº‹ä»¶ï¼ï¼ï¼
      push (location) {
        this.transitionTo(location, () => {
          window.history.pushState({}, '', location)
        })
      }
    }
    
    export default HTML5History
    

### setupListener

æ·»åŠ è·¯ç”±ç›‘å¬å™¨ï¼Œå½“æ¿€æ´»åŒä¸€æ–‡æ¡£ä¸­ä¸åŒçš„å†å²è®°å½•æ¡ç›®æ—¶ï¼Œè°ƒç”¨ transitionTo æ–¹æ³•ç»Ÿä¸€å¤„ç†è·³è½¬é€»è¾‘ã€‚ä½¿ç”¨äº† `onpopstate` äº‹ä»¶ç›‘å¬è·¯ç”±å˜åŒ–

**è§¦å‘æ—¶æœºï¼š**åœ¨ vueRouter ç±»çš„ init æ–¹æ³•ä¸­è°ƒç”¨

> è°ƒç”¨ `history.pushState()` æˆ–è€… `history.replaceState()` ä¸ä¼šè§¦å‘ popstate äº‹ä»¶

### push

è·³è½¬é¡µé¢ï¼Œæ‰‹åŠ¨è°ƒç”¨ transitionTo æ–¹æ³•å»å¤„ç†è·³è½¬é€»è¾‘ï¼Œå¹¶åœ¨å›è°ƒä¸­é€šè¿‡ `history.pushState` å‘è·¯ç”±æ ˆæ·»åŠ ä¸€æ¡è·¯ç”±è®°å½•ï¼Œæ›´æ–°åœ°å€æ  URL

**è§¦å‘æ—¶æœºï¼š**å½“æˆ‘ä»¬é€šè¿‡ `<router-link>` è·³è½¬è·¯ç”±æ—¶ä¼šè§¦å‘æ ¹å®ä¾‹ä¸Šçš„ `app._router.push()` æ–¹æ³•ï¼ˆ VueRouter ç±»ä¸­çš„ push æ–¹æ³•ï¼‰ï¼Œå…¶å†…éƒ¨å°±è°ƒç”¨äº†è¯¥æ–¹æ³•

ä¸‹ä¸€èŠ‚æˆ‘ä»¬åˆ†æä¸€ä¸‹è·¯ç”±åˆ‡æ¢åˆ°åº•åšäº†å“ªäº›å·¥ä½œ

5\. è·¯ç”±åˆ‡æ¢
========

å½“æˆ‘ä»¬ç‚¹å‡»`<router-link>` è¿›è¡Œè·¯ç”±åˆ‡æ¢æ—¶ï¼Œä¼šé€šè¿‡ push æ–¹æ³•è°ƒç”¨ base åŸºç±»ä¸­çš„ transitionTo æ–¹æ³•å¤„ç†è·³è½¬é€»è¾‘ï¼Œç„¶åè§¦å‘ä¸€ç³»åˆ—çš„å¯¼èˆªå®ˆå«é’©å­ï¼Œå¦‚æœå…¨éƒ¨é’©å­éƒ½æ‰§è¡Œå®Œäº†ï¼Œå°±ä¼šæ›´æ–°æ ¹å®ä¾‹ä¸Šçš„ \_route å“åº”å¼å±æ€§ï¼Œé€šçŸ¥ `<router-view>` å»æ¸²æŸ“æ–°çš„ç»„ä»¶

okï¼æˆ‘ä»¬å…·ä½“åˆ†æä¸‹æ¯ä¸€æ­¥éƒ½æ˜¯å¦‚ä½•å®ç°çš„

router-link
-----------

`<router-link>` å…¨å±€ç»„ä»¶çš„æ³¨å†Œæ˜¯åœ¨ VueRouter ç±»ä¸Šçš„ install æ–¹æ³•ä¸­ï¼Œå…¶ç»„ä»¶å®ç°æ˜¯åœ¨ `src/components/link.js` ä¸­

ç‚¹å‡» `<router-link>` æ—¶ï¼Œä¼šè°ƒç”¨æ ¹å®ä¾‹ä¸Šçš„ `app._router.push()` æ–¹æ³•ï¼ˆå³ VueRouter ç±»ä¸­çš„ push æ–¹æ³•ï¼‰ï¼Œå…¶å†…éƒ¨è°ƒç”¨äº† history å¯¹è±¡ï¼ˆè·¯ç”±å†å²å®ä¾‹ï¼‰çš„ push æ–¹æ³•ï¼ˆå³ HashHistory ç±»æˆ– Html5History ç±»æˆ–ä¸­çš„ push æ–¹æ³•ï¼‰ï¼Œ**å†…éƒ¨æ‰‹åŠ¨è°ƒç”¨ transitionTo æ–¹æ³•å»å¤„ç†è·³è½¬é€»è¾‘ï¼Œå¹¶åœ¨å›è°ƒä¸­é€šè¿‡ history.pushState æˆ– location.hash å‘è·¯ç”±æ ˆæ·»åŠ ä¸€æ¡è·¯ç”±è®°å½•ï¼Œæ›´æ–°åœ°å€æ  URL**

    export default { 
      props: {
        to: { type: String, required: true },
        tag: { type: String, default: 'a' }
      },
      methods: {
        handler () {
          this.$router.push(this.to)
        }
      },
      render () {
        const tag = this.tag
        return <tag style={ { cursor: 'pointer' } } onClick={this.handler}>{this.$slots.default}</tag>
    }
    }
    
    

æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆçœ‹ä¸‹å¯¼èˆªå®ˆå«ï¼Œç„¶åä¸€èµ·åˆ†æ base åŸºç±»ä¸­ transitionTo æ–¹æ³•çš„å†…éƒ¨å®ç°

beforeEach
----------

è¿™é‡Œï¼Œæˆ‘ä»¬åªä»‹ç»å…¨å±€å‰ç½®å®ˆå« beforeEachã€‚ç”¨æˆ·å¯ä»¥æ³¨å†Œå¤šä¸ªå…¨å±€å‰ç½®å®ˆå«

    const router = new VueRouter({ ... })
    
    router.beforeEach((to, from, next) => {
      // ...
      // è¿”å› false ä»¥å–æ¶ˆå¯¼èˆª
      return false
    })
    
    router.beforeEach((to, from) => {
      // ...
      // è¿”å› false ä»¥å–æ¶ˆå¯¼èˆª
      return false
    })
    

å½“ä¸€ä¸ªå¯¼èˆªè§¦å‘æ—¶ï¼Œå…¨å±€å‰ç½®å®ˆå«æŒ‰ç…§åˆ›å»ºé¡ºåºè°ƒç”¨ã€‚å®ˆå«æ˜¯å¼‚æ­¥è§£ææ‰§è¡Œï¼Œæ­¤æ—¶å¯¼èˆªåœ¨æ‰€æœ‰å®ˆå« resolve å®Œä¹‹å‰ä¸€ç›´å¤„äº**ç­‰å¾…ä¸­**ã€‚å®ˆå«æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°

*   **to:** å³å°†è¦è¿›å…¥çš„ç›®æ ‡è·¯ç”±
*   **from:** å½“å‰å¯¼èˆªæ­£è¦ç¦»å¼€çš„è·¯ç”±
*   **nextï¼š** è¿›è¡Œç®¡é“ä¸­çš„ä¸‹ä¸€ä¸ªå®ˆå«é’©å­

æˆ‘ä»¬éœ€è¦ç”¨ `beforeEachHooks` æ•°ç»„æ¥æ”¶é›†ç”¨æˆ·æ³¨å†Œçš„å®ˆå«é’©å­ï¼Œåç»­ä¼šåœ¨ transitionTo æ–¹æ³•ä¸­ä¾æ¬¡æ‰§è¡Œ

    class VueRouter {
      constructor (options) {
        this.beforeEachHooks = []
        ...
      }
    
      // è·¯ç”±å®ˆå«ï¼Œç¼“å­˜å›è°ƒé’©å­ï¼Œåœ¨ transitionToæ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒé’©å­
      beforeEach (cb) {
        this.beforeEachHooks.push(cb)
      }
    }
    

**æ³¨æ„ï¼åªæœ‰å½“å…¨éƒ¨é’©å­éƒ½æ‰§è¡Œå®Œäº†ï¼Œæ‰ä¼šå»æ¸²æŸ“æ–°çš„è·¯ç”±ç»„ä»¶**

    transitionTo (location, listener) {
    	const record = this.router.match(location) // åŒ¹é…è·¯ç”±è®°å½•
      const route = createRoute(record, { path: location }) // ç”Ÿæˆè·¯ç”±å¯¹è±¡
      
      const queue = [].concat(this.router.beforeEachHooks)
      runQueue(queue, this.current, route, () => {
        this.current = route // æ›´æ–°å½“å‰çš„ currentå¯¹è±¡ï¼Œ ç¨åæˆ‘ä»¬å°±å¯ä»¥åˆ‡æ¢é¡µé¢æ˜¾ç¤º
        listener && listener() // æ·»åŠ è·¯ç”±ç›‘å¬å™¨ or æ›´æ”¹åœ°å€æ url
        this.cb && this.cb(route) // æ›´æ–° app._route
      })
    }
    
    function runQueue (queue, from, to, cb) {
      function step (index) {
        if (index >= queue.length) return cb()
        const hook = queue[index] // hookå°±æ˜¯æˆ‘ä»¬çš„é’©å­æ–¹æ³•
        hook(from, to, () => step(index + 1)) // ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ nextæ–¹æ³•
      }
      step(0)
    }
    

base
----

base æ˜¯ HashHistory å’Œ Html5History çš„åŸºç±»ï¼Œä¸»è¦è´Ÿè´£ç»Ÿä¸€å¤„ç†è·¯ç”±è·³è½¬é€»è¾‘ï¼Œå®ƒåœ¨ `src/history/base.js`ä¸­å®šä¹‰ã€‚**è®©æˆ‘ä»¬é‡ç‚¹æ¥åˆ†æä¸‹ transitionTo çš„å†…éƒ¨å®ç°**

    class Base {
      constructor (router) {
        this.router = router
        this.current = createRoute(null, {
          path: '/'
        })
      }
    
      // ç¼“å­˜æ›´æ–°_routeçš„å›è°ƒï¼ˆthis._route = routeï¼‰
      listen (cb) {
        this.cb = cb
      }
    
      // æ‰€æœ‰çš„è·³è½¬é€»è¾‘éƒ½åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®ç°
      // æ ¹æ®è·¯å¾„åŒ¹é…å¯¹åº”çš„è·¯ç”±è®°å½•ï¼Œç„¶åæ›´æ–°å½“å‰çš„ currentå¯¹è±¡ å’Œ app._routeå¯¹è±¡ã€‚
      // æˆ‘ä»¬ä¹‹å‰ç”¨ defineReactive å°† app._route å˜æˆäº†å“åº”å¼å¯¹è±¡ï¼Œapp._routeå‘ç”Ÿå˜åŒ–åï¼Œä¼šè§¦å‘ setter åŠ«æŒï¼Œé€šçŸ¥ router-view é‡æ–°æ¸²æŸ“æ–°è·¯å¾„çš„ç»„ä»¶
      transitionTo (location, listener) {
        // æ ¹æ®ä¸€ä¸ªè·¯å¾„åŒ¹é…å¯¹åº”çš„è·¯ç”±ä¿¡æ¯
        const record = this.router.match(location)
    
        const route = createRoute(record, { path: location })
    
        // å»é‡ï¼šå½“å‰è·³è½¬çš„è·¯å¾„location å’Œ æˆ‘ä»¬ä¹‹å‰å­˜çš„current.path ç›¸åŒï¼Œè€Œä¸”åŒ¹é…ç»“æœä¹Ÿç›¸åŒï¼ˆåˆå§‹åŒ–path:'/'éœ€è¦é¢å¤–åˆ¤æ–­åŒ¹é…ç»“æœmatchedï¼‰ï¼Œåˆ™ä¸å†è·³è½¬äº†
        if (location === this.current.path && route.matched.length === this.current.matched.length) {
          return
        }
        // å¦‚æœæ˜¯ hashæ¨¡å¼ï¼Œå¹¶ä¸”ä½¿ç”¨ hashchangeç›‘å¬è·¯ç”±æ—¶ï¼Œåˆå§‹åŒ–é¡µé¢ å’Œ é€šè¿‡route-linkè·³è½¬é¡µé¢æ—¶
        // transitionToæ–¹æ³•æ‰§è¡Œäº†ä¸¤æ¬¡ï¼ˆæ­¤å¤„æ‰“å°äº†ä¸¤éï¼‰ï¼Œéœ€è¦å»é‡å¤„ç†ï¼Œå½“å‰è·³è½¬çš„è·¯ç”±location å’Œ ä¸Šæ¬¡çš„è·³è½¬çš„è·¯ç”±ï¼ˆv3ä¸­å®ç°æ­¤å±æ€§ï¼‰ä½œæ¯”è¾ƒï¼›è‹¥ä¸€è‡´ï¼Œåˆ™return
        console.log('transitionToï¼ˆrecordï¼‰', record, route)
    
        const queue = [].concat(this.router.beforeEachHooks) // æˆ‘ä»¬å¯èƒ½æœ‰å¤šä¸ªé’©å­
        runQueue(queue, this.current, route, () => {
          this.current = route // æ›´æ–°å½“å‰çš„ currentå¯¹è±¡ï¼Œ ç¨åæˆ‘ä»¬å°±å¯ä»¥åˆ‡æ¢é¡µé¢æ˜¾ç¤º
    
          // æ·»åŠ è·¯ç”±ç›‘å¬å™¨ or æ›´æ”¹åœ°å€æ url
          listener && listener()
    
          // æ›´æ–° app._route
          this.cb && this.cb(route)
        })
      }
    }
    
    export default Base
    
    /**
     * @desc æ ¹æ®æ ‘å½¢ç»“æ„recordè·¯ç”±ä¿¡æ¯ è¿”å›ä¸€ä¸ª æ‰å¹³åŒ–çš„ä¸Šä¸‹çº§è·¯ç”±æ•°æ®
     * è¿”å›ç¤ºä¾‹ï¼š{path:'/', matched:[]}
     * è¿”å›ç¤ºä¾‹ï¼š{path:'/about/a', matched:[aboutRecord, aboutARecord]}
     */
    function createRoute (record, location) {
      const matched = []
      if (record) {
        while (record) {
          matched.unshift(record) // [about, about/a]
          record = record.parent
        }
      }
      return {
        ...location,
        matched
      }
    }
    
    /**
     * @name æ‰§è¡Œè·¯ç”±å®ˆå«é’©å­
     * @desc å¦‚æœæœ‰å¤šä¸ªbeforeEaché’©å­ï¼Œåªæœ‰åœ¨ä¸Šä¸€ä¸ªé’©å­ä¸­æ‰§è¡Œäº†nextæ–¹æ³•ï¼Œæˆ‘ä»¬æ‰ä¼šè¿è¡Œä¸‹ä¸€ä¸ªé’©å­
     * @desc åªè¦æœ‰ä¸€ä¸ªé’©å­æœªæ‰§è¡Œnextæ–¹æ³•ï¼Œåˆ™ç»ˆæ­¢ï¼ˆåç»­çš„é’©å­ã€è·³è½¬é€»è¾‘å‡ä¸æ‰§è¡Œï¼‰
     */
    function runQueue (queue, from, to, cb) {
      function step (index) {
        if (index >= queue.length) return cb()
        const hook = queue[index] // hookå°±æ˜¯æˆ‘ä»¬çš„é’©å­æ–¹æ³•
        hook(from, to, () => step(index + 1)) // ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ nextæ–¹æ³•
      }
      step(0)
    }
    

è®©æˆ‘ä»¬æ ¹æ®ä¸€ä¸ªå…·ä½“åœºæ™¯å»è¿›è¡Œåˆ†æï¼Œå‡å¦‚æˆ‘ä»¬è¦è·³è½¬`http://localhost:8080/about/a` URLï¼Œè·¯ç”±é…ç½®å¦‚ä¸‹ï¼š

    const routes = [
      {
        path: '/about',
        name: 'About',
        component: About,
        children: [
          {
            path: 'a',
            component: {
              render: (h) => <h2>about a</h2>
            }
          },
        ]
      },
      ...
    ]
    

1.  é¦–å…ˆä¼šé€šè¿‡ `router.match()` æ ¹æ®è·¯å¾„ `/about/a` å»åŒ¹é…å¯¹åº”çš„è·¯ç”±è®°å½• recordï¼Œmatch æ–¹æ³•æ˜¯ä¹‹å‰ç”± createMatcher ç”Ÿæˆçš„ï¼Œrecord è·¯ç”±è®°å½•ç»“æ„å¦‚ä¸‹ï¼Œæ­¤å¤„ä»…å±•ç¤ºéƒ¨åˆ†å±æ€§

    {
      "path": "/about/a",
      "component": { about/a ç»„ä»¶å®šä¹‰ },
      "parent": {
        "path": "/about",
        "component": { about ç»„ä»¶å®šä¹‰ }
      }
    }
    

2.  ç„¶åé€šè¿‡ `createRoute()` ç”Ÿæˆä¸€ä¸ªæ‰å¹³åŒ–çš„ä¸Šä¸‹çº§è·¯ç”±æ•°æ® routeï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ `this.$route` è·¯ç”±å¯¹è±¡ï¼Œroute å¯¹è±¡æ ¼å¼å¦‚ä¸‹ï¼Œæ­¤å¤„ä»…å±•ç¤ºéƒ¨åˆ†å±æ€§

    {
      "path": "/about/a",
      "matched": [
      	{
      		"path": "/about",
      		"component": { about ç»„ä»¶å®šä¹‰ }
    		},
    		{
      		"path": "/about/a",
      		"component": { about/a ç»„ä»¶å®šä¹‰ },
      		"parent": {
        			"path": "/about",
        			"component": { about ç»„ä»¶å®šä¹‰ }
      		}
    		}
    	]	
    }
    

3.  è·³è½¬ä¸€æ¬¡è·¯ç”±æœ‰å¯èƒ½ä¼šå¤šæ¬¡æ‰§è¡Œ transitionTo æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšå»é‡å¤„ç†ï¼Œå¦‚æœå½“å‰è·³è½¬çš„è·¯å¾„å’Œæˆ‘ä»¬ä¹‹å‰ç¼“å­˜çš„ç›¸åŒï¼Œåˆ™ return
4.  **å¦‚æœå…¨éƒ¨å¯¼èˆªå®ˆå«é’©å­éƒ½æ‰§è¡Œå®Œäº†**ï¼Œåˆ™æ›´æ–°å½“å‰çš„ current å¯¹è±¡ï¼Œå¹¶æ›´æ–°æ ¹å®ä¾‹ä¸Šçš„ \_route å“åº”å¼å¯¹è±¡ï¼Œç„¶åé€šçŸ¥ `<router-view>` å»æ¸²æŸ“æ–°çš„è·¯ç”±ç»„ä»¶ï¼Œè‡³äº`<router-view>` æ˜¯å¦‚ä½•å»æ¸²æŸ“æ–°ç»„ä»¶çš„ï¼Œæˆ‘ä»¬ä¸‹ä¸€ç« èŠ‚å†å»åˆ†æ

router-view
-----------

`<router-view>` å…¨å±€ç»„ä»¶çš„æ³¨å†Œä¹Ÿæ˜¯åœ¨ VueRouter ç±»ä¸Šçš„ install æ–¹æ³•ä¸­ï¼Œå…¶ç»„ä»¶å®ç°æ˜¯åœ¨ `src/components/view.js` ä¸­

    export default {
      functional: true,
      render (h, { parent, data }) {
        // é»˜è®¤å…ˆæ¸²æŸ“ app.vueä¸­çš„ router-viewï¼›å†æ¸²æŸ“ Home æˆ– Aboutä¸­çš„ router-view
    
        data.routerView = true // æ ‡è¯†è¯¥ç»„ä»¶æ˜¯é€šè¿‡ route-view æ¸²æŸ“å‡ºæ¥çš„
        const route = parent.$route // install.jsä¸­ä»£ç†çš„$route
    
        let depth = 0
        while (parent) {
          // $vnode æŒ‡çš„æ˜¯ç»„ä»¶æœ¬èº«è™šæ‹ŸDOM
          if (parent.$vnode && parent.$vnode.data.routerView) {
            depth++
          }
          parent = parent.$parent // ä¸åœçš„å‘ä¸ŠæŸ¥æ‰¾çˆ¶ç»„ä»¶
        }
    
        // matchedæ˜¯ä¸€ä¸ªåŒ…å«ä¸Šä¸‹çˆ¶å­è·¯ç”±è®°å½•çš„æ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š[aboutRecord, aboutARecord]
        const record = route.matched[depth]
    
        // æ²¡æœ‰åŒ¹é…åˆ°ç»„ä»¶ç›´æ¥return
        if (!record) {
          return h()
        }
    
        return h(record.component, data)
      }
    }
    
    

é‚£ä¹ˆè·³è½¬è·¯ç”±åï¼Œ`<router-view>`åˆæ˜¯å¦‚ä½•çŸ¥é“å»æ¸²æŸ“æ–°ç»„ä»¶çš„å‘¢ï¼Ÿä½•æ—¶æ¸²æŸ“ï¼Ÿæ¸²æŸ“å“ªä¸€ä¸ªç»„ä»¶ï¼Ÿ

**å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä½•æ—¶å»æ¸²æŸ“ï¼Ÿ**

æˆ‘ä»¬ä¹‹å‰ç”¨ `defineReactive` æ–¹æ³•å°†æ ¹å®ä¾‹ä¸Šçš„ \_route å±æ€§å˜æˆäº†ä¸€ä¸ª**å“åº”å¼å¯¹è±¡**ï¼Œå¹¶åœ¨ Vue åŸå‹ä¸Šä»£ç†äº† `$route` å±æ€§ã€‚è€Œ`<router-view>` ç»„ä»¶çš„ render å‡½æ•°å¼•ç”¨äº† `$route` å±æ€§ï¼Œæ‰€ä»¥å½“ \_route å˜åŒ–åï¼Œä¼šè§¦å‘ setter åŠ«æŒï¼Œé€šçŸ¥ `<router-view>` å»è‡ªåŠ¨æ¸²æŸ“æ–°çš„ç»„ä»¶

    beforeCreate () {
      if (this.$options.router) {
        Vue.util.defineReactive(this, '_route', this._router.history.current)
      }
    }
    
    Object.defineProperty(Vue.prototype, '$route', {
      get () {
        return this._routerRoot && this._routerRoot._route
      }
    })
    

**ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä»–æ€ä¹ˆçŸ¥é“æ¸²æŸ“å“ªä¸ªç»„ä»¶ï¼Ÿ**

`$route` å¯¹è±¡çš„ matched å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«ä¸Šä¸‹çˆ¶å­è·¯ç”±è®°å½•çš„æ•°ç»„ï¼Œåœ¨ transitionTo æ–¹æ³•ä¸­è¢«åˆ›å»º

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå…·ä½“çš„è·¯ç”±é…ç½®ï¼š

    const routes = [
      {
        path: '/about',
        name: 'About',
        component: About,
        children: [
          {
            path: 'a', // childrenä¸­è·¯å¾„ä¸èƒ½å¢åŠ  /
            component: {
              render: (h) => <h2>about a</h2>
            }
          },
        ]
      },
    	...
    ]
    

å½“æˆ‘ä»¬è®¿é—® `http://localhost:8080/about/a` URLæ—¶ï¼Œ \_route å¯¹è±¡ï¼ˆå³ this.$routeï¼‰æ ¼å¼å¦‚ä¸‹ï¼š

    {
      "path": "/about/a",
    	"matched": [
      	{
        	"path": "/about",
        	"component": { about ç»„ä»¶å®šä¹‰ }
      	},
      	{
        	"path": "/about/a",
        	"component": { about/a ç»„ä»¶å®šä¹‰ },
        	"parent": {
          	"path": "/about",
          	"component": { about ç»„ä»¶å®šä¹‰ }
        	}
      	}
    	]
    }
    

`<router-view>` ä¸­ render å‡½æ•°æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¼šä¸åœçš„å‘ä¸ŠæŸ¥æ‰¾çˆ¶ç»„ä»¶ï¼Œçœ‹æ˜¯å¦æœ‰ `routerView` æ ‡è¯†ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™ç´¢å¼•æ·±åº¦ `depth + 1`ï¼Œç„¶åæ¸²æŸ“ `h(route.matched[depth].component, data)`ã€‚

ç»„ä»¶çš„æ¸²æŸ“æ˜¯æ ‘çŠ¶çš„ï¼Œé»˜è®¤å…ˆæ¸²æŸ“ app.vue ä¸­çš„ `<router-view>`ï¼Œ `h(route.matched[0].component, data)`ï¼Œå³ About ç»„ä»¶ï¼›å†æ¸²æŸ“ About ä¸­çš„ `<router-view>`ï¼Œ`h(route.matched[1].component, data)`ï¼Œå³ About/a ç»„ä»¶

6\. å‚è€ƒé“¾æ¥
========

[æµ…æ˜¾æ˜“æ‡‚çš„vue-routeræºç è§£æ(ä¸€)](https://zhuanlan.zhihu.com/p/365641816)

[vue-router æºç åˆ†æ - æå®‡ä»“ | Li Yucang](https://liyucang-git.github.io/2019/08/15/vue-router%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/)

[ç å³°å…¬å¼€è¯¾ | vue-router æºç ](https://www.bilibili.com/video/BV1JW4y1j7yE?p=53&vd_source=3803914bc772ed7f1b00bb23000e9282)

äººé—´ä¸æ­£ç»ç”Ÿæ´»æ‰‹å†Œ