---
layout: post
title: "èŠä¸€èŠ Rust çš„ stack overflow"
date: "2023-06-22T01:16:29.303Z"
---
èŠä¸€èŠ Rust çš„ stack overflow
-------------------------

æ—©ä¸Šçœ‹åˆ°äº†è¿™ç¯‡æ–‡ç«  [æ™ºèƒ½æŒ‡é’ˆæœ‰å¯èƒ½ä¼šè®©ä½ çš„åº”ç”¨å´©æºƒ](https://mp.weixin.qq.com/s/HB3RHJBhrhKCp4mToPC2nw), ä¸‹é¢åˆ†æä¸€ä¸‹

ä¼šå¯¼è‡´ stack overflow çš„ä»£ç 

    struct Node<T> {
        val: T,
        next: Option<Box<Node<T>>>,
    }
    struct LinkedList<T> {
        head: Option<Box<Node<T>>>,
    }
    impl<T> LinkedList<T> {
        fn new() -> Self {
            Self { head: None }
        }
        fn push_front(&mut self, val: T) {
            let next = self.head.take();
            self.head = Some(Box::new(Node { val, next }));
        }
    }
    
    fn main() {
        let mut list = LinkedList::new();
        for i in 0..1000000 {
            list.push_front(i);
        }
    }
    

playground: [https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=dfb32796d46df05fd6bcc4855fc11ae1](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=dfb32796d46df05fd6bcc4855fc11ae1)

è¾“å‡ºçš„ç»“æœ:

    thread 'main' has overflowed its stack
    fatal runtime error: stack overflow
    timeout: the monitored command dumped core
    /playground/tools/entrypoint.sh: line 11:     8 Aborted                 timeout --signal=KILL ${timeout} "$@"
    

åŸæ–‡ä¸­ç»™å‡ºäº†è§£é‡Š:

> ç¨‹åºå´©æºƒæ˜¯å› ä¸ºLinkedListçš„æ™ºèƒ½æŒ‡é’ˆå¤´éƒ¨çš„é»˜è®¤é‡Šæ”¾å¯¼è‡´å¯¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„é€’å½’è°ƒç”¨ï¼Œè¿™ä¸æ˜¯å°¾é€’å½’çš„ï¼Œæ— æ³•ä¼˜åŒ–ã€‚ä¿®å¤æ–¹æ³•æ˜¯æ‰‹åŠ¨è¦†ç›–LinkedListæ•°æ®ç»“æ„çš„ææ„å‡½æ•°æ–¹æ³•ï¼Œè¿­ä»£åœ°é‡Šæ”¾æ¯ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸éœ€è¦é€’å½’ã€‚ä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œè¿™è¿èƒŒäº†æ™ºèƒ½æŒ‡é’ˆçš„ç›®çš„â€”â€”å®ƒä»¬æ— æ³•ä»ç¨‹åºå‘˜é‚£é‡Œè§£æ”¾æ‰‹åŠ¨å†…å­˜ç®¡ç†çš„è´Ÿæ‹…ã€‚

ä½†æ˜¯è¿™ä¸ªè§£é‡Šè¿˜ä¸å¤Ÿç›´è§‚ï¼Œä¹Ÿæ²¡æœ‰ç»™å‡ºä¿®å¤ä»£ç 

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·ä»¥æ›´ç›´ç™½çš„æ–¹å¼çœ‹çœ‹è¿™ä¸ª LinkedList è¢« Drop æ—¶åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆ

æˆ‘ä»¬å…ˆç»™ `Node<T>` å’Œ `LinkedList<T>` åŠ ä¸Š `Drop trait`, æ–¹ä¾¿æˆ‘ä»¬è§‚å¯Ÿä»£ç æ‰§è¡Œè¿‡ç¨‹

    struct Node<T> {
        val: T,
        next: Option<Box<Node<T>>>,
    }
    struct LinkedList<T> {
        head: Option<Box<Node<T>>>,
    }
    impl<T> LinkedList<T> {
        fn new() -> Self {
            Self { head: None }
        }
        fn push_front(&mut self, val: T) {
            let next = self.head.take();
            self.head = Some(Box::new(Node { val, next }));
        }
    }
    
    impl<T> Drop for Node<T> {
        fn drop(&mut self) {
            println!("drop node begin");
            let _ = self.next.take();
            println!("drop node end");
        }
    }
    
    impl<T> Drop for LinkedList<T> {
        fn drop(&mut self) {
            println!("drop linkedlist begin");
            let _ = self.head.take();
            println!("drop linkedlist end");
        }
    }
    
    fn main() {
        let mut list = LinkedList::new();
        for i in 0..1000000 {
            list.push_front(i);
        }
        println!("EOF");
    }
    

playground: [https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=61f7aad2bf8ddcd133a146cd88744e97](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=61f7aad2bf8ddcd133a146cd88744e97)

æŸ¥çœ‹æ‰§è¡Œç»“æœ:

    thread 'main' has overflowed its stack
    fatal runtime error: stack overflow
    timeout: the monitored command dumped core
    /playground/tools/entrypoint.sh: line 11:     7 Aborted                 timeout --signal=KILL ${timeout} "$@"
    

è·ŸåŸæ¥çš„ä»£ç ä¸€è‡´

æŸ¥çœ‹æ ‡å‡†è¾“å‡º:

    EOF
    drop linkedlist begin
    drop node begin
    drop node begin
    drop node begin
    (...)
    drop node begin
    

çœç•¥å¤„å…¨éƒ¨éƒ½æ˜¯ `drop node begin`, å¯è§æˆ‘ä»¬çš„ç¨‹åºåœ¨é“¾å¼è°ƒç”¨ `Node<T>` çš„ `drop` å‡½æ•°ã€‚å› ä¸º `drop` ä¸€ä¸ª `Node` å°±æ˜¯ä¾æ¬¡ `drop` å®ƒå†…éƒ¨çš„ `fields`(`val` å’Œ `next`)ï¼Œå½“æ‰€æœ‰ `fields` è¢« `drop` å®Œäº†ï¼Œè¿™ä¸ª `Node` ç»“æ„ä¹Ÿå°±ç®—è¢«é‡Šæ”¾äº†

é—®é¢˜å°±åœ¨å®ƒå†…éƒ¨è¿™ä¸ª `next`ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾æ¡ï¼Œæ›´å‡†ç¡®çš„è¯´åº”è¯¥æ˜¯ä¸€ä¸ªå¥—å¨ƒğŸª†æˆ–æ˜¯æ´‹è‘±ğŸ§…ï¼è€Œé»˜è®¤çš„ `Drop` æœºåˆ¶æ˜¯ä»å†…éƒ¨(`fields`)å‘å¤–å±‚ä¾æ¬¡é‡Šæ”¾ï¼Œå½“æˆ‘éœ€è¦å‰¥æ‰æœ€å¤–å±‚æ—¶ï¼Œå´è¦ç­‰å®ƒé‡Œé¢é‚£ä¸€å±‚å…ˆå‰¥å®Œï¼Œé‡Œé¢çš„ä¸€å±‚åˆè¦ç­‰æ›´é‡Œé¢çš„ä¸€å±‚...... å½“å±‚æ•°è¿‡å¤šæ—¶å°±å¯¼è‡´äº†ä¸Šé¢çš„ `stack overflow`

çŸ¥é“äº†åŸå› ï¼Œæ”¹èµ·æ¥å°±ç®€å•äº†ï¼Œè¦å‰¥å“ªä¸€å±‚å°±ç›´æ¥å‰¥ï¼Œä¸è¦ç­‰å…¶å®ƒå±‚ï¼Œçœ‹ä»£ç :

    // å¯ä»¥ä¸å†™ï¼Œå› ä¸º LinkedList<T> çš„ drop å·²ç»æŠŠè¿™é‡Œçš„ next ç½®ä¸º None äº†ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºå‡½æ•°è°ƒç”¨è¿‡ç¨‹
    impl<T> Drop for Node<T> {
        fn drop(&mut self) {
            println!("drop node begin");
            let _ = self.next.take();
            println!("drop node end");
        }
    }
    
    impl<T> Drop for LinkedList<T> {
        fn drop(&mut self) {
            println!("drop linkedlist begin");
            // let _ = self.head.take();
            let mut node = self.head.take(); // Some(Box<Node>)
            while let Some(mut inner) = node {
                // inner is Box<Node{val, next: Some()}>
                node = inner.next.take(); // inner.next is None
            } // drop inner
            println!("drop linkedlist end");
        }
    }
    

playground: [https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=b8cce86d16ee776516e14fd031e75c6c](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=b8cce86d16ee776516e14fd031e75c6c)

æŸ¥çœ‹è¾“å‡ºç»“æœ:

    EOF
    drop linkedlist begin
    drop node begin
    drop node end
    drop node begin
    drop node end
    (...)
    drop linkedlist end
    

å¯è§æˆ‘ä»¬çš„å¥—å¨ƒå·²ç»è¢«ä¸€å±‚å±‚å‰¥å¼€äº†

é—®é¢˜
==

è¿™ä¸ª `LinkedList` çš„ä¾‹å­æ¯”è¾ƒç®€å•ï¼Œå¯¹äºå®ƒçš„ `stack overflow` æˆ‘ä»¬ä»”ç»†ä¸€æ¨æ•²å°±èƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬çš„ç¨‹åºè¿è¡Œäº†ä¸€å¹´åŠè½½éƒ½æ²¡é—®é¢˜ï¼Œå¿½ç„¶æœ‰ä¸€å¤©å°± `stack overflow` äº†ï¼Œå¹¶ä¸”è¿˜æ²¡å•¥çº¿ç´¢ï¼Œè¿™ä¸ªæ—¶å€™è¯¥å’‹æ•´ï¼Œæƒ³æƒ³éƒ½è®©äººå¤´å¤§ã€‚

æ‰€ä»¥ï¼Œèƒ½å¦åœ¨ `stack overflow` å‘ç”Ÿæ—¶è·å–åˆ°å‡½æ•°è°ƒç”¨æ ˆ(`backtrace`) å‘¢?

å¸¦ç€è¿™ä¸ªé—®é¢˜ä¸€é¡¿æœç´¢, æ‰¾åˆ°ä¸¤ä¸ªè®¨è®ºè¿™ä¸ªé—®é¢˜çš„é“¾æ¥:

[How to diagnose a `stack overflow` issueâ€™s cause?](https://users.rust-lang.org/t/how-to-diagnose-a-stack-overflow-issues-cause/17320)

[Great stack overflow error messages](https://github.com/rust-lang/rust/issues/51405)

åé¢è¿™ä¸ª issue ä¸­æœ‰äººç»™å‡ºäº†ä¸€ä¸ª crate: [backtrace-on-stack-overflow](https://crates.io/crates/backtrace-on-stack-overflow), ç›®å‰è¿™ä¸ª crate ä¸æ”¯æŒ Windows

    Î» bat src/main.rs
    fn main() {
        unsafe { backtrace_on_stack_overflow::enable() };
        f(92)
    }
    
    fn f(x: u64) {
        f(x)
    }
    Î» cargo run
        Finished dev [unoptimized + debuginfo] target(s) in 0.01s
         Running `target/debug/so`
    Stack Overflow:
       0: backtrace_on_stack_overflow::handle_sigsegv
                 at /home/matklad/p/backtrace-on-stack-overflow/src/lib.rs:33:40
       1: <unknown>
       2: so::f
                 at src/main.rs:6
       3: so::f
                 at src/main.rs:7:5
       4: so::f
                 at src/main.rs:7:5
       5: so::f
                 at src/main.rs:7:5
       6: so::f
                 at src/main.rs:7:5
       7: so::f
                 at src/main.rs:7:5
       8: so::f
                 at src/main.rs:7:5
       9: so::f
                 at src/main.rs:7:5
      10: so::f
                 at src/main.rs:7:5
    

![](https://img2023.cnblogs.com/blog/342816/202306/342816-20230614182318243-1514579333.png)

+V d2h5X251bGw= è¯·å¤‡æ³¨ï¼šfromåšå®¢å›­

posted on 2023-06-21 17:30Â  [æ˜å¤©æœ‰é£å¹](https://www.cnblogs.com/hangj/)Â  é˜…è¯»(124)Â  è¯„è®º(0)Â  [ç¼–è¾‘](https://i.cnblogs.com/EditPosts.aspx?postid=17496798)Â  [æ”¶è—](javascript:void(0))Â  [ä¸¾æŠ¥](javascript:void(0))