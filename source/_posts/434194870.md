---
layout: post
title: "[Qtå¼€å‘]ä¸€å£æ°”ææ‡‚ä¸²å£é€šä¿¡"
date: "2023-06-12T01:19:57.675Z"
---
\[Qtå¼€å‘\]ä¸€å£æ°”ææ‡‚ä¸²å£é€šä¿¡
=================

ğŸŠğŸŠğŸŠğŸŠğŸŠå¥½å¤šå°é³„é±¼

ä¸€ã€å…³äºä¸²å£é€šä¿¡ï¼š
=========

Qtçš„ç¡®æœ‰è‡ªå·±çš„ä¸²å£é€šä¿¡ç±»ï¼Œå°±æ˜¯QSerialPortï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å› ä¸ºè¦æ›´åŠ å®šåˆ¶åŒ–çš„ä½¿ç”¨ä¸²å£é€šä¿¡ç±»å‡å°å¼€å‘çš„éš¾åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæä¾›ä¸€ä¸ªä¸²å£é€šä¿¡ç±»ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªSerialPortHelperç±»ã€‚

é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ä»€ä¹ˆæ˜¯ä¸²å£ï¼Œä¸²å£é€šä¿¡å°±æ˜¯æœºå™¨å’Œç³»ç»Ÿä¹‹é—´çš„ä¸€ä¸ªé€šä¿¡åè®®ï¼Œä½ å¯ä»¥å°†å®ƒç†è§£ä¸ºå…±äº«å†…å­˜ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å‘å…¶ä¸­å†™å…¥å†…å®¹ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™ä»ä¸­è¯»å–æ•°æ®ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨Qtçš„å°è£…ä¸‹ï¼Œä½ ä¸éœ€è¦çŸ¥é“ä¸²å£å†…çš„æ•°æ®æ˜¯å¦æ˜¯ç»™ä½ çš„ï¼Œè¿˜æ˜¯ä½ å‘çš„ï¼Œå› ä¸ºç»Ÿç»Ÿéƒ½æ˜¯ä½ çš„ã€‚

ä¸²å£é€šä¿¡ä»€ä¹ˆï¼Ÿ
-------

å¤§æ¦‚äº†è§£äº†ä¸€ä¸‹ä»€ä¹ˆæ˜¯ä¸²å£é€šä¿¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸²å£é€šä¿¡çš„é€šä¿¡æ‰‹å†Œå¤§æ¦‚æ˜¯ä»€ä¹ˆæ ·ã€‚

![image](https://img2023.cnblogs.com/blog/3013923/202306/3013923-20230611201043929-1799994630.png)

ç”±ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸²å£é€šä¿¡æ¶ˆæ¯å¤§æ¦‚å°±æ˜¯ä¸€ä¸²16è¿›åˆ¶çš„å­—ç¬¦æŒ‰ç…§ç‰¹å®šçš„è§„å®šï¼Œç„¶åå‘ä¸²å£ä¸­å†™å…¥è¿™äº›æ¶ˆæ¯å°±å¯ä»¥äº†ã€‚æ¯”å¦‚å‰é¢è¿™ä¸‰ä¸ª_41 54 64_è¿™ä¸‰ä¸ªæ•°å­—å°±æ˜¯å›ºå®šå†™æ­»çš„ï¼Œè€Œ_36_åˆ™æ˜¯è¿™ä¸ªåè®®çš„é€šä¿¡å·ï¼Œæ˜¯ç”¨äºåŒºåˆ†ä¸åŒæ¶ˆæ¯ç çš„ï¼Œæ¯”å¦‚ä¸Šè¿°è¿™æ¡æŒ‡ä»¤çš„æ¶ˆæ¯ç æ˜¯36ï¼Œå¦å¤–ä¸€æ¡æ¶ˆæ¯

ç„¶ååç»­æ ‡äº†é¢œè‰²çš„å†…å®¹å°±æ˜¯å®é™…ä¸Šè¿™æ¡æ¶ˆæ¯ç ä¸­å…·ä½“æºå¸¦çš„æ•°æ®ï¼Œè¿™ä¸ªå°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚

ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¡¬ä»¶è¿”å›çš„æ•°æ®æˆ–è€…å‘ç¡¬ä»¶å‘é€çš„æ•°æ®ä¸ä¸€å®šéƒ½æ˜¯åƒäººä¸€æ ·çš„ä»å·¦åˆ°å³ï¼Œæœ‰äº›å‘½ä»¤ç‰¹åˆ«æ˜¯åé•¿çš„å‘½ä»¤å¾ˆå¤šéƒ½æ˜¯è¦æ±‚ä»å³åˆ°å·¦ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„å°ç«¯åºï¼Œä½å­—èŠ‚åœ¨å‰é«˜å­—èŠ‚åœ¨åï¼Œæ¯”å¦‚ï¼š  
![image](https://img2023.cnblogs.com/blog/3013923/202306/3013923-20230611202113040-1419465681.png)

ç»™å‡ºä¸¤ç«¯å‡½æ•°ç¤ºä¾‹ï¼ˆå®é™…ä¸Šè¿™ä¸¤ä¸ªå‡½æ•°åœ¨Qtä¸­éƒ½æœ‰ï¼Œè¿™é‡Œåªæ˜¯å±•ç¤ºä¸€ä¸‹å…·ä½“æ˜¯ä»€ä¹ˆæ„æ€è€Œå·²ï¼‰ï¼š

    //å°†æ¥æ”¶åˆ°çš„å°ç«¯å­—èŠ‚åºæ•°æ®è½¬æ¢ä¸ºæ— ç¬¦å·æ•´æ•°
    QString SerialPortHelper::getLittleEnd(const QByteArray& data)
    {
    	if (data.size() > 8) return "";
    	qulonglong result = 0;
    	for (int i = 0; i < data.size(); ++i)
    	{
    		qulonglong tmp = (uchar)data[i];
    		result += tmp <<= i * 8;
    	}
    	return QString::number(result);
    }
    
    //å¤§ç«¯å­—èŠ‚åºæ•°æ®è½¬æ¢ä¸ºæµ®ç‚¹æ•°
    QString SerialPortHelper::getBigEndFlt(const QByteArray& data)
    {
    	const int fltLen = 4;
    	if (data.size() != fltLen) return "null";
    	float result = 0;
    	uchar fltArr[fltLen];
    	for (int i = 0; i < fltLen; ++i)
    	{
    		fltArr[fltLen - i - 1] = data.at(i);
    	}
    	return QString::number(*(float*)fltArr, 'f', 9);
    }
    

okï¼Œæ¥ä¸‹æ¥è¿˜æœ‰å››ä½æ•°å­—ï¼Œè¿™ä¸ªè¦åˆ†å¼€æ¥è¯´å‰ä¸¤ä½å’Œåä¸¤ä½ã€‚

å…¶ä¸­å‰ä¸¤ä½æ˜¯CRCæ ¡éªŒç ï¼Œè¿™ä¸ªæ˜¯éœ€è¦å¯¹å‰é¢çš„æ•°å­—è¿›è¡Œä¸€ä¸ªåŸºæœ¬çš„æ ¡éªŒï¼Œå…·ä½“æˆ‘å°±ä¸å¤ªæ‡‚äº†ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œä¾›å‚è€ƒï¼š

    void SerialPortHelper::CRC16_2(const QByteArray& ba, uchar* crcBuf)
    {
    	int pos, i;
    	uchar* buf = (uchar*)ba.data();
    	int len = ba.size();
    	unsigned int crc = 0xFFFF;
    	for (pos = 0; pos < len; pos++)
    	{
    		crc ^= (unsigned int)buf[pos]; // XOR byte into least sig. byte of crc
    		for (i = 8; i != 0; i--) // Loop over each bit
    		{
    			if ((crc & 0x0001) != 0) // If the LSB is set
    			{
    				crc >>= 1; // Shift right and XOR 0xA001
    				crc ^= 0xA001;
    			}
    			else // Else LSB is not set
    			{
    				crc >>= 1; // Just shift right
    			}
    		}
    	}
    	//é«˜ä½å­—èŠ‚è½¬æ¢
    	crc = ((crc & 0x00ff) << 8) | ((crc & 0xff00) >> 8);
    	//qDebug() << QString().sprintf("CRC:%04x", crc);
    	crcBuf[0] = crc >> 8;
    	crcBuf[1] = crc;
    }
    

æœ€åä¸¤ä½å°±æ˜¯å›ºå®šçš„äº†ï¼Œç”¨ä¸¤ä¸ªå›ºå®šæ­é…æ¥åˆ†å‰²å„ç§å­—ç¬¦æ®µ

ä¸²å£é€šä¿¡ä½¿ç”¨æµç¨‹
--------

æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ä¸²å£ç±»ï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š

1.è·å¾—åŸºæœ¬å‚æ•°ï¼š  
æˆ‘ä»¬éœ€è¦è·å¾—è¿™ä¸ªä¸²å£çš„ä¸€äº›åŸºæœ¬å‚æ•°ï¼Œå…¶ä¸­åŒ…å«å†…å®¹å¦‚ä¸‹ï¼š

    QString portName = "NULL";
    int baudRate = 921600;
    QSerialPort::DataBits dataBits = QSerialPort::Data8;
    QSerialPort::StopBits stopBits = QSerialPort::OneStop;
    QSerialPort::Parity parity = QSerialPort::NoParity;
    

æˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨è¿™ä¸ªç«¯å£è°ƒç”¨çš„æ—¶å€™è®¾ç½®å¥½è¿™äº›å±æ€§ï¼Œæ‰èƒ½è·å–æ­£ç¡®çš„COMå£æ¶ˆæ¯å’Œå‘é€æ¶ˆæ¯ï¼Œç»™å‡ºä¸€ä¸ªå¯åŠ¨ä¸²å£çš„ç¤ºä¾‹ï¼š

    serialPort = new QSerialPort();
    serialPort->setPortName(param.portName);
    if (serialPort->open(QIODevice::ReadWrite))
    {
    	serialPort->setBaudRate(param.baudRate);
    	serialPort->setDataBits(param.dataBits);
    	serialPort->setStopBits(param.stopBits);
    	serialPort->setParity(param.parity);
    	//é€šçŸ¥ä¸²å£æ¥æ”¶åˆ°æ¶ˆæ¯çš„ä¿¡å·å‡½æ•°
    	connect(serialPort, &QSerialPort::readyRead, this, &CarControlModel::dataReceive);	
    	qDebug() << "connect:" << param.portName;
    	emit checkConnableRetSig(true);
    
    	setStartTime();
    	//emit comConnStatus(true);
    	return true;
    

Seeï¼Ÿå…¶å®å¾ˆç®€å•çš„çš„ï¼Œè¿™ä¸ªå¯¹è±¡å®é™…ä¸Šå°±åšäº†ä¸€ä»¶äº‹ï¼Œé€šçŸ¥ä½ ç°åœ¨æ¥æ•°æ®äº†ã€‚æ³¨æ„ï¼Œè¿™ä¸ªreadyRead å¹¶ä¸æ˜¯å‘ç»™ä½ æ¥åˆ°çš„æ•°æ®ï¼Œè€Œæ˜¯é€šçŸ¥ä½ ç°åœ¨ä¸²å£æ¥åˆ°æ¶ˆæ¯äº†ï¼Œè€Œä¸”è¿™ä¸ªæ¶ˆæ¯è¿˜å¾ˆæœ‰å¯èƒ½ä¸æ˜¯ä¸€æ¡ä¸€æ¡çš„ï¼Œå¯èƒ½æ˜¯ä¸€æ®µä¸€æ®µçš„ï¼Œå°±æ˜¯æ¶ˆæ¯å¯èƒ½ä¸å®Œæ•´ï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªç¤ºä¾‹ã€‚

    void CarControlModel::dataReceive()
    {
    	if (serialPort != nullptr && serialPort->isOpen())
    	{
    
    		QByteArray buffer = serialPort->readAll();
    		analysisData(buffer);
    	}
    }
    
    void CarControlModel::analysisData(const QByteArray& dataArr)
    {
    	//æ¶ˆæ¯æ–­å¼€çš„æƒ…å†µ
    	qDebug() << "recv data: " << dataArr.toHex(' ');
    	dataBuff.append(dataArr);
    	QList<QByteArray> dataList;
    	for (;;)
    	{
    		int index = dataBuff.indexOf(QByteArray(gEnd, gEndLen));
    		if (index == -1) break;
    		dataList.append(dataBuff.mid(0, index + gEndLen));
    		dataBuff = dataBuff.right(dataBuff.size() - index - gEndLen);
    	}
    	if (dataList.size() == 0) return;
    	ã€‚ã€‚ã€‚ã€‚
    

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¥åˆ°ä¸²å£æŒ‡ä»¤ä¹‹åå¯èƒ½è¿˜éœ€è¦ä½ åšä¸€ä¸ªè§£æï¼ŒæŠŠæ¥åˆ°çš„æ¶ˆæ¯æ‹†åˆ†å‡ºæ¥å¤„ç†ã€‚

å‘ä¸²å£å‘é€æŒ‡ä»¤ï¼š
--------

å‘é€æŒ‡ä»¤çš„è¯ï¼Œå°±æ¯”è¾ƒç®€å•äº†ï¼Œæ¯”å¦‚ï¼š

    qint64 CarControlModel::startCentralCMD()
    {
    	QByteArray allArr, funDataArr;
    	funDataArr.clear();
    	funDataArr.append(0x32);
    	funDataArr.append(0x01);  //0x01å¯åŠ¨ä¸­å¿ƒç ç›˜
    	code(allArr, funDataArr);
    	return writeData(allArr);
    }
    
    //ä¼ å…¥åŠŸèƒ½ç æ•°æ®åŒºï¼Œç»„åˆæˆå®Œæ•´çš„æŒ‡ä»¤å­˜å…¥æ•°ç»„
    void CarControlModel::code(QByteArray& allArr, const QByteArray& funDataArr)
    {
    	allArr.clear();
    	allArr.append(gId, gIdLen);
    	allArr.append(gAddress, gAddressLen);
    	allArr.append(funDataArr);
    	uchar crcBuf[gCrcLen];
    	CRC16_2(allArr, crcBuf);
    	allArr.append((char*)crcBuf, gCrcLen);
    	allArr.append(gEnd, gEndLen);
    }
    //ä¸²å£å‘é€æ¶ˆæ¯å‡ºå»
    qint64 CarControlModel::writeData(const QByteArray& data)
    {
    	qDebug() << "send data: " << data.toHex(' ');
    	qint64 ret = -1;
    	if (serialPort != nullptr && serialPort->isOpen())
    	{
    		ret = serialPort->write(data);
    		if (!serialPort->waitForBytesWritten(10000))
    		{
    			//emit sendWarningSig("å‘é€å¤±è´¥ï¼š" + data.toHex(' '));
    			qDebug() << QString("å‘é€å¤±è´¥ï¼š" + data.toHex(' '));
    		}
    	}
    	else
    	{
    		emit sendWarningSig("å·¥æ§ä¸»ä¸²å£æœªè¿æ¥");
    	}
    	return ret;
    }