---
layout: post
title: "ã€å¯†ç å­¦ã€‘ä¸ºä»€ä¹ˆä¸æ¨èåœ¨å¯¹ç§°åŠ å¯†ä¸­ä½¿ç”¨CBCå·¥ä½œæ¨¡å¼"
date: "2023-05-24T01:09:47.748Z"
---
ã€å¯†ç å­¦ã€‘ä¸ºä»€ä¹ˆä¸æ¨èåœ¨å¯¹ç§°åŠ å¯†ä¸­ä½¿ç”¨CBCå·¥ä½œæ¨¡å¼
==========================

![ã€å¯†ç å­¦ã€‘ä¸ºä»€ä¹ˆä¸æ¨èåœ¨å¯¹ç§°åŠ å¯†ä¸­ä½¿ç”¨CBCå·¥ä½œæ¨¡å¼](https://img2023.cnblogs.com/blog/2261141/202305/2261141-20230523203927682-225098855.png) åœ¨è°·æ­Œé‡Œé¢æœç´¢â€œpython cbc åŠ å¯†â€æ—¶å‘ç° é‡Œé¢æ’åå‰ä¸‰çš„æ–‡ç« ç¤ºä¾‹ä»£ç ç«Ÿç„¶å°†å¯†é’¥ç”¨ä½œIVâ€¦.. è¿™åŠ å¯†æ˜¯åŠ äº†ä¸ªå¯‚å¯ ä¸çŸ¥é“æœ‰æ²¡æœ‰å¼€å‘å¤åˆ¶ç²˜è´´æ‹¿å»ç”¨ã€‚

å¼•è¨€
--

è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘åœ¨å…¬å¸å†…éƒ¨åˆ†äº«ä¸­ä¸€éƒ¨åˆ†å†…å®¹çš„è¯¦ç»†ç‰ˆæœ¬ï¼Œå¦‚æ ‡é¢˜æ‰€è¨€ï¼Œæˆ‘ä¼šé€šè¿‡æ–‡å­—ã€ä»£ç ç¤ºä¾‹ã€å¸¦ä½ å®Œæ•´çš„ææ‡‚ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸å»ºè®®ä½ ä½¿ç”¨cbcåŠ å¯†æ¨¡å¼ï¼Œç”¨äº†ä¼šå¯¼è‡´ä»€ä¹ˆå®‰å…¨é—®é¢˜ï¼Œå³ä½¿ä¸€å®šè¦ç”¨éœ€è¦æ³¨æ„å“ªäº›æ–¹é¢çš„å†…å®¹ã€‚

> æ³¨ï¼šæœ¬æ–‡ä»…ä»å®‰å…¨è§’åº¦å‡ºå‘ï¼Œæœªè€ƒè™‘æ€§èƒ½ä¸å…¼å®¹æ€§ç­‰å› ç´ 

å·¥ä½œæ¨¡å¼æ˜¯ä¸ªå•¥
-------

åˆ†ç»„åŠ å¯†çš„å·¥ä½œæ¨¡å¼ä¸å…·ä½“çš„åˆ†ç»„åŠ å¯†ç®—æ³•æ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥åªè¦ä½¿ç”¨äº†cbcæ¨¡å¼ï¼Œä¸é™äºAESã€DESã€3DESç­‰ç®—æ³•éƒ½ä¸€æ ·å­˜åœ¨é—®é¢˜ã€‚

ä»¥`AES-128-CBC`ä¸ºä¾‹ï¼Œå¯ä»¥å±è”½AESç®—æ³•çš„å†…éƒ¨å®ç°ï¼ŒæŠŠAESç®—æ³•å½“ä½œä¸€ä¸ªé»‘ç›’ï¼Œè¾“å…¥æ˜æ–‡å’Œå¯†é’¥è¿”å›å¯†æ–‡ã€‚

![image-20230518164048044](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230518164048.png)

å› ä¸ºæ˜¯åˆ†ç»„åŠ å¯†ç®—æ³•ï¼Œæ‰€ä»¥å¯¹äºé•¿çš„æ˜æ–‡ï¼Œéœ€è¦æŒ‰ç…§ç®—æ³•çº¦å®šçš„å—å¤§å°è¿›è¡Œåˆ†ç»„ï¼ŒAESæ¯ä¸€ç»„ä¸º16Bï¼Œä¸åŒç»„ä¹‹é—´ä½¿ç”¨ç›¸åŒçš„å¯†é’¥è¿›è¡Œè®¡ç®—çš„è¯ï¼Œä¼šäº§ç”Ÿä¸€äº›å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†å°†åˆ†ç»„å¯†ç åº”ç”¨åˆ°ä¸åŒçš„å®é™…åº”ç”¨ï¼ŒNISTå®šä¹‰äº†è‹¥å¹²çš„å·¥ä½œæ¨¡å¼ï¼Œä¸åŒæ¨¡å¼å¯¹åˆ†å—çš„åŠ å¯†å¤„ç†é€»è¾‘ä¼šä¸åŒï¼Œå¸¸è§çš„å·¥ä½œæ¨¡å¼æœ‰ï¼š

æ¨¡å¼

æè¿°

ECBï¼ˆç”µç æœ¬ï¼‰

ç›¸åŒçš„å¯†é’¥åˆ†é˜Ÿæ˜æ–‡åˆ†ç»„è¿›è¡ŒåŠ å¯†

CBCï¼ˆåˆ†ç»„é“¾æ¥ï¼‰

åŠ å¯†ç®—æ³•çš„è¾“å…¥æ˜¯ä¸Šä¸€ä¸ªå¯†æ–‡ç»„å’Œå½“å‰æ˜æ–‡ç»„çš„å¼‚æˆ–

CFBï¼ˆå¯†æ–‡åé¦ˆï¼‰

ä¸€æ¬¡å¤„ç†sä½ï¼Œä¸Šä¸€å—å¯†æ–‡ä½œä¸ºä¸‹ä¸€å—åŠ å¯†ç®—æ³•è¾“å…¥ï¼Œäº§ç”Ÿä¼ªéšæœºæ•°ä¸æ˜æ–‡å¼‚æˆ–æˆ–ä½œä¸ºä¸‹ä¸€å•å…ƒçš„å¯†æ–‡

OFBï¼ˆè¾“å‡ºåé¦ˆï¼‰

ç±»ä¼¼CFBï¼Œä»…åŠ å¯†ç®—æ³•çš„è¾“å…¥æ˜¯ä¸Šä¸€æ¬¡åŠ å¯†çš„è¾“å‡ºï¼Œä¸”ä½¿ç”¨æ•´ä¸ªåˆ†ç»„

CTRï¼ˆæŠ€æ•°å™¨ï¼‰

æ¯ä¸ªæ˜æ–‡åˆ†ç»„éƒ½ä¸ä¸€ä¸ªç»è¿‡åŠ å¯†çš„è®¡æ•°å™¨ç›¸å¼‚æˆ–ã€‚å¯¹æ¯ä¸ªåç»­åˆ†ç»„è®¡æ•°å™¨é€’å¢

ECBæ¨¡å¼æœ€ä¸ºç®€å•ï¼Œå‡è®¾å­˜åœ¨æ˜æ–‡åˆ†ç»„aã€bã€cã€d æ¯ä¸ªåˆ†ç»„åˆ†åˆ«åœ¨ç›¸åŒå¯†é’¥kè¿›è¡ŒaesåŠ å¯†åçš„å¯†æ–‡ä¸ºAã€Bã€Cã€Dï¼Œæœ€ç»ˆæ˜æ–‡abcdå¯¹åº”çš„å¯†æ–‡ä¸ºABCDï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

![image-20230518165951722](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230518165951.png)

ECBæ¨¡å¼å¾ˆç®€å•å¯èƒ½ä»æ€§èƒ½è§’åº¦è®²éå¸¸å ä¼˜ï¼Œå› ä¸ºåˆ†ç»„ä¹‹é—´æ²¡æœ‰å…³è”ï¼Œå¯ä»¥ç‹¬ç«‹å¹¶è¡Œè®¡ç®—ã€‚ä½†ä»å®‰å…¨è§’åº¦æ¥çœ‹è¿™ç§ç›´æ¥å°†å¯†æ–‡åˆ†ç»„è¿›è¡Œæ‹¼æ¥çš„æ–¹å¼ï¼Œå¾ˆå¯èƒ½ä¼šè¢«æ”»å‡»è€…çŒœè§£å‡ºæ˜æ–‡ç‰¹å¾æˆ–æ›¿æ¢ä¸¢å¼ƒéƒ¨åˆ†å¯†æ–‡å—è¾¾åˆ°æ˜æ–‡çš„æ›¿æ¢ä¸æˆªå–æ•ˆæœï¼Œä»¥ä¸‹çš„å›¾éå¸¸æ¸…æ™°ï¼š

![image-20230302102403380](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230302102403.png)

![image-20230523201623883](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230523201624.png)

æ‰€ä»¥å¾ˆå®¹æ˜“ç†è§£ECBä¹Ÿä¸æ˜¯æ¨èä½¿ç”¨çš„å·¥ä½œæ¨¡å¼ã€‚

CBC
---

æœ‰äº†ECBçš„å‰è½¦ä¹‹é‰´ï¼ŒCBCï¼ˆ Cipher Block Chainingï¼‰æ¨¡å¼å°±æå‡ºå°†æ˜æ–‡åˆ†ç»„å…ˆäºä¸€ä¸ªéšæœºå€¼åˆ†ç»„IVè¿›è¡Œå¼‚æˆ–ä¸”æœ¬ç»„çš„å¯†æ–‡åˆä¸ä¸‹ä¸€ç»„çš„æ˜æ–‡è¿›è¡Œå¼‚æˆ–çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼å¢åŠ äº†å¯†æ–‡çš„éšæœºæ€§ï¼Œé¿å…äº†ECBçš„é—®é¢˜ï¼Œè¯¦ç»†è¿‡ç¨‹è§å›¾ï¼š

### åŠ å¯†è¿‡ç¨‹ğŸ”

![image-20230518185706238](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230518185706.png)

è§£é‡Šä¸‹è¿™ä¸ªå›¾ï¼Œå­˜åœ¨æ˜æ–‡åˆ†ç»„aã€bã€cã€dï¼Œcbcå·¥ä½œæ¨¡å¼æ˜¯å­˜åœ¨æ‰§è¡Œé¡ºåºçš„ï¼Œå³ç¬¬ä¸€ä¸ªå¯†æ–‡åˆ†ç»„è®¡ç®—åæ‰èƒ½è®¡ç®—ç¬¬äºŒä¸ªåˆ†ç»„ï¼Œç¬¬ä¸€ä¸ªæ˜æ–‡åˆ†ç»„åœ¨åŠ å¯†å‰æ˜æ–‡aéœ€è¦å’Œä¸€ä¸ªåˆå§‹åˆ†ç»„IVè¿›è¡Œå¼‚æˆ–è¿ç®— å³ `a^IV` ï¼Œç„¶åå†ç”¨å¯†é’¥Kè¿›è¡Œæ ‡å‡†çš„AESåŠ å¯†ï¼Œ`E(a^IV,K)` å¾—åˆ°ç¬¬ä¸€ç»„çš„å¯†æ–‡åˆ†ç»„Aï¼Œå¯†æ–‡åˆ†ç»„Aä¼šå‚ä¸ç¬¬äºŒç»„å¯†æ–‡çš„è®¡ç®—ï¼Œè®¡ç®—è¿‡ç¨‹ç±»ä¼¼ï¼Œåªä¸è¿‡ç¬¬äºŒæ¬¡éœ€å°†IVæ›¿æ¢ä¸ºAï¼Œå¦‚æ­¤å¾ªç¯ï¼Œæœ€åå¾—åˆ°çš„å¯†æ–‡ABCDå³ä¸ºCBCæ¨¡å¼ã€‚

### è§£å¯†è¿‡ç¨‹

ä»”ç»†è§‚å¯ŸCBCçš„åŠ å¯†è¿‡ç¨‹ï¼Œéœ€è¦ä½¿ç”¨åˆ°ä¸€ä¸ªéšæœºåˆ†ç»„IVï¼Œåœ¨æ ‡å‡†çš„åŠ å¯†è¿‡ç¨‹ä¸­ï¼ŒIVä¼šè¢«æ‹¼æ¥åˆ°å¯†æ–‡åˆ†ç»„ä¸­å»ï¼Œå‡è®¾å­˜åœ¨ä¸¤äººç”²å’Œä¹™ï¼Œç”²æ–¹ç»™åˆ°ä¹™æ–¹çš„å¯†æ–‡å®é™…æ˜¯ (IV)ABCDï¼Œä¹™åœ¨æ‹¿åˆ°å¯†æ–‡åæå–IVï¼Œç„¶åè¿›è¡Œä¸‹å›¾çš„è§£å¯†ï¼š

![image-20230518190822992](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230518190823.png)

è§£å¯†è¿‡ç¨‹å°±æ˜¯åŠ å¯†è¿‡ç¨‹è½¬å˜äº†ä¸‹æ–¹å‘ï¼Œç•™æ„ä¸¤ä¸ªå›¾ä»abcdåˆ°ABCDçš„ç®­å¤´æ–¹å‘ã€‚ç¬¬ä¸€ä¸ªå¯†æ–‡åˆ†ç»„å…ˆè¿›è¡ŒAESè§£å¯†ï¼Œå¾—åˆ°çš„ä¸­é—´å€¼æˆ‘ä»¬è®¡ä¸ºM\_Aï¼ŒM\_Aå†äºåˆå§‹å‘é‡IVè¿›è¡Œå¼‚æˆ–å¾—åˆ°aï¼Œç¬¬äºŒä¸ªåˆ†ç»„é‡å¤åŒæ ·çš„åŠ¨ä½œï¼Œè¿˜æ˜¯å°†IVæ›¿æ¢ä¸ºå¯†æ–‡åˆ†ç»„Aï¼Œæœ€ç»ˆå¯å¾—åˆ°æ˜æ–‡åˆ†ç»„abcdã€‚

CBCæœ‰ä»€ä¹ˆé—®é¢˜
--------

CBCå¢åŠ äº†éšæœºå˜é‡IVç»™å¯†æ–‡å¢åŠ äº†éšæœºæ€§ï¼Œå¢å¤§äº†å¯†æ–‡åˆ†æçš„éš¾åº¦æ˜¯ä¸æ˜¯å°±å®‰å…¨äº†å‘¢ï¼Ÿ ç­”æ¡ˆå½“ç„¶æ˜¯ä¸ï¼ŒCBCåˆå¼•å…¥äº†æ–°çš„é—®é¢˜â€”â€”å¯ä»¥é€šè¿‡æ”¹å˜å¯†æ–‡ä»è€Œæ”¹å˜æ˜æ–‡ã€‚

CBCå­—èŠ‚ç¿»è½¬æ”»å‡»
---------

### åŸç†è®²è§£

CBCå­—èŠ‚ç¿»è½¬æ”»å‡»åŸç†éå¸¸ç®€å•ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

![image-20230518201030532](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230518201030.png)

æ”»å‡»å¾€å¾€å‘ç”Ÿåœ¨è§£å¯†è¿‡ç¨‹ï¼Œé»‘å®¢é€šè¿‡æ§åˆ¶IVå’Œå¯†æ–‡åˆ†ç»„å¯ä»¥è¾¾åˆ°ä¿®æ”¹æ˜æ–‡çš„ç›®çš„ï¼Œå›¾ä¸­é»‘å®¢é€šè¿‡æ›¿æ¢å¯†æ–‡Dåˆ†ç»„ä¸ºEåˆ†ç»„å¯ä»¥ç¯¡æ”¹åŸæœ¬æ˜æ–‡dä¸ºxï¼ˆå¯èƒ½ä¼šæ¶‰åŠå¡«å……éªŒè¯ï¼Œè¿™é‡Œå…ˆä¸ç®¡ï¼‰ï¼Œæˆ–è€…åŒæ ·çš„é“ç†é»‘å®¢å¯ä»¥é€šè¿‡æ§åˆ¶IVè¾¾åˆ°ä¿®æ”¹æ˜æ–‡åˆ†ç»„açš„ç›®çš„ã€‚

### ä¸¾ä¸ªä¾‹å­ğŸŒ°

æ¥ä¸‹æ¥ç”¨ä¸€ä¸ªå®é™…ä¾‹å­æ¥æ¼”ç¤ºå…¶åŸç†åŠå±å®³ã€‚

> ä¸ºäº†ä¿è¯æ–¹ä¾¿è¿›è¡ŒåŸç†è®²è§£ï¼Œåœ¨åŠ å¯†æ—¶ä¼šå°†IVå’Œkeyå†™æ­»ï¼Œé¿å…æ¯æ¬¡è¿è¡Œçš„ç»“æœä¸ä¸€æ ·ã€‚

å‡è®¾å­˜åœ¨ä¸€ä¸ªwebæœåŠ¡åº”ç”¨ï¼Œå‰åç«¯é€šè¿‡Cookieæ¥è¿›è¡Œæƒé™æ ¡éªŒï¼Œcookieçš„å†…å®¹ä¸ºæ˜æ–‡`admin:0`è¿›è¡ŒAES-128-CBCåŠ å¯†åçš„å¯†æ–‡è¿›è¡Œbase64ç¼–ç ï¼Œæ•°å­—0ä»£è¡¨æ­¤æ—¶ç”¨æˆ·çš„æƒé™ä¸ºéç®¡ç†å‘˜ç”¨æˆ·ï¼Œå½“adminåé¢çš„æ•°å­—ä¸º1æ—¶ï¼Œåç«¯ä¼šè®¤ä¸ºæ˜¯ä¸€åç®¡ç†å‘˜ç”¨æˆ·ã€‚

Cookieå†…å®¹ä¸ºï¼š`AAAAAAAAAAAAAAAAAAAAAJyycJTyrCtpsXM3jT1uVKU=`

æ­¤æ—¶é»‘å®¢åœ¨çŸ¥é“æ ¡éªŒåŸç†çš„æƒ…å†µä¸‹å¯åˆ©ç”¨å­—èŠ‚ç¿»è½¬æ”»å‡»å¯¹æ­¤æœåŠ¡å‘èµ·æ”»å‡»ï¼Œåœ¨ä¸çŸ¥é“å¯†é’¥çš„æƒ…å†µä¸‹å°†cookieæ˜æ–‡ä¿®æ”¹ä¸º`admin:1`ï¼Œå…·ä½“è¿‡ç¨‹ï¼š

AESä»¥16Bä½œä¸ºblock sizeè¿›è¡Œåˆ†å—ï¼Œ`admin:0`åœ¨asciiç¼–ç ä¸‹å¯¹åº”çš„äºŒè¿›åˆ¶ä»…ä¸º7Bï¼Œæ‰€ä»¥åœ¨åŠ å¯†æ—¶è¿˜ä¼šå¯¹åŸå§‹æ˜æ–‡è¿›è¡Œå¡«å……ç›´åˆ°åˆšå¥½ä¸º16Bçš„æ•´æ•°å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¡«å……9B(å¡«å……ç»†èŠ‚ä¸‹é¢å†è®²)ï¼Œå› ä¸ºCBCè¿˜ä¼šæœ‰IVï¼Œæ‰€ä»¥æœ€ç»ˆçš„å¯†æ–‡æ˜¯IV+Cipherï¼ŒIV16Bï¼Œcipher16Bï¼Œæ€»å…±32Bï¼Œè¿™é‡Œå› ä¸ºåªæœ‰ä¸€ä¸ªå¯†æ–‡åˆ†å—ï¼Œæ‰€ä»¥æ”¹å˜IVçš„ç¬¬7ä¸ªå­—èŠ‚å¯¹åº”æ˜æ–‡`admin:0`æ•°å­—çš„ä½ç½®ï¼Œæˆ–è€…å¯†æ–‡çš„ç¬¬7ä¸ªå­—èŠ‚å³å¯æ”¹å˜æ˜æ–‡æ•°å­—éƒ¨åˆ†çš„å­—æ®µï¼Œé€šè¿‡ä¸æ–­çš„å°è¯•ï¼Œæˆ‘ä»¬å°†åŸæœ¬å¯†æ–‡IVåˆ†ç»„ **`00`æ”¹ä¸º`01`,å³å¯æˆåŠŸç¿»è½¬æ˜æ–‡ä¸º1ï¼Œå³cookieæ˜æ–‡å˜ä¸º`admin:1`ï¼Œä»è€Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚**

![image-20230518203836726](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230518203836.png)

å®Œæ•´ä»£ç ï¼š

    package com.example.springshiroproject;
    
    import org.apache.shiro.crypto.AesCipherService;
    import org.apache.shiro.util.ByteSource;
    
    import java.lang.reflect.InvocationTargetException;
    import java.lang.reflect.Method;
    import java.security.Key;
    import java.util.Arrays;
    
    public class MyTest {
        public static void main(String[] args) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {
            AesCipherService aesCipherService = new AesCipherService();
            // å†™æ­»å¯†é’¥
            byte[] key = new byte[128/8];
            Arrays.fill(key,(byte) '\0');  // å†™æ­»çš„å¯†é’¥ï¼Œå®¢æˆ·ç«¯åŠé»‘å®¢æœªçŸ¥
            String plainText = "admin:0";  // cookieæ˜æ–‡å†…å®¹
    
            byte[] plainTextBytes = plainText.getBytes();
    
    		// å†™æ­»IV
            byte[] iv_bytes = new byte[128/8];
            Arrays.fill(iv_bytes, (byte) '\0');
    //
    //      // é€šè¿‡åå°„è°ƒç”¨å¯ä»¥è‡ªå®šä¹‰IVçš„AES-128-cbcåŠ å¯†æ–¹æ³•ï¼ˆåŸæ–¹æ³•ä¸ºprivateï¼‰
            Method encryptWithIV =  aesCipherService.getClass().getSuperclass().getSuperclass().getSuperclass().getDeclaredMethod("encrypt",new Class[]{byte[].class, byte[].class,byte[].class,boolean.class});
            encryptWithIV.setAccessible(true);
            ByteSource cipherWithIV = (ByteSource) encryptWithIV.invoke(aesCipherService,new Object[]{plainTextBytes, key,iv_bytes,true});
            System.out.println("æ˜æ–‡ï¼š" + ByteSource.Util.bytes(plainTextBytes).toHex());
    
    		// æ­£å¸¸é€»è¾‘è§£å¯†
            byte[] cipher = cipherWithIV.getBytes();
            System.out.println("åŸå§‹å¯†æ–‡ï¼š " + cipherWithIV.toHex());
            System.out.println("Cookieå†…å®¹ï¼š " + cipherWithIV.toBase64());
    
            ByteSource decPlain = aesCipherService.decrypt(cipher, key);
            System.out.println("åŸå§‹è§£å¯†åæ˜æ–‡ï¼š" + new String(decPlain.getBytes()));
    
    		// å­—èŠ‚ç¿»è½¬æ”»å‡»
            cipher[6] = (byte)0x01;
            System.out.println("ç¿»è½¬åçš„å¯†æ–‡ï¼š " + ByteSource.Util.bytes(cipher).toHex());
            System.out.println("ç¿»è½¬åçš„cookieï¼š"+ ByteSource.Util.bytes(cipher).toBase64());
            decPlain = aesCipherService.decrypt(cipher, key);
            System.out.println("ç¿»è½¬è§£å¯†åæ˜æ–‡ï¼š" + new String(decPlain.getBytes()));
        }
    }
    
    

è¿™ä¸ªä¾‹å­åªè®²äº†ä¸€ä¸ªåˆ†å—çš„æƒ…å†µï¼Œåœ¨å®é™…çš„åœºæ™¯ä¸­å¯èƒ½æ¶‰åŠå¤šä¸ªåˆ†å—ï¼Œè€Œå¤šä¸ªåˆ†å—è¿›è¡Œå°è¯•æ”¹å˜ä¸€ä¸ªå¯†æ–‡åˆ†ç»„å®é™…ä¼šå½±å“ä¸¤ä¸ªæ˜æ–‡åˆ†ç»„ï¼Œè¦æ±‚ä¸æ–­åœ¨ç›¸åŒä½ç½®çš„å‘å‰çš„å¯†æ–‡åˆ†ç»„è¿›è¡Œå˜æ¢çŒœæµ‹ï¼Œéå¸¸è€—æ—¶ã€‚

![image-20230301211038733](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230519103634.png)

æ‰€ä»¥ä¸ºäº†æ›´æ–¹ä¾¿çš„åˆ©ç”¨ï¼Œæ”»å‡»è€…å‘ç°åˆ©ç”¨è§£å¯†ç¨‹åºç«¯ä¼šå¯¹å¡«å……è§„åˆ™è¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯ä¸é€šè¿‡ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç±»ä¼¼sqlæ³¨å…¥ç›²æ³¨ä¸€æ ·ï¼Œç»™æ”»å‡»è€…æä¾›äº†æ›´å¤šçš„ä¿¡æ¯æ–¹ä¾¿äº†æ¼æ´çš„åˆ©ç”¨ã€‚

å¡«å……ç±»å‹
----

å› ä¸ºä¼šæ¶‰åŠåˆ°å¯¹å¡«å……è§„åˆ™çš„åˆ©ç”¨ï¼Œæ‰€ä»¥æœ‰å¿…è¦ä¸“é—¨ä»‹ç»ä¸‹ä¸»æµçš„å¡«å……ç±»å‹ï¼š

å¡«å……ç±»å‹

æè¿°

NoPadding

æ²¡æœ‰å¡«å……

PKCS#5

å›ºå®šåˆ†å—sizeä¸º8B

PKCS#7

åˆ†å—sizeå¯ä¸º1ï½255

ISO 10126

æœ€åä¸€ä¸ªå­—èŠ‚å¡«å……éœ€è¦å¡«å……çš„é•¿åº¦ï¼Œå‰©ä¸‹çš„éšæœºå¡«å……

ANSI X9.23

æœ€åä¸€ä¸ªå­—èŠ‚å¡«å……éœ€è¦å¡«å……çš„é•¿åº¦ï¼Œå‰©ä¸‹çš„è¡¥0å¡«å……

ZerosPadding

å¡«å…… `\x00`

è¿™é‡Œç€é‡è®²ä¸€ä¸‹`PKCS#5`å’Œ`PKCS#7`, æˆ‘å‘ç°å¾ˆå¤šå®‰å…¨äººå‘˜å†™çš„æ–‡ç« å¯¹äºè¿™ä¸¤ç§å¡«å……æ¨¡å¼çš„æè¿°æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯”å¦‚ï¼š

![image-20230519104840842](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230519104840.png)

å…¶å®ä¸ç®¡`pkcs#5`è¿˜æ˜¯`pkcs#7` å¡«å……çš„å†…å®¹éƒ½æ˜¯éœ€è¦å¡«å……çš„å­—èŠ‚æ•°è¿™ä¸ªæ•°äºŒè¿›åˆ¶æœ¬èº«ï¼Œ`pkcs#5`æ˜¯æŒ‰ç…§8Bä¸ºæ ‡å‡†åˆ†å—è¿›è¡Œå¡«å……ï¼Œ`pkcs#7`æ˜¯å¯ä»¥ä¸å›ºå®š1ï½255éƒ½è¡Œï¼Œåªä¸è¿‡æŒ‰ç…§AESçš„RFCçº¦å®šï¼Œblocksizeå›ºå®šä¸º16Bï¼Œæ‰€ä»¥åœ¨AESè°ƒç”¨é‡Œé¢`pkcs#5`å’Œ`pkcs#7`æ˜¯æ²¡å•¥åŒºåˆ«çš„ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚å­˜åœ¨æ˜æ–‡`helloworld`ï¼Œæ˜æ–‡æœ¬èº«ä¸ºè‹±æ–‡ï¼ŒæŒ‰ç…§asciiæ¯ä¸ªå­—ç¬¦å ç”¨1Bï¼Œæ˜æ–‡é•¿åº¦ä¸º`10B`ï¼Œè¿˜éœ€å¡«å……`6B` ï¼Œå¡«å……å†…å®¹ä¸º`\x06`ï¼Œæœ€ç»ˆåˆ†å—å†…å®¹ä¸ºï¼š`helloworld\x06\x06\x06\x06\x06\x06`.

åœ¨è§£å¯†æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå¯¹å†…å®¹åšå¦‚ä¸‹æ ¡éªŒï¼š

1.  è·å–è§£å¯†åçš„æ˜æ–‡æ•°æ®ã€‚
2.  è·å–æ˜æ–‡æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„å€¼ã€‚
3.  æ£€æŸ¥æœ€åä¸€ä¸ªå­—èŠ‚çš„å€¼æ˜¯å¦åœ¨æœ‰æ•ˆå¡«å……èŒƒå›´å†…ã€‚
    *   å¦‚æœæœ€åä¸€ä¸ªå­—èŠ‚çš„å€¼å°äºç­‰äºæ˜æ–‡æ•°æ®çš„é•¿åº¦ï¼Œåˆ™åˆ¤æ–­ä¸ºå¡«å……æ•°æ®ã€‚
    *   å¦‚æœæœ€åä¸€ä¸ªå­—èŠ‚çš„å€¼å¤§äºæ˜æ–‡æ•°æ®çš„é•¿åº¦ï¼Œåˆ™åˆ¤æ–­ä¸ºæ— å¡«å……æ•°æ®ã€‚
    *   å¦‚æœæœ€åä¸€ä¸ªå­—èŠ‚çš„å€¼è¶…å‡ºå¡«å……èŒƒå›´ï¼ˆå¤§äºå—å¤§å°ï¼‰ï¼Œåˆ™æ•°æ®å¯èƒ½è¢«ç¯¡æ”¹æˆ–å­˜åœ¨å…¶ä»–å¼‚å¸¸ã€‚
4.  å¦‚æœå­˜åœ¨å¡«å……ï¼Œåˆ™æ ¹æ®å¡«å……çš„å­—èŠ‚æ•°ï¼Œæˆªå–æ˜æ–‡æ•°æ®ï¼Œå»é™¤å¡«å……éƒ¨åˆ†ã€‚

Padding oracle attack
---------------------

padding oracle æ”»å‡»åˆ©ç”¨çš„æ˜¯ç¯¡æ”¹å¯†æ–‡åˆ†ç»„æœ€åçš„å¡«å……å­—èŠ‚å¼•å‘æœåŠ¡ç«¯æŠ¥é”™è¿›è€Œå¯é¢„æµ‹å‡ºæ˜æ–‡æˆ–ç”Ÿæˆæ–°çš„å¯†æ–‡çš„æ”»å‡»æ–¹å¼ï¼Œæ‰€ä»¥è¿™é‡Œçš„oracleæ˜¯é¢„æµ‹çš„æ„æ€ï¼Œéæˆ‘ä»¬ç†Ÿæ‚‰çš„javaæ¯å…¬å¸ç”²éª¨æ–‡ã€‚

### ä¾‹å­ğŸŒ°

å‡è®¾æˆ‘ä»¬æ”¶åˆ°äº†ä¸€ä¸²é€šè¿‡AES-128-CBCåŠ å¯†çš„å¯†æ–‡ï¼Œå¯†æ–‡å†…å®¹ä¸ºï¼š

`000000000000000000000000000000009cb27094f2ac2b69b173378d3d6e54a5`

å‰é¢16Bå…¨æ˜¯0çš„éƒ¨åˆ†æ˜¯å†™æ­»çš„IV,åé¢æ‰æ˜¯çœŸæ­£çš„å¯†æ–‡ã€‚å¤ä¹ ä¸‹è§£å¯†è¿‡ç¨‹

![image-20230519161123394](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230519161123.png)

![image-20230519160953949](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230519160954.png)

1.  å¯†æ–‡cipheré¦–å…ˆä¼šåœ¨å¯†é’¥Kçš„ä½œç”¨ä¸‹ç”Ÿæˆä¸­é—´å€¼M
2.  ä¸­é—´å€¼Må†äºåˆå§‹å‘é‡IVå¼‚æˆ–å¾—åˆ°æ˜æ–‡plain text.

è¡¨ä¸­æ ‡é»„çš„å°±æ˜¯æ”»å‡»è€…å¯æ§çš„å†…å®¹ï¼Œå¦‚æœä»…ç¿»è½¬å­—èŠ‚åªèƒ½æ”¹å˜æ˜æ–‡å†…å®¹ï¼Œä½†æˆ‘ä»¬æ— æ³•ç¡®åˆ‡å¾—çŸ¥æ˜æ–‡çš„å…·ä½“å†…å®¹ï¼Œæ‰€ä»¥padding oracle å°±ç™»åœºäº†ï¼Œæ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘åœ¨è§£å¯†æ—¶ä¼šå¯¹æ˜æ–‡å†…å®¹åšåˆ¤æ–­ï¼Œå¦‚æœè§£å¯†å†…å®¹æ­£ç¡®å¯èƒ½ä¼šè¿”å›200ï¼Œè§£å¯†æ˜æ–‡é”™è¯¯è¿”å›403ï¼Œä½†å¦‚æœç ´åå¯†æ–‡ç¨‹åºå¯¹å¡«å……éªŒè¯å‡ºé”™å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå‡ºé”™è¿›è€Œäº§ç”Ÿ500é”™è¯¯ã€‚

æ”»å‡»è€…ä¼šåˆ©ç”¨500é”™è¯¯æ¥å¾ªç¯åˆ¤æ–­çŒœè§£çš„ä¸­é—´å€¼æ˜¯å¦æ­£ç¡®ã€‚

![image-20230519162633255](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230519162633.png)

çŒœè§£å‡ºä¸­é—´å€¼åå†ä¸å·²çŸ¥çš„IVè¿›è¡Œå¼‚æˆ–å°±èƒ½å¾—åˆ°æ˜æ–‡ã€‚

### æ”»å‡»æµç¨‹

#### çŒœè§£ä¸­é—´å€¼

è¿˜æ˜¯ä»¥åˆšåˆšçš„ä¾‹å­æ¥åšæµ‹è¯•ï¼Œæˆ‘ä»¬å°è¯•çŒœè§£æœ€åä¸€ä½ä¸­é—´å€¼ï¼Œå°†IVä»00-ffè¿›è¡Œæš´åŠ›éªŒè¯ç›´åˆ°ç¨‹åºä¸æŠ¥é”™ï¼Œå¾—åˆ°`iv[15]`ä¸º`0x08` æ—¶æ²¡æœ‰æŠ¥å¡«å……é”™è¯¯ï¼Œè¯æ˜è¿™ä¸ªæ—¶å€™ç¯¡æ”¹åçš„æ˜æ–‡æœ€åä¸€ä½åº”è¯¥ä¸º`0x01`ï¼Œå°†æ˜æ–‡å’ŒIVè¿›è¡Œå¼‚æˆ–ï¼Œå¯å¾—ä¸­é—´å€¼ä¸º`0x08^0x01 = 0x09` ï¼Œè¡¨ä¸­çº¢è‰²éƒ¨åˆ†:

![image-20230519172221014](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230519172221.png)

å†è¿›è¡Œç¬¬äºŒæ­¥ï¼ŒçŒœè§£å€’æ•°ç¬¬äºŒä½ï¼ŒçŒœè§£å€’æ•°ç¬¬äºŒä½éœ€è¦æ»¡è¶³ç¯¡æ”¹åçš„æ˜æ–‡åä¸¤ä½éƒ½ä¸º`0x02`ï¼Œå› ä¸ºæœ€åä¸€ä½éƒ½ä¸­é—´å€¼å·²ç»å¾—å‡ºäº†ä¸º 0x09 æ‰€ä»¥ï¼Œæœ€åä¸€ä½çš„ivä¸ºï¼š`0x09^0x02 = 0x0B`,å¾ªç¯ivå€’æ•°ç¬¬äºŒä½ä»00~ff.å¾—åˆ°IVå€¼ä¸º`0x0B`æ—¶ï¼Œç¨‹åºä¸æŠ¥é”™ï¼Œæ‰€ä»¥ä¸­é—´å€¼ä¸º`0x02^0x0B=0x09`

![image-20230519174843806](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230519174843.png)

ä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰çš„ä¸­é—´å€¼éƒ½è¢«çŒœè§£å‡ºæ¥ã€‚

![image-20230523193203108](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230523193203.png)

#### è·å–æ˜æ–‡

æ­¤æ—¶ï¼Œ**æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸çŸ¥é“å¯†é’¥çš„æƒ…å†µä¸‹ï¼Œæ ¹æ®ä¸­é—´å€¼å’ŒIVæ¨æµ‹å‡ºæ˜æ–‡`M^IV=P`**(Mä¸ºä¸­é—´å€¼ï¼ŒIVä¸ºåˆå§‹å‘é‡ã€Pä¸ºæ˜æ–‡)ã€‚

å› ä¸ºæˆ‘ä»¬å°†ivå†™æ­»ä¸º00ï¼Œæ‰€ä»¥æ˜æ–‡å°±æ˜¯Må¯¹åº”çš„ASCIIå€¼ï¼Œä¹Ÿå°±æ˜¯ï¼š

`admin:0\09\09\09\09\09\09\09\09\09`

09ä¸ºå¡«å……å†…å®¹ï¼Œå­—èŠ‚å»æ‰å¾—åˆ°æœ€ç»ˆæ˜æ–‡ï¼š`admin:0`

å¯¹åº”çš„ä»£ç ï¼ˆJavaï¼‰ï¼š

    package com.example.springshiroproject;
    
    import org.apache.shiro.crypto.AesCipherService;
    import org.apache.shiro.crypto.CryptoException;
    import org.apache.shiro.util.ByteSource;
    
    import javax.crypto.BadPaddingException;
    import java.lang.reflect.InvocationTargetException;
    import java.lang.reflect.Method;
    import java.security.Key;
    import java.util.Arrays;
    
    public class MyTest {
        public static void main(String[] args) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {
            int blockSize = 16;
            AesCipherService aesCipherService = new AesCipherService();
            // å†™æ­»å¯†é’¥
            byte[] key = new byte[128/8];
            Arrays.fill(key,(byte) '\0');  // å†™æ­»çš„å¯†é’¥ï¼Œå®¢æˆ·ç«¯åŠé»‘å®¢æœªçŸ¥
            String plainText = "admin:0";  // cookieæ˜æ–‡å†…å®¹
    
            byte[] plainTextBytes = plainText.getBytes();
    
    
            byte[] iv_bytes = new byte[128/8];
            Arrays.fill(iv_bytes, (byte) '\0');
    //
    //      // é€šè¿‡åå°„è°ƒç”¨å¯ä»¥è‡ªå®šä¹‰IVçš„AES-128-cbcåŠ å¯†æ–¹æ³•
            Method encryptWithIV =  aesCipherService.getClass().getSuperclass().getSuperclass().getSuperclass().getDeclaredMethod("encrypt",new Class[]{byte[].class, byte[].class,byte[].class,boolean.class});
            encryptWithIV.setAccessible(true);
            ByteSource cipherWithIV = (ByteSource) encryptWithIV.invoke(aesCipherService,new Object[]{plainTextBytes, key,iv_bytes,true});
            System.out.println("æ˜æ–‡ï¼š" + ByteSource.Util.bytes(plainTextBytes).toHex());
    
    
            byte[] cipher = cipherWithIV.getBytes();
    //        System.out.println(cipher.length);
            System.arraycopy(cipher,0,iv_bytes,0,blockSize-1);
            System.out.println("åŸå§‹å¯†æ–‡ï¼š " + cipherWithIV.toHex());
            System.out.println("Cookieå†…å®¹ï¼š " + cipherWithIV.toBase64());
    
            ByteSource decPlain = aesCipherService.decrypt(cipher, key);
            System.out.println("åŸå§‹è§£å¯†åæ˜æ–‡ï¼š" + new String(decPlain.getBytes()));
            System.out.println("å¼€å§‹å°è¯•");
            decPlain = null;
    
    
            byte[] middleValue = new byte[blockSize];
            Arrays.fill(middleValue,(byte) 0x00);
            boolean flipFlag = false;
            for (int j=0; j<blockSize; j++){
                byte tmp;
                System.out.println("start "+ (j+1));
                if (j >0){
                    for (int p=middleValue.length-1;p>middleValue.length-1-j;p--){
                        tmp = (byte) (middleValue[p]^(j+1));
                        cipher[p] = tmp;
    //                    System.out.println("æ­¤æ—¶çš„tmp: " + tmp);
                    }
                    System.out.println("æ ¹æ®å·²çŸ¥ä¸­é—´å€¼å¡«å……ivçš„cipherï¼š " + ByteSource.Util.bytes(cipher).toHex());
                }else {
                    System.out.println("åˆå§‹å¡«å……");
    
                }
                tmp  = cipher[blockSize-j-1];
                for (int i=0x00; i<=0xff; i++){
                    if (tmp == i){
    //                    continue;
                        System.out.println("å’ŒåŸå€¼ä¸€è‡´è·³è¿‡");
                        if (!flipFlag){
                            flipFlag = true;
                            continue;
                        }
                    }
    
                    cipher[blockSize-j-1] = (byte) i;
                    try{
                        decPlain = aesCipherService.decrypt(cipher, key);
                        tmp = (byte) (i ^ (j+1));
                        middleValue[blockSize-j-1] =tmp; //ä¿å­˜ä¸­é—´å€¼ M = IV ^ I
                        System.out.println("çŒœå¯¹äº†ï¼å€’æ•°ç¬¬" +(j+1) +"ä¸ªivï¼š" + i);
                        System.out.println("å€’æ•°ç¬¬" +(j+1) +"ä¸ªMï¼š" + tmp);
                        break;
                    }catch (CryptoException e){
                        if (i==0xff){
                            System.out.print("æ²¡æœ‰è·‘å‡ºæ¥");
                            System.exit(0);
                        }
    
                    }
    
                }
            }
            System.out.println("çŒœè§£çš„ä¸­é—´å€¼ï¼š" + ByteSource.Util.bytes(middleValue).toHex());
            byte[] attackPlain = new byte[blockSize];
            for (int i=0;i<attackPlain.length;i++){
                attackPlain[i] =(byte)( iv_bytes[i] ^middleValue[i]);
            }
    
            System.out.println("æœ€ç»ˆå¯†æ–‡ï¼š" + ByteSource.Util.bytes(cipher).toHex());
            System.out.println("æœ€ç»ˆæ˜æ–‡ï¼š" + ByteSource.Util.bytes(attackPlain).toHex());
            System.out.println("å°è¯•ç»“æŸ");
    
            System.out.println("ç¿»è½¬è§£å¯†åæ˜æ–‡ï¼š" + new String(attackPlain));
    
    
        }
    }
    

è¿è¡Œç»“æœï¼š

![image-20230523193739360](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230523193739.png)

å¦å¤–å¯¹åº”çš„pythonç‰ˆæœ¬æˆ‘ä¹Ÿæœ‰å†™è¿‡,å¦‚æœä½ è‡ªå·±é€ è½®å­å‘ç°æŠ¥é”™å¯ä»¥å‚è€ƒä¸‹æˆ‘çš„ä»£ç ï¼š

æ¼æ´æ¨¡æ‹Ÿç¯å¢ƒï¼š

    from aes_manual import aes_manual
    
    class PaddingOracleEnv:
    
        def __init__(self):
            self.key = aes_manual.get_key(16)
    
        def run(self):
            cipher = aes_manual.encrypt(self.key, "hello".encode())
    
    
        def login(self,cookie):
            try:
                text = aes_manual.decrypt(self.key, cookie)
                if text == b'hello':
                    return 200  # å®Œå…¨æ­£ç¡®
                else:
                    return 403  # æ˜æ–‡é”™è¯¯
            except RuntimeError as e:
                return 500  # å¡«å……éªŒè¯å¤±è´¥
    
    
    padding_oracle_env = PaddingOracleEnv()
    
    if __name__ == '__main__':
        res = padding_oracle_env.login(b"1111111111111111R\xbb\x16^\xaf\xa8\x18Me.U\xaf\xfe\xb6\x99\xec")
        print(res)
    
    

æ”»å‡»è„šæœ¬ï¼š

    import sys
    
    from aes_manual import aes_manual
    from padding_oracle_env import padding_oracle_env
    from loguru import logger
    
    class PaddingOracleAttack:
    
        def __init__(self):
            logger.remove()
            logger.add(sys.stderr,level="DEBUG")
            self.cipher_text_raw = b"1111111111111111R\xbb\x16^\xaf\xa8\x18Me.U\xaf\xfe\xb6\x99\xec"
            self.iv = aes_manual.get_iv(self.cipher_text_raw)
            self.cipher_content = aes_manual.get_cipher_content(self.cipher_text_raw)
    
        def single_byte_xor(self, A: bytes, B: bytes):
            """å•å­—èŠ‚å¼‚æˆ–æ“ä½œ"""
            assert len(A) == len(B) == 1
            return ord(A) ^ ord(B)
    
        def guess_last(self):
            """
            padding oracle
            :return:
            """
            c_l = len(self.cipher_content)
            M = bytearray()
            for j in range(1, c_l+1):  # ä¸­é—´å€¼ä½æ•°
                for i in range(1, 256):  # å‡ iv çˆ†ç ´
                    f_iv = b'\x00' * (c_l-j) + bytes([i])
                    for m in M[::-1]:
                        f_iv += bytes([m ^ j])  # åˆ©ç”¨ä¸Šä¸€æ­¥å·²çŸ¥çš„mè®¡ç®—åé¢æœªçŸ¥ä½ç½®çš„iv
                    res = padding_oracle_env.login(f_iv + self.cipher_content)
                    if res == 403:  # å¡«å……æ­£ç¡®çš„æƒ…å†µ
                        M.append(i ^ j)
                        logger.info(f"{j} - {bytes([i])} - {i}")
                        break
            # logger.info(M)
            M = M[::-1]  # reverse
            logger.info(f"M({len(M)}):{M}")
            p = bytearray()
            for m_i, m in enumerate(M):
                p.append(m ^ self.iv[m_i])
            logger.info(f"ç ´è§£æ˜æ–‡ä¸º({len(p)})ï¼š{p}")
    
        def run(self):
            self.guess_last()
    
    if __name__ == '__main__':
    
        attack = PaddingOracleAttack()
        attack.run()
    

å…¶å®ä¹Ÿæ²¡å¿…è¦é‡å¤é€ è½®å­ï¼Œä¹Ÿæœ‰å¾ˆå¤šç°æˆçš„å·¥å…·ï¼Œå¦‚ï¼š[https://github.com/KishanBagaria/padding-oracle-attacker](https://github.com/KishanBagaria/padding-oracle-attacker)

![img](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230523194136.gif)

æ€»ç»“
--

å›ç­”æ ‡é¢˜é—®é¢˜ï¼Œæ­£æ˜¯å› ä¸ºCBCå­—èŠ‚ç¿»è½¬ã€padding oracle attack è¿™äº›æ”»å‡»æ–¹å¼çš„å­˜åœ¨ï¼Œæ‰€ä»¥åœ¨å¯¹ä¼ è¾“æœºå¯†æ€§è¦æ±‚é«˜çš„åœºæ™¯æ˜¯ä¸æ¨èä½¿ç”¨CBCå·¥ä½œæ¨¡å¼çš„ï¼Œ

æ­¤å¤–æˆ‘åœ¨è°·æ­Œã€ç™¾åº¦æœç´¢`python aes cbcåŠ å¯†`å…³é”®è¯æ—¶å‡ºç°äº†å¾ˆå¤šè¯¯å¯¼æ€§çš„æ–‡ç« ï¼š

![image-20230523195957179](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230523195957.png)

![image-20230523200030081](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230523200033.png)

è€Œä¸”æ–‡ç« æ’åå‰ä¸‰ï¼Œ**é‡Œé¢çš„ç¤ºä¾‹ä»£ç ç«Ÿç„¶ç›´æ¥å°†åŠ è§£å¯†å¯†é’¥ä½œä¸ºIV**ï¼Œè¿™ä¹ˆåšæœ‰å¦‚ä¸‹é£é™©ï¼š

1.  è¦çŸ¥é“IVä¸€èˆ¬ä¼šæ‹¼æ¥åœ¨å¯†æ–‡çš„å¤´éƒ¨æ”¾åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼Œè¿™ç§æ–¹å¼æ”»å‡»è€…éƒ½ä¸éœ€è¦å­—èŠ‚ç¿»è½¬é‚£ä¹ˆå¤æ‚çš„æ“ä½œï¼Œç›´æ¥å–å‡ºIVè§£å¯†å³å¯
2.  å³ä½¿IVä¸ä½œä¸ºå¯†æ–‡ä¸€éƒ¨åˆ†ä¼ è¾“ï¼Œä½¿ç”¨ç›¸åŒçš„IVè¿›è¡ŒåŠ å¯†ä¼šå¯¼è‡´ç›¸åŒçš„æ˜æ–‡å—äº§ç”Ÿç›¸åŒçš„å¯†æ–‡å—ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡è§‚å¯Ÿå¯†æ–‡çš„æ¨¡å¼æ¥æ¨æ–­å‡ºæ˜æ–‡çš„ä¸€äº›ä¿¡æ¯ï¼Œç”šè‡³è¿›è¡Œå…¶ä»–å½¢å¼çš„æ”»å‡»ï¼Œå¦‚é€‰æ‹©æ˜æ–‡æ”»å‡»ã€‚

ä¸ºäº†ç¡®ä¿å®‰å…¨æ€§ï¼Œåº”è¯¥ç”Ÿæˆéšæœºä¸”å”¯ä¸€çš„IVï¼Œå¹¶å°†å…¶ä¸å¯†æ–‡ä¸€èµ·å­˜å‚¨ã€‚å¸¸è§çš„åšæ³•æ˜¯æ¯æ¬¡åŠ å¯†ç”Ÿæˆä¸€ä¸ªæ–°çš„IVï¼Œå¹¶å°†å…¶ä½œä¸ºé™„åŠ çš„å¯†æ–‡æ•°æ®ä¸€èµ·ä¼ è¾“æˆ–å­˜å‚¨ï¼Œä»¥ä¾¿è§£å¯†æ—¶æ­£ç¡®ä½¿ç”¨ã€‚è¿™æ ·å¯ä»¥é¿å…å¯é¢„æµ‹æ€§æ”»å‡»ï¼Œå¹¶å¢å¼ºAES CBCæ¨¡å¼çš„å®‰å…¨æ€§

æ›´æ¨èä½¿ç”¨GCMä½œä¸ºåŠ è§£å¯†çš„å·¥ä½œæ¨¡å¼ï¼Œå› ä¸ºï¼š

1.  æ•°æ®å®Œæ•´æ€§å’ŒåŠ å¯†è®¤è¯ï¼šGCM æ¨¡å¼æä¾›äº†è®¤è¯æ ‡ç­¾ (Authentication Tag) çš„ç”Ÿæˆï¼Œç”¨äºéªŒè¯å¯†æ–‡çš„å®Œæ•´æ€§å’Œè®¤è¯å¯†æ–‡çš„æ¥æºã€‚è¿™å¯ä»¥å¸®åŠ©æ£€æµ‹ä»»ä½•å¯¹å¯†æ–‡çš„ç¯¡æ”¹æˆ–ä¼ªé€ ï¼Œå¹¶æä¾›æ›´å¼ºçš„æ•°æ®å®Œæ•´æ€§ä¿æŠ¤ã€‚
2.  éšæœºæ€§å’Œä¸å¯é¢„æµ‹æ€§ï¼šGCM æ¨¡å¼ä½¿ç”¨è®¡æ•°å™¨å’Œå¯†é’¥ç”Ÿæˆä¸€ä¸ªå¯†é’¥æµï¼Œè¿™ä¸ªå¯†é’¥æµä¸æ˜æ–‡è¿›è¡Œå¼‚æˆ–è¿ç®—å¾—åˆ°å¯†æ–‡ã€‚è¿™ç§å¼‚æˆ–è¿ç®—çš„æ–¹å¼æä¾›äº†æ›´é«˜çš„éšæœºæ€§å’Œä¸å¯é¢„æµ‹æ€§ï¼Œå¢åŠ äº†å¯†æ–‡çš„å®‰å…¨æ€§ã€‚
3.  å¹¶è¡ŒåŠ å¯†å’Œé«˜æ€§èƒ½ï¼šGCM æ¨¡å¼æ”¯æŒå¹¶è¡ŒåŠ å¯†ï¼Œå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªæ•°æ®å—ï¼Œæé«˜åŠ å¯†å’Œè§£å¯†çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚è¿™åœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶éå¸¸æœ‰ç”¨ã€‚
4.  æŠµæŠ—å¡«å……æ”»å‡»ï¼šä¸ä¸€äº›å—å¯†ç æ¨¡å¼ç›¸æ¯”ï¼ŒGCM æ¨¡å¼ä¸éœ€è¦è¿›è¡Œå¡«å……æ“ä½œï¼Œå› æ­¤ä¸å®¹æ˜“å—åˆ°å¡«å……æ”»å‡»ç­‰ç›¸å…³æ¼æ´çš„å½±å“ã€‚

å‚è€ƒ
--

> *   [https://paper.seebug.org/1123/](https://paper.seebug.org/1123/)
> *   [https://www.rfc-editor.org/rfc/rfc2630](https://www.rfc-editor.org/rfc/rfc2630)
> *   [https://xz.aliyun.com/t/11633](https://xz.aliyun.com/t/11633)
> *   chatgpt

å…¬ä¼—å·
---

å®¶äººä»¬ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œç¡¬æ ¸å®‰å…¨â€ï¼Œè·Ÿæˆ‘ä¸€èµ·å­¦èµ·æ¥ï¼

![æ¬¢è¿å…³æ³¨](https://9eek-1251521991.cos.ap-chengdu.myqcloud.com/article/img/20230523203131.jpeg)