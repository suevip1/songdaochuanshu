---
layout: post
title: "å¾®æœåŠ¡å¼€å‘ï¼šæ–­è·¯å™¨è¯¦è§£"
date: "2023-05-13T01:04:25.528Z"
---
å¾®æœåŠ¡å¼€å‘ï¼šæ–­è·¯å™¨è¯¦è§£
===========

æœ¬æ–‡ç¿»è¯‘è‡ªå›½å¤–è®ºå› mediumï¼ŒåŸæ–‡åœ°å€ï¼š[https://salithachathuranga94.medium.com/micro-service-patterns-circuit-breaker-with-spring-boot-253e4a829f94](https://salithachathuranga94.medium.com/micro-service-patterns-circuit-breaker-with-spring-boot-253e4a829f94)

å¾®æœåŠ¡æ˜¯ç›®å‰ä¸šç•Œä½¿ç”¨çš„æœ€é‡è¦çš„å®ç°æ–¹é¢ã€‚é€šè¿‡ä½¿ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ¶ˆé™¤ä»–ä»¬ä»¥å‰åœ¨å•ä½“åº”ç”¨ç¨‹åºä¸­é‡åˆ°çš„è®¸å¤šé—®é¢˜ã€‚å±•æœ›æœªæ¥ï¼Œäººä»¬å¼€å§‹åœ¨å¾®æœåŠ¡ä¸­æœç´¢å’Œé‡‡ç”¨å„ç§æ¨¡å¼ã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œæ–°æ¨¡å¼çš„äº§ç”Ÿæ˜¯ä¸ºäº†è§£å†³å¦ä¸€ä¸ªæ¨¡å¼ä¸­å‡ºç°çš„å¸¸è§é—®é¢˜ã€‚å°±è¿™æ ·ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œå¤§é‡çš„æ¨¡å¼è¿›å…¥äº†å®è·µã€‚æ‚¨å¯ä»¥ä»è¿™é‡Œè·å¾—å®Œæ•´çš„æ‘˜è¦: **[https://microservices.io/patterns/microservices.html](https://microservices.io/patterns/microservices.html)**

è€ƒè™‘åˆ°å®ƒä»¬çš„èŒƒå›´ï¼Œè¿™äº›å¾®æœåŠ¡æ¨¡å¼è¿›ä¸€æ­¥åˆ†ä¸ºå‡ ç±»ã€‚åœ¨æ‰€æœ‰è¿™äº›æ¨¡å¼ä¸­ï¼Œè®¸å¤šå¼€å‘äººå‘˜éƒ½ä½¿ç”¨äº†ä¸€äº›éå¸¸é‡è¦å’Œæµè¡Œçš„æ¨¡å¼ã€‚æ–­è·¯å™¨æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œæœ‰åŠ©äºä»¥é€‚å½“çš„æ–¹å¼ç®¡ç†ä¸‹æ¸¸æœåŠ¡æ•…éšœã€‚è®©æˆ‘ä»¬äº†è§£è¿™ç§æ¨¡å¼çš„ä½œç”¨ã€‚ğŸ’ª

ä¸€ã€æ–­è·¯å™¨ä»‹ç»
=======

### 1.1 ä»€ä¹ˆæ˜¯æ–­è·¯å™¨æ¨¡å¼?

æ‚¨å¯èƒ½å·²ç»å¬è¯´è¿‡æˆ‘ä»¬åœ¨ç”µå­äº§å“ä¸­å‘ç°çš„æ–­è·¯å™¨ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿç®€å•åœ°è¯´ï¼Œåœ¨æ„æƒ³ä¸åˆ°çš„æƒ…å†µä¸‹åˆ‡æ–­ç”µæµã€‚ä¸æ­¤ç›¸åŒï¼Œè¿™ç§å¾®æœåŠ¡æ¨¡å¼ä¹Ÿå› å…¶å…·æœ‰ç›¸åŒçš„æ€§è´¨è€Œå¾—åã€‚

è¿™ç§æ¨¡å¼åœ¨æœåŠ¡ä¹‹é—´è¿›è¡Œé€šä¿¡æ—¶å‡ºç°ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„åœºæ™¯ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªæœåŠ¡ï¼šæœåŠ¡ A å’Œ Bã€‚æœåŠ¡ A æ­£åœ¨è°ƒç”¨æœåŠ¡ Bï¼ˆAPI è°ƒç”¨ï¼‰ä»¥è·å–æ‰€éœ€çš„ä¸€äº›ä¿¡æ¯ã€‚å½“æœåŠ¡ A è°ƒç”¨æœåŠ¡ B æ—¶ï¼Œå¦‚æœæœåŠ¡ B ç”±äºæŸäº›åŸºç¡€è®¾æ–½ä¸­æ–­è€Œå…³é—­ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼ŸæœåŠ¡ A æ²¡æœ‰å¾—åˆ°ç»“æœï¼Œå®ƒå°†å› æŠ›å‡ºå¼‚å¸¸è€ŒæŒ‚èµ·ã€‚ç„¶åå¦ä¸€ä¸ªè¯·æ±‚æ¥äº†ï¼Œå®ƒä¹Ÿé¢ä¸´åŒæ ·çš„æƒ…å†µã€‚å°±åƒè¿™ä¸ªè¯·æ±‚çº¿ç¨‹å°†è¢«é˜»å¡/æŒ‚èµ·ï¼Œç›´åˆ°æœåŠ¡ B å‡ºç°ï¼ç»“æœï¼Œç½‘ç»œèµ„æºå°†è¢«è€—å°½ï¼Œæ€§èƒ½ä½ä¸‹ï¼Œç”¨æˆ·ä½“éªŒå·®ã€‚çº§è”æ•…éšœä¹Ÿå¯èƒ½å› æ­¤å‘ç”Ÿã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ç§æ–­è·¯å™¨æ¨¡å¼æ¥è§£å†³é—®é¢˜ã€‚å®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§åœ¨ä¸æ‰“æ‰°æœ€ç»ˆç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºèµ„æºçš„æƒ…å†µä¸‹å¤„ç†è¿™ç§æƒ…å†µçš„æ–¹æ³•ã€‚

### 1.2 æ¨¡å¼å¦‚ä½•è¿ä½œï¼ŸğŸ’¥

åŸºæœ¬ä¸Šï¼Œå®ƒçš„è¡Œä¸ºä¸ç”µè·¯æ–­è·¯å™¨ç›¸åŒã€‚å½“åº”ç”¨ç¨‹åºçš„è¿œç¨‹æœåŠ¡è°ƒç”¨å¤±è´¥æ¬¡æ•°è¶…è¿‡ç»™å®šé˜ˆå€¼æ—¶ï¼Œæ–­è·¯å™¨å°†åœ¨ç‰¹å®šæ—¶é—´æ®µå†…è·³é—¸ã€‚åœ¨æ­¤è¶…æ—¶åˆ°æœŸåï¼Œæ–­è·¯å™¨å…è®¸æœ‰é™æ•°é‡çš„è¯·æ±‚é€šè¿‡å®ƒã€‚å¦‚æœè¿™äº›è¯·æ±‚æˆåŠŸï¼Œåˆ™æ–­è·¯å™¨å°†å…³é—­å¹¶æ¢å¤æ­£å¸¸æ“ä½œã€‚å¦åˆ™ï¼Œå¦‚æœå®ƒä»¬å¤±è´¥äº†ï¼Œè¶…æ—¶æ—¶é—´å°†é‡æ–°å¼€å§‹ï¼Œç„¶ååƒä»¥å‰ä¸€æ ·åšå‰©ä¸‹çš„äº‹æƒ…ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§æ¦‚å¿µè®²è§£å¸®åŠ©å¤§å®¶æ¥ç†è§£æ–­è·¯å™¨ã€‚ğŸ˜

### 1.3 æ¨¡å¼çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸğŸ’¥

æ–­è·¯å™¨æ¨¡å¼ä¸­è®¨è®ºäº† 3 ä¸ªä¸»è¦çŠ¶æ€ã€‚ä»–ä»¬æ˜¯ï¼š

1.  CLOSED
2.  OPEN
3.  HALF OPEN

è®©æˆ‘ä»¬ç®€è¦äº†è§£ä¸€ä¸‹çŠ¶æ€â€¦â€¦

##### CLOSED State

å½“æ­£åœ¨äº¤äº’çš„ä¸¤ä¸ªæœåŠ¡éƒ½å¯åŠ¨å¹¶è¿è¡Œæ—¶ï¼Œæ–­è·¯å™¨é»˜è®¤å…³é—­ã€‚æ–­è·¯å™¨ä¼šæŒç»­ç»Ÿè®¡è¿œç¨‹ API è°ƒç”¨çš„æ¬¡æ•°ã€‚

##### OPEN State

ä¸€æ—¦è¿œç¨‹ API è°ƒç”¨å¤±è´¥ç™¾åˆ†æ¯”è¶…è¿‡ç»™å®šé˜ˆå€¼ï¼Œæ–­è·¯å™¨å°±ä¼šå°†å…¶çŠ¶æ€æ›´æ”¹ä¸º OPEN çŠ¶æ€ã€‚è°ƒç”¨å¾®æœåŠ¡ä¼šç«‹å³å¤±è´¥ï¼Œè¿”å›å¼‚å¸¸ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæµé‡ä¸­æ–­äº†ã€‚

##### HALF OPEN State

åœ¨ OPEN çŠ¶æ€åœç•™ç»™å®šçš„è¶…æ—¶æ—¶é—´åï¼Œæ–­è·¯å™¨è‡ªåŠ¨å°†å…¶çŠ¶æ€å˜ä¸º HALF OPEN çŠ¶æ€ã€‚åœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œåªå…è®¸æœ‰é™æ•°é‡çš„è¿œç¨‹ API è°ƒç”¨é€šè¿‡ã€‚å¦‚æœå¤±è´¥è°ƒç”¨è®¡æ•°å¤§äºæ­¤æœ‰é™æ•°é‡ï¼Œåˆ™æ–­è·¯å™¨å†æ¬¡å˜ä¸º OPEN çŠ¶æ€ï¼Œæµé‡ç»§ç»­ä¸­æ–­ã€‚å¦åˆ™å…³é—­æ–­è·¯å™¨ï¼Œæµé‡æ¢å¤æ­£å¸¸ã€‚

![Pattern states](https://files.mdnice.com/user/40549/d454281d-9a37-41b3-acc5-cac8bbb08fac.png)

ä¸ºäº†å®é™…æ¼”ç¤ºè¯¥æ¨¡å¼ï¼Œæˆ‘å°†ä½¿ç”¨ Spring Boot æ¡†æ¶æ¥åˆ›å»ºå¾®æœåŠ¡ã€‚å¹¶ç”¨ Resilience4j åº“å®ç°æ–­è·¯å™¨ã€‚

### 1.4 ä»€ä¹ˆ Resilience4j?

Resilience4j æ˜¯ä¸€ä¸ªè½»é‡çº§ã€æ˜“äºä½¿ç”¨çš„å®¹é”™åº“ï¼Œå…¶çµæ„Ÿæ¥è‡ªäº Netflix Hystrixã€‚å®ƒæä¾›å„ç§åŠŸèƒ½å¦‚ä¸‹ï¼š

*   **æ–­è·¯å™¨ â€” å®¹é”™**
*   é€Ÿç‡é™åˆ¶å™¨ â€” é˜»æ­¢å¤ªå¤šè¯·æ±‚
*   æ—¶é—´é™åˆ¶å™¨ â€” è°ƒç”¨è¿œç¨‹æ“ä½œæ—¶çš„é™åˆ¶æ—¶é—´
*   é‡è¯•æœºåˆ¶ â€” å¤±è´¥æ“ä½œè‡ªåŠ¨é‡è¯•
*   éš”æ¿ â€” é™åˆ¶å¹¶å‘è¯·æ±‚æ•°
*   ç¼“å­˜ â€” å­˜å‚¨è¿œç¨‹æ“ä½œçš„ç»“æœ

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†åŸºäº Spring Boot é¡¹ç›®æ¥ä½¿ç”¨ç¬¬ä¸€ä¸ªåŠŸèƒ½ã€‚ğŸ˜

äºŒã€ä»£ç è®²è§£
======

### 2.1 åˆ›å»º 2ï¸âƒ£ ä¸ªå¾®æœåŠ¡

æˆ‘å°†ä½¿ç”¨åä¸º loan-serviceï¼ˆè´·æ¬¾ï¼‰ å’Œ rate-serviceï¼ˆåˆ©ç‡ï¼‰ çš„ä¸¤ä¸ªæœåŠ¡æ¥å®ç°ä¸€ä¸ªç®€å•çš„æœåŠ¡é—´é€šä¿¡åœºæ™¯ã€‚

##### æŠ€æœ¯ç»†èŠ‚ï¼š

å¸¦æœ‰ H2 å†…å­˜ä¸­ DBã€JPAã€Hibernateã€Actuatorã€Resilience4j çš„ Spring Boot

##### è„šæœ¬ï¼š

è´·æ¬¾æœåŠ¡å¯ä»¥è·å–ä¿å­˜åœ¨æ•°æ®åº“ä¸­çš„è´·æ¬¾ï¼Œæ¯ä¸ªè´·æ¬¾å¯¹è±¡éƒ½æœ‰è´·æ¬¾ç±»å‹ã€‚æ ¹æ®è´·æ¬¾ç±»å‹ï¼Œæœ‰å•ç‹¬çš„åˆ©ç‡ç™¾åˆ†æ¯”ã€‚å› æ­¤ï¼Œåˆ©ç‡æœåŠ¡çš„åç§°åŒ…å«é‚£äº›åˆ©ç‡å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚

*   æˆ‘å°†ä»è´·æ¬¾æœåŠ¡è°ƒç”¨åˆ©ç‡æœåŠ¡ï¼Œè¯·æ±‚ç»™å®šè´·æ¬¾ç±»å‹çš„åˆ©ç‡ã€‚
*   ç„¶åæˆ‘å¿…é¡»æ ¹æ®è´·æ¬¾ç±»å‹è®¡ç®—è´·æ¬¾çš„æ€»åˆ©æ¯ä»·å€¼ã€‚
*   ç„¶åæˆ‘å°†ä½¿ç”¨ä»åˆ©ç‡æœåŠ¡è·å¾—çš„åˆ©ç‡æ›´æ–°æ‰€æœ‰è´·æ¬¾å¯¹è±¡çš„åˆ©æ¯é‡‘é¢ã€‚

![Project setup](https://files.mdnice.com/user/40549/1df8a6ba-88c7-45b0-a5ff-a9454ee8a4f0.png)

ç”±äºè´¹ç‡æœåŠ¡æ˜¯ç‹¬ç«‹çš„ï¼Œæˆ‘å°†é¦–å…ˆå®ç°è´¹ç‡æœåŠ¡çš„åŸºæœ¬åŠŸèƒ½ã€‚

ä½¿ç”¨ POM æ–‡ä»¶ä¸‹æ–¹æä¾›çš„ä¾èµ–é¡¹åˆ›å»ºä¸€ä¸ªæ–°çš„ Spring Boot é¡¹ç›®ã€‚æˆ‘å°†å…¶å‘½åä¸ºè´¹ç‡æœåŠ¡ã€‚**[https://github.com/SalithaUCSC/spring-boot-circuit-breaker/blob/main/rate-service/pom.xml](https://github.com/SalithaUCSC/spring-boot-circuit-breaker/blob/main/rate-service/pom.xml)**

##### Controller:

    @RestController
    @RequestMapping("api")
    public class RateController {
    
        @Autowired
        private RateService rateService;
    
        @GetMapping(path = "/rates/{type}")
        public ResponseEntity<Rate> getRateByType(@PathVariable("type") String type) {
            return ResponseEntity.ok().body(rateService.getRateByType(type));
        }
    }
    

##### Service:

    @Service
    public class RateService {
    
        @Autowired
        private RateRepository repository;
    
        public Rate getRateByType(String type) {
            return repository.findByType(type).orElseThrow(() -> new RuntimeException("Rate Not Found: " + type));
        }
    }
    

##### Repository:

    @Repository
    public interface RateRepository extends JpaRepository<Rate, Integer> {
        Optional<Rate> findByType(String type);
    }
    

##### Entity:

    @Builder
    @Getter
    @Setter
    @AllArgsConstructor
    @NoArgsConstructor
    @Entity
    @Table(name = "rates")
    public class Rate {
        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        Integer id;
        String type;
        @Column(name = "rate")
        Double rateValue;
    }
    

##### Configuration:

    server:
      port: 9000
    spring:
      application:
        name: rate-service
      datasource:
        url: jdbc:h2:mem:cb-rate-db
        username: root
        password: 123
        driverClassName: org.h2.Driver
      jpa:
        database-platform: org.hibernate.dialect.H2Dialect
        hibernate:
          ddl-auto: create-drop
      h2:
        console:
          enabled: true
    

##### å¯åŠ¨ç±»ï¼šä¸»ç±»å°†åœ¨æœåŠ¡å³å°†åˆ°æ¥æ—¶æ·»åŠ ä¸¤ç§ç±»å‹çš„è´·æ¬¾åˆ©ç‡ã€‚

    @SpringBootApplication
    public class RateServiceApplication {
    
       @Autowired
       private RateRepository rateRepository;
    
       public static void main(String[] args) {
          SpringApplication.run(RateServiceApplication.class, args);
       }
    
       @PostConstruct
       public void setupData() {
          rateRepository.saveAll(Arrays.asList(
             Rate.builder().id(1).typå¹¶æ£€æŸ¥æˆ‘ä»¬éœ€è¦çš„ APIe("PERSONAL").rateValue(10.0).build(),
             Rate.builder().id(2).type("HOUSING").rateValue(8.0).build()
          ));
       }
    }
    

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯åŠ¨ rate-service å¹¶æ£€æŸ¥æˆ‘ä»¬éœ€è¦çš„ APIã€‚è½¬åˆ° **[http://localhost:9000/api/rates/PERSONAL](http://localhost:9000/api/rates/PERSONAL)** å¹¶æŸ¥çœ‹ç»“æœã€‚ä½ åº”è¯¥å¾—åˆ°è¿™ä¸ªå›åº”ã€‚

    {"id": 1,"type": "PERSONAL","rateValue": 10}
    

### 2.2 è´·æ¬¾æœåŠ¡æ·»åŠ æ–­è·¯å™¨

ç°åœ¨æˆ‘éœ€è¦å®æ–½è´·æ¬¾æœåŠ¡ã€‚ loan-service å†…éƒ¨éœ€è¦æ–­è·¯å™¨ï¼Œå› ä¸ºå®ƒæ­£åœ¨è°ƒç”¨ rate-serviceã€‚å› æ­¤ï¼Œéœ€è¦ Resilience4j åº“ã€‚æˆ‘éœ€è¦æ£€æŸ¥æ–­è·¯å™¨çš„çŠ¶æ€ã€‚ä¸ºæ­¤ï¼Œæˆ‘éœ€è¦åœ¨è´·æ¬¾æœåŠ¡ä¸­å¯ç”¨ Actuatorã€‚

ä½¿ç”¨ POM æ–‡ä»¶ä¸‹æ–¹æä¾›çš„ä¾èµ–é¡¹åˆ›å»ºä¸€ä¸ªæ–°çš„ Spring Boot é¡¹ç›®ã€‚æˆ‘å°†å…¶å‘½åä¸ºè´·æ¬¾æœåŠ¡ã€‚  
**[https://github.com/SalithaUCSC/spring-boot-circuit-breaker/blob/main/loan-service/pom.xml](https://github.com/SalithaUCSC/spring-boot-circuit-breaker/blob/main/loan-service/pom.xml)**

è®©æˆ‘ä»¬ä¸ºè´·æ¬¾æœåŠ¡æ·»åŠ åŸºæœ¬åŠŸèƒ½ã€‚

##### Controller:

    @RestController
    @RequestMapping("api")
    public class LoanController {
    
        @Autowired
        private LoanService loanService;
    
        @GetMapping(path = "/loans")
        public ResponseEntity<List<Loan>> getLoansByType(@RequestParam("type") String type) {
            return ResponseEntity.ok().body(loanService.getAllLoansByType(type.toUpperCase()));
        }
    
    }
    

##### Repository:

    public interface LoanRepository extends JpaRepository<Loan, Integer> {
        List<Loan> findByType(String type);
    }
    

##### DTOï¼šè¿™ç”¨äºè½¬æ¢æ¥è‡ªè´¹ç‡æœåŠ¡ API è°ƒç”¨çš„å“åº”ã€‚å› ä¸ºå®ƒæ˜¯ Rate çš„ç±»å‹ã€‚åŒrate-service Rateå®ä½“ç±»ï¼ˆåªæ˜¯çœç•¥äº†ORMç›¸å…³çš„ä¸œè¥¿ï¼‰

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    public class InterestRate {
        Integer id;
        String type;
        Double rateValue;
    }
    

##### Entity:

    @Builder
    @Getter
    @Setter
    @AllArgsConstructor
    @NoArgsConstructor
    @Entity
    @Table(name = "loans")
    public class Loan {
        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        Integer id;
        String type;
        Double amount;
        Double interest;
    }
    

##### å¯åŠ¨ç±»ï¼š

*   ä¸»ç±»å°†åœ¨æœåŠ¡å³å°†åˆ°æ¥æ—¶æ·»åŠ  3 ä¸ªè´·æ¬¾å¯¹è±¡ã€‚åˆ©æ¯é‡‘é¢å·²è®¾ç½®ä¸ºé›¶ï¼Œå› ä¸ºæˆ‘ä»¬åæ¥é€šè¿‡è¿œç¨‹è°ƒç”¨ rate-service å¯¹å…¶è¿›è¡Œäº†æ›´æ–°ã€‚
*   æˆ‘ä»¬éœ€è¦ä¸€ä¸ª RestTemplate ç±»çš„ Bean æ¥æ‰§è¡Œè¿œç¨‹ API è°ƒç”¨ã€‚å¦‚æœæ‚¨ä¸çŸ¥é“ï¼Œè¯·ä»æ­¤å¤„é˜…è¯»: **[https://salithachathuranga94.medium.com/rest-template-with-spring-boot-e2001a8219e6](https://salithachathuranga94.medium.com/rest-template-with-spring-boot-e2001a8219e6)**

    @SpringBootApplication
    public class LoanServiceApplication {
    
       @Autowired
       private LoanRepository loanRepository;
    
       public static void main(String[] args) {
          SpringApplication.run(LoanServiceApplication.class, args);
       }
    
       @Bean
       public RestTemplate restTemplate() {
          return new RestTemplate();
       }
    
       @PostConstruct
       public void setupData() {
          loanRepository.saveAll(Arrays.asList(
             Loan.builder().id(1).type("PERSONAL").amount(200000.0).interest(0.0).build(),
             Loan.builder().id(2).type("HOUSING").amount(6000000.0).interest(0.0).build(),
             Loan.builder().id(3).type("PERSONAL").amount(100000.0).interest(0.0).build()
          ));
       }
    }
    

##### Service:

è¿™æ˜¯æˆ‘ä»¬æ‰§è¡Œè¿œç¨‹è°ƒç”¨çš„æœ€é‡è¦çš„åœ°æ–¹ã€‚æˆ‘ä»¬éœ€è¦åœ¨åˆ©ç‡æœåŠ¡ä¸­ä½¿ç”¨ RestTemplate: **[http://localhost:9000/api/rates/{type}](http://localhost:9000/api/rates/%7Btype%7D)** è°ƒç”¨æ­¤ API ä»¥è·å–è´·æ¬¾ç±»å‹çš„ç™¾åˆ†æ¯”ã€‚ç„¶åæˆ‘ä»¬è®¡ç®—åˆ©æ¯é‡‘é¢ä¸ºè´·æ¬¾é‡‘é¢\*ï¼ˆåˆ©ç‡/100ï¼‰å¹¶æ›´æ–°è´·æ¬¾åˆ©æ¯é‡‘é¢ã€‚

    @Service
    public class LoanService {
        @Autowired
        private LoanRepository loanRepository;
        @Autowired
        private RestTemplate restTemplate;
        private static final String SERVICE_NAME = "loan-service";
        private static final String RATE_SERVICE_URL = "http://localhost:9000/api/rates/";
        public List<Loan> getAllLoansByType(String type) {
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            HttpEntity<InterestRate> entity = new HttpEntity<>(null, headers);
            ResponseEntity<InterestRate> response = restTemplate.exchange(
                (RATE_SERVICE_URL + type),
                HttpMethod.GET, entity,
                InterestRate.class
            );
            InterestRate rate = response.getBody();
            List<Loan> loanList = new ArrayList<>();
            if (rate != null) {
                loanList = loanRepository.findByType(type);
                for (Loan loan : loanList) {
                    loan.setInterest(loan.getAmount() * (rate.getRateValue() / 100));
                }
            }
            return loanList;
        }
    }
    

##### Configuration:

    server:
      port: 8000
    spring:
      application:
        name: loan-service
      datasource:
        url: jdbc:h2:mem:cb-loan-db
        username: root
        password: 123
        driverClassName: org.h2.Driver
      jpa:
        database-platform: org.hibernate.dialect.H2Dialect
        hibernate:
          ddl-auto: create-drop
      h2:
        console:
          enabled: true
    management:
      endpoint:
        health:
          show-details: always
      endpoints:
        web:
          exposure:
            include: health
      health:
        circuitbreakers:
          enabled: true
    

> æˆ‘ä»¬éœ€è¦åœ¨æ‰§è¡Œå™¨æš´æ¼æ–­è·¯å™¨è¯¦ç»†ä¿¡æ¯ï¼ˆæš´æ¼ç«¯ç‚¹ï¼‰ã€‚ç¨åæˆ‘ä»¬å°†åœ¨æ­¤å¤„æ·»åŠ æ–­è·¯å™¨é…ç½®ã€‚ç›®å‰ï¼Œä¸éœ€è¦ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯åŠ¨ rate-service å¹¶æ£€æŸ¥æˆ‘ä»¬éœ€è¦çš„ APIã€‚è½¬åˆ° **[http://localhost:8000/api/loans?type=personal](http://localhost:8000/api/loans?type=personal)** å¹¶æŸ¥çœ‹ç»“æœã€‚ä½ åº”è¯¥å¾—åˆ°è¿™ä¸ªå›åº”ã€‚

    [
    {"id": 1,"type": "PERSONAL","amount": 200000,"interest": 20000}, 
    {"id": 3,"type": "PERSONAL","amount": 100000,"interest": 10000}
    ]
    

### 2.3 æ·»åŠ å›é€€æ–¹æ³•ğŸ’¥

ç°åœ¨æˆ‘ä»¬å¿…é¡»ç”¨æ³¨é‡Šæ¥ä¸°å¯Œæˆ‘ä»¬çš„ Loan æœåŠ¡æ–¹æ³•ã€‚å®ƒè¢«ç§°ä¸º â€œ@CircuitBreakerâ€ã€‚åœ¨è¿™é‡Œï¼ŒSERVICE\_NAME è¢«è§†ä¸ºâ€œè´·æ¬¾æœåŠ¡â€ã€‚ç„¶åæˆ‘ä»¬å¿…é¡»æä¾›ä¸€ä¸ª fallbackMethodã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯å½“ä¸‹æ¸¸æœâ€‹â€‹åŠ¡ï¼ˆé€Ÿç‡æœåŠ¡ï¼‰æ— æ³•å“åº”æ—¶é»˜è®¤è°ƒç”¨å®ƒã€‚

    @CircuitBreaker(name = SERVICE_NAME, fallbackMethod = "getDefaultLoans")
    public List<Loan> getAllLoansByType(String type) {
             ...............
    }
    

æˆ‘å·²ç»è®¾ç½®äº†å½“è´¹ç‡æœåŠ¡æ²¡æœ‰å“åº”æ—¶é»˜è®¤è¿”å›ç©ºåˆ—è¡¨çš„æ–¹æ³•ã€‚

> æ‚¨å¯ä»¥è®¾ç½®æ­¤æ–¹æ³•ä»¥æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œè€Œä¸å‘é€ç©ºæ¶ˆæ¯ã€‚ä½ å¯ä»¥è¿”å›è¿™æ ·çš„ä¸œè¥¿ â€” â€œRate service is not responding.è¯·æ±‚å¤±è´¥ï¼â€ã€‚å‘é€ç©ºæ•°ç»„æˆ–ä¸€ç»„é»˜è®¤æ•°æ®ä¸æ˜¯ç†æƒ³çš„æ–¹å¼ã€‚å› ä¸ºè¿™ä¼šç»™ç”¨æˆ·å¸¦æ¥å›°æƒ‘ã€‚ä½†æ˜¯æ‚¨å¿…é¡»ç¡®ä¿è¿™ä¸¤ç§æ–¹æ³•éƒ½è¿”å›ç›¸åŒç±»å‹çš„æ•°æ®ã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼šä¸¤ç§æ–¹æ³•éƒ½è¿”å›åˆ—è¡¨ï¼

    public List<Loan> getDefaultLoans(Exception e) {
        return new ArrayList<>();
    }
    

### 2.4 æ·»åŠ æ–­è·¯å™¨é…ç½®ğŸ’¥

è®©æˆ‘ä»¬æ·»åŠ  Resilience4j æ–­è·¯å™¨é…ç½®ã€‚å°†æ­¤æ·»åŠ åˆ°è´·æ¬¾æœåŠ¡ä¸­çš„ application.ymlã€‚

    resilience4j:
      circuitbreaker:
        instances:
          loan-service:
            registerHealthIndicator: true
            failureRateThreshold: 50
            minimumNumberOfCalls: 5
            automaticTransitionFromOpenToHalfOpenEnabled: true
            waitDurationInOpenState: 5s
            permittedNumberOfCallsInHalfOpenState: 3
            slidingWindowSize: 10
            slidingWindowType: COUNT_BASED
    

*   failureRateThreshold â€” å¤±è´¥é˜ˆå€¼çš„é¢„æœŸç™¾åˆ†æ¯”ã€‚æˆ‘å°†å…¶è®¾ç½®ä¸º 50%ã€‚è¿™æ„å‘³ç€ï¼Œå½“å¤±è´¥çš„è¿œç¨‹è°ƒç”¨æ€»æ•° % ç­‰äºæˆ–å¤§äº 50% æ—¶ï¼Œæ–­è·¯å™¨å°†å¤„äºæ´»åŠ¨çŠ¶æ€ä»¥åœæ­¢è¿›ä¸€æ­¥çš„è¯·æ±‚ã€‚
*   minimumNumberOfCalls â€” å†³å®šå¯ç”¨æ–­è·¯å™¨çš„å¤±è´¥ç™¾åˆ†æ¯”çš„ API è°ƒç”¨æ€»æ•°çš„æœ€å°å€¼ã€‚æˆ‘å°†å…¶è®¾ç½®ä¸º 5ã€‚å‡è®¾å‰ 5 ä¸ª API è°ƒç”¨ä¸­æœ‰ 3 ä¸ª API è°ƒç”¨å¤±è´¥ã€‚è¿™æ„å‘³ç€ failureRateThreshold = (3/5) \* 100 = 60%ã€‚
*   automaticTransitionFromOpenToHalfOpenEnabled â€” æˆ‘å·²å°†å…¶è®¾ç½®ä¸º trueã€‚å½“è½¬æ¢çš„æ­£ç¡®æ—¶é—´åˆ°æ¥æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å°† OPEN çŠ¶æ€è½¬æ¢ä¸º HALF OPEN çŠ¶æ€
*   waitDurationInOpenState â€” ä» OPEN çŠ¶æ€è¿›å…¥ HALF OPEN çŠ¶æ€ä¹‹å‰çš„è¶…æ—¶æ—¶é—´ã€‚ 5 ç§’åï¼Œæ–­è·¯å™¨å°±å°†æ›´æ”¹çŠ¶æ€ã€‚
*   permittedNumberOfCallsInHalfOpenState â€” åœ¨ HALF OPEN çŠ¶æ€ä¸‹åº”å‘é€çš„ LIMITED API è°ƒç”¨æ•°ã€‚æˆ‘å°†å…¶è®¾ç½®ä¸º 3ã€‚å› æ­¤ï¼Œåœ¨ 3 æ¬¡ API è°ƒç”¨ä¹‹åï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™æ–­è·¯å™¨å°†å†æ¬¡è¿›å…¥ OPEN çŠ¶æ€ã€‚å¦åˆ™æ–­è·¯å™¨å°†å…³é—­ï¼Œå› ä¸º rate-service å·²å¯åŠ¨ã€‚
*   slidingWindowTypeï¼šæˆ‘åœ¨è¿™é‡Œè®¾ç½®äº†ç±»å‹ä»¥æ ¹æ®è¯·æ±‚è®¡æ•°ä¿æŒæ–­è·¯å™¨è¡Œä¸ºã€‚

å¯åŠ¨è¿™ä¸¤ä¸ªæœåŠ¡ã€‚ç°åœ¨è½¬åˆ°è´·æ¬¾æœåŠ¡ï¼Œè¾“å…¥ç›‘æ§ç«¯ç‚¹ URLï¼š**[http://localhost:8000/actuator/health](http://localhost:8000/actuator/health)**ã€‚æ–­è·¯å™¨çš„è¯¦ç»†ä¿¡æ¯ä¼šåœ¨å“åº”ä¸­çªå‡ºæ˜¾ç¤ºã€‚

    {
      "status": "UP",
      "components": {
        "circuitBreakers": {
          "status": "UP",
          "details": {
            "loan-service": {
              "status": "UP",
              "details": {
                "failureRate": "-1.0%",
                "failureRateThreshold": "50.0%",
                "slowCallRate": "-1.0%",
                "slowCallRateThreshold": "100.0%",
                "bufferedCalls": 1,
                "slowCalls": 0,
                "slowFailedCalls": 0,
                "failedCalls": 0,
                "notPermittedCalls": 0,
                "state": "CLOSED"
              }
            }
          }
        },
       ......................................
      }
    }
    

*   bufferedCalls â€” ä»è´·æ¬¾æœåŠ¡åˆ°åˆ©ç‡æœåŠ¡çš„æ€» API è°ƒç”¨
*   failedCalls - ä»è´·æ¬¾æœåŠ¡åˆ°åˆ©ç‡æœåŠ¡çš„å¤±è´¥ API è°ƒç”¨æ€»æ•°
*   failureRate â€” (failedCalls/bufferedCalls) \* 100%

### 2.5 æµ‹è¯•æ–­è·¯å™¨ğŸ’¥

æˆ‘ä»¬å¿…é¡»éµå¾ªä¸€äº›æœ‰åºçš„æ­¥éª¤æ‰èƒ½å‡†ç¡®åœ°çœ‹åˆ°å˜åŒ–ã€‚åœ¨æ¯ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»æŸ¥çœ‹ç›‘æ§ç«¯ç‚¹ï¼Œå¹¶é€šè¿‡æ›´æ”¹å…¶çŠ¶æ€æŸ¥çœ‹æ–­è·¯å™¨çš„è¡Œä¸ºæ–¹å¼ã€‚å¼€å§‹ï¼ğŸ’ª

*   å¯åŠ¨ä¸¤ä¸ªå¾®æœåŠ¡ã€‚è´·æ¬¾æœåŠ¡åœ¨ 8000 ä¸Šè¿è¡Œï¼Œåˆ©ç‡æœåŠ¡åœ¨ 9000 ä¸Šè¿è¡Œã€‚
*   ç°åœ¨ç‚¹å‡»æ­¤ API 2 æ¬¡ï¼š**[http://localhost:8000/api/loans?type=personal](http://localhost:8000/api/loans?type=personal)**ã€‚ç„¶åå»æ£€æŸ¥ç›‘æ§ç«¯ç‚¹ **[http://localhost:8000/actuator/health](http://localhost:8000/actuator/health)**ã€‚ç°åœ¨ bufferedCalls è®¡æ•°å·²æŒ‰é¢„æœŸæ›´æ–°ä¸º 2ã€‚ç”±äºè´¹ç‡æœåŠ¡å·²å¯åŠ¨ï¼Œæ–­è·¯å™¨ä»å¤„äºå…³é—­çŠ¶æ€ã€‚

    {
        "loan-service": {
            "status": "UP",
            "details": {
                "failureRate": "-1.0%",
                "failureRateThreshold": "50.0%",
                "slowCallRate": "-1.0%",
                "slowCallRateThreshold": "100.0%",
                "bufferedCalls": 2,
                "slowCalls": 0,
                "slowFailedCalls": 0,
                "failedCalls": 0,
                "notPermittedCalls": 0,
                "state": "CLOSED"
            }
        }
    }
    

*   ç°åœ¨åœæ­¢è´¹ç‡æœåŠ¡ï¼ç„¶åç‚¹å‡»è´·æ¬¾æœåŠ¡ API URL 3æ¬¡ï¼š**[http://localhost:8000/api/loans?type=personal](http://localhost:8000/api/loans?type=personal)**ã€‚ä½ åº”è¯¥å¾—åˆ°ä¸€ä¸ªæˆ‘ä»¬è®¾ç½®ä¸ºåå¤‡çš„ç©ºæ•°ç»„ï¼è¿™å°†ä½¿ bufferedCalls è®¡æ•°ä¸º 5ï¼ˆå‰ 2 ä¸ªå’Œè¿™ä¸ª 3ï¼‰ã€‚åŒæ—¶ï¼ŒfailedCalls è®¡æ•°æ›´æ–°ä¸º 3ã€‚ç°åœ¨ failureRate å˜ä¸º 60%( (3/5) \* 100% )ã€‚ç„¶åå®ƒå·²ç»è¶…è¿‡äº†æˆ‘ä»¬çš„é˜ˆå€¼ï¼š50%ã€‚ğŸ˜€ç„¶åæ–­è·¯å™¨å°†å…¶çŠ¶æ€æ›´æ”¹ä¸º OPENï¼ğŸ˜

    {
        "loan-service": {
            "status": "CIRCUIT_OPEN",
            "details": {
                "failureRate": "60.0%",
                "failureRateThreshold": "50.0%",
                "slowCallRate": "0.0%",
                "slowCallRateThreshold": "100.0%",
                "bufferedCalls": 5,
                "slowCalls": 0,
                "slowFailedCalls": 0,
                "failedCalls": 3,
                "notPermittedCalls": 0,
                "state": "OPEN"
            }
        }
    }
    

*   ç„¶åç­‰å¾… 5 ç§’é’Ÿã€‚å®ƒåº”è¯¥åœ¨ 5 ç§’åè½¬æ¢ä¸ºåŠå¼€çŠ¶æ€ï¼Œæ ¹æ®æˆ‘ä»¬çš„é…ç½®ï¼Œæˆ‘ä»¬å°† waitDurationInOpenState è®¾ç½®ä¸º 5s è¿™æ˜¯è¶…æ—¶æ—¶é—´ã€‚åœ¨è¿™æ®µæ—¶é—´ä¹‹åï¼Œè¯·æ±‚è®¡æ•°ä¹Ÿå°†è¢«é‡ç½®ã€‚

    {
        "loan-service": {
            "status": "CIRCUIT_HALF_OPEN",
            "details": {
                "failureRate": "-1.0%",
                "failureRateThreshold": "50.0%",
                "slowCallRate": "-1.0%",
                "slowCallRateThreshold": "100.0%",
                "bufferedCalls": 0,
                "slowCalls": 0,
                "slowFailedCalls": 0,
                "failedCalls": 0,
                "notPermittedCalls": 0,
                "state": "HALF_OPEN"
            }
        }
    }
    

*   åœ¨ HALF OPEN çŠ¶æ€ä¸‹ï¼Œæœ‰é™æ•°é‡çš„è¯·æ±‚å°†è¢«å…è®¸é€šè¿‡ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒåœ¨é…ç½®ä¸­ä¸º 3ï¼Œç›¸å…³å€¼å·²è®¾ç½®ä¸º permittedNumberOfCallsInHalfOpenState: 3ã€‚

ç”±äº rate-service ä»ç„¶å…³é—­ï¼Œåªéœ€å†æ¬¡å°è¯• loan-service API 3æ¬¡ï¼**[http://localhost:8000/api/loans?type=personal](http://localhost:8000/api/loans?type=personal)** å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿ 3æ¬¡è°ƒç”¨å…¨éƒ¨å¤±è´¥ï¼é‚£ä¹ˆ failureRate å°±æ˜¯ 100%ã€‚æˆ‘ä»¬çš„æ–­è·¯å™¨å°†å†æ¬¡æ‰“å¼€ã€‚

    {
        "loan-service": {
            "status": "CIRCUIT_OPEN",
            "details": {
                "failureRate": "100.0%",
                "failureRateThreshold": "50.0%",
                "slowCallRate": "0.0%",
                "slowCallRateThreshold": "100.0%",
                "bufferedCalls": 3,
                "slowCalls": 0,
                "slowFailedCalls": 0,
                "failedCalls": 3,
                "notPermittedCalls": 0,
                "state": "OPEN"
            }
        }
    }
    

*   è¶…æ—¶ 5 ç§’åï¼Œå®ƒå°†å†æ¬¡å˜ä¸ºåŠå¼€çŠ¶æ€ï¼ä½¿ç”¨æ‰§è¡Œå™¨å†æ¬¡æ£€æŸ¥ã€‚ä½ åº”è¯¥å¾—åˆ°ä¸€ä¸ªç”¨äºè´·æ¬¾æœåŠ¡ API è°ƒç”¨çš„ç©ºæ•°ç»„...
*   ç°åœ¨å¼€å§‹æ”¶è´¹æœåŠ¡ï¼ğŸ˜ç„¶åå†æ¬¡å°è¯•æ­¤ API 3æ¬¡ï¼š**[http://localhost:8000/api/loans?type=personal](http://localhost:8000/api/loans?type=personal)** å‘ç°æ–­è·¯å™¨å·²å…³é—­ï¼ğŸ˜å› ä¸ºæˆåŠŸæ‰§è¡Œäº†é¢„æœŸçš„æœ‰é™ API è°ƒç”¨è®¡æ•°ã€‚

    {
        "loan-service": {
            "status": "UP",
            "details": {
                "failureRate": "-1.0%",
                "failureRateThreshold": "50.0%",
                "slowCallRate": "-1.0%",
                "slowCallRateThreshold": "100.0%",
                "bufferedCalls": 0,
                "slowCalls": 0,
                "slowFailedCalls": 0,
                "failedCalls": 0,
                "notPermittedCalls": 0,
                "state": "CLOSED"
            }
        }
    }
    

è‡ªæ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†æ–­è·¯å™¨çš„æµ‹è¯•å·¥ä½œã€‚æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼ŸğŸ˜å®ƒæ­£åœ¨æŒ‰é¢„æœŸå·¥ä½œï¼

å®Œæ•´çš„æºä»£ç å¯ä»¥åœ¨è¿™ä¸ª GitHub å­˜å‚¨åº“ä¸­æ‰¾åˆ°ï¼š**[https://github.com/SalithaUCSC/spring-boot-circuit-breaker](https://github.com/SalithaUCSC/spring-boot-circuit-breaker)**

> æœ€åæ„Ÿè°¢å¤§å®¶é˜…è¯»ï¼Œå¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½ä¸ºä½ æä¾›ä»·å€¼ã€‚å…¬ä¼—å·ã€waynblogã€‘åˆ†äº«æŠ€æœ¯å¹²è´§ã€å¼€æºé¡¹ç›®ã€å®æˆ˜ç»éªŒã€é«˜æ•ˆå¼€å‘å·¥å…·ç­‰ï¼Œæ‚¨çš„å…³æ³¨å°†æ˜¯æˆ‘çš„æ›´æ–°åŠ¨åŠ›ğŸ˜˜ã€‚