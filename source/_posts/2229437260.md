---
layout: post
title: "ç¼–ç å™¨ | åŸºäºŽ Transformers çš„ç¼–ç å™¨-è§£ç å™¨æ¨¡åž‹"
date: "2023-06-06T01:19:32.170Z"
---
ç¼–ç å™¨ | åŸºäºŽ Transformers çš„ç¼–ç å™¨-è§£ç å™¨æ¨¡åž‹
================================

åŸºäºŽ transformer çš„ç¼–ç å™¨-è§£ç å™¨æ¨¡åž‹æ˜¯ _è¡¨å¾å­¦ä¹ _ å’Œ _æ¨¡åž‹æž¶æž„_ è¿™ä¸¤ä¸ªé¢†åŸŸå¤šå¹´ç ”ç©¶æˆæžœçš„ç»“æ™¶ã€‚æœ¬æ–‡ç®€è¦ä»‹ç»äº†ç¥žç»ç¼–ç å™¨-è§£ç å™¨æ¨¡åž‹çš„åŽ†å²ï¼Œæ›´å¤šèƒŒæ™¯çŸ¥è¯†ï¼Œå»ºè®®è¯»è€…é˜…è¯»ç”± Sebastion Ruder æ’°å†™çš„è¿™ç¯‡ç²¾å½© [åšæ–‡](https://ruder.io/a-review-of-the-recent-history-of-nlp/)ã€‚æ­¤å¤–ï¼Œå»ºè®®è¯»è€…å¯¹ _è‡ªæ³¨æ„åŠ› (self-attention) æž¶æž„_ æœ‰ä¸€ä¸ªåŸºæœ¬äº†è§£ï¼Œå¯ä»¥é˜…è¯» Jay Alammar çš„ [è¿™ç¯‡åšæ–‡](http://jalammar.github.io/illustrated-transformer/) å¤ä¹ ä¸€ä¸‹åŽŸå§‹ transformer æ¨¡åž‹ã€‚

æœ¬æ–‡åˆ† 4 ä¸ªéƒ¨åˆ†:

*   èƒŒæ™¯ - _ç®€è¦å›žé¡¾äº†ç¥žç»ç¼–ç å™¨-è§£ç å™¨æ¨¡åž‹çš„åŽ†å²ï¼Œé‡ç‚¹å…³æ³¨åŸºäºŽ RNN çš„æ¨¡åž‹ã€‚_
*   ç¼–ç å™¨-è§£ç å™¨ - _é˜è¿°åŸºäºŽ transformer çš„ç¼–ç å™¨-è§£ç å™¨æ¨¡åž‹ï¼Œå¹¶é˜è¿°å¦‚ä½•ä½¿ç”¨è¯¥æ¨¡åž‹è¿›è¡ŒæŽ¨ç†ã€‚_
*   ç¼–ç å™¨ - _é˜è¿°æ¨¡åž‹çš„ç¼–ç å™¨éƒ¨åˆ†ã€‚_
*   è§£ç å™¨ - _é˜è¿°æ¨¡åž‹çš„è§£ç å™¨éƒ¨åˆ†ã€‚_

æ¯ä¸ªéƒ¨åˆ†éƒ½å»ºç«‹åœ¨å‰ä¸€éƒ¨åˆ†çš„åŸºç¡€ä¸Šï¼Œä½†ä¹Ÿå¯ä»¥å•ç‹¬é˜…è¯»ã€‚è¿™ç¯‡åˆ†äº«æ˜¯ç¬¬ä¸‰éƒ¨åˆ† **ç¼–ç å™¨**ã€‚

ç¼–ç å™¨
---

å¦‚å‰ä¸€èŠ‚æ‰€è¿°ï¼Œ _åŸºäºŽ transformer_ çš„ç¼–ç å™¨å°†è¾“å…¥åºåˆ—æ˜ å°„åˆ°ä¸Šä¸‹æ–‡ç›¸å…³çš„ç¼–ç åºåˆ—:

\\\[f\_{\\theta\_{\\text{enc}}}: \\mathbf{X}\_{1:n} \\to \\mathbf{\\overline{X}}\_{1:n} \\\]

ä»”ç»†è§‚å¯Ÿæž¶æž„ï¼ŒåŸºäºŽ transformer çš„ç¼–ç å™¨ç”±è®¸å¤š _æ®‹å·®æ³¨æ„åŠ›æ¨¡å—_ å †å è€Œæˆã€‚æ¯ä¸ªç¼–ç å™¨æ¨¡å—éƒ½åŒ…å«ä¸€ä¸ª **åŒå‘** è‡ªæ³¨æ„åŠ›å±‚ï¼Œå…¶åŽè·Ÿç€ä¸¤ä¸ªå‰é¦ˆå±‚ã€‚è¿™é‡Œï¼Œä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å¿½ç•¥å½’ä¸€åŒ–å±‚ (normalization layer)ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä¸ä¼šæ·±å…¥è®¨è®ºä¸¤ä¸ªå‰é¦ˆå±‚çš„ä½œç”¨ï¼Œä»…å°†å…¶è§†ä¸ºæ¯ä¸ªç¼–ç å™¨æ¨¡å— \\({}^1\\) çš„è¾“å‡ºæ˜ å°„å±‚ã€‚åŒå‘è‡ªæ³¨æ„å±‚å°†æ¯ä¸ªè¾“å…¥å‘é‡ \\(\\mathbf{x'}\_j, \\forall j \\in {1, \\ldots, n}\\) ä¸Žå…¨éƒ¨è¾“å…¥å‘é‡ \\(\\mathbf{x'}\_1, \\ldots, \\mathbf{x'}\_n\\) ç›¸å…³è”å¹¶é€šè¿‡è¯¥æœºåˆ¶å°†æ¯ä¸ªè¾“å…¥å‘é‡ \\(\\mathbf{x'}\_j\\) æç‚¼ä¸ºä¸Žå…¶è‡ªèº«ä¸Šä¸‹æ–‡ç›¸å…³çš„è¡¨å¾: \\(\\mathbf{x''}\_j\\)ã€‚å› æ­¤ï¼Œç¬¬ä¸€ä¸ªç¼–ç å™¨å—å°†è¾“å…¥åºåˆ— \\(\\mathbf{X}\_{1:n}\\) (å¦‚ä¸‹å›¾æµ…ç»¿è‰²æ‰€ç¤º) ä¸­çš„æ¯ä¸ªè¾“å…¥å‘é‡ä»Ž _ä¸Šä¸‹æ–‡æ— å…³_ çš„å‘é‡è¡¨å¾è½¬æ¢ä¸º _ä¸Šä¸‹æ–‡ç›¸å…³_ çš„å‘é‡è¡¨å¾ï¼ŒåŽé¢æ¯ä¸€ä¸ªç¼–ç å™¨æ¨¡å—éƒ½ä¼šè¿›ä¸€æ­¥ç»†åŒ–è¿™ä¸ªä¸Šä¸‹æ–‡è¡¨å¾ï¼Œç›´åˆ°æœ€åŽä¸€ä¸ªç¼–ç å™¨æ¨¡å—è¾“å‡ºæœ€ç»ˆçš„ä¸Šä¸‹æ–‡ç›¸å…³ç¼–ç  \\(\\mathbf{\\overline{X}}\_{1:n}\\) (å¦‚ä¸‹å›¾æ·±ç»¿è‰²æ‰€ç¤º)ã€‚

æˆ‘ä»¬å¯¹ `ç¼–ç å™¨å¦‚ä½•å°†è¾“å…¥åºåˆ— "I want to buy a car EOS" å˜æ¢ä¸ºä¸Šä¸‹æ–‡ç¼–ç åºåˆ—`è¿™ä¸€è¿‡ç¨‹è¿›è¡Œä¸€ä¸‹å¯è§†åŒ–ã€‚ä¸ŽåŸºäºŽ RNN çš„ç¼–ç å™¨ç±»ä¼¼ï¼ŒåŸºäºŽ transformer çš„ç¼–ç å™¨ä¹Ÿåœ¨è¾“å…¥åºåˆ—æœ€åŽæ·»åŠ äº†ä¸€ä¸ª EOSï¼Œä»¥æç¤ºæ¨¡åž‹è¾“å…¥å‘é‡åºåˆ—å·²ç»“æŸ \\({}^2\\)ã€‚

![](https://raw.githubusercontent.com/patrickvonplaten/scientific_images/master/encoder_decoder/Encoder_block.png)

ä¸Šå›¾ä¸­çš„ _åŸºäºŽ transformer_ çš„ç¼–ç å™¨ç”±ä¸‰ä¸ªç¼–ç å™¨æ¨¡å—ç»„æˆã€‚æˆ‘ä»¬åœ¨å³ä¾§çš„çº¢æ¡†ä¸­è¯¦ç»†åˆ—å‡ºäº†ç¬¬äºŒä¸ªç¼–ç å™¨æ¨¡å—çš„å‰ä¸‰ä¸ªè¾“å…¥å‘é‡: \\(\\mathbf{x}\_1\\)ï¼Œ\\(\\mathbf {x}\_2\\) åŠ \\(\\mathbf{x}\_3\\)ã€‚çº¢æ¡†ä¸‹éƒ¨çš„å…¨è¿žæŽ¥å›¾æè¿°äº†åŒå‘è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œä¸Šé¢æ˜¯ä¸¤ä¸ªå‰é¦ˆå±‚ã€‚å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨åŒå‘è‡ªæ³¨æ„åŠ›æœºåˆ¶ã€‚

å¯ä»¥çœ‹å‡ºï¼Œè‡ªæ³¨æ„åŠ›å±‚çš„æ¯ä¸ªè¾“å‡ºå‘é‡ \\(\\mathbf{x''}\_i, \\forall i \\in {1, \\ldots, 7}\\) éƒ½ _ç›´æŽ¥_ ä¾èµ–äºŽ _æ‰€æœ‰_ è¾“å…¥å‘é‡ \\(\\mathbf{x'}\_1, \\ldots, \\mathbf{x'}\_7\\)ã€‚è¿™æ„å‘³ç€ï¼Œå•è¯ â€œwantâ€ çš„è¾“å…¥å‘é‡è¡¨ç¤º \\(\\mathbf{x'}\_2\\) ä¸Žå•è¯ â€œbuyâ€ (å³ \\(\\mathbf{x'}\_4\\)) å’Œå•è¯ â€œIâ€ (å³ \\(\\mathbf{x'}\_1\\)) ç›´æŽ¥ç›¸å…³ã€‚ å› æ­¤ï¼Œâ€œwantâ€ çš„è¾“å‡ºå‘é‡è¡¨å¾ï¼Œ _å³_ \\(\\mathbf{x''}\_2\\)ï¼Œæ˜¯ä¸€ä¸ªèžåˆäº†å…¶ä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ›´ç²¾ç»†çš„è¡¨å¾ã€‚

æˆ‘ä»¬æ›´æ·±å…¥äº†è§£ä¸€ä¸‹åŒå‘è‡ªæ³¨æ„åŠ›çš„å·¥ä½œåŽŸç†ã€‚ç¼–ç å™¨æ¨¡å—çš„è¾“å…¥åºåˆ— \\(\\mathbf{X'}\_{1:n}\\) ä¸­çš„æ¯ä¸ªè¾“å…¥å‘é‡ \\(\\mathbf{x'}\_i\\) é€šè¿‡ä¸‰ä¸ªå¯è®­ç»ƒçš„æƒé‡çŸ©é˜µ \\(\\mathbf{W}\_q\\)ï¼Œ\\(\\mathbf{W}\_v\\)ï¼Œ\\(\\mathbf{W}\_k\\) åˆ†åˆ«æŠ•å½±è‡³ `key` å‘é‡ \\(\\mathbf{k}\_i\\)ã€`value` å‘é‡ \\(\\mathbf{v}\_i\\) å’Œ `query` å‘é‡ \\(\\mathbf{q}\_i\\) (ä¸‹å›¾åˆ†åˆ«ä»¥æ©™è‰²ã€è“è‰²å’Œç´«è‰²è¡¨ç¤º):

\\\[\\mathbf{q}\_i = \\mathbf{W}\_q \\mathbf{x'}\_i, \\\]

\\\[\\mathbf{v}\_i = \\mathbf{W}\_v \\mathbf{x'}\_i, \\\]

\\\[\\mathbf{k}\_i = \\mathbf{W}\_k \\mathbf{x'}\_i, \\\]

\\\[\\forall i \\in {1, \\ldots n } \\\]

è¯·æ³¨æ„ï¼Œå¯¹æ¯ä¸ªè¾“å…¥å‘é‡ \\(\\mathbf{x}\_i (\\forall i \\in {i, \\ldots, n}\\)) è€Œè¨€ï¼Œå…¶æ‰€ä½¿ç”¨çš„æƒé‡çŸ©é˜µéƒ½æ˜¯ **ç›¸åŒ** çš„ã€‚å°†æ¯ä¸ªè¾“å…¥å‘é‡ \\(\\mathbf{x}\_i\\) æŠ•å½±åˆ° `query` ã€ `key` å’Œ `value` å‘é‡åŽï¼Œå°†æ¯ä¸ª `query` å‘é‡ \\(\\mathbf{q}\_j (\\forall j \\in {1, \\ldots, n}\\)) ä¸Žæ‰€æœ‰ `key` å‘é‡ \\(\\mathbf{k}\_1, \\ldots, \\mathbf{k}\_n\\) è¿›è¡Œæ¯”è¾ƒã€‚å“ªä¸ª `key` å‘é‡ä¸Ž `query` å‘é‡ \\(\\mathbf{q}\_j\\) è¶Šç›¸ä¼¼ï¼Œå…¶å¯¹åº”çš„ `value` å‘é‡ \\(\\mathbf{v}\_j\\) å¯¹è¾“å‡ºå‘é‡ \\(\\mathbf{x''}\_j\\) çš„å½±å“å°±è¶Šé‡è¦ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œè¾“å‡ºå‘é‡ \\(\\mathbf{x''}\_j\\) è¢«å®šä¹‰ä¸ºæ‰€æœ‰ `value` å‘é‡çš„åŠ æƒå’Œ \\(\\mathbf{v}\_1, \\ldots, \\mathbf{v}\_n\\) åŠ ä¸Šè¾“å…¥å‘é‡ \\(\\mathbf{x'}\_j\\)ã€‚è€Œå„ `value` å‘é‡çš„æƒé‡ä¸Ž \\(\\mathbf{q}\_j\\) å’Œå„ä¸ª `key` å‘é‡ \\(\\mathbf{k}\_1, \\ldots, \\mathbf{k}\_n\\) ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦æˆæ­£æ¯”ï¼Œå…¶æ•°å­¦å…¬å¼ä¸º \\(\\textbf{Softmax}(\\mathbf{K}\_{1:n}^\\intercal \\mathbf{q}\_j)\\)ï¼Œå¦‚ä¸‹æ–‡çš„å…¬å¼æ‰€ç¤ºã€‚å…³äºŽè‡ªæ³¨æ„åŠ›å±‚çš„å®Œæ•´æè¿°ï¼Œå»ºè®®è¯»è€…é˜…è¯» [è¿™ç¯‡](http://jalammar.github.io/illustrated-transformer/) åšæ–‡æˆ– [åŽŸå§‹è®ºæ–‡](https://arxiv.org/abs/1706.03762)ã€‚

å¥½å§ï¼Œåˆå¤æ‚èµ·æ¥äº†ã€‚æˆ‘ä»¬ä»¥ä¸Šä¾‹ä¸­çš„ä¸€ä¸ª `query` å‘é‡ä¸ºä¾‹å›¾è§£ä¸€ä¸‹åŒå‘è‡ªæ³¨æ„å±‚ã€‚ä¸ºç®€å•èµ·è§ï¼Œæœ¬ä¾‹ä¸­å‡è®¾æˆ‘ä»¬çš„ _åŸºäºŽ transformer_ çš„è§£ç å™¨åªæœ‰ä¸€ä¸ªæ³¨æ„åŠ›å¤´ `config.num_heads = 1` å¹¶ä¸”æ²¡æœ‰å½’ä¸€åŒ–å±‚ã€‚

![](https://raw.githubusercontent.com/patrickvonplaten/scientific_images/master/encoder_decoder/encoder_detail.png)

å›¾å·¦æ˜¾ç¤ºäº†ä¸Šä¸ªä¾‹å­ä¸­çš„ç¬¬äºŒä¸ªç¼–ç å™¨æ¨¡å—ï¼Œå³è¾¹è¯¦ç»†å¯è§†åŒ–äº†ç¬¬äºŒä¸ªè¾“å…¥å‘é‡ \\(\\mathbf{x'}\_2\\) çš„åŒå‘è‡ªæ³¨æ„æœºåˆ¶ï¼Œå…¶å¯¹åº”è¾“å…¥è¯ä¸º â€œwantâ€ã€‚é¦–å…ˆå°†æ‰€æœ‰è¾“å…¥å‘é‡ \\(\\mathbf{x'}\_1, \\ldots, \\mathbf{x'}\_7\\) æŠ•å½±åˆ°å®ƒä»¬å„è‡ªçš„ `query` å‘é‡ \\(\\mathbf{q}\_1, \\ldots, \\mathbf{q}\_7\\) (ä¸Šå›¾ä¸­ä»…ä»¥ç´«è‰²æ˜¾ç¤ºå‰ä¸‰ä¸ª `query` å‘é‡)ï¼Œ `value` å‘é‡ \\(\\mathbf{v}\_1, \\ldots, \\mathbf{v}\_7\\) (è“è‰²) å’Œ `key` å‘é‡ \\(\\mathbf{k}\_1, \\ldots, \\mathbf{k}\_7\\) (æ©™è‰²)ã€‚ç„¶åŽï¼Œå°† `query` å‘é‡ \\(\\mathbf{q}\_2\\) ä¸Žæ‰€æœ‰ `key` å‘é‡çš„è½¬ç½® ( _å³_ \\(\\mathbf{K}\_{1:7}^{\\intercal}\\)) ç›¸ä¹˜ï¼ŒéšåŽè¿›è¡Œ softmax æ“ä½œä»¥äº§ç”Ÿ _è‡ªæ³¨æ„åŠ›æƒé‡_ ã€‚ è‡ªæ³¨æ„åŠ›æƒé‡æœ€ç»ˆä¸Žå„è‡ªçš„ `value` å‘é‡ç›¸ä¹˜ï¼Œå¹¶åŠ ä¸Šè¾“å…¥å‘é‡ \\(\\mathbf{x'}\_2\\)ï¼Œæœ€ç»ˆè¾“å‡ºå•è¯ â€œwantâ€ çš„ä¸Šä¸‹æ–‡ç›¸å…³è¡¨å¾ï¼Œ _å³_ \\(\\mathbf{x''}\_2\\) (å›¾å³æ·±ç»¿è‰²è¡¨ç¤º)ã€‚æ•´ä¸ªç­‰å¼æ˜¾ç¤ºåœ¨å›¾å³æ¡†çš„ä¸Šéƒ¨ã€‚ \\(\\mathbf{K}\_{1:7}^{\\intercal}\\) å’Œ \\(\\mathbf{q}\_2\\) çš„ç›¸ä¹˜ä½¿å¾—å°† â€œwantâ€ çš„å‘é‡è¡¨å¾ä¸Žæ‰€æœ‰å…¶ä»–è¾“å…¥ (â€œIâ€ï¼Œâ€œtoâ€ï¼Œâ€œbuyâ€ï¼Œâ€œaâ€ï¼Œâ€œcarâ€ï¼Œâ€œEOSâ€) çš„å‘é‡è¡¨å¾ç›¸æ¯”è¾ƒæˆä¸ºå¯èƒ½ï¼Œå› æ­¤è‡ªæ³¨æ„åŠ›æƒé‡åæ˜ å‡ºæ¯ä¸ªè¾“å…¥å‘é‡ \\(\\mathbf{x'}\_j\\) å¯¹ â€œwantâ€ ä¸€è¯çš„æœ€ç»ˆè¡¨å¾ \\(\\mathbf{x''}\_2\\) çš„é‡è¦ç¨‹åº¦ã€‚

ä¸ºäº†è¿›ä¸€æ­¥ç†è§£åŒå‘è‡ªæ³¨æ„åŠ›å±‚çš„å«ä¹‰ï¼Œæˆ‘ä»¬å‡è®¾ä»¥ä¸‹å¥å­: â€œ _æˆ¿å­å¾ˆæ¼‚äº®ä¸”ä½äºŽå¸‚ä¸­å¿ƒï¼Œå› æ­¤é‚£å„¿å…¬å…±äº¤é€šå¾ˆæ–¹ä¾¿_ â€ã€‚ â€œé‚£å„¿â€è¿™ä¸ªè¯æŒ‡çš„æ˜¯â€œæˆ¿å­â€ï¼Œè¿™ä¸¤ä¸ªè¯ç›¸éš” 12 ä¸ªå­—ã€‚åœ¨åŸºäºŽ transformer çš„ç¼–ç å™¨ä¸­ï¼ŒåŒå‘è‡ªæ³¨æ„åŠ›å±‚è¿ç®—ä¸€æ¬¡ï¼Œå³å¯å°†â€œæˆ¿å­â€çš„è¾“å…¥å‘é‡ä¸Žâ€œé‚£å„¿â€çš„è¾“å…¥å‘é‡ç›¸å…³è”ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨åŸºäºŽ RNN çš„ç¼–ç å™¨ä¸­ï¼Œç›¸è· 12 ä¸ªå­—çš„è¯å°†éœ€è¦è‡³å°‘ 12 ä¸ªæ—¶é—´æ­¥çš„è¿ç®—ï¼Œè¿™æ„å‘³ç€åœ¨åŸºäºŽ RNN çš„ç¼–ç å™¨ä¸­æ‰€éœ€æ•°å­¦è¿ç®—ä¸Žè·ç¦»å‘ˆçº¿æ€§å…³ç³»ã€‚è¿™ä½¿å¾—åŸºäºŽ RNN çš„ç¼–ç å™¨æ›´éš¾å¯¹é•¿ç¨‹ä¸Šä¸‹æ–‡è¡¨å¾è¿›è¡Œå»ºæ¨¡ã€‚æ­¤å¤–ï¼Œå¾ˆæ˜Žæ˜¾ï¼ŒåŸºäºŽ transformer çš„ç¼–ç å™¨æ¯”åŸºäºŽ RNN çš„ç¼–ç å™¨-è§£ç å™¨æ¨¡åž‹æ›´ä¸å®¹æ˜“ä¸¢å¤±é‡è¦ä¿¡æ¯ï¼Œå› ä¸ºç¼–ç çš„åºåˆ—é•¿åº¦ç›¸å¯¹è¾“å…¥åºåˆ—é•¿åº¦ä¿æŒä¸å˜ï¼Œ _å³_ \\(\\textbf{len }(\\mathbf{X}\_{1:n}) = \\textbf{len}(\\mathbf{\\overline{X}}\_{1:n}) = n\\)ï¼Œè€Œ RNN åˆ™ä¼šå°† \\(\\textbf{len}((\\mathbf{X}\_{1:n}) = n\\) åŽ‹ç¼©åˆ° \\(\\textbf{len}(\\mathbf{c}) = 1\\)ï¼Œè¿™ä½¿å¾— RNN å¾ˆéš¾æœ‰æ•ˆåœ°å¯¹è¾“å…¥è¯ä¹‹é—´çš„é•¿ç¨‹ä¾èµ–å…³ç³»è¿›è¡Œç¼–ç ã€‚

é™¤äº†æ›´å®¹æ˜“å­¦åˆ°é•¿ç¨‹ä¾èµ–å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ° transformer æž¶æž„èƒ½å¤Ÿå¹¶è¡Œå¤„ç†æ–‡æœ¬ã€‚ä»Žæ•°å­¦ä¸Šè®²ï¼Œè¿™æ˜¯é€šè¿‡å°†è‡ªæ³¨æ„åŠ›æœºåˆ¶è¡¨ç¤ºä¸º `query` ã€ `key` å’Œ `value` çš„çŸ©é˜µä¹˜æ¥å®Œæˆçš„:

\\\[\\mathbf{X''}\_{1:n} = \\mathbf{V}\_{1:n} \\text{Softmax}(\\mathbf{Q}\_{1:n}^\\intercal \\mathbf{K}\_{1:n}) + \\mathbf{X'}\_{1:n} \\\]

è¾“å‡º \\(\\mathbf{X''}\_{1:n} = \\mathbf{x''}\_1, \\ldots, \\mathbf{x''}\_n\\) æ˜¯ç”±ä¸€ç³»åˆ—çŸ©é˜µä¹˜è®¡ç®—å’Œ softmax æ“ä½œç®—å¾—ï¼Œå› æ­¤å¯ä»¥æœ‰æ•ˆåœ°å¹¶è¡ŒåŒ–ã€‚è¯·æ³¨æ„ï¼Œåœ¨åŸºäºŽ RNN çš„ç¼–ç å™¨æ¨¡åž‹ä¸­ï¼Œéšå«çŠ¶æ€ \\(\\mathbf{c}\\) çš„è®¡ç®—å¿…é¡»æŒ‰é¡ºåºè¿›è¡Œ: å…ˆè®¡ç®—ç¬¬ä¸€ä¸ªè¾“å…¥å‘é‡çš„éšå«çŠ¶æ€ \\(\\mathbf{x}\_1\\); ç„¶åŽè®¡ç®—ç¬¬äºŒä¸ªè¾“å…¥å‘é‡çš„éšå«çŠ¶æ€ï¼Œå…¶å–å†³äºŽç¬¬ä¸€ä¸ªéšå«å‘é‡çš„çŠ¶æ€ï¼Œä¾æ­¤ç±»æŽ¨ã€‚RNN çš„é¡ºåºæ€§é˜»ç¢äº†æœ‰æ•ˆçš„å¹¶è¡ŒåŒ–ï¼Œå¹¶ä½¿å…¶åœ¨çŽ°ä»£ GPU ç¡¬ä»¶ä¸Šæ¯”åŸºäºŽ transformer çš„ç¼–ç å™¨æ¨¡åž‹çš„æ•ˆçŽ‡ä½Žå¾—å¤šã€‚

å¤ªå¥½äº†ï¼ŒçŽ°åœ¨æˆ‘ä»¬åº”è¯¥å¯¹:  
a) åŸºäºŽ transformer çš„ç¼–ç å™¨æ¨¡åž‹å¦‚ä½•æœ‰æ•ˆåœ°å»ºæ¨¡é•¿ç¨‹ä¸Šä¸‹æ–‡è¡¨å¾ï¼Œä»¥åŠ  
b) å®ƒä»¬å¦‚ä½•æœ‰æ•ˆåœ°å¤„ç†é•¿åºåˆ—å‘é‡è¾“å…¥è¿™ä¸¤ä¸ªæ–¹é¢æœ‰äº†æ¯”è¾ƒå¥½çš„ç†è§£äº†ã€‚

çŽ°åœ¨ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ª `MarianMT` ç¼–ç å™¨-è§£ç å™¨æ¨¡åž‹çš„ç¼–ç å™¨éƒ¨åˆ†çš„å°ä¾‹å­ï¼Œä»¥éªŒè¯è¿™äº›ç†è®ºåœ¨å®žè·µä¸­è¡Œä¸è¡Œå¾—é€šã€‚

* * *

\\({}^1\\) å…³äºŽå‰é¦ˆå±‚åœ¨åŸºäºŽ transformer çš„æ¨¡åž‹ä¸­æ‰€æ‰®æ¼”çš„è§’è‰²çš„è¯¦ç»†è§£é‡Šè¶…å‡ºäº†æœ¬æ–‡çš„èŒƒç•´ã€‚[Yun ç­‰äºº (2017)](https://arxiv.org/pdf/1912.10077.pdf) çš„å·¥ä½œè®¤ä¸ºå‰é¦ˆå±‚å¯¹äºŽå°†æ¯ä¸ªä¸Šä¸‹æ–‡å‘é‡ \\(\\mathbf{x'}\_i\\) æ˜ å°„åˆ°ç›®æ ‡è¾“å‡ºç©ºé—´è‡³å…³é‡è¦ï¼Œè€Œå•é  _è‡ªæ³¨æ„åŠ›_ å±‚æ— æ³•è¾¾æˆè¿™ä¸€ç›®çš„ã€‚è¿™é‡Œè¯·æ³¨æ„ï¼Œæ¯ä¸ªè¾“å‡ºè¯å…ƒ \\(\\mathbf{x'}\\) éƒ½ç»ç”±ç›¸åŒçš„å‰é¦ˆå±‚å¤„ç†ã€‚æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå»ºè®®è¯»è€…é˜…è¯»è®ºæ–‡ã€‚

\\({}^2\\) æˆ‘ä»¬æ— é¡»å°† EOS é™„åŠ åˆ°è¾“å…¥åºåˆ—ï¼Œè™½ç„¶æœ‰å·¥ä½œè¡¨æ˜Žï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹åŠ å…¥å®ƒå¯ä»¥æé«˜æ€§èƒ½ã€‚ç›¸ååœ°ï¼ŒåŸºäºŽ transformer çš„è§£ç å™¨å¿…é¡»æŠŠ \\(\\text{BOS}\\) ä½œä¸ºç¬¬ 0 ä¸ªç›®æ ‡å‘é‡ï¼Œå¹¶ä»¥ä¹‹ä¸ºæ¡ä»¶é¢„æµ‹ç¬¬ 1 ä¸ªç›®æ ‡å‘é‡ã€‚

    from transformers import MarianMTModel, MarianTokenizer
    import torch
    
    tokenizer = MarianTokenizer.from_pretrained("Helsinki-NLP/opus-mt-en-de")
    model = MarianMTModel.from_pretrained("Helsinki-NLP/opus-mt-en-de")
    
    embeddings = model.get_input_embeddings()
    
    # create ids of encoded input vectors
    input_ids = tokenizer("I want to buy a car", return_tensors="pt").input_ids
    
    # pass input_ids to encoder
    encoder_hidden_states = model.base_model.encoder(input_ids, return_dict=True).last_hidden_state
    
    # change the input slightly and pass to encoder
    input_ids_perturbed = tokenizer("I want to buy a house", return_tensors="pt").input_ids
    encoder_hidden_states_perturbed = model.base_model.encoder(input_ids_perturbed, return_dict=True).last_hidden_state
    
    # compare shape and encoding of first vector
    print(f"Length of input embeddings {embeddings(input_ids).shape[1]}. Length of encoder_hidden_states {encoder_hidden_states.shape[1]}")
    
    # compare values of word embedding of "I" for input_ids and perturbed input_ids
    print("Is encoding for `I` equal to its perturbed version?: ", torch.allclose(encoder_hidden_states[0, 0], encoder_hidden_states_perturbed[0, 0], atol=1e-3))
    

_è¾“å‡º:_

        Length of input embeddings 7. Length of encoder_hidden_states 7
        Is encoding for `I` equal to its perturbed version?: False
    

æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹è¾“å…¥è¯åµŒå…¥çš„åºåˆ—é•¿åº¦ ( _å³_ `embeddings(input_ids)`ï¼Œå¯¹åº”äºŽ \\(\\mathbf{X}\_{1:n}\\)) å’Œ `encoder_hidden_â€‹â€‹states` çš„é•¿åº¦ (å¯¹åº”äºŽ\\(\\mathbf{\\overline{X}}\_{1:n}\\))ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è®©ç¼–ç å™¨å¯¹å•è¯åºåˆ— â€œI want to buy a carâ€ åŠå…¶è½»å¾®æ”¹åŠ¨ç‰ˆ â€œI want to buy a houseâ€ åˆ†åˆ«æ‰§è¡Œå‰å‘æ“ä½œï¼Œä»¥æ£€æŸ¥ç¬¬ä¸€ä¸ªè¯ â€œIâ€ çš„è¾“å‡ºç¼–ç åœ¨æ›´æ”¹è¾“å…¥åºåˆ—çš„æœ€åŽä¸€ä¸ªå•è¯åŽæ˜¯å¦ä¼šæœ‰æ‰€ä¸åŒã€‚

ä¸å‡ºæ„å¤–ï¼Œè¾“å…¥è¯åµŒå…¥å’Œç¼–ç å™¨è¾“å‡ºç¼–ç çš„é•¿åº¦ï¼Œ _å³_ \\(\\textbf{len}(\\mathbf{X}\_{1:n})\\) å’Œ \\(\\textbf{len }(\\mathbf{\\overline{X}}\_{1:n})\\)ï¼Œæ˜¯ç›¸ç­‰çš„ã€‚åŒæ—¶ï¼Œå¯ä»¥æ³¨æ„åˆ°å½“æœ€åŽä¸€ä¸ªå•è¯ä»Ž â€œcarâ€ æ”¹æˆ â€œhouseâ€ åŽï¼Œ\\(\\mathbf{\\overline{x}}\_1 = \\text{â€œIâ€}\\) çš„ç¼–ç è¾“å‡ºå‘é‡çš„å€¼ä¹Ÿæ”¹å˜äº†ã€‚å› ä¸ºæˆ‘ä»¬çŽ°åœ¨å·²ç»ç†è§£äº†åŒå‘è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œè¿™å°±ä¸è¶³ä¸ºå¥‡äº†ã€‚

é¡ºå¸¦ä¸€æï¼Œ _è‡ªç¼–ç _ æ¨¡åž‹ (å¦‚ BERT) çš„æž¶æž„ä¸Ž _åŸºäºŽ transformer_ çš„ç¼–ç å™¨æ¨¡åž‹æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ _è‡ªç¼–ç _ æ¨¡åž‹åˆ©ç”¨è¿™ç§æž¶æž„å¯¹å¼€æ”¾åŸŸæ–‡æœ¬æ•°æ®è¿›è¡Œå¤§è§„æ¨¡è‡ªç›‘ç£é¢„è®­ç»ƒï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥å°†ä»»ä½•å•è¯åºåˆ—æ˜ å°„åˆ°æ·±åº¦åŒå‘è¡¨å¾ã€‚åœ¨ [Devlin ç­‰ (2018)](https://arxiv.org/abs/1810.04805) çš„å·¥ä½œä¸­ï¼Œä½œè€…å±•ç¤ºäº†ä¸€ä¸ªé¢„è®­ç»ƒ BERT æ¨¡åž‹ï¼Œå…¶é¡¶éƒ¨æœ‰ä¸€ä¸ªä»»åŠ¡ç›¸å…³çš„åˆ†ç±»å±‚ï¼Œå¯ä»¥åœ¨ 11 ä¸ª NLP ä»»åŠ¡ä¸ŠèŽ·å¾— SOTA ç»“æžœã€‚ä½ å¯ä»¥ä»Ž [æ­¤å¤„](https://huggingface.co/transformers/model_summary.html#autoencoding-models) æ‰¾åˆ° ðŸ¤— transformers æ”¯æŒçš„æ‰€æœ‰ _è‡ªç¼–ç _ æ¨¡åž‹ã€‚

æ•¬è¯·å…³æ³¨å…¶ä½™éƒ¨åˆ†çš„æ–‡ç« ã€‚

* * *

> è‹±æ–‡åŽŸæ–‡: [https://hf.co/blog/encoder-decoder](https://hf.co/blog/encoder-decoder)
> 
> åŽŸæ–‡ä½œè€…: Patrick von Platen
> 
> è¯‘è€…: Matrix Yao (å§šä¼Ÿå³°)ï¼Œè‹±ç‰¹å°”æ·±åº¦å­¦ä¹ å·¥ç¨‹å¸ˆï¼Œå·¥ä½œæ–¹å‘ä¸º transformer-family æ¨¡åž‹åœ¨å„æ¨¡æ€æ•°æ®ä¸Šçš„åº”ç”¨åŠå¤§è§„æ¨¡æ¨¡åž‹çš„è®­ç»ƒæŽ¨ç†ã€‚
> 
> å®¡æ ¡/æŽ’ç‰ˆ: zhongdongy (é˜¿ä¸œ)