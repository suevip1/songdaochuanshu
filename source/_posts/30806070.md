---
layout: post
title: "åœ°è¡¨æœ€å¸…ç¼“å­˜Caffeine"
date: "2023-09-05T00:55:53.645Z"
---
åœ°è¡¨æœ€å¸…ç¼“å­˜Caffeine

ä¸€èµ·è®¤è¯†ä¸€ä¸‹æ€§èƒ½é¡¶å°–çš„æœ¬åœ°ç¼“å­˜Caffeine

ç®€ä»‹
==

ç¼“å­˜æ˜¯ç¨‹åºå‘˜ä»¬ç»•ä¸å¼€çš„è¯é¢˜ï¼Œåƒæ˜¯å¸¸ç”¨çš„æœ¬åœ°ç¼“å­˜Guava,åˆ†å¸ƒå¼ç¼“å­˜Redisç­‰ï¼Œæ˜¯æä¾›é«˜æ€§èƒ½æœåŠ¡çš„åŸºç¡€ã€‚ä»Šå¤©æ•¬å§å¸¦å¤§å®¶ä¸€èµ·è®¤è¯†ä¸€ä¸ªæ›´é«˜æ•ˆçš„æœ¬åœ°ç¼“å­˜â€”â€”**Caffeine**ã€‚

![img](https://img2023.cnblogs.com/blog/37001/202309/37001-20230905001127127-1610033798.png)

Caffeine Cacheä½¿ç”¨äº†åŸºäºå†…å­˜çš„å­˜å‚¨ç­–ç•¥ï¼Œå¹¶ä¸”æ”¯æŒé«˜å¹¶å‘ã€ä½å»¶è¿Ÿï¼ŒåŒæ—¶è¿˜æä¾›äº†ç¼“å­˜è¿‡æœŸã€å®šæ—¶åˆ·æ–°ã€ç¼“å­˜å¤§å°æ§åˆ¶ç­‰åŠŸèƒ½ã€‚Caffeineæ˜¯ä¸€ä¸ªJavaé«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“ã€‚æ®å…¶å®˜æ–¹è¯´æ˜ï¼Œå› ä½¿ç”¨ Window TinyLfu å›æ”¶ç­–ç•¥ï¼Œå…¶ç¼“å­˜å‘½ä¸­ç‡å·²ç»æ¥è¿‘æœ€ä¼˜å€¼ã€‚æ­¤å¤„åº”æœ‰æŒå£°ğŸ‘ğŸ»

å®ƒæ˜¯Guava Cacheçš„å‡çº§ç‰ˆæœ¬, ä½†æ˜¯æ¯”Guava Cacheæ›´å¿«ï¼Œæ›´ç¨³å®šã€‚Caffeine Cacheæœ€é€‚åˆåšæ•°æ®é‡ä¸å¤§ï¼Œä½†æ˜¯è¯»å†™é¢‘ç¹çš„åº”ç”¨åœºæ™¯ã€‚ç»“åˆRedisç­‰å¯ä»¥å®ç°åº”ç”¨ä¸­çš„å¤šçº§ç¼“å­˜ç­–ç•¥ã€‚  
!

è¿˜æ˜¯è€å¥—è·¯ï¼Œå…ˆå†™ä»£ç ç¤ºä¾‹ï¼Œå¯¹Caffeineçš„å¸…æœ‰ä¸ªè‚¤æµ…çš„è®¤è¯†ï¼Œåé¢å†å»ç ”ç©¶ä»–çš„å†…åœ¨æœºåˆ¶

Caffeineç¼“å­˜ç±»å‹
============

æ–°å»ºé¡¹ç›®ï¼Œæ·»åŠ caffeineçš„mavenå¼•ç”¨

    <!-- https://mvnrepository.com/artifact/com.github.ben-manes.caffeine/caffeine -->
    <dependency>
        <groupId>com.github.ben-manes.caffeine</groupId>
        <artifactId>caffeine</artifactId>
        <version>3.1.7</version>
    </dependency>
    
    

Caffeineå››ç§ç¼“å­˜ç±»å‹ï¼šCache, LoadingCache, AsyncCache, AsyncLoadingCache

1\. Cache
---------

åœ¨è·å–ç¼“å­˜å€¼æ—¶ï¼Œå¦‚æœæƒ³è¦åœ¨ç¼“å­˜å€¼ä¸å­˜åœ¨æ—¶ï¼ŒåŸå­åœ°å°†å€¼å†™å…¥ç¼“å­˜ï¼Œåˆ™å¯ä»¥è°ƒç”¨get(key, k -> value)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†é¿å…å†™å…¥ç«äº‰ã€‚  
åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œå½“ä½¿ç”¨get(key, k -> value)æ—¶ï¼Œå¦‚æœæœ‰å¦ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨æœ¬æ–¹æ³•è¿›è¡Œç«äº‰ï¼Œåˆ™åä¸€çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å‰ä¸€çº¿ç¨‹æ›´æ–°ç¼“å­˜å®Œæˆï¼›è€Œè‹¥å¦ä¸€çº¿ç¨‹è°ƒç”¨getIfPresent()æ–¹æ³•ï¼Œåˆ™ä¼šç«‹å³è¿”å›nullï¼Œä¸ä¼šè¢«é˜»å¡ã€‚

    public class CacheDemo {
        static Cache<Integer, Article> cache = Caffeine.newBuilder()
                .maximumSize(1000)
                .expireAfterWrite(10, TimeUnit.MINUTES)
                .build();
    
        public static void main(String[] args) {
            //get
            System.out.println(cache.get(1, x -> new Article(x)));//Article{id=1, title='title 1'}
    
            //getIfPresent
            System.out.println(cache.getIfPresent(2));//null
    
            //put è®¾ç½®ç¼“å­˜
            cache.put(2, new Article(2));
            System.out.println(cache.getIfPresent(2));//Article{id=2, title='title 2'}
    
            //invalidate ç§»é™¤ç¼“å­˜
            cache.invalidate(2);
            System.out.println(cache.getIfPresent(2));//null
        }
    }
    

2.LoadingCache
--------------

LoadingCacheæ˜¯ä¸€ç§è‡ªåŠ¨åŠ è½½çš„ç¼“å­˜ã€‚ä½¿ç”¨æ—¶éœ€è¦æŒ‡å®šCacheLoaderï¼Œå¹¶å®ç°å…¶ä¸­çš„load()æ–¹æ³•ä¾›ç¼“å­˜ç¼ºå¤±æ—¶è‡ªåŠ¨åŠ è½½ã€‚  
get()æ–¹æ³•ç”¨æ¥è¯»å–ç¼“å­˜ï¼Œå’Œä¸Šé¢çš„Cacheæ–¹å¼ä¸åŒä¹‹å¤„åœ¨äºï¼Œå½“ç¼“å­˜ä¸å­˜åœ¨æˆ–è€…å·²ç»è¿‡æœŸæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨CacheLoader.load()æ–¹æ³•åŠ è½½æœ€æ–°å€¼ã€‚åŠ è½½è¿‡ç¨‹æ˜¯ä¸€ç§åŒæ­¥æ“ä½œï¼Œå°†è¿”å›å€¼æ’å…¥ç¼“å­˜å¹¶ä¸”è¿”å›ã€‚

    /**
     * LoadingCacheç¤ºä¾‹ï¼Œè‡ªåŠ¨åŠ è½½çš„ç¼“å­˜
     *
     * @author chenjing
     */
    public class LoadingCacheDemo {
        private static LoadingCache<Integer, Article> cache = Caffeine.newBuilder()
                .build(new CacheLoader<>() {
                    @Override
                    public @Nullable Article load(Integer id) {
                        return new Article(id);
                    }
                });
    
        public static void main(String[] args) {
            System.out.println(cache.get(1));//Article{id=1, title='title 1'}
    
            //getIfPresent
            System.out.println(cache.getIfPresent(2));//null
    
    
            System.out.println(cache.getAll(List.of(10,20)));//{10=Article{id=10, title='title 10'}, 20=Article{id=20, title='title 20'}}
        }
    }
    

3.AsyncCache
------------

å’ŒCacheç±»ä¼¼ï¼Œä½†æ˜¯å¼‚æ­¥æ‰§è¡Œæ“ä½œï¼Œå¹¶è¿”å›ä¿å­˜å®é™…å€¼çš„CompletableFutureï¼Œé€‚ç”¨äºéœ€è¦è¿›è¡Œå¹¶å‘æ‰§è¡Œæé«˜ååé‡çš„åœºæ™¯ã€‚

    /**
     * Caffeine å¼‚æ­¥ç¼“å­˜
     *
     * @author chenjing
     */
    public class AsyncCacheDemo {
        static AsyncCache<Integer, Article> cache = Caffeine.newBuilder()
                .maximumSize(1000)
                .expireAfterWrite(10, TimeUnit.MINUTES)
                .buildAsync();
    
        public static void main(String[] args) throws ExecutionException, InterruptedException {
            //get è¿”å›çš„æ˜¯CompletableFuture
            CompletableFuture<Article> future = cache.get(1, x -> new Article(x));
            System.out.println(future.get());//Article{id=1, title='title 1'}
        }
    }
    
    

4.AsyncLoadingCache
-------------------

å¼‚æ­¥åŠ è½½ç¼“å­˜

    /**
     * Caffeine AsyncLoadingCache å¼‚æ­¥è‡ªåŠ¨åŠ è½½ç¼“å­˜
     * @author chenjing 
     */
    public class AsyncLoadingCacheDemo {
        private static AsyncLoadingCache<Integer, Article> asyncLoadingCache =
                Caffeine.newBuilder()
                        .maximumSize(1000)
                        .expireAfterWrite(10, TimeUnit.MINUTES)
                        .buildAsync(
                                (key, executor) -> CompletableFuture.supplyAsync(() -> new Article(key), executor)
                        );
    
        public static void main(String[] args) {
    
            CompletableFuture<Article> userCompletableFuture = asyncLoadingCache.get(66);
            System.out.println(userCompletableFuture.join());//Article{id=66, title='title 66'}
        }
    } 
    
    

ç¼“å­˜è¿‡æœŸ
====

1.  åŸºäºç¼“å­˜å¤§å°  
    é€šè¿‡ maximumSize() æŒ‡å®šç¼“å­˜å¤§å°ã€‚

    /**
     * æµ‹è¯•CaffeineåŸºäºç©ºé—´çš„é©±é€ç­–ç•¥
     *
     * @author chenjing
     */
    public class MaxSizeExpire {
        public static void main(String[] args) {
            System.out.println("æµ‹è¯•åŸºäºå®¹é‡è¿‡æœŸçš„ç¼“å­˜");
            Integer size = 10;
            Cache<Integer, Article> cache = Caffeine.newBuilder()
                    .maximumSize(size)
                    .recordStats()
                    .build();
            cache.put(1, new Article(1));
            System.out.println("æ”¾å…¥ä¸€æ¡æ•°æ®ï¼Œè·å–çœ‹çœ‹");
            System.out.println(cache.getIfPresent(1));//Article{id=1, title='title 1'}
    
            System.out.println("æ”¾å…¥" + size + "æ¡æ•°æ®");
            for (int i = 2; i <= size + 5; i++) {
                cache.put(i, new Article(i));
            }
    
            System.out.println("å†æ‰“å°ç¬¬ä¸€æ¡æ•°æ®çœ‹çœ‹");
            System.out.println(cache.getIfPresent(1));//Article{id=1, title='title 1'}
    
            //æ‰“å°ä¸€ä¸‹ç¼“å­˜çŠ¶æ€
            System.out.println(cache.stats());//CacheStats{hitCount=2, missCount=0, loadSuccessCount=0, loadFailureCount=0, totalLoadTime=0, evictionCount=5, evictionWeight=5}
        }
    }
    
    

2.  åŸºäºç¼“å­˜å†™å…¥æ—¶é—´  
    ä¸€èˆ¬æœ€è¿‘ä¸€æ®µæ—¶é—´ç¼“å­˜çš„æ•°æ®æ‰æ˜¯æœ‰æ•ˆçš„ï¼Œç¼“å­˜å¾ˆä¹…ä¹‹å‰çš„ä¸šåŠ¡æ•°æ®æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚å¸¸è§çš„ä¸€ç§åœºæ™¯å°±æ˜¯ï¼Œç¼“å­˜å†™å…¥ä¹‹åNåˆ†é’Ÿä¹‹åè‡ªåŠ¨å¤±æ•ˆã€‚

    /**
     * Caffeine expireAfterWrite
     * @author chenjing
     */
    public class ExpireAfterWriteDemo {
        public static void main(String[] args) throws InterruptedException {
            System.out.println("æµ‹è¯•åŸºäºæ—¶é—´è¿‡æœŸçš„ç¼“å­˜");
            Integer seconds = 5;
            Integer size = 5;
            Cache<Integer, Article> cache = Caffeine.newBuilder()
                    //åŸºäºæ—¶é—´è¿‡æœŸ
                    .expireAfterWrite(seconds, TimeUnit.SECONDS)
                    //ç›‘æ§ç¼“å­˜ç§»é™¤
                    .removalListener((Integer key, Article value, RemovalCause cause) ->
                            System.out.printf("ç§»é™¤key %sï¼ŒåŸå› æ˜¯ %s %n", key, cause))
                    .build();
    
            System.out.println("æ”¾å…¥" + size + "æ¡æ•°æ®");
            for (int i = 1; i <= size; i++) {
                cache.put(i, new Article(i));
                System.out.println(cache.getIfPresent(i));
            }
    
            System.out.println("sleep 10 seconds");
            Thread.sleep(10000);
    
            for (int i = 1; i <= size; i++) {
                cache.put(i, new Article(i));
                System.out.println(cache.getIfPresent(i));
            }
        }
    }
    
    

æ‰§è¡Œç»“æœï¼š

    æµ‹è¯•åŸºäºæ—¶é—´è¿‡æœŸçš„ç¼“å­˜
    æ”¾å…¥5æ¡æ•°æ®
    Article{id=1, title='title 1'}
    Article{id=2, title='title 2'}
    Article{id=3, title='title 3'}
    Article{id=4, title='title 4'}
    Article{id=5, title='title 5'}
    sleep 10 seconds
    ç§»é™¤key 1ï¼ŒåŸå› æ˜¯ EXPIRED
    Article{id=1, title='title 1'}
    Article{id=2, title='title 2'}
    ç§»é™¤key 2ï¼ŒåŸå› æ˜¯ EXPIRED
    ç§»é™¤key 3ï¼ŒåŸå› æ˜¯ EXPIRED
    Article{id=3, title='title 3'}
    ç§»é™¤key 4ï¼ŒåŸå› æ˜¯ EXPIRED
    ç§»é™¤key 5ï¼ŒåŸå› æ˜¯ EXPIRED
    Article{id=4, title='title 4'}
    Article{id=5, title='title 5'}
    

ç¼“å­˜åˆ·æ–°
====

refreshAfterWrite()å’ŒexpireAfterWrite()ä¸åŒï¼Œåœ¨åˆ·æ–°çš„æ—¶å€™å¦‚æœæŸ¥è¯¢ç¼“å­˜å…ƒç´ ï¼Œå…¶æ—§å€¼å°†ä»è¢«è¿”å›ï¼Œç›´åˆ°è¯¥å…ƒç´ çš„åˆ·æ–°å®Œæ¯•åç»“æŸåæ‰ä¼šè¿”å›åˆ·æ–°åçš„æ–°å€¼ã€‚è¿™é‡Œçš„åˆ·æ–°æ“ä½œé»˜è®¤ä¹Ÿæ˜¯ç”±çº¿ç¨‹æ± ForkJoinPool.commonPool()å¼‚æ­¥æ‰§è¡Œçš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡Caffeine.executor()é‡å†™æ¥æŒ‡å®šè‡ªå®šä¹‰çš„çº¿ç¨‹æ± ã€‚

    public class RefreshAfterWriteDemo {
        public static void main(String[] args) throws InterruptedException {
            LoadingCache<Integer, Article> cache = Caffeine.newBuilder()
                    .refreshAfterWrite(2, TimeUnit.SECONDS)
                    .build(new CacheLoader<Integer, Article>() {
                        @Override
                        public @Nullable Article load(Integer integer) {
                            return new Article(integer);
                        }
    
                        @Override
                        public @Nullable Article reload(Integer key, Article oldValue) {
                            return new Article(key + 100);
                        }
                    });
    
            cache.put(1, new Article(1));
            for (int i = 0; i < 3; i++) {
                System.out.println(cache.get(1));
                Thread.sleep(3000);
            }
        }
    }
    

ç¼“å­˜ç›‘æ§
====

åˆ›å»ºCaffeineæ—¶è®¾ç½®removalListenerï¼Œå¯ä»¥ç›‘å¬ç¼“å­˜åœ°æ¸…é™¤æˆ–æ›´æ–°ç›‘å¬ã€‚

     Cache<Integer, Article> cache = Caffeine.newBuilder()
                    //åŸºäºæ—¶é—´è¿‡æœŸ
                    .expireAfterWrite(seconds, TimeUnit.SECONDS)
                    //ç›‘æ§ç¼“å­˜ç§»é™¤
                    .removalListener((Integer key, Article value, RemovalCause cause) ->
                            System.out.printf("ç§»é™¤key %sï¼ŒåŸå› æ˜¯ %s %n", key, cause))
                    .build();
    

å½“ç¼“å­˜ä¸­çš„æ•°æ®å‘é€æ›´æ–°ï¼Œæˆ–è€…è¢«æ¸…é™¤æ—¶ï¼Œå°±ä¼šè§¦å‘ç›‘å¬å™¨ï¼Œåœ¨ç›‘å¬å™¨é‡Œå¯ä»¥è‡ªå®šä¹‰ä¸€äº›å¤„ç†æ‰‹æ®µï¼Œæ¯”å¦‚æ‰“å°å‡ºå“ªä¸ªæ•°æ®è¢«æ¸…é™¤ï¼ŒåŸå› æ˜¯ä»€ä¹ˆã€‚è¿™ä¸ªè§¦å‘å’Œç›‘å¬çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œå°±æ˜¯æœ‰å¯èƒ½æ•°æ®éƒ½è¢«åˆ é™¤ä¸€å°ä¼šå„¿äº†ï¼Œç›‘å¬å™¨æ‰ç›‘å¬åˆ°ã€‚

* * *

### æœ¬äººå…¬ä¼—å·\[ **æ•¬YES** \]åŒæ­¥æ›´æ–°ï¼Œæ¬¢è¿å¤§å®¶å…³æ³¨~

![img](https://img2023.cnblogs.com/blog/37001/202309/37001-20230905001435629-1839223843.png)

ä½œè€…ï¼š[é™ˆæ•¬(å…¬ä¼—å·ï¼šæ•¬YES)](http://www.cnblogs.com/janes/)  
å‡ºå¤„ï¼š[http://www.cnblogs.com/janes/](http://www.cnblogs.com/janes/)  
åšå®¢æ–‡ç« ä»…ä¾›äº¤æµå­¦ä¹ ï¼Œè¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”ã€‚å¦‚éœ€è½¬è½½ï¼Œè¯·åŠ¡å¿…æ³¨æ˜å‡ºå¤„ã€‚